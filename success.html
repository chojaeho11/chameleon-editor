<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>결제 처리 중...</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <style>
        body { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #334155; }
        .loader { border: 4px solid #e2e8f0; border-top: 4px solid #6366f1; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="loader"></div>
    <h2 id="title" data-i18n="msg_processing_payment">Processing Payment...</h2>
    <p id="desc" data-i18n="msg_wait_moment">Please wait a moment.</p>

    <script type="module">
        // 1. Supabase 설정 (기존 키 그대로 사용)
        const SUPABASE_URL = 'https://qinvtnhiidtmrzosyvys.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpbnZ0bmhpaWR0bXJ6b3N5dnlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMDE3NjQsImV4cCI6MjA3ODc3Nzc2NH0.3z0f7R4w3bqXTOMTi19ksKSeAkx8HOOTONNSos8Xz8Y';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function processSuccess() {
            // URL에서 값 가져오기
            const urlParams = new URLSearchParams(window.location.search);
            const paymentKey = urlParams.get("paymentKey"); // ★ 이게 진짜 결제키 (tviva...)
            const orderId = urlParams.get("orderId");       // 이건 주문번호 (cafe...)
            const amount = urlParams.get("amount");
            const dbId = urlParams.get("db_id");

            console.log("받은 결제키:", paymentKey); // 콘솔에서 확인 가능

            if (!paymentKey || !orderId || !amount || !dbId) {
                alert("Missing payment information.");
                window.location.href = "index.html";
                return;
            }

            try {
                // 1. 토스 승인 요청 (Edge Function)
                const { data, error } = await sb.functions.invoke('confirm-payment', {
                    body: { paymentKey, orderId, amount: Number(amount), dbId }
                });

                if (error || (data && data.error)) {
                    throw new Error(error?.message || data?.error);
                }

                // 2. ★ 여기가 제일 중요합니다 ★ DB 업데이트
                const { error: dbError } = await sb.from('orders').update({
                    status: '접수됨', // [수정] 결제 성공했으므로 관리자에 노출
                    payment_status: '결제완료',
                    payment_method: '카드/간편결제',
                    toss_payment_key: paymentKey
                }).eq('id', dbId);

                if (dbError) console.error("DB 저장 실패:", dbError);

                // 성공 시 이동
                document.getElementById('title').innerText = "Payment Successful!";
                if(window.t) document.getElementById('title').innerText = window.t('msg_payment_complete');
                
                localStorage.removeItem('chameleon_cart_guest');
                const user = await sb.auth.getUser();
                if(user?.data?.user) localStorage.removeItem(`chameleon_cart_${user.data.user.id}`);
                
                setTimeout(() => window.location.href = "index.html", 1000);

            } catch (e) {
                console.error(e);
                alert("Payment Failed: " + e.message);
                window.location.href = "index.html";
            }
        }

        processSuccess();
    </script>
</body>
</html>