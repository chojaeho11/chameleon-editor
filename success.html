<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>결제 처리 중...</title>
    <style>
        body { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #334155; }
        .loader { border: 4px solid #e2e8f0; border-top: 4px solid #6366f1; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="loader" id="loader"></div>
    <h2 id="title">Processing Payment...</h2>
    <p id="desc">Please wait a moment.</p>

    <script>
        // Supabase 설정 (fetch 직접 호출 - Tracking Prevention 우회)
        const SUPABASE_URL = 'https://qinvtnhiidtmrzosyvys.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpbnZ0bmhpaWR0bXJ6b3N5dnlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMDE3NjQsImV4cCI6MjA3ODc3Nzc2NH0.3z0f7R4w3bqXTOMTi19ksKSeAkx8HOOTONNSos8Xz8Y';

        // Edge Function 직접 호출 (Supabase JS 클라이언트 불필요)
        async function invokeFunction(fnName, body) {
            const res = await fetch(`${SUPABASE_URL}/functions/v1/${fnName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'apikey': SUPABASE_KEY,
                },
                body: JSON.stringify(body)
            });
            return await res.json();
        }

        // DB 업데이트 (REST API 직접 호출)
        async function updateOrder(dbId, updateData) {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${dbId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'apikey': SUPABASE_KEY,
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify(updateData)
            });
            if (!res.ok) console.error("DB update failed:", res.status);
        }

        // [추천인] 카드결제 완료 후 추천인 적립
        async function creditReferralBonus(dbId, refId) {
            if (!refId) return;
            try {
                // 중복 체크
                const logRes = await fetch(`${SUPABASE_URL}/rest/v1/wallet_logs?user_id=eq.${refId}&type=eq.referral_bonus&description=ilike.*${dbId}*&select=id`, {
                    headers: { 'Authorization': `Bearer ${SUPABASE_KEY}`, 'apikey': SUPABASE_KEY }
                });
                const logs = await logRes.json();
                if (logs && logs.length > 0) return;

                // 주문 금액 + 주문자명 조회
                const orderRes = await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${dbId}&select=total_amount,manager_name`, {
                    headers: { 'Authorization': `Bearer ${SUPABASE_KEY}`, 'apikey': SUPABASE_KEY }
                });
                const [order] = await orderRes.json();
                if (!order || !order.total_amount) return;

                const bonus = Math.floor(order.total_amount * 0.1);
                if (bonus <= 0) return;
                const buyerName = order.manager_name || '고객';

                // 프로필 조회
                const pfRes = await fetch(`${SUPABASE_URL}/rest/v1/profiles?id=eq.${refId}&select=deposit`, {
                    headers: { 'Authorization': `Bearer ${SUPABASE_KEY}`, 'apikey': SUPABASE_KEY }
                });
                const [pf] = await pfRes.json();
                const newDeposit = (parseInt(pf?.deposit || 0)) + bonus;

                // deposit 업데이트
                await fetch(`${SUPABASE_URL}/rest/v1/profiles?id=eq.${refId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_KEY}`, 'apikey': SUPABASE_KEY, 'Prefer': 'return=minimal' },
                    body: JSON.stringify({ deposit: newDeposit })
                });

                // 로그 기록
                await fetch(`${SUPABASE_URL}/rest/v1/wallet_logs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_KEY}`, 'apikey': SUPABASE_KEY },
                    body: JSON.stringify({ user_id: refId, type: 'referral_bonus', amount: bonus, description: `${buyerName}님의 추천 적립 (주문: ${dbId})` })
                });
                console.log('[추천인] 적립 완료:', refId, '+' + bonus);
            } catch (e) {
                console.error('[추천인] 적립 오류:', e);
            }
        }

        async function processSuccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const dbId = urlParams.get("db_id");
            const sessionId = urlParams.get("session_id"); // Stripe
            const paymentKey = urlParams.get("paymentKey"); // Toss
            const refId = urlParams.get("ref_id"); // 추천인

            if (!dbId) {
                alert("Missing order information.");
                window.location.href = "index.html";
                return;
            }

            try {
                if (sessionId) {
                    // ====== Stripe 결제 확인 ======
                    console.log("Stripe session:", sessionId);

                    const data = await invokeFunction('verify-stripe-payment', {
                        session_id: sessionId, db_id: dbId
                    });

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // DB 업데이트
                    await updateOrder(dbId, {
                        status: '접수됨',
                        payment_status: '결제완료',
                        payment_method: 'Stripe Card',
                        toss_payment_key: sessionId
                    });

                } else if (paymentKey) {
                    // ====== Toss 결제 확인 ======
                    const orderId = urlParams.get("orderId");
                    const amount = urlParams.get("amount");

                    if (!orderId || !amount) {
                        throw new Error("Missing Toss payment parameters.");
                    }

                    console.log("Toss paymentKey:", paymentKey);

                    const data = await invokeFunction('confirm-payment', {
                        paymentKey, orderId, amount: Number(amount), dbId
                    });

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    await updateOrder(dbId, {
                        status: '접수됨',
                        payment_status: '결제완료',
                        payment_method: '카드/간편결제',
                        toss_payment_key: paymentKey
                    });

                } else {
                    throw new Error("No payment verification data found.");
                }

                // 추천인 적립
                if (refId) {
                    await creditReferralBonus(dbId, refId);
                }

                // 결제 성공 처리
                document.getElementById('loader').style.display = 'none';
                document.getElementById('title').innerText = "Payment Successful!";
                document.getElementById('desc').innerText = "Redirecting...";

                // 장바구니 비우기
                try {
                    localStorage.removeItem('chameleon_cart_guest');
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('chameleon_cart_')) localStorage.removeItem(key);
                    });
                } catch(e) {}

                setTimeout(() => window.location.href = "index.html", 1500);

            } catch (e) {
                console.error("Payment verification error:", e);
                document.getElementById('loader').style.display = 'none';
                document.getElementById('title').innerText = "Payment Error";
                document.getElementById('desc').innerText = e.message;

                // 에러가 나도 결제 자체는 완료됨 → 5초 후 홈으로 이동
                setTimeout(() => {
                    alert("Payment was processed but verification encountered an issue. Please contact support if your order doesn't appear.");
                    window.location.href = "index.html";
                }, 3000);
            }
        }

        processSuccess();
    </script>
</body>
</html>
