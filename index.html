<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<script>
    window.addEventListener('load', function() {
        // Fabric.js가 로드되었는지 확인
        if (typeof fabric === 'undefined') return;

        const originalFromURL = fabric.Image.fromURL;
        
        // 이미지 로딩 함수를 '스마트 로더'로 교체
        fabric.Image.fromURL = function(url, callback, options) {
            // 1. URL 유효성 검사 (비어있으면 무시)
            if (!url || typeof url !== 'string') {
                if(callback) callback(null); // 콜백을 강제로 실행해 로딩을 끝냄
                return;
            }

            // 2. [핵심] URL 자리에 JSON 데이터가 들어온 경우 -> 디자인으로 로드 (LoadFromJSON)
            // %7B는 '{' 의 URL 인코딩 문자입니다.
            if (url.includes('%7B') || url.trim().startsWith('{') || url.includes('{"version"')) {
                console.warn("🚨 이미지 주소 자리에 JSON 데이터 발견! -> 캔버스 복원으로 전환합니다.");
                
                // 만약 전역 canvas 객체가 있다면 즉시 데이터 복원 시도
                if (window.canvas) {
                    try {
                        // URL 인코딩된 경우 디코딩
                        const jsonStr = decodeURIComponent(url);
                        const jsonObj = JSON.parse(jsonStr);

                        window.canvas.loadFromJSON(jsonObj, function() {
                            console.log("✅ JSON 데이터 복원 완료");
                            window.canvas.requestRenderAll();
                            
                            // ★ 중요: 무한 로딩을 끄기 위해 로딩 화면을 강제로 숨김
                            const loadingEl = document.getElementById('loading');
                            if(loadingEl) loadingEl.style.display = 'none';
                            
                            // 콜백이 있다면 빈 이미지라도 넘겨서 에러 방지
                            if (callback) callback(new fabric.Image('')); 
                        });
                    } catch (e) {
                        console.error("JSON 복원 실패:", e);
                        if(document.getElementById('loading')) document.getElementById('loading').style.display = 'none';
                    }
                }
                return; // 원래의 fromURL 실행 차단
            }

            // 3. 정상적인 이미지 URL인 경우 -> 원래대로 실행
            return originalFromURL.call(this, url, callback, options);
        };
        
        console.log("✅ 스마트 에러 방지 시스템 가동 (JSON 자동 변환 모드)");
    });
</script>
<script>
    // [기존 코드] 서비스 워커 및 캐시 삭제
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for(let registration of registrations) {
                registration.unregister();
                console.log("좀비 서비스 워커 삭제 완료!");
            }
        });
        caches.keys().then(function(names) {
            for (let name of names) caches.delete(name);
            console.log("좀비 캐시 저장소 삭제 완료!");
        });
    }

    // [★추가할 코드] 431 에러 방지를 위한 모든 쿠키 삭제
    document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
    });
    console.log("헤더 용량 초과 방지를 위해 쿠키를 초기화했습니다.");
</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>카멜레온프린팅 - 친환경 전시·팝업스토어 인쇄 & 무료 디자인 에디터</title>
<meta name="description" content="허니콤보드, 패브릭인쇄, 팝업스토어 전문. 무료 에디터로 등신대/백월 디자인부터 인쇄까지 한번에 해결하세요.">

<meta property="og:type" content="website">
<meta property="og:site_name" content="카멜레온프린팅">
<meta property="og:title" content="카멜레온프린팅 - 친환경 전시 인쇄 & 무료 에디터">
<meta property="og:description" content="허니콤보드, 패브릭인쇄, 팝업스토어 전문. 무료 에디터로 쉽고 빠르게 디자인하세요.">
<meta property="og:url" content="https://www.cafe2626.com/">
<meta property="og:image" content="https://gdadmin.signmini.com/data/editor/policy/260105/6c9bc3b9b9a5903a01b44a7b36fc2cbe_191502.png">
<link rel="shortcut icon" href="https://gdadmin.signmini.com/data/common/favicon.ico">
<meta name="keywords" content="카멜레온프린팅, 허니콤보드, 종이매대, 패브릭인쇄, 팝업스토어, 등신대제작, 실사출력, 연포장, 친환경전시, 백월디자인, 전시부스, 폼보드인쇄">
<link rel="canonical" href="https://www.cafe2626.com/" />

<link rel="canonical" href="https://www.cafe3355.com/">
    <link rel="alternate" hreflang="ko" href="https://www.cafe2626.com/">
    <link rel="alternate" hreflang="en" href="https://www.cafe3355.com/">
    <link rel="alternate" hreflang="ja" href="https://www.cafe0101.com/">
    <link rel="alternate" hreflang="x-default" href="https://www.cafe2626.com/">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/svg2pdf.js@2.2.4/dist/svg2pdf.umd.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/plugins/svg.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/kilobtye/potrace@master/potrace.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.17/paper-full.min.js" defer></script>
<script src="https://js.tosspayments.com/v1" defer></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="./style.css">

<meta name="naver-site-verification" content="141eed82fa50fd6f98fa7bfe8dc481a202beb8cf" />

<script>
  (function(){var w=window;if(w.ChannelIO){return w.console.error("ChannelIO script included twice.");}var ch=function(){ch.c(arguments);};ch.q=[];ch.c=function(args){ch.q.push(args);};w.ChannelIO=ch;function l(){if(w.ChannelIOInitialized){return;}w.ChannelIOInitialized=true;var s=document.createElement("script");s.type="text/javascript";s.async=true;s.src="https://cdn.channel.io/plugin/ch-plugin-web.js";var x=document.getElementsByTagName("script")[0];if(x.parentNode){x.parentNode.insertBefore(s,x);}}if(document.readyState==="complete"){l();}else{w.addEventListener("DOMContentLoaded",l);w.addEventListener("load",l);}})();
  ChannelIO('boot', { "pluginKey": "752ba9ff-a447-4e10-9813-715e051995cd" });
</script>
<script>
    // 1. 프로젝트 버전
    const PROJECT_VERSION = '119';
    const DATA_PATH = './long/';
</script>
</head>
<body>
<div id="loading"><div class="loading-spin"></div><p style="margin-top:15px; font-weight:600;">로딩 중입니다...</p></div>

<div id="contextMenu">
    <div class="ctx-item" id="ctxUndo"><i class="fa-solid fa-rotate-left"></i> <span data-i18n="ctx_undo">실행 취소</span></div>
    <div class="ctx-item" id="ctxRedo"><i class="fa-solid fa-rotate-right"></i> <span data-i18n="ctx_redo">다시 실행</span></div>
    <div class="ctx-divider"></div>
    <div class="ctx-item" id="ctxCopy"><i class="fa-regular fa-copy"></i> <span data-i18n="ctx_copy">복사하기</span></div>
    <div class="ctx-item" id="ctxPaste"><i class="fa-regular fa-paste"></i> <span data-i18n="ctx_paste">붙여넣기</span></div>
    <div class="ctx-item" id="ctxDelete" style="color:#ef4444;"><i class="fa-solid fa-trash"></i> <span data-i18n="ctx_delete">삭제하기</span></div>
    <div class="ctx-divider"></div>
    <div class="ctx-item" id="ctxFront"><i class="fa-solid fa-arrow-up-from-bracket"></i> <span data-i18n="ctx_front">맨 앞으로</span></div>
    <div class="ctx-item" id="ctxBack"><i class="fa-solid fa-arrow-down-from-bracket"></i> <span data-i18n="ctx_back">맨 뒤로</span></div>
    <div class="ctx-divider"></div>
    <div class="ctx-item" id="ctxLock"><i class="fa-solid fa-lock"></i> <span data-i18n="ctx_lock">잠금 (Lock)</span></div>
</div>
<div class="topbar">
        <div class="brand" onclick="location.reload()"><i class="fa-solid fa-palette"></i> Chameleon</div>
        
        <div class="template-tabs" style="display:none;">
            <button id="btnMobileTemplateOpen" onclick="document.getElementById('templateOverlay').style.display='flex'; window.filterTpl('photo-bg');">🎨 <span data-i18n="tab_all">템플릿</span></button>
            
            <button class="tpl-tab active" data-tpl="all" 
                style="background: linear-gradient(135deg, #410175 0%, #f00064 100%); color: #fff; font-weight: 800; border: none; box-shadow: 0 3px 10px rgba(255, 105, 180, 0.3); margin-right: 5px;">
                🎨 전체 템플릿
            </button>

            <button class="tpl-tab" data-tpl="user_vector">
   유저 템플릿 벡터
</button>

<button class="tpl-tab" data-tpl="user_image">
   유저 템플릿 이미지
</button>

            <button class="tpl-tab" data-tpl="photo-bg">사진</button>

            <button class="tpl-tab" data-tpl="vector" data-i18n="tab_vector">배경</button>

            <button class="tpl-tab" data-tpl="graphic" data-i18n="tab_graphic">객체</button>

            <button class="tpl-tab" data-tpl="transparent-graphic" data-i18n="tab_pattern">패턴</button>

            <button class="tpl-tab" data-tpl="logo" data-i18n="tab_logo">로고</button>
        </div>
        
        <div style="flex:1;"></div>
        
        <button class="btn" onclick="if(confirm('첫 화면으로 돌아가시겠습니까?\n(저장하지 않은 작업은 사라질 수 있습니다)')) location.reload()" style="margin-right:5px; background:rgb(206, 14, 78); border:1px solid #ddd; color:#ffffff; padding:8px 12px;">
    <i class="fa-solid fa-house"></i> <span style="font-weight:bold;">HOME</span>
</button>

<button class="btn primary" id="btnOrderTop" style="margin-right:5px; background:#ffde26; color:#ffffff; font-weight:bold; box-shadow:0 4px 12px rgb(197, 255, 90);">
    <span data-i18n="btn_add_to_cart">장바구니 담기</span>
</button>

<!-- <button class="btn" id="btnViewCart" onclick="document.getElementById('cartPage').style.display='block'; document.body.classList.remove('editor-active');" style="display:none !important; margin-right:5px; background:rgb(137, 57, 241); border:1px solid #fdfff2; color:#ffffff; padding:8px 12px;"> -->
    <!-- <span data-i18n="btn_cart">🛒 장바구니</span> -->
<!-- </button> -->
        
        <button class="btn" id="btnLoginBtn" onclick="document.getElementById('loginModal').style.display='flex'" style="margin-right:5px;" data-i18n="btn_login">로그인</button>

        <button class="btn" id="btnMyLibrary" onclick="document.getElementById('libraryModal').style.display='flex'; if(window.loadMyDesigns) window.loadMyDesigns();" style="background:white; border:1px solid #ddd; color:#333; padding:8px 12px;">
            <span data-i18n="btn_my_library">📂 보관함</span>
        </button>
        <button class="btn" onclick="window.openMyOrderList()" style="background:white; border:1px solid #ddd; color:#333; margin-right:5px;">
    🚚 주문배송조회
</button>
    </div>


<div id="startScreen">
    
    <div class="hero-section">
    <h1 class="hero-title" data-i18n="hero_title">광고사 기획사 파티플래너라면? <br><span>카멜레온</span>과 함께해요.</h1>
    <p class="hero-desc" data-i18n="hero_desc">대한민국 1등 광고인쇄 도매쇼핑몰, 로고를 공유하고 함께 만드는 무료에디터</p>
</div>
<!-- 퀵메뉴와퍼 -->
<div class="quick-menu-wrapper">
    
    <img src="https://cdn-pro-web-159-230.cdn-nhncommerce.com/dnjsdudrjs13_godomall_com/data/editor/goods/251229/b74dea838f41881ce41d11b7c306629f_152347.png" class="bouncing-char" alt="캐릭터">
    
    
    <div class="quick-title-box">
        <span class="qt-badge" data-i18n="home_quick_badge">가격 퀄리티 두가지는 자신있다. 대한민국 프린팅계의 코스트코</span>
        <h2 class="qt-text" data-i18n="home_quick_title">카멜레온의 제품 카테고리</h2>
    </div>
    <div id="topCategoryTabs" class="category-tabs"></div>

    <div id="categoryDescriptionBox" style="
        max-width: 1000px;
        margin: 10px auto 30px auto; 
        padding: 20px; 
        background: #f8fafc; 
        border-radius: 12px; 
        text-align: center; 
        font-size: 15px; 
        color: #475569; 
        line-height: 1.6;
        display: none; 
        border: 1px solid #e2e8f0;
        word-break: keep-all;
    ">
    </div>

    <div class="main-search-wrapper" style="max-width: 1000px; margin: 0 auto 25px auto; padding: 0 15px; position: relative; z-index: 10;">
    <div style="position: relative; transition: all 0.3s;">
        <input type="text" id="mainCategorySearch" 
               placeholder="🔍 찾으시는 상품이나 카테고리를 입력해보세요! (예: 배너, 아크릴, 현수막)" 
               onkeyup="window.filterMainIcons(this.value)"
               style="
                   width: 100%; 
                   padding: 18px 20px 18px 55px; 
                   font-size: 16px; 
                   border: 2px solid #e2e8f0; 
                   border-radius: 50px; 
                   background: #ffffff; 
                   box-shadow: 0 8px 20px rgba(99, 102, 241, 0.1); 
                   transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                   outline: none;
                   color: #334155;
                   font-weight: 600;
               "
               onfocus="this.style.borderColor='#6366f1'; this.style.boxShadow='0 12px 25px rgba(99, 102, 241, 0.2)';"
               onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='0 8px 20px rgba(99, 102, 241, 0.1)';"
        >
        <i class="fa-solid fa-magnifying-glass" style="
            position: absolute; 
            left: 25px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: #6366f1; 
            font-size: 20px;
            pointer-events: none;
        "></i>
    </div>
</div>

    
    <div class="quick-menu-track" id="quickMenuContainer"></div>
    <div style="text-align: center; margin-top: 30px; padding-bottom: 30px; background: #fff; border-radius: 16px; padding: 30px; border: 1px solid #e2e8f0; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);">
        <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 20px;" data-i18n="home_vip_title">골드 등급 이상 또는 대량주문 전용 VIP 라운지</h3>
        <p style="margin: 0 0 20px 0; color: #64748b; font-size: 15px;" data-i18n="home_vip_desc">
            팝업스토어나 전시장 꾸미기 같이 대량이거나 복잡한 주문인가요? 골드 등급이상의 VIP고객이신가요?<br>
            파일만 올려주시면 <strong>전담 매니저</strong>가 분석 후 견적서와 함께 30분 이내에 연락드립니다.<br>
            매니저의 가이드에 따라 결제만 하시면 디자인/파일변환/접수/배송/설치까지 논스톱으로 도와드립니다.
        </p>
        <button onclick="document.getElementById('vipOrderModal').style.display='flex'" class="btn-round" style="background: linear-gradient(135deg, #1e1b4b 0%, #4338ca 100%); color: white; padding: 15px 40px; font-size: 18px; font-weight: 800; border: none; box-shadow: 0 10px 20px rgba(67, 56, 202, 0.3); width: auto; display: inline-flex; gap: 10px; align-items: center;">
            <i class="fa-solid fa-crown" style="color: #fbbf24;"></i> <span data-i18n="home_btn_vip_upload">VIP 주문 파일 업로드 (원스톱 접수)</span>
        </button>
    </div>
</div>

<!-- 오늘의핫딜 -->
<div id="hotDealSection" class="hotdeal-wrapper" style="display:none;">
    <div class="hotdeal-header">
        <h2>🔥 <span data-i18n="home_hotdeal_title">오늘의 핫딜</span> <span class="badge-hot">Time Sale</span></h2>
        <p data-i18n="home_hotdeal_desc">지금 놓치면 후회하는 초특가 상품을 만나보세요. 친구에서 선물하세요. 집들이 선물 핫딜상품은 최대 10개까지 주문가능</p>
    </div>
    <div id="hotDealGrid" class="hotdeal-grid">
        </div>
</div>

<div id="bizDealSection" class="hotdeal-wrapper" style="display:none; margin-top:0px; background: #f8fafc; padding: 20px; border-radius: 12px;">
    <div class="hotdeal-header">
        <h2 style="color: #4f46e5;">💼 <span data-i18n="home_biz_title">업자용 대박할인</span> <span class="badge-hot" style="background:#4f46e5;">B2B Only</span></h2>
        <p data-i18n="home_biz_desc">사업자 고객님을 위한 전용 특가! 최소주문수량 10~100개 리셀러 판매자에게 드리는 업자할인</p>
    </div>
    <div id="bizDealGrid" class="hotdeal-grid">
        </div>
</div>


    <!-- 게시판 -->
<div class="community-nav-wrapper">
    <div class="comm-grid">
        <a href="#" onclick="goBoard('blog'); return false;" class="comm-btn blog">
            <div class="comm-icon"><i class="fa-solid fa-pen-nib"></i></div>
            <span data-i18n="menu_blog">카멜레온<br>블로그</span>
        </a>
        <a href="#" onclick="goBoard('review'); return false;" class="comm-btn">
            <div class="comm-icon"><i class="fa-solid fa-star"></i></div>
            <span data-i18n="menu_review">고객<br>제작후기</span>
        </a>
        <a href="#" onclick="goBoard('promo'); return false;" class="comm-btn">
            <div class="comm-icon"><i class="fa-solid fa-bullhorn"></i></div>
            <span data-i18n="menu_promo">지역광고사<br>홍보</span>
        </a>
        <a href="#" onclick="goBoard('trade'); return false;" class="comm-btn">
            <div class="comm-icon"><i class="fa-solid fa-handshake"></i></div>
            <span data-i18n="menu_trade">중고장비<br>거래</span>
        </a>
        <a href="#" onclick="goBoard('job'); return false;" class="comm-btn">
            <div class="comm-icon"><i class="fa-solid fa-briefcase"></i></div>
            <span data-i18n="menu_job">구인구직</span>
        </a>
        <a href="#" onclick="goBoard('free'); return false;" class="comm-btn">
            <div class="comm-icon"><i class="fa-solid fa-comments"></i></div>
            <span data-i18n="menu_manual">제품설명서</span>
        </a>
    </div>
</div>

<div class="gallery-section">
    <style>
    .tier-section-wrap {
        text-align: center;
        margin: 40px auto 60px auto;
        max-width: 1000px;
        padding: 0 20px;
    }
    .tier-title-main {
        font-size: 24px;
        font-weight: 800;
        color: #1e293b;
        margin-bottom: 30px;
    }
    .tier-title-main span {
        color: #6366f1;
    }
    
    .tier-container {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap; /* 모바일에서 자동 줄바꿈 */
    }

    .tier-card {
        flex: 1;
        min-width: 280px; /* 카드 최소 너비 */
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        padding: 30px 20px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        overflow: hidden;
    }

    .tier-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    /* 카드 상단 색상띠 */
    .tier-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 6px;
    }
    .tier-card.gold::before { background: #eab308; }
    .tier-card.platinum::before { background: #64748b; }
    .tier-card.franchise::before { background: #6366f1; }

    .tier-icon {
        width: 60px; height: 60px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 24px;
        margin-bottom: 15px;
    }
    .tier-card.gold .tier-icon { background: #fef9c3; color: #ca8a04; }
    .tier-card.platinum .tier-icon { background: #f1f5f9; color: #475569; }
    .tier-card.franchise .tier-icon { background: #e0e7ff; color: #4f46e5; }

    .tier-name {
        font-size: 18px;
        font-weight: 800;
        margin-bottom: 5px;
        color: #334155;
    }

    .tier-discount {
        font-size: 32px;
        font-weight: 900;
        margin-bottom: 20px;
    }
    .tier-card.gold .tier-discount { color: #ca8a04; }
    .tier-card.platinum .tier-discount { color: #475569; }
    .tier-card.franchise .tier-discount { color: #4f46e5; }

    .tier-desc {
        font-size: 14px;
        color: #64748b;
        line-height: 1.6;
        border-top: 1px solid #f1f5f9;
        padding-top: 15px;
        width: 100%;
    }
    .tier-desc strong { color: #334155; }
    
    .tier-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
        background: #f1f5f9;
        color: #64748b;
        margin-bottom: 5px;
    }
</style>

<div class="tier-section-wrap">
    <h2 class="tier-title-main" data-i18n="tier_main_title">멤버십 등급별 <span>할인 혜택</span> 안내</h2>
    
    <div class="tier-container">
        <div class="tier-card gold">
            <div class="tier-icon"><i class="fa-solid fa-medal"></i></div>
            <div class="tier-name" data-i18n="tier_gold_name">골드 (GOLD)</div>
            <div class="tier-discount" data-i18n="tier_gold_discount" style="color:#ca8a04;">3% 할인</div>
            <div class="tier-desc">
                <span class="tier-badge" data-i18n="tier_cond_1">조건 1</span> <span data-i18n="tier_gold_cond_1">누적 구매 <strong>500만원</strong> 이상</span><br>
                <div style="margin: 5px 0; font-size:12px; color:#94a3b8;">OR</div>
                <span class="tier-badge" data-i18n="tier_cond_2">조건 2</span> <span data-i18n="tier_gold_cond_2">로고 <strong>10개</strong> 공유</span>
            </div>
        </div>

        <div class="tier-card platinum">
            <div class="tier-icon"><i class="fa-solid fa-crown"></i></div>
            <div class="tier-name" data-i18n="tier_plat_name">플레티넘 (PLATINUM)</div>
            <div class="tier-discount" data-i18n="tier_plat_discount" style="color:#475569;">5% 할인</div>
            <div class="tier-desc">
                <span class="tier-badge" data-i18n="tier_cond_1">조건 1</span> <span data-i18n="tier_plat_cond_1">누적 구매 <strong>1,000만원</strong> 이상</span><br>
                <div style="margin: 5px 0; font-size:12px; color:#94a3b8;">OR</div>
                <span class="tier-badge" data-i18n="tier_cond_2">조건 2</span> <span data-i18n="tier_plat_cond_2">로고 <strong>100개</strong> 공유</span>
            </div>
        </div>

        <div class="tier-card franchise">
            <div class="tier-icon"><i class="fa-solid fa-store"></i></div>
            <div class="tier-name" data-i18n="tier_partner_name">가맹점 (PARTNER)</div>
            <div class="tier-discount" data-i18n="tier_partner_discount" style="color:#4f46e5;">10% 할인</div>
            <div class="tier-desc">
                <span class="tier-badge" style="background:#e0e7ff; color:#4338ca;" data-i18n="tier_partner_cond_label">가입조건</span><br>
                <span data-i18n="tier_partner_cond_fee">파트너스 신청자</span><br>
                <span style="font-size:12px; color:#888;" data-i18n="tier_partner_cond_note">(사업자등록증 필수)</span>
            </div>
        </div>
    </div>
</div>

<div class="partner-recruit-banner" style="max-width:1000px; margin: 30px auto; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 16px; padding: 40px; color: white; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15);">
    
    <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(99, 102, 241, 0.2); border-radius: 50%;"></div>
    
    <div style="position: relative; z-index: 2; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
        <div style="flex: 1; min-width: 300px;">
            <span style="background: #6366f1; color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 800; margin-bottom: 10px; display: inline-block;">PARTNER CENTER</span>
            <h2 style="margin: 0 0 10px 0; font-size: 28px; font-weight: 800;" data-i18n="partner_banner_title">우리 지역 인쇄/광고 주문, <br><span style="color: #818cf8;">직접 접수받고 수익을 창출하세요!</span></h2>
            <p style="margin: 0; color: #94a3b8; font-size: 15px; line-height: 1.6;" data-i18n="partner_banner_desc">
                영업은 본사가 가맹점주님은 제작 납품, 허니콤보드는 설치비 무료...
            </p>
        </div>
        
        <div style="text-align: right;">
    <button id="btnPartnerConsole" onclick="location.href='partner.html'" class="btn-round" style="display: none; background: #fff; color: #0f172a; font-weight: 800; padding: 15px 30px; border: none; font-size: 16px; box-shadow: 0 4px 15px rgba(255,255,255,0.2);">
        <i class="fa-solid fa-store"></i> <span data-i18n="btn_partner_console">파트너스 센터 입장</span>
    </button>
    
    <button id="btnPartnerApply" onclick="document.getElementById('partnerApplyModal').style.display='flex'" class="btn-round" style="background: transparent; border: 2px solid #6366f1; color: #fff; font-weight: 800; padding: 12px 25px;">
        <span data-i18n="btn_partner_apply">가맹점 신청하기</span>
    </button>
</div>
    </div>
</div>
<!-- 기여자시스템 -->
<div class="contributor-section">
    <div class="contributor-header">
        <div class="contributor-title">
            <i class="fa-solid fa-gem" style="color:#6366f1;"></i> <span data-i18n="contrib_title">카멜레온 기여자 시스템</span>
            <span class="contributor-badge" id="myTierBadge">Loading...</span>
        </div>
        <div class="contributor-balance-box">
            <span style="font-size:12px; color:#64748b;" data-i18n="contrib_balance_label">내 누적 수익금</span>
            <div class="live-money" id="contributorBalance">0</div>
        </div>
    </div>

    <div class="contributor-desc" data-i18n="contrib_desc">
        내가 만든 디자인 소스를 공유하고 현금을 적립받으세요...
    </div>

    <div class="contributor-grid">
        <button class="contrib-btn" onclick="window.handleContributorUpload('png')">
            <div class="c-icon-box bg-blue"><i class="fa-solid fa-image"></i></div>
            <div class="c-info">
                <span class="c-name" data-i18n="contrib_btn_png">PNG 객체</span>
                <span class="c-reward">100 <span class="tier-bonus"></span></span>
            </div>
        </button>

        <button class="contrib-btn" onclick="window.handleContributorUpload('svg')">
            <div class="c-icon-box bg-purple"><i class="fa-solid fa-bezier-curve"></i></div>
            <div class="c-info">
                <span class="c-name" data-i18n="contrib_btn_svg">SVG 객체</span>
                <span class="c-reward">200 <span class="tier-bonus"></span></span>
            </div>
        </button>

        <button class="contrib-btn" onclick="window.handleContributorUpload('logo')">
            <div class="c-icon-box bg-orange"><i class="fa-solid fa-icons"></i></div>
            <div class="c-info">
                <span class="c-name" data-i18n="contrib_btn_logo">로고 업로드</span>
                <span class="c-reward">150 <span class="tier-bonus"></span></span>
            </div>
        </button>

        <button class="contrib-btn" onclick="window.openTemplateCreator()">
            <div class="c-icon-box bg-green"><i class="fa-solid fa-palette"></i></div>
            <div class="c-info">
                <span class="c-name" data-i18n="contrib_btn_template">템플릿 만들기</span>
                <span class="c-reward">100 <span class="tier-bonus"></span></span>
            </div>
        </button>
    </div>

    <input type="file" id="contributorFileInput" style="display:none;" multiple>
</div>
<!-- 마이페이지 -->
<div id="partnerConsoleModal" class="modal-bg" style="z-index: 20000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 1200px; max-width: 98%; height: 90vh; display: flex; flex-direction: column; padding: 0; background: #f8fafc; overflow: hidden;">
        
        <div style="background: #fff; padding: 15px 25px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <h3 style="margin: 0; color: #1e293b;"><i class="fa-solid fa-store" style="color:#6366f1;"></i> 파트너스 콘솔</h3>
                <span class="badge" style="background: #e0e7ff; color: #4338ca;" id="partnerRegionBadge">지역 미설정</span>
            </div>
            <button onclick="document.getElementById('partnerConsoleModal').style.display='none'" class="btn-round" style="width: auto; padding: 5px 15px;">닫기</button>
        </div>

        <div style="display: flex; flex: 1; overflow: hidden;">
            <div style="width: 220px; background: #fff; border-right: 1px solid #e2e8f0; padding: 20px;">
                <div class="nav-menu" style="display: flex; flex-direction: column; gap: 5px;">
                    <button class="nav-item active" onclick="switchPartnerTab('pool')" style="text-align: left; padding: 12px; border: none; background: #eff6ff; color: #6366f1; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        <i class="fa-solid fa-list-ul"></i> 실시간 주문접수
                    </button>
                    <button class="nav-item" onclick="switchPartnerTab('my')" style="text-align: left; padding: 12px; border: none; background: transparent; color: #64748b; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        <i class="fa-solid fa-clipboard-check"></i> 나의 진행 주문
                    </button>
                    <button class="nav-item" onclick="switchPartnerTab('settlement')" style="text-align: left; padding: 12px; border: none; background: transparent; color: #64748b; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        <i class="fa-solid fa-sack-dollar"></i> 정산 및 출금
                    </button>
                </div>
            </div>

            <div style="flex: 1; padding: 25px; overflow-y: auto;">
                <div id="tab-pool" class="partner-tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">📍 실시간 오더 (선착순)</h2>
                        <button class="btn-round primary" onclick="loadPartnerOrders('pool')" style="width: auto;"><i class="fa-solid fa-rotate"></i> 새로고침</button>
                    </div>
                    <div id="orderPoolList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">로딩 중...</div>
                </div>

                <div id="tab-my" class="partner-tab-content" style="display: none;">
                    <h2 style="margin-bottom: 20px;">📋 나의 진행 주문</h2>
                    <div id="myOrderList" style="display: flex; flex-direction: column; gap: 15px;">내역 없음</div>
                </div>

                <div id="tab-settlement" class="partner-tab-content" style="display: none;">
    
    <div style="background: #fff; padding: 30px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; display: flex; align-items: center;">
        
        <div style="margin-right: 50px;">
            <div style="font-size: 14px; color: #64748b; margin-bottom: 5px;">출금 가능 금액 (수수료 제외)</div>
            <div style="font-size: 32px; font-weight: 900; color: #1e293b;" id="partnerAvailableBalance">0원</div>
        </div>

        <div>
            <div style="font-size: 14px; color: #64748b; margin-bottom: 5px;">출금 대기중 (신청완료)</div>
            <div style="font-size: 32px; font-weight: 900; color: #d97706;" id="partnerPendingBalance">0원</div>
        </div>

        <button class="btn-round primary" onclick="requestPartnerWithdrawal()" style="width: auto; padding: 15px 30px; margin-left: auto;">
            💸 출금 요청하기
        </button>
    </div>
    
    <h4 style="margin-bottom: 15px; color: #334155;">정산 상세 내역</h4>
    <table style="width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0;">
        <thead style="background: #f8fafc;">
            <tr>
                <th style="padding: 12px; text-align: left; color: #64748b; font-size: 13px;">날짜</th>
                <th style="padding: 12px; text-align: right; color: #64748b; font-size: 13px;">주문금액</th>
                <th style="padding: 12px; text-align: right; color: #64748b; font-size: 13px;">정산금액</th>
                <th style="padding: 12px; text-align: center; color: #64748b; font-size: 13px;">상태</th>
            </tr>
        </thead>
        <tbody id="settlementListBody"></tbody>
    </table>
</div>
            </div>
        </div>
    </div>
</div>

<div id="myOrderModal" class="modal-bg" style="z-index: 16000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 800px; max-width: 95%; max-height: 85vh; display: flex; flex-direction: column; padding: 0; background: #f8fafc; overflow: hidden;">
        
        <div style="background: #fff; padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: #1e293b;">📦 나의 주문 배송 조회</h3>
            <button onclick="document.getElementById('myOrderModal').style.display='none'" class="btn-round" style="width: auto; padding: 5px 15px;">닫기</button>
        </div>

        <div style="flex: 1; padding: 20px; overflow-y: auto;">
            <div id="myOrderListUser" style="display: flex; flex-direction: column; gap: 15px;">
                </div>
        </div>
    </div>
</div>
    
    <div class="hero-search-wrap">
    <div style="display:none; opacity:0;">
        <input type="text" name="fake_username_prevention" autocomplete="username">
        <input type="password" name="fake_password_prevention" autocomplete="current-password">
    </div>

    <input type="search" 
           id="startSearchInput" 
           name="q_search_query_final_v2" 
           class="hero-search-input" 
           placeholder="어떤 디자인을 찾으세요? (예: 고양이, 바다, 하늘)" 
           autocomplete="off" 
           readonly 
           onfocus="this.removeAttribute('readonly');"
    >
    <button id="btnStartSearch" class="hero-search-btn">
        <i class="fa-solid fa-magnifying-glass"></i> <span data-i18n="btn_search">검색</span>
    </button>
</div> 
<div class="pagination-wrapper" style="display:flex; justify-content:center; align-items:center; gap:20px; margin:20px 0 40px 0;">
    <button id="btnTplPrev" class="btn-round" onclick="changeTemplatePage(-1)" style="width:100px; justify-content:center;" disabled>
        <i class="fa-solid fa-chevron-left"></i> 이전
    </button>
    
    <span id="tplPageLabel" style="font-weight:bold; color:#334155; font-size:16px;">1 페이지</span>
    
    <button id="btnTplNext" class="btn-round" onclick="changeTemplatePage(1)" style="width:100px; justify-content:center;">
        다음 <i class="fa-solid fa-chevron-right"></i>
    </button>
</div>
<div class="community-nav-wrapper">


<script>
    // 게시판 이동 함수 (도메인 및 언어 자동 감지 적용)
    function goBoard(category) {
        // 1. 현재 도메인 확인
        const hostname = window.location.hostname;
        let targetCountry = 'KR'; // 기본값

        // 2. 도메인에 따라 국가 코드 결정 (board.html은 KR, US, JP 대문자 사용)
        if (hostname.includes('cafe3355.com')) {
            targetCountry = 'US';
        } else if (hostname.includes('cafe0101.com')) {
            targetCountry = 'JP';
        }

        // 3. 주소창 파라미터(?lang=)가 있다면 최우선 적용 (테스트용)
        const urlParams = new URLSearchParams(window.location.search);
        const paramLang = urlParams.get('lang');
        if (paramLang) {
            if (paramLang.toLowerCase() === 'en' || paramLang.toLowerCase() === 'us') targetCountry = 'US';
            if (paramLang.toLowerCase() === 'ja' || paramLang.toLowerCase() === 'jp') targetCountry = 'JP';
        }

        // 4. 해당 언어 코드를 달고 게시판 새 창 열기
        window.open(`/board.html?cat=${category}&country=${targetCountry}`, '_blank');
    }
</script>
    

    <div id="startTemplateGrid" class="template-grid-start"></div>
    
    <div class="review-section">
    <div class="review-header">
    <h2 data-i18n="review_section_title">✨ 고객님들의 생생한 후기</h2>
    <p data-i18n="review_section_desc">카멜레온으로 완성된 멋진 결과물들을 확인해보세요.</p>
</div>

    <div class="marquee-wrapper">
        <div class="marquee-track">
    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000000048/image/detail/1000000048_detail_065.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div>
            <p class="review-text" data-i18n="rev_1_text">"행사때마다 이용합니다. 기획사한테는 여기만한 곳이 없어요. 허니콤보드 진짜 저렴하고 빠르고 사장님 최고입니다."</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_1_user">제일기획 우*진 부장</span>
                <span class="u-date" data-i18n="rev_1_date">2024.03.15</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000000049/image/detail/1000000049_detail_023.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div>
            <p class="review-text" data-i18n="rev_2_text">"행사때 뭔가 포인트를 주고싶었는데 너무 좋았어요. 경기도에서 1개 시켰는데도 무료배송 너무 친절한 기사님까지 최고예요!"</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_2_user">이벤트기획 김*수</span>
                <span class="u-date" data-i18n="rev_2_date">2024.03.12</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000004101/image/main/1000004101_main_028.png');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div>
            <p class="review-text" data-i18n="rev_3_text">"키링 제작 진짜 너무 퀄리티 높은거 아닌가요? 소량구매는 안되서 아쉽지만 저희같은 판매자에게는 최고입니다."</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_3_user">도치맘**</span>
                <span class="u-date" data-i18n="rev_3_date">2024.03.10</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000000428/image/detail/1000000428_detail_094.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star-half-stroke"></i></div>
            <p class="review-text" data-i18n="rev_4_text">"쉬폰인쇄 퀄리티 미쳤습니다. 여긴 달라요. UV로 만드는 색빠지는 그런거 아니고 찐 의류인쇄에 사용하는 방식이라는데 색감 퀄리티 빨아도 물 안빠지고 최고입니다. 강추!!!"</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_4_user">핸드메이드샵</span>
                <span class="u-date" data-i18n="rev_4_date">2024.03.08</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000000113/image/main/1000000113_main_082.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div>
            <p class="review-text" data-i18n="rev_5_text">"행사때마다 잘 이용하고 있습니다. 허니콤보드는 진짜 국내 1위라는게 헛말이 아닌곳. 이제 에디터까지 있어서 너무 편하고 좋습니다."</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_5_user">신화기획 최보람</span>
                <span class="u-date" data-i18n="rev_5_date">2025.12.15</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000004088/image/detail/1000004088_detail_057.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div>
            <p class="review-text" data-i18n="rev_6_text">"종이로 만든 원터치 매대, 써보니 진짜 튼튼해요 종이같지 않아요. 황서연 매니저라는분이 오셔서 설치 알려주셨는데 너무 친절하십니다."</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_6_user">몰타기획</span>
                <span class="u-date" data-i18n="rev_6_date">2024.03.12</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000003080/image/detail/1000003080_detail_042.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div>
            <p class="review-text" data-i18n="rev_7_text">"단상이 너무 옛날거라 촌스러워서 허니콤보드로 감싸서 사용했는데 행사의 품격이 올라갑니다."</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_7_user">엡손 김지수</span>
                <span class="u-date" data-i18n="rev_7_date">2024.03.10</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000000051/image/detail/1000000051_detail_040.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star-half-stroke"></i></div>
            <p class="review-text" data-i18n="rev_8_text">"허니콤보드 종이가 이렇게까지 튼튼하고 예쁘다니 좋습니다. 진짜 맘에 들어요. 기획할때 꼭 넣어야하는 포인트"</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_8_user">에드팝사인기획</span>
                <span class="u-date" data-i18n="rev_8_date">2024.03.08</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000003340/image/detail/1000000050_detail_061.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div>
            <p class="review-text" data-i18n="rev_9_text">"일반배너와는 느낌이 달라요. 고급스럽고 독특하고 버리기도 편해서 좋아요."</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_9_user">최희수</span>
                <span class="u-date" data-i18n="rev_9_date">2025.12.15</span>
            </div>
        </div>
    </div>
</div>
            
            

    </div>
</div>
</div>

    <div class="footer-wrap">
    <div class="footer-inner">
        <div class="foot-left">
            <div class="foot-menu">
                <ul>
                    <li><a href="#" data-i18n="footer_menu_company">회사소개</a></li>
                    <li><a href="#" data-i18n="footer_menu_notice">공지사항</a></li>
                    <li><a href="#" data-i18n="footer_menu_terms">이용약관</a></li>
                    <li><a href="#"><strong data-i18n="footer_menu_privacy">개인정보처리방침</strong></a></li>
                </ul>
            </div>
            <div class="foot-info">
                <dl>
                    <dt data-i18n="footer_company_label">상호명 :</dt>
                    <dd data-i18n="footer_company_value">(주)카멜레온프린팅</dd>
                    
                    <dt data-i18n="footer_ceo_label">대표 :</dt>
                    <dd data-i18n="footer_ceo_value">조재호</dd>
                </dl>
                <dl>
                    <dt data-i18n="footer_addr_label">주소 :</dt>
                    <dd data-i18n="footer_addr_value">경기도 화성시 우정읍 한말길 72-2</dd>
                </dl>
                <dl>
                    <dt data-i18n="footer_biz_num_label">사업자등록번호 :</dt>
                    <dd>470-81-02808</dd>
                    
                    <dt data-i18n="footer_mail_order_label">통신판매업신고번호 :</dt>
                    <dd>2025-화성우정-0033</dd>
                </dl>
                <dl>
                    <dt data-i18n="footer_privacy_manager_label">개인정보관리자 :</dt>
                    <dd>변지웅</dd>
                </dl>
                <p class="copyright">Copyright © <strong>Chameleon Canvas</strong>. all rights reserved.</p>
            </div>
        </div>

        <div class="cs-center">
            <h3 data-i18n="footer_cs_title">고객센터 (CS CENTER)</h3>
            <strong>031-366-1984</strong>
            <p>
                <span data-i18n="footer_cs_time">평일 09:00 ~ 18:00</span> <br>
                <span data-i18n="footer_cs_lunch">점심 12:00 ~ 13:00</span> <br>
                <span data-i18n="footer_cs_closed">* 주말 및 공휴일 휴무</span>
            </p>
        </div>
    </div>
</div>
    </div>
</div>



<div id="mainEditor" style="display:none;">
    

    <div id="wallHeightControls">
        <div class="wall-label"><i class="fa-solid fa-ruler-vertical"></i> <span data-i18n="wall_option_title">가벽 높이</span></div>
        <button class="height-btn active" onclick="window.setWallHeight(2200, this)">220cm</button>
        <button class="height-btn" onclick="window.setWallHeight(2400, this)">240cm</button>
        <button class="height-btn" onclick="window.setWallHeight(3000, this)">300cm</button>
    </div>

    <div class="editor-wrap">
        
        <div class="side" id="toolsPanel" style="text-align: center; padding: 10px 12px;">
            
            <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:10px; margin-bottom:10px;">
                <div style="font-size:11px; font-weight:700; color:#64748b; margin-bottom:5px; display:flex; justify-content:space-between;">
                    <span data-i18n="tool_size_change">📏 사이즈 변경(mm)</span>
                    <span id="limitLabel" style="color:#6366f1;">Max: -</span>
                </div>
                <div style="display:flex; gap:5px; align-items:center;">
                    <input type="number" id="inputUserW" class="ai-input-pretty" placeholder="W" style="margin:0; padding:5px; font-size:12px; text-align:center;">
                    <span style="color:#999;">x</span>
                    <input type="number" id="inputUserH" class="ai-input-pretty" placeholder="H" style="margin:0; padding:5px; font-size:12px; text-align:center;">
                </div>
                <button id="btnApplyUserSize" class="btn-round primary" style="width:100%; margin-top:6px; height:32px; font-size:12px;" data-i18n="btn_save_cost">변경 적용</button>
            </div>
            
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button id="btnRotateCanvas" class="btn-round" style="flex:1; justify-content: center;"><i class="fa-solid fa-rotate"></i> <span data-i18n="btn_rotate">회전</span></button>
                <button id="btnFitScreen" class="btn-round" style="flex:1; justify-content: center;"><i class="fa-solid fa-compress"></i> <span data-i18n="btn_fit_screen">맞춤</span></button>
            </div>

            <div class="section-title" data-i18n="label_ai_tools" style="margin-bottom: 5px; font-size: 12px;">AI TOOLS</div>
            <button class="btn-round ai-red" id="btnAIBox" style="justify-content: center; height: 38px; margin-bottom: 5px;"><i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="btn_ai_gen">AI 생성</span></button>
            <!-- <button class="btn-round" id="btnOpenSellModal" onclick="window.openSellModal()"  -->
                  <!-- style="width: 100%; justify-content: center; height: 38px; background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); border: none; color: white; margin-bottom: 5px; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);"> -->
                 <!-- <i class="fa-solid fa-sack-dollar"></i> <span data-i18n="btn_sell_design">디자인 판매 등록</span> -->
            </button>
            <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                <button class="btn-round" id="btnOpenSaveModal" style="flex: 1; justify-content: center; height: 38px;">
                    <span data-i18n="btn_save_design">💾 디자인 저장</span>
                </button>
                <button class="btn-round" id="btnMyPageSide" style="flex: 1; justify-content: center; height: 38px; background: white; border: 1px solid #ddd; color: #333;">
                    <span>📂 MY page</span>
                </button>
            </div>

            <button class="btn-round" onclick="document.getElementById('logoUploadModal').style.display='flex'" style="width: 100%; justify-content: center; height: 38px; background: #f8fafc; border: 1px solid #6366f1; color: #6366f1; margin-bottom: 15px;">
                <i class="fa-solid fa-cloud-arrow-up"></i> <span data-i18n="btn_logo_share">로고 공유방</span>
            </button>
            
            <div class="section-title" style="margin-bottom: 5px; font-size: 12px; color: #b6b6b6; letter-spacing: 1px;">무료 다운로드</div>
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <button id="btnPNG" class="btn-round" style="flex:1; justify-content: center; height: 36px;"><i class="fa-regular fa-image"></i> PNG</button>
                <button id="btnPDF" class="btn-round" style="flex:1; justify-content: center; height: 36px;"><i class="fa-solid fa-file-pdf"></i> PDF</button>
            </div>

            <!-- 요기가 원래 마법사 자리 -->

            <button id="btnAddBasicText" class="btn-round" style="width:100%; margin-bottom:10px; border:1px solid #cbd5e1; background:#fff; color:#333; font-weight:bold; padding:10px; display:flex; align-items:center; justify-content:center;">
                <span style="display:inline-flex; width:20px; height:20px; background:#222; color:#fff; border-radius:4px; align-items:center; justify-content:center; margin-right:6px; font-size:12px;">T</span>
                <span style="font-size: 13px;">텍스트 추가</span>
            </button>

            <button class="btn-round" id="btnFontSelect" style="width:100%; margin-bottom:10px; display:flex; align-items:center; justify-content:center; height: 38px;">
                <span data-i18n="btn_font" style="font-size: 13px;">🅰️ 폰트 전체보기</span>
            </button>

            <div id="leftTextSettings" style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:8px; margin-bottom:10px; text-align: left;">
                <div style="display:flex; gap:4px; margin-bottom:8px;">
                    <button class="tool-btn" id="btnAlignLeftText" style="flex:1;"><i class="fa-solid fa-align-left"></i></button>
                    <button class="tool-btn" id="btnAlignCenterText" style="flex:1;"><i class="fa-solid fa-align-center"></i></button>
                    <button class="tool-btn" id="btnAlignRightText" style="flex:1;"><i class="fa-solid fa-align-right"></i></button>
                </div>
                <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px; align-items:center; margin-bottom:6px;">
                    <span style="font-size:11px; color:#666;">크기</span>
                    <input type="range" id="textSize" min="10" max="200" value="50" style="width:100%;">
                </div>
                <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px; align-items:center; margin-bottom:6px;">
                    <span style="font-size:11px; color:#666;">자간</span>
                    <input type="range" id="textCharSpacing" min="-50" max="300" value="0" style="width:100%;">
                </div>
                <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px; align-items:center;">
                    <span style="font-size:11px; color:#666;">행간</span>
                    <input type="range" id="textLineHeight" min="0.5" max="2.5" step="0.1" value="1.2" style="width:100%;">
                </div>
            </div>

            <div class="color-group" style="margin-bottom:5px; font-size: 12px; display: flex; align-items: center; justify-content: space-between;">
                <span data-i18n="label_fill">🎨 면색상</span>
                <input id="fillColor" type="color" class="color-picker" value="#000000" style="width: 25px; height: 25px;">
            </div>
            <div class="color-group" style="margin-bottom:10px; font-size: 12px; display: flex; align-items: center; justify-content: space-between;">
                <span data-i18n="label_stroke">🖌️ 선색상</span>
                <input id="strokeColor" type="color" class="color-picker" value="#000000" style="width: 25px; height: 25px;">
            </div>

            <div class="section-title" data-i18n="label_shapes" style="font-size: 12px; margin-bottom: 5px;">SHAPES</div>
            <div class="shape-panel" style="gap: 4px;">
                <button class="shape-btn" data-shape="rect">■</button>
                <button class="shape-btn" data-shape="circle">●</button>
                <button class="shape-btn" data-shape="triangle">▲</button>
                <button class="shape-btn" data-shape="star">★</button>
                <button class="shape-btn" data-shape="heart">♥</button>
                <button class="shape-btn" data-shape="arrow">➡</button>
                <button class="shape-btn" data-shape="round">▢</button>
                <button class="shape-btn" data-shape="line">━</button>
            </div>

            <div class="section-title" style="font-size: 12px; margin-top: 15px; margin-bottom: 5px;">BACKGROUND</div>
            <button id="btnBgColor" class="btn-round" style="width:100%; justify-content: flex-start; margin-bottom: 5px; height: 38px;">
                <div style="width:20px; height:20px; background:linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); border-radius:4px; margin-right:8px; border:1px solid #ddd;"></div>
                <span>배경색 설정</span>
            </button>

            <div id="bgColorPanel" style="display:none; background:#f8fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:10px;">
                <div style="font-size:11px; font-weight:bold; color:#666; margin-bottom:5px; text-align:left;">기본 팔레트</div>
                <div id="colorPaletteGrid" style="display:grid; grid-template-columns:repeat(6, 1fr); gap:6px;">
                    </div>
            </div>
            <div class="section-title" data-i18n="label_upload" style="font-size: 12px; margin-top: 10px; margin-bottom: 5px;">UPLOAD</div>
            <label class="upload-box" for="imgUpload" style="height: 60px; padding: 10px;"><span style="font-size:18px;"><i class="fa-solid fa-cloud-arrow-up"></i></span> <span style="font-size: 12px;">Image/PDF</span></label>
            <input id="imgUpload" type="file" accept="image/*,.svg,.pdf" style="display:none;">
        </div>
        
        <div id="sideTemplateDrawer" class="side-drawer" style="display:none;">
            <div class="drawer-header">
                <span style="font-weight:800; color:#334155; font-size:14px;">🎨 추천 디자인</span>
                <button class="btn-close-drawer" onclick="document.getElementById('sideTemplateDrawer').style.display='none'">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="drawer-search-box">
                <input type="text" id="sideTemplateSearch" placeholder="디자인 검색 (예: 카페, 세일)" autocomplete="off" onkeyup="window.handleSideSearch(this.value)">
                <i class="fa-solid fa-magnifying-glass"></i>
            </div>

            <div id="sideTemplateList" class="drawer-content">
                </div>
        </div>

        <div class="stage" id="stage">
           <div id="textWizardToolbar" class="wizard-toolbar floating-island">
    <div class="wiz-brand" style="display:flex; flex-direction:column; justify-content:center; align-items:center; line-height:1.2; padding: 0 5px;">
        <span class="wiz-icon" style="font-size:20px; margin-bottom:2px;">🧙‍♂️</span>
        <span style="font-size:10px; font-weight:bold; color:#8b00a7; letter-spacing:-0.5px;">디자인마법사</span>
    </div>
    
    <div class="wiz-scroll-track">
        
        <button onclick="window.toggleBackgroundLock()" style="
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    cursor: pointer;
    margin: 0 2px; /* 좌우 여백을 줄여 공간 확보 */
    padding: 0;
    min-width: 40px; /* 전체 폭 축소 */
">
    <div style="
        width: 30px;
        height: 30px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 3px;
        border: 1px solid #eee;
    ">
        <span style="font-size: 16px;">🔒</span>
    </div>

    <span style="
        font-size: 10px;
        color: #555; /* 너무 진하지 않게 자연스러운 색상 */
        font-weight: bold;
        white-space: nowrap;
        letter-spacing: -0.5px; /* 자간을 좁혀서 가로 공간 추가 확보 */
    ">
        배경풀기
    </span>
</button>


        <button class="wiz-btn" onclick="window.applyNewWizard('basic')">
            <div class="icon-box c-indigo"><i class="fa-solid fa-store"></i></div>
            <span>전단지</span>
        </button>
        <button class="wiz-btn" onclick="window.applyNewWizard('flyer')">
            <div class="icon-box c-red"><i class="fa-solid fa-bullhorn"></i></div>
            <span>포스터</span>
        </button>
        <button class="wiz-btn" onclick="window.applyNewWizard('card')">
            <div class="icon-box c-green"><i class="fa-solid fa-address-card"></i></div>
            <span>명함</span>
        </button>
        <button class="wiz-btn" onclick="window.applyNewWizard('menu')">
            <div class="icon-box c-orange"><i class="fa-solid fa-utensils"></i></div>
            <span>메뉴판</span>
        </button>

        <div class="wiz-divider"></div>

        <button class="wiz-btn" onclick="window.applyNewWizard('banner-h')">
            <div class="icon-box c-blue"><i class="fa-solid fa-scroll"></i></div>
            <span>가로현수막</span>
        </button>
        <button class="wiz-btn" onclick="window.applyNewWizard('banner-v')">
            <div class="icon-box c-purple"><i class="fa-solid fa-flag"></i></div>
            <span>세로배너</span>
        </button>
        <button class="wiz-btn" onclick="window.applyNewWizard('fabric')">
            <div class="icon-box c-pink"><i class="fa-solid fa-shirt"></i></div>
            <span>SALE</span>
        </button>
        <button class="wiz-btn" onclick="window.applyNewWizard('vertical-text')">
            <div class="icon-box c-teal"><i class="fa-solid fa-text-height"></i></div>
            <span>인스타판넬</span>
        </button>
        
    </div>
</div>
            <div id="pageControls" class="page-controls-bar">
                <button class="btn-icon-only" id="btnPagePrev" onclick="window.changePage(-1)" title="이전 페이지">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                
                <span id="pageCounter" style="font-weight:800; font-size:14px; min-width:60px; text-align:center; color:#334155;">1 / 1</span>
                
                <button class="btn-icon-only" id="btnPageNext" onclick="window.changePage(1)" title="다음 페이지">
                    <i class="fa-solid fa-chevron-right"></i>
                </button>

                <div style="width:1px; height:14px; background:#cbd5e1; margin:0 8px;"></div>

                <button class="btn-text-icon" onclick="window.addPage()" title="Page">
                    <i class="fa-solid fa-plus"></i> <span style="font-size:12px; font-weight:bold;">Page</span>
                </button>
                
                <button class="btn-text-icon delete" onclick="window.deletePage()" title="현재 페이지 삭제">
                    <i class="fa-regular fa-trash-can"></i>
                </button>
            </div>
            <div class="bottom-dock">
                <button onclick="window.toggleBackgroundLock()" class="zoom-btn" title="배경 잠금/해제"><i class="fa-solid fa-lock"></i></button>
                <button onclick="document.getElementById('btnFitScreen').click()" class="zoom-btn" title="화면 맞춤"><i class="fa-solid fa-compress"></i></button>
                <div class="divider"></div>
                
                <button id="btnZoomOut" class="zoom-btn"><i class="fa-solid fa-minus"></i></button>
                <button id="btnZoomIn" class="zoom-btn"><i class="fa-solid fa-plus"></i></button>
                <div class="divider"></div>
                <div style="position:relative;">
                    <div id="guideMenuPanel" class="guide-popup" style="display:none;">
                        <button class="guide-opt-btn" data-mode="off" onclick="window.setGuideMode('off')">🚫 끔</button>
                        <button class="guide-opt-btn" data-mode="cross" onclick="window.setGuideMode('cross')">✚ 십자</button>
                        <button class="guide-opt-btn" data-mode="3" onclick="window.setGuideMode('3')">3단</button>
                        <button class="guide-opt-btn" data-mode="4" onclick="window.setGuideMode('4')">4단</button>
                        <button class="guide-opt-btn" data-mode="5" onclick="window.setGuideMode('5')">5단</button>
                        <button class="guide-opt-btn" data-mode="grid" onclick="window.setGuideMode('grid')">▦ 격자</button>
                    </div>
                    
                    <button id="guideToggle" class="zoom-btn" style="width:auto; padding:0 15px; border-radius:20px; font-size:12px;">
                        <i class="fa-solid fa-ruler-horizontal"></i> 가이드
                    </button>
                </div>
                <span class="help-text">Space: 이동 / 휠: 줌</span>
            </div>
            
            <div class="right-stack" id="rightStackPanel">
                <div class="panel-box" id="panelEdit" style="padding: 10px 12px; text-align: center;">
                    <div class="section-title" style="margin-top:0; margin-bottom: 8px; font-size: 12px;" data-i18n="label_edit_layer">편집 & 레이어</div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:5px;">
                        <button class="tool-btn" id="btnUndo" style="font-size: 11px;"><i class="fa-solid fa-rotate-left"></i> <span data-i18n="btn_undo">취소</span></button>
                        <button class="tool-btn" id="btnRedo" style="font-size: 11px;"><i class="fa-solid fa-rotate-right"></i> <span data-i18n="btn_redo">다시</span></button>
                        <button class="tool-btn" id="btnCopy" style="font-size: 11px;"><i class="fa-regular fa-copy"></i> <span data-i18n="btn_copy">복사</span></button>
                        <button class="tool-btn" id="btnPaste" style="font-size: 11px;"><i class="fa-regular fa-paste"></i> <span data-i18n="btn_paste">붙여넣기</span></button>
                    </div>
                    
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <button class="tool-btn" id="btnRotateLeft15" style="flex:1; font-size: 11px;">-15°</button>
                        <button class="tool-btn" id="btnRotateRight15" style="flex:1; font-size: 11px;">+15°</button>
                    </div>

                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <button class="tool-btn" id="btnFront" data-i18n="btn_front" style="flex:1; font-size: 11px;">맨앞</button>
                        <button class="tool-btn" id="btnBack" data-i18n="btn_back" style="flex:1; font-size: 11px;">맨뒤</button>
                        <button class="tool-btn" id="btnDel" style="color:red; flex:1; font-size: 11px;" data-i18n="btn_del">삭제</button>
                    </div>
                    
                    <!-- <div class="section-title" style="margin-bottom:8px; font-size: 12px;" data-i18n="label_align">정렬</div>
                    <div class="align-grid" style="gap: 4px; margin-bottom: 8px;">
                        <button class="align-btn" id="btnAlignLeft"><i class="fa-solid fa-align-left"></i></button>
                        <button class="align-btn" id="btnAlignRight"><i class="fa-solid fa-align-right"></i></button>
                        <button class="align-btn" id="btnAlignTop"><i class="fa-solid fa-align-left" style="transform:rotate(90deg)"></i></button>
                        <button class="align-btn" id="btnAlignMiddle"><i class="fa-solid fa-arrows-up-down-left-right"></i></button>
                        <button class="align-btn" id="btnAlignBottom"><i class="fa-solid fa-align-right" style="transform:rotate(90deg)"></i></button>
                    </div> -->
                    <button class="btn-round" id="btnCenterObject" onclick="window.alignObject('center')" style="margin-top:5px; height: 32px; font-size: 11px;">
        🎯 <span data-i18n="btn_center_all">정중앙</span>
    </button>
    
    <button class="btn-round" onclick="window.setAsBackground()" style="margin-top:5px; height: 32px; font-size: 11px;">
        🖼 <span data-i18n="btn_full_bg">배경 채우기</span>
    </button>

    <button id="btnLockWizard" class="btn-round" style="margin-top:5px; height: 32px; font-size: 11px;">
        <i class="fa-solid fa-lock"></i> <span>선택-잠그기</span>
    </button>
                </div>

                <div class="panel-box" id="panelText" style="display:none;"></div>
                
                <div class="panel-box" style="padding: 10px 12px; text-align: center;">
                    <div class="section-title" style="margin-top:0; color:#333; font-size: 12px; margin-bottom: 5px;" data-i18n="label_ai_image_tools">AI & Cutout</div>
                    <div class="tool-box-group" style="padding: 0;">
                        <button id="btn-create-outline" class="btn-round" style="width:100%; margin-bottom:5px; justify-content:center; height: 36px; font-size: 11px;">
                            ✂️ <span data-i18n="btn_make_cutline">오려내기 칼선</span>
                        </button>
                        <div style="display:flex; gap:5px; margin-bottom: 10px;">
                            <button id="btn-make-keyring" class="btn-round" style="flex:1; justify-content: center; height:32px; font-size:11px;">
                                <span data-i18n="btn_keyring_hole">키링 고리</span>
                            </button>
                            <button id="btn-make-standee" class="btn-round" style="flex:1; justify-content: center; height:32px; font-size:11px;">
                                <span data-i18n="btn_stand_base">등신대</span>
                            </button>
                        </div>
                    </div>

                    <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 10px;">
    
    <button id="btnUpscale" class="btn-round" style="
        width: 100%; 
        height: 45px; 
        border: none; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        color: white; 
        font-weight: 800; 
        font-size: 13px; 
        box-shadow: 0 4px 10px rgba(118, 75, 162, 0.4);
        display: flex; align-items: center; justify-content: center;">
        ✨ <span data-i18n="btn_enhance">A3이상 사진 해상도UP</span>
    </button>

    <button id="btnCutout" class="btn-round" style="
        width: 100%; 
        height: 45px; 
        border: none; 
        background: linear-gradient(135deg, #ff9a9e 0%, #ff6a88 100%); 
        color: white; 
        font-weight: 800; 
        font-size: 13px; 
        box-shadow: 0 4px 10px rgba(255, 106, 136, 0.4);
        display: flex; align-items: center; justify-content: center;">
        ✂️ <span data-i18n="btn_bg_remove">배경 제거하기</span>
    </button>

    <button class="tool-btn" id="btnOutline" style="height: 36px; font-size: 11px; background:white; border:1px solid #ddd; color:#333;">
        🔲 <span data-i18n="btn_text_outline">외곽선</span>
    </button>

</div>
                    
                    <div class="section-title" style="margin-top:10px; font-size: 11px; text-align: left;">선 두께</div>
                    <input type="range" id="globalStroke" min="0" max="30" value="0" style="width:100%;">
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button class="tool-btn" id="btnStrokeMiter" style="flex:1; height: 30px; font-size: 11px;"><i class="fa-solid fa-square"></i> 각지게</button>
                        <button class="tool-btn" id="btnStrokeRound" style="flex:1; height: 30px; font-size: 11px;"><i class="fa-solid fa-circle"></i> 둥글게</button>
                    </div>

                    <div class="section-title" style="margin-top: 10px; font-size: 11px; text-align: left;">투명도</div>
                    <input type="range" id="opacitySlider" min="0" max="100" value="100" style="width:100%;">
                </div>
            </div>
            <canvas id="designCanvas"></canvas>
        </div>
    </div>
</div>
<div id="mobileTextEditor" style="display:none;">
    <div class="m-text-header">
        <span style="color:#6366f1; font-weight:bold;"><i class="fa-solid fa-pen"></i> 텍스트 수정</span>
        
        <div style="display:flex; gap:5px;">
            <button onclick="window.deleteMobileObject()" style="background:#ef4444; color:white; border:none; padding:6px 12px; border-radius:6px; font-weight:bold; font-size:13px;">
                <i class="fa-solid fa-trash"></i> 삭제
            </button>
            
            <button onclick="window.closeMobileTextEditor()" style="background:#6366f1; color:white; border:none; padding:6px 12px; border-radius:6px; font-weight:bold; font-size:13px;">
                완료
            </button>
        </div>
    </div>
    <textarea id="mobileTextInput" placeholder="여기에 내용을 입력하세요..."></textarea>
</div>
<div id="templateActionModal" class="modal-bg" style="z-index: 20000;">
    <div class="modal-box" style="width: 500px; max-width: 90%;">
        <h3 style="margin-top:0; font-size: 20px;">🎨 템플릿 불러오기</h3>
        <p style="color:#666; font-size:15px; margin-bottom:30px; line-height: 1.5;">
            현재 작업 중인 디자인이 있습니다.<br>
            선택한 템플릿을 어떻게 적용하시겠습니까?
        </p>
        
        <div style="display:flex; gap:15px;">
            <button id="btnActionAdd" class="btn-round" style="flex:1; height:120px; flex-direction:column; justify-content:center; gap:10px; background:#f1f5f9; border:1px solid #cbd5e1; color:#334155;">
                <i class="fa-solid fa-layer-group" style="font-size:32px; color:#6366f1;"></i>
                <span style="font-size:16px; font-weight:bold;">현재 작업에 추가</span>
                <span style="font-size:12px; font-weight:normal; opacity:0.8;">기존 디자인 위에 겹치기</span>
            </button>

            <button id="btnActionReplace" class="btn-round ai-red" style="flex:1; height:120px; flex-direction:column; justify-content:center; gap:10px; border:none;">
                <i class="fa-solid fa-file-circle-check" style="font-size:32px;"></i>
                <span style="font-size:16px; font-weight:bold;">새 작업 시작</span>
                <span style="font-size:12px; font-weight:normal; opacity:0.8;">기존 내용 지우고 덮어쓰기</span>
            </button>
        </div>

        <button onclick="document.getElementById('templateActionModal').style.display='none'" class="btn-round" style="margin-top:20px; border:none; color:#999;">
            취소하고 돌아가기
        </button>
    </div>
</div>
<div id="sizeSelectModal" class="modal-bg" style="z-index: 15000;">
    <div class="modal-box" style="width: 800px; max-width: 95%;">
        <h3>📏 어떤 크기로 만드시겠습니까?</h3>
        <p style="margin-bottom:20px; color:#666;">선택한 제품 크기에 맞춰 템플릿이 자동으로 조절됩니다.</p>
        
        <div id="productSelectGrid" class="quick-menu-track" style="grid-template-columns: repeat(4, 1fr);"></div>
        
        <button onclick="document.getElementById('sizeSelectModal').style.display='none'" class="btn-round" style="margin-top:20px;">취소</button>
    </div>
</div>
<div id="aiDrawer" class="ai-drawer"><h3>✨ AI 이미지 생성</h3><p class="label">설명 (Prompt)</p><textarea id="aiPrompt" class="ai-input-pretty" placeholder="예: 숲속에 앉아있는 귀여운 갈색 토끼" style="height:100px;"></textarea><button id="aiGenerateBtn" class="btn-round primary" style="margin-top:10px;">생성하기</button><div id="aiResultArea" style="min-height:200px; background:#f9f9f9; margin-top:20px; display:flex; justify-content:center; align-items:center;"><span style="color:#ccc;">결과 대기 중</span></div><button id="aiUseBtn" class="btn-round" style="display:none; margin-top:10px;">캔버스에 넣기</button><button onclick="document.getElementById('aiDrawer').classList.remove('open')" class="btn-round" style="margin-top:10px;">닫기</button></div>
<div id="templateOverlay">
    <div class="tpl-modal-box">
        <div class="tpl-sidebar">
            <button class="tpl-cate-btn" onclick="window.filterTpl('all', this)">
                <span style="font-weight:800; color:#6366f1;">🎨 전체 디자인</span>
            </button>
            
            <button class="tpl-cate-btn" onclick="window.filterTpl('user_vector', this)">
    <span>유저 템플릿 (벡터)</span>
</button>
<button class="tpl-cate-btn" onclick="window.filterTpl('user_image', this)">
    <span>유저 템플릿 (이미지)</span>
</button>

            <button class="tpl-cate-btn active" onclick="window.filterTpl('photo-bg', this)">
                <span>이미지</span>
            </button>

            <button class="tpl-cate-btn" onclick="window.filterTpl('vector', this)">
                <span>심플배경 (백터)</span>
            </button>

            <button class="tpl-cate-btn" onclick="window.filterTpl('graphic', this)">
                <span>PNG객체</span>
            </button>

            <button class="tpl-cate-btn" onclick="window.filterTpl('transparent-graphic', this)">
                <span>패턴디자인</span>
            </button>

            <button class="tpl-cate-btn" onclick="window.filterTpl('logo', this)">
                <span>로고모음</span>
            </button>
        </div>
        <div class="tpl-content">
            <div style="padding: 20px 30px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between;">
                <h2 style="margin:0;">검색</h2>
                <input type="text" id="tplSearchInput" class="ai-input-pretty" style="width:300px; margin-bottom:0;" placeholder="검색어 입력...">
                <button onclick="document.getElementById('templateOverlay').style.display='none'" style="border:none; background:none; cursor:pointer;">
                    <i class="fa-solid fa-xmark fa-2x"></i>
                </button>
            </div>
            <div id="tplGrid" class="tpl-grid"></div>
            <div style="padding:15px; text-align:right; border-top:1px solid #eee;">
                <button id="btnUseTpl" class="btn primary" onclick="window.useSelectedTemplate()">선택한 템플릿 적용</button>
            </div> 
        </div>
    </div>
</div>
<div id="libraryModal" class="modal-bg" style="z-index: 11000;"><div class="modal-box" style="width: 800px; max-width: 90%; height: 80%; display: flex; flex-direction: column;"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h3 style="margin:0;">📂 내 디자인 보관함</h3><button onclick="document.getElementById('libraryModal').style.display='none'" style="border:none; background:none; cursor:pointer; font-size:20px;">✕</button></div><div id="myDesignGrid" style="flex:1; overflow-y:auto; display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:20px; padding:10px;"></div></div></div>
<div id="saveDesignModal" class="modal-bg" style="z-index: 11001;"><div class="modal-box"><h3>💾 디자인 저장하기</h3><p style="font-size:13px; color:#666;">보관함에 저장하여 나중에 다시 불러올 수 있습니다.</p><input id="saveDesignTitle" class="ai-input-pretty" placeholder="디자인 제목을 입력하세요 (예: 여름 이벤트 배너)"><div style="display:flex; gap:10px; margin-top:20px;"><button id="btnConfirmSave" class="btn-round primary">저장하기</button><button onclick="document.getElementById('saveDesignModal').style.display='none'" class="btn-round">취소</button></div></div></div>
<div id="loadModeModal" class="modal-bg" style="z-index: 10001;"><div class="modal-box" style="width: 450px;"><h3>🎨 템플릿 불러오기</h3><p style="color:#666; font-size:14px; margin-bottom:20px;">현재 캔버스 내용이 있습니다.</p><div style="display:flex; gap:10px;"><button id="btnLoadReplace" class="btn-round ai-red" style="height:100px;">새 작업으로<br>(기존 삭제)</button><button id="btnLoadAdd" class="btn-round primary" style="height:100px;">현재 작업에<br>추가하기</button></div><button onclick="document.getElementById('loadModeModal').style.display='none'" class="btn-round" style="margin-top:15px;">취소</button></div></div>
<div id="loginModal" class="modal-bg" style="z-index: 10002;">
    <div class="modal-box" style="width: 400px;">
        <h3 id="authTitle" style="margin-top:0;" data-i18n="modal_login_title">로그인</h3>
        <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:15px;">
            <input id="loginId" class="ai-input-pretty" placeholder="이메일 주소" data-i18n-placeholder="placeholder_email" style="margin:0;">
            <input id="loginPw" class="ai-input-pretty" type="password" placeholder="비밀번호" data-i18n-placeholder="placeholder_pw" style="margin:0;">
            <input id="loginPwConfirm" class="ai-input-pretty" type="password" placeholder="비밀번호 확인" data-i18n-placeholder="placeholder_pw_confirm" style="margin:0; display:none;">
        </div>
        <button class="btn-round primary" id="btnAuthAction" style="width:100%; justify-content:center; height:45px; font-size:15px;" data-i18n="btn_login_submit">로그인</button>
        <div style="margin-top:15px; font-size:13px; color:#666;">
            <span id="authSwitchText" data-i18n="msg_no_account">계정이 없으신가요?</span>
            <span id="btnSwitchAuthMode" style="color:var(--primary); font-weight:bold; cursor:pointer; margin-left:5px; text-decoration:underline;" data-i18n="btn_signup">회원가입</span>
        </div>
        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
        <div style="display:flex; flex-direction:column; gap:8px;">
            <button id="btnGoogleLogin" class="btn-round" style="border-color:#ddd; justify-content:center;">
                <i class="fa-brands fa-google" style="color:#DB4437; margin-right:8px;"></i> <span data-i18n="btn_google_login">Google로 시작하기</span>
            </button>
            <button id="btnKakaoLogin" class="btn-round" style="border-color:#FEE500; background:#FEE500; color:#3C1E1E; justify-content:center;">
                <i class="fa-solid fa-comment" style="margin-right:8px;"></i> 카카오로 시작하기
            </button>
        </div>
        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #f1f5f9; text-align: center;">
    <p style="font-size: 13px; color: #6366f1; font-weight: bold; margin-bottom: 15px; line-height: 1.5; word-break: keep-all;">
        <i class="fa-solid fa-circle-info"></i> 고객님의 소중한 작업물을 임시저장하기 위해서는<br>회원가입 또는 로그인이 꼭 필요한 서비스입니다.
    </p>
    
    <button onclick="document.getElementById('loginModal').style.display='none'" class="btn-round" style="width: 100%; justify-content: center; background: #f8fafc; border: 1px solid #e2e8f0; color: #64748b; font-weight: normal;">
        👀 로그인 없이 둘러보기
    </button>
</div>
    </div>
</div>
<div id="productDetailModal" class="modal-bg" style="z-index: 11000;"><div class="modal-box" style="width: 900px; max-width: 95%; display: flex; text-align: left; padding:0; overflow:hidden;"><div style="width: 45%; background: #f8fafc; display: flex; align-items: center; justify-content: center; padding: 20px;"><img id="pdpImage" src="" style="max-width: 100%; max-height: 300px; object-fit: contain;"></div><div style="width: 55%; padding: 40px; display: flex; flex-direction: column;"><h2 id="pdpTitle" style="margin: 0 0 10px 0;">상품명</h2><h3 id="pdpPrice" style="color: var(--primary); margin: 0 0 20px 0;">0원</h3><button id="btnActionDesign" class="btn-round primary" style="height: 50px;">🎨 직접 디자인하기</button><div style="margin-top:10px;"><input type="file" id="pdpFileUpload" style="display: none;"><button onclick="document.getElementById('pdpFileUpload').click()" class="btn-round">📂 파일 업로드 주문</button></div><button onclick="document.getElementById('productDetailModal').style.display='none'" style="margin-top: auto; border:none; background:none; cursor:pointer;">닫기</button></div></div></div>
<div id="cartPage" style="display:none; position:fixed; inset:0; background:#f1f5f9; z-index: 12000; overflow-y:auto; padding-top: 40px;">
    <div style="max-width: 1000px; margin: 0 auto; padding-bottom: 60px;">
        <div style="display:flex; justify-content:space-between; align-items:center; padding:0 20px;">
            <h1>🛒 <span data-i18n="cart_title">장바구니</span> <span id="cartCount">(0)</span></h1>
            <button onclick="document.getElementById('cartPage').style.display='none'" class="btn-round" style="width:auto;" data-i18n="btn_close">닫기</button>
        </div>

        <div style="display: flex; flex-direction: column; gap: 20px; padding: 0 20px;">
            
            <div style="background:#ffe70e; padding:15px; border-radius:12px; border:1px dashed #ffde39; text-align:center;">
                <p style="margin:0 0 10px 0; font-size:13px; color:#64748b;">직접 디자인한 파일은 여기에 일괄 업로드 해주세요</p>
                <button onclick="document.getElementById('bulkCartUpload').click()" class="btn-round" style="width:100%; justify-content:center; background:#f8fafc; border:1px solid #6366f1; color:#6366f1;">
                    <i class="fa-solid fa-cloud-arrow-up"></i> 파일 일괄 업로드
                </button>
                <input type="file" id="bulkCartUpload" multiple style="display:none;" onchange="window.handleBulkCartUpload(this)">
            </div>

            <div id="cartListArea" style="width: 100%;"></div>
            <div style="background:#fffbeb; border:1px solid #fcd34d; border-radius:12px; padding:15px; display:flex; flex-wrap:wrap; gap:15px; justify-content:space-between; align-items:center; margin: 20px 0;">
                <div style="display:flex; align-items:center; gap:12px; min-width: 200px;">
                    <div style="width:40px; height:40px; background:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#d97706; box-shadow:0 2px 5px rgba(0,0,0,0.05); flex-shrink:0;">
                        <i class="fa-solid fa-truck-fast" style="font-size:18px;"></i>
                    </div>
                    <div>
                        <div style="font-size:14px; font-weight:800; color:#92400e; word-break:keep-all;">배송비 선택을 잊으셨나요?</div>
                        <div style="font-size:12px; color:#b45309; margin-top:2px; word-break:keep-all;">제품에 맞는 배송/설치 옵션을 꼭 추가해주세요.</div>
                    </div>
                </div>
                <button onclick="window.openDeliveryCategory()" class="btn-round" style="width:auto; flex-grow:1; max-width:100%; height:38px; padding:0 15px; background:#fff; border:1px solid #d97706; color:#d97706; font-weight:800; font-size:12px; box-shadow:0 2px 5px rgba(0,0,0,0.05); white-space:nowrap;">
                    + 배송비 추가 (서울 경기는 모든 고객 무료배송) 시간지정 및 설치요청만 결제하세요.
                </button>
            </div>
            
            <div style="width: 100%;">
                <div style="background:white; padding:20px; border-radius:12px;">
                    <h3 data-i18n="label_payment_amt">결제 금액</h3>
                    
                    <div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                        <span data-i18n="label_product_price">상품</span>
                        <span id="summaryItemPrice">0원</span>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                        <span data-i18n="label_option_price">옵션</span>
                        <span id="summaryAddonPrice">0원</span>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; color:#ef4444; font-weight:bold; margin-bottom: 5px;">
                        <span>등급 할인</span>
                        <span id="summaryDiscount">0원 (0%)</span>
                    </div>
                    
                    <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
                    
                    <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:20px; margin-bottom: 20px;">
                        <span data-i18n="label_total_price">합계</span>
                        <span id="summaryTotal">0원</span>
                    </div>
                    
                    <button id="btnGoCheckout" class="btn-round primary" style="margin-top:0; width:100%; height: 50px; font-size: 16px;">
                        💳 <span data-i18n="btn_do_checkout">결제하기</span>
                    </button>
                    
                    <button id="btnPrintQuote" class="btn-round btn-secondary" style="margin-top:10px; width:100%;">
                        <i class="fa-solid fa-file-invoice"></i> <span data-i18n="btn_print_quote">견적서 출력</span>
                    </button>
                </div>
            </div>
            </div>
    </div>
</div>
<div id="calendarModal" class="modal-bg" style="z-index: 12500;">
    <div class="modal-box">
        <h3>📅 <span data-i18n="modal_calendar_title">배송요청 [제작기간 3일]</span></h3>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <button id="btnPrevMonth" class="btn-round" style="width:30px;">&lt;</button>
            <span id="currentMonthYear" style="font-weight:bold;"></span>
            <button id="btnNextMonth" class="btn-round" style="width:30px;">&gt;</button>
        </div>
        <div id="calendarGrid" class="calendar-grid"></div>
        <button onclick="document.getElementById('calendarModal').style.display='none'" class="btn-round" style="margin-top:15px;" data-i18n="btn_close">닫기</button>
    </div>
</div>
<div id="deliveryInfoModal" class="modal-bg" style="z-index: 12600;">
    <div class="modal-box" style="text-align:left;">
        <h3 style="text-align:center;" data-i18n="modal_delivery_title">📝 배송 정보 입력</h3>
        
        <p data-i18n="label_manager_name">담당자명</p>
        <input id="inputManagerName" class="ai-input-pretty">
        
        <p data-i18n="label_contact_phone">연락처</p>
        <input id="inputManagerPhone" class="ai-input-pretty">
        
        <p data-i18n="label_address">주소 (Address)</p>
        
        <div id="addrFormKR">
            <input id="inputAddressKR" class="ai-input-pretty" placeholder="주소 검색 또는 입력">
        </div>

        <div id="addrFormGlobal" style="display:none; gap:10px; flex-direction:column;">
            <div style="display:flex; gap:10px;">
                <input id="inputZipCode" class="ai-input-pretty" placeholder="Zip/Postal Code" style="flex:1; margin:0;">
                <input id="inputState" class="ai-input-pretty" placeholder="State/Prefecture" style="flex:1; margin:0;">
            </div>
            <input id="inputCity" class="ai-input-pretty" placeholder="City" style="margin-bottom:0;">
            <input id="inputStreet1" class="ai-input-pretty" placeholder="Street Address 1" style="margin-bottom:0;">
            <input id="inputStreet2" class="ai-input-pretty" placeholder="Apartment, suite, unit, etc. (optional)">
        </div>
        
        <p data-i18n="label_request_memo" style="margin-top:10px;">요청사항</p>
        <textarea id="inputRequest" class="ai-input-pretty"></textarea>
        
        <button id="btnSubmitOrderInfo" class="btn-round primary" style="margin-top:10px;" data-i18n="btn_payment_submit">주문서 생성 및 결제</button>
        <button onclick="document.getElementById('deliveryInfoModal').style.display='none'" class="btn-round" style="margin-top:5px;" data-i18n="btn_cancel">취소</button>
    </div>
</div>

<div id="checkoutModal" class="modal-bg" style="z-index: 13000;">
    <div class="modal-box" style="text-align:left; width: 500px;">
        <h3 style="text-align:center; margin-bottom: 20px;" data-i18n="modal_checkout_title">주문 확인 및 결제</h3>
        
        <label style="font-size:12px; color:#666; font-weight:bold;" data-i18n="label_orderer_name">주문자명</label>
        <input id="orderName" class="ai-input-pretty" readonly>
        
        <label style="font-size:12px; color:#666; font-weight:bold;" data-i18n="label_contact_phone">연락처</label>
        <input id="orderPhone" class="ai-input-pretty" readonly>
        
        <label style="font-size:12px; color:#666; font-weight:bold;" data-i18n="label_shipping_addr">배송지</label>
        <input id="orderAddr" class="ai-input-pretty" readonly>
        
        <label style="font-size:12px; color:#666; font-weight:bold;" data-i18n="label_request_memo">요청사항</label>
        <textarea id="orderMemo" class="ai-input-pretty" readonly></textarea>
        
        <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">

        <div style="background:#f0f9ff; padding:15px; border-radius:8px; border:1px solid #bae6fd; margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span style="font-weight:bold; color:#0369a1;">Ⓜ️ 마일리지 사용</span>
                <span style="font-size:12px; color:#64748b;">보유: <b id="userOwnMileage">0 P</b></span>
            </div>
            
            <div style="display:flex; gap:8px; align-items:center;">
                <input type="number" id="inputUseMileage" class="ai-input-pretty" placeholder="0" style="margin:0; text-align:right; font-weight:bold; color:#0369a1;" oninput="window.calcMileageLimit(this)">
                <button class="btn-round" onclick="window.applyMaxMileage()" style="width:60px; font-size:12px; background:#fff; border:1px solid #cbd5e1; color:#333; justify-content:center;">최대</button>
            </div>

            <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:11px;">
                <span style="color:#ef4444; font-weight:bold;">* 결제금액의 5%까지만 사용 가능</span>
                <span style="color:#0369a1;">사용가능 한도: <b id="mileageLimitDisplay">0 P</b></span>
            </div>
        </div>

        <div style="text-align:right; margin-bottom:20px;">
            <div style="font-size:13px; color:#666;">최종 결제 금액</div>
            <div id="finalPayAmountDisplay" style="font-size:24px; font-weight:900; color:#6366f1;">0원</div>
        </div>
        <label style="font-size:14px; font-weight:bold; color:#333; margin-bottom:10px; display:block;">결제 수단 선택</label>
        
        <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
            <label class="pay-method-item" style="display:flex; align-items:center; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer;">
                <input type="radio" name="paymentMethod" value="card" checked style="margin-right:10px; accent-color:#6366f1;">
                <span>💳 카드 / 간편결제 (즉시 완료)</span>
            </label>

            <label class="pay-method-item" style="display:flex; align-items:center; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer;">
                <input type="radio" name="paymentMethod" value="bank" style="margin-right:10px; accent-color:#6366f1;">
                <span>🏦 무통장 입금 (확인 후 제작)</span>
            </label>

            <label class="pay-method-item" style="display:flex; align-items:center; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer;">
                <input type="radio" name="paymentMethod" value="deposit" style="margin-right:10px; accent-color:#6366f1;">
                <div style="display:flex; justify-content:space-between; width:100%;">
                    <span>💰 나의 예치금 사용</span>
                    <span id="myCurrentDepositDisplay" style="font-weight:bold; color:#6366f1;">(잔액 조회중...)</span>
                </div>
            </label>
        </div>

        <button id="btnFinalPay" class="btn-round primary" style="width:100%; height: 50px; font-size: 16px;" onclick="window.handleFinalPayment()">
            결제하기
        </button>

        <div id="bankInfoBox" style="display:none; margin-top:15px; background:#f8fafc; padding:15px; border-radius:8px; font-size:13px;">
            <div class="bank-title" style="font-weight:bold; margin-bottom:5px;" data-i18n="msg_bank_info">[계좌이체 안내]</div>
            
            <div style="line-height:1.6;">
                <span data-i18n="msg_bank_name">국민은행</span> 
                <span style="font-weight:bold; color:#333;">647701-04-277763</span><br>
                <span data-i18n="msg_bank_owner">(예금주: 카멜레온프린팅)</span>
            </div>
            
            <div style="margin-top:10px; border-top:1px solid #e2e8f0; padding-top:10px;">
                <label style="font-weight:bold; display:block; margin-bottom:5px;" data-i18n="label_manager_name">입금자명</label>
                <input type="text" id="inputDepositorName" class="ai-input-pretty" placeholder="" style="margin:0; background:white;">
            </div>
            
            <div style="color:#ef4444; margin-top:5px;" data-i18n="msg_bank_note">* 입금자명이 주문자명과 다르면 확인이 지연됩니다.</div>
        </div>

        <div style="display:flex; gap:10px; margin-top:15px;">
            <button id="btnDownQuotationCheckout" class="btn-round btn-secondary" style="flex:1; justify-content: center;">
                <i class="fa-solid fa-file-invoice"></i> 견적서 다운
            </button>
            <button id="btnDownOrderSheetCheckout" class="btn-round btn-secondary" style="flex:1; justify-content: center;">
                <i class="fa-solid fa-clipboard-list"></i> 작업지시서 다운
            </button>
        </div>

        <button onclick="document.getElementById('checkoutModal').style.display='none'; if(window.isOrderCompleted) location.reload();" class="btn-round" style="margin-top:10px; border:none; color:#888;">닫기</button>
    </div>
</div>
        </div>

        <button onclick="document.getElementById('checkoutModal').style.display='none'" class="btn-round" style="margin-top:10px; border:none; color:#888;">닫기</button>
    </div>
</div>

        <button onclick="document.getElementById('checkoutModal').style.display='none'" class="btn-round" style="margin-top:10px; border:none; color:#888;">닫기</button>
    </div>
</div>
</div>
<div id="successModal" class="modal-bg" style="z-index: 14000;"><div class="modal-box"><h2>🎉 주문 완료!</h2><button id="btnDownOrderSheet" class="btn-round">📄 작업지시서 다운로드</button><button id="btnDownQuotation" class="btn-round" style="margin-top:5px;">📑 견적서 다운로드</button><button onclick="window.closeSuccessModal()" class="btn-round primary" style="margin-top:15px;">확인</button></div></div>
<div id="sellModal" class="modal-bg" style="display: none;"> <div class="modal-box">
        <h3 class="modal-title">💎 디자인 공유/판매 등록</h3>
        
        <div class="benefit-box">
            <div class="benefit-item">
                <span class="benefit-icon">💰</span>
                <span>등록 즉시 <span class="highlight">100원</span>, 사용될 때마다 <span class="highlight">200원</span> 적립</span>
            </div>
            <div class="benefit-item">
                <span class="benefit-icon">💳</span>
                <span>1,000원부터 바로 <span class="highlight">현금 환전</span> 가능</span>
            </div>
            <div class="benefit-item">
                <span class="benefit-icon">🚀</span>
                <span>텍스트/로고 공유로 매일 자동 수입 만들기!</span>
            </div>
        </div>

        

        <div class="input-row" style="margin-bottom: 15px;">
    <label style="display:block; font-weight:bold; margin-bottom:5px;">템플릿 유형</label>
    <div style="display: flex; gap: 20px;">
        <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
            <input type="radio" name="sellType" value="vector" checked> 
            벡터
        </label>
        <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
            <input type="radio" name="sellType" value="image"> 
            이미지
        </label>
    </div>
</div>
        <div class="input-group">
            <label class="input-label">키워드 & 제목</label>
            <input id="sellTitle" class="ai-input-pretty" 
                   type="text"
                   placeholder="예: 피부과 이벤트, 여름 포스터" 
                   oninput="document.getElementById('sellKw').value = this.value;">
        </div>

        <input id="sellKw" type="hidden">
        

        <div class="btn-group">
            <button onclick="document.getElementById('sellModal').style.display='none'" class="btn-round cancel">취소</button>
            <button id="btnSellConfirm" class="btn-round primary">등록하기</button>
        </div>
    </div>
</div>
<div id="fontModal" class="modal-bg" style="z-index: 10002;"><div class="modal-box"><h3>폰트 선택</h3><div id="fontList" style="max-height:300px; overflow-y:auto;"></div><button onclick="document.getElementById('fontModal').style.display='none'" class="btn-round" style="margin-top:10px;">닫기</button></div></div>
<div id="choiceModal" class="modal-bg" style="z-index: 15000;">
    <div class="modal-box" style="width: 900px; max-width: 95%;">
        
        <div class="choice-layout">
    <div class="choice-left">
        <h3 style="margin-top:0;" data-i18n="choice_modal_title">🎨 작업 방식을 선택해주세요</h3>
<div id="choiceProdDesc" class="info-desc-box product-desc" style="display:none;"></div>

<p style="color:#666; font-size:14px; margin-bottom:20px; line-height:1.5;" data-i18n="choice_modal_desc">
    선택하신 <span id="choiceProdName" style="color:#6366f1; font-weight:bold;">상품</span>으로 디자인을 시작하거나,<br>
    이미 완성된 파일이 있다면 바로 주문할 수 있습니다.
</p>

        <div style="display:flex; gap:15px; margin-bottom:20px;">
            <button onclick="window.confirmChoice('editor')" class="btn-round primary" style="flex:1; height:120px; flex-direction:column; justify-content:center; gap:10px;">
                <i class="fa-solid fa-palette" style="font-size:32px;"></i>
                <span style="font-size:16px;" data-i18n="btn_design_direct">직접 디자인하기</span>
                <span style="font-size:12px; font-weight:normal; opacity:0.8;" data-i18n="btn_design_direct_sub">에디터에서 꾸미기</span>
            </button>

            <button onclick="window.confirmChoice('cart')" class="btn-round" style="flex:1; height:120px; flex-direction:column; justify-content:center; gap:10px; background:#fff; color:#334155; border:2px solid #cbd5e1; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);">
                <i class="fa-solid fa-cart-plus" style="font-size:32px; color:#ef4444;"></i>
                <span style="font-size:16px; font-weight:bold;">CART</span>
                <span style="font-size:12px; font-weight:normal; opacity:0.8;">Add to Cart</span>
            </button>
        </div>

        <button onclick="document.getElementById('choiceModal').style.display='none'; location.reload();" class="btn-round" style="width:100%; margin-bottom:10px; background:#f1f5f9; color:#64748b; border:none;">
            <i class="fa-solid fa-arrow-left"></i> Home
        </button>

        <input type="file" id="directUploadInput" style="display:none;" accept="image/*,.pdf">
        
        <button onclick="document.getElementById('choiceModal').style.display='none'" class="btn-round" style="margin-top:auto; background:transparent; border:1px solid #ddd; color:#888;" data-i18n="btn_close">닫기</button>
    </div>

    <div class="choice-right">
        <img id="choiceProductImg" src="" alt="상품 이미지">

        <div id="customSizePanel" style="display:none; flex-direction:column; justify-content:center; height:100%; padding:20px; background:#f8fafc; border-radius:12px;">
            <h3 style="text-align:center; color:#334155; margin-top:0;">📏 사이즈 입력</h3>
            
            <div style="margin-bottom:15px;">
                <label style="font-weight:bold; font-size:13px; color:#64748b;">가로 (Width) mm</label>
                <input type="number" id="inputCustW" class="ai-input-pretty" placeholder="예: 1000" oninput="window.calcCustomPrice()">
            </div>

            <div style="margin-bottom:15px;">
                <label style="font-weight:bold; font-size:13px; color:#64748b;">세로 (Height) mm</label>
                <input type="number" id="inputCustH" class="ai-input-pretty" placeholder="예: 2000" oninput="window.calcCustomPrice()">
            </div>

            <input type="hidden" id="inputCustQty" value="1">

            <div style="background:#1e293b; color:white; padding:15px; border-radius:8px; text-align:center;">
                <div style="font-size:12px; opacity:0.8;">예상 견적 금액 (1개 기준)</div>
                <div id="calcResultPrice" style="font-size:24px; font-weight:800; color:#fbbf24;">0원</div>
                <div id="calcResultSize" style="font-size:11px; margin-top:5px; color:#94a3b8;">-</div>
            </div>
            
            <p style="font-size:12px; color:#64748b; margin-top:10px; line-height:1.5; word-break:keep-all;">
                ※ 예상 금액입니다. 배송비와 마감 비용 등이 추가될 수 있으며, 회원 등급에 따라 할인이 적용됩니다.<br>
                <b>최종 금액은 장바구니에서 확인하세요.</b>
            </p>
                
                <div id="calcResultSize" style="font-size:11px; margin-top:5px; color:#94a3b8;">-</div>
            </div>
        </div>
        </div>
</div>

    </div>
</div>
<div id="mobileControlDock" style="z-index: 30000;">
    <button onclick="window.toggleMobilePanel('left')" class="mobile-fab left">
        <i class="fa-solid fa-shapes"></i>
        <span>글자도형</span>
    </button>

    <button onclick="window.toggleMobilePanel('right')" class="mobile-fab right">
        <i class="fa-solid fa-layer-group"></i>
        <span>편집/정렬</span>
    </button>
</div>
<div id="categoryDetailModal" class="modal-bg" style="z-index: 15000;">
    <div class="modal-box" style="width: 800px; max-width: 95%; position: relative;">
        
        <button onclick="document.getElementById('categoryDetailModal').style.display='none'" 
                style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #94a3b8; z-index: 10;">
            <i class="fa-solid fa-xmark"></i>
        </button>
        <h3 id="catModalTitle">📏 사이즈(제품)를 선택해주세요</h3>
        
        <div style="margin-bottom: 15px; position: relative;">
            <input type="text" id="modalProdSearch" class="ai-input-pretty" 
                   placeholder="🔍 찾으시는 상품명이나 사이즈를 입력하세요..." 
                   style="width:100%; margin:0; padding-left: 35px;"
                   onkeyup="window.filterModalItems(this.value)">
            <i class="fa-solid fa-magnifying-glass" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8;"></i>
        </div>

        <div id="catModalDesc" class="info-desc-box" style="display:none;"></div>
        
        <div id="catProductGrid" class="quick-menu-track" style="grid-template-columns: repeat(4, 1fr);"></div>
        
        <button onclick="document.getElementById('categoryDetailModal').style.display='none'" class="btn-round" style="margin-top:20px;">닫기</button>
    </div>
</div>
<div id="logoUploadModal" class="modal-bg" style="z-index: 20000;">
    <div class="modal-box" style="width: 400px;">
        <h3 style="margin-top:0;">☁️ Upload Logo</h3>
        <div class="upload-drop-zone" id="dropZone" onclick="document.getElementById('logoFileInput').click()">
            <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
            <span class="upload-text">Click or Drag</span>
            <img id="previewImage">
            <div id="removeFileBtn" onclick="window.resetUpload(event)">✕</div>
        </div>
        <input type="file" id="logoFileInput" accept="image/png, image/jpeg, image/svg+xml" style="display:none;" onchange="window.handleFileSelect(this)">
        <input type="text" id="logoKeywordInput" class="ai-input-pretty" placeholder="PNG로고 등록시 150원 즉시 지급 MY page에서 확인">
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="window.uploadUserLogo()" class="btn-round primary" style="flex:2;">Upload</button>
            <button onclick="document.getElementById('logoUploadModal').style.display='none'" class="btn-round" style="flex:1;">Cancel</button>
        </div>
    </div>
</div>


<div id="aiStartModal" class="modal-bg" style="z-index: 15000;">
    <div class="modal-box" style="width: 500px; max-width: 90%;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">✨ AI 이미지 생성 (Start)</h3>
            <button onclick="document.getElementById('aiStartModal').style.display='none'" style="border:none; background:none; cursor:pointer; font-size:20px;">✕</button>
        </div>
        
        <p style="color:#666; font-size:14px; margin-bottom:10px;">이미지를 만들면 다른 유저에게 자동으로 공유되고 현금으로 적립됩니다.</p>
        
        <textarea id="aiStartPrompt" class="ai-input-pretty" placeholder="멋진 프롬프트를 작성하시면 최상위 AI 모델로 멋진 작품을 만들어 줍니다. 시작화면으로 가서 새로고침 하면 고객님께서 생성한 멋진 작품이 하단작품에 등록되어 있을거예요." style="height:100px;"></textarea>
        
        <button id="btnAiStartGen" class="btn-round primary" style="width:100%; margin-top:5px;">
            🎨 생성하기
        </button>

        <div id="aiStartResult" style="margin-top:20px; min-height:300px; background:#f8fafc; border-radius:12px; display:flex; align-items:center; justify-content:center; border:1px solid #e2e8f0;">
            <span style="color:#cbd5e1;">이미지가 여기에 표시됩니다</span>
        </div>

        <button id="btnAiStartGo" class="btn-round" style="width:100%; margin-top:15px; display:none; background:#111; color:#fff;">
            🚀 이 이미지로 디자인 시작하기
        </button>
    </div>
</div>
<script type="module" src="./config.js?v=119"></script>
<script type="module" src="./canvas-core.js?v=119"></script>
<script type="module" src="./canvas-size.js?v=119"></script>
<script type="module" src="./canvas-guides.js?v=119"></script>
<script type="module" src="./canvas-zoom-pan.js?v=119"></script>
<script type="module" src="./canvas-objects.js?v=119"></script>
<script type="module" src="./canvas-image.js?v=119"></script>
<script type="module" src="./canvas-template.js?v=119"></script> 
<script type="module" src="./canvas-ai.js?v=119"></script>
<script type="module" src="./canvas-utils.js?v=119"></script>
<script type="module" src="./shortcuts.js?v=119"></script>
<script type="module" src="./context-menu.js?v=119"></script>
<script type="module" src="./export.js?v=119"></script>
<script type="module" src="./order.js?v=119"></script>
<script type="module" src="./login.js?v=119"></script>
<script type="module" src="./my-design.js?v=119"></script>
<script type="module" src="./main.js?v=119"></script>

<script type="module">
    import { addNewPage, switchPage, deleteCurrentPage } from "./canvas-pages.js";
    // HTML 버튼에서 onclick으로 쓰기 위해 전역 등록
    window.addPage = addNewPage;
    window.changePage = switchPage;
    window.deletePage = deleteCurrentPage;
</script>
<script>
    // [추가] 모바일 전용 스마트 화면 맞춤 함수
    // [개선된] 모바일 전용 스마트 화면 맞춤 함수
    window.smartMobileFit = function() {
        if (!window.canvas) return;
        
        // ★ 핵심: 좌표가 틀어진 상태에서 계산하면 엉뚱한 곳으로 가므로, 일단 초기화
        window.canvas.setViewportTransform([1, 0, 0, 1, 0, 0]); 

        // 1. 대지(Board) 찾기
        const board = window.canvas.getObjects().find(o => o.isBoard);
        if (!board) return;

        const canvasW = window.canvas.getWidth();
        const canvasH = window.canvas.getHeight();
        const boardW = board.getScaledWidth();
        const boardH = board.getScaledHeight();

        // 2. 안전 영역 (버튼 피하기)
        const paddingX = 40;  // 좌우 여백
        const paddingY = 200; // 상하 여백 (하단 독바 + 상단 메뉴 고려 넉넉하게)

        // 3. 줌 계산
        const safeW = canvasW - paddingX;
        const safeH = canvasH - paddingY;
        let zoom = Math.min(safeW / boardW, safeH / boardH);

        // 세로 배너형일 경우 더 작게 (한눈에 들어오게)
        const isVertical = boardH > boardW * 1.2;
        if (isVertical) zoom *= 0.85; 
        else zoom *= 0.95;

        zoom = Math.min(Math.max(zoom, 0.05), 5);

        // 4. 중앙 좌표 계산 (초기화된 상태 기준)
        const vpt = window.canvas.viewportTransform;
        vpt[0] = zoom;
        vpt[3] = zoom;
        
        // 가로 중앙 정렬
        vpt[4] = (canvasW - boardW * zoom) / 2;

        // 세로 정렬 (세로형은 위로, 일반형은 중앙)
        if (isVertical) {
            vpt[5] = 80; // 상단 여백 80px 띄우고 배치
        } else {
            vpt[5] = (canvasH - boardH * zoom) / 2 - 20; // 중앙에서 살짝 위
        }

        window.canvas.setViewportTransform(vpt);
        window.canvas.requestRenderAll();
        console.log("📱 스마트 맞춤 완료 (치우침 보정됨)");
    };
</script>
<script>
    // [추가] 사이드바 검색 핸들러 (0.5초 딜레이)
    let sideSearchTimeout;
    window.handleSideSearch = function(keyword) {
        if (sideSearchTimeout) clearTimeout(sideSearchTimeout);
        
        sideSearchTimeout = setTimeout(() => {
            const currentKey = window.currentProductKey || 'custom';
            if (window.loadSideBarTemplates) {
                window.loadSideBarTemplates(currentKey, keyword);
            }
        }, 500);
    };
</script>
<div id="generalProductModal" class="modal-bg" style="z-index: 15500; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 800px; max-width: 95%; display: flex; overflow: hidden; padding: 0;">
        <div style="width: 45%; background: #f8fafc; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <img id="genProdImg" src="" style="max-width: 100%; max-height: 300px; object-fit: contain; border-radius: 8px;">
        </div>
        
        <div style="width: 55%; padding: 30px; display: flex; flex-direction: column;">
            <div style="flex: 1;">
                <h2 id="genProdTitle" style="margin: 0 0 10px 0; color: #1e293b;">상품명</h2>
                <div id="genProdDesc" style="font-size: 13px; color: #64748b; margin-bottom: 20px; line-height: 1.5;">설명</div>
                
                <div style="background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: bold; color: #334155;">단가</span>
                        <span id="genProdPrice" style="font-weight: bold;">0원</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; color: #334155;">수량</span>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" id="genProdQty" value="1" min="1" 
                                   style="width: 100px; padding: 5px; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; font-weight: bold; font-size: 16px;"
                                   onclick="this.select()" 
                                   onchange="window.updateGeneralTotal()" 
                                   oninput="window.updateGeneralTotal()">
                            <span>개</span>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; border-top: 1px solid #f1f5f9; padding-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="font-size: 14px; color: #64748b;">총 결제금액</span>
                    <span id="genProdTotal" style="font-size: 24px; font-weight: 900; color: #6366f1;">0원</span>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="window.addGeneralToCart()" class="btn-round primary" style="flex: 1; height: 50px; font-size: 16px;">
                        🛒 장바구니 담기
                    </button>
                    <button onclick="document.getElementById('generalProductModal').style.display='none'" class="btn-round" style="width: 80px; border: 1px solid #e2e8f0; color: #64748b; background: white;">
                        취소
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="./text-wizard.js?v=119"></script> 
<script>
    
    // [0] 파트너스 센터 입장 함수 (마스터키 + 호환성 적용)
    // [0] 파트너스 센터 입장 함수 (마스터키 + Platinum 허용)
    window.enterPartnerCenter = function() {
        // 1. 로그인 체크
        if (!window.currentUser) {
            alert(window.t ? window.t('msg_login_required') : "로그인이 필요합니다.");
            document.getElementById('loginModal').style.display = 'flex';
            return;
        }

        // 2. 현재 로그인 정보 확인
        const myEmail = (window.currentUser.email || '').toLowerCase().trim();
        
        // 등급 가져오기 (DB 위치별 체크)
        let r = window.currentUser.role;
        if (!r && window.currentUser.user_metadata) r = window.currentUser.user_metadata.role;
        if (!r && window.currentUser.app_metadata) r = window.currentUser.app_metadata.role;
        
        let finalRole = (r || 'user').toLowerCase().trim();

        // ★ partners(복수형)만 partner로 통일
        if (finalRole === 'partners') finalRole = 'partner';

        // ★ [핵심] 사장님 이메일 프리패스 (DB 오류 무시하고 무조건 입장)
        const adminEmails = ['korea900@daum.net', 'korea900as@gmail.com'];
        if (adminEmails.includes(myEmail)) {
            console.log("👑 관리자(파트너스) 계정 확인됨 -> 프리패스 입장");
            finalRole = 'partner'; 
        }

        console.log("최종 인식 등급:", finalRole);

        // 3. 입장 허용 목록 (platinum 포함)
        const allowedRoles = ['admin', 'franchise', 'partner', 'platinum'];

        if (allowedRoles.includes(finalRole)) {
            // 1. 모달이 있는 페이지(index.html)라면 모달 열기
            const modal = document.getElementById('partnerConsoleModal');
            if (modal) {
                modal.style.display = 'flex';
                
                // 뱃지 UI 업데이트
                const badge = document.getElementById('partnerRegionBadge');
                if (badge) {
                    if (finalRole === 'franchise') {
                        badge.innerText = window.currentUser.region || '가맹점';
                        badge.style.backgroundColor = '#6366f1'; 
                    } else if (finalRole === 'admin') {
                        badge.innerText = '관리자 (Master)';
                        badge.style.backgroundColor = '#1e293b'; 
                    } else {
                        // partner, platinum 모두 파트너스로 표시
                        badge.innerText = '파트너스 (Partners)';
                        badge.style.backgroundColor = '#64748b'; 
                    }
                }
                // 데이터 로드
                if (window.switchPartnerTab) window.switchPartnerTab('pool');
            } 
            // 2. 모달이 없는 페이지라면 partner.html로 이동
            else {
                location.href = 'partner.html';
            }
        } else {
            // 실패 시 메시지
            alert(`🚫 입장 권한이 없습니다.\n\n[진단 정보]\n- 계정: ${myEmail}\n- 인식된 등급: ${finalRole}\n\n관리자 승인 후 이용해주세요.`);
        }
    };
    // [1] 파트너 신청 제출 함수
    window.submitRealPartnerApp = async function() {
        // sb(Supabase) 객체가 로드되었는지 확인
        if (typeof sb === 'undefined') { alert("시스템 로딩 중입니다. 잠시 후 다시 시도해주세요."); return; }

        const comp = document.getElementById('applyCompName').value;
        const phone = document.getElementById('applyPhone').value;
        const region = document.getElementById('applyRegion').value;
        const items = document.getElementById('applyMainItems').value;

        if(!comp || !phone || !region) return alert("필수 정보(업체명, 연락처, 지역)를 모두 입력해주세요.");

        const { data: { user } } = await sb.auth.getUser();
        if(!user) return alert("로그인이 필요합니다.");

        // DB에 저장
        const { error } = await sb.from('partner_applications').insert({
            user_id: user.id,
            company_name: comp,
            contact_phone: phone,
            region: region,
            main_items: items, // 주생산품목
            status: 'pending'
        });

        if(error) {
            alert("신청 오류: " + error.message);
        } else {
            alert("✅ 신청이 완료되었습니다.\n관리자 승인 후 '파트너스 센터'에 접속하실 수 있습니다.");
            document.getElementById('partnerApplyModal').style.display='none';
        }
    };

    // [2] 고객용: 도착한 입찰(견적) 확인 및 모달 띄우기
    window.checkBidsForOrder = async function(orderId) {
        // 해당 주문의 입찰 내역 조회
        const { data: bids, error } = await sb.from('bids')
            .select('*')
            .eq('order_id', orderId)
            .order('price', { ascending: true }); // 저렴한 순

        if(error || !bids || bids.length === 0) {
            alert("아직 도착한 견적서가 없습니다.\n파트너사들이 확인 중이니 조금만 기다려주세요.");
            return;
        }

        // 모달 HTML 동적 생성
        const old = document.getElementById('bidListModal');
        if(old) old.remove();

        let listHtml = '';
        bids.forEach(bid => {
            // 선택된 상태인지 확인
            const isSelected = bid.status === 'selected';
            const bgClass = isSelected ? 'background:#f0fdf4; border-color:#bbf7d0;' : 'background:#fff;';
            
            // 버튼 또는 연락처 표시
            let actionArea = '';
            if(isSelected) {
                actionArea = `
                    <div style="margin-top:10px; padding:10px; background:#fff; border-radius:6px; text-align:center;">
                        <div style="font-size:12px; color:#15803d; font-weight:bold;">🎉 시공 파트너로 선정되었습니다!</div>
                        <div style="font-size:16px; font-weight:800; color:#1e293b; margin-top:5px;">📞 ${bid.partner_phone}</div>
                        <button onclick="writePartnerReview('${bid.partner_id}', '${bid.order_id}')" class="btn-round" style="margin-top:8px; width:100%; height:36px; font-size:12px;">⭐ 시공완료 후기 쓰기</button>
                    </div>
                `;
            } else {
                actionArea = `<button onclick="selectBid('${bid.id}', '${bid.order_id}')" class="btn-round primary" style="width:100%; margin-top:10px;">이 파트너 선택하기</button>`;
            }

            listHtml += `
                <div style="border:1px solid #e2e8f0; padding:15px; border-radius:12px; margin-bottom:10px; ${bgClass}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold; font-size:15px;">${bid.company_name || '파트너사'}</span>
                        <span style="font-weight:bold; color:#6366f1; font-size:16px;">${bid.price.toLocaleString()}원</span>
                    </div>
                    <p style="font-size:13px; color:#475569; margin:10px 0; line-height:1.4;">"${bid.message}"</p>
                    ${actionArea}
                </div>
            `;
        });

        const modalHtml = `
            <div id="bidListModal" class="modal-bg" style="display:flex; z-index:20000; align-items:center; justify-content:center;">
                <div class="modal-box" style="width:400px; max-height:80vh; overflow-y:auto; background:#f8fafc;">
                    <h3 style="margin-top:0;">📋 도착한 견적서 (${bids.length}건)</h3>
                    <p style="color:#666; font-size:13px; margin-bottom:15px;">마음에 드는 파트너를 선택하여 공사를 진행하세요.</p>
                    <div>${listHtml}</div>
                    <button onclick="document.getElementById('bidListModal').remove()" class="btn-round" style="width:100%; margin-top:15px; background:#e2e8f0; color:#334155; border:none;">닫기</button>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    };

    // [3] 파트너 선택 함수
    window.selectBid = async function(bidId, orderId) {
        if(!confirm("이 파트너를 선택하시겠습니까?\n선택 시 파트너의 연락처가 공개되며, 다른 입찰은 마감됩니다.")) return;

        // 1. 해당 입찰 승인
        await sb.from('bids').update({ status: 'selected' }).eq('id', bidId);
        // 2. 나머지는 거절 처리
        await sb.from('bids').update({ status: 'rejected' }).eq('order_id', orderId).neq('id', bidId);
        // 3. 주문 상태 변경 (제작준비)
        await sb.from('orders').update({ status: '제작준비' }).eq('id', orderId);

        alert("✅ 파트너 선택 완료! 연락처를 확인하여 일정을 조율하세요.");
        document.getElementById('bidListModal').remove();
        checkBidsForOrder(orderId); // 모달 다시 열어서 결과 보여줌
    };

    // [4] 후기 작성 함수
    window.writePartnerReview = async function(partnerId, orderId) {
        const rating = prompt("평점을 입력해주세요 (1~5점):", "5");
        if(!rating) return;
        const comment = prompt("파트너에 대한 솔직한 후기를 남겨주세요:", "친절하고 꼼꼼하게 작업해주셨습니다!");
        if(!comment) return;

        const { data: { user } } = await sb.auth.getUser();
        const { error } = await sb.from('partner_reviews').insert({
            partner_id: partnerId,
            order_id: orderId,
            customer_id: user.id,
            rating: parseInt(rating),
            comment: comment
        });

        if(error) alert("작성 실패: " + error.message);
        else alert("소중한 후기가 등록되었습니다!");
    };
</script>

</body>
</html>

<script type="module">
    // ★ 여기 파일명 뒤에 ?v=119 를 꼭 붙여야 캐시가 깨집니다!
    import { canvas, setMaxLimits } from './canvas-core.js?v=119';
    import { openProductDetail, startDesignFromProduct, addProductToCartDirectly } from './order.js?v=119'; // [수정] 함수 추가됨
    import { applySize } from './canvas-size.js?v=119';
    import { sb, PRODUCT_DB, cartData, currentUser, initConfig, getLocalizedData } from './config.js?v=119';

    // -----------------------------------------------------------
    // [1] 전역 변수 및 헬퍼 함수 설정
    // -----------------------------------------------------------
    window.canvas = canvas;
    // index.html 내부 스크립트 수정

window.getTinyThumb = function(url, size = 150) {
    if (!url) return '';
    
    // 1. Base64 데이터는 그대로 반환
    if (url.startsWith('data:image')) return url;

    // [★수정] 이미 Supabase 리사이징 옵션이 붙어있다면 원본 그대로 반환 (중복 방지)
    if (url.includes('width=') && url.includes('resize=')) {
        return url;
    }

    // 2. URL 파라미터 연결자 결정
    const separator = url.includes('?') ? '&' : '?';

    // 3. 리사이징 파라미터 추가
    return `${url}${separator}width=${size}&height=${size}&resize=cover&quality=50&format=webp`;
};
    window.openProductDetail = openProductDetail;
    window.startDesignFromProduct = startDesignFromProduct;
    window.applySize = applySize;
    window.currentProductKey = 'A4';
    let selectedProductForChoice = null;

    // -----------------------------------------------------------
    // [2] 통합 언어 감지 및 SEO 자동 설정 (핵심 로직)
    // -----------------------------------------------------------
    // [2] 언어 감지 및 설정 (수정됨)
    const urlParams = new URLSearchParams(window.location.search);
    let detectedLang = urlParams.get('lang');

    // 1. 파라미터가 없으면 도메인으로 판단
    if (!detectedLang) {
        const hostname = window.location.hostname;
        if (hostname.includes('cafe3355.com')) {
            detectedLang = 'en'; // 영어 도메인
        } else if (hostname.includes('cafe0101.com')) {
            detectedLang = 'ja'; // 일본어 도메인
        } else {
            detectedLang = 'kr'; // 그 외 한국어
        }
    }
    
    // 언어 코드 소문자로 통일
    let CURRENT_LANG = detectedLang ? detectedLang.toLowerCase() : 'kr';
    if (CURRENT_LANG === 'jp') CURRENT_LANG = 'ja';
    if (CURRENT_LANG === 'us') CURRENT_LANG = 'en';

    console.log(`🌍 접속 모드: ${CURRENT_LANG} (Domain: ${window.location.hostname})`);

    // 메타태그 업데이트
    function updateSEOMetaTags(lang) {
        const metaData = {
            'kr': { title: "카멜레온프린팅", desc: "무료 디자인 에디터" },
            'en': { title: "Chameleon Printing", desc: "Free Design Editor" },
            'ja': { title: "カメレオンプリンティング", desc: "無料デザインエディタ" }
        };
        const data = metaData[lang] || metaData['kr'];
        document.title = data.title;
        document.documentElement.setAttribute('lang', lang);
    }
    updateSEOMetaTags(CURRENT_LANG);

    window.translations = {};

// ★ [신규 추가] 전역 번역 헬퍼 함수
window.t = function(key) {
    if (window.translations && window.translations[key]) {
        return window.translations[key];
    }
    // 번역 데이터가 아직 로드되지 않았거나 키가 없으면, 키 자체를 반환하거나 임시 처리
    // (디버깅을 위해 콘솔에 로그를 남겨도 좋습니다)
    // console.warn(`Missing translation: ${key}`);
    return key; 
};

    async function loadAndApplyTranslations() {
        // ★ 중요: long 폴더가 없다면 'long/'을 지우세요. 파일명 뒤에 시간을 붙여 캐시를 갱신합니다.
        const jsonPath = `long/${CURRENT_LANG}_${PROJECT_VERSION}.json?t=${new Date().getTime()}`;
        
        console.log(`📂 번역 파일 로딩: ${jsonPath}`);

        try {
            const response = await fetch(jsonPath);
            // 파일이 없으면 에러 발생
            if (!response.ok) throw new Error(`File not found (${response.status})`);
            
            const langData = await response.json();
            window.translations = langData; 

            // 텍스트 교체
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (langData[key]) el.innerHTML = langData[key];
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (langData[key]) el.placeholder = langData[key];
            });

            // 버튼 강제 번역
            const loginBtn = document.getElementById('btnLoginBtn');
            if (loginBtn && langData['btn_login']) loginBtn.innerText = langData['btn_login'];
            
            // 카카오 버튼 숨김 (한국어 아닐 때)
            const kakaoBtn = document.getElementById('btnKakaoLogin');
            if (kakaoBtn) kakaoBtn.style.display = (CURRENT_LANG === 'kr') ? 'flex' : 'none';

            loadLanguageFont(); // 폰트 적용

        } catch (error) {
            console.error(`🚨 번역 로드 실패 (${CURRENT_LANG}):`, error);
            // 영어/일본어 파일이 없을 때만 한국어로 자동 전환 (무한루프 방지)
            if (CURRENT_LANG !== 'kr') {
                console.warn("⚠️ 한국어로 전환합니다.");
                CURRENT_LANG = 'kr';
                loadAndApplyTranslations();
            }
        }
    }

    function loadLanguageFont() {
        const head = document.getElementsByTagName('head')[0];
        let fontLink = document.createElement('link');
        fontLink.rel = 'stylesheet';
        let fontFamily = "'Pretendard', sans-serif";

        if (CURRENT_LANG === 'ja') {
            fontLink.href = 'https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap';
            fontFamily = "'Noto Sans JP', sans-serif";
            window.currentCanvasFont = 'Noto Sans JP';
        } else if (CURRENT_LANG === 'en') {
            fontLink.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap';
            fontFamily = "'Inter', sans-serif";
            window.currentCanvasFont = 'Inter';
        } else {
            window.currentCanvasFont = 'Pretendard';
        }
        
        head.appendChild(fontLink);
        const style = document.createElement('style');
        style.innerHTML = `body, button, input, select, textarea { font-family: ${fontFamily} !important; }`;
        head.appendChild(style);
    }
    
    // 번역 실행
    loadAndApplyTranslations();

    // -----------------------------------------------------------
    // [4] 템플릿 클릭 & 필터링 함수 (기존 기능 복구)
    // -----------------------------------------------------------
    window.onTemplateClick = async function(tpl) {
        const startScreen = document.getElementById('startScreen');
        const isStartScreenVisible = startScreen && window.getComputedStyle(startScreen).display !== 'none';

        if (isStartScreenVisible) {
            document.getElementById('templateOverlay').style.display = 'none';
            window.pendingTemplate = tpl;
            if (window.showCategorySelectionModal) window.showCategorySelectionModal();
            else alert("사이즈 선택 화면을 불러올 수 없습니다.");
        } else {
            if(!confirm("현재 캔버스에 템플릿을 적용하시겠습니까?\n(기존 디자인 위에 추가됩니다)")) return;
            document.getElementById('templateOverlay').style.display = 'none';
            await window.applyTemplateDirectly(tpl);
        }
    };

    window.filterTpl = async function(category, btnElement) {
        if (btnElement) {
            const sidebar = document.querySelector('.tpl-sidebar');
            if(sidebar) sidebar.querySelectorAll('.tpl-cate-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
        }
        const grid = document.getElementById('tplGrid');
        if (!grid) return;
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; color:#888;">로딩 중...</div>';

        try {
            let query = sb.from('library')
              .select('id, thumb_url, category, tags') 
              .order('created_at', { ascending: false })
              .limit(50);
            if (category && category !== 'all') {
                query = query.ilike('category', `%${category}%`); 
            }
            const { data, error } = await query;
            if (error) throw error;
            grid.innerHTML = '';
            if (!data || data.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; color:#999;">데이터가 없습니다.</div>';
                return;
            }
            data.forEach(tpl => {
                const div = document.createElement('div');
                div.className = 'tpl-item';
                div.style.cssText = 'cursor:pointer; position:relative; overflow:hidden; border-radius:8px; aspect-ratio:1/1.4; background:#f1f5f9;';
                const imgSrc = tpl.thumb_url || 'https://via.placeholder.com/300?text=No+Image';
                div.innerHTML = `<img src="${imgSrc}" style="width:100%; height:100%; object-fit:cover;">`;
                div.onclick = () => window.onTemplateClick(tpl);
                grid.appendChild(div);
            });
        } catch (e) {
            console.error(e);
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">오류 발생</div>';
        }
    };

    // -----------------------------------------------------------
    // [5] 초기화 (Load Event)
    // -----------------------------------------------------------
    window.addEventListener('load', async () => {
        if (window.initConfig) await window.initConfig(); 
        else if (typeof initConfig === 'function') await initConfig();

        updateLoginButtonState();

        // ★ [중요] 아래에 있는 함수들을 여기서 호출하여 화면을 그립니다.
        if (typeof renderQuickMenu === 'function') renderQuickMenu();
        
        if(window.searchTemplates) window.searchTemplates('');
        if (window.preloadLanguageFont) window.preloadLanguageFont();
        if (typeof loadSpecialProducts === 'function') {
            loadSpecialProducts('hotDealSection', 'hotDealGrid', 'hotdeal', 6);
            loadSpecialProducts('bizDealSection', 'bizDealGrid', '23432424', 6);
        }

        const searchBtn = document.getElementById('btnStartSearch');
        const searchInput = document.getElementById('startSearchInput');
        if (searchBtn && searchInput) {
            const doSearch = () => { if(window.searchTemplates) window.searchTemplates(searchInput.value); };
            searchBtn.onclick = doSearch;
            searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') doSearch(); });
        }
        
        document.getElementById("loading").style.display = "none";
    });

    function updateLoginButtonState() {
        const btnLogin = document.getElementById('btnLoginBtn');
        const btnConsole = document.getElementById('btnPartnerConsole');
        if (window.currentUser) {
            if (btnLogin) {
                // [수정] 다국어 적용
                btnLogin.innerText = window.t('btn_logout'); 
                btnLogin.style.fontWeight = "bold"; 
                btnLogin.style.color = "#ef4444"; 
                const newBtn = btnLogin.cloneNode(true);
                btnLogin.parentNode.replaceChild(newBtn, btnLogin);
                newBtn.onclick = async function() {
                    // [수정] 다국어 적용
                    if (confirm(window.t('msg_logout_confirm'))) {
                        if(typeof sb !== 'undefined') await sb.auth.signOut();
                        localStorage.removeItem('sb-qinvtnhiidtmrzosyvys-auth-token'); 
                        window.location.reload(); 
                    }
                };
            }
            if(btnConsole) btnConsole.style.removeProperty('display');
        } else {
            if (btnLogin) {
                // [수정] 다국어 적용
                btnLogin.innerText = window.t('btn_login');
                btnLogin.style.fontWeight = "normal";
                btnLogin.style.color = "";
                const newBtn = btnLogin.cloneNode(true);
                btnLogin.parentNode.replaceChild(newBtn, btnLogin);
                newBtn.onclick = () => document.getElementById('loginModal').style.display = 'flex';
            }
            if(btnConsole) btnConsole.style.setProperty('display', 'none', 'important');
        }
    }

    // 마이페이지 복구 로직
    const loadId = localStorage.getItem('load_design_id');
    if (loadId) {
        localStorage.removeItem('load_design_id');
        setTimeout(async () => {
            const loading = document.getElementById('loading');
            if(loading) loading.style.display = 'flex';
            try {
                const { data, error } = await sb.from('user_designs').select('*').eq('id', loadId).single();
                if (error || !data) throw new Error("디자인을 찾을 수 없습니다.");
                if (data.json && !data.json_data) data.json_data = data.json;

                document.getElementById("startScreen").style.display = "none";
                document.getElementById("mainEditor").style.display = "flex";
                document.body.classList.add('editor-active');

                if (window.restoreDesignFromData) window.restoreDesignFromData(data);
            } catch (e) {
                console.error(e);
                alert("불러오기 실패: " + e.message);
                if(loading) loading.style.display = 'none';
            }
        }, 800);
    }

    // PDF 폰트 설정
    window.pdfFontCache = null;
    window.pdfFontName = 'NanumGothic'; 
    window.preloadLanguageFont = async function() { 
        try { 
            let fontUrl = 'https://cdn.jsdelivr.net/gh/google/fonts@main/ofl/nanumgothic/NanumGothic-Regular.ttf'; 
            const r = await fetch(fontUrl); 
            if(r.ok) { 
                const b = await r.blob(); 
                const rd = new FileReader(); 
                rd.onloadend = function() { window.pdfFontCache = rd.result.split(',')[1]; }; 
                rd.readAsDataURL(b); 
            } 
        } catch(e) { console.error("Font Load Error:", e); } 
    };
    window.loadKoreanFontForPDF = async function(doc) { 
        if(window.pdfFontCache) { 
            try { 
                const fileName = window.pdfFontName + '.ttf';
                doc.addFileToVFS(fileName, window.pdfFontCache); 
                doc.addFont(fileName, window.pdfFontName, 'normal'); 
                doc.setFont(window.pdfFontName); 
            } catch(e) { console.warn(e); } 
        } 
    };

    // PDF.js 워커 설정
    if (window.pdfjsLib) window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // [추가] 핫딜 렌더링 함수
    // [새로운 통합 함수] 일반 핫딜 + 업자용 핫딜 모두 처리
    // [수정됨] 핫딜 상품 로드 (언어/화폐 감지 추가)
// [최적화됨] 핫딜/추천상품 로드 (언어 로직 제거됨 -> getLocalizedData 위임)
async function loadSpecialProducts(sectionId, gridId, categoryCode, limitCount = 6) {
    const section = document.getElementById(sectionId);
    const grid = document.getElementById(gridId);
    if (!grid) return;

    try {
        const { data: products, error } = await sb.from('admin_products')
            .select('*')
            .eq('category', categoryCode)
            .order('sort_order', { ascending: true }) 
            .limit(limitCount); 

        if (error) throw error;

        if (!products || products.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        grid.innerHTML = '';

        products.forEach(p => {
            if (!window.PRODUCT_DB) window.PRODUCT_DB = {};
            
            // ★ [핵심] 여기서 지저분한 if문을 싹 제거하고 한 줄로 끝냅니다!
            const { name, price, formattedPrice } = getLocalizedData(p);
            
            // 전역 DB 저장 (에디터 연동용)
            window.PRODUCT_DB[p.code] = {
                name: name,
                price: price,
                w: p.width_mm, h: p.height_mm,
                img: p.img_url,
                addons: p.addons ? p.addons.split(',') : [],
                category: p.category
            };

            const card = document.createElement('div');
            card.className = 'hotdeal-card';
            const imgSrc = p.img_url || 'https://via.placeholder.com/300?text=No+Image';
            const sizeText = (p.width_mm && p.height_mm) ? `${p.width_mm} x ${p.height_mm}mm` : 'Option';
            
            // 뱃지 색상
            const badgeColor = categoryCode === 'hotdeal' ? '#ef4444' : '#4f46e5';
            const badgeText = categoryCode === 'hotdeal' ? 'HOT' : 'BIZ';

            // HTML 생성 (이제 name과 formattedPrice 변수만 넣으면 끝)
            card.innerHTML = `
                <div class="hotdeal-img-box">
                    <img src="${imgSrc}" alt="${name}" onerror="this.src='https://placehold.co/300?text=No+Img'">
                    <div style="position:absolute; top:10px; left:10px; background:${badgeColor}; color:white; font-size:11px; font-weight:bold; padding:2px 8px; border-radius:4px;">${badgeText}</div>
                </div>
                <div class="hotdeal-info">
                    <div class="hotdeal-title">${name}</div>
                    <div class="hotdeal-meta">${sizeText}</div>
                    <div class="hotdeal-price">${formattedPrice}</div>
                </div>
            `;

            card.onclick = () => {
                window.currentProductKey = p.code;
                window.selectedProductForChoice = window.PRODUCT_DB[p.code];
                window.startEditorDirect(p.code);
            };

            grid.appendChild(card);
        });

    } catch (e) {
        console.error(`[${categoryCode}] 로딩 실패:`, e);
        section.style.display = 'none';
    }
}

    window.goBoardWithCategory = function(boardType, subCode, subName) {
        const hostname = window.location.hostname;
        let targetCountry = 'KR';
        if (hostname.includes('cafe3355.com')) targetCountry = 'US';
        else if (hostname.includes('cafe0101.com')) targetCountry = 'JP';

        // 해당 소분류 코드(sub_code)와 이름(sub_name)을 달고 새 창 열기
        const url = `/board.html?cat=${boardType}&country=${targetCountry}&sub_code=${encodeURIComponent(subCode)}&sub_name=${encodeURIComponent(subName)}`;
        window.open(url, '_blank');
    };
    window.openTopMenu = async function(topCode, titleText) {
        const modal = document.getElementById('categoryDetailModal');
        const grid = document.getElementById('catProductGrid');
        const titleEl = document.getElementById('catModalTitle');
        const descEl = modal.querySelector('p');

        // 1. 모달 창 열기 & 로딩 표시
        modal.style.display = 'flex';
        if(titleEl) titleEl.innerHTML = `<span style="color:#6366f1;">${titleText}</span> <span style="font-size:14px; color:#888; font-weight:normal;">(세부 항목 선택)</span>`;
        if(descEl) descEl.innerText = "원하시는 카테고리를 선택해주세요.";
        
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px;">Loading...</div>';

        try {
            // 2. 해당 메뉴의 하위 카테고리 목록 가져오기
            const { data: subCats } = await sb.from('admin_categories')
                .select('*')
                .eq('top_category_code', topCode) 
                .order('sort_order', { ascending: true });

            // 카테고리가 아예 없으면 -> 바로 상품 목록 보여주기로 넘어감
            if (!subCats || subCats.length === 0) {
                 window.showCategoryProducts(topCode, titleText);
                 return;
            }

            // 3. ★ [핵심] 빈 이미지를 채우기 위해 상품 이미지 미리 가져오기
            const { data: prodImages } = await sb.from('admin_products')
                .select('category, img_url')
                .not('img_url', 'is', null) // 이미지가 있는 것만
                .neq('img_url', '');

            // "카테고리 코드" : "상품 이미지 URL" 형태로 정리 (매핑)
            const catThumbMap = {};
            if (prodImages) {
                prodImages.forEach(p => {
                    // 아직 이 카테고리에 할당된 이미지가 없으면, 첫번째 발견된 상품 이미지를 등록
                    if (p.category && !catThumbMap[p.category]) {
                        catThumbMap[p.category] = p.img_url;
                    }
                });
            }

            grid.innerHTML = '';

            // 4. 화면에 버튼들 그리기
            subCats.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'quick-item';
                div.style.cursor = 'pointer';

                // 원본 URL 가져오기
let rawUrl = cat.img_url || cat.image || cat.thumbnail || catThumbMap[cat.code] || '';
// 리사이징 함수 적용 (150px)
let iconUrl = window.getTinyThumb(rawUrl, 150);
                
                let imgTag = '';
                if (iconUrl) {
                    imgTag = `<img src="${iconUrl}" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentNode.innerHTML='<i class=\\'fa-solid fa-folder-open\\'></i>'">`;
                } else {
                    imgTag = `<i class="fa-solid fa-folder-open" style="font-size:24px; color:#cbd5e1;"></i>`;
                }

                div.innerHTML = `
                    <div class="quick-icon" style="background:#fff; border:1px solid #f1f5f9; overflow:hidden; display:flex; align-items:center; justify-content:center;">
                        ${imgTag}
                    </div>
                    <div class="quick-text">${cat.name}</div>
                `;

                // 클릭하면 상품 목록으로 이동
                div.onclick = () => {
                    window.showCategoryProducts(cat.code, cat.name);
                };

                grid.appendChild(div);
            });

        } catch (e) {
            console.error("상단 메뉴 로딩 에러:", e);
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">데이터를 불러오지 못했습니다.</div>';
        }
    };

// =================================================================
// [통합 수정본] 카테고리 렌더링 & 전체 검색 & 모달 검색 수정
// =================================================================
// =================================================================
// [최종 업데이트] 데이터 로드 (상품 코드, 가격 포함)
// =================================================================
let globalSubCats = [];      // 카테고리 데이터
let globalProdImages = [];   // 상품 데이터 (검색용)
let globalCatThumbMap = {};  // 썸네일 매핑

async function renderQuickMenu() {
    const tabContainer = document.getElementById('topCategoryTabs');
    const itemContainer = document.getElementById('quickMenuContainer');
    if (!tabContainer || !itemContainer) return;

    itemContainer.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px;"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</div>';

    const isJP = window.location.hostname.includes('cafe0101.com') || window.location.href.includes('lang=ja');
    const isUS = window.location.hostname.includes('cafe3355.com') || window.location.href.includes('lang=en');

    try {
        // 1. 카테고리 데이터
        let { data: topCats } = await sb.from('admin_top_categories').select('*').order('sort_order', { ascending: true });
        const { data: subCats } = await sb.from('admin_categories').select('*').order('sort_order', { ascending: true });
        
        // 2. 상품 데이터 (전체 정보 가져오기)
        const { data: prodImages } = await sb.from('admin_products')
            .select('*') // [수정] 상세 정보(사이즈,설명 등)를 위해 전체 컬럼 선택
            .not('img_url', 'is', null).neq('img_url', '');

        // 전역 변수 저장
        globalSubCats = subCats || [];
        globalProdImages = prodImages || [];

        // 3. 썸네일 매핑 및 PRODUCT_DB 등록 (검색된 상품 클릭 시 정보 로드용)
        if (prodImages) {
            // PRODUCT_DB 초기화 확인
            if (!window.PRODUCT_DB) window.PRODUCT_DB = {};

            prodImages.forEach(p => {
                // 3-1. 썸네일 매핑 (기존 로직)
                if (p.category && !globalCatThumbMap[p.category]) {
                    globalCatThumbMap[p.category] = p.img_url;
                }

                // 3-2. [추가] 상세 정보 전역 DB 등록
                // 다국어 처리 확인
                let localName = p.name;
                let localPrice = p.price;
                if(typeof window.getLocalizedData === 'function') {
                    const localData = window.getLocalizedData(p);
                    localName = localData.name;
                    localPrice = localData.price;
                }

                window.PRODUCT_DB[p.code] = {
                    name: localName,
                    price: localPrice,
                    w_mm: p.width_mm, 
                    h_mm: p.height_mm,
                    img: p.img_url, 
                    description: p.description, 
                    addons: p.addons ? p.addons.split(',') : [], 
                    category: p.category,
                    is_custom_size: p.is_custom_size,
                    is_general_product: p.is_general_product
                };
            });
        }

        // 4. 탭 생성 (기존 로직 유지)
        const renderTabs = () => {
            tabContainer.innerHTML = '';
            if (topCats) {
                const seen = new Set();
                topCats = topCats.filter(cat => {
                    const name = cat.name.trim();
                    if (seen.has(name)) return false;
                    seen.add(name);
                    return true;
                });
                const hiddenNames = ['배너/현수막', '전시/매대', '기본 대분류', '기본대분류'];
                topCats = topCats.filter(cat => !hiddenNames.includes(cat.name));

                topCats.forEach(top => {
                    let topName = top.name;
                    if (isJP) topName = top.name_jp || top.name;
                    else if (isUS) topName = top.name_us || top.name;

                    const btn = document.createElement('button');
                    btn.className = 'cat-tab';
                    btn.innerText = topName;
                    
                    btn.onclick = (e) => {
                        const tabs = tabContainer.querySelectorAll('.cat-tab');
                        tabs.forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        // 검색창 초기화
                        const searchInput = document.getElementById('mainCategorySearch');
                        if(searchInput) searchInput.value = '';
                        renderItemsByFilter(top.code);
                    };
                    tabContainer.appendChild(btn);
                });
            }
            // 기타 탭
            const orphanCats = subCats.filter(sub => !sub.top_category_code);
            if (orphanCats.length > 0) {
                const etcBtn = document.createElement('button');
                etcBtn.className = 'cat-tab';
                etcBtn.innerText = isJP ? 'Others' : '기타';
                etcBtn.onclick = (e) => {
                    document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById('mainCategorySearch').value = '';
                    renderItemsByFilter('etc');
                };
                tabContainer.appendChild(etcBtn);
            }
        };

        // 5. 그리드 그리기 (공통 함수)
        window._drawQuickItems = (list, isProductMode = false) => {
            itemContainer.innerHTML = '';
            if (!list || list.length === 0) {
                itemContainer.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px 0; color:#94a3b8;">검색 결과가 없습니다.</div>`;
                return;
            }

            list.forEach(item => {
                const isProduct = isProductMode || item.price !== undefined; // 가격이 있으면 상품으로 간주
                
                let name = item.name;
                let rawUrl = item.img_url || item.image || (isProduct ? '' : globalCatThumbMap[item.code]);
                const tinyUrl = window.getTinyThumb ? window.getTinyThumb(rawUrl, 150) : rawUrl;
                
                // 클릭 이벤트 분기
                let clickAction = '';
                let badge = '';

                if (isProduct) {
                    // ★ 상품 클릭 시 분기 처리 (일반상품 vs 디자인상품)
                    if (item.is_general_product) {
                        clickAction = `window.openGeneralProductModal('${item.code}')`;
                    } else {
                        clickAction = `window.showChoiceModal('${item.code}')`;
                    }
                    badge = `<span style="position:absolute; top:5px; left:5px; background:#6366f1; color:white; font-size:10px; padding:2px 6px; border-radius:4px; z-index:2;">상품</span>`;
                } else {
                    // 카테고리 클릭 시 -> 상품 리스트 모달
                    const safeDesc = (item.description || '').replace(/\n/g, ' ').replace(/'/g, "\\'");
                    clickAction = `window.showCategoryProducts('${item.code}', '${name}', '${safeDesc}')`;
                }

                const div = document.createElement('div');
                div.className = 'quick-item';
                if (isUS || isJP) div.classList.add('long-text-mode');

                let imgTag = tinyUrl 
                    ? `<img src="${tinyUrl}" loading="lazy" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentNode.innerHTML='<i class=\\'fa-solid fa-cube\\'></i>'">`
                    : `<i class="fa-solid fa-folder-open" style="font-size:24px; color:#cbd5e1;"></i>`;

                div.innerHTML = `
                    <div class="quick-icon" onclick="${clickAction}" style="background:#fff; border:1px solid #f1f5f9; overflow:hidden; display:flex; align-items:center; justify-content:center; cursor:pointer; position:relative;">
                        ${badge}
                        ${imgTag}
                    </div>
                    <div class="quick-text" onclick="${clickAction}" style="cursor:pointer;">${name}</div>
                `;
                
                itemContainer.appendChild(div);
            });
        };

        // 탭 필터링
        const renderItemsByFilter = (filterCode) => {
            let filtered = (filterCode === 'etc') 
                ? subCats.filter(sub => !sub.top_category_code)
                : subCats.filter(sub => sub.top_category_code === filterCode);
            window._drawQuickItems(filtered, false);
        };

        // 초기 실행
        renderTabs();
        const firstTab = tabContainer.querySelectorAll('.cat-tab')[0];
        if (firstTab) firstTab.click();

        // 전역 노출
        window._renderCategoryItems = renderItemsByFilter;

    } catch (err) {
        console.error("카테고리 로딩 실패:", err);
        itemContainer.innerHTML = '<div style="grid-column:1/-1; text-align:center;">Loading Error.</div>';
    }
}

// ==========================================================
// [최종] 통합 검색 (카테고리 + 개별 상품 동시 검색)
// ==========================================================
window.filterMainIcons = function(keyword) {
    const term = keyword.toLowerCase().trim();

    // 1. 검색어 없으면 -> 원래 탭 화면으로 복구
    if (!term) {
        const activeTab = document.querySelector('.cat-tab.active');
        if (activeTab) activeTab.click();
        return;
    }

    // 2. 카테고리 검색 (이름 일치)
    const matchedCats = globalSubCats.filter(cat => {
        return (cat.name || '').toLowerCase().includes(term);
    });

    // 3. 상품 검색 (이름 일치) -> ★ 여기가 추가된 핵심 기능
    const matchedProds = globalProdImages.filter(prod => {
        return (prod.name || '').toLowerCase().includes(term);
    });

    // 4. 결과 합치기 (카테고리 먼저, 그 뒤에 상품)
    // 상품 데이터에는 isProduct: true 플래그를 달아주는 로직은 _drawQuickItems에서 처리됨
    const combinedResults = [...matchedCats, ...matchedProds];

    // 5. 화면에 그리기
    window._drawQuickItems(combinedResults);
};


    window.categoryCache = {}; 


window.showCategoryProducts = async function(catKey, catName, catDesc) {
    const grid = document.getElementById('catProductGrid');
    const modal = document.getElementById('categoryDetailModal');
    const titleEl = document.getElementById('catModalTitle');
    const descBox = document.getElementById('catModalDesc'); // 설명 박스

    // 제목 설정
    if(titleEl) titleEl.innerHTML = `<span style="color:#6366f1;">${catName}</span>`;
    
    // [신규] 소분류 설명 표시
    if (descBox) {
        if (catDesc && catDesc.trim() !== "" && catDesc !== "undefined") {
            descBox.style.display = "block";
            descBox.innerHTML = catDesc.replace(/\n/g, '<br>');
        } else {
            descBox.style.display = "none";
        }
    }
    
    grid.style.gridTemplateColumns = "repeat(4, 1fr)"; 
    grid.style.gap = "12px";
    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px;"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</div>';
    modal.style.display = 'flex';

    // 1. 캐시 확인
    let products = window.categoryCache[catKey];
    if (!products) {
        try {
            const { data, error } = await sb.from('admin_products')
                .select('*')
                .eq('category', catKey)
                .order('sort_order', { ascending: true });
            if (error) throw error;
            products = data;
            window.categoryCache[catKey] = data;
        } catch (e) {
            console.error("Error:", e);
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:red;">Error loading products.</div>';
            return;
        }
    }

    grid.innerHTML = '';
    if (!products || products.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:#999;">No products found.</div>';
        return;
    }

    products.forEach(p => {
        const thumbUrl = p.img_url ? window.getTinyThumb(p.img_url, 80) : '';

        // ★ [핵심] 여기서도 getLocalizedData 한 방으로 해결
        const { name, price, formattedPrice } = getLocalizedData(p);

        // 전역 DB 등록
        if (!window.PRODUCT_DB) window.PRODUCT_DB = {};
        const scaleFactor = 3.7795;
        const pxW = Math.round((p.width_mm || 210) * scaleFactor);
        const pxH = Math.round((p.height_mm || 297) * scaleFactor);

        // [수정] 언어별 설명 가져오기
        const isJP = window.location.hostname.includes('cafe0101.com') || window.location.href.includes('lang=ja');
        const isUS = window.location.hostname.includes('cafe3355.com') || window.location.href.includes('lang=en');
        
        let pDesc = p.description;
        if(isJP) pDesc = p.description_jp || p.description;
        else if(isUS) pDesc = p.description_us || p.description;

        window.PRODUCT_DB[p.code] = {
            name: name,
            price: price,
            w: pxW, h: pxH,
            w_mm: p.width_mm, h_mm: p.height_mm,
            img: p.img_url, 
            addons: p.addons ? p.addons.split(',') : [], 
            category: p.category,
            description: pDesc,
            is_custom_size: p.is_custom_size, // ★ [추가] 커스텀 여부 저장
            is_general_product: p.is_general_product // [신규] 일반 상품 여부 저장
        };

        const div = document.createElement('div');
        div.className = 'quick-item'; 
        
        let imgHtml = p.img_url 
            ? `<div class="quick-icon-img-box"><img src="${thumbUrl}" alt="${name}" loading="lazy" onerror="this.parentNode.innerHTML='<div class=\\'quick-icon\\'><i class=\\'fa-solid fa-cube\\'></i></div>';"></div>`
            : `<div class="quick-icon"><i class="fa-solid fa-cube"></i></div>`;

        div.innerHTML = `
            ${imgHtml}
            <div class="quick-text">${name}</div>
            <div style="font-size:11px; color:#888; margin-top:3px;">
                ${p.width_mm || '-'}x${p.height_mm || '-'} / ${formattedPrice}
            </div>
        `;

        div.onclick = () => {
            modal.style.display = 'none'; 
            window.currentProductKey = p.code;
            window.selectedProductForChoice = window.PRODUCT_DB[p.code];

            // [수정됨] 일반 상품이면 바로 장바구니로, 아니면 선택 모달 띄우기
            // [수정됨] 일반 상품이면 전용 모달(수량/설명) 띄우기
            if (p.is_general_product) {
                if (window.openGeneralProductModal) {
                    window.openGeneralProductModal(p.code);
                } else {
                    alert("일반 상품 모달 스크립트가 로드되지 않았습니다.");
                }
            } else {
                // 기존 디자인 상품 (모달 띄우기)
                if(window.showChoiceModal) window.showChoiceModal(p.code);
                else window.startEditorDirect(p.code);
            }
        };
        grid.appendChild(div);
    });
};
 
    // [1] 모달 열기 및 모드(일반/커스텀) 설정
    window.showChoiceModal = function(key) {
        window.currentProductKey = key;
        window.selectedProductForChoice = window.PRODUCT_DB[key];
        
        if (!window.selectedProductForChoice) return alert("상품 정보를 불러오는 중입니다.");
        
        const product = window.selectedProductForChoice;
        
        // 텍스트 및 설명 설정
        const nameEl = document.getElementById('choiceProdName');
        if(nameEl) nameEl.innerText = product.name;

        const descEl = document.getElementById('choiceProdDesc');
        if (descEl) {
            descEl.style.display = product.description ? "block" : "none";
            descEl.innerHTML = (product.description || '').replace(/\n/g, '<br>');
        }

        // ★ [중요] 커스텀(헤베 계산) 모드인지 여부를 전역 변수에 확실히 저장
        const isCustom = product.is_custom_size === true; 
        window.isCustomModeCurrent = isCustom; 

        if (isCustom) {
            // [계산기 모드]
            document.getElementById('choiceProductImg').style.display = 'none';
            const panel = document.getElementById('customSizePanel');
            if(panel) {
                panel.style.display = 'flex';
                // 입력창 초기화
                document.getElementById('inputCustW').value = '';
                document.getElementById('inputCustH').value = '';
                document.getElementById('inputCustQty').value = 1;
                document.getElementById('calcResultPrice').innerText = '0원';
                document.getElementById('calcResultSize').innerText = '-';
            }
        } else {
            // [일반 모드]
            document.getElementById('choiceProductImg').src = product.img || 'https://placehold.co/400?text=No+Image';
            document.getElementById('choiceProductImg').style.display = 'block';
            if(document.getElementById('customSizePanel')) {
                document.getElementById('customSizePanel').style.display = 'none';
            }
        }

        document.getElementById('choiceModal').style.display = 'flex';
    };

    // [2] 실시간 가격 계산 함수 (입력할 때마다 실행)
    window.calcCustomPrice = function() {
        const w = parseInt(document.getElementById('inputCustW').value || 0);
        const h = parseInt(document.getElementById('inputCustH').value || 0);
        const qty = parseInt(document.getElementById('inputCustQty').value || 1);
        
        // 제품의 1헤베(1m x 1m)당 단가
        const unitPrice = window.selectedProductForChoice.price; 

        if (w > 0 && h > 0) {
            // 헤베 계산식: (가로mm * 세로mm / 1,000,000) * 단가
            const area = (w * h) / 1000000;
            // 1개당 가격 (올림 처리)
            // [수정] 10원 단위 절사 (내림 처리): 242,001원 -> 242,000원
            const pricePerItem = Math.floor((area * unitPrice) / 100) * 100;
            // 총 합계 (수량 포함)
            const totalPrice = pricePerItem * qty;
            
            document.getElementById('calcResultPrice').innerText = totalPrice.toLocaleString() + '원';
            document.getElementById('calcResultSize').innerText = `${w}mm x ${h}mm (${area.toFixed(2)}㎡)`;
        } else {
            document.getElementById('calcResultPrice').innerText = '0원';
            document.getElementById('calcResultSize').innerText = '-';
        }
    };

    // [3] 선택 완료 및 장바구니 담기 (핵심 수정)
    // [3] 선택 완료 및 장바구니 담기 (헤베 가격 적용 수정판)
    window.confirmChoice = function(mode) {
        if (window.isDirectCartAddInProgress) return;
        if (!window.selectedProductForChoice) return alert("상품 정보가 없습니다.");

        // 변수 초기화
        let finalW = 0, finalH = 0;
        let finalPricePerItem = window.selectedProductForChoice.price; // 기본값 (1헤베 단가)
        let finalQty = 1;

        // ★ [핵심] 커스텀 모드일 경우 여기서 가격을 '재계산'해서 확정함
        if (window.isCustomModeCurrent) {
            finalW = parseInt(document.getElementById('inputCustW').value || 0);
            finalH = parseInt(document.getElementById('inputCustH').value || 0);
            finalQty = parseInt(document.getElementById('inputCustQty').value || 1);
            
            if (finalW < 100 || finalH < 100) return alert("최소 사이즈는 100mm 이상이어야 합니다.");
            
            // 1헤베 단가 가져오기
            const unitPrice = window.selectedProductForChoice.price;
            
            // 1개당 가격 계산: (가로mm * 세로mm / 1,000,000) * 단가
            // Math.ceil로 소수점 올림 처리 (1원 단위 보존)
            // [수정] 10원 단위 절사 (내림 처리): 242,001원 -> 242,000원
            finalPricePerItem = Math.floor((((finalW * finalH) / 1000000) * unitPrice) / 100) * 100;
            
            console.log(`[헤베계산적용] ${finalW}x${finalH} = ${finalPricePerItem}원 (단가:${unitPrice})`);
        }

        if (mode === 'editor') {
            document.getElementById('choiceModal').style.display = 'none';
            // 에디터 실행 (4번째 인자로 '확정된 가격' 전달)
            window.startEditorDirect(
                window.currentProductKey, 
                window.isCustomModeCurrent ? finalW : null, 
                window.isCustomModeCurrent ? finalH : null,
                window.isCustomModeCurrent ? finalPricePerItem : null // ★ 추가됨
            );
        } else if (mode === 'cart') {
            window.isDirectCartAddInProgress = true;
            setTimeout(() => { window.isDirectCartAddInProgress = false; }, 3000);
            document.getElementById('choiceModal').style.display = 'none';

            import('./order.js?v=119').then(m => {
                // 원본 객체 복사 (중요: 원본을 수정하면 안됨)
                const productToCart = { ...window.selectedProductForChoice };
                
                // ★ [수정 포인트] 커스텀 모드면 '계산된 가격'으로 덮어쓰기
                if (window.isCustomModeCurrent) {
                    productToCart.price = finalPricePerItem; // 여기서 1헤베 가격 -> 계산된 가격으로 변경됨
                    productToCart.name += ` (${finalW}x${finalH}mm)`; // 이름 뒤에 사이즈 명시
                    productToCart.width_mm = finalW;
                    productToCart.height_mm = finalH;
                    productToCart.is_custom = true; // 커스텀 상품임을 표시
                }
                
                // 장바구니 추가 함수 호출 (최종 확정된 가격의 객체 전달)
                m.addProductToCartDirectly(productToCart, finalQty); 
                document.getElementById('cartAddedModal').style.display = 'flex'; 
            });
        }
    };

    // [신규] 완료 모달 : 결제하러 가기 버튼
    window.goToCartFromSuccess = function() {
        document.getElementById('cartAddedModal').style.display = 'none'; // 완료 모달 닫기
        document.getElementById('cartPage').style.display = 'block';      // 장바구니 열기
        if(window.renderCart) window.renderCart(); // 장바구니 갱신 (안전장치)
    };

    // [신규] 완료 모달 : 다른 제품 구매하기 버튼 (시작화면으로)
    window.continueShopping = function() {
        document.getElementById('cartAddedModal').style.display = 'none'; // 완료 모달 닫기
        document.getElementById('categoryDetailModal').style.display = 'none'; // 카테고리창도 닫기(필요시)
        // 시작 화면은 이미 배경에 깔려 있으므로 모달만 닫으면 됩니다.
        // 만약 새로고침이 필요하다면 location.reload()를 사용하세요.
    };

    // [추가] 장바구니 일괄 업로드 핸들러
    window.handleBulkCartUpload = function(input) {
        if (input.files.length === 0) return;
        import('./order.js?v=119').then(m => {
            m.processBulkCartUpload(input.files);
            input.value = ''; // 초기화
        });
    };

    const directUploadInput = document.getElementById("directUploadInput");
    if (directUploadInput) {
        directUploadInput.onchange = async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const product = window.selectedProductForChoice;
            if (!product) return alert("상품 정보가 없습니다.");

            const loading = document.getElementById("loading");
            if (loading) loading.style.display = "flex";

            try {
                let thumbUrl = 'https://placehold.co/100?text=FILE';
                let fileDataURI = null;

                if (file.type === 'application/pdf') {
                    if (window.pdfjsLib && !window.pdfjsLib.GlobalWorkerOptions.workerSrc) {
                        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    }
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        const page = await pdf.getPage(1);
                        const viewport = page.getViewport({ scale: 1 });
                        const scale = 150 / viewport.width;
                        const scaledViewport = page.getViewport({ scale });
                        const cvs = document.createElement('canvas');
                        const ctx = cvs.getContext('2d');
                        cvs.height = scaledViewport.height;
                        cvs.width = scaledViewport.width;
                        await page.render({ canvasContext: ctx, viewport: scaledViewport }).promise;
                        thumbUrl = cvs.toDataURL('image/jpeg', 0.8);
                    } catch (err) { console.warn("PDF Thumb Error:", err); }
                } else if (file.type.startsWith('image/')) {
                    fileDataURI = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = (evt) => resolve(evt.target.result);
                        reader.readAsDataURL(file);
                    });
                    thumbUrl = fileDataURI;
                }

                if (!fileDataURI) {
                     fileDataURI = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = (evt) => resolve(evt.target.result);
                        reader.readAsDataURL(file);
                    });
                }

                const newItem = {
                    uid: Date.now(),
                    product: product,
                    type: 'file',
                    fileName: file.name,
                    mimeType: file.type,
                    fileData: fileDataURI,
                    thumb: thumbUrl,
                    qty: 1,
                    selectedAddons: {},
                    isOpen: true
                };

                if (typeof cartData !== 'undefined') {
                    cartData.push(newItem);
                    try {
                        const user = typeof currentUser !== 'undefined' ? currentUser : null;
                        const storageKey = user ? `chameleon_cart_${user.id}` : 'chameleon_cart_guest';
                        localStorage.setItem(storageKey, JSON.stringify(cartData));
                    } catch(err) {}
                }

                if (window.renderCart) window.renderCart();
                document.getElementById('choiceModal').style.display = 'none';
                document.getElementById('cartPage').style.display = 'block';
                
            } catch (err) {
                console.error(err);
                alert("파일 처리 중 오류가 발생했습니다.");
            } finally {
                if (loading) loading.style.display = "none";
                directUploadInput.value = ''; 
            }
        };
    }

    // ============================================================
    // [5] 에디터 시작 및 템플릿 로드
    // ============================================================
    // ============================================================
    // [5] 에디터 시작 및 템플릿 로드 (수정됨: 로그인 체크 + 템플릿 팝업)
    // ============================================================
    // [폰트 동적 로딩 함수 추가]
    function loadEditorFonts() {
        if (window.isFontsLoaded) return; // 이미 로드했으면 중복 실행 방지
        console.log("🎨 에디터용 서체 로딩 시작...");
        
        const fonts = [
            "https://cdn.jsdelivr.net/gh/orioncactus/GmarketSans/build/GmarketSans.css",
            "https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&family=Nanum+Myeongjo:wght@400;700;800&family=Do+Hyeon&family=Jua&display=swap"
        ];

        fonts.forEach(url => {
            const link = document.createElement('link');
            link.href = url;
            link.rel = 'stylesheet';
            document.head.appendChild(link);
        });
        window.isFontsLoaded = true;
    }

    // [수정] customW, customH, customPrice 파라미터 추가
    // [수정됨] 템플릿 팝업 제거 + 화면 먼저 보여주고 폰트 로딩 (속도 개선)
    window.startEditorDirect = async function(key, customW = null, customH = null, customPrice = null) {
        
        // 1. [검증] 로그인 및 필수값 체크
        const { data } = await sb.auth.getSession();
        if (!data || !data.session || !data.session.user) {
            alert(window.t('msg_login_required_design'));
            document.getElementById('loginModal').style.display = 'flex';
            return; 
        }

        if (!key) return alert("상품 코드가 올바르지 않습니다.");

        // 2. [설정] 전역 변수 및 상품 정보 설정
        window.currentProductKey = key;
        if(canvas) canvas.currentProductKey = key;
        
        if (!window.PRODUCT_DB) window.PRODUCT_DB = {};
        const product = window.PRODUCT_DB[key];

        // 커스텀 가격/사이즈 적용
        if (customPrice !== null) {
            product.price = customPrice;
            product.is_custom_size = true; 
            product.w_mm = customW; 
            product.h_mm = customH;
            console.log(`[에디터 진입] 가격 조정됨: ${customPrice.toLocaleString()}원`);
        }

        // 사이즈 계산
        const displayW = customW || (product ? (product.w_mm || product.w || 210) : 210);
        const displayH = customH || (product ? (product.h_mm || product.h || 297) : 297);
        const maxSide = Math.max(displayW, displayH);

        if (product && maxSide >= 800) {
            alert(window.t('msg_large_product_warning'));
        }
        
        // 픽셀 변환 및 캔버스 설정
        const canvasW = Math.round(displayW * 3.7795);
        const canvasH = Math.round(displayH * 3.7795);
        const mode = (typeof key === 'string' && key.includes('Wall')) ? 'wall' : 'standard';

        if (typeof setMaxLimits === 'function') setMaxLimits(displayW, displayH);
        
        const limitLabel = document.getElementById("limitLabel");
        if(limitLabel) limitLabel.innerText = `Max: ${displayW}x${displayH}`;
        
        const inpW = document.getElementById("inputUserW");
        const inpH = document.getElementById("inputUserH");
        if(inpW) inpW.value = displayW;
        if(inpH) inpH.value = displayH;

        // 3. [핵심] 화면 전환을 먼저 실행
        document.getElementById("startScreen").style.display = "none";
        // ★ [수정] Grid가 아닌 Flex로 강제 지정 (CSS 오버라이딩 확실하게)
        document.getElementById("mainEditor").style.display = "flex"; 
        
        const tplTabs = document.querySelector('.template-tabs');
        if(tplTabs) tplTabs.style.display = 'flex';
        document.body.classList.add('editor-active'); 

        // ★ [추가] 사이드바 템플릿 추천 패널 로드
        if (typeof window.loadSideBarTemplates === 'function') {
            // 'custom'이 아니거나, 특정 상품일 때 사이드바를 엽니다.
            console.log(`📂 사이드바 템플릿 로드 시도: ${key}`);
            window.loadSideBarTemplates(key);
        }
        
        if (window.ChannelIO) ChannelIO('hide');
        window.dispatchEvent(new Event('resize'));

        // 캔버스 크기 적용 (화면이 보여야 캔버스도 제대로 그려짐)
        if (window.applySize) window.applySize(canvasW, canvasH, key, mode, 'replace');

        // 4. [지연 로딩] 폰트와 스크립트를 화면 전환 후에 로드
        console.log("🚀 화면 진입 완료. 서체 및 스크립트 로딩 시작...");
        
        loadEditorFonts(); // CSS 폰트

        // 필수 스크립트 로드 (await를 쓰되, 이미 화면은 떴음)
        if (!window.isObjectsLoaded) {
            try {
                await import('./canvas-objects.js?v=119');
                window.isObjectsLoaded = true;
            } catch (e) {
                console.error("스크립트 로딩 실패:", e);
            }
        }

        // ★ [핵심] 폰트 로딩을 비동기로 처리 (await 제거)하여 멈춤 현상 제거
        if (window.initCanvasFonts) {
            window.initCanvasFonts().then(() => {
                console.log("✅ 서체 로딩 완료");
            }); 
        }

        // 6. 템플릿 처리 (기존 선택된 템플릿만 적용)
        if (window.pendingTemplate) {
            setTimeout(async () => {
                if (window.applyStartTemplate) await window.applyStartTemplate(window.pendingTemplate);
                window.pendingTemplate = null;
            }, 500);
        } else {
            // [수정됨] 템플릿 검색 팝업(Overlay) 띄우는 코드를 주석 처리하여 실행되지 않게 함
            /* if (!hasFixedGuide) {
                setTimeout(() => {
                    const tplOverlay = document.getElementById('templateOverlay');
                    if (tplOverlay) {
                        tplOverlay.style.display = 'flex';
                        if (window.filterTpl) window.filterTpl('photo-bg'); 
                    }
                }, 300);
            } 
            */
        }

        // AI 이미지 시작일 경우 처리
        if (window.pendingAiImage) {
            const loading = document.getElementById("loading");
            if(loading) loading.style.display = 'flex';

            fabric.Image.fromURL(window.pendingAiImage, (img) => {
                if (!img) return;
                const board = canvas.getObjects().find(o => o.isBoard);
                const cW = board ? board.width * board.scaleX : canvas.width;
                const cH = board ? board.height * board.scaleY : canvas.height;
                const cX = board ? board.left + cW / 2 : canvas.width / 2;
                const cY = board ? board.top + cH / 2 : canvas.height / 2;
                const scale = Math.min((cW * 0.8) / img.width, (cH * 0.8) / img.height);
                
                img.set({
                    scaleX: scale, scaleY: scale, left: cX, top: cY,
                    originX: 'center', originY: 'center'
                });
                canvas.add(img);
                canvas.setActiveObject(img);
                canvas.requestRenderAll();
                window.pendingAiImage = null;
                if(loading) loading.style.display = 'none';
            }, { crossOrigin: 'anonymous' });
        }
    };

    window.onTemplateClick = async function(tpl) {
        const startScreen = document.getElementById('startScreen');
        const isEditorOpen = startScreen && window.getComputedStyle(startScreen).display === 'none';

       if (isEditorOpen) {
            if(!confirm(window.t('msg_template_apply_confirm'))) return;
            await applyTemplateDirectly(tpl);
        } else {
            window.pendingTemplate = tpl; 
            showCategorySelectionModal(); 
        }
    };

    function finishLoading() {
        document.getElementById("loading").style.display = "none";
        document.getElementById('templateOverlay').style.display = 'none';
    }


    // ============================================================
    // [1] 초기화 및 데이터 로드 (안정화 최종 버전)
    // ============================================================
    window.addEventListener('load', async () => {
        // 1. 설정 로딩 대기 (config.js의 작업이 끝날 때까지 기다림)
        if (window.initConfig) await window.initConfig(); 
        else if (typeof initConfig === 'function') await initConfig();

        // 2. 카테고리 메뉴 렌더링
        if (typeof renderQuickMenu === 'function') renderQuickMenu();
        
        // 3. 템플릿 및 상품 로드
        if(window.searchTemplates) window.searchTemplates('');
        if (window.preloadLanguageFont) window.preloadLanguageFont();
        if (typeof loadSpecialProducts === 'function') {
            loadSpecialProducts('hotDealSection', 'hotDealGrid', 'hotdeal', 6);
            loadSpecialProducts('bizDealSection', 'bizDealGrid', '23432424', 6);
        }

        // 4. 로그인 버튼 상태 업데이트 (config.js 완료 후 실행되므로 안전함)
        const btnLogin = document.getElementById('btnLoginBtn');
        const btnConsole = document.getElementById('btnPartnerConsole');
        
        // config.js에서 설정된 currentUser 변수 사용
        if (window.currentUser) {
            console.log("✅ 로그인 됨:", window.currentUser.email);
            if (btnLogin) {
                // [수정] "로그아웃" -> window.t('btn_logout')
                btnLogin.innerText = window.t('btn_logout');
                btnLogin.style.fontWeight = "bold"; 
                btnLogin.style.color = "#ef4444"; 
                btnLogin.onclick = async function() {
                    // [수정] "로그아웃 하시겠습니까?" -> window.t('msg_logout_confirm')
                    if (confirm(window.t('msg_logout_confirm'))) {
                        await sb.auth.signOut();
                        localStorage.removeItem('sb-qinvtnhiidtmrzosyvys-auth-token'); 
                        window.location.reload(); 
                    }
                };
            }
            if(btnConsole) btnConsole.style.removeProperty('display');
        } else {
            if (btnLogin) {
                // [수정] "로그인" -> window.t('btn_login')
                btnLogin.innerText = window.t('btn_login');
                btnLogin.onclick = () => document.getElementById('loginModal').style.display = 'flex';
            }
            if(btnConsole) btnConsole.style.setProperty('display', 'none', 'important');
        }

        // 5. 검색창 연결
        const searchBtn = document.getElementById('btnStartSearch');
        const searchInput = document.getElementById('startSearchInput');
        if (searchBtn && searchInput) {
            const doSearch = () => { if(window.searchTemplates) window.searchTemplates(searchInput.value); };
            searchBtn.onclick = doSearch;
            searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') doSearch(); });
        }
    });


// ==========================================
    // [1] 템플릿 페이징 시스템 (28개씩 보기) - 수정됨
    // ==========================================

    const ITEMS_PER_PAGE = 10; // 한 페이지당 28개
    let currentTemplatePage = 0;
    let lastSearchKeyword = '';

    // 1. 검색 시작 (초기화)
    window.searchTemplates = function(keyword = '') {
        lastSearchKeyword = keyword;
        currentTemplatePage = 0; // 1페이지로 리셋
        loadTemplatePage(0);
    };

    // 2. 페이지 변경 버튼 클릭 시 실행 (HTML의 onclick과 연결됨)
    window.changeTemplatePage = function(delta) {
        const newPage = currentTemplatePage + delta;
        if (newPage < 0) return; // 0페이지 미만 방지
        loadTemplatePage(newPage);
    };

    // 3. 데이터 로드 및 그리기 (핵심 함수)
    async function loadTemplatePage(page) {
        const grid = document.getElementById('startTemplateGrid');
        if (!grid) return;

        // 로딩 표시
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:60px; color:#888;"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><br><br>로딩 중...</div>';
        
        try {
            // DB 쿼리 준비
            let query = sb.from('library')
                .select('id, thumb_url, category, tags', { count: 'exact' }) // 전체 개수도 같이 가져옴
                .order('created_at', { ascending: false })
                // ★ [수정] 오직 유저 템플릿(벡터/이미지)만 필터링 (로고 제외)
                .in('category', ['user_vector', 'user_image']) 
                .range(page * ITEMS_PER_PAGE, (page + 1) * ITEMS_PER_PAGE - 1); // 범위 설정

            // 검색어 필터 (태그 검색)
            if (lastSearchKeyword && lastSearchKeyword.trim() !== '') {
                query = query.ilike('tags', `%${lastSearchKeyword}%`);
            }

            const { data, error, count } = await query;

            if (error) throw error;

            grid.innerHTML = ''; // 기존 내용 지우기

            // 데이터가 없을 때
            if (!data || data.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:60px; color:#999;">검색 결과가 없습니다.</div>';
                updatePaginationButtons(page, 0);
                return;
            }

            // [수정] 카드 생성 (정사각형 프레임 + 모든 뱃지 표시)
            data.forEach(tpl => {
                const card = document.createElement('div');
                card.className = 'tpl-card-start'; 
                
                // 1. 카테고리별 뱃지 설정 (모든 종류 추가)
                let badgeText = '';
                let badgeColor = '#64748b'; // 기본 회색

                switch (tpl.category) {
                    case 'user_vector': badgeText = 'User Vector'; badgeColor = '#7c3aed'; break; // 보라색
                    case 'user_image':  badgeText = 'User Image'; badgeColor = '#059669'; break;  // 초록색
                    case 'vector':      badgeText = 'Vector'; badgeColor = '#7c3aed'; break;
                    case 'photo-bg':    badgeText = 'Image'; badgeColor = '#059669'; break;
                    case 'graphic':     badgeText = 'Graphic'; badgeColor = '#2563eb'; break; // 파란색
                    case 'pattern':
                    case 'transparent-graphic': badgeText = 'Pattern'; badgeColor = '#db2777'; break; // 핑크색
                    case 'logo':        badgeText = 'Logo'; badgeColor = '#d97706'; break; // 주황색
                    case 'text':        badgeText = 'Text'; badgeColor = '#475569'; break;
                }

                // 뱃지 HTML 생성
                let badgeHtml = '';
                if (badgeText) {
                    badgeHtml = `<span style="position:absolute; top:10px; left:10px; background:${badgeColor}; color:white; font-size:10px; font-weight:800; padding:4px 8px; border-radius:6px; z-index:5; box-shadow:0 2px 4px rgba(0,0,0,0.2); text-transform:uppercase; letter-spacing:0.5px;">${badgeText}</span>`;
                }

                // 2. 이미지 최적화 (정사각형 1:1 비율 요청)
                let imgSrc = tpl.thumb_url || 'https://via.placeholder.com/300';
                if (imgSrc.includes('supabase.co')) {
                    const separator = imgSrc.includes('?') ? '&' : '?';
                    // width와 height를 똑같이 설정하고 resize=cover 옵션을 주어 정사각형으로 자름
                    imgSrc += `${separator}width=400&height=400&resize=cover&format=webp&quality=70`;
                }

                // 3. HTML 구성 및 스타일 강제 적용
                // aspect-ratio: 1/1 을 주어 강제로 정사각형으로 만듭니다.
                card.style.cssText = "aspect-ratio: 1/1; position: relative; overflow: hidden; border-radius: 16px; border: 1px solid #e5e7eb; background: #f8fafc;";
                
                card.innerHTML = `
                    ${badgeHtml}
                    <img src="${imgSrc}" class="tpl-card-img" loading="lazy" style="width:100%; height:100%; object-fit:cover; display:block;">
                    <div class="tpl-card-overlay"></div>
                `;
                
                card.onclick = () => { 
                    if(window.onTemplateClick) window.onTemplateClick(tpl); 
                };
                
                grid.appendChild(card);
            });

            // 현재 페이지 번호 업데이트 및 버튼 상태 관리
            currentTemplatePage = page;
            updatePaginationButtons(page, data.length);

        } catch (e) {
            console.error("템플릿 로드 오류:", e);
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px;">오류가 발생했습니다.</div>';
        }
    }

    // 4. 버튼 활성화/비활성화 및 페이지 번호 표시
    function updatePaginationButtons(page, currentItemsCount) {
        const btnPrev = document.getElementById('btnTplPrev');
        const btnNext = document.getElementById('btnTplNext');
        const lblPage = document.getElementById('tplPageLabel');

        if(lblPage) lblPage.innerText = `${page + 1} 페이지`;

        // 첫 페이지면 '이전' 버튼 비활성화
        if(btnPrev) {
            btnPrev.disabled = (page === 0);
            btnPrev.style.opacity = (page === 0) ? '0.5' : '1';
            btnPrev.style.cursor = (page === 0) ? 'default' : 'pointer';
        }

        // 가져온 데이터가 설정 개수(28개)보다 적으면 '다음' 버튼 비활성화 (마지막 페이지)
        if(btnNext) {
            const isLastPage = currentItemsCount < ITEMS_PER_PAGE;
            btnNext.disabled = isLastPage;
            btnNext.style.opacity = isLastPage ? '0.5' : '1';
            btnNext.style.cursor = isLastPage ? 'default' : 'pointer';
        }
    }

    // PDF 폰트 설정 (폰트 깨짐 방지)
    window.pdfFontCache = null;
    window.pdfFontName = 'NanumGothic'; // 기본

    window.preloadLanguageFont = async function() { 
        try { 
            let fontUrl = '';
            if (CURRENT_LANG === 'jp') {
                fontUrl = 'https://cdn.jsdelivr.net/gh/google/fonts@main/ofl/nanumgothic/NanumGothic-Regular.ttf'; 
            } else {
                fontUrl = 'https://cdn.jsdelivr.net/gh/google/fonts@main/ofl/nanumgothic/NanumGothic-Regular.ttf';
            }

            const r = await fetch(fontUrl); 
            if(r.ok) { 
                const b = await r.blob(); 
                const rd = new FileReader(); 
                rd.onloadend = function() { 
                    window.pdfFontCache = rd.result.split(',')[1]; 
                }; 
                rd.readAsDataURL(b); 
            } 
        } catch(e) { console.error("Font Load Error:", e); } 
    };

    window.loadKoreanFontForPDF = async function(doc) { 
        if(window.pdfFontCache) { 
            try { 
                const fileName = window.pdfFontName + '.ttf';
                doc.addFileToVFS(fileName, window.pdfFontCache); 
                doc.addFont(fileName, window.pdfFontName, 'normal'); 
                doc.setFont(window.pdfFontName); 
            } catch(e) { console.warn(e); } 
        } 
    };

    // 기타 유틸
    window.toggleLockSelection = function() { if(!canvas)return; const a=canvas.getActiveObject(); if(!a)return alert("선택필요"); const l=!a.lockMovementX; a.set({lockMovementX:l,lockMovementY:l,lockRotation:l,lockScalingX:l,lockScalingY:l,hasControls:!l,selectable:true}); canvas.discardActiveObject(); canvas.requestRenderAll(); };
    window.setAsBackground = function() { 
    if(!canvas) return; 
    
    const a = canvas.getActiveObject(); 
    if(!a) return alert("배경으로 만들 이미지를 선택해주세요."); 
    
    const b = canvas.getObjects().find(o => o.isBoard); 
    if(!b) return; 

    // 1.1배(10%) 더 크게 키우기 계산
    const scaleX = (b.width * b.scaleX) / a.width;
    const scaleY = (b.height * b.scaleY) / a.height;
    const s = Math.max(scaleX, scaleY) * 1.15; 

    // 속성 변경
    a.set({
        scaleX: s,
        scaleY: s,
        left: b.left + (b.width * b.scaleX) / 2,
        top: b.top + (b.height * b.scaleY) / 2,
        originX: 'center',
        originY: 'center',
        angle: 0
    }); 
    
    // ★ [핵심 수정] 좌표 강제 업데이트 (이게 없으면 오류가 납니다!)
    a.setCoords(); 
    
    canvas.sendToBack(a); 
    canvas.sendToBack(b); // 대지는 항상 맨 뒤로
    canvas.requestRenderAll(); 
};
    window.alignObject = function(d) { if(!canvas)return; const a=canvas.getActiveObject(); if(!a)return; const b=canvas.getObjects().find(o=>o.isBoard); const r=b?b.getBoundingRect():{left:0,top:0,width:canvas.width,height:canvas.height}; const w=a.getScaledWidth(); const h=a.getScaledHeight(); if(d=='left') a.left=r.left+w/2; if(d=='centerH') a.left=r.left+r.width/2; if(d=='right') a.left=r.left+r.width-w/2; if(d=='top') a.top=r.top+h/2; if(d=='centerV') a.top=r.top+r.height/2; if(d=='bottom') a.top=r.top+r.height-h/2; if(d=='center') { a.left=r.left+r.width/2; a.top=r.top+r.height/2; } a.setCoords(); canvas.requestRenderAll(); };

    if (window.pdfjsLib) window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // =========================================================
    // [신규] 일반 상품 모달 로직 (오류 해결용)
    // =========================================================
    window.currentGenProduct = null;

    // 1. 모달 열기
    window.openGeneralProductModal = function(code) {
        // 상품 정보 가져오기 (이미 전역변수에 로드됨)
        const product = window.PRODUCT_DB[code];
        if (!product) return alert("상품 정보를 찾을 수 없습니다.");

        window.currentGenProduct = product;

        // UI 설정
        document.getElementById('genProdImg').src = product.img || 'https://placehold.co/400?text=No+Image';
        document.getElementById('genProdTitle').innerText = product.name;
        document.getElementById('genProdDesc').innerText = product.description || '';
        document.getElementById('genProdPrice').innerText = (product.price || 0).toLocaleString() + '원';
        
        // 수량 및 합계 초기화
        document.getElementById('genProdQty').value = 1;
        window.updateGeneralTotal();

        // 모달 표시
        document.getElementById('categoryDetailModal').style.display = 'none'; // 기존 창 닫기
        document.getElementById('generalProductModal').style.display = 'flex';
    };

    // 2. 합계 금액 실시간 계산
    window.updateGeneralTotal = function() {
        const qty = parseInt(document.getElementById('genProdQty').value) || 1;
        const price = window.currentGenProduct ? (window.currentGenProduct.price || 0) : 0;
        const total = price * qty;
        document.getElementById('genProdTotal').innerText = total.toLocaleString() + '원';
    };

    // 3. 장바구니 담기 실행
    window.addGeneralToCart = function() {
        if (!window.currentGenProduct) return;
        const qty = parseInt(document.getElementById('genProdQty').value) || 1;

        // 중복 방지 (이미 진행중이면 차단)
        if (window.isDirectCartAddInProgress) return;
        
        // 로딩 표시
        window.isDirectCartAddInProgress = true;
        
        // order.js의 함수 호출 (수량 포함)
        addProductToCartDirectly(window.currentGenProduct, qty);

        // 모달 닫기 및 완료 모달 열기 (order.js에서 처리되지만 안전장치)
        document.getElementById('generalProductModal').style.display = 'none';
        setTimeout(() => { window.isDirectCartAddInProgress = false; }, 1000);
    };
</script>
</script>
<script>
    document.addEventListener('click', function(e) {
        const card = e.target.closest('.size-card');
        if (card) {
            const onclickCode = card.getAttribute('onclick');
            if (onclickCode) {
                try { eval(onclickCode); } catch(err) { console.error("판형 클릭 오류:", err); }
            }
        }
    });
    
    window.closeSuccessModal = function() {
        const modal = document.getElementById('successModal');
        if (modal) {
            modal.style.display = 'none';
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const confirmBtn = document.querySelector('#successModal .btn-round.primary');
        if(confirmBtn) {
            confirmBtn.onclick = window.closeSuccessModal;
        }
    });
    
    // 입력창 오류 해결
    window.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            if (e.code === 'Space' || e.key === ' ') {
                e.stopPropagation(); 
            }
        }
    }, true);
</script>
<script src="https://js.tosspayments.com/v1"></script>
<script src="https://js.stripe.com/v3/"></script>
<button id="btnPayTest" style="display:none; position:fixed; bottom:20px; right:20px; z-index:999999;">결제테스트</button>


<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-11349651713"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-11349651713');
</script>
<!-- Event snippet for Google Shopping App Add To Cart conversion page -->
<script>
  gtag('event', 'conversion', {
      'send_to': 'AW-11349651713/P7AtCKeNgfYaEIHi96Mq',
      'value': 1.0,
      'currency': 'KRW'
  });

  // [선택된 디자인 배경 만들기 - 10% 확대 + 오류 수정 버전]

</script>

<div id="reviewWriteModal" class="modal-bg" style="z-index: 17000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 400px; text-align: center;">
        <h3 style="margin-top: 0;">🎁 상품은 마음에 드셨나요?</h3>
        <p style="color: #666; font-size: 14px; margin-bottom: 20px;">구매를 확정하고 소중한 후기를 남겨주세요.<br>(가맹점에게 큰 힘이 됩니다!)</p>

        <div style="margin-bottom: 20px;">
            <div id="starContainer" style="font-size: 32px; color: #ddd; cursor: pointer;">
                <i class="fa-solid fa-star" onclick="setReviewRating(1)" id="star1"></i>
                <i class="fa-solid fa-star" onclick="setReviewRating(2)" id="star2"></i>
                <i class="fa-solid fa-star" onclick="setReviewRating(3)" id="star3"></i>
                <i class="fa-solid fa-star" onclick="setReviewRating(4)" id="star4"></i>
                <i class="fa-solid fa-star" onclick="setReviewRating(5)" id="star5"></i>
            </div>
            <div id="ratingText" style="font-weight: bold; color: #6366f1; margin-top: 5px;">5점</div>
        </div>

        <textarea id="reviewCommentInput" class="ai-input-pretty" placeholder="후기를 간단히 남겨주세요 (선택사항)" style="height: 80px;"></textarea>
        
        <input type="hidden" id="targetReviewOrderId">
        <input type="hidden" id="targetReviewScore" value="5">

        <button onclick="submitOrderReview()" class="btn-round primary" style="width: 100%; margin-top: 10px;">
            확인 및 정산지급 승인
        </button>
        <button onclick="document.getElementById('reviewWriteModal').style.display='none'" class="btn-round" style="margin-top: 5px; border: none; color: #888;">
            나중에 하기
        </button>
    </div>
</div>
<div id="withdrawModal" class="modal-bg" style="z-index: 25000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 500px; text-align: left;">
        <h3 style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 15px;">💸 정산 출금 신청</h3>
        
        <div style="background: #f0f9ff; border: 1px solid #bae6fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #0369a1; line-height: 1.6;">
            <strong>[세금계산서 발행 정보]</strong><br>
            아래 정보로 세금계산서를 발행하여 첨부해주세요.<br><br>
            상호 : <strong>(주)카멜레온프린팅</strong> (대표: 조재호)<br>
            사업자등록번호 : <strong>470-81-02808</strong><br>
            주소 : 경기도 화성시 우정읍 한말길 72-2<br>
            이메일 : korea900as@gmail.com
        </div>

        <div style="margin-bottom: 15px;">
            <label style="font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px;">출금 요청 금액 (수수료 공제 후)</label>
            <input id="wdAmount" class="ai-input-pretty" readonly style="background: #f8fafc; font-weight: 800; color: #6366f1; font-size: 18px;">
            <div style="font-size: 11px; color: #64748b; margin-top: 5px; line-height: 1.4;">
                * 공제 내역 (총 20%): 부가세(10%) + 카드수수료(3.5%) + 가맹수수료(6.5%)<br>
                * 실제 입금은 신청일로부터 <strong>영업일 기준 5일 이내</strong> 처리됩니다.
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <div style="flex: 1;">
                <label style="font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px;">예금주 (실명)</label>
                <input id="wdRealName" class="ai-input-pretty" placeholder="홍길동" style="margin-bottom: 0;">
            </div>
            <div style="flex: 1;">
                <label style="font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px;">연락처</label>
                <input id="wdPhone" class="ai-input-pretty" placeholder="010-0000-0000" style="margin-bottom: 0;">
            </div>
        </div>

        <div style="margin-bottom: 15px;">
            <label style="font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px;">주민등록번호 (원천징수용)</label>
            <input id="wdRRN" class="ai-input-pretty" type="password" placeholder="000000-0000000" maxlength="14">
        </div>
        <div style="margin-bottom: 15px;">
            <label style="font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px;">입금받을 계좌 정보</label>
            <input id="wdBankInfo" class="ai-input-pretty" placeholder="은행명 / 계좌번호 (본인 명의)">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px;">세금계산서 첨부 (필수)</label>
            <div style="display: flex; gap: 10px;">
                <input type="file" id="wdTaxFile" class="ai-input-pretty" accept=".pdf,.jpg,.png" style="padding: 8px;">
            </div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button onclick="submitWithdrawal()" class="btn-round primary" style="flex: 1;">신청하기</button>
            <button onclick="document.getElementById('withdrawModal').style.display='none'" class="btn-round" style="flex: 1;">취소</button>
        </div>
    </div>
</div>

<audio id="orderAlertSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

<div id="contributorUploadModal" class="modal-bg" style="display: none; z-index: 20000; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 500px; max-width: 95%;">
        <h3 id="cUploadTitle" style="margin-top:0;">📤 업로드</h3>
        
        <div style="margin-bottom: 15px;">
            <label class="form-label" style="font-weight:bold; display:block; margin-bottom:5px;">검색 키워드 (태그)</label>
            <input type="text" id="cUploadTags" class="ai-input-pretty" placeholder="파일을 선택하면 자동 입력됩니다.">
        </div>

        <div id="cUploadSvgArea" style="display:none; gap:10px; margin-bottom:15px;">
            <div style="flex:1;">
                <label class="form-label" style="font-size:12px; font-weight:bold;">1. 썸네일 (JPG/PNG)</label>
                <input type="file" id="cFileThumb" class="ai-input-pretty" accept="image/png, image/jpeg" style="padding:5px;" onchange="window.autoFillTags(this)">
            </div>
            <div style="flex:1;">
                <label class="form-label" style="font-size:12px; font-weight:bold;">2. SVG 원본</label>
                <input type="file" id="cFileSvg" class="ai-input-pretty" accept=".svg" style="padding:5px;">
            </div>
        </div>

        <div id="cUploadSimpleArea" style="margin-bottom:15px;">
            <label class="form-label" style="font-weight:bold; display:block; margin-bottom:5px;">파일 선택</label>
            <input type="file" id="cFileSimple" class="ai-input-pretty" accept="image/png, image/jpeg" multiple style="padding:5px;" onchange="window.autoFillTags(this)">
            <p style="font-size:11px; color:#666; margin-top:5px;">* 배경이 투명한 PNG 파일을 권장합니다.</p>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="window.submitContributorUpload()" class="btn-round primary" style="flex:1;">업로드 및 적립받기</button>
            <button onclick="document.getElementById('contributorUploadModal').style.display='none'" class="btn-round" style="flex:1; background:#f1f5f9; color:#333;">취소</button>
        </div>
    </div>
</div>
<script src="./text-wizard.js"></script>
<div id="vipOrderModal" class="modal-bg" style="z-index: 30000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 550px; max-width: 95%;">
        <div style="background: #1e1b4b; margin: -25px -25px 20px -25px; padding: 25px; color: white; border-radius: 12px 12px 0 0; text-align: center;">
            <h3 style="margin: 0; font-size: 22px; color: #fff;"><i class="fa-solid fa-crown" style="color: #fbbf24;"></i> VIP 우선 접수</h3>
            <p style="margin: 10px 0 0 0; opacity: 0.8; font-size: 13px;">전담 매니저를 선택하고 파일을 올려주세요.</p>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <div style="flex:1;">
                <label class="form-label" style="font-weight:bold; font-size:13px;">담당자 성함</label>
                <input id="vipName" class="ai-input-pretty" placeholder="예: 김철수 팀장" style="margin:0;">
            </div>
            <div style="flex:1;">
                <label class="form-label" style="font-weight:bold; font-size:13px;">연락처</label>
                <input id="vipPhone" class="ai-input-pretty" placeholder="010-0000-0000" style="margin:0;">
            </div>
        </div>

        <div style="margin-bottom: 15px;">
            <label class="form-label" style="font-weight:bold; font-size:13px; margin-bottom:5px; display:block;" data-i18n="label_select_manager">담당 매니저 선택 (Optional)</label>
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:5px;">
                <label class="manager-select">
                    <input type="radio" name="vipManager" value="은미 매니저" checked>
                    <div class="mgr-box">은미 매니저</div>
                </label>
                <label class="manager-select">
                    <input type="radio" name="vipManager" value="지숙 매니저">
                    <div class="mgr-box">지숙 매니저</div>
                </label>
                <label class="manager-select">
                    <input type="radio" name="vipManager" value="성희 매니저">
                    <div class="mgr-box">성희 매니저</div>
                </label>
                <label class="manager-select">
                    <input type="radio" name="vipManager" value="본사담당자">
                    <div class="mgr-box" style="background:#f1f5f9; color:#64748b;">본사담당자</div>
                </label>
            </div>
            <style>
                .manager-select input { display:none; }
                .manager-select .mgr-box { border:1px solid #e2e8f0; padding:10px; text-align:center; border-radius:8px; cursor:pointer; font-weight:bold; color:#475569; transition:0.2s; font-size:13px; }
                .manager-select input:checked + .mgr-box { background:#e0e7ff; border-color:#6366f1; color:#4338ca; box-shadow:0 0 0 2px #6366f1 inset; }
            </style>
        </div>

        <div style="margin-bottom: 15px;">
            <label class="form-label" style="font-weight:bold; font-size:13px;">요청사항 (메모)</label>
            <textarea id="vipMemo" class="ai-input-pretty" placeholder="견적 요청 내용이나 작업 지시사항을 자유롭게 적어주세요." style="height:80px; margin:0;"></textarea>
        </div>

        <div style="margin-bottom: 20px;">
            <label class="form-label" style="font-weight:bold; font-size:13px; display:block; margin-bottom:5px;">파일 업로드 (다중 선택 가능)</label>
            <div onclick="document.getElementById('vipFileInput').click()" style="border: 2px dashed #cbd5e1; background: #f8fafc; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s;">
                <i class="fa-solid fa-cloud-arrow-up" style="font-size: 24px; color: #94a3b8; margin-bottom: 5px;"></i>
                <div style="color: #64748b; font-size: 13px;">여기를 클릭하여 파일 선택 (여러개 가능)</div>
                <div id="vipFileList" style="margin-top:10px; font-size:12px; color:#4338ca; text-align:left; padding-left:10px;"></div>
            </div>
            <input type="file" id="vipFileInput" multiple style="display: none;" onchange="updateVipFileList(this)">
        </div>

        <button onclick="window.submitVipOrder()" class="btn-round primary" style="width: 100%; height: 50px; font-size: 16px; background: #4338ca;">
            🚀 접수하기
        </button>
        <button onclick="document.getElementById('vipOrderModal').style.display='none'" class="btn-round" style="width: 100%; margin-top: 10px; border: none; color: #64748b;">
            닫기
        </button>
    </div>
</div>

<div id="partnerApplyModal" class="modal-bg" style="z-index: 20000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 500px; max-width: 95%;">
        <h3 style="margin-top:0;">🤝 파트너(가맹점) 신청</h3>
        <p style="color:#666; font-size:13px; margin-bottom:20px;">지역 광고/제조 파트너가 되어 수익을 창출하세요.</p>
        
        <div style="margin-bottom:15px;">
            <label class="form-label" style="font-weight:bold;">업체명 (상호)</label>
            <input id="applyCompName" class="ai-input-pretty" placeholder="예: 카멜레온디자인">
        </div>
        
        <div style="margin-bottom:15px;">
            <label class="form-label" style="font-weight:bold;">연락처</label>
            <input id="applyPhone" class="ai-input-pretty" placeholder="010-1234-5678">
        </div>
        
        <div style="margin-bottom:15px;">
            <label class="form-label" style="font-weight:bold;">활동 지역 (다중 입력 가능)</label>
            <input id="applyRegion" class="ai-input-pretty" placeholder="예: 서울 강남구, 서초구, 경기 화성시 (쉼표로 구분)">
            <p style="font-size:11px; color:#ef4444; margin-top:5px;">* 여러 지역 활동 시 쉼표(,)로 구분하여 모두 적어주세요.</p>
        </div>
        <div style="margin-bottom:20px;">
            <label class="form-label" style="font-weight:bold;">주 생산 품목 (제조사인 경우)</label>
            <input id="applyMainItems" class="ai-input-pretty" placeholder="예: 현수막, 아크릴, 간판 (광고사는 '기획/디자인' 입력)">
        </div>

        <button onclick="window.submitRealPartnerApp()" class="btn-round primary" style="width:100%;">신청하기</button>
        <button onclick="window.cancelPartnerApp()" class="btn-round" style="width:100%; margin-top:5px; background:#fff1f2; color:#be123c; border:1px solid #fda4af;">신청 철회하기</button>
        <button onclick="document.getElementById('partnerApplyModal').style.display='none'" class="btn-round" style="width:100%; margin-top:10px; background:#f1f5f9; color:#333; border:none;">닫기</button>
    </div>
</div>

<script>
function updateVipFileList(input) {
    const list = document.getElementById('vipFileList');
    list.innerHTML = '';
    if(input.files.length > 0) {
        for(let i=0; i<input.files.length; i++) {
            list.innerHTML += `<div>📄 ${input.files[i].name}</div>`;
        }
    }
}
</script>
<script type="module">
    import { sb, initConfig } from './config.js?v=119';

    // [유입 경로 상세 분석 함수]
    function getTrafficSource() {
        const params = new URLSearchParams(window.location.search);
        const referrer = document.referrer;
        const currentUrl = window.location.href;

        // 1. [광고 체크] URL에 gclid(구글광고ID)나 utm 파라미터가 있는지 확인
        if (params.has('gclid') || params.get('utm_medium') === 'cpc' || params.get('utm_source') === 'ad') {
            return 'Google Ads (광고)';
        }
        
        // 2. [직접 접속/즐겨찾기] 리퍼러가 없는 경우
        if (!referrer || referrer.trim() === '') {
            return 'Direct (즐겨찾기/주소입력)';
        }

        // 3. [검색 엔진 및 소셜] 도메인 분석
        try {
            const refUrl = new URL(referrer);
            const hostname = refUrl.hostname.toLowerCase();

            if (hostname.includes('google.')) return 'Google Search (자연검색)';
            if (hostname.includes('naver.')) return 'Naver Search (자연검색)';
            if (hostname.includes('daum.') || hostname.includes('kakao.')) return 'Daum/Kakao';
            if (hostname.includes('instagram.')) return 'Instagram';
            if (hostname.includes('facebook.') || hostname.includes('fb.com')) return 'Facebook';
            if (hostname.includes('youtube.')) return 'Youtube';
            if (hostname.includes('bing.')) return 'Bing Search';

            // 그 외 사이트 (블로그 등)는 도메인 그대로 표시
            return hostname;
        } catch (e) {
            return 'Other Websites';
        }
    }

    async function trackVisit() {
        // DB 설정 로드 대기
        if (!sb || !sb.from) {
            if (typeof initConfig === 'function') await initConfig();
        }

        try {
            // 상세 분석된 유입 경로 가져오기
            const visitSource = getTrafficSource();

            // 1. 방문 기록 저장
            const { data, error } = await sb
                .from('page_views')
                .insert([{ 
                    referrer: visitSource, // 분석된 결과를 저장
                    duration: 0 
                }])
                .select()
                .single();

            if (error) throw error;

            // 2. 체류시간 업데이트 (5초 간격)
            const visitId = data.id;
            const startTime = Date.now();
            
            setInterval(() => {
                const durationSec = Math.floor((Date.now() - startTime) / 1000);
                sb.from('page_views')
                  .update({ duration: durationSec })
                  .eq('id', visitId)
                  .then(() => {});
            }, 5000);

        } catch (e) {
            console.warn("Tracking skipped:", e.message);
        }
    }

    // 페이지 로드 시 실행
    window.addEventListener('load', trackVisit);
    // [신규] '배송' 카테고리 자동 열기 함수
    window.openDeliveryCategory = async function() {
        document.getElementById('cartAddedModal').style.display = 'none'; // 완료 모달 닫기
        
        // 로딩 표시를 위해 카테고리 모달을 먼저 엽니다 (빈 상태)
        const modal = document.getElementById('categoryDetailModal');
        const grid = document.getElementById('catProductGrid');
        modal.style.display = 'flex';
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px;"><i class="fa-solid fa-spinner fa-spin"></i> 배송 옵션을 찾는 중...</div>';

        try {
            // DB에서 이름이 '배송'인 카테고리를 찾습니다.
            const { data, error } = await sb.from('admin_categories')
                .select('*')
                .eq('name', '배송') // ★ DB에 저장된 정확한 이름이어야 합니다
                .single();

            if (error || !data) {
                alert("배송 카테고리를 찾을 수 없습니다. 관리자에게 문의해주세요.");
                modal.style.display = 'none';
                return;
            }

            // 찾은 카테고리 코드로 상품 목록을 띄웁니다.
            window.showCategoryProducts(data.code, data.name, data.description);

        } catch (e) {
            console.error(e);
            alert("오류가 발생했습니다.");
            modal.style.display = 'none';
        }
    };

    // [신규] 장바구니 화면만 열기 (결제 유도 X)
    window.goToCartPageOnly = function() {
        document.getElementById('cartAddedModal').style.display = 'none';
        document.getElementById('cartPage').style.display = 'block';
        if(window.renderCart) window.renderCart();
    };
    // [수정 1] 템플릿 만들기 버튼 클릭 시 -> 전용 모달 열기
    window.openTemplateCreator = function() {
        // 1. 로그인 체크
        if (!window.currentUser) {
            alert(window.t ? window.t('msg_login_required') : "로그인이 필요합니다.");
            document.getElementById('loginModal').style.display = 'flex';
            return;
        }

        // 2. 모달 열기 (값 초기화)
        document.getElementById('tplCreateW').value = '1000';
        document.getElementById('tplCreateH').value = '1000';
        document.getElementById('templateCreatorModal').style.display = 'flex';
    };

    // [수정 2] "디자인 시작하기" 버튼 클릭 시 실행 (초기화 및 에디터 진입)
    // [최종 수정] "디자인 시작하기" 버튼 클릭 시 실행 (강력 초기화 적용)
    window.confirmTemplateCreation = function() {
        const wVal = document.getElementById('tplCreateW').value;
        const hVal = document.getElementById('tplCreateH').value;
        const w = parseInt(wVal);
        const h = parseInt(hVal);

        if (!w || !h || w <= 0 || h <= 0) {
            alert("올바른 사이즈를 입력해주세요.");
            return;
        }

        // ★ [핵심] 유령 이미지 완벽 차단: 모든 관련 변수 초기화
        window.pendingTemplate = null; 
        window.pendingAiImage = null;
        window.selectedTpl = null; // ★ 이 부분이 중요합니다 (갤러리 선택 해제)
        
        // 파일 입력창들도 싹 비우기
        const inputs = ['contributorFileInput', 'imgUpload', 'logoFileInput', 'vipFileInput'];
        inputs.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.value = '';
        });

        // 모달 닫기
        document.getElementById('templateCreatorModal').style.display = 'none';

        // 에디터 열기 (빈 화면)
        if (window.startEditorDirect) {
            // custom 키로 빈 캔버스 시작
            window.startEditorDirect('custom', w, h);
            
            // [안전장치] 에디터 로드 직후 캔버스를 한 번 더 비워줌 (0.5초 뒤 실행)
            setTimeout(() => {
                if(window.canvas) {
                    // 배경(Board)을 제외한 모든 객체 삭제
                    const objects = window.canvas.getObjects().filter(o => !o.isBoard);
                    objects.forEach(o => window.canvas.remove(o));
                    window.canvas.requestRenderAll();
                }
            }, 500);
        } else {
            alert("에디터 로드 중 오류가 발생했습니다. 새로고침 해주세요.");
        }
    };


// =================================================================
// [최종] 템플릿 모달: 카테고리 + 상품 통합 검색 기능
// =================================================================

// 전역 변수에 모달용 데이터를 저장해둡니다.
window.modalGlobalData = {
    categories: [],
    products: [],
    thumbMap: {}
};

// 1. 모달 열기 및 데이터 준비
window.showCategorySelectionModal = async function() {
    const modal = document.getElementById('categoryDetailModal');
    const grid = document.getElementById('catProductGrid');
    const titleEl = document.getElementById('catModalTitle');
    const descEl = modal.querySelector('p');
    const searchInput = document.getElementById('modalProdSearch');

    // UI 초기화
    if(titleEl) titleEl.innerHTML = `<span style="color:#6366f1;">템플릿을 적용할 상품 검색</span>`;
    if(descEl) descEl.style.display = 'none'; // 설명 숨김
    
    // 검색창 초기화
    if(searchInput) {
        searchInput.value = ''; 
        setTimeout(() => searchInput.focus(), 100); 
    }

    modal.style.display = 'flex';
    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px;"><i class="fa-solid fa-spinner fa-spin" style="font-size:30px; color:#6366f1;"></i><br><br>데이터 로딩 중...</div>';
    
    try {
        if (typeof sb === 'undefined') throw new Error("DB 연결이 없습니다.");

        // (1) 카테고리 가져오기
        const { data: categories } = await sb.from('admin_categories')
            .select('*').order('sort_order', { ascending: true });

        // (2) 상품 데이터 가져오기 (코드, 가격, 이미지 포함)
        const { data: products } = await sb.from('admin_products')
            .select('category, img_url, name, code, price, width_mm, height_mm')
            .not('img_url', 'is', null)
            .neq('img_url', '');

        // (3) 데이터 전역 저장
        window.modalGlobalData.categories = categories || [];
        window.modalGlobalData.products = products || [];
        window.modalGlobalData.thumbMap = {};

        // 썸네일 매핑 (카테고리 대표 이미지용)
        if (products) {
            products.forEach(p => {
                if (p.category && !window.modalGlobalData.thumbMap[p.category]) {
                    window.modalGlobalData.thumbMap[p.category] = p.img_url;
                }
            });
        }

        // (4) 초기 화면 그리기 (검색어 없음 -> 안내 문구 표시)
        window.filterModalItems('');

    } catch (e) {
        console.error("로딩 실패:", e);
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">오류가 발생했습니다.</div>';
    }
};

// 2. 검색 및 화면 그리기 (통합 검색 로직)
window.filterModalItems = function(keyword) {
    const term = keyword.toLowerCase().trim();
    const grid = document.getElementById('catProductGrid');
    if (!grid) return;

    // A. 검색어가 없을 때 -> 안내 문구만 표시 (깔끔하게)
    if (term === '') {
        grid.innerHTML = `
            <div style="grid-column:1/-1; text-align:center; padding: 60px 0; color:#94a3b8;">
                <i class="fa-solid fa-magnifying-glass" style="font-size:40px; margin-bottom:15px; opacity:0.5;"></i><br>
                <span style="font-size:18px; font-weight:bold; color:#475569;">찾으시는 상품을 검색해주세요.</span><br>
                <span style="font-size:14px; margin-top:5px; display:inline-block;">(예: 배너, 현수막, 텀블러 등)</span>
            </div>
        `;
        return;
    }

    // B. 검색어가 있을 때 -> 필터링 시작
    const { categories, products, thumbMap } = window.modalGlobalData;

    // 1) 카테고리 검색
    const matchedCats = categories.filter(cat => (cat.name || '').toLowerCase().includes(term));
    
    // 2) 상품 검색 (이름 일치)
    const matchedProds = products.filter(prod => (prod.name || '').toLowerCase().includes(term));

    // 결과가 없을 때
    if (matchedCats.length === 0 && matchedProds.length === 0) {
        grid.innerHTML = `
            <div style="grid-column:1/-1; text-align:center; padding: 50px 0; color:#94a3b8;">
                <i class="fa-solid fa-circle-exclamation" style="font-size:30px; margin-bottom:10px;"></i><br>
                <span>검색 결과가 없습니다.</span>
            </div>
        `;
        return;
    }

    // C. 결과 그리기 (기존 내용 비우고 새로 그림)
    grid.innerHTML = '';

    // [헬퍼] 아이템 HTML 생성 함수
    const createItem = (item, type) => {
        const div = document.createElement('div');
        div.className = 'quick-item';
        
        // 이미지 주소 결정
        let rawUrl = '';
        let badgeHtml = '';
        let subText = '';

        if (type === 'category') {
            rawUrl = item.img_url || item.image || thumbMap[item.code] || '';
            // 카테고리는 뱃지 없음
        } else {
            // 상품인 경우
            rawUrl = item.img_url || '';
            badgeHtml = `<span style="position:absolute; top:6px; left:6px; background:#6366f1; color:white; font-size:10px; font-weight:bold; padding:2px 6px; border-radius:4px; z-index:2;">상품</span>`;
            subText = `<div style="font-size:11px; color:#888; margin-top:2px;">${(item.price||0).toLocaleString()}원</div>`;
        }

        const iconUrl = window.getTinyThumb ? window.getTinyThumb(rawUrl, 150) : rawUrl;
        const imgTag = iconUrl 
            ? `<img src="${iconUrl}" loading="lazy" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentNode.innerHTML='<i class=\\'fa-solid fa-cube\\'></i>'">`
            : `<i class="fa-solid fa-folder-open" style="font-size:24px; color:#cbd5e1;"></i>`;

        div.innerHTML = `
            <div class="quick-icon" style="background:#fff; border:1px solid #f1f5f9; overflow:hidden; display:flex; align-items:center; justify-content:center; position:relative;">
                ${badgeHtml}
                ${imgTag}
            </div>
            <div class="quick-text">${item.name}</div>
            ${subText}
        `;

        // 클릭 이벤트 연결
        div.onclick = () => {
            if (type === 'category') {
                window.showCategoryProducts(item.code, item.name);
            } else {
                // 상품 클릭 시 분기 처리
                document.getElementById('categoryDetailModal').style.display = 'none'; // 모달 닫기
                
                if (item.is_general_product) {
                    // [수정] 일반 상품: 수량 입력 모달 열기
                    window.openGeneralProductModal(item.code);
                } else {
                    // [수정] 디자인 상품: 에디터 시작
                    window.startEditorDirect(
                        item.code, 
                        item.width_mm, 
                        item.height_mm
                    );
                }
            }
        };
        return div;
    };

    // 카테고리 먼저 추가
    matchedCats.forEach(cat => grid.appendChild(createItem(cat, 'category')));
    // 상품 그 뒤에 추가
    matchedProds.forEach(prod => grid.appendChild(createItem(prod, 'product')));
};

</script>

<div id="cartAddedModal" class="modal-bg" style="z-index: 16000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 400px; text-align: center; padding: 40px 30px;">
        <div style="font-size: 50px; color: #6366f1; margin-bottom: 20px;">
            <i class="fa-regular fa-circle-check"></i>
        </div>
        <h3 style="margin: 0 0 10px 0; font-size: 22px;">장바구니에 담겼습니다!</h3>
        <p style="color: #666; margin-bottom: 30px;">선택하신 상품이 장바구니에 추가되었습니다.</p>
        
        <div style="display: flex; flex-direction: column; gap: 8px;">
            <button onclick="window.goToCartFromSuccess()" class="btn-round primary" style="width: 100%; justify-content: center; height: 45px; font-size: 15px;">
                💳 바로 결제하러 가기
            </button>

            <button onclick="window.openDeliveryCategory()" class="btn-round" style="width: 100%; justify-content: center; height: 45px; background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; font-weight:800;">
                🚚 배송비/설치비 추가하기
            </button>

            <button onclick="window.goToCartPageOnly()" class="btn-round" style="width: 100%; justify-content: center; height: 45px; background: #f0f9ff; color: #0369a1; border: 1px solid #bae6fd;">
                🛒 장바구니로 가기
            </button>

            <button onclick="window.continueShopping()" class="btn-round" style="width: 100%; justify-content: center; height: 45px; background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0;">
                🛍️ 다른상품 더 쇼핑하기
            </button>
        </div>
    </div>
</div>
<div id="partnerApplyModal" class="modal-bg" style="z-index: 20000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 500px; max-width: 95%;">
        <h3 style="margin-top:0;">🤝 파트너(가맹점) 신청</h3>
        <p style="color:#666; font-size:13px; margin-bottom:20px;">지역 광고/제조 파트너가 되어 수익을 창출하세요.</p>
        
        <div style="margin-bottom:15px;">
            <label class="form-label" style="font-weight:bold;">업체명 (상호)</label>
            <input id="applyCompName" class="ai-input-pretty" placeholder="예: 카멜레온디자인">
        </div>
        
        <div style="margin-bottom:15px;">
            <label class="form-label" style="font-weight:bold;">연락처</label>
            <input id="applyPhone" class="ai-input-pretty" placeholder="010-1234-5678">
        </div>
        
        <div style="margin-bottom:15px;">
            <label class="form-label" style="font-weight:bold;">활동 지역 (구 단위까지 입력)</label>
            <input id="applyRegion" class="ai-input-pretty" placeholder="예: 서울 강남구, 경기 화성시">
            <p style="font-size:11px; color:#ef4444; margin-top:5px;">* 정확한 매칭을 위해 시/군/구 단위까지 입력해주세요.</p>
        </div>
        
        <div style="margin-bottom:20px;">
            <label class="form-label" style="font-weight:bold;">주 생산 품목 (제조사인 경우)</label>
            <input id="applyMainItems" class="ai-input-pretty" placeholder="예: 현수막, 아크릴, 간판 (광고사는 '기획/디자인' 입력)">
        </div>

        <button onclick="window.submitRealPartnerApp()" class="btn-round primary" style="width:100%;">신청하기</button>
        <button onclick="document.getElementById('partnerApplyModal').style.display='none'" class="btn-round" style="width:100%; margin-top:10px; background:#f1f5f9; color:#333; border:none;">닫기</button>
    </div>
</div>

<script>
    // 파트너 신청 제출 스크립트 (index.html 내부에 포함)
    window.submitRealPartnerApp = async function() {
        if (typeof sb === 'undefined') { alert("시스템 로딩 중입니다."); return; }

        const comp = document.getElementById('applyCompName').value;
        const phone = document.getElementById('applyPhone').value;
        const region = document.getElementById('applyRegion').value;
        const items = document.getElementById('applyMainItems').value;

        if(!comp || !phone || !region) return alert("업체명, 연락처, 지역은 필수입니다.");

        const { data: { user } } = await sb.auth.getUser();
        if(!user) return alert("로그인이 필요합니다.");

        const { error } = await sb.from('partner_applications').insert({
            user_id: user.id,
            company_name: comp,
            contact_phone: phone,
            region: region,
            main_items: items,
            status: 'pending'
        });

        if(error) alert("신청 오류: " + error.message);
        else {
            alert("✅ 신청이 완료되었습니다. 관리자 승인 후 이용 가능합니다.");
            document.getElementById('partnerApplyModal').style.display='none';
        }
    };

    // [추가] 파트너스 신청 취소 함수 (피드백 4)
    window.cancelPartnerApp = async function() {
        if(!confirm("신청을 철회하시겠습니까?")) return;
        const { data: { user } } = await sb.auth.getUser();
        if(!user) return;
        
        const { error } = await sb.from('partner_applications')
            .delete()
            .eq('user_id', user.id)
            .eq('status', 'pending'); // 대기중인 것만 취소 가능

        if(error) alert("철회 실패: " + error.message);
        else {
            alert("신청이 철회되었습니다.");
            document.getElementById('partnerApplyModal').style.display='none';
        }
    };

    // [추가] 파트너스 탭 전환
    window.switchPartnerTab = function(tabName) {
        document.querySelectorAll('.partner-tab-content').forEach(el => el.style.display = 'none');
        document.getElementById('tab-' + tabName).style.display = 'block';
        
        document.querySelectorAll('.nav-menu .nav-item').forEach(el => el.classList.remove('active'));
        // 스타일 처리는 간소화 (필요시 구현)
        
        if(tabName === 'pool' || tabName === 'my') loadPartnerOrders(tabName);
    };

    // [추가] 파트너스 주문 로드 (피드백 1, 4 반영)
    window.loadPartnerOrders = async function(mode) {
        const listDiv = (mode === 'pool') ? document.getElementById('orderPoolList') : document.getElementById('myOrderList');
        if(!listDiv) return;
        
        listDiv.innerHTML = '<div style="padding:20px; text-align:center;">로딩 중...</div>';
        
        const { data: { user } } = await sb.auth.getUser();
        if(!user) return;

        let query = sb.from('orders').select('*').order('created_at', { ascending: false });

        if(mode === 'pool') {
            // [피드백 1 반영] 미결제 주문 제외 (결제완료, 입금확인 상태만 노출)
            query = query.in('payment_status', ['결제완료', '입금확인'])
                         .eq('status', '접수됨'); // 아직 배정되지 않은 접수 상태
        } else if(mode === 'my') {
            // 내가 입찰한 주문 조회 (bids 테이블 조인 필요하지만, 간소화를 위해 orders에서 필터링하거나 별도 로직)
            // 여기서는 예시로 status가 진행중인 것들만 보여준다고 가정
             query = query.in('status', ['제작준비', '칼선작업', '출력중']); 
             // 실제로는 bids 테이블과 join하여 내가 입찰한 order_id를 가져와야 정확함
             // (Supabase join 쿼리가 복잡하므로, 여기서는 UI 구조만 잡습니다)
        }

        const { data: orders, error } = await query.limit(20);
        
        if(error || !orders || orders.length === 0) {
            listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">주문 내역이 없습니다.</div>';
            return;
        }

        listDiv.innerHTML = '';
        orders.forEach(o => {
            const isMyTab = mode === 'my';
            
            // [피드백 4 반영] 잘못 접수한 경우 취소 버튼 (나의 주문 탭에서만)
            let actionBtn = `<button class="btn-round primary" onclick="window.bidOrder('${o.id}')">입찰하기</button>`;
            if(isMyTab) {
                actionBtn = `<button class="btn-round" style="background:#fee2e2; color:#ef4444; border:1px solid #fca5a5;" onclick="window.cancelBid('${o.id}')">접수 취소/철회</button>`;
            }

            listDiv.innerHTML += `
                <div style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:15px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span class="badge">${o.status}</span>
                        <span style="font-weight:bold; color:#6366f1;">${(o.total_amount||0).toLocaleString()}원</span>
                    </div>
                    <div style="font-weight:bold; margin-bottom:5px;">${o.manager_name || '고객'} (${o.site_code})</div>
                    <div style="font-size:13px; color:#64748b; margin-bottom:10px;">${o.addr_basic || '주소 비공개'}</div>
                    ${actionBtn}
                </div>
            `;
        });
    };

    // [추가] 입찰 취소 함수 (피드백 4)
    window.cancelBid = async function(orderId) {
        if(!confirm("정말로 접수를 철회하시겠습니까?\n고객에게 알림이 갈 수 있습니다.")) return;
        
        const { data: { user } } = await sb.auth.getUser();
        
        // bids 테이블에서 내 입찰 삭제
        const { error } = await sb.from('bids').delete().eq('order_id', orderId).eq('partner_id', user.id);
        
        if(error) alert("철회 실패: " + error.message);
        else {
            alert("정상적으로 철회되었습니다.");
            loadPartnerOrders('my');
        }
    };



</script>
<div id="templateCreatorModal" class="modal-bg" style="z-index: 21000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 500px; max-width: 95%; text-align: left; border-radius: 16px; overflow: hidden; padding: 0;">
        
        <div style="background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%); padding: 20px 25px; color: white;">
            <h3 style="margin: 0; font-size: 20px; display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-palette"></i> 템플릿 만들기 시작
            </h3>
            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 13px;">나만의 멋진 디자인을 등록하고 수익을 창출하세요!</p>
        </div>

        <div style="padding: 25px;">
            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <ul style="margin: 0; padding-left: 20px; color: #475569; font-size: 13px; line-height: 1.8;">
                    <li>📷 <strong>이미지/벡터 구분:</strong> 배경이 벡터라면 벡터로, 이미지라면 이미지로 등록.</li>
                    <li>💡 <strong>꿀팁:</strong> 글씨 배치 후 배경만 바꾸면 빠르게 등록가능.</li>
                    <li>💰 <strong>수익 UP:</strong> 태그를 많이 입력할수록 노출이 잘 되어 수익금 상승.</li>
                    <li>⚡ <strong>즉시 적립:</strong> 템플릿 등록 즉시 수익 + 판매수익까지.</li>
                </ul>
            </div>

            <label style="font-weight: bold; font-size: 14px; color: #1e293b; display: block; margin-bottom: 8px;">
                📏 만들고 싶은 탬플릿 사이즈 (mm)
            </label>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <div style="flex: 1; position: relative;">
                    <input type="number" id="tplCreateW" class="ai-input-pretty" placeholder="가로" value="1000" style="padding-right: 30px; font-weight: bold; color: #334155;">
                    <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 12px;">mm</span>
                </div>
                <span style="display: flex; align-items: center; color: #cbd5e1;">X</span>
                <div style="flex: 1; position: relative;">
                    <input type="number" id="tplCreateH" class="ai-input-pretty" placeholder="세로" value="1000" style="padding-right: 30px; font-weight: bold; color: #334155;">
                    <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 12px;">mm</span>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="document.getElementById('templateCreatorModal').style.display='none'" class="btn-round" style="flex: 1; justify-content: center; background: #fff; border: 1px solid #cbd5e1; color: #64748b;">
                    취소
                </button>
                <button onclick="window.confirmTemplateCreation()" class="btn-round primary" style="flex: 2; justify-content: center; height: 45px; font-size: 15px; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);">
                    🚀 디자인 시작하기
                </button>
            </div>
        </div>
    </div>
</div>
</body>
</html>