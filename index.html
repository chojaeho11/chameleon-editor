<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script>
    // [í†µí•© ë¯¸ë””ì–´ ë¡œë”] ë¡œë”© ì†ë„ ê°œì„  ë° ë°ì´í„° ì˜¤ì¸ì‹ ë°©ì§€
    window.addEventListener('DOMContentLoaded', function() {
        if (typeof fabric === 'undefined') return;
        const originalFromURL = fabric.Image.fromURL;
        
        fabric.Image.fromURL = function(url, callback, options) {
            if (!url || typeof url !== 'string') return callback && callback(null);

            // JSON ë°ì´í„°ê°€ ì´ë¯¸ì§€ ì£¼ì†Œë¡œ ì˜ëª» ë“¤ì–´ì˜¨ ê²½ìš°ë§Œ í•„í„°ë§ (ì˜ìƒ íŒŒì¼ .mp4 ë“±ì€ ì œì™¸)
            const isJson = url.startsWith('{') || url.includes('%7B') || url.includes('{"version"');
            const isVideo = url.toLowerCase().match(/\.(mp4|webm|ogg|mov)$/);

            if (isJson && !isVideo) {
                try {
                    const jsonObj = JSON.parse(decodeURIComponent(url));
                    if (window.canvas) {
                        window.canvas.loadFromJSON(jsonObj, () => {
                            window.canvas.requestRenderAll();
                            const loader = document.getElementById('loading');
                            if(loader) loader.style.display = 'none';
                        });
                    }
                    return;
                } catch (e) { console.error("JSON ë³µì› ì‹¤íŒ¨"); }
            }
            return originalFromURL.call(this, url, callback, options);
        };
        console.log("âœ… ë¯¸ë””ì–´ ìµœì í™” ì—”ì§„ ê°€ë™");
    });
</script>
<script>
    // [ê¸°ì¡´ ì½”ë“œ] ì„œë¹„ìŠ¤ ì›Œì»¤ ë° ìºì‹œ ì‚­ì œ
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for(let registration of registrations) {
                registration.unregister();
                console.log("ì¢€ë¹„ ì„œë¹„ìŠ¤ ì›Œì»¤ ì‚­ì œ ì™„ë£Œ!");
            }
        });
        caches.keys().then(function(names) {
            for (let name of names) caches.delete(name);
            console.log("ì¢€ë¹„ ìºì‹œ ì €ì¥ì†Œ ì‚­ì œ ì™„ë£Œ!");
        });
    }

    // [â˜…ì¶”ê°€í•  ì½”ë“œ] 431 ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•œ ëª¨ë“  ì¿ í‚¤ ì‚­ì œ
    document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
    });
    console.log("í—¤ë” ìš©ëŸ‰ ì´ˆê³¼ ë°©ì§€ë¥¼ ìœ„í•´ ì¿ í‚¤ë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.");
</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ… - ì¹œí™˜ê²½ ì „ì‹œÂ·íŒì—…ìŠ¤í† ì–´ ì¸ì‡„ & ë¬´ë£Œ ë””ìì¸ ì—ë””í„°</title>
<meta name="description" content="í—ˆë‹ˆì½¤ë³´ë“œ, íŒ¨ë¸Œë¦­ì¸ì‡„, íŒì—…ìŠ¤í† ì–´ ì „ë¬¸. ë¬´ë£Œ ì—ë””í„°ë¡œ ë“±ì‹ ëŒ€/ë°±ì›” ë””ìì¸ë¶€í„° ì¸ì‡„ê¹Œì§€ í•œë²ˆì— í•´ê²°í•˜ì„¸ìš”.">

<meta property="og:type" content="website">
<meta property="og:site_name" content="ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ…">
<meta property="og:title" content="ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ… - ì¹œí™˜ê²½ ì „ì‹œ ì¸ì‡„ & ë¬´ë£Œ ì—ë””í„°">
<meta property="og:description" content="í—ˆë‹ˆì½¤ë³´ë“œ, íŒ¨ë¸Œë¦­ì¸ì‡„, íŒì—…ìŠ¤í† ì–´ ì „ë¬¸. ë¬´ë£Œ ì—ë””í„°ë¡œ ì‰½ê³  ë¹ ë¥´ê²Œ ë””ìì¸í•˜ì„¸ìš”.">
<meta property="og:url" content="https://www.cafe2626.com/">
<meta property="og:image" content="https://gdadmin.signmini.com/data/editor/policy/260105/6c9bc3b9b9a5903a01b44a7b36fc2cbe_191502.png">
<link rel="shortcut icon" href="https://gdadmin.signmini.com/data/common/favicon.ico">
<meta name="keywords" content="ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ…, í—ˆë‹ˆì½¤ë³´ë“œ, ì¢…ì´ë§¤ëŒ€, íŒ¨ë¸Œë¦­ì¸ì‡„, íŒì—…ìŠ¤í† ì–´, ë“±ì‹ ëŒ€ì œì‘, ì‹¤ì‚¬ì¶œë ¥, ì—°í¬ì¥, ì¹œí™˜ê²½ì „ì‹œ, ë°±ì›”ë””ìì¸, ì „ì‹œë¶€ìŠ¤, í¼ë³´ë“œì¸ì‡„">
<link rel="canonical" href="https://www.cafe2626.com/" />

<link rel="canonical" href="https://www.cafe3355.com/">
    <link rel="alternate" hreflang="ko" href="https://www.cafe2626.com/">
    <link rel="alternate" hreflang="en" href="https://www.cafe3355.com/">
    <link rel="alternate" hreflang="ja" href="https://www.cafe0101.com/">
    <link rel="alternate" hreflang="x-default" href="https://www.cafe2626.com/">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/svg2pdf.js@2.2.4/dist/svg2pdf.umd.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/plugins/svg.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/kilobtye/potrace@master/potrace.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/js-clipper@1.0.1/clipper.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.17/paper-full.min.js" defer></script>
<script src="https://js.tosspayments.com/v1" defer></script>

<!-- Pretendard í°íŠ¸ëŠ” loadLanguageFont()ì—ì„œ êµ­ê°€ë³„ë¡œ ë™ì  ë¡œë“œ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="./style.css?v=120">

<meta name="naver-site-verification" content="141eed82fa50fd6f98fa7bfe8dc481a202beb8cf" />

<!-- ì±„ë„í†¡ ë¹„í™œì„±í™” (ì¹´ë©œë ˆì˜¨ AI ì±—ë´‡ìœ¼ë¡œ ëŒ€ì²´)
<script>
  (function(){var w=window;if(w.ChannelIO){return w.console.error("ChannelIO script included twice.");}var ch=function(){ch.c(arguments);};ch.q=[];ch.c=function(args){ch.q.push(args);};w.ChannelIO=ch;function l(){if(w.ChannelIOInitialized){return;}w.ChannelIOInitialized=true;var s=document.createElement("script");s.type="text/javascript";s.async=true;s.src="https://cdn.channel.io/plugin/ch-plugin-web.js";var x=document.getElementsByTagName("script")[0];if(x.parentNode){x.parentNode.insertBefore(s,x);}}if(document.readyState==="complete"){l();}else{w.addEventListener("DOMContentLoaded",l);w.addEventListener("load",l);}})();
  ChannelIO('boot', { "pluginKey": "752ba9ff-a447-4e10-9813-715e051995cd" });
</script>
-->
<script>
    // 1. í”„ë¡œì íŠ¸ ë²„ì „
    const PROJECT_VERSION = '119';
    const DATA_PATH = './long/';
</script>
</head>
<body>
<div id="loading"><div class="loading-spin"></div><p style="margin-top:15px; font-weight:600;" data-i18n="msg_loading">ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...</p></div>

<div id="contextMenu">
    <div class="ctx-item" id="ctxUndo"><i class="fa-solid fa-rotate-left"></i> <span data-i18n="ctx_undo">ì‹¤í–‰ ì·¨ì†Œ</span></div>
    <div class="ctx-item" id="ctxRedo"><i class="fa-solid fa-rotate-right"></i> <span data-i18n="ctx_redo">ë‹¤ì‹œ ì‹¤í–‰</span></div>
    <div class="ctx-divider"></div>
    <div class="ctx-item" id="ctxCopy"><i class="fa-regular fa-copy"></i> <span data-i18n="ctx_copy">ë³µì‚¬í•˜ê¸°</span></div>
    <div class="ctx-item" id="ctxPaste"><i class="fa-regular fa-paste"></i> <span data-i18n="ctx_paste">ë¶™ì—¬ë„£ê¸°</span></div>
    <div class="ctx-item" id="ctxDelete" style="color:#ef4444;"><i class="fa-solid fa-trash"></i> <span data-i18n="ctx_delete">ì‚­ì œí•˜ê¸°</span></div>
    <div class="ctx-divider"></div>
    <div class="ctx-item" id="ctxFront"><i class="fa-solid fa-arrow-up-from-bracket"></i> <span data-i18n="ctx_front">ë§¨ ì•ìœ¼ë¡œ</span></div>
    <div class="ctx-item" id="ctxBack"><i class="fa-solid fa-arrow-down-from-bracket"></i> <span data-i18n="ctx_back">ë§¨ ë’¤ë¡œ</span></div>
    <div class="ctx-divider"></div>
    <div class="ctx-item" id="ctxLock"><i class="fa-solid fa-lock"></i> <span data-i18n="ctx_lock">ì ê¸ˆ (Lock)</span></div>
</div>
<div class="topbar">
        <div class="brand" onclick="window.goHome()"><i class="fa-solid fa-palette"></i> Chameleon</div>
        
        <div class="template-tabs">
            <button id="btnMobileTemplateOpen" onclick="document.getElementById('templateOverlay').style.display='flex'; window.filterTpl('group_template');" data-i18n="btn_mobile_template">ğŸ¨ í…œí”Œë¦¿</button>
            
            <button class="tpl-tab" onclick="document.getElementById('templateOverlay').style.display='flex'; window.filterTpl('group_template', this);" 
    style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; font-weight: 800; border: none; margin-right: 5px;">
    <span data-i18n="tab_all">ğŸ¨ í…œí”Œë¦¿ (ë°°ê²½)</span>
</button>

<button class="tpl-tab" onclick="document.getElementById('templateOverlay').style.display='flex'; window.filterTpl('group_asset', this);" 
    style="background: #fff; color: #059669; border: 1px solid #059669; font-weight: 800;">
    <span data-i18n="tab_graphic">ğŸ§© ê°ì²´ (ìš”ì†Œ/ë²¡í„°)</span>
</button>
        </div>
        
        <div style="flex:1;"></div>
        
        <button class="btn" onclick="window.goHome()" style="margin-right:5px; background:rgb(206, 14, 78); border:1px solid #ddd; color:#ffffff; padding:8px 12px;">
    <i class="fa-solid fa-house"></i> <span style="font-weight:bold;">HOME</span>
</button>

<button class="btn primary" id="btnOrderTop" style="margin-right:5px; background:#ffde26; color:#ffffff; font-weight:bold; box-shadow:0 4px 12px rgb(197, 255, 90);">
    <span data-i18n="btn_add_to_cart">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</span>
</button>

<!-- <button class="btn" id="btnViewCart" onclick="document.getElementById('cartPage').style.display='block'; document.body.classList.remove('editor-active');" style="display:none !important; margin-right:5px; background:rgb(137, 57, 241); border:1px solid #fdfff2; color:#ffffff; padding:8px 12px;"> -->
    <!-- <span data-i18n="btn_cart">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</span> -->
<!-- </button> -->
        
        <button class="btn" id="btnLoginBtn" onclick="document.getElementById('loginModal').style.display='flex'" style="margin-right:5px;" data-i18n="btn_login">ë¡œê·¸ì¸</button>

        <button class="btn" id="btnMyLibrary" onclick="document.getElementById('libraryModal').style.display='flex'; if(window.loadMyDesigns) window.loadMyDesigns();" style="background:white; border:1px solid #ddd; color:#333; padding:8px 12px;">
            <span data-i18n="btn_my_library">ğŸ“‚ ë³´ê´€í•¨</span>
        </button>
        <button class="btn" onclick="window.openMyOrderList()" style="background:white; border:1px solid #ddd; color:#333; margin-right:5px;">
    <span data-i18n="menu_orders">ğŸšš ì£¼ë¬¸ë°°ì†¡ì¡°íšŒ</span>
</button>
    </div>


<div id="startScreen">
    
    <div class="hero-section">
    <h1 class="hero-title" data-i18n="hero_title">ê´‘ê³ ì‚¬ ê¸°íšì‚¬ íŒŒí‹°í”Œë˜ë„ˆë¼ë©´? <br><span>ì¹´ë©œë ˆì˜¨</span>ê³¼ í•¨ê»˜í•´ìš”.</h1>
    <p class="hero-desc" data-i18n="hero_desc">ëŒ€í•œë¯¼êµ­ 1ë“± ê´‘ê³ ì¸ì‡„ ë„ë§¤ì‡¼í•‘ëª°, ë¡œê³ ë¥¼ ê³µìœ í•˜ê³  í•¨ê»˜ ë§Œë“œëŠ” ë¬´ë£Œì—ë””í„°</p>
</div>
<!-- í€µë©”ë‰´ì™€í¼ -->
<div class="quick-menu-wrapper">
    
    <img src="https://cdn-pro-web-159-230.cdn-nhncommerce.com/dnjsdudrjs13_godomall_com/data/editor/goods/251229/b74dea838f41881ce41d11b7c306629f_152347.png" class="bouncing-char" alt="ìºë¦­í„°">
    
    
    <div class="quick-title-box">
        <span class="qt-badge" data-i18n="home_quick_badge">ë‹´ë‹¹ ë§¤ë‹ˆì €ì—ê²Œ ì‚¬ì—…ìë¥¼ ë³´ë‚´ì£¼ì„¸ìš” 10%í• ì¸ê³¼ ë¬´ë£Œë°°ì†¡ì„ ì§€ì›í•©ë‹ˆë‹¤.</span>
        <h2 class="qt-text" data-i18n="home_quick_title">ì‚¬ì—…ìì—ê²Œ íŠ¹ë³„í•œ í˜œíƒ, ìˆ˜ë„ê¶Œ ë¬´ë£Œë°°ì†¡ ì´ì•Œë°°ì†¡</h2>
    </div>
    <div id="topCategoryTabs" class="category-tabs"></div>

    <div id="categoryDescriptionBox" style="
        max-width: 1000px;
        margin: 10px auto 30px auto; 
        padding: 20px; 
        background: #f8fafc; 
        border-radius: 12px; 
        text-align: center; 
        font-size: 15px; 
        color: #475569; 
        line-height: 1.6;
        display: none; 
        border: 1px solid #e2e8f0;
        word-break: keep-all;
    ">
    </div>

    <div class="main-search-wrapper" style="max-width: 1000px; margin: 0 auto 25px auto; padding: 0 15px; position: relative; z-index: 10;">
    <style>
        @keyframes searchGlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .search-glow-border {
            position: relative;
            border-radius: 50px;
            padding: 3px;
            background: linear-gradient(90deg, #6366f1, #a855f7, #ec4899, #f59e0b, #10b981, #6366f1);
            background-size: 300% 300%;
            animation: searchGlow 4s ease infinite;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2), 0 0 20px rgba(168, 85, 247, 0.1);
            transition: box-shadow 0.3s;
        }
        .search-glow-border:focus-within {
            box-shadow: 0 12px 35px rgba(99, 102, 241, 0.3), 0 0 30px rgba(168, 85, 247, 0.2);
        }
        .search-glow-border input {
            width: 100%;
            padding: 16px 20px 16px 55px;
            font-size: 16px;
            border: none;
            border-radius: 47px;
            background: #ffffff;
            outline: none;
            color: #334155;
            font-weight: 600;
        }
        .search-glow-border input::placeholder { color: #94a3b8; font-weight: 500; }
    </style>
    <div class="search-glow-border">
        <input type="text" id="mainCategorySearch"
       placeholder="ì˜¤ëŠ˜ì€ ì–´ë–¤ ì œí’ˆì„ ì°¾ìœ¼ì‹œë‚˜ìš”?"
       data-i18n-placeholder="search_placeholder"
       onkeyup="window.filterMainIcons(this.value)"
        >
        <i class="fa-solid fa-magnifying-glass" style="
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: #6366f1;
            font-size: 20px;
            pointer-events: none;
        "></i>
    </div>
</div>

    
    <div class="quick-menu-track" id="quickMenuContainer"></div>
    <div style="text-align: center; margin-top: 30px; padding-bottom: 30px; background: #fff; border-radius: 16px; padding: 30px; border: 1px solid #e2e8f0; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);">
        <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 20px;" data-i18n="home_vip_title">ëŒ€ëŸ‰ì£¼ë¬¸ ì „ìš© VIP ë¼ìš´ì§€</h3>
        <p style="margin: 0 0 20px 0; color: #64748b; font-size: 15px;" data-i18n="home_vip_desc">
            íŒì—…ìŠ¤í† ì–´ë‚˜ ì „ì‹œì¥ ê¾¸ë¯¸ê¸° ê°™ì´ ëŒ€ëŸ‰ì´ê±°ë‚˜ ë³µì¡í•œ ì£¼ë¬¸ì¸ê°€ìš”? ê³¨ë“œ ë“±ê¸‰ì´ìƒì˜ VIPê³ ê°ì´ì‹ ê°€ìš”?<br>
            íŒŒì¼ë§Œ ì˜¬ë ¤ì£¼ì‹œë©´ <strong>ì „ë‹´ ë§¤ë‹ˆì €</strong>ê°€ ë¶„ì„ í›„ ê²¬ì ì„œì™€ í•¨ê»˜ 30ë¶„ ì´ë‚´ì— ì—°ë½ë“œë¦½ë‹ˆë‹¤.<br>
            ë§¤ë‹ˆì €ì˜ ê°€ì´ë“œì— ë”°ë¼ ê²°ì œë§Œ í•˜ì‹œë©´ ë””ìì¸/íŒŒì¼ë³€í™˜/ì ‘ìˆ˜/ë°°ì†¡/ì„¤ì¹˜ê¹Œì§€ ë…¼ìŠ¤í†±ìœ¼ë¡œ ë„ì™€ë“œë¦½ë‹ˆë‹¤.
        </p>
        
        <button onclick="document.getElementById('vipOrderModal').style.display='flex'" class="btn-round" style="background: linear-gradient(135deg, #1e1b4b 0%, #4338ca 100%); color: white; padding: 15px 40px; font-size: 18px; font-weight: 800; border: none; box-shadow: 0 10px 20px rgba(67, 56, 202, 0.3); width: auto; display: inline-flex; gap: 10px; align-items: center; margin-bottom: 25px;">
            <i class="fa-solid fa-crown" style="color: #fbbf24;"></i> <span data-i18n="home_btn_vip_upload">VIP ì£¼ë¬¸ íŒŒì¼ ì—…ë¡œë“œ (ì›ìŠ¤í†± ì ‘ìˆ˜)</span>
        </button>

        <div style="border-top: 2px dashed #e2e8f0; padding-top: 25px; margin-top: 10px;">
    <div style="display: inline-block; background: #eff6ff; color: #4f46e5; padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: 800; margin-bottom: 15px;" data-i18n="vip_fast_inquiry">
        âš¡ ì‰½ê³  ë¹ ë¥¸ ë¬¸ì˜
    </div>
    <p style="margin: 0 0 20px 0; color: #334155; font-size: 16px; font-weight: 600;" data-i18n="vip_manager_intro">
        "ì¹œì ˆí•œ ë§¤ë‹ˆì €ê°€ ì „í™”ë¡œ ë¹ ë¥´ê²Œ ì‘ëŒ€í•©ë‹ˆë‹¤"
    </p>
    
    <div style="display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
    <div style="display: flex; flex-direction: column; align-items: center; min-width: 140px;">
        <span style="background: #f1f5f9; color: #475569; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 800; margin-bottom: 5px; border: 1px solid #e2e8f0;" data-i18n="vip_manager_1_name">ğŸ‘©â€ğŸ’¼ ì§€ìˆ™ ë§¤ë‹ˆì €</span>
        <a href="tel:010-3455-1946" class="mgr-phone" style="text-decoration: none; color: #4338ca; font-size: 22px; font-weight: 900; letter-spacing: -0.5px;" data-i18n="vip_manager_1_phone">010-3455-1946</a>
    </div>

    <div style="display: flex; flex-direction: column; align-items: center; min-width: 140px;">
        <span style="background: #f1f5f9; color: #475569; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 800; margin-bottom: 5px; border: 1px solid #e2e8f0;" data-i18n="vip_manager_2_name">ğŸ‘©â€ğŸ’¼ ì€ë¯¸ ë§¤ë‹ˆì €</span>
        <a href="tel:010-7793-5393" class="mgr-phone" style="text-decoration: none; color: #4338ca; font-size: 22px; font-weight: 900; letter-spacing: -0.5px;" data-i18n="vip_manager_2_phone">010-7793-5393</a>
    </div>

    <div style="display: flex; flex-direction: column; align-items: center; min-width: 140px;">
        <span style="background: #f1f5f9; color: #475569; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 800; margin-bottom: 5px; border: 1px solid #e2e8f0;" data-i18n="vip_manager_3_name">ğŸ‘©â€ğŸ’¼ ì„±í¬ ë§¤ë‹ˆì €</span>
        <a href="tel:010-3490-3328" class="mgr-phone" style="text-decoration: none; color: #4338ca; font-size: 22px; font-weight: 900; letter-spacing: -0.5px;" data-i18n="vip_manager_3_phone">010-3490-3328</a>
    </div>
</div>

<p style="margin: 0; font-size: 14px; color: #64748b;" data-i18n="vip_inquiry_time">
    <i class="fa-regular fa-clock"></i> ë¬¸ì˜ì‹œê°„ : ì˜¤ì „ 9ì‹œ ~ ì˜¤í›„ 6ì‹œ
</p>
</div>
        </div>
</div>

<!-- ì˜¤ëŠ˜ì˜í•«ë”œ -->
<div id="hotDealSection" class="hotdeal-wrapper" style="display:none;">
    <div class="hotdeal-header">
        <h2>ğŸ”¥ <span data-i18n="home_hotdeal_title">ì˜¤ëŠ˜ì˜ í•«ë”œ</span> <span class="badge-hot">Time Sale</span></h2>
        <p data-i18n="home_hotdeal_desc">ì§€ê¸ˆ ë†“ì¹˜ë©´ í›„íšŒí•˜ëŠ” ì´ˆíŠ¹ê°€ ìƒí’ˆì„ ë§Œë‚˜ë³´ì„¸ìš”. ì¹œêµ¬ì—ê²Œ ì„ ë¬¼í•˜ì„¸ìš”. ì§‘ë“¤ì´ ì„ ë¬¼ í•«ë”œìƒí’ˆì€ ìµœëŒ€ 10ê°œê¹Œì§€ ì£¼ë¬¸ê°€ëŠ¥</p>
    </div>
    <div id="hotDealGrid" class="hotdeal-grid">
        </div>
</div>

<div id="bizDealSection" class="hotdeal-wrapper" style="display:none; margin-top:0px; background: #f8fafc; padding: 20px; border-radius: 12px;">
    <div class="hotdeal-header">
        <h2 style="color: #4f46e5;">ğŸ’¼ <span data-i18n="home_biz_title">ì—…ììš© ëŒ€ë°•í• ì¸</span> <span class="badge-hot" style="background:#4f46e5;">B2B Only</span></h2>
        <p data-i18n="home_biz_desc">ì‚¬ì—…ì ê³ ê°ë‹˜ì„ ìœ„í•œ ì „ìš© íŠ¹ê°€! ìµœì†Œì£¼ë¬¸ìˆ˜ëŸ‰ 10~100ê°œ ë¦¬ì…€ëŸ¬ íŒë§¤ìì—ê²Œ ë“œë¦¬ëŠ” ì—…ìí• ì¸</p>
    </div>
    <div id="bizDealGrid" class="hotdeal-grid">
        </div>
</div>


    <!-- ê²Œì‹œíŒ -->
<div class="community-nav-wrapper">
    <div class="comm-grid">
        <a href="#" onclick="goBoard('blog'); return false;" class="comm-btn blog">
            <div class="comm-icon"><i class="fa-solid fa-pen-nib"></i></div>
            <span data-i18n="menu_blog">ì¹´ë©œë ˆì˜¨<br>ë¸”ë¡œê·¸</span>
        </a>
        <a href="#" onclick="goBoard('review'); return false;" class="comm-btn">
            <div class="comm-icon"><i class="fa-solid fa-star"></i></div>
            <span data-i18n="menu_review">ê³ ê°<br>ì œì‘í›„ê¸°</span>
        </a>
        <a href="#" onclick="goBoard('promo'); return false;" class="comm-btn">
            <div class="comm-icon"><i class="fa-solid fa-bullhorn"></i></div>
            <span data-i18n="menu_promo">ì§€ì—­ê´‘ê³ ì‚¬<br>í™ë³´</span>
        </a>
        <a href="#" onclick="goBoard('trade'); return false;" class="comm-btn">
            <div class="comm-icon"><i class="fa-solid fa-handshake"></i></div>
            <span data-i18n="menu_trade">ì¤‘ê³ ì¥ë¹„<br>ê±°ë˜</span>
        </a>
        <a href="#" onclick="goBoard('job'); return false;" class="comm-btn">
            <div class="comm-icon"><i class="fa-solid fa-briefcase"></i></div>
            <span data-i18n="menu_job">êµ¬ì¸êµ¬ì§</span>
        </a>
        <a href="#" onclick="goBoard('free'); return false;" class="comm-btn">
            <div class="comm-icon"><i class="fa-solid fa-comments"></i></div>
            <span data-i18n="menu_manual">ì œí’ˆì„¤ëª…ì„œ</span>
        </a>
    </div>
</div>

<div class="gallery-section">
    <style>
    .tier-section-wrap {
        text-align: center;
        margin: 40px auto 60px auto;
        max-width: 1000px;
        padding: 0 20px;
    }
    .tier-title-main {
        font-size: 24px;
        font-weight: 800;
        color: #1e293b;
        margin-bottom: 30px;
    }
    .tier-title-main span {
        color: #6366f1;
    }
    
    .tier-container {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap; /* ëª¨ë°”ì¼ì—ì„œ ìë™ ì¤„ë°”ê¿ˆ */
    }

    .tier-card {
        flex: 1;
        min-width: 280px; /* ì¹´ë“œ ìµœì†Œ ë„ˆë¹„ */
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        padding: 30px 20px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        overflow: hidden;
    }

    .tier-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    /* ì¹´ë“œ ìƒë‹¨ ìƒ‰ìƒë  */
    .tier-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 6px;
    }
    .tier-card.gold::before { background: #eab308; }
    .tier-card.platinum::before { background: #64748b; }
    .tier-card.franchise::before { background: #6366f1; }

    .tier-icon {
        width: 60px; height: 60px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 24px;
        margin-bottom: 15px;
    }
    .tier-card.gold .tier-icon { background: #fef9c3; color: #ca8a04; }
    .tier-card.platinum .tier-icon { background: #f1f5f9; color: #475569; }
    .tier-card.franchise .tier-icon { background: #e0e7ff; color: #4f46e5; }

    .tier-name {
        font-size: 18px;
        font-weight: 800;
        margin-bottom: 5px;
        color: #334155;
    }

    .tier-discount {
        font-size: 32px;
        font-weight: 900;
        margin-bottom: 20px;
    }
    .tier-card.gold .tier-discount { color: #ca8a04; }
    .tier-card.platinum .tier-discount { color: #475569; }
    .tier-card.franchise .tier-discount { color: #4f46e5; }

    .tier-desc {
        font-size: 14px;
        color: #64748b;
        line-height: 1.6;
        border-top: 1px solid #f1f5f9;
        padding-top: 15px;
        width: 100%;
    }
    .tier-desc strong { color: #334155; }
    
    .tier-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
        background: #f1f5f9;
        color: #64748b;
        margin-bottom: 5px;
    }
</style>

<div class="tier-section-wrap">
    <h2 class="tier-title-main" data-i18n="tier_main_title">ë©¤ë²„ì‹­ ë“±ê¸‰ë³„ <span>í• ì¸ í˜œíƒ</span> ì•ˆë‚´</h2>
    
    <div class="tier-container">
        <div class="tier-card gold">
            <div class="tier-icon"><i class="fa-solid fa-medal"></i></div>
            <div class="tier-name" data-i18n="tier_gold_name">ê³¨ë“œ (GOLD)</div>
            <div class="tier-discount" data-i18n="tier_gold_discount" style="color:#ca8a04;">3% í• ì¸</div>
            <div class="tier-desc">
                <span class="tier-badge" data-i18n="tier_cond_1">ì¡°ê±´ 1</span> <span data-i18n="tier_gold_cond_1">ëˆ„ì  êµ¬ë§¤ <strong>500ë§Œì›</strong> ì´ìƒ</span><br>
                <div style="margin: 5px 0; font-size:12px; color:#94a3b8;">OR</div>
                <span class="tier-badge" data-i18n="tier_cond_2">ì¡°ê±´ 2</span> <span data-i18n="tier_gold_cond_2">ë¡œê³  <strong>10ê°œ</strong> ê³µìœ </span>
            </div>
        </div>

        <div class="tier-card platinum">
            <div class="tier-icon"><i class="fa-solid fa-crown"></i></div>
            <div class="tier-name" data-i18n="tier_plat_name">í”Œë ˆí‹°ë„˜ (PLATINUM)</div>
            <div class="tier-discount" data-i18n="tier_plat_discount" style="color:#475569;">5% í• ì¸</div>
            <div class="tier-desc">
                <span class="tier-badge" data-i18n="tier_cond_1">ì¡°ê±´ 1</span> <span data-i18n="tier_plat_cond_1">ëˆ„ì  êµ¬ë§¤ <strong>1,000ë§Œì›</strong> ì´ìƒ</span><br>
                <div style="margin: 5px 0; font-size:12px; color:#94a3b8;">OR</div>
                <span class="tier-badge" data-i18n="tier_cond_2">ì¡°ê±´ 2</span> <span data-i18n="tier_plat_cond_2">ë¡œê³  <strong>100ê°œ</strong> ê³µìœ </span>
            </div>
        </div>

        <div class="tier-card franchise">
            <div class="tier-icon"><i class="fa-solid fa-store"></i></div>
            <div class="tier-name" data-i18n="tier_partner_name">ê°€ë§¹ì  (PARTNER)</div>
            <div class="tier-discount" data-i18n="tier_partner_discount" style="color:#4f46e5;">10% í• ì¸</div>
            <div class="tier-desc">
                <span class="tier-badge" style="background:#e0e7ff; color:#4338ca;" data-i18n="tier_partner_cond_label">ê°€ì…ì¡°ê±´</span><br>
                <span data-i18n="tier_partner_cond_fee">íŒŒíŠ¸ë„ˆìŠ¤ ì‹ ì²­ì</span><br>
                <span style="font-size:12px; color:#888;" data-i18n="tier_partner_cond_note">(ì‚¬ì—…ìë“±ë¡ì¦ í•„ìˆ˜)</span>
            </div>
        </div>
    </div>
</div>

<div class="partner-recruit-banner" style="max-width:1000px; margin: 30px auto; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 16px; padding: 40px; color: white; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15);">
    
    <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(99, 102, 241, 0.2); border-radius: 50%;"></div>
    
    <div style="position: relative; z-index: 2; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
        <div style="flex: 1; min-width: 300px;">
            <span style="background: #6366f1; color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 800; margin-bottom: 10px; display: inline-block;">PARTNER CENTER</span>
            <h2 style="margin: 0 0 10px 0; font-size: 28px; font-weight: 800;" data-i18n="partner_banner_title">ì—…ìë“¤ì„ ìœ„í•œ ìˆ˜ìˆ˜ë£Œ ì €ë ´í•œ ì¿ íŒ¡<br><span style="color: #818cf8;">ë§ˆì§„ì´ ë†’ì€ í•´ì™¸íŒë§¤, ì¹´ë©œë ˆì˜¨ì—ê²Œ ë§¡ê¸°ì„¸ìš”!</span></h2>
            <p style="margin: 0; color: #94a3b8; font-size: 15px; line-height: 1.6;" data-i18n="partner_banner_desc">
                ë°°ì†¡ë¶€í„° ì„œë¥˜ê¹Œì§€ ì¹´ë©œë ˆì˜¨ì— ë“±ë¡ë§Œ í•˜ë©´ ì˜¤ì¼€ì´!<br>ê´‘ê³ ê³„ì˜ ë„ë§¤ê¾¹ìœ¼ë¡œ í‹°ì…”ì¸ ì¸ì‡„Â·êµ¿ì¦ˆì œì‘Â·íŒì´‰ë¬¼Â·ê¸°íƒ€ ê³µì‚°í’ˆì´ë‚˜ ì„ ë¬¼ì„ ë“±ë¡í•˜ì„¸ìš”.<br><b style="color:#818cf8;">6.5% ì—…ê³„ ìµœì € ìˆ˜ìˆ˜ë£Œ</b>ì™€ ì „êµ­ 1ìœ„ ê´‘ê³ ì¸ì‡„ ì¶œë ¥ì—…ì²´ì˜ ëª¨ë“  ê³ ê°ë“¤,<br>ê·¸ë¦¬ê³  <b style="color:#818cf8;">2ë°° ê°€ê²©ìœ¼ë¡œ í•´ì™¸ ì‹œì¥ ê³µëµ</b>ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì§€ê¸ˆ ìµœìƒë‹¨ ìœ„ì¹˜ë¥¼ ì„ ì í•˜ì„¸ìš”!
            </p>
        </div>
        
        <div style="text-align: right;">
    <button id="btnPartnerConsole" onclick="location.href='partner.html'" class="btn-round" style="display: none; background: #fff; color: #0f172a; font-weight: 800; padding: 15px 30px; border: none; font-size: 16px; box-shadow: 0 4px 15px rgba(255,255,255,0.2);">
        <i class="fa-solid fa-store"></i> <span data-i18n="btn_partner_console">íŒŒíŠ¸ë„ˆìŠ¤ ì„¼í„° ì…ì¥</span>
    </button>
    
    <button id="btnPartnerApply" onclick="document.getElementById('partnerApplyModal').style.display='flex'" class="btn-round" style="background: transparent; border: 2px solid #6366f1; color: #fff; font-weight: 800; padding: 12px 25px;">
        <span data-i18n="btn_partner_apply">ê°€ë§¹ì  ì‹ ì²­í•˜ê¸°</span>
    </button>
</div>
    </div>
</div>
<!-- ê¸°ì—¬ìì‹œìŠ¤í…œ -->
<div class="contributor-section">
    <div class="contributor-header">
        <div class="contributor-title">
            <i class="fa-solid fa-gem" style="color:#6366f1;"></i> <span data-i18n="contrib_title">ì¹´ë©œë ˆì˜¨ ê¸°ì—¬ì ì‹œìŠ¤í…œ</span>
            <span class="contributor-badge" id="myTierBadge">Loading...</span>
        </div>
        <div class="contributor-balance-box">
            <span style="font-size:12px; color:#64748b;" data-i18n="contrib_balance_label">ë‚´ ëˆ„ì  ìˆ˜ìµê¸ˆ</span>
            <div class="live-money" id="contributorBalance">0</div>
        </div>
    </div>

    <div class="contributor-desc" data-i18n="contrib_desc">
        ë‚´ê°€ ë§Œë“  ë””ìì¸ ì†ŒìŠ¤ë¥¼ ê³µìœ í•˜ê³  í˜„ê¸ˆì„ ì ë¦½ë°›ìœ¼ì„¸ìš”. <br>ì €í’ˆì§ˆ ì´ë¯¸ì§€ë¥¼ ë°˜ë³µí•´ì„œ ì˜¬ë¦¬ë©´ ë“±ê¸‰ì´ í•˜ë½í•©ë‹ˆë‹¤.ë“±ê¸‰ ìƒìŠ¹ 2ë°° 4ë°°, í•˜ë½ ì‹œ ì ˆë°˜ ë¹„ìš©ì´ ì§€ê¸‰ë©ë‹ˆë‹¤.<br><span style='color:#ef4444; font-weight:bold;'>ì¹´í…Œê³ ë¦¬ í™•ì¸!</span> ê°ì²´ ë¡œê³  ë“± ì¹´í…Œê³ ë¦¬ë¥¼ ë§ì¶”ì§€ ì•Šê±°ë‚˜ í‚¤ì›Œë“œë¥¼ 3ê°œ ì´í•˜ ë“±ë¡ ì‹œ ë“±ë¡ ê¶Œí•œì´ ì‚­ì œë©ë‹ˆë‹¤.
    </div>

    <div class="contributor-grid">
        <button class="contrib-btn" onclick="window.handleContributorUpload('png')">
            <div class="c-icon-box bg-blue"><i class="fa-solid fa-image"></i></div>
            <div class="c-info">
                <span class="c-name" data-i18n="contrib_btn_png">PNG ê°ì²´</span>
                <span class="c-reward">150 <span class="tier-bonus"></span></span>
            </div>
        </button>

        <button class="contrib-btn" onclick="window.handleContributorUpload('svg')">
            <div class="c-icon-box bg-purple"><i class="fa-solid fa-bezier-curve"></i></div>
            <div class="c-info">
                <span class="c-name" data-i18n="contrib_btn_svg">SVG ê°ì²´</span>
                <span class="c-reward">150 <span class="tier-bonus"></span></span>
            </div>
        </button>

        <button class="contrib-btn" onclick="window.handleContributorUpload('logo')">
            <div class="c-icon-box bg-orange"><i class="fa-solid fa-icons"></i></div>
            <div class="c-info">
                <span class="c-name" data-i18n="contrib_btn_logo">ë¡œê³  ì—…ë¡œë“œ</span>
                <span class="c-reward">150 <span class="tier-bonus"></span></span>
            </div>
        </button>

        <button class="contrib-btn" onclick="window.openTemplateCreator()">
            <div class="c-icon-box bg-green"><i class="fa-solid fa-palette"></i></div>
            <div class="c-info">
                <span class="c-name" data-i18n="contrib_btn_template">í…œí”Œë¦¿ ë§Œë“¤ê¸°</span>
                <span class="c-reward">150 <span class="tier-bonus"></span></span>
            </div>
        </button>
    </div>

    <input type="file" id="contributorFileInput" style="display:none;" multiple>
</div>
<!-- íŒŒíŠ¸ë„ˆ ì½˜ì†” ëª¨ë‹¬ ì œê±°ë¨ â€” partner.htmlë¡œ ì´ë™ -->

<div id="myOrderModal" class="modal-bg" style="z-index: 16000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 800px; max-width: 95%; max-height: 85vh; display: flex; flex-direction: column; padding: 0; background: #f8fafc; overflow: hidden;">
        
        <div style="background: #fff; padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: #1e293b;" data-i18n="my_order_tracking_title">ğŸ“¦ ë‚˜ì˜ ì£¼ë¬¸ ë°°ì†¡ ì¡°íšŒ</h3>
            <button onclick="document.getElementById('myOrderModal').style.display='none'" class="btn-round" style="width: auto; padding: 5px 15px;" data-i18n="btn_close">ë‹«ê¸°</button>
        </div>

        <div style="flex: 1; padding: 20px; overflow-y: auto;">
            <div id="myOrderListUser" style="display: flex; flex-direction: column; gap: 15px;">
                </div>
        </div>
    </div>
</div>
    
    <div class="hero-search-wrap">
    <div style="display:none; opacity:0;">
        <input type="text" name="fake_username_prevention" autocomplete="username">
        <input type="password" name="fake_password_prevention" autocomplete="current-password">
    </div>

    <input type="search" 
           id="startSearchInput" 
           name="q_search_query_final_v2" 
           class="hero-search-input" 
           data-i18n-placeholder="search_placeholder_start"
           placeholder="" 
           autocomplete="off" 
           readonly 
           onfocus="this.removeAttribute('readonly');"
    >
    <button id="btnStartSearch" class="hero-search-btn">
        <i class="fa-solid fa-magnifying-glass"></i> <span data-i18n="btn_search">Search</span>
    </button>
</div> 
<div class="pagination-wrapper" style="display:flex; justify-content:center; align-items:center; gap:20px; margin:20px 0 40px 0;">
    <button id="btnTplPrev" class="btn-round" onclick="changeTemplatePage(-1)" style="width:100px; justify-content:center;" disabled>
        <i class="fa-solid fa-chevron-left"></i> <span data-i18n="btn_prev">ì´ì „</span>
    </button>
    
    <span id="tplPageLabel" style="font-weight:bold; color:#334155; font-size:16px;">
    <span data-i18n="label_page_prefix">Page</span> <span id="currentPageNum">1</span>
</span>
    
    <button id="btnTplNext" class="btn-round" onclick="changeTemplatePage(1)" style="width:100px; justify-content:center;">
        <span data-i18n="btn_next">ë‹¤ìŒ</span> <i class="fa-solid fa-chevron-right"></i>
    </button>
</div>
<div class="community-nav-wrapper">


<script>
    // ê²Œì‹œíŒ ì´ë™ í•¨ìˆ˜ (ë„ë©”ì¸ ë° ì–¸ì–´ ìë™ ê°ì§€ ì ìš©)
    function goBoard(category) {
        // 1. í˜„ì¬ ë„ë©”ì¸ í™•ì¸
        const hostname = window.location.hostname;
        let targetCountry = 'KR'; // ê¸°ë³¸ê°’

        // 2. ë„ë©”ì¸ì— ë”°ë¼ êµ­ê°€ ì½”ë“œ ê²°ì • (board.htmlì€ KR, US, JP ëŒ€ë¬¸ì ì‚¬ìš©)
        if (hostname.includes('cafe3355.com')) {
            targetCountry = 'US';
        } else if (hostname.includes('cafe0101.com')) {
            targetCountry = 'JP';
        }

        // 3. ì£¼ì†Œì°½ íŒŒë¼ë¯¸í„°(?lang=)ê°€ ìˆë‹¤ë©´ ìµœìš°ì„  ì ìš© (í…ŒìŠ¤íŠ¸ìš©)
        const urlParams = new URLSearchParams(window.location.search);
        const paramLang = urlParams.get('lang');
        if (paramLang) {
            if (paramLang.toLowerCase() === 'en' || paramLang.toLowerCase() === 'us') targetCountry = 'US';
            if (paramLang.toLowerCase() === 'ja' || paramLang.toLowerCase() === 'jp') targetCountry = 'JP';
        }

        // 4. í•´ë‹¹ ì–¸ì–´ ì½”ë“œë¥¼ ë‹¬ê³  ê²Œì‹œíŒ ìƒˆ ì°½ ì—´ê¸°
        window.open(`/board.html?cat=${category}&country=${targetCountry}`, '_blank');
    }
</script>
    

    <div id="startTemplateGrid" class="template-grid-start"></div>
    
    <div class="review-section">
    <div class="review-header">
    <h2 data-i18n="review_section_title">âœ¨ ê³ ê°ë‹˜ë“¤ì˜ ìƒìƒí•œ í›„ê¸°</h2>
    <p data-i18n="review_section_desc">ì¹´ë©œë ˆì˜¨ìœ¼ë¡œ ì™„ì„±ëœ ë©‹ì§„ ê²°ê³¼ë¬¼ë“¤ì„ í™•ì¸í•´ë³´ì„¸ìš”.</p>
</div>

    <div class="marquee-wrapper">
        <div class="marquee-track">
    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000000048/image/detail/1000000048_detail_065.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div>
            <p class="review-text" data-i18n="rev_1_text">"í–‰ì‚¬ë•Œë§ˆë‹¤ ì´ìš©í•©ë‹ˆë‹¤. ê¸°íšì‚¬í•œí…ŒëŠ” ì—¬ê¸°ë§Œí•œ ê³³ì´ ì—†ì–´ìš”. í—ˆë‹ˆì½¤ë³´ë“œ ì§„ì§œ ì €ë ´í•˜ê³  ë¹ ë¥´ê³  ì‚¬ì¥ë‹˜ ìµœê³ ì…ë‹ˆë‹¤."</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_1_user">ì œì¼ê¸°íš ìš°*ì§„ ë¶€ì¥</span>
                <span class="u-date" data-i18n="rev_1_date">2024.03.15</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000000049/image/detail/1000000049_detail_023.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div>
            <p class="review-text" data-i18n="rev_2_text">"í–‰ì‚¬ë•Œ ë­”ê°€ í¬ì¸íŠ¸ë¥¼ ì£¼ê³ ì‹¶ì—ˆëŠ”ë° ë„ˆë¬´ ì¢‹ì•˜ì–´ìš”. ê²½ê¸°ë„ì—ì„œ 1ê°œ ì‹œì¼°ëŠ”ë°ë„ ë¬´ë£Œë°°ì†¡ ë„ˆë¬´ ì¹œì ˆí•œ ê¸°ì‚¬ë‹˜ê¹Œì§€ ìµœê³ ì˜ˆìš”!"</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_2_user">ì´ë²¤íŠ¸ê¸°íš ê¹€*ìˆ˜</span>
                <span class="u-date" data-i18n="rev_2_date">2024.03.12</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000004101/image/main/1000004101_main_028.png');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div>
            <p class="review-text" data-i18n="rev_3_text">"í‚¤ë§ ì œì‘ ì§„ì§œ ë„ˆë¬´ í€„ë¦¬í‹° ë†’ì€ê±° ì•„ë‹Œê°€ìš”? ë„ë§¤êµ¬ë§¤ ë„ˆë¬´ ì €ë ´í•´ì„œ ì €í¬ê°™ì€ íŒë§¤ìì—ê²ŒëŠ” ìµœê³ ì…ë‹ˆë‹¤."</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_3_user">ë„ì¹˜ë§˜**</span>
                <span class="u-date" data-i18n="rev_3_date">2024.03.10</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000000428/image/detail/1000000428_detail_094.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star-half-stroke"></i></div>
            <p class="review-text" data-i18n="rev_4_text">"ì‰¬í°ì¸ì‡„ í€„ë¦¬í‹° ë¯¸ì³¤ìŠµë‹ˆë‹¤. ì—¬ê¸´ ë‹¬ë¼ìš”. UVë¡œ ë§Œë“œëŠ” ìƒ‰ë¹ ì§€ëŠ” ê·¸ëŸ°ê±° ì•„ë‹ˆê³  ì° ì˜ë¥˜ì¸ì‡„ì— ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì´ë¼ëŠ”ë° ìƒ‰ê° í€„ë¦¬í‹° ë¹¨ì•„ë„ ë¬¼ ì•ˆë¹ ì§€ê³  ìµœê³ ì…ë‹ˆë‹¤. ê°•ì¶”!!!"</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_4_user">í•¸ë“œë©”ì´ë“œìƒµ</span>
                <span class="u-date" data-i18n="rev_4_date">2024.03.08</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000000113/image/main/1000000113_main_082.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div>
            <p class="review-text" data-i18n="rev_5_text">"í–‰ì‚¬ë•Œë§ˆë‹¤ ì˜ ì´ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. í—ˆë‹ˆì½¤ë³´ë“œëŠ” ì§„ì§œ êµ­ë‚´ 1ìœ„ë¼ëŠ”ê²Œ í—›ë§ì´ ì•„ë‹Œê³³. ì´ì œ ì—ë””í„°ê¹Œì§€ ìˆì–´ì„œ ë„ˆë¬´ í¸í•˜ê³  ì¢‹ìŠµë‹ˆë‹¤."</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_5_user">ì‹ í™”ê¸°íš ìµœë³´ëŒ</span>
                <span class="u-date" data-i18n="rev_5_date">2025.12.15</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000004088/image/detail/1000004088_detail_057.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div>
            <p class="review-text" data-i18n="rev_6_text">"ì¢…ì´ë¡œ ë§Œë“  ì›í„°ì¹˜ ë§¤ëŒ€, ì¨ë³´ë‹ˆ ì§„ì§œ íŠ¼íŠ¼í•´ìš” ì¢…ì´ê°™ì§€ ì•Šì•„ìš”. í™©ì„œì—° ë§¤ë‹ˆì €ë¼ëŠ”ë¶„ì´ ì˜¤ì…”ì„œ ì„¤ì¹˜ ì•Œë ¤ì£¼ì…¨ëŠ”ë° ë„ˆë¬´ ì¹œì ˆí•˜ì‹­ë‹ˆë‹¤."</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_6_user">ëª°íƒ€ê¸°íš</span>
                <span class="u-date" data-i18n="rev_6_date">2024.03.12</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000003080/image/detail/1000003080_detail_042.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div>
            <p class="review-text" data-i18n="rev_7_text">"ë¯¸ë¦¬ìº”ë²„ìŠ¤ ìº”ë°” ì„±ì›ì• ë“œí”¼ì•„ ë‹¤ ì¨ë´¤ëŠ”ë° ê°€ê²©ê³¼ í€„ë¦¬í‹°ëŠ” ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ…ì´ ì§„ì§œ ê°€ì„±ë¹„ ìµœê³ ì…ë‹ˆë‹¤."</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_7_user">ì—¡ì† ê¹€ì§€ìˆ˜</span>
                <span class="u-date" data-i18n="rev_7_date">2024.03.10</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000000051/image/detail/1000000051_detail_040.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star-half-stroke"></i></div>
            <p class="review-text" data-i18n="rev_8_text">"í—ˆë‹ˆì½¤ë³´ë“œ ì¢…ì´ê°€ ì´ë ‡ê²Œê¹Œì§€ íŠ¼íŠ¼í•˜ê³  ì˜ˆì˜ë‹¤ë‹ˆ ì¢‹ìŠµë‹ˆë‹¤. ì§„ì§œ ë§˜ì— ë“¤ì–´ìš”. ê¸°íší• ë•Œ ê¼­ ë„£ì–´ì•¼í•˜ëŠ” í¬ì¸íŠ¸"</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_8_user">ì—ë“œíŒì‚¬ì¸ê¸°íš</span>
                <span class="u-date" data-i18n="rev_8_date">2024.03.08</span>
            </div>
        </div>
    </div>

    <div class="review-card">
        <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000003340/image/detail/1000000050_detail_061.jpg');"></div>
        <div class="review-content">
            <div class="review-stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div>
            <p class="review-text" data-i18n="rev_9_text">"ì¼ë°˜ë°°ë„ˆì™€ëŠ” ëŠë‚Œì´ ë‹¬ë¼ìš”. ê³ ê¸‰ìŠ¤ëŸ½ê³  ë…íŠ¹í•˜ê³  ë²„ë¦¬ê¸°ë„ í¸í•´ì„œ ì¢‹ì•„ìš”."</p>
            <div class="review-user">
                <span class="u-name" data-i18n="rev_9_user">ìµœí¬ìˆ˜</span>
                <span class="u-date" data-i18n="rev_9_date">2025.12.15</span>
            </div>
        </div>
    </div>
</div>
            
            

    </div>
</div>
</div>

    <div class="footer-wrap">
    <div class="footer-inner">
        <div class="foot-left">
            <div class="foot-menu">
                <ul>
                    <li><a href="#" data-i18n="footer_menu_company">íšŒì‚¬ì†Œê°œ</a></li>
                    <li><a href="#" data-i18n="footer_menu_notice">ê³µì§€ì‚¬í•­</a></li>
                    <li><a href="#" data-i18n="footer_menu_terms">ì´ìš©ì•½ê´€</a></li>
                    <li><a href="#"><strong data-i18n="footer_menu_privacy">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</strong></a></li>
                </ul>
            </div>
            <div class="foot-info">
                <dl>
                    <dt data-i18n="footer_company_label">ìƒí˜¸ëª… :</dt>
                    <dd data-i18n="footer_company_value">(ì£¼)ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ…</dd>
                    
                    <dt data-i18n="footer_ceo_label">ëŒ€í‘œ :</dt>
                    <dd data-i18n="footer_ceo_value">ì¡°ì¬í˜¸</dd>
                </dl>
                <dl>
                    <dt data-i18n="footer_addr_label">ì£¼ì†Œ :</dt>
                    <dd data-i18n="footer_addr_value">ê²½ê¸°ë„ í™”ì„±ì‹œ ìš°ì •ì í•œë§ê¸¸ 72-2</dd>
                </dl>
                <dl>
                    <dt data-i18n="footer_biz_num_label">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ :</dt>
                    <dd>470-81-02808</dd>
                    
                    <dt data-i18n="footer_mail_order_label">í†µì‹ íŒë§¤ì—…ì‹ ê³ ë²ˆí˜¸ :</dt>
                    <dd>2025-í™”ì„±ìš°ì •-0033</dd>
                </dl>
                <dl>
                    <dt data-i18n="footer_privacy_manager_label">ê°œì¸ì •ë³´ê´€ë¦¬ì :</dt>
                    <dd>Haruto</dd>
                </dl>
                <p class="copyright">Copyright Â© <strong>Chameleon Canvas</strong>. all rights reserved.</p>
            </div>
        </div>

        <div class="cs-center">
            <h3 data-i18n="footer_cs_title">ê³ ê°ì„¼í„° (CS CENTER)</h3>
            <strong>Channel Talk</strong>
            <p>
                <span data-i18n="footer_cs_time">í‰ì¼ 09:00 ~ 18:00</span> <br>
                <span data-i18n="footer_cs_lunch">ì ì‹¬ 12:00 ~ 13:00</span> <br>
                <span data-i18n="footer_cs_closed">* ì£¼ë§ ë° ê³µíœ´ì¼ íœ´ë¬´</span>
            </p>
        </div>
    </div>
</div>
    </div>
</div>



<div id="mainEditor" style="display:none;">
    

    <div id="wallHeightControls">
        <div class="wall-label"><i class="fa-solid fa-ruler-vertical"></i> <span data-i18n="wall_option_title">ê°€ë²½ ë†’ì´</span></div>
        <button class="height-btn active" onclick="window.setWallHeight(2200, this)">220cm</button>
        <button class="height-btn" onclick="window.setWallHeight(2400, this)">240cm</button>
        <button class="height-btn" onclick="window.setWallHeight(3000, this)">300cm</button>
    </div>

    <div class="editor-wrap">
        
        <div class="side" id="toolsPanel" style="text-align: center; padding: 10px 12px;">
            
            <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:10px; margin-bottom:10px;">
                <div style="font-size:11px; font-weight:700; color:#64748b; margin-bottom:5px; display:flex; justify-content:space-between;">
                    <span data-i18n="tool_size_change">ğŸ“ ì‚¬ì´ì¦ˆ ë³€ê²½(mm)</span>
                    <span id="limitLabel" style="color:#6366f1;">Max: -</span>
                </div>
                <div style="display:flex; gap:5px; align-items:center;">
                    <input type="number" id="inputUserW" class="ai-input-pretty" placeholder="W" style="margin:0; padding:5px; font-size:12px; text-align:center;">
                    <span style="color:#999;">x</span>
                    <input type="number" id="inputUserH" class="ai-input-pretty" placeholder="H" style="margin:0; padding:5px; font-size:12px; text-align:center;">
                </div>
                <button id="btnApplyUserSize" class="btn-round primary" style="width:100%; margin-top:6px; height:32px; font-size:12px;" data-i18n="btn_save_cost">ë³€ê²½ ì ìš©</button>
            </div>
            
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button id="btnRotateCanvas" class="btn-round" style="flex:1; justify-content: center;"><i class="fa-solid fa-rotate"></i> <span data-i18n="btn_rotate">íšŒì „</span></button>
                <button id="btnFitScreen" class="btn-round" style="flex:1; justify-content: center;"><i class="fa-solid fa-compress"></i> <span data-i18n="btn_fit_screen">ë§ì¶¤</span></button>
            </div>

            <div class="section-title" data-i18n="label_ai_tools" style="margin-bottom: 5px; font-size: 12px;">AI TOOLS</div>
            <button class="btn-round ai-red" id="btnAIBox" style="justify-content: center; height: 38px; margin-bottom: 5px;"><i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="btn_ai_gen">AI ìƒì„±</span></button>
            <!-- <button class="btn-round" id="btnOpenSellModal" onclick="window.openSellModal()"  -->
                  <!-- style="width: 100%; justify-content: center; height: 38px; background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); border: none; color: white; margin-bottom: 5px; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);"> -->
                 <!-- <i class="fa-solid fa-sack-dollar"></i> <span data-i18n="btn_sell_design">ë””ìì¸ íŒë§¤ ë“±ë¡</span> -->
            </button>
            <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                <button class="btn-round" id="btnOpenSaveModal" style="flex: 1; justify-content: center; height: 38px;">
                    <span data-i18n="btn_save_design">ğŸ’¾ ë””ìì¸ ì €ì¥</span>
                </button>
                <button class="btn-round" id="btnMyPageSide" style="flex: 1; justify-content: center; height: 38px; background: white; border: 1px solid #ddd; color: #333;">
                    <span>ğŸ“‚ MY page</span>
                </button>
            </div>

            <button class="btn-round" onclick="document.getElementById('logoUploadModal').style.display='flex'" style="width: 100%; justify-content: center; height: 38px; background: #f8fafc; border: 1px solid #6366f1; color: #6366f1; margin-bottom: 15px;">
                <i class="fa-solid fa-cloud-arrow-up"></i> <span data-i18n="btn_logo_share">ë¡œê³  ê³µìœ ë°©</span>
            </button>
            
            <div class="section-title" style="margin-bottom: 5px; font-size: 12px; color: #b6b6b6; letter-spacing: 1px;">ë¬´ë£Œ ë‹¤ìš´ë¡œë“œ</div>
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <button id="btnPNG" class="btn-round" style="flex:1; justify-content: center; height: 36px;"><i class="fa-regular fa-image"></i> PNG</button>
                <button id="btnPDF" class="btn-round" style="flex:1; justify-content: center; height: 36px;"><i class="fa-solid fa-file-pdf"></i> PDF</button>
            </div>

            <!-- ìš”ê¸°ê°€ ì›ë˜ ë§ˆë²•ì‚¬ ìë¦¬ -->

            <button id="btnAddBasicText" class="btn-round" style="width:100%; margin-bottom:10px; border:1px solid #cbd5e1; background:#fff; color:#333; font-weight:bold; padding:10px; display:flex; align-items:center; justify-content:center;">
                <span style="display:inline-flex; width:20px; height:20px; background:#222; color:#fff; border-radius:4px; align-items:center; justify-content:center; margin-right:6px; font-size:12px;">T</span>
                <span style="font-size: 13px;" data-i18n="btn_add_text">í…ìŠ¤íŠ¸ ì¶”ê°€</span>
            </button>

            <button class="btn-round" id="btnFontSelect" style="width:100%; margin-bottom:10px; display:flex; align-items:center; justify-content:center; height: 38px;">
                <span data-i18n="btn_font" style="font-size: 13px;">ğŸ…°ï¸ í°íŠ¸ ì „ì²´ë³´ê¸°</span>
            </button>

            <div id="leftTextSettings" style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:8px; margin-bottom:10px; text-align: left;">
                <div style="display:flex; gap:4px; margin-bottom:8px;">
                    <button class="tool-btn" id="btnAlignLeftText" style="flex:1;"><i class="fa-solid fa-align-left"></i></button>
                    <button class="tool-btn" id="btnAlignCenterText" style="flex:1;"><i class="fa-solid fa-align-center"></i></button>
                    <button class="tool-btn" id="btnAlignRightText" style="flex:1;"><i class="fa-solid fa-align-right"></i></button>
                </div>
                <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px; align-items:center; margin-bottom:6px;">
                    <span style="font-size:11px; color:#666;" data-i18n="editor_size">í¬ê¸°</span>
                    <input type="range" id="textSize" min="10" max="200" value="50" style="width:100%;">
                </div>
                <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px; align-items:center; margin-bottom:6px;">
                    <span style="font-size:11px; color:#666;" data-i18n="editor_char_spacing">ìê°„</span>
                    <input type="range" id="textCharSpacing" min="-50" max="300" value="0" style="width:100%;">
                </div>
                <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px; align-items:center;">
                    <span style="font-size:11px; color:#666;" data-i18n="editor_line_height">í–‰ê°„</span>
                    <input type="range" id="textLineHeight" min="0.5" max="2.5" step="0.1" value="1.2" style="width:100%;">
                </div>
            </div>

            <div class="color-group" style="margin-bottom:5px; font-size: 12px; display: flex; align-items: center; justify-content: space-between;">
                <span data-i18n="label_fill">ğŸ¨ ë©´ìƒ‰ìƒ</span>
                <input id="fillColor" type="color" class="color-picker" value="#000000" style="width: 25px; height: 25px;">
            </div>
            <div class="color-group" style="margin-bottom:10px; font-size: 12px; display: flex; align-items: center; justify-content: space-between;">
                <span data-i18n="label_stroke">ğŸ–Œï¸ ì„ ìƒ‰ìƒ</span>
                <input id="strokeColor" type="color" class="color-picker" value="#000000" style="width: 25px; height: 25px;">
            </div>

            <div class="section-title" data-i18n="label_shapes" style="font-size: 12px; margin-bottom: 5px;">SHAPES</div>
            <div class="shape-panel" style="gap: 4px;">
                <button class="shape-btn" data-shape="rect">â– </button>
                <button class="shape-btn" data-shape="circle">â—</button>
                <button class="shape-btn" data-shape="triangle">â–²</button>
                <button class="shape-btn" data-shape="star">â˜…</button>
                <button class="shape-btn" data-shape="heart">â™¥</button>
                <button class="shape-btn" data-shape="arrow">â¡</button>
                <button class="shape-btn" data-shape="round">â–¢</button>
                <button class="shape-btn" data-shape="line">â”</button>
            </div>

            <div class="section-title" style="font-size: 12px; margin-top: 15px; margin-bottom: 5px;">BACKGROUND</div>
            <button id="btnBgColor" class="btn-round" style="width:100%; justify-content: flex-start; margin-bottom: 5px; height: 38px;">
                <div style="width:20px; height:20px; background:linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); border-radius:4px; margin-right:8px; border:1px solid #ddd;"></div>
                <span data-i18n="editor_bg_color">ë°°ê²½ìƒ‰ ì„¤ì •</span>
            </button>

            <div id="bgColorPanel" style="display:none; background:#f8fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:10px;">
                <div style="font-size:11px; font-weight:bold; color:#666; margin-bottom:5px; text-align:left;" data-i18n="editor_basic_palette">ê¸°ë³¸ íŒ”ë ˆíŠ¸</div>
                <div id="colorPaletteGrid" style="display:grid; grid-template-columns:repeat(6, 1fr); gap:6px;">
                    </div>
            </div>
            <div class="section-title" data-i18n="label_upload" style="font-size: 12px; margin-top: 10px; margin-bottom: 5px;">UPLOAD</div>
            <label class="upload-box" for="imgUpload" style="height: 60px; padding: 10px;"><span style="font-size:18px;"><i class="fa-solid fa-cloud-arrow-up"></i></span> <span style="font-size: 12px;">Image/PDF</span></label>
            <input id="imgUpload" type="file" accept="image/*,.svg,.pdf" style="display:none;">
        </div>

        
        
        <div id="sideTemplateDrawer" class="side-drawer" style="display:none;">
            <div class="drawer-header">
                <span style="font-weight:800; color:#334155; font-size:14px;" data-i18n="editor_recommended">ğŸ¨ ì¶”ì²œ ë””ìì¸</span>
                <button class="btn-close-drawer" onclick="document.getElementById('sideTemplateDrawer').style.display='none'">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div style="display:flex; padding:15px 15px 0 15px; gap:8px;">
                <button id="btnSideTabTpl" class="btn-round" onclick="window.switchSideGroup('group_template')"
                        style="flex:1; justify-content:center; height:36px; font-size:13px; background:#6366f1; color:white; border:none; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1);" data-i18n="editor_tab_template">
                    í…œí”Œë¦¿
                </button>
                <button id="btnSideTabObj" class="btn-round" onclick="window.switchSideGroup('group_asset')"
                        style="flex:1; justify-content:center; height:36px; font-size:13px; background:#fff; color:#64748b; border:1px solid #e2e8f0; font-weight:bold;" data-i18n="editor_tab_element">
                    ìš”ì†Œ
                </button>
            </div>

            <div class="drawer-search-box" style="padding:15px; margin-bottom:0;">
                <div style="position:relative;">
                    <input type="text" id="sideTemplateSearch" 
                           placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ì˜ˆ: ì¹´í˜, ì„¸ì¼)" data-i18n-placeholder="ph_search_template" 
                           autocomplete="off" 
                           onkeyup="window.handleSideSearch(this.value)"
                           style="width:100%; padding:10px 10px 10px 35px; border:2px solid #f1f5f9; border-radius:8px; background:#f8fafc; font-size:13px; outline:none;">
                    <i class="fa-solid fa-magnifying-glass" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#94a3b8;"></i>
                </div>
            </div>

            <div id="sideTemplateList" class="drawer-content" style="padding-top:0;"></div>
        </div>

        <div class="stage" id="stage">
           <div id="textWizardToolbar" class="wizard-toolbar floating-island">
    <div class="wiz-brand" style="display:flex; flex-direction:column; justify-content:center; align-items:center; line-height:1.2; padding: 0 5px;">
        <span class="wiz-icon" style="font-size:20px; margin-bottom:2px;">ğŸ§™â€â™‚ï¸</span>
        <span style="font-size:10px; font-weight:bold; color:#8b00a7; letter-spacing:-0.5px;" data-i18n="editor_design_wizard">ë””ìì¸ë§ˆë²•ì‚¬</span>
    </div>
    
    <div class="wiz-scroll-track">
        
        <button onclick="window.toggleBackgroundLock()" style="
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    cursor: pointer;
    margin: 0 2px; /* ì¢Œìš° ì—¬ë°±ì„ ì¤„ì—¬ ê³µê°„ í™•ë³´ */
    padding: 0;
    min-width: 40px; /* ì „ì²´ í­ ì¶•ì†Œ */
">
    <div style="
        width: 30px;
        height: 30px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 3px;
        border: 1px solid #eee;
    ">
        <span style="font-size: 16px;">ğŸ”’</span>
    </div>

    <span style="
        font-size: 10px;
        color: #555; /* ë„ˆë¬´ ì§„í•˜ì§€ ì•Šê²Œ ìì—°ìŠ¤ëŸ¬ìš´ ìƒ‰ìƒ */
        font-weight: bold;
        white-space: nowrap;
        letter-spacing: -0.5px; /* ìê°„ì„ ì¢í˜€ì„œ ê°€ë¡œ ê³µê°„ ì¶”ê°€ í™•ë³´ */
    ">
        <span data-i18n="editor_unlock_bg">ë°°ê²½í’€ê¸°</span>
    </span>
</button>


        <button class="wiz-btn" onclick="window.applyNewWizard('basic')">
            <div class="icon-box c-indigo"><i class="fa-solid fa-store"></i></div>
            <span data-i18n="wiz_flyer">ì „ë‹¨ì§€</span>
        </button>
        <button class="wiz-btn" onclick="window.applyNewWizard('flyer')">
            <div class="icon-box c-red"><i class="fa-solid fa-bullhorn"></i></div>
            <span data-i18n="wiz_poster">í¬ìŠ¤í„°</span>
        </button>
        <button class="wiz-btn" onclick="window.applyNewWizard('card')">
            <div class="icon-box c-green"><i class="fa-solid fa-address-card"></i></div>
            <span data-i18n="wiz_card">ëª…í•¨</span>
        </button>
        <button class="wiz-btn" onclick="window.applyNewWizard('menu')">
            <div class="icon-box c-orange"><i class="fa-solid fa-utensils"></i></div>
            <span data-i18n="wiz_menu">ë©”ë‰´íŒ</span>
        </button>

        <div class="wiz-divider"></div>

        <button class="wiz-btn" onclick="window.applyNewWizard('banner-h')">
            <div class="icon-box c-blue"><i class="fa-solid fa-scroll"></i></div>
            <span data-i18n="wiz_banner_h">ê°€ë¡œí˜„ìˆ˜ë§‰</span>
        </button>
        <button class="wiz-btn" onclick="window.applyNewWizard('banner-v')">
            <div class="icon-box c-purple"><i class="fa-solid fa-flag"></i></div>
            <span data-i18n="wiz_banner_v">ì„¸ë¡œë°°ë„ˆ</span>
        </button>
        <button class="wiz-btn" onclick="window.applyNewWizard('fabric')">
            <div class="icon-box c-pink"><i class="fa-solid fa-shirt"></i></div>
            <span>SALE</span>
        </button>
        <button class="wiz-btn" onclick="window.applyNewWizard('vertical-text')">
            <div class="icon-box c-teal"><i class="fa-solid fa-text-height"></i></div>
            <span data-i18n="wiz_insta_panel">ì¸ìŠ¤íƒ€íŒë„¬</span>
        </button>
        
    </div>
</div>
            <div id="pageControls" class="page-controls-bar">
                <button class="btn-icon-only" id="btnPagePrev" onclick="window.changePage(-1)" title="ì´ì „ í˜ì´ì§€">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                
                <span id="pageCounter" style="font-weight:800; font-size:14px; min-width:60px; text-align:center; color:#334155;">1 / 1</span>
                
                <button class="btn-icon-only" id="btnPageNext" onclick="window.changePage(1)" title="ë‹¤ìŒ í˜ì´ì§€">
                    <i class="fa-solid fa-chevron-right"></i>
                </button>

                <div style="width:1px; height:14px; background:#cbd5e1; margin:0 8px;"></div>

                <button class="btn-text-icon" onclick="window.addPage()" title="Page">
                    <i class="fa-solid fa-plus"></i> <span style="font-size:12px; font-weight:bold;">Page</span>
                </button>
                
                <button class="btn-text-icon delete" onclick="window.deletePage()" title="í˜„ì¬ í˜ì´ì§€ ì‚­ì œ">
                    <i class="fa-regular fa-trash-can"></i>
                </button>
            </div>
            <div class="bottom-dock">
                <button onclick="window.toggleBackgroundLock()" class="zoom-btn" title="ë°°ê²½ ì ê¸ˆ/í•´ì œ"><i class="fa-solid fa-lock"></i></button>
                <button onclick="document.getElementById('btnFitScreen').click()" class="zoom-btn" title="í™”ë©´ ë§ì¶¤"><i class="fa-solid fa-compress"></i></button>
                <div class="divider"></div>
                
                <button id="btnZoomOut" class="zoom-btn"><i class="fa-solid fa-minus"></i></button>
                <button id="btnZoomIn" class="zoom-btn"><i class="fa-solid fa-plus"></i></button>
                <div class="divider"></div>
                <div style="position:relative;">
                    <div id="guideMenuPanel" class="guide-popup" style="display:none;">
                        <button class="guide-opt-btn" data-mode="off" onclick="window.setGuideMode('off')" data-i18n="guide_off">ğŸš« ë”</button>
                        <button class="guide-opt-btn" data-mode="cross" onclick="window.setGuideMode('cross')" data-i18n="guide_cross">âœš ì‹­ì</button>
                        <button class="guide-opt-btn" data-mode="3" onclick="window.setGuideMode('3')" data-i18n="guide_3col">3ë‹¨</button>
                        <button class="guide-opt-btn" data-mode="4" onclick="window.setGuideMode('4')" data-i18n="guide_4col">4ë‹¨</button>
                        <button class="guide-opt-btn" data-mode="5" onclick="window.setGuideMode('5')" data-i18n="guide_5col">5ë‹¨</button>
                        <button class="guide-opt-btn" data-mode="grid" onclick="window.setGuideMode('grid')" data-i18n="guide_grid">â–¦ ê²©ì</button>
                    </div>
                    
                    <button id="guideToggle" class="zoom-btn" style="width:auto; padding:0 15px; border-radius:20px; font-size:12px;">
                        <i class="fa-solid fa-ruler-horizontal"></i> <span data-i18n="btn_guide_on">ê°€ì´ë“œ</span>
                    </button>
                </div>
                <span class="help-text" data-i18n="help_text_shortcuts">Space: ì´ë™ / íœ : ì¤Œ</span>
            </div>
            
            <div class="right-stack" id="rightStackPanel">
                <div class="panel-box" id="panelEdit" style="padding: 10px 12px; text-align: center;">
                    <div class="section-title" style="margin-top:0; margin-bottom: 8px; font-size: 12px;" data-i18n="label_edit_layer">í¸ì§‘ & ë ˆì´ì–´</div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:5px;">
                        <button class="tool-btn" id="btnUndo" style="font-size: 11px;"><i class="fa-solid fa-rotate-left"></i> <span data-i18n="btn_undo">ì·¨ì†Œ</span></button>
                        <button class="tool-btn" id="btnRedo" style="font-size: 11px;"><i class="fa-solid fa-rotate-right"></i> <span data-i18n="btn_redo">ë‹¤ì‹œ</span></button>
                        <button class="tool-btn" id="btnCopy" style="font-size: 11px;"><i class="fa-regular fa-copy"></i> <span data-i18n="btn_copy">ë³µì‚¬</span></button>
                        <button class="tool-btn" id="btnPaste" style="font-size: 11px;"><i class="fa-regular fa-paste"></i> <span data-i18n="btn_paste">ë¶™ì—¬ë„£ê¸°</span></button>
                    </div>
                    
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <button class="tool-btn" id="btnRotateLeft15" style="flex:1; font-size: 11px;">-15Â°</button>
                        <button class="tool-btn" id="btnRotateRight15" style="flex:1; font-size: 11px;">+15Â°</button>
                    </div>

                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <button class="tool-btn" id="btnFront" data-i18n="btn_front" style="flex:1; font-size: 11px;">ë§¨ì•</button>
                        <button class="tool-btn" id="btnBack" data-i18n="btn_back" style="flex:1; font-size: 11px;">ë§¨ë’¤</button>
                        <button class="tool-btn" id="btnDel" style="color:red; flex:1; font-size: 11px;" data-i18n="btn_del">ì‚­ì œ</button>
                    </div>
                    
                    <!-- <div class="section-title" style="margin-bottom:8px; font-size: 12px;" data-i18n="label_align">ì •ë ¬</div>
                    <div class="align-grid" style="gap: 4px; margin-bottom: 8px;">
                        <button class="align-btn" id="btnAlignLeft"><i class="fa-solid fa-align-left"></i></button>
                        <button class="align-btn" id="btnAlignRight"><i class="fa-solid fa-align-right"></i></button>
                        <button class="align-btn" id="btnAlignTop"><i class="fa-solid fa-align-left" style="transform:rotate(90deg)"></i></button>
                        <button class="align-btn" id="btnAlignMiddle"><i class="fa-solid fa-arrows-up-down-left-right"></i></button>
                        <button class="align-btn" id="btnAlignBottom"><i class="fa-solid fa-align-right" style="transform:rotate(90deg)"></i></button>
                    </div> -->
                    <button class="btn-round" id="btnCenterObject" onclick="window.alignObject('center')" style="margin-top:5px; height: 32px; font-size: 11px;">
        ğŸ¯ <span data-i18n="btn_center_all">ì •ì¤‘ì•™</span>
    </button>
    
    <button class="btn-round" onclick="window.setAsBackground()" style="margin-top:5px; height: 32px; font-size: 11px;">
        ğŸ–¼ <span data-i18n="btn_full_bg">ë°°ê²½ ì±„ìš°ê¸°</span>
    </button>

    <button id="btnLockWizard" class="btn-round" style="margin-top:5px; height: 32px; font-size: 11px;">
        <i class="fa-solid fa-lock"></i> <span data-i18n="editor_lock_selection">ì„ íƒ-ì ê·¸ê¸°</span>
    </button>
                </div>

                <div class="panel-box" id="panelText" style="display:none;"></div>
                
                <div class="panel-box" style="padding: 10px 12px; text-align: center;">
                    <div class="section-title" style="margin-top:0; color:#333; font-size: 12px; margin-bottom: 5px;" data-i18n="label_ai_image_tools">AI & Cutout</div>
                    <div class="tool-box-group" style="padding: 0;">
                        <button id="btn-create-outline" class="btn-round" style="width:100%; margin-bottom:5px; justify-content:center; height: 36px; font-size: 11px;">
                            âœ‚ï¸ <span data-i18n="btn_make_cutline">ì˜¤ë ¤ë‚´ê¸° ì¹¼ì„ </span>
                        </button>
                        <div style="display:flex; gap:5px; margin-bottom: 10px;">
                            <button id="btn-make-keyring" class="btn-round" style="flex:1; justify-content: center; height:32px; font-size:11px;">
                                <span data-i18n="btn_keyring_hole">í‚¤ë§ ê³ ë¦¬</span>
                            </button>
                            <button id="btn-make-standee" class="btn-round" style="flex:1; justify-content: center; height:32px; font-size:11px;">
                                <span data-i18n="btn_stand_base">ë“±ì‹ ëŒ€</span>
                            </button>
                        </div>
                    </div>

                    <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 10px;">
    
    <button id="btnUpscale" class="btn-round" style="
        width: 100%; 
        height: 45px; 
        border: none; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        color: white; 
        font-weight: 800; 
        font-size: 13px; 
        box-shadow: 0 4px 10px rgba(118, 75, 162, 0.4);
        display: flex; align-items: center; justify-content: center;">
        âœ¨ <span data-i18n="btn_enhance">A3ì´ìƒ ì‚¬ì§„ í•´ìƒë„UP</span>
    </button>

    <button id="btnCutout" class="btn-round" style="
        width: 100%; 
        height: 45px; 
        border: none; 
        background: linear-gradient(135deg, #ff9a9e 0%, #ff6a88 100%); 
        color: white; 
        font-weight: 800; 
        font-size: 13px; 
        box-shadow: 0 4px 10px rgba(255, 106, 136, 0.4);
        display: flex; align-items: center; justify-content: center;">
        âœ‚ï¸ <span data-i18n="btn_bg_remove">ë°°ê²½ ì œê±°í•˜ê¸°</span>
    </button>

    <button class="tool-btn" id="btnOutline" style="height: 36px; font-size: 11px; background:white; border:1px solid #ddd; color:#333;">
        ğŸ”² <span data-i18n="btn_text_outline">ì™¸ê³½ì„ </span>
    </button>

</div>
                    
                    <div class="section-title" style="margin-top:10px; font-size: 11px; text-align: left;" data-i18n="editor_stroke_width">ì„  ë‘ê»˜</div>
                    <input type="range" id="globalStroke" min="0" max="30" value="0" style="width:100%;">
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button class="tool-btn" id="btnStrokeMiter" style="flex:1; height: 30px; font-size: 11px;"><i class="fa-solid fa-square"></i> <span data-i18n="style_miter">ê°ì§€ê²Œ</span></button>
                        <button class="tool-btn" id="btnStrokeRound" style="flex:1; height: 30px; font-size: 11px;"><i class="fa-solid fa-circle"></i> <span data-i18n="style_round">ë‘¥ê¸€ê²Œ</span></button>
                    </div>

                    <div class="section-title" style="margin-top: 10px; font-size: 11px; text-align: left;" data-i18n="label_opacity">íˆ¬ëª…ë„</div>
                    <input type="range" id="opacitySlider" min="0" max="100" value="100" style="width:100%;">
                </div>
            </div>
            <canvas id="designCanvas"></canvas>
        </div>
    </div>
</div>
<div id="mobileTextEditor" style="display:none;">
    <div class="m-text-header">
        <span style="color:#6366f1; font-weight:bold;"><i class="fa-solid fa-pen"></i> <span data-i18n="editor_text_edit">í…ìŠ¤íŠ¸ ìˆ˜ì •</span></span>
        
        <div style="display:flex; gap:5px;">
            <button onclick="window.deleteMobileObject()" style="background:#ef4444; color:white; border:none; padding:6px 12px; border-radius:6px; font-weight:bold; font-size:13px;">
                <i class="fa-solid fa-trash"></i> <span data-i18n="btn_delete_obj">ì‚­ì œ</span>
            </button>
            
            <button onclick="window.closeMobileTextEditor()" style="background:#6366f1; color:white; border:none; padding:6px 12px; border-radius:6px; font-weight:bold; font-size:13px;" data-i18n="btn_done_edit">
                ì™„ë£Œ
            </button>
        </div>
    </div>
    <textarea id="mobileTextInput" placeholder="ì—¬ê¸°ì— ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." data-i18n-placeholder="ph_text_input"></textarea>
</div>
<div id="templateActionModal" class="modal-bg" style="z-index: 20000;">
    <div class="modal-box" style="width: 500px; max-width: 90%;">
        <h3 style="margin-top:0; font-size: 20px;" data-i18n="tpl_load_title">ğŸ¨ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°</h3>
        <p style="color:#666; font-size:15px; margin-bottom:30px; line-height: 1.5;" data-i18n="tpl_load_desc">
            í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë””ìì¸ì´ ìˆìŠµë‹ˆë‹¤.<br>
            ì„ íƒí•œ í…œí”Œë¦¿ì„ ì–´ë–»ê²Œ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
        </p>
        
        <div style="display:flex; gap:15px;">
            <button id="btnActionAdd" class="btn-round" style="flex:1; height:120px; flex-direction:column; justify-content:center; gap:10px; background:#f1f5f9; border:1px solid #cbd5e1; color:#334155;">
                <i class="fa-solid fa-layer-group" style="font-size:32px; color:#6366f1;"></i>
                <span style="font-size:16px; font-weight:bold;" data-i18n="tpl_action_add">í˜„ì¬ ì‘ì—…ì— ì¶”ê°€</span>
                <span style="font-size:12px; font-weight:normal; opacity:0.8;" data-i18n="tpl_action_add_desc">ê¸°ì¡´ ë””ìì¸ ìœ„ì— ê²¹ì¹˜ê¸°</span>
            </button>

            <button id="btnActionReplace" class="btn-round ai-red" style="flex:1; height:120px; flex-direction:column; justify-content:center; gap:10px; border:none;">
                <i class="fa-solid fa-file-circle-check" style="font-size:32px;"></i>
                <span style="font-size:16px; font-weight:bold;" data-i18n="tpl_action_replace">ìƒˆ ì‘ì—… ì‹œì‘</span>
                <span style="font-size:12px; font-weight:normal; opacity:0.8;" data-i18n="tpl_action_replace_desc">ê¸°ì¡´ ë‚´ìš© ì§€ìš°ê³  ë®ì–´ì“°ê¸°</span>
            </button>
        </div>

        <button onclick="document.getElementById('templateActionModal').style.display='none'" class="btn-round" style="margin-top:20px; border:none; color:#999;">
            <span data-i18n="btn_cancel_back">ì·¨ì†Œí•˜ê³  ëŒì•„ê°€ê¸°</span>
        </button>
    </div>
</div>
<div id="sizeSelectModal" class="modal-bg" style="z-index: 15000;">
    <div class="modal-box" style="width: 800px; max-width: 95%;">
        <h3 data-i18n="size_select_title">ğŸ“ ì–´ë–¤ í¬ê¸°ë¡œ ë§Œë“œì‹œê² ìŠµë‹ˆê¹Œ?</h3>
        <p style="margin-bottom:20px; color:#666;" data-i18n="size_select_desc">ì„ íƒí•œ ì œí’ˆ í¬ê¸°ì— ë§ì¶° í…œí”Œë¦¿ì´ ìë™ìœ¼ë¡œ ì¡°ì ˆë©ë‹ˆë‹¤.</p>
        
        <div id="productSelectGrid" class="quick-menu-track" style="grid-template-columns: repeat(4, 1fr);"></div>
        
        <button onclick="document.getElementById('sizeSelectModal').style.display='none'" class="btn-round" style="margin-top:20px;" data-i18n="btn_cancel">ì·¨ì†Œ</button>
    </div>
</div>
<div id="aiDrawer" class="ai-drawer"><h3 data-i18n="ai_title">âœ¨ AI ì´ë¯¸ì§€ ìƒì„±</h3><p class="label" data-i18n="ai_prompt_label">ì„¤ëª… (Prompt)</p><textarea id="aiPrompt" class="ai-input-pretty" placeholder="ì˜ˆ: ìˆ²ì†ì— ì•‰ì•„ìˆëŠ” ê·€ì—¬ìš´ ê°ˆìƒ‰ í† ë¼" data-i18n-placeholder="ph_ai_prompt" style="height:100px;"></textarea><button id="aiGenerateBtn" class="btn-round primary" style="margin-top:10px;" data-i18n="btn_generate">ìƒì„±í•˜ê¸°</button><div id="aiResultArea" style="min-height:200px; background:#f9f9f9; margin-top:20px; display:flex; justify-content:center; align-items:center;"><span style="color:#ccc;" data-i18n="ai_waiting">ê²°ê³¼ ëŒ€ê¸° ì¤‘</span></div><button id="aiUseBtn" class="btn-round" style="display:none; margin-top:10px;" data-i18n="btn_add_to_canvas">ìº”ë²„ìŠ¤ì— ë„£ê¸°</button><button onclick="document.getElementById('aiDrawer').classList.remove('open')" class="btn-round" style="margin-top:10px;" data-i18n="btn_close">ë‹«ê¸°</button></div>
<div id="templateOverlay">
    <div class="tpl-modal-box">
        <div class="tpl-sidebar">
            <button class="tpl-cate-btn active" onclick="window.filterTpl('group_template', this)">
                <span style="font-weight:800; color:#6366f1; font-size:16px;" data-i18n="editor_tab_template">ğŸ¨ í…œí”Œë¦¿</span>
            </button>

            <button class="tpl-cate-btn" onclick="window.filterTpl('group_asset', this)">
                <span style="font-weight:800; color:#059669; font-size:16px;" data-i18n="tpl_obj_label">ğŸ§© ê°ì²´</span>
            </button>
        </div>
        <div class="tpl-content">
            <div style="padding: 20px 30px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between;">
                <h2 style="margin:0;" data-i18n="search_label">ê²€ìƒ‰</h2>
                <input type="text" id="tplSearchInput" class="ai-input-pretty" style="width:300px; margin-bottom:0;" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." data-i18n-placeholder="ph_search_input">
                <button onclick="document.getElementById('templateOverlay').style.display='none'" style="border:none; background:none; cursor:pointer;">
                    <i class="fa-solid fa-xmark fa-2x"></i>
                </button>
            </div>
            <div id="tplGrid" class="tpl-grid"></div>
            <div style="padding:15px; text-align:right; border-top:1px solid #eee;">
                <button id="btnUseTpl" class="btn primary" onclick="window.useSelectedTemplate()" data-i18n="btn_apply_template">ì„ íƒí•œ í…œí”Œë¦¿ ì ìš©</button>
            </div> 
        </div>
    </div>
</div>
<div id="libraryModal" class="modal-bg" style="z-index: 11000;"><div class="modal-box" style="width: 800px; max-width: 90%; height: 80%; display: flex; flex-direction: column;"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h3 style="margin:0;">ğŸ“‚ ë‚´ ë””ìì¸ ë³´ê´€í•¨</h3><button onclick="document.getElementById('libraryModal').style.display='none'" style="border:none; background:none; cursor:pointer; font-size:20px;">âœ•</button></div><div id="myDesignGrid" style="flex:1; overflow-y:auto; display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:20px; padding:10px;"></div></div></div>
<div id="saveDesignModal" class="modal-bg" style="z-index: 11001;"><div class="modal-box"><h3>ğŸ’¾ ë””ìì¸ ì €ì¥í•˜ê¸°</h3><p style="font-size:13px; color:#666;">ë³´ê´€í•¨ì— ì €ì¥í•˜ì—¬ ë‚˜ì¤‘ì— ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><input id="saveDesignTitle" class="ai-input-pretty" placeholder="ë””ìì¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì—¬ë¦„ ì´ë²¤íŠ¸ ë°°ë„ˆ)"><div style="display:flex; gap:10px; margin-top:20px;"><button id="btnConfirmSave" class="btn-round primary">ì €ì¥í•˜ê¸°</button><button onclick="document.getElementById('saveDesignModal').style.display='none'" class="btn-round">ì·¨ì†Œ</button></div></div></div>
<div id="loadModeModal" class="modal-bg" style="z-index: 10001;"><div class="modal-box" style="width: 450px;"><h3>ğŸ¨ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°</h3><p style="color:#666; font-size:14px; margin-bottom:20px;">í˜„ì¬ ìº”ë²„ìŠ¤ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤.</p><div style="display:flex; gap:10px;"><button id="btnLoadReplace" class="btn-round ai-red" style="height:100px;">ìƒˆ ì‘ì—…ìœ¼ë¡œ<br>(ê¸°ì¡´ ì‚­ì œ)</button><button id="btnLoadAdd" class="btn-round primary" style="height:100px;">í˜„ì¬ ì‘ì—…ì—<br>ì¶”ê°€í•˜ê¸°</button></div><button onclick="document.getElementById('loadModeModal').style.display='none'" class="btn-round" style="margin-top:15px;">ì·¨ì†Œ</button></div></div>
<div id="loginModal" class="modal-bg" style="z-index: 10002;">
    <div class="modal-box" style="width: 400px;">
        <h3 id="authTitle" style="margin-top:0;" data-i18n="modal_login_title">ë¡œê·¸ì¸</h3>
        <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:15px;">
            <input id="loginId" class="ai-input-pretty" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" data-i18n-placeholder="placeholder_email" style="margin:0;">
            <input id="loginPw" class="ai-input-pretty" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" data-i18n-placeholder="placeholder_pw" style="margin:0;">
            <input id="loginPwConfirm" class="ai-input-pretty" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" data-i18n-placeholder="placeholder_pw_confirm" style="margin:0; display:none;">
        </div>
        <button class="btn-round primary" id="btnAuthAction" style="width:100%; justify-content:center; height:45px; font-size:15px;" data-i18n="btn_login_submit">ë¡œê·¸ì¸</button>
        <div style="margin-top:15px; font-size:13px; color:#666;">
            <span id="authSwitchText" data-i18n="msg_no_account">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?</span>
            <span id="btnSwitchAuthMode" style="color:var(--primary); font-weight:bold; cursor:pointer; margin-left:5px; text-decoration:underline;" data-i18n="btn_signup">íšŒì›ê°€ì…</span>
        </div>
        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
        <div style="display:flex; flex-direction:column; gap:8px;">
            <button id="btnGoogleLogin" class="btn-round" style="border-color:#ddd; justify-content:center;">
                <i class="fa-brands fa-google" style="color:#DB4437; margin-right:8px;"></i> <span data-i18n="btn_google_login">Googleë¡œ ì‹œì‘í•˜ê¸°</span>
            </button>
            <button id="btnKakaoLogin" class="btn-round" style="border-color:#FEE500; background:#FEE500; color:#3C1E1E; justify-content:center;">
                <i class="fa-solid fa-comment" style="margin-right:8px;"></i> ì¹´ì¹´ì˜¤ë¡œ ì‹œì‘í•˜ê¸°
            </button>
        </div>
        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #f1f5f9; text-align: center;">
    <p style="font-size: 13px; color: #6366f1; font-weight: bold; margin-bottom: 15px; line-height: 1.5; word-break: keep-all;">
        <i class="fa-solid fa-circle-info"></i> ê³ ê°ë‹˜ì˜ ì†Œì¤‘í•œ ì‘ì—…ë¬¼ì„ ì„ì‹œì €ì¥í•˜ê¸° ìœ„í•´ì„œëŠ”<br>íšŒì›ê°€ì… ë˜ëŠ” ë¡œê·¸ì¸ì´ ê¼­ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.
    </p>
    
    <button onclick="document.getElementById('loginModal').style.display='none'" class="btn-round" style="width: 100%; justify-content: center; background: #f8fafc; border: 1px solid #e2e8f0; color: #64748b; font-weight: normal;">
        ğŸ‘€ ë¡œê·¸ì¸ ì—†ì´ ë‘˜ëŸ¬ë³´ê¸°
    </button>
</div>
    </div>
</div>
<div id="productDetailModal" class="modal-bg" style="z-index: 11000;"><div class="modal-box" style="width: 900px; max-width: 95%; display: flex; text-align: left; padding:0; overflow:hidden;"><div style="width: 45%; background: #f8fafc; display: flex; align-items: center; justify-content: center; padding: 20px;"><img id="pdpImage" src="" style="max-width: 100%; max-height: 300px; object-fit: contain;"></div><div style="width: 55%; padding: 40px; display: flex; flex-direction: column;"><h2 id="pdpTitle" style="margin: 0 0 10px 0;">ìƒí’ˆëª…</h2><h3 id="pdpPrice" style="color: var(--primary); margin: 0 0 20px 0;">0ì›</h3><button id="btnActionDesign" class="btn-round primary" style="height: 50px;">ğŸ¨ ì§ì ‘ ë””ìì¸í•˜ê¸°</button><div style="margin-top:10px;"><input type="file" id="pdpFileUpload" style="display: none;"><button onclick="document.getElementById('pdpFileUpload').click()" class="btn-round">ğŸ“‚ íŒŒì¼ ì—…ë¡œë“œ ì£¼ë¬¸</button></div><button onclick="document.getElementById('productDetailModal').style.display='none'" style="margin-top: auto; border:none; background:none; cursor:pointer;">ë‹«ê¸°</button></div></div></div>
<div id="cartPage" style="display:none; position:fixed; inset:0; background:#f1f5f9; z-index: 12000; overflow-y:auto; padding-top: 40px;">
    <div style="max-width: 1000px; margin: 0 auto; padding-bottom: 60px;">
        <div style="display:flex; justify-content:space-between; align-items:center; padding:0 20px;">
            <h1>ğŸ›’ <span data-i18n="cart_title">ì¥ë°”êµ¬ë‹ˆ</span> <span id="cartCount">(0)</span></h1>
            <button onclick="document.getElementById('cartPage').style.display='none'" class="btn-round" style="width:auto;" data-i18n="btn_close">ë‹«ê¸°</button>
        </div>

        <div style="display: flex; flex-direction: column; gap: 20px; padding: 0 20px;">
            
            <div style="background:#ffe70e; padding:15px; border-radius:12px; border:1px dashed #ffde39; text-align:center;">
                <p style="margin:0 0 10px 0; font-size:13px; color:#64748b;" data-i18n="cart_upload_guide">ì§ì ‘ ë””ìì¸í•œ íŒŒì¼ì€ ì—¬ê¸°ì— ì¼ê´„ ì—…ë¡œë“œ í•´ì£¼ì„¸ìš”</p>
                <button onclick="document.getElementById('bulkCartUpload').click()" class="btn-round" style="width:100%; justify-content:center; background:#f8fafc; border:1px solid #6366f1; color:#6366f1;">
                    <i class="fa-solid fa-cloud-arrow-up"></i> <span data-i18n="btn_bulk_upload">íŒŒì¼ ì¼ê´„ ì—…ë¡œë“œ</span>
                </button>
                <input type="file" id="bulkCartUpload" multiple style="display:none;" onchange="window.handleBulkCartUpload(this)">
            </div>

            <div id="cartListArea" style="width: 100%;"></div>
            
            
            <div style="width: 100%;">
                <div style="background:white; padding:20px; border-radius:12px;">
                    <h3 data-i18n="label_payment_amt">ê²°ì œ ê¸ˆì•¡</h3>
                    
                    <div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                        <span data-i18n="label_product_price">ìƒí’ˆ</span>
                        <span id="summaryItemPrice">0ì›</span>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                        <span data-i18n="label_option_price">ì˜µì…˜</span>
                        <span id="summaryAddonPrice">0ì›</span>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; color:#ef4444; font-weight:bold; margin-bottom: 5px;">
                        <span>ë“±ê¸‰ í• ì¸</span>
                        <span id="summaryDiscount">0ì› (0%)</span>
                    </div>
                    
                    <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
                    
                    <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:20px; margin-bottom: 20px;">
                        <span data-i18n="label_total_price">í•©ê³„</span>
                        <span id="summaryTotal">0ì›</span>
                    </div>
                    
                    <button id="btnGoCheckout" class="btn-round primary" style="margin-top:0; width:100%; height: 50px; font-size: 16px;">
                        ğŸ’³ <span data-i18n="btn_do_checkout">ê²°ì œí•˜ê¸°</span>
                    </button>
                    
                    <button id="btnPrintQuote" class="btn-round btn-secondary" style="margin-top:10px; width:100%;">
                        <i class="fa-solid fa-file-invoice"></i> <span data-i18n="btn_print_quote">ê²¬ì ì„œ ì¶œë ¥</span>
                    </button>
                </div>
            </div>
            </div>
    </div>
</div>
<div id="calendarModal" class="modal-bg" style="z-index: 12500;">
    <div class="modal-box">
        <h3>ğŸ“… <span data-i18n="modal_calendar_title">ë°°ì†¡ìš”ì²­ [ì œì‘ê¸°ê°„ 3ì¼]</span></h3>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <button id="btnPrevMonth" class="btn-round" style="width:30px;">&lt;</button>
            <span id="currentMonthYear" style="font-weight:bold;"></span>
            <button id="btnNextMonth" class="btn-round" style="width:30px;">&gt;</button>
        </div>
        <div id="calendarGrid" class="calendar-grid"></div>
        <button onclick="document.getElementById('calendarModal').style.display='none'" class="btn-round" style="margin-top:15px;" data-i18n="btn_close">ë‹«ê¸°</button>
    </div>
</div>
<div id="deliveryInfoModal" class="modal-bg" style="z-index: 12600;">
    <div class="modal-box" style="text-align:left;">
        <h3 style="text-align:center;" data-i18n="modal_delivery_title">ğŸ“ ë°°ì†¡ ì •ë³´ ì…ë ¥</h3>
        
        <p data-i18n="label_manager_name">ë‹´ë‹¹ìëª…</p>
        <input id="inputManagerName" class="ai-input-pretty">
        
        <p data-i18n="label_contact_phone">ì—°ë½ì²˜</p>
        <input id="inputManagerPhone" class="ai-input-pretty">
        
        <p data-i18n="label_address">ì£¼ì†Œ (Address)</p>
        
        <div id="addrFormKR">
            <input id="inputAddressKR" class="ai-input-pretty" placeholder="ì£¼ì†Œ ê²€ìƒ‰ ë˜ëŠ” ì…ë ¥">
        </div>

        <div id="addrFormGlobal" style="display:none; gap:10px; flex-direction:column;">
            <div style="display:flex; gap:10px;">
                <input id="inputZipCode" class="ai-input-pretty" placeholder="Zip/Postal Code" style="flex:1; margin:0;">
                <input id="inputState" class="ai-input-pretty" placeholder="State/Prefecture" style="flex:1; margin:0;">
            </div>
            <input id="inputCity" class="ai-input-pretty" placeholder="City" style="margin-bottom:0;">
            <input id="inputStreet1" class="ai-input-pretty" placeholder="Street Address 1" style="margin-bottom:0;">
            <input id="inputStreet2" class="ai-input-pretty" placeholder="Apartment, suite, unit, etc. (optional)">
        </div>
        
        <p data-i18n="label_request_memo" style="margin-top:10px;">ìš”ì²­ì‚¬í•­</p>
        <textarea id="inputRequest" class="ai-input-pretty"></textarea>
        
        <button id="btnSubmitOrderInfo" class="btn-round primary" style="margin-top:10px;" data-i18n="btn_payment_submit">ì£¼ë¬¸ì„œ ìƒì„± ë° ê²°ì œ</button>
        <button onclick="document.getElementById('deliveryInfoModal').style.display='none'" class="btn-round" style="margin-top:5px;" data-i18n="btn_cancel">ì·¨ì†Œ</button>
    </div>
</div>

<div id="checkoutModal" class="modal-bg" style="z-index: 13000;">
    <div class="modal-box" style="text-align:left; width: 500px;">
        <h3 style="text-align:center; margin-bottom: 20px;" data-i18n="modal_checkout_title">ì£¼ë¬¸ í™•ì¸ ë° ê²°ì œ</h3>
        
        <label style="font-size:12px; color:#666; font-weight:bold;" data-i18n="label_orderer_name">ì£¼ë¬¸ìëª…</label>
        <input id="orderName" class="ai-input-pretty" readonly>
        
        <label style="font-size:12px; color:#666; font-weight:bold;" data-i18n="label_contact_phone">ì—°ë½ì²˜</label>
        <input id="orderPhone" class="ai-input-pretty" readonly>
        
        <label style="font-size:12px; color:#666; font-weight:bold;" data-i18n="label_shipping_addr">ë°°ì†¡ì§€</label>
        <input id="orderAddr" class="ai-input-pretty" readonly>
        
        <label style="font-size:12px; color:#666; font-weight:bold;" data-i18n="label_request_memo">ìš”ì²­ì‚¬í•­</label>
        <textarea id="orderMemo" class="ai-input-pretty" readonly></textarea>
        
        <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">

        <div style="background:#f0f9ff; padding:15px; border-radius:8px; border:1px solid #bae6fd; margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span style="font-weight:bold; color:#0369a1;" data-i18n="label_mileage_use">â“‚ï¸ ë§ˆì¼ë¦¬ì§€ ì‚¬ìš©</span>
                <span style="font-size:12px; color:#64748b;"><span data-i18n="label_mileage_owned">ë³´ìœ :</span> <b id="userOwnMileage">0 P</b></span>
            </div>
            
            <div style="display:flex; gap:8px; align-items:center;">
                <input type="number" id="inputUseMileage" class="ai-input-pretty" placeholder="0" style="margin:0; text-align:right; font-weight:bold; color:#0369a1;" oninput="window.calcMileageLimit(this)">
                <button class="btn-round" onclick="window.applyMaxMileage()" style="width:60px; font-size:12px; background:#fff; border:1px solid #cbd5e1; color:#333; justify-content:center;" data-i18n="btn_max">ìµœëŒ€</button>
            </div>

            <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:11px;">
                <span style="color:#ef4444; font-weight:bold;" data-i18n="msg_mileage_5pct">* ê²°ì œê¸ˆì•¡ì˜ 5%ê¹Œì§€ë§Œ ì‚¬ìš© ê°€ëŠ¥</span>
                <span style="color:#0369a1;"><span data-i18n="label_available_limit">ì‚¬ìš©ê°€ëŠ¥ í•œë„:</span> <b id="mileageLimitDisplay">0 P</b></span>
            </div>
        </div>

        <div style="text-align:right; margin-bottom:20px;">
            <div style="font-size:13px; color:#666;" data-i18n="label_final_pay_amount">ìµœì¢… ê²°ì œ ê¸ˆì•¡</div>
            <div id="finalPayAmountDisplay" style="font-size:24px; font-weight:900; color:#6366f1;">0ì›</div>
        </div>
        <label style="font-size:14px; font-weight:bold; color:#333; margin-bottom:10px; display:block;" data-i18n="label_pay_method">ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ</label>
        
        <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
            <label class="pay-method-item" style="display:flex; align-items:center; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer;">
                <input type="radio" name="paymentMethod" value="card" checked style="margin-right:10px; accent-color:#6366f1;">
                <span data-i18n="label_card_pay">ğŸ’³ ì¹´ë“œ / ê°„í¸ê²°ì œ (ì¦‰ì‹œ ì™„ë£Œ)</span>
            </label>

            <label class="pay-method-item" style="display:flex; align-items:center; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer;">
                <input type="radio" name="paymentMethod" value="bank" style="margin-right:10px; accent-color:#6366f1;">
                <span data-i18n="label_bank_transfer">ğŸ¦ ë¬´í†µì¥ ì…ê¸ˆ (í™•ì¸ í›„ ì œì‘)</span>
            </label>

            <label class="pay-method-item" style="display:flex; align-items:center; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer;">
                <input type="radio" name="paymentMethod" value="deposit" style="margin-right:10px; accent-color:#6366f1;">
                <div style="display:flex; justify-content:space-between; width:100%;">
                    <span data-i18n="label_deposit_use">ğŸ’° ë‚˜ì˜ ì˜ˆì¹˜ê¸ˆ ì‚¬ìš©</span>
                    <span id="myCurrentDepositDisplay" style="font-weight:bold; color:#6366f1;" data-i18n="label_balance_loading">(ì”ì•¡ ì¡°íšŒì¤‘...)</span>
                </div>
            </label>
        </div>

        <button id="btnFinalPay" class="btn-round primary" style="width:100%; height: 50px; font-size: 16px;" onclick="window.handleFinalPayment()" data-i18n="btn_do_final_pay">
            ê²°ì œí•˜ê¸°
        </button>

        <div id="bankInfoBox" style="display:none; margin-top:15px; background:#f8fafc; padding:15px; border-radius:8px; font-size:13px;">
            <div class="bank-title" style="font-weight:bold; margin-bottom:5px;" data-i18n="msg_bank_info">[ê³„ì¢Œì´ì²´ ì•ˆë‚´]</div>
            
            <div style="line-height:1.6;">
                <span data-i18n="msg_bank_name">êµ­ë¯¼ì€í–‰</span> 
                <span style="font-weight:bold; color:#333;">647701-04-277763</span><br>
                <span data-i18n="msg_bank_owner">(ì˜ˆê¸ˆì£¼: ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ…)</span>
            </div>
            
            <div style="margin-top:10px; border-top:1px solid #e2e8f0; padding-top:10px;">
                <label style="font-weight:bold; display:block; margin-bottom:5px;" data-i18n="label_manager_name">ì…ê¸ˆìëª…</label>
                <input type="text" id="inputDepositorName" class="ai-input-pretty" placeholder="" style="margin:0; background:white;">
            </div>
            
            <div style="color:#ef4444; margin-top:5px;" data-i18n="msg_bank_note">* ì…ê¸ˆìëª…ì´ ì£¼ë¬¸ìëª…ê³¼ ë‹¤ë¥´ë©´ í™•ì¸ì´ ì§€ì—°ë©ë‹ˆë‹¤.</div>
        </div>

        <div style="display:flex; gap:10px; margin-top:15px;">
            <button id="btnDownQuotationCheckout" class="btn-round btn-secondary" style="flex:1; justify-content: center;">
                <i class="fa-solid fa-file-invoice"></i> <span data-i18n="btn_download_quote">ê²¬ì ì„œ ë‹¤ìš´</span>
            </button>
            <button id="btnDownOrderSheetCheckout" class="btn-round btn-secondary" style="flex:1; justify-content: center;">
                <i class="fa-solid fa-clipboard-list"></i> <span data-i18n="btn_download_work_sheet">ì‘ì—…ì§€ì‹œì„œ ë‹¤ìš´</span>
            </button>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
    <button id="btnDownReceipt" class="btn-round btn-secondary" style="flex:1; justify-content: center; background:#fff; color:#475569; border:1px solid #cbd5e1;">
        <i class="fa-solid fa-receipt"></i> <span data-i18n="pdf_receipt_title">ì˜ìˆ˜ì¦</span>
    </button>
    <button id="btnDownStatement" class="btn-round btn-secondary" style="flex:1; justify-content: center; background:#fff; color:#475569; border:1px solid #cbd5e1;">
        <i class="fa-solid fa-file-contract"></i> <span data-i18n="pdf_statement_title">ê±°ë˜ëª…ì„¸ì„œ</span>
    </button>
</div>

        <button onclick="document.getElementById('checkoutModal').style.display='none'; if(window.isOrderCompleted) location.reload();" class="btn-round" style="margin-top:10px; border:none; color:#888;" data-i18n="btn_close">ë‹«ê¸°</button>
    </div>
</div>
        </div>

        <button onclick="document.getElementById('checkoutModal').style.display='none'" class="btn-round" style="margin-top:10px; border:none; color:#888;" data-i18n="btn_close">ë‹«ê¸°</button>
    </div>
</div>

        <button onclick="document.getElementById('checkoutModal').style.display='none'" class="btn-round" style="margin-top:10px; border:none; color:#888;" data-i18n="btn_close">ë‹«ê¸°</button>
    </div>
</div>
</div>
<div id="successModal" class="modal-bg" style="z-index: 14000;"><div class="modal-box"><h2 data-i18n="msg_order_complete_title">ğŸ‰ ì£¼ë¬¸ ì™„ë£Œ!</h2><button id="btnDownOrderSheet" class="btn-round" data-i18n="btn_download_order_sheet">ğŸ“„ ì‘ì—…ì§€ì‹œì„œ ë‹¤ìš´ë¡œë“œ</button><button id="btnDownQuotation" class="btn-round" style="margin-top:5px;" data-i18n="btn_download_quotation">ğŸ“‘ ê²¬ì ì„œ ë‹¤ìš´ë¡œë“œ</button><button onclick="window.closeSuccessModal()" class="btn-round primary" style="margin-top:15px;" data-i18n="btn_confirm">í™•ì¸</button></div></div>
<div id="sellModal" class="modal-bg" style="display: none;"> <div class="modal-box">
        <h3 class="modal-title" data-i18n="sell_title">ğŸ’ ë””ìì¸ ê³µìœ /íŒë§¤ ë“±ë¡</h3>
        
        <div class="benefit-box">
            <div class="benefit-item">
                <span class="benefit-icon">ğŸ’°</span>
                <span data-i18n="sell_benefit_1">ë“±ë¡ ì¦‰ì‹œ <span class="highlight">100ì›</span>, ì‚¬ìš©ë  ë•Œë§ˆë‹¤ <span class="highlight">200ì›</span> ì ë¦½</span>
            </div>
            <div class="benefit-item">
                <span class="benefit-icon">ğŸ’³</span>
                <span data-i18n="sell_benefit_2">1,000ì›ë¶€í„° ë°”ë¡œ <span class="highlight">í˜„ê¸ˆ í™˜ì „</span> ê°€ëŠ¥</span>
            </div>
            <div class="benefit-item">
                <span class="benefit-icon">ğŸš€</span>
                <span data-i18n="sell_benefit_3">í…ìŠ¤íŠ¸/ë¡œê³  ê³µìœ ë¡œ ë§¤ì¼ ìë™ ìˆ˜ì… ë§Œë“¤ê¸°!</span>
            </div>
        </div>

        

        <div class="input-row" style="margin-bottom: 15px;">
    <label style="display:block; font-weight:bold; margin-bottom:5px;" data-i18n="sell_type_label">í…œí”Œë¦¿ ìœ í˜•</label>
    <div style="display: flex; gap: 20px;">
        <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
            <input type="radio" name="sellType" value="vector" checked>
            <span data-i18n="sell_type_vector">ë²¡í„°</span>
        </label>
        <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
            <input type="radio" name="sellType" value="image">
            <span data-i18n="sell_type_image">ì´ë¯¸ì§€</span>
        </label>
    </div>
</div>
        <div class="input-group">
            <label class="input-label" data-i18n="sell_keyword_label">í‚¤ì›Œë“œ & ì œëª©</label>
            <input id="sellTitle" class="ai-input-pretty" 
                   type="text"
                   placeholder="ì˜ˆ: í”¼ë¶€ê³¼ ì´ë²¤íŠ¸, ì—¬ë¦„ í¬ìŠ¤í„°" data-i18n-placeholder="ph_sell_title" 
                   oninput="document.getElementById('sellKw').value = this.value;">
        </div>

        <input id="sellKw" type="hidden">
        

        <div class="btn-group">
            <button onclick="document.getElementById('sellModal').style.display='none'" class="btn-round cancel" data-i18n="btn_cancel">ì·¨ì†Œ</button>
            <button id="btnSellConfirm" class="btn-round primary" data-i18n="btn_register">ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>
</div>
<div id="fontModal" class="modal-bg" style="z-index: 10002;"><div class="modal-box"><h3 data-i18n="modal_font_title">í°íŠ¸ ì„ íƒ</h3><div id="fontList" style="max-height:300px; overflow-y:auto;"></div><button onclick="document.getElementById('fontModal').style.display='none'" class="btn-round" style="margin-top:10px;" data-i18n="btn_close">ë‹«ê¸°</button></div></div>
<div id="choiceModal" class="modal-bg" style="z-index: 15000;">
    <div class="modal-box" style="width: 900px; max-width: 95%;">
        
        <div class="choice-layout">
    <div class="choice-left">
        <h3 style="margin-top:0;" data-i18n="choice_modal_title">ğŸ¨ ì‘ì—… ë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
<div id="choiceProdDesc" class="info-desc-box product-desc" style="display:none;"></div>

<p style="color:#666; font-size:14px; margin-bottom:20px; line-height:1.5;" data-i18n="choice_modal_desc">
    ì„ íƒí•˜ì‹  <span id="choiceProdName" style="color:#6366f1; font-weight:bold;">ìƒí’ˆ</span>ìœ¼ë¡œ ë””ìì¸ì„ ì‹œì‘í•˜ê±°ë‚˜,<br>
    ì´ë¯¸ ì™„ì„±ëœ íŒŒì¼ì´ ìˆë‹¤ë©´ ë°”ë¡œ ì£¼ë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
</p>
<div id="extraLinksArea" style="display:flex; gap:10px; margin-bottom:15px;">
    <button id="btnGoDetail" class="btn-round" style="display:none; flex:1; background:#f8fafc; border:1px solid #cbd5e1; color:#475569; font-size:13px; height:40px; justify-content:center; align-items:center; gap:5px;">
        <i class="fa-solid fa-circle-info"></i> <span data-i18n="btn_detail_page">ìƒì„¸í˜ì´ì§€ ë³´ê¸°</span>
    </button>
    <button id="btnGoStory" class="btn-round" style="display:none; flex:1; background:#fff7ed; border:1px solid #ffedd5; color:#c2410c; font-size:13px; height:40px; justify-content:center; align-items:center; gap:5px;">
        <i class="fa-solid fa-book-open"></i> <span data-i18n="btn_story_page">ìŠ¤í† ë¦¬ ë³´ê¸°</span>
    </button>
</div>

        <div style="display:flex; gap:15px; margin-bottom:20px;">
            <button onclick="window.confirmChoice('editor')" class="btn-round primary" style="flex:1; height:120px; flex-direction:column; justify-content:center; gap:10px;">
                <i class="fa-solid fa-palette" style="font-size:32px;"></i>
                <span style="font-size:16px;" data-i18n="btn_design_direct">ì§ì ‘ ë””ìì¸í•˜ê¸°</span>
                <span style="font-size:12px; font-weight:normal; opacity:0.8;" data-i18n="btn_design_direct_sub">ì—ë””í„°ì—ì„œ ê¾¸ë¯¸ê¸°</span>
            </button>

            <button onclick="window.confirmChoice('cart')" class="btn-round" style="flex:1; height:120px; flex-direction:column; justify-content:center; gap:10px; background:#4ccc02; color:#ffffff; border:2px solid #2ec500; box-shadow:0 4px 10px rgba(74, 222, 128, 0.2);">
    <i class="fa-solid fa-basket-shopping" style="font-size:32px; color:#ffffff;"></i>
    
    <span style="font-size:16px; font-weight:800;" data-i18n="btn_purchase">êµ¬ë§¤í•˜ê¸°</span>
    <span style="font-size:12px; font-weight:normal; opacity:0.9;" data-i18n="btn_purchase_sub">íŒŒì¼ì—…ë¡œë“œëŠ” ì¥ë°”êµ¬ë‹ˆ</span>
</button>
        </div>

        <button onclick="document.getElementById('choiceModal').style.display='none'; location.reload();" class="btn-round" style="width:100%; margin-bottom:10px; background:#f1f5f9; color:#64748b; border:none;">
            <i class="fa-solid fa-arrow-left"></i> Home
        </button>

        <input type="file" id="directUploadInput" style="display:none;" accept="image/*,.pdf">
        
        <button onclick="document.getElementById('choiceModal').style.display='none'" class="btn-round" style="margin-top:auto; background:transparent; border:1px solid #ddd; color:#888;" data-i18n="btn_close">ë‹«ê¸°</button>
    </div>

    <div class="choice-right">
        <img id="choiceProductImg" src="" alt="ìƒí’ˆ ì´ë¯¸ì§€">

        <div id="customSizePanel" style="display:none; flex-direction:column; justify-content:center; height:100%; padding:20px; background:#f8fafc; border-radius:12px;">
            <h3 style="text-align:center; color:#334155; margin-top:0;">ğŸ“ ì‚¬ì´ì¦ˆ ì…ë ¥</h3>
            
            <div style="margin-bottom:15px;">
                <label style="font-weight:bold; font-size:13px; color:#64748b;">ê°€ë¡œ (Width) mm</label>
                <input type="number" id="inputCustW" class="ai-input-pretty" placeholder="ì˜ˆ: 1000" oninput="window.calcCustomPrice()">
            </div>

            <div style="margin-bottom:15px;">
                <label style="font-weight:bold; font-size:13px; color:#64748b;">ì„¸ë¡œ (Height) mm</label>
                <input type="number" id="inputCustH" class="ai-input-pretty" placeholder="ì˜ˆ: 2000" oninput="window.calcCustomPrice()">
            </div>

            <input type="hidden" id="inputCustQty" value="1">

            <div style="background:#1e293b; color:white; padding:15px; border-radius:8px; text-align:center;">
                <div style="font-size:12px; opacity:0.8;" data-i18n="label_estimate_price">ì˜ˆìƒ ê²¬ì  ê¸ˆì•¡ (1ê°œ ê¸°ì¤€)</div>
                <div id="calcResultPrice" style="font-size:24px; font-weight:800; color:#fbbf24;">0ì›</div>
                <div id="calcResultSize" style="font-size:11px; margin-top:5px; color:#94a3b8;">-</div>
            </div>
            
            <p style="font-size:12px; color:#64748b; margin-top:10px; line-height:1.5; word-break:keep-all;">
                <span data-i18n="estimate_note_1">â€» ìµœì¢… ê¸ˆì•¡ì€ ë§ˆì¼ë¦¬ì§€ ë“±ê¸‰í• ì¸ ë“±ìœ¼ë¡œ ì´ë³´ë‹¤ ë”ë”ë”! ì €ë ´í•©ë‹ˆë‹¤.</span><br>
                <b data-i18n="estimate_note_2">ìµœì¢… ê¸ˆì•¡ì€ ì¥ë°”êµ¬ë‹ˆì—ì„œ í™•ì¸í•˜ì„¸ìš”.</b>
            </p>
                
                <div id="calcResultSize" style="font-size:11px; margin-top:5px; color:#94a3b8;">-</div>
            </div>
        </div>
        </div>
</div>

    </div>
</div>
<div id="mobileControlDock" style="z-index: 30000;">
    <button onclick="window.toggleMobilePanel('left')" class="mobile-fab left">
        <i class="fa-solid fa-shapes"></i>
        <span>ê¸€ìë„í˜•</span>
    </button>

    <button onclick="window.toggleMobilePanel('right')" class="mobile-fab right">
        <i class="fa-solid fa-layer-group"></i>
        <span>í¸ì§‘/ì •ë ¬</span>
    </button>
</div>
<div id="categoryDetailModal" class="modal-bg" style="z-index: 15000;">
    <div class="modal-box" style="width: 800px; max-width: 95%; position: relative;">
        
        <button onclick="document.getElementById('categoryDetailModal').style.display='none'" 
                style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #94a3b8; z-index: 10;">
            <i class="fa-solid fa-xmark"></i>
        </button>
        <h3 id="catModalTitle">ğŸ“ ì‚¬ì´ì¦ˆ(ì œí’ˆ)ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
        
        <div style="margin-bottom: 15px; position: relative;">
            <input type="text" id="modalProdSearch" class="ai-input-pretty" 
                   data-i18n-placeholder="search_placeholder"
                   placeholder="ğŸ” Search..." 
                   style="width:100%; margin:0; padding-left: 35px;"
                   onkeyup="window.filterModalItems(this.value)">
            <i class="fa-solid fa-magnifying-glass" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8;"></i>
        </div>

        <div id="catModalDesc" class="info-desc-box" style="display:none;"></div>
        
        <div id="catProductGrid" class="quick-menu-track" style="grid-template-columns: repeat(4, 1fr);"></div>
        
        <button onclick="document.getElementById('categoryDetailModal').style.display='none'" class="btn-round" style="margin-top:20px;">ë‹«ê¸°</button>
    </div>
</div>
<div id="logoUploadModal" class="modal-bg" style="z-index: 20000;">
    <div class="modal-box" style="width: 400px;">
        <h3 style="margin-top:0;">â˜ï¸ Upload Logo</h3>
        <div class="upload-drop-zone" id="dropZone" onclick="document.getElementById('logoFileInput').click()">
            <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
            <span class="upload-text">Click or Drag</span>
            <img id="previewImage">
            <div id="removeFileBtn" onclick="window.resetUpload(event)">âœ•</div>
        </div>
        <input type="file" id="logoFileInput" accept="image/png, image/jpeg, image/svg+xml" style="display:none;" onchange="window.handleFileSelect(this)">
        <input type="text" id="logoKeywordInput" class="ai-input-pretty" placeholder="PNGë¡œê³  ë“±ë¡ì‹œ 150ì› ì¦‰ì‹œ ì§€ê¸‰ MY pageì—ì„œ í™•ì¸">
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="window.uploadUserLogo()" class="btn-round primary" style="flex:2;">Upload</button>
            <button onclick="document.getElementById('logoUploadModal').style.display='none'" class="btn-round" style="flex:1;">Cancel</button>
        </div>
    </div>
</div>


<div id="aiStartModal" class="modal-bg" style="z-index: 15000;">
    <div class="modal-box" style="width: 500px; max-width: 90%;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">âœ¨ AI ì´ë¯¸ì§€ ìƒì„± (Start)</h3>
            <button onclick="document.getElementById('aiStartModal').style.display='none'" style="border:none; background:none; cursor:pointer; font-size:20px;">âœ•</button>
        </div>
        
        <p style="color:#666; font-size:14px; margin-bottom:10px;">ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ë©´ ë‹¤ë¥¸ ìœ ì €ì—ê²Œ ìë™ìœ¼ë¡œ ê³µìœ ë˜ê³  í˜„ê¸ˆìœ¼ë¡œ ì ë¦½ë©ë‹ˆë‹¤.</p>
        
        <textarea id="aiStartPrompt" class="ai-input-pretty" placeholder="ë©‹ì§„ í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•˜ì‹œë©´ ìµœìƒìœ„ AI ëª¨ë¸ë¡œ ë©‹ì§„ ì‘í’ˆì„ ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤. ì‹œì‘í™”ë©´ìœ¼ë¡œ ê°€ì„œ ìƒˆë¡œê³ ì¹¨ í•˜ë©´ ê³ ê°ë‹˜ê»˜ì„œ ìƒì„±í•œ ë©‹ì§„ ì‘í’ˆì´ í•˜ë‹¨ì‘í’ˆì— ë“±ë¡ë˜ì–´ ìˆì„ê±°ì˜ˆìš”." style="height:100px;"></textarea>
        
        <button id="btnAiStartGen" class="btn-round primary" style="width:100%; margin-top:5px;">
            ğŸ¨ ìƒì„±í•˜ê¸°
        </button>

        <div id="aiStartResult" style="margin-top:20px; min-height:300px; background:#f8fafc; border-radius:12px; display:flex; align-items:center; justify-content:center; border:1px solid #e2e8f0;">
            <span style="color:#cbd5e1;">ì´ë¯¸ì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</span>
        </div>

        <button id="btnAiStartGo" class="btn-round" style="width:100%; margin-top:15px; display:none; background:#111; color:#fff;">
            ğŸš€ ì´ ì´ë¯¸ì§€ë¡œ ë””ìì¸ ì‹œì‘í•˜ê¸°
        </button>
    </div>
</div>
<script type="module" src="./config.js?v=119"></script>
<script type="module" src="./canvas-core.js?v=119"></script>
<script type="module" src="./canvas-size.js?v=119"></script>
<script type="module" src="./canvas-guides.js?v=119"></script>
<script type="module" src="./canvas-zoom-pan.js?v=119"></script>
<script type="module" src="./canvas-objects.js?v=119"></script>
<script type="module" src="./canvas-image.js?v=119"></script>
<script type="module" src="./canvas-template.js?v=119"></script> 
<script type="module" src="./canvas-ai.js?v=119"></script>
<script type="module" src="./canvas-utils.js?v=119"></script>
<script type="module" src="./shortcuts.js?v=119"></script>
<script type="module" src="./context-menu.js?v=119"></script>
<script type="module" src="./export.js?v=121"></script>
<script type="module" src="./order.js?v=119"></script>
<script type="module" src="./login.js?v=119"></script>
<script type="module" src="./my-design.js?v=119"></script>
<script type="module" src="./main.js?v=119"></script>

<script type="module">
    import { addNewPage, switchPage, deleteCurrentPage } from "./canvas-pages.js";
    // HTML ë²„íŠ¼ì—ì„œ onclickìœ¼ë¡œ ì“°ê¸° ìœ„í•´ ì „ì—­ ë“±ë¡
    window.addPage = addNewPage;
    window.changePage = switchPage;
    window.deletePage = deleteCurrentPage;
</script>
<script>
    // [ì¶”ê°€] ëª¨ë°”ì¼ ì „ìš© ìŠ¤ë§ˆíŠ¸ í™”ë©´ ë§ì¶¤ í•¨ìˆ˜
    // [ê°œì„ ëœ] ëª¨ë°”ì¼ ì „ìš© ìŠ¤ë§ˆíŠ¸ í™”ë©´ ë§ì¶¤ í•¨ìˆ˜
    window.smartMobileFit = function() {
        if (!window.canvas) return;
        
        // â˜… í•µì‹¬: ì¢Œí‘œê°€ í‹€ì–´ì§„ ìƒíƒœì—ì„œ ê³„ì‚°í•˜ë©´ ì—‰ëš±í•œ ê³³ìœ¼ë¡œ ê°€ë¯€ë¡œ, ì¼ë‹¨ ì´ˆê¸°í™”
        window.canvas.setViewportTransform([1, 0, 0, 1, 0, 0]); 

        // 1. ëŒ€ì§€(Board) ì°¾ê¸°
        const board = window.canvas.getObjects().find(o => o.isBoard);
        if (!board) return;

        const canvasW = window.canvas.getWidth();
        const canvasH = window.canvas.getHeight();
        const boardW = board.getScaledWidth();
        const boardH = board.getScaledHeight();

        // 2. ì•ˆì „ ì˜ì—­ (ë²„íŠ¼ í”¼í•˜ê¸°)
        const paddingX = 40;  // ì¢Œìš° ì—¬ë°±
        const paddingY = 200; // ìƒí•˜ ì—¬ë°± (í•˜ë‹¨ ë…ë°” + ìƒë‹¨ ë©”ë‰´ ê³ ë ¤ ë„‰ë„‰í•˜ê²Œ)

        // 3. ì¤Œ ê³„ì‚°
        const safeW = canvasW - paddingX;
        const safeH = canvasH - paddingY;
        let zoom = Math.min(safeW / boardW, safeH / boardH);

        // ì„¸ë¡œ ë°°ë„ˆí˜•ì¼ ê²½ìš° ë” ì‘ê²Œ (í•œëˆˆì— ë“¤ì–´ì˜¤ê²Œ)
        const isVertical = boardH > boardW * 1.2;
        if (isVertical) zoom *= 0.85; 
        else zoom *= 0.95;

        zoom = Math.min(Math.max(zoom, 0.05), 5);

        // 4. ì¤‘ì•™ ì¢Œí‘œ ê³„ì‚° (ì´ˆê¸°í™”ëœ ìƒíƒœ ê¸°ì¤€)
        const vpt = window.canvas.viewportTransform;
        vpt[0] = zoom;
        vpt[3] = zoom;
        
        // ê°€ë¡œ ì¤‘ì•™ ì •ë ¬
        vpt[4] = (canvasW - boardW * zoom) / 2;

        // ì„¸ë¡œ ì •ë ¬ (ì„¸ë¡œí˜•ì€ ìœ„ë¡œ, ì¼ë°˜í˜•ì€ ì¤‘ì•™)
        if (isVertical) {
            vpt[5] = 80; // ìƒë‹¨ ì—¬ë°± 80px ë„ìš°ê³  ë°°ì¹˜
        } else {
            vpt[5] = (canvasH - boardH * zoom) / 2 - 20; // ì¤‘ì•™ì—ì„œ ì‚´ì§ ìœ„
        }

        window.canvas.setViewportTransform(vpt);
        window.canvas.requestRenderAll();
        console.log("ğŸ“± ìŠ¤ë§ˆíŠ¸ ë§ì¶¤ ì™„ë£Œ (ì¹˜ìš°ì¹¨ ë³´ì •ë¨)");
    };
</script>
<script>
    // [ì¶”ê°€] ì‚¬ì´ë“œë°” ê²€ìƒ‰ í•¸ë“¤ëŸ¬ (0.5ì´ˆ ë”œë ˆì´)
    let sideSearchTimeout;
    window.handleSideSearch = function(keyword) {
        if (sideSearchTimeout) clearTimeout(sideSearchTimeout);
        
        sideSearchTimeout = setTimeout(() => {
            const currentKey = window.currentProductKey || 'custom';
            if (window.loadSideBarTemplates) {
                window.loadSideBarTemplates(currentKey, keyword);
            }
        }, 500);
    };
</script>
<div id="generalProductModal" class="modal-bg" style="z-index: 15500; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 900px; max-width: 95%; overflow: hidden; padding: 0; max-height: 90vh; overflow-y: auto;">
        <!-- ìƒë‹¨: ì´ë¯¸ì§€ + êµ¬ë§¤ì •ë³´ -->
        <div style="display: flex;">
            <div style="width: 45%; background: #f8fafc; display: flex; align-items: center; justify-content: center; padding: 24px; min-height: 320px;">
                <img id="genProdImg" src="" style="max-width: 100%; max-height: 350px; object-fit: contain; border-radius: 10px;">
            </div>

            <div style="width: 55%; padding: 30px; display: flex; flex-direction: column;">
                <div style="flex: 1;">
                    <h2 id="genProdTitle" style="margin: 0 0 10px 0; color: #1e293b; font-size: 22px;">ìƒí’ˆëª…</h2>
                
                <div style="background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: bold; color: #334155;">ë‹¨ê°€</span>
                        <span id="genProdPrice" style="font-weight: bold;">0ì›</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; color: #334155;">ìˆ˜ëŸ‰</span>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" id="genProdQty" value="1" min="1" 
                                   style="width: 100px; padding: 5px; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; font-weight: bold; font-size: 16px;"
                                   onclick="this.select()" 
                                   onchange="window.updateGeneralTotal()" 
                                   oninput="window.updateGeneralTotal()">
                            <span>ê°œ</span>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; border-top: 1px solid #f1f5f9; padding-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="font-size: 14px; color: #64748b;">ì´ ê²°ì œê¸ˆì•¡</span>
                    <span id="genProdTotal" style="font-size: 24px; font-weight: 900; color: #6366f1;">0ì›</span>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="window.addGeneralToCart()" class="btn-round primary" style="flex: 1; height: 50px; font-size: 16px;">
                        ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
                    </button>
                    <button onclick="document.getElementById('generalProductModal').style.display='none'" class="btn-round" style="width: 80px; border: 1px solid #e2e8f0; color: #64748b; background: white;">
                        ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>
        </div>
        <!-- í•˜ë‹¨: ìƒì„¸ì„¤ëª… ì˜ì—­ -->
        <div id="genProdDesc" style="padding: 30px; border-top: 1px solid #e2e8f0; font-size: 14px; color: #334155; line-height: 1.8;">ì„¤ëª…</div>
    </div>
</div>

<script src="./text-wizard.js?v=119"></script> 
<script>
    
    // [0] íŒŒíŠ¸ë„ˆìŠ¤ ì„¼í„° ì…ì¥ í•¨ìˆ˜ (í•­ìƒ partner.htmlë¡œ ì´ë™)
    window.enterPartnerCenter = function() {
        if (!window.currentUser) {
            alert(window.t ? window.t('msg_login_required') : "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            document.getElementById('loginModal').style.display = 'flex';
            return;
        }
        location.href = 'partner.html';
    };
    

    // [2] ê³ ê°ìš©: ë„ì°©í•œ ì…ì°°(ê²¬ì ) í™•ì¸ ë° ëª¨ë‹¬ ë„ìš°ê¸°
    window.checkBidsForOrder = async function(orderId) {
        // í•´ë‹¹ ì£¼ë¬¸ì˜ ì…ì°° ë‚´ì—­ ì¡°íšŒ
        const { data: bids, error } = await sb.from('bids')
            .select('*')
            .eq('order_id', orderId)
            .order('price', { ascending: true }); // ì €ë ´í•œ ìˆœ

        if(error || !bids || bids.length === 0) {
            alert("ì•„ì§ ë„ì°©í•œ ê²¬ì ì„œê°€ ì—†ìŠµë‹ˆë‹¤.\níŒŒíŠ¸ë„ˆì‚¬ë“¤ì´ í™•ì¸ ì¤‘ì´ë‹ˆ ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
            return;
        }

        // ëª¨ë‹¬ HTML ë™ì  ìƒì„±
        const old = document.getElementById('bidListModal');
        if(old) old.remove();

        let listHtml = '';
        bids.forEach(bid => {
            // ì„ íƒëœ ìƒíƒœì¸ì§€ í™•ì¸
            const isSelected = bid.status === 'selected';
            const bgClass = isSelected ? 'background:#f0fdf4; border-color:#bbf7d0;' : 'background:#fff;';
            
            // ë²„íŠ¼ ë˜ëŠ” ì—°ë½ì²˜ í‘œì‹œ
            let actionArea = '';
            if(isSelected) {
                actionArea = `
                    <div style="margin-top:10px; padding:10px; background:#fff; border-radius:6px; text-align:center;">
                        <div style="font-size:12px; color:#15803d; font-weight:bold;">ğŸ‰ ì‹œê³µ íŒŒíŠ¸ë„ˆë¡œ ì„ ì •ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                        <div style="font-size:16px; font-weight:800; color:#1e293b; margin-top:5px;">ğŸ“ ${bid.partner_phone}</div>
                        <button onclick="writePartnerReview('${bid.partner_id}', '${bid.order_id}')" class="btn-round" style="margin-top:8px; width:100%; height:36px; font-size:12px;">â­ ì‹œê³µì™„ë£Œ í›„ê¸° ì“°ê¸°</button>
                    </div>
                `;
            } else {
                actionArea = `<button onclick="selectBid('${bid.id}', '${bid.order_id}')" class="btn-round primary" style="width:100%; margin-top:10px;">ì´ íŒŒíŠ¸ë„ˆ ì„ íƒí•˜ê¸°</button>`;
            }

            listHtml += `
                <div style="border:1px solid #e2e8f0; padding:15px; border-radius:12px; margin-bottom:10px; ${bgClass}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold; font-size:15px;">${bid.company_name || 'íŒŒíŠ¸ë„ˆì‚¬'}</span>
                        <span style="font-weight:bold; color:#6366f1; font-size:16px;">${fmtMoney(bid.price)}</span>
                    </div>
                    <p style="font-size:13px; color:#475569; margin:10px 0; line-height:1.4;">"${bid.message}"</p>
                    ${actionArea}
                </div>
            `;
        });

        const modalHtml = `
            <div id="bidListModal" class="modal-bg" style="display:flex; z-index:20000; align-items:center; justify-content:center;">
                <div class="modal-box" style="width:400px; max-height:80vh; overflow-y:auto; background:#f8fafc;">
                    <h3 style="margin-top:0;">ğŸ“‹ ë„ì°©í•œ ê²¬ì ì„œ (${bids.length}ê±´)</h3>
                    <p style="color:#666; font-size:13px; margin-bottom:15px;">ë§ˆìŒì— ë“œëŠ” íŒŒíŠ¸ë„ˆë¥¼ ì„ íƒí•˜ì—¬ ê³µì‚¬ë¥¼ ì§„í–‰í•˜ì„¸ìš”.</p>
                    <div>${listHtml}</div>
                    <button onclick="document.getElementById('bidListModal').remove()" class="btn-round" style="width:100%; margin-top:15px; background:#e2e8f0; color:#334155; border:none;">ë‹«ê¸°</button>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    };

    // [3] íŒŒíŠ¸ë„ˆ ì„ íƒ í•¨ìˆ˜
    window.selectBid = async function(bidId, orderId) {
        // [ìˆ˜ì •] ë‹¤êµ­ì–´ ì ìš©
        if(!confirm(window.t('confirm_select_partner', "Select this partner?\nContact info will be revealed and other bids will be closed."))) return;

        // 1. í•´ë‹¹ ì…ì°° ìŠ¹ì¸
        await sb.from('bids').update({ status: 'selected' }).eq('id', bidId);
        // 2. ë‚˜ë¨¸ì§€ëŠ” ê±°ì ˆ ì²˜ë¦¬
        await sb.from('bids').update({ status: 'rejected' }).eq('order_id', orderId).neq('id', bidId);
        // 3. ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ (ì œì‘ì¤€ë¹„)
        await sb.from('orders').update({ status: 'ì œì‘ì¤€ë¹„' }).eq('id', orderId);

        alert("âœ… íŒŒíŠ¸ë„ˆ ì„ íƒ ì™„ë£Œ! ì—°ë½ì²˜ë¥¼ í™•ì¸í•˜ì—¬ ì¼ì •ì„ ì¡°ìœ¨í•˜ì„¸ìš”.");
        document.getElementById('bidListModal').remove();
        checkBidsForOrder(orderId); // ëª¨ë‹¬ ë‹¤ì‹œ ì—´ì–´ì„œ ê²°ê³¼ ë³´ì—¬ì¤Œ
    };

    // [4] í›„ê¸° ì‘ì„± í•¨ìˆ˜
    window.writePartnerReview = async function(partnerId, orderId) {
        const rating = prompt("í‰ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (1~5ì ):", "5");
        if(!rating) return;
        const comment = prompt("íŒŒíŠ¸ë„ˆì— ëŒ€í•œ ì†”ì§í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”:", "ì¹œì ˆí•˜ê³  ê¼¼ê¼¼í•˜ê²Œ ì‘ì—…í•´ì£¼ì…¨ìŠµë‹ˆë‹¤!");
        if(!comment) return;

        const { data: { user } } = await sb.auth.getUser();
        const { error } = await sb.from('partner_reviews').insert({
            partner_id: partnerId,
            order_id: orderId,
            customer_id: user.id,
            rating: parseInt(rating),
            comment: comment
        });

        if(error) alert(window.t('msg_failed', "Failed: ") + error.message);
        else alert(window.t('msg_review_saved', "Review saved!"));
    };
</script>

</body>
</html>

<script type="module">
    // â˜… ì—¬ê¸° íŒŒì¼ëª… ë’¤ì— ?v=119 ë¥¼ ê¼­ ë¶™ì—¬ì•¼ ìºì‹œê°€ ê¹¨ì§‘ë‹ˆë‹¤!
    import { canvas, setMaxLimits } from './canvas-core.js?v=119';
    import { openProductDetail, startDesignFromProduct, addProductToCartDirectly } from './order.js?v=119'; // [ìˆ˜ì •] í•¨ìˆ˜ ì¶”ê°€ë¨
    import { applySize } from './canvas-size.js?v=119';
    import { sb, PRODUCT_DB, cartData, currentUser, initConfig, getLocalizedData } from './config.js?v=119';

    // -----------------------------------------------------------
    // [1] ì „ì—­ ë³€ìˆ˜ ë° í—¬í¼ í•¨ìˆ˜ ì„¤ì •
    // -----------------------------------------------------------
    // -----------------------------------------------------------
    // [1] ì „ì—­ ë³€ìˆ˜ ë° í—¬í¼ í•¨ìˆ˜ ì„¤ì •
    // -----------------------------------------------------------
    // í†µí™” í™˜ì‚° í—¬í¼ (KRW â†’ í˜„ì§€ í†µí™”)
    function fmtMoney(krw) {
        const cfg = window.SITE_CONFIG || {};
        const country = cfg.COUNTRY || 'KR';
        const rate = (cfg.CURRENCY_RATE && cfg.CURRENCY_RATE[country]) || 1;
        const converted = (krw || 0) * rate;
        if (country === 'JP') return 'Â¥' + Math.floor(converted).toLocaleString();
        if (country === 'US') return '$' + converted.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
        return converted.toLocaleString() + 'ì›';
    }
    // ì´ë¯¸ í˜„ì§€ í†µí™”ì¸ ê¸ˆì•¡ì— ì‹¬ë³¼ë§Œ ë¶™ì´ê¸° (í™˜ì‚° ë¶ˆí•„ìš”)
    function fmtLocal(amt) {
        const country = (window.SITE_CONFIG || {}).COUNTRY || 'KR';
        if (country === 'JP') return 'Â¥' + Math.floor(amt).toLocaleString();
        if (country === 'US') return '$' + (amt||0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
        return (amt||0).toLocaleString() + 'ì›';
    }

    window.canvas = canvas;
    window.sb = sb; // â˜… [í•µì‹¬] ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë„êµ¬ ì „ì—­ ë“±ë¡
    // index.html ë‚´ë¶€ ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì •

window.getTinyThumb = function(url, size = 150) {
    if (!url) return '';
    
    // 1. Base64 ë°ì´í„°ëŠ” ê·¸ëŒ€ë¡œ ë°˜í™˜
    if (url.startsWith('data:image')) return url;

    // [â˜…ìˆ˜ì •] ì´ë¯¸ Supabase ë¦¬ì‚¬ì´ì§• ì˜µì…˜ì´ ë¶™ì–´ìˆë‹¤ë©´ ì›ë³¸ ê·¸ëŒ€ë¡œ ë°˜í™˜ (ì¤‘ë³µ ë°©ì§€)
    if (url.includes('width=') && url.includes('resize=')) {
        return url;
    }

    // 2. URL íŒŒë¼ë¯¸í„° ì—°ê²°ì ê²°ì •
    const separator = url.includes('?') ? '&' : '?';

    // 3. ë¦¬ì‚¬ì´ì§• íŒŒë¼ë¯¸í„° ì¶”ê°€
    return `${url}${separator}width=${size}&height=${size}&resize=cover&quality=50&format=webp`;
};
    window.openProductDetail = openProductDetail;
    window.startDesignFromProduct = startDesignFromProduct;
    window.applySize = applySize;
    window.currentProductKey = 'A4';
    let selectedProductForChoice = null;

    // -----------------------------------------------------------
    // [2] í†µí•© ì–¸ì–´ ê°ì§€ ë° SEO ìë™ ì„¤ì • (í•µì‹¬ ë¡œì§)
    // -----------------------------------------------------------
    // [2] ì–¸ì–´ ê°ì§€ ë° ì„¤ì • (ìˆ˜ì •ë¨)
    const urlParams = new URLSearchParams(window.location.search);
    let detectedLang = urlParams.get('lang');

    // 1. íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ë„ë©”ì¸ìœ¼ë¡œ íŒë‹¨
    if (!detectedLang) {
        const hostname = window.location.hostname;
        if (hostname.includes('cafe3355.com')) {
            detectedLang = 'en'; // ì˜ì–´ ë„ë©”ì¸
        } else if (hostname.includes('cafe0101.com')) {
            detectedLang = 'ja'; // ì¼ë³¸ì–´ ë„ë©”ì¸
        } else {
            detectedLang = 'kr'; // ê·¸ ì™¸ í•œêµ­ì–´
        }
    }
    
    // ì–¸ì–´ ì½”ë“œ ì†Œë¬¸ìë¡œ í†µì¼
    let CURRENT_LANG = detectedLang ? detectedLang.toLowerCase() : 'kr';
    if (CURRENT_LANG === 'jp') CURRENT_LANG = 'ja';
    if (CURRENT_LANG === 'us') CURRENT_LANG = 'en';

    console.log(`ğŸŒ ì ‘ì† ëª¨ë“œ: ${CURRENT_LANG} (Domain: ${window.location.hostname})`);

    // ë©”íƒ€íƒœê·¸ ì—…ë°ì´íŠ¸
    function updateSEOMetaTags(lang) {
        const metaData = {
            'kr': { title: "ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ…", desc: "ë¬´ë£Œ ë””ìì¸ ì—ë””í„°" },
            'en': { title: "Chameleon Printing", desc: "Free Design Editor" },
            'ja': { title: "ã‚«ãƒ¡ãƒ¬ã‚ªãƒ³ãƒ—ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°", desc: "ç„¡æ–™ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿" }
        };
        const data = metaData[lang] || metaData['kr'];
        document.title = data.title;
        document.documentElement.setAttribute('lang', lang);
    }
    updateSEOMetaTags(CURRENT_LANG);

    window.translations = {};

// â˜… [ì‹ ê·œ ì¶”ê°€] ì „ì—­ ë²ˆì—­ í—¬í¼ í•¨ìˆ˜
window.t = function(key, fallback) {
    if (window.translations && window.translations[key]) {
        return window.translations[key];
    }
    return fallback || key;
};

    async function loadAndApplyTranslations() {
        // â˜… ì¤‘ìš”: long í´ë”ê°€ ì—†ë‹¤ë©´ 'long/'ì„ ì§€ìš°ì„¸ìš”. íŒŒì¼ëª… ë’¤ì— ì‹œê°„ì„ ë¶™ì—¬ ìºì‹œë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
        const jsonPath = `long/${CURRENT_LANG}_${PROJECT_VERSION}.json?t=${new Date().getTime()}`;
        
        console.log(`ğŸ“‚ ë²ˆì—­ íŒŒì¼ ë¡œë”©: ${jsonPath}`);

        try {
            const response = await fetch(jsonPath);
            // íŒŒì¼ì´ ì—†ìœ¼ë©´ ì—ëŸ¬ ë°œìƒ
            if (!response.ok) throw new Error(`File not found (${response.status})`);
            
            const langData = await response.json();
            window.translations = langData; 

            // index.html ë‚´ ë²ˆì—­ ì ìš© ë¶€ë¶„ ìˆ˜ì •
// index.html í•˜ë‹¨ loadAndApplyTranslations í•¨ìˆ˜ ë‚´ì˜ ë£¨í”„ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ êµì²´
document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (langData[key]) {
        const icon = el.querySelector('i'); // ê¸°ì¡´ ì•„ì´ì½˜(<i>) ë³´ì¡´
        
        if (icon) {
            el.innerHTML = ''; 
            el.appendChild(icon); 
            // íƒœê·¸ê°€ ì„ì¸ ë²ˆì—­ ë°ì´í„°ë„ ì •ìƒ ì¶œë ¥ë˜ë„ë¡ innerHTML ì‚¬ìš©
            const textSpan = document.createElement('span');
            textSpan.innerHTML = ' ' + langData[key]; 
            el.appendChild(textSpan);
        } else {
            // ì¼ë°˜ ìš”ì†Œë„ íƒœê·¸ê°€ ì½”ë“œë¡œ ë³´ì´ì§€ ì•Šê²Œ innerHTMLë¡œ ì‚½ì…
            el.innerHTML = langData[key]; 
        }
    }
});
// placeholder ë²ˆì—­
document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (langData[key]) el.setAttribute('placeholder', langData[key]);
});
// title ë²ˆì—­
document.querySelectorAll('[data-i18n-title]').forEach(el => {
    const key = el.getAttribute('data-i18n-title');
    if (langData[key]) el.setAttribute('title', langData[key]);
});
            // ë²„íŠ¼ ê°•ì œ ë²ˆì—­
            const loginBtn = document.getElementById('btnLoginBtn');
            if (loginBtn && langData['btn_login']) loginBtn.innerText = langData['btn_login'];
            
            // ì¹´ì¹´ì˜¤ ë²„íŠ¼ ìˆ¨ê¹€ (í•œêµ­ì–´ ì•„ë‹ ë•Œ)
            const kakaoBtn = document.getElementById('btnKakaoLogin');
            if (kakaoBtn) kakaoBtn.style.display = (CURRENT_LANG === 'kr') ? 'flex' : 'none';

            loadLanguageFont(); // í°íŠ¸ ì ìš©

        } catch (error) {
            console.error(`ğŸš¨ ë²ˆì—­ ë¡œë“œ ì‹¤íŒ¨ (${CURRENT_LANG}):`, error);
            // ì˜ì–´/ì¼ë³¸ì–´ íŒŒì¼ì´ ì—†ì„ ë•Œë§Œ í•œêµ­ì–´ë¡œ ìë™ ì „í™˜ (ë¬´í•œë£¨í”„ ë°©ì§€)
            if (CURRENT_LANG !== 'kr') {
                console.warn("âš ï¸ í•œêµ­ì–´ë¡œ ì „í™˜í•©ë‹ˆë‹¤.");
                CURRENT_LANG = 'kr';
                loadAndApplyTranslations();
            }
        }
    }

    function loadLanguageFont() {
        const head = document.getElementsByTagName('head')[0];
        let fontLink = document.createElement('link');
        fontLink.rel = 'stylesheet';
        let fontFamily = "'Pretendard', sans-serif";

        if (CURRENT_LANG === 'ja') {
            fontLink.href = 'https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap';
            fontFamily = "'Noto Sans JP', sans-serif";
            window.currentCanvasFont = 'Noto Sans JP';
        } else if (CURRENT_LANG === 'en') {
            fontLink.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap';
            fontFamily = "'Inter', sans-serif";
            window.currentCanvasFont = 'Inter';
        } else {
            fontLink.href = 'https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css';
            window.currentCanvasFont = 'Pretendard';
        }

        head.appendChild(fontLink);
        const style = document.createElement('style');
        style.innerHTML = `body, button, input, select, textarea { font-family: ${fontFamily} !important; }`;
        head.appendChild(style);
    }
    
    // ë²ˆì—­ ì‹¤í–‰
    loadAndApplyTranslations();

    // -----------------------------------------------------------
    // [4] í…œí”Œë¦¿ í´ë¦­ & í•„í„°ë§ í•¨ìˆ˜ (ê¸°ì¡´ ê¸°ëŠ¥ ë³µêµ¬)
    // -----------------------------------------------------------
    window.onTemplateClick = async function(tpl) {
        const startScreen = document.getElementById('startScreen');
        const isStartScreenVisible = startScreen && window.getComputedStyle(startScreen).display !== 'none';

        if (isStartScreenVisible) {
            document.getElementById('templateOverlay').style.display = 'none';
            window.pendingTemplate = tpl;
            if (window.showCategorySelectionModal) window.showCategorySelectionModal();
            else alert(window.t('msg_invalid_size'));
        } else {
            if(!confirm(window.t('msg_template_apply_confirm'))) return;
            document.getElementById('templateOverlay').style.display = 'none';
            await window.applyTemplateDirectly(tpl);
        }
    };

    // [ì „ì—­] í˜„ì¬ ê·¸ë£¹ ê¸°ì–µ
    window.currentTplGroup = 'group_template';

    window.filterTpl = async function(category, btnElement) {
        // 1. ë²„íŠ¼ ìŠ¤íƒ€ì¼ í™œì„±í™”
        if (btnElement) {
            // ìƒë‹¨ë°” ë²„íŠ¼ì¸ì§€ ì‚¬ì´ë“œë°” ë²„íŠ¼ì¸ì§€ í™•ì¸ í›„ ìŠ¤íƒ€ì¼ ì ìš©
            const sidebar = document.querySelector('.tpl-sidebar');
            if(sidebar) {
                // ì‚¬ì´ë“œë°” ë²„íŠ¼ë“¤ ì´ˆê¸°í™”
                sidebar.querySelectorAll('.tpl-cate-btn').forEach(b => b.classList.remove('active'));
                
                // ë§Œì•½ í´ë¦­í•œ ë²„íŠ¼ì´ ì‚¬ì´ë“œë°” ì•ˆì— ìˆë‹¤ë©´ active ì¶”ê°€
                if(sidebar.contains(btnElement)) {
                    btnElement.classList.add('active');
                } else {
                    // ìƒë‹¨ë°” ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì‚¬ì´ë“œë°”ë„ ë§ì¶°ì£¼ê¸°
                    const targetBtn = sidebar.querySelector(`button[onclick*="'${category}'"]`);
                    if(targetBtn) targetBtn.classList.add('active');
                }
            }
            window.currentTplGroup = category;
        }

        // ê²€ìƒ‰ì–´ ë° íƒ€ê²Ÿ ê·¸ë£¹ ì„¤ì •
        const searchInput = document.getElementById('tplSearchInput');
        const searchKeyword = searchInput ? searchInput.value.trim() : "";
        const targetGroup = category || window.currentTplGroup;

        const grid = document.getElementById('tplGrid');
        if (!grid) return;
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px;"><i class="fa-solid fa-spinner fa-spin" style="font-size:30px; color:#6366f1;"></i></div>';

        if (!sb) { grid.innerHTML = ''; return; }
        try {
            // â˜… [í•µì‹¬ ìˆ˜ì •] ë²¡í„°(vector, user_vector)ë¥¼ ê°ì²´(group_asset)ë¡œ ì´ë™!
            const groups = {
                // í…œí”Œë¦¿: ì‚¬ì§„, ìœ ì €ì´ë¯¸ì§€, í…ìŠ¤íŠ¸ (ë°°ê²½í˜•)
                'group_template': ['user_image', 'photo-bg', 'text'],

                // ê°ì²´: ë²¡í„°, ìœ ì €ë²¡í„°, ê·¸ë˜í”½, íŒ¨í„´, ë¡œê³  (ìš”ì†Œí˜•)
                'group_asset': ['vector', 'user_vector', 'graphic', 'transparent-graphic', 'pattern', 'logo']
            };

            // ì¿¼ë¦¬ ì‘ì„±
            let query = sb.from('library')
              .select('id, thumb_url, category, tags, product_key') 
              .order('created_at', { ascending: false })
              .limit(60); 

            // ê·¸ë£¹ í•„í„°ë§
            if (groups[targetGroup]) {
                query = query.in('category', groups[targetGroup]);
            } else if (targetGroup && targetGroup !== 'all') {
                query = query.eq('category', targetGroup);
            }

            // ê²€ìƒ‰ì–´ í•„í„°ë§
            if (searchKeyword) {
                query = query.ilike('tags', `%${searchKeyword}%`);
            }

            const { data, error } = await query;
            if (error) throw error;

            grid.innerHTML = '';
            if (!data || data.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; color:#999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            data.forEach(tpl => {
                const div = document.createElement('div');
                div.className = 'tpl-item';
                div.style.cssText = 'cursor:pointer; position:relative; overflow:hidden; border-radius:8px; aspect-ratio:1/1; background:#f1f5f9; border:1px solid #e2e8f0;';
                
                let imgSrc = tpl.thumb_url || 'https://via.placeholder.com/300';
                if (imgSrc.includes('supabase.co')) {
                    const sep = imgSrc.includes('?') ? '&' : '?';
                    imgSrc += `${sep}width=300&height=300&resize=cover&quality=60`;
                }

                // ë±ƒì§€ í‘œì‹œ (ë²¡í„°ì¸ì§€ í™•ì¸ìš©)
                let badge = '';
                if(tpl.category === 'vector' || tpl.category === 'user_vector') {
                    badge = `<span style="position:absolute; top:5px; left:5px; background:#7c3aed; color:white; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold;">VECTOR</span>`;
                }

                div.innerHTML = `
                    ${badge}
                    <img src="${imgSrc}" loading="lazy" style="width:100%; height:100%; object-fit:contain;">
                `;
                div.onclick = () => window.onTemplateClick(tpl);
                grid.appendChild(div);
            });

        } catch (e) {
            console.error("Load Error:", e);
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">ì˜¤ë¥˜ ë°œìƒ</div>';
        }
    };

    // -----------------------------------------------------------
    // [5] ì´ˆê¸°í™” (Load Event)
    // -----------------------------------------------------------
    window.addEventListener('load', async () => {
        if (window.initConfig) await window.initConfig(); 
        else if (typeof initConfig === 'function') await initConfig();

        updateLoginButtonState();

        // â˜… [ì¤‘ìš”] ì•„ë˜ì— ìˆëŠ” í•¨ìˆ˜ë“¤ì„ ì—¬ê¸°ì„œ í˜¸ì¶œí•˜ì—¬ í™”ë©´ì„ ê·¸ë¦½ë‹ˆë‹¤.
        if (typeof renderQuickMenu === 'function') renderQuickMenu();
        
        if(window.searchTemplates) window.searchTemplates('');
        if (window.preloadLanguageFont) window.preloadLanguageFont();
        if (typeof loadSpecialProducts === 'function') {
            loadSpecialProducts('hotDealSection', 'hotDealGrid', 'hotdeal', 6);
            loadSpecialProducts('bizDealSection', 'bizDealGrid', '23432424', 6);
        }

        const searchBtn = document.getElementById('btnStartSearch');
        const searchInput = document.getElementById('startSearchInput');
        if (searchBtn && searchInput) {
            const doSearch = () => { 
                // ëª¨ë°”ì¼ í‚¤ë³´ë“œ ë‹«ê¸° (UX ê°œì„ )
                searchInput.blur();
                if(window.searchTemplates) window.searchTemplates(searchInput.value); 
            };
            
            searchBtn.onclick = doSearch;
            
            // [ìˆ˜ì •] ëª¨ë°”ì¼ í˜¸í™˜ì„±ì„ ìœ„í•´ keydown ì‚¬ìš© & ì—”í„°í‚¤ ì²˜ë¦¬ ê°•í™”
            searchInput.addEventListener('keydown', (e) => { 
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault(); // í¼ ìë™ì œì¶œ ë°©ì§€
                    doSearch(); 
                }
            });
        }
        
        document.getElementById("loading").style.display = "none";
    });

    function updateLoginButtonState() {
        const btnLogin = document.getElementById('btnLoginBtn');
        const btnConsole = document.getElementById('btnPartnerConsole');
        if (window.currentUser) {
            if (btnLogin) {
                // [ìˆ˜ì •] ë‹¤êµ­ì–´ ì ìš©
                btnLogin.innerText = window.t('btn_logout'); 
                btnLogin.style.fontWeight = "bold"; 
                btnLogin.style.color = "#ef4444"; 
                const newBtn = btnLogin.cloneNode(true);
                btnLogin.parentNode.replaceChild(newBtn, btnLogin);
                newBtn.onclick = async function() {
                    // [ìˆ˜ì •] ë‹¤êµ­ì–´ ì ìš©
                    if (confirm(window.t('msg_logout_confirm'))) {
                        if(typeof sb !== 'undefined') await sb.auth.signOut();
                        localStorage.removeItem('sb-qinvtnhiidtmrzosyvys-auth-token'); 
                        window.location.reload(); 
                    }
                };
            }
            if(btnConsole) btnConsole.style.removeProperty('display');
        } else {
            if (btnLogin) {
                // [ìˆ˜ì •] ë‹¤êµ­ì–´ ì ìš©
                btnLogin.innerText = window.t('btn_login');
                btnLogin.style.fontWeight = "normal";
                btnLogin.style.color = "";
                const newBtn = btnLogin.cloneNode(true);
                btnLogin.parentNode.replaceChild(newBtn, btnLogin);
                newBtn.onclick = () => document.getElementById('loginModal').style.display = 'flex';
            }
            if(btnConsole) btnConsole.style.setProperty('display', 'none', 'important');
        }
    }

    // ë§ˆì´í˜ì´ì§€ ë³µêµ¬ ë¡œì§
    const loadId = localStorage.getItem('load_design_id');
    if (loadId) {
        localStorage.removeItem('load_design_id');
        setTimeout(async () => {
            const loading = document.getElementById('loading');
            if(loading) loading.style.display = 'flex';
            try {
                if (!sb) throw new Error("DB ì—°ê²°ì´ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                const { data, error } = await sb.from('user_designs').select('*').eq('id', loadId).single();
                if (error || !data) throw new Error("ë””ìì¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                if (data.json && !data.json_data) data.json_data = data.json;

                document.getElementById("startScreen").style.display = "none";
                document.getElementById("mainEditor").style.display = "flex";
                document.body.classList.add('editor-active');

                if (window.restoreDesignFromData) window.restoreDesignFromData(data);
            } catch (e) {
                console.error(e);
                alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + e.message);
                if(loading) loading.style.display = 'none';
            }
        }, 800);
    }

    // PDF í°íŠ¸ ì„¤ì •
    window.pdfFontCache = null;
    window.pdfFontName = 'NanumGothic'; 
    // (PDF í°íŠ¸ëŠ” ë‘ë²ˆì§¸ preloadLanguageFontì—ì„œ ì²˜ë¦¬)

    // PDF.js ì›Œì»¤ ì„¤ì •
    if (window.pdfjsLib) window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // [ì¶”ê°€] í•«ë”œ ë Œë”ë§ í•¨ìˆ˜
    // [ìƒˆë¡œìš´ í†µí•© í•¨ìˆ˜] ì¼ë°˜ í•«ë”œ + ì—…ììš© í•«ë”œ ëª¨ë‘ ì²˜ë¦¬
    // [ìˆ˜ì •ë¨] í•«ë”œ ìƒí’ˆ ë¡œë“œ (ì–¸ì–´/í™”í ê°ì§€ ì¶”ê°€)
// [ìµœì í™”ë¨] í•«ë”œ/ì¶”ì²œìƒí’ˆ ë¡œë“œ (ì–¸ì–´ ë¡œì§ ì œê±°ë¨ -> getLocalizedData ìœ„ì„)
async function loadSpecialProducts(sectionId, gridId, categoryCode, limitCount = 6) {
    const section = document.getElementById(sectionId);
    const grid = document.getElementById(gridId);
    if (!grid) return;
    if (!sb) { console.warn("[loadSpecialProducts] sbê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ"); return; }

    try {
        const { data: products, error } = await sb.from('admin_products')
            .select('*')
            .eq('category', categoryCode)
            .order('sort_order', { ascending: true }) 
            .limit(limitCount); 

        if (error) throw error;

        if (!products || products.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        grid.innerHTML = '';

        products.forEach(p => {
            if (!window.PRODUCT_DB) window.PRODUCT_DB = {};
            
            // â˜… [í•µì‹¬] ì—¬ê¸°ì„œ ì§€ì €ë¶„í•œ ifë¬¸ì„ ì‹¹ ì œê±°í•˜ê³  í•œ ì¤„ë¡œ ëëƒ…ë‹ˆë‹¤!
            const { name, price, formattedPrice } = getLocalizedData(p);
            
            // ì „ì—­ DB ì €ì¥ (ì—ë””í„° ì—°ë™ìš©)
            window.PRODUCT_DB[p.code] = {
                name: name,
                price: price,
                w: p.width_mm, h: p.height_mm,
                img: p.img_url,
                addons: p.addons ? p.addons.split(',') : [],
                category: p.category
            };

            const card = document.createElement('div');
            card.className = 'hotdeal-card';
            const imgSrc = p.img_url || 'https://via.placeholder.com/300?text=No+Image';
            const sizeText = (p.width_mm && p.height_mm) ? `${p.width_mm} x ${p.height_mm}mm` : 'Option';
            
            // ë±ƒì§€ ìƒ‰ìƒ
            const badgeColor = categoryCode === 'hotdeal' ? '#ef4444' : '#4f46e5';
            const badgeText = categoryCode === 'hotdeal' ? 'HOT' : 'BIZ';

            // HTML ìƒì„± (ì´ì œ nameê³¼ formattedPrice ë³€ìˆ˜ë§Œ ë„£ìœ¼ë©´ ë)
            card.innerHTML = `
                <div class="hotdeal-img-box">
                    <img src="${imgSrc}" alt="${name}" onerror="this.src='https://placehold.co/300?text=No+Img'">
                    <div style="position:absolute; top:10px; left:10px; background:${badgeColor}; color:white; font-size:11px; font-weight:bold; padding:2px 8px; border-radius:4px;">${badgeText}</div>
                </div>
                <div class="hotdeal-info">
                    <div class="hotdeal-title">${name}</div>
                    <div class="hotdeal-meta">${sizeText}</div>
                    <div class="hotdeal-price">${formattedPrice}</div>
                </div>
            `;

            card.onclick = () => {
                window.loadProductDetailAndOpen(p.code);
            };

            grid.appendChild(card);
        });

    } catch (e) {
        console.error(`[${categoryCode}] ë¡œë”© ì‹¤íŒ¨:`, e);
        section.style.display = 'none';
    }
}

    window.goBoardWithCategory = function(boardType, subCode, subName) {
        const hostname = window.location.hostname;
        let targetCountry = 'KR';
        if (hostname.includes('cafe3355.com')) targetCountry = 'US';
        else if (hostname.includes('cafe0101.com')) targetCountry = 'JP';

        // í•´ë‹¹ ì†Œë¶„ë¥˜ ì½”ë“œ(sub_code)ì™€ ì´ë¦„(sub_name)ì„ ë‹¬ê³  ìƒˆ ì°½ ì—´ê¸°
        const url = `/board.html?cat=${boardType}&country=${targetCountry}&sub_code=${encodeURIComponent(subCode)}&sub_name=${encodeURIComponent(subName)}`;
        window.open(url, '_blank');
    };
    window.openTopMenu = async function(topCode, titleText) {
        if (!sb) { console.warn("[openTopMenu] sbê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ"); return; }
        const modal = document.getElementById('categoryDetailModal');
        const grid = document.getElementById('catProductGrid');
        const titleEl = document.getElementById('catModalTitle');
        const descEl = modal.querySelector('p');

        // 1. ëª¨ë‹¬ ì°½ ì—´ê¸° & ë¡œë”© í‘œì‹œ
        modal.style.display = 'flex';
        if(titleEl) titleEl.innerHTML = `<span style="color:#6366f1;">${titleText}</span> <span style="font-size:14px; color:#888; font-weight:normal;">(ì„¸ë¶€ í•­ëª© ì„ íƒ)</span>`;
        if(descEl) descEl.innerText = "ì›í•˜ì‹œëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.";

        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px;">Loading...</div>';

        try {
            // 2. í•´ë‹¹ ë©”ë‰´ì˜ í•˜ìœ„ ì¹´í…Œê³ ë¦¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const { data: subCats } = await sb.from('admin_categories')
                .select('*')
                .eq('top_category_code', topCode) 
                .order('sort_order', { ascending: true });

            // ì¹´í…Œê³ ë¦¬ê°€ ì•„ì˜ˆ ì—†ìœ¼ë©´ -> ë°”ë¡œ ìƒí’ˆ ëª©ë¡ ë³´ì—¬ì£¼ê¸°ë¡œ ë„˜ì–´ê°
            if (!subCats || subCats.length === 0) {
                 window.showCategoryProducts(topCode, titleText);
                 return;
            }

            // 3. â˜… [í•µì‹¬] ë¹ˆ ì´ë¯¸ì§€ë¥¼ ì±„ìš°ê¸° ìœ„í•´ ìƒí’ˆ ì´ë¯¸ì§€ ë¯¸ë¦¬ ê°€ì ¸ì˜¤ê¸°
            const { data: prodImages } = await sb.from('admin_products')
                .select('category, img_url')
                .not('img_url', 'is', null) // ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²ƒë§Œ
                .neq('img_url', '');

            // "ì¹´í…Œê³ ë¦¬ ì½”ë“œ" : "ìƒí’ˆ ì´ë¯¸ì§€ URL" í˜•íƒœë¡œ ì •ë¦¬ (ë§¤í•‘)
            const catThumbMap = {};
            if (prodImages) {
                prodImages.forEach(p => {
                    // ì•„ì§ ì´ ì¹´í…Œê³ ë¦¬ì— í• ë‹¹ëœ ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´, ì²«ë²ˆì§¸ ë°œê²¬ëœ ìƒí’ˆ ì´ë¯¸ì§€ë¥¼ ë“±ë¡
                    if (p.category && !catThumbMap[p.category]) {
                        catThumbMap[p.category] = p.img_url;
                    }
                });
            }

            grid.innerHTML = '';

            // 4. í™”ë©´ì— ë²„íŠ¼ë“¤ ê·¸ë¦¬ê¸°
            subCats.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'quick-item';
                div.style.cursor = 'pointer';

                // ì›ë³¸ URL ê°€ì ¸ì˜¤ê¸°
let rawUrl = cat.img_url || cat.image || cat.thumbnail || catThumbMap[cat.code] || '';
// ë¦¬ì‚¬ì´ì§• í•¨ìˆ˜ ì ìš© (150px)
let iconUrl = window.getTinyThumb(rawUrl, 150);
                
                let imgTag = '';
                if (iconUrl) {
                    imgTag = `<img src="${iconUrl}" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentNode.innerHTML='<i class=\\'fa-solid fa-folder-open\\'></i>'">`;
                } else {
                    imgTag = `<i class="fa-solid fa-folder-open" style="font-size:24px; color:#cbd5e1;"></i>`;
                }

                div.innerHTML = `
                    <div class="quick-icon" style="background:#fff; border:1px solid #f1f5f9; overflow:hidden; display:flex; align-items:center; justify-content:center;">
                        ${imgTag}
                    </div>
                    <div class="quick-text">${cat.name}</div>
                `;

                // í´ë¦­í•˜ë©´ ìƒí’ˆ ëª©ë¡ìœ¼ë¡œ ì´ë™
                div.onclick = () => {
                    window.showCategoryProducts(cat.code, cat.name);
                };

                grid.appendChild(div);
            });

        } catch (e) {
            console.error("ìƒë‹¨ ë©”ë‰´ ë¡œë”© ì—ëŸ¬:", e);
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
        }
    };
// =================================================================
// [ìµœì¢… ìˆ˜ì •] ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§ (ìƒí’ˆëª…/ì´ë¯¸ì§€/ë³„ì  ì™„ë²½ ë³µêµ¬)
// =================================================================
let globalSubCats = [];      // ì¹´í…Œê³ ë¦¬ ë°ì´í„°
let globalProdImages = [];   // ìƒí’ˆ ë°ì´í„° (ê²€ìƒ‰ìš©)
let globalCatThumbMap = {};  // ì¸ë„¤ì¼ ë§¤í•‘ ì „ì—­ ë³€ìˆ˜

// [ìµœì¢… ìˆ˜ì •] ì•ˆë‚´ ë¬¸êµ¬ ì‚­ì œ ë° ì¹¸ ë„“ì´(ë†’ì´) ìµœì†Œí™”
window._drawQuickItems = (list, isProductMode = false) => {
    const itemContainer = document.getElementById('quickMenuContainer');
    if (!itemContainer) return;
    
    // 1. ê²°ê³¼ê°€ ì—†ê±°ë‚˜ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì„ ë•Œ (ì¹¸ì„ í™• ì¢í˜)
    if (!list || !Array.isArray(list) || list.length === 0) {
        itemContainer.innerHTML = ''; // ë¬¸êµ¬ ì™„ì „ ì‚­ì œ
        // ì˜ì—­ì˜ ë†’ì´ë¥¼ 20pxë¡œ í™• ì¢í˜€ì„œ í—ˆì „í•¨ì„ ë°©ì§€ (ìœ„ì•„ë˜ ì—¬ë°±ë§Œ ìœ ì§€)
        itemContainer.style.minHeight = '20px'; 
        itemContainer.style.padding = '0';
        return;
    }

    // 2. ê²°ê³¼ê°€ ìˆì„ ë•Œ ê¸°ì¡´ ë Œë”ë§ ë¡œì§ (ë†’ì´ ìë™ ë³µêµ¬)
    itemContainer.style.minHeight = 'auto'; 
    itemContainer.style.padding = '20px 0'; // í•„ìš”ì‹œ ì›ë˜ íŒ¨ë”©ê°’ìœ¼ë¡œ ì¡°ì ˆ
    itemContainer.innerHTML = '';
    
    list.forEach(item => {
        const isProduct = isProductMode || item.price !== undefined;
        
        // [ìˆ˜ì •] ì–¸ì–´ë³„ ì´ë¦„ ì ìš© (ì´ ì½”ë“œê°€ ëª¨ë‹¬ ì œëª©ê¹Œì§€ í•´ê²°í•©ë‹ˆë‹¤)
        let name = item.name || '';
        if (CURRENT_LANG === 'ja' && item.name_jp) name = item.name_jp;
        if (CURRENT_LANG === 'en' && item.name_us) name = item.name_us;

        const itemCode = item.code || '';
        
        let rawUrl = item.img_url || item.image || item.thumbnail;
        if (!rawUrl && !isProduct && window.globalCatThumbMap) {
            rawUrl = window.globalCatThumbMap[itemCode];
        }
        
        const tinyUrl = window.getTinyThumb ? window.getTinyThumb(rawUrl, 200) : rawUrl;
        
        let clickAction = isProduct 
            ? `window.loadProductDetailAndOpen('${itemCode}')` 
            : `window.showCategoryProducts('${itemCode}', '${name.replace(/'/g, "\\'")}')`;

        const div = document.createElement('div');
        div.className = 'quick-item';
        div.innerHTML = `
            <div class="quick-icon" onclick="${clickAction}" style="position:relative; overflow:hidden; cursor:pointer;">
                ${isProduct ? '<span style="position:absolute;top:6px;left:6px;background:#6366f1;color:white;font-size:10px;padding:2px 6px;border-radius:4px;z-index:2;font-weight:bold;">ìƒí’ˆ</span>' : ''}
                <img src="${tinyUrl}" loading="lazy" style="width:100%; height:100%; object-fit:cover;" onerror="this.src='https://placehold.co/200?text=No+Img'">
            </div>
            <div class="quick-text" onclick="${clickAction}" style="cursor:pointer;">${name}</div>
        `;
        itemContainer.appendChild(div);
    });
};

// [ìˆ˜ì •] ê²€ìƒ‰ ì‹œ ë°ì´í„° ë¯¸ë¡œë”©ì— ì˜í•œ undefined ì—ëŸ¬ ë°©ì§€
// [ìˆ˜ì •] ë©”ì¸ ê²€ìƒ‰ í•„í„° (ì¹´í…Œê³ ë¦¬ ì œì™¸, ìƒí’ˆë§Œ ê²€ìƒ‰)
window.filterMainIcons = function(keyword) {
    const term = keyword.toLowerCase().trim();
    
    // ë°ì´í„° ë¡œë“œ ì—¬ë¶€ ì²´í¬ (undefined ì—ëŸ¬ ë°©ì§€)
    if (!window.globalSubCats || !window.globalProdImages) return;

    if (!term) {
        // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ í˜„ì¬ í™œì„±í™”ëœ ì¹´í…Œê³ ë¦¬ íƒ­ ë‚´ìš©ì„ ë‹¤ì‹œ ë³´ì—¬ì¤Œ
        const activeTab = document.querySelector('.cat-tab.active');
        if (activeTab) activeTab.click();
        return;
    }

    // matchedCats(ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰)ë¥¼ ì œì™¸í•˜ê³  matchedProds(ìƒí’ˆ ê²€ìƒ‰)ë§Œ ìˆ˜í–‰í•¨
    const matchedProds = window.globalProdImages.filter(prod => 
        (prod.name || '').toLowerCase().includes(term)
    );

    // ê²°ê³¼ë¬¼ë¡œ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ë§Œ ì „ë‹¬ (ë‘ ë²ˆì§¸ ì¸ì trueëŠ” ìƒí’ˆ ëª¨ë“œ í™œì„±í™”ë¥¼ ì˜ë¯¸)
    window._drawQuickItems(matchedProds, true);
};
// [2] í€µë©”ë‰´ ë°ì´í„° ë¡œë”© ë° íƒ­ ìƒì„±
async function renderQuickMenu() {
    const tabContainer = document.getElementById('topCategoryTabs');
    const itemContainer = document.getElementById('quickMenuContainer');
    if (!tabContainer || !itemContainer) return;
    if (!sb) { console.warn("[renderQuickMenu] sbê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ"); return; }

    itemContainer.innerHTML = '<div style="text-align:center; padding:50px; grid-column:1/-1;"><i class="fa-solid fa-spinner fa-spin"></i></div>';

    try {
        // ëŒ€ë¶„ë¥˜, ì¤‘ë¶„ë¥˜, ê²€ìƒ‰ìš© ìƒí’ˆ ì •ë³´ë¥¼ ë™ì‹œì— ê°€ì ¸ì˜´
        const [{ data: topCats }, { data: subCats }, { data: allProds }] = await Promise.all([
            sb.from('admin_top_categories').select('*').order('sort_order', { ascending: true }),
            sb.from('admin_categories').select('*').order('sort_order', { ascending: true }),
            sb.from('admin_products').select('code, name, category, img_url, price').or('partner_id.is.null,partner_status.eq.approved').order('sort_order', { ascending: true })
        ]);

        // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™” (ê²€ìƒ‰ ì˜¤ë¥˜ ë°©ì§€ í•µì‹¬)
        window.globalSubCats = subCats || [];
        window.globalProdImages = allProds || [];
        window.globalCatThumbMap = {};

        // ì¹´í…Œê³ ë¦¬ë³„ ëŒ€í‘œ ì´ë¯¸ì§€ ë§¤í•‘
        if (allProds) {
            allProds.forEach(p => {
                if (p.category && !window.globalCatThumbMap[p.category]) {
                    window.globalCatThumbMap[p.category] = p.img_url;
                }
            });
        }

        tabContainer.innerHTML = '';
        topCats.forEach(top => {
            const btn = document.createElement('button');
            btn.className = 'cat-tab';
            
            // [ìˆ˜ì •] ëŒ€ë¶„ë¥˜ ì–¸ì–´ë³„ ëª…ì¹­ ì ìš©
            let tName = top.name;
            if (CURRENT_LANG === 'ja' && top.name_jp) tName = top.name_jp;
            if (CURRENT_LANG === 'en' && top.name_us) tName = top.name_us;
            btn.innerText = tName; 
            
            btn.onclick = () => {
                document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                const filteredSub = subCats.filter(s => s.top_category_code === top.code);
                window._drawQuickItems(filteredSub, false);
            };
            tabContainer.appendChild(btn);
        });

        if (tabContainer.firstChild) tabContainer.firstChild.click();

    } catch (err) {
        console.error("ì´ˆê¸° ë¡œë”© ì‹¤íŒ¨:", err);
        itemContainer.innerHTML = "ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
}


// [ì‹ ê·œ] ì–¸ì–´ ì„¤ì •ì„ ìœ ì§€í•˜ë©´ì„œ í™ˆìœ¼ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
window.goHome = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const currentLang = urlParams.get('lang');
    const path = window.location.pathname;
    const isHome = path === '/' || path.endsWith('/index.html') || path.endsWith('/index');

    if (isHome) {
        // ì´ë¯¸ í™ˆ â†’ ëª¨ë‹¬ ë‹«ê³  ìŠ¤í¬ë¡¤ (ì±„íŒ… ìœ ì§€)
        ['choiceModal','generalProductModal','categoryDetailModal','productDetailModal'].forEach(function(id) {
            var m = document.getElementById(id);
            if (m) {
                m.style.display = 'none';
                m.classList.remove('product-full-page');
                m.style.padding = '';
                m.style.background = '';
                var box = m.querySelector('.modal-box');
                if (box) {
                    box.style = '';
                    var h = box.querySelector('.product-full-header');
                    var g = box.querySelector('.product-guide-banner');
                    if (h) h.remove();
                    if (g) g.remove();
                }
            }
        });
        var ss = document.getElementById('startScreen');
        if (ss) ss.style.display = '';
        window.history.pushState(null, '', currentLang ? '/?lang=' + currentLang : '/');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
        // ë‹¤ë¥¸ í˜ì´ì§€ë©´ í™ˆìœ¼ë¡œ ì´ë™
        window.location.href = currentLang ? '/?lang=' + currentLang : '/';
    }
};

// [ìµœì¢… ìˆ˜ì •] ìƒí’ˆ í´ë¦­ ì‹œ URL ë³€ê²½ (ì–¸ì–´ ì„¤ì • ìœ ì§€ ê¸°ëŠ¥ ì¶”ê°€)
// [ìˆ˜ì •ë¨] ìƒí’ˆ ìƒì„¸ ì •ë³´ ë¡œë“œ (DB ì—°ê²° ì•ˆì •í™”: window.sb ì‚¬ìš©)
    window.loadProductDetailAndOpen = async function(productCode) {
        const loading = document.getElementById('loading');
        if(loading) {
            loading.style.display = 'flex';
            const p = loading.querySelector('p');
            if(p) p.innerText = "ìƒí’ˆ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...";
        }

        try {
            // 1. ì–¸ì–´ ì„¤ì • ìœ ì§€
            const urlParams = new URLSearchParams(window.location.search);
            const currentLang = urlParams.get('lang');

            // â˜… [í•µì‹¬ ìˆ˜ì •] sb ëŒ€ì‹  window.sb ì‚¬ìš© (ì „ì—­ ë³€ìˆ˜ ê°•ì œ ì°¸ì¡°)
            if (!window.sb) throw new Error("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ëŒ€ê¸° ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");

            // DB ì¡°íšŒ
            const { data: product, error } = await window.sb.from('admin_products')
                .select('*').eq('code', productCode).single();

            if (error || !product) throw new Error("ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            // ì „ì—­ ë³€ìˆ˜ ì €ì¥
            if (!window.PRODUCT_DB) window.PRODUCT_DB = {};
            window.PRODUCT_DB[productCode] = product;

            // 2. ì£¼ì†Œì°½ ë³€ê²½ (ì–¸ì–´ ìœ ì§€)
            let newUrl = `${window.location.pathname}?product=${productCode}`;
            if (currentLang) {
                newUrl += `&lang=${currentLang}`;
            }
            window.history.pushState({ page: 'product', code: productCode }, '', newUrl);

            // í™”ë©´ ì „í™˜
            const startScreen = document.getElementById('startScreen');
            const catModal = document.getElementById('categoryDetailModal');
            if(startScreen) startScreen.style.display = 'none';
            if(catModal) catModal.style.display = 'none';

            // ì „ì²´í™”ë©´ ëª¨ë“œ ì‹¤í–‰ í•¨ìˆ˜
            const transformToFullScreen = (modalId, productName) => {
                const modal = document.getElementById(modalId);
                const box = modal.querySelector('.modal-box');
                
                if (!modal || !box) return;

                modal.classList.add('product-full-page'); 
                modal.style.display = 'flex';
                modal.style.padding = '0';
                modal.style.background = '#ffffff';
                
                box.style.width = '100%';
                box.style.maxWidth = '100%';
                box.style.height = '100%';
                box.style.borderRadius = '0';
                box.style.boxShadow = 'none';
                box.style.margin = '0';
                box.style.overflowY = 'auto'; 

                const oldHeader = box.querySelector('.product-full-header');
                const oldGuide = box.querySelector('.product-guide-banner');
                if(oldHeader) oldHeader.remove();
                if(oldGuide) oldGuide.remove();

                let homeLink = "/";
                if (currentLang) homeLink += `?lang=${currentLang}`;

                const _backText = currentLang==='ja'?'æˆ»ã‚‹':currentLang==='en'?'Back':'ë’¤ë¡œê°€ê¸°';
                const _homeText = currentLang==='ja'?'ãƒ›ãƒ¼ãƒ ':currentLang==='en'?'Home':'í™ˆ';
                const _guideText = currentLang==='ja'
                    ?'å•†å“æƒ…å ±ã‚’ç¢ºèªã—ã€<strong>ã‚ªãƒ—ã‚·ãƒ§ãƒ³</strong>ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'
                    :currentLang==='en'
                    ?'Check product info and select <strong>options</strong>.'
                    :'ìƒí’ˆ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  <strong>ì˜µì…˜</strong>ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';

                const headerHTML = `
                    <div class="product-full-header">
                        <button class="back-btn" onclick="window.history.back()">
                            <i class="fa-solid fa-arrow-left"></i> ${_backText}
                        </button>
                        <div class="page-title">${productName}</div>
                        <div class="right-menu">
                            <button onclick="location.href='${homeLink}'" class="btn-round" style="padding:6px 12px; font-size:12px; height:auto;">
                                <i class="fa-solid fa-house"></i> ${_homeText}
                            </button>
                        </div>
                    </div>
                    <div class="product-guide-banner">
                        <i class="fa-solid fa-circle-info"></i> ${_guideText}
                    </div>
                `;

                box.insertAdjacentHTML('afterbegin', headerHTML);

                const closeBtns = box.querySelectorAll('button[onclick*="none"], button[onclick*="display=\'none\'"]');
                closeBtns.forEach(btn => btn.style.display = 'none');
            };

            // ë‹¤êµ­ì–´ ìƒí’ˆëª… ê°€ì ¸ì˜¤ê¸°
            const localized = typeof getLocalizedData === 'function' ? getLocalizedData(product) : { name: product.name };

            // ì°½ ì—´ê¸° (ëª¨ë“  ìƒí’ˆ ë™ì¼ ì¸í„°í˜ì´ìŠ¤)
            window.showChoiceModal(productCode);
            transformToFullScreen('choiceModal', localized.name);

            window.scrollTo(0, 0);

        } catch (e) {
            console.error(e);
            alert("ì˜¤ë¥˜: " + e.message);
            window.history.back();
        } finally {
            if(loading) loading.style.display = 'none';
        }
    };
// [3] ë©”ì¸ ê²€ìƒ‰ í•„í„° (ìƒí’ˆ + ì¹´í…Œê³ ë¦¬)
// [ìˆ˜ì • ì½”ë“œ] ë©”ì¸ ê²€ìƒ‰ í•„í„° (ì¹´í…Œê³ ë¦¬ ì œì™¸, ìƒí’ˆë§Œ ê²€ìƒ‰í•˜ë„ë¡ ìˆ˜ì •)
window.filterMainIcons = function(keyword) {
    const term = keyword.toLowerCase().trim();
    
    // ë°ì´í„° ë¡œë“œ ì—¬ë¶€ ì²´í¬ (undefined ì—ëŸ¬ ë°©ì§€)
    if (!window.globalSubCats || !window.globalProdImages) return;

    if (!term) {
        // ê²€ìƒ‰ì–´ê°€ ë¹„ì–´ìˆìœ¼ë©´ í˜„ì¬ ì„ íƒëœ íƒ­ì˜ ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ë‹¤ì‹œ ë³´ì—¬ì¤Œ
        const activeTab = document.querySelector('.cat-tab.active');
        if (activeTab) activeTab.click();
        return;
    }

    // matchedCats(ì¹´í…Œê³ ë¦¬) ê²€ìƒ‰ì„ ìƒëµí•˜ê³  matchedProds(ìƒí’ˆ) ê²€ìƒ‰ ê²°ê³¼ë§Œ ì¶”ì¶œ
    const matchedProds = window.globalProdImages.filter(prod => 
        (prod.name || '').toLowerCase().includes(term)
    );

    // ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ë§Œ ê·¸ë¦¬ë„ë¡ ì „ë‹¬ (ë‘ ë²ˆì§¸ ì¸ì trueëŠ” ìƒí’ˆ ë°°ì§€ë¥¼ í‘œì‹œí•˜ê¸° ìœ„í•¨)
    window._drawQuickItems(matchedProds, true);
};
window.categoryCache = {}; 

// [ìµœì¢… í†µí•©] ì¹´í…Œê³ ë¦¬ í´ë¦­ ì‹œ ìƒí’ˆ ëª©ë¡ ë¡œë“œ (ìƒì„¸ì •ë³´ëŠ” ì œì™¸í•˜ì—¬ ë¡œë”© ì†ë„ ìµœì í™”)
window.showCategoryProducts = async function(catKey, catName, catDesc) {
    if (!sb) { console.warn("[showCategoryProducts] sbê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ"); return; }
    const grid = document.getElementById('catProductGrid');
    const modal = document.getElementById('categoryDetailModal');
    const titleEl = document.getElementById('catModalTitle');
    const descBox = document.getElementById('catModalDesc');

    // 1. UI ì´ˆê¸°í™”
    if(titleEl) titleEl.innerHTML = `<span style="color:#6366f1;">${catName}</span>`;
    
    // ì„¤ëª… ë°•ìŠ¤ ì²˜ë¦¬ (ì¼ë³¸ì–´ ëŒ€ì‘ í¬í•¨)
    if (descBox) {
        const urlParams = new URLSearchParams(window.location.search);
        const currentLang = urlParams.get('lang') || 'kr';
        let displayDesc = catDesc;
        if (currentLang === 'ja' && window.modalGlobalData?.categories) {
            const catData = window.modalGlobalData.categories.find(c => c.code === catKey);
            if (catData?.description_ja) displayDesc = catData.description_ja;
        }
        if (displayDesc && displayDesc !== "undefined" && displayDesc.trim() !== "") {
            descBox.style.display = "block";
            descBox.innerHTML = displayDesc.replace(/\n/g, '<br>');
        } else {
            descBox.style.display = "none";
        }
    }
    
    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px;"><i class="fa-solid fa-spinner fa-spin"></i> ë¡œë”© ì¤‘...</div>';
    modal.style.display = 'flex';

    try {
        // [í•µì‹¬ ìµœì í™”] ë¬´ê±°ìš´ description(ìƒì„¸ì„¤ëª…) í•„ë“œë¥¼ ë¹¼ê³  ëª©ë¡ì— í•„ìš”í•œ ìµœì†Œ ë°ì´í„°ë§Œ ê°€ì ¸ì˜´
        const { data: products, error } = await sb.from('admin_products')
            .select('code, name, price, img_url, width_mm, height_mm, is_general_product, is_custom_size, name_jp, price_jp, name_us, price_us, partner_id')
            .eq('category', catKey)
            .or('partner_id.is.null,partner_status.eq.approved')
            .order('sort_order', { ascending: true });

        if (error) throw error;
        grid.innerHTML = '';

        if (!products || products.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:#999;">ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        products.forEach(p => {
            const localized = typeof getLocalizedData === 'function' ? getLocalizedData(p) : { name: p.name, formattedPrice: fmtMoney(p.price||0) };
            const thumbUrl = p.img_url ? window.getTinyThumb(p.img_url, 150) : '';
            
            const div = document.createElement('div');
            div.className = 'quick-item';
            div.innerHTML = `
                <div class="quick-icon-img-box">
                    <img src="${thumbUrl}" loading="lazy" onerror="this.src='https://placehold.co/150?text=No+Img'">
                </div>
                <div class="quick-text" style="display:block !important; font-weight:bold; margin-top:8px;">${localized.name}</div>
                <div style="font-weight:bold; color:#6366f1; margin-top:5px;">${localized.formattedPrice}</div>
            `;

            // í´ë¦­ ì‹œ ìƒì„¸ ì •ë³´ë¥¼ ë¡œë“œí•˜ëŠ” ë³„ë„ í•¨ìˆ˜ í˜¸ì¶œ (ì§€ì—° ë¡œë”©ì˜ í•µì‹¬)
            div.onclick = () => window.loadProductDetailAndOpen(p.code);
            grid.appendChild(div);
        });
    } catch (e) {
        console.error("ë¡œë“œ ì‹¤íŒ¨:", e);
        grid.innerHTML = '<div style="text-align:center; padding:20px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
    }
};

// ============================================================
    // [í†µí•©] ìƒí’ˆ ìƒì„¸í˜ì´ì§€ ì „ì²´í™”ë©´ ëª¨ë“œ ì‹œìŠ¤í…œ (ìƒë‹¨ë°”+URLë³€ê²½)
    // ============================================================

    // 1. ìƒí’ˆ ìƒì„¸ ì •ë³´ ë¡œë“œ ë° ì „ì²´í™”ë©´ ì—´ê¸° (ì–¸ì–´ ìœ ì§€ ë²„ì „)
    window.loadProductDetailAndOpen = async function(productCode) {
        // sb ì´ˆê¸°í™” ëŒ€ê¸° (ìµœëŒ€ 5ì´ˆ)
        if (!sb) {
            for (let i = 0; i < 50; i++) {
                await new Promise(r => setTimeout(r, 100));
                if (sb) break;
            }
            if (!sb) { console.warn("[loadProductDetailAndOpen] sb ì´ˆê¸°í™” ì‹¤íŒ¨"); return; }
        }
        const loading = document.getElementById('loading');
        if(loading) {
            loading.style.display = 'flex';
            const p = loading.querySelector('p');
            if(p) p.innerText = "ìƒí’ˆ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...";
        }

        try {
            // 1. í˜„ì¬ ì–¸ì–´ ì„¤ì • í™•ì¸ (ì´ê±¸ ìƒì–´ë²„ë¦¬ì§€ ì•Šê²Œ ì¡ì•„ì•¼ í•¨)
            const urlParams = new URLSearchParams(window.location.search);
            const currentLang = urlParams.get('lang'); // 'ja', 'en' ë“±

            // DB ì¡°íšŒ
            const { data: product, error } = await sb.from('admin_products')
                .select('*').eq('code', productCode).single();

            if (error || !product) throw new Error("ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            // ì „ì—­ ë³€ìˆ˜ ì €ì¥
            if (!window.PRODUCT_DB) window.PRODUCT_DB = {};
            window.PRODUCT_DB[productCode] = product;

            // 2. â˜… [í•µì‹¬] ì£¼ì†Œì°½ ë°”ê¿€ ë•Œ ì–¸ì–´ ê¼¬ë¦¬í‘œ ë¶™ì´ê¸°
            let newUrl = `${window.location.pathname}?product=${productCode}`;
            if (currentLang) {
                newUrl += `&lang=${currentLang}`; // ì—¬ê¸°ì„œ &lang=jaë¥¼ ë¶™ì—¬ì¤Œ
            }
            window.history.pushState({ page: 'product', code: productCode }, '', newUrl);

            // í™”ë©´ ì „í™˜ (í™ˆ ìˆ¨ê¹€)
            const startScreen = document.getElementById('startScreen');
            const catModal = document.getElementById('categoryDetailModal');
            if(startScreen) startScreen.style.display = 'none';
            if(catModal) catModal.style.display = 'none';

            // ì „ì²´í™”ë©´ ëª¨ë“œ ì‹¤í–‰ í•¨ìˆ˜
            const transformToFullScreen = (modalId, productName) => {
                const modal = document.getElementById(modalId);
                const box = modal.querySelector('.modal-box');
                
                if (!modal || !box) return;

                modal.classList.add('product-full-page'); 
                modal.style.display = 'flex';
                modal.style.padding = '0';
                modal.style.background = '#ffffff';
                
                box.style.width = '100%';
                box.style.maxWidth = '100%';
                box.style.height = '100%';
                box.style.borderRadius = '0';
                box.style.boxShadow = 'none';
                box.style.margin = '0';
                box.style.overflowY = 'auto'; 

                const oldHeader = box.querySelector('.product-full-header');
                const oldGuide = box.querySelector('.product-guide-banner');
                if(oldHeader) oldHeader.remove();
                if(oldGuide) oldGuide.remove();

                // â˜… [í•µì‹¬] í™ˆ ë²„íŠ¼ ë§í¬ì—ë„ ì–¸ì–´ ì„¤ì • ì ìš©
                let homeLink = "/";
                if (currentLang) homeLink += `?lang=${currentLang}`;

                const _backText = currentLang==='ja'?'æˆ»ã‚‹':currentLang==='en'?'Back':'ë’¤ë¡œê°€ê¸°';
                const _homeText = currentLang==='ja'?'ãƒ›ãƒ¼ãƒ ':currentLang==='en'?'Home':'í™ˆ';
                const _guideText = currentLang==='ja'
                    ?'å•†å“æƒ…å ±ã‚’ç¢ºèªã—ã€<strong>ã‚ªãƒ—ã‚·ãƒ§ãƒ³</strong>ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'
                    :currentLang==='en'
                    ?'Check product info and select <strong>options</strong>.'
                    :'ìƒí’ˆ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  <strong>ì˜µì…˜</strong>ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';

                const headerHTML = `
                    <div class="product-full-header">
                        <button class="back-btn" onclick="window.history.back()">
                            <i class="fa-solid fa-arrow-left"></i> ${_backText}
                        </button>
                        <div class="page-title">${productName}</div>
                        <div class="right-menu">
                            <button onclick="location.href='${homeLink}'" class="btn-round" style="padding:6px 12px; font-size:12px; height:auto;">
                                <i class="fa-solid fa-house"></i> ${_homeText}
                            </button>
                        </div>
                    </div>
                    <div class="product-guide-banner">
                        <i class="fa-solid fa-circle-info"></i> ${_guideText}
                    </div>
                `;

                box.insertAdjacentHTML('afterbegin', headerHTML);

                const closeBtns = box.querySelectorAll('button[onclick*="none"], button[onclick*="display=\'none\'"]');
                closeBtns.forEach(btn => btn.style.display = 'none');
            };

            // ë‹¤êµ­ì–´ ìƒí’ˆëª… ê°€ì ¸ì˜¤ê¸°
            const localized = typeof getLocalizedData === 'function' ? getLocalizedData(product) : { name: product.name };

            // ì°½ ì—´ê¸° (ëª¨ë“  ìƒí’ˆ ë™ì¼ ì¸í„°í˜ì´ìŠ¤)
            window.showChoiceModal(productCode);
            transformToFullScreen('choiceModal', localized.name);

            window.scrollTo(0, 0);

        } catch (e) {
            console.error(e);
            alert("ì˜¤ë¥˜: " + e.message);
            window.history.back();
        } finally {
            if(loading) loading.style.display = 'none';
        }
    };

    // 2. [ë’¤ë¡œê°€ê¸° ê°ì§€] ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ëˆ„ë¥´ë©´ í™ˆìœ¼ë¡œ ë³µê·€
    window.addEventListener('popstate', function(event) {
        // ëª¨ë“  ì „ì²´í™”ë©´ ëª¨ë‹¬ ë‹«ê¸°
        const modals = ['choiceModal', 'generalProductModal'];
        
        modals.forEach(id => {
            const m = document.getElementById(id);
            if(m) {
                m.style.display = 'none';
                m.classList.remove('product-full-page'); // í´ë˜ìŠ¤ ì œê±°
                m.style.padding = ''; // íŒ¨ë”© ë³µêµ¬
                m.style.background = ''; // ë°°ê²½ ë³µêµ¬
                
                // ë‚´ë¶€ ìŠ¤íƒ€ì¼ ë³µêµ¬ (íŒì—…ìš©)
                const box = m.querySelector('.modal-box');
                if(box) {
                    box.style = ''; // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                    // ì£¼ì…í–ˆë˜ í—¤ë” ì œê±°
                    const h = box.querySelector('.product-full-header');
                    const g = box.querySelector('.product-guide-banner');
                    if(h) h.remove();
                    if(g) g.remove();
                    
                    // ìˆ¨ê²¼ë˜ ë‹«ê¸° ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê¸°
                    const closeBtns = box.querySelectorAll('button[onclick*="none"]');
                    closeBtns.forEach(btn => btn.style.display = '');
                }
            }
        });

        // í™ˆ í™”ë©´ ë‹¤ì‹œ ë³´ì´ê¸°
        const startScreen = document.getElementById('startScreen');
        if(startScreen) startScreen.style.display = '';
    });

    // 3. [ì´ˆê¸° ì ‘ì†] URLì— ?product=ì½”ë“œ ìˆìœ¼ë©´ ë°”ë¡œ ì—´ê¸° (sb ëŒ€ê¸° í¬í•¨)
    (async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const productCode = urlParams.get('product');
        if (productCode) {
            console.log("ğŸ”— URL ì ‘ì† ê°ì§€:", productCode);
            // sb ì´ˆê¸°í™” ëŒ€ê¸° (ìµœëŒ€ 5ì´ˆ)
            for (let i = 0; i < 50 && !sb; i++) {
                await new Promise(r => setTimeout(r, 100));
            }
            if (window.loadProductDetailAndOpen) window.loadProductDetailAndOpen(productCode);
        }
    })();
    // [ìµœì¢… ì•ˆì •í™” ë²„ì „] ìƒì„¸ í˜ì´ì§€ ëª¨ë‹¬ ì˜¤í”ˆ í•¨ìˆ˜
// [ìˆ˜ì • 2] ìƒì„¸í˜ì´ì§€ ëª¨ë‹¬ (DB ê³µí†µì •ë³´ ì—°ë™ + ì• ë‹ˆë©”ì´ì…˜ ê°•ì œ ì‹¤í–‰)
// [ìµœì¢… ë³µêµ¬] ìƒì„¸í˜ì´ì§€ ëª¨ë‹¬ (DB ì—°ë™ ë³µêµ¬ + ë””ìì¸/ê¸°ëŠ¥ ê°œì„  ìœ ì§€)
window.showChoiceModal = async function(key) {
    console.clear();
    console.log("ğŸ› ï¸ [Debug] ëª¨ë‹¬ ì—´ê¸°. ìƒí’ˆí‚¤:", key);
    if (!sb && !window.sb) { console.warn("[showChoiceModal] sbê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ"); return; }
    const _sb = window.sb || sb;

    // 1. ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    let product = window.PRODUCT_DB ? window.PRODUCT_DB[key] : null;
    if (!product || !product.description) {
        const { data, error } = await _sb.from('admin_products').select('*').eq('code', key).single();
        if (error || !data) return alert("ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        product = data;
        if(!window.PRODUCT_DB) window.PRODUCT_DB = {};
        window.PRODUCT_DB[key] = product;
    }
    window.selectedProductForChoice = product;
    const modal = document.getElementById('choiceModal');
    const modalBox = modal.querySelector('.modal-box');
    
    // 2. ì–¸ì–´ ì„¤ì •
    const urlParams = new URLSearchParams(window.location.search);
    let lang = urlParams.get('lang');
    if (!lang) {
        if (window.location.hostname.includes('cafe0101.com')) lang = 'ja';
        else if (window.location.hostname.includes('cafe3355.com')) lang = 'en';
        else lang = 'kr';
    }

    // 3. ìƒí’ˆëª… & ì„¤ëª…
    let dName = product.name_kr || product.name || "ìƒí’ˆëª… ì—†ìŒ";
    let dDesc = product.description_kr || product.description || "";
    let dPrice = product.price;
    if (lang === 'ja') {
        if (product.name_jp) dName = product.name_jp;
        if (product.description_jp) dDesc = product.description_jp;
        if (product.price_jp) dPrice = product.price_jp;
    } else if (lang === 'en') {
        if (product.name_us) dName = product.name_us;
        if (product.description_us) dDesc = product.description_us;
        if (product.price_us) dPrice = product.price_us;
    }
    const isCustom = product.is_custom_size === true;
    window.isCustomModeCurrent = isCustom;

// ============================================================
    // [ìµœì¢… ìˆ˜ì •] ê³µí†µ ì •ë³´ ë¡œë“œ (ìˆœì„œ: ì „ì²´ê³µí†µ -> ì¹´í…Œê³ ë¦¬ê³µí†µ)
    // ============================================================
    // ============================================================
    // [ìµœì¢… ìˆ˜ì •] ê³µí†µ ì •ë³´ ë¡œë“œ (ì „ì²´ -> ì¹´í…Œê³ ë¦¬ ìˆœì„œ + ëŒ€ë¶„ë¥˜ ìë™ë§¤ì¹­)
    // ============================================================
    let commonInfoHtml = "";
    
    try {
        const dbClient = window.sb || sb; 
        if (!dbClient) throw new Error("DB ì—°ê²°ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");

        // [í•µì‹¬] ìƒí’ˆì˜ ì†Œë¶„ë¥˜ ì½”ë“œë¡œ 'ëŒ€ë¶„ë¥˜(Top Category) ì½”ë“œ' ì°¾ê¸°
        // ê´€ë¦¬ìì—ì„œ ëŒ€ë¶„ë¥˜ ê¸°ì¤€ìœ¼ë¡œ ì €ì¥í–ˆê¸° ë•Œë¬¸ì—, ì—¬ê¸°ì„œ ë³€í™˜ì´ í•„ìš”í•©ë‹ˆë‹¤.
        const subCatCode = product.category;
        let targetCat = subCatCode || 'NO_CAT';

        if (window.globalSubCats) {
            // ë¯¸ë¦¬ ë¡œë“œëœ ì¹´í…Œê³ ë¦¬ ëª©ë¡ì—ì„œ í˜„ì¬ ìƒí’ˆì˜ ì†Œë¶„ë¥˜ë¥¼ ì°¾ê³ , ê·¸ ë¶€ëª¨(ëŒ€ë¶„ë¥˜) ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const match = window.globalSubCats.find(c => c.code === subCatCode);
            if (match && match.top_category_code) {
                targetCat = match.top_category_code;
                console.log(`ğŸ”— ì¹´í…Œê³ ë¦¬ ë§¤ì¹­: ${subCatCode} (ì†Œë¶„ë¥˜) -> ${targetCat} (ëŒ€ë¶„ë¥˜)`);
            }
        }
        
        // 3. ë°ì´í„° ì¡°íšŒ ('ì „ì²´'ì™€ 'ì°¾ì•„ë‚¸ ëŒ€ë¶„ë¥˜' ë‘ ê°€ì§€ ì¡°íšŒ)
        const { data: commonList } = await dbClient.from('common_info')
            .select('*')
            .in('category_code', ['all', targetCat]) 
            .eq('section', 'top');

        if (commonList && commonList.length > 0) {
            // (1) ë°ì´í„° ë¶„ë¥˜
            const globalData = commonList.find(c => c.category_code === 'all');
            const catData = commonList.find(c => c.category_code === targetCat);

            // ì–¸ì–´ë³„ ë‚´ìš© ì¶”ì¶œ í—¬í¼
            const getContentByLang = (data) => {
                if (!data) return "";
                if (lang === 'ja' && data.content_jp) return data.content_jp;
                if (lang === 'en' && data.content_us) return data.content_us;
                return data.content || ""; // ê¸°ë³¸ KR
            };

            // (2) HTML í•©ì¹˜ê¸°
            let combinedHtml = "";

            // ì „ì²´ ê³µí†µ (ìƒë‹¨)
            const globalContent = getContentByLang(globalData);
            if (globalContent) {
                combinedHtml += `<div class="common-global-section" style="margin-bottom:30px;">${globalContent}</div>`;
            }

            // ì¹´í…Œê³ ë¦¬ ê³µí†µ (í•˜ë‹¨)
            const catContent = getContentByLang(catData);
            if (catContent) {
                combinedHtml += `<div class="common-category-section" style="margin-bottom:30px;">${catContent}</div>`;
            }

            if (combinedHtml) {
                commonInfoHtml = `<div class="common-info-area product-detail-render">${combinedHtml}</div>`;
            }
        }
    } catch (err) {
        console.warn("ê³µí†µ ì •ë³´ ë¡œë“œ ê²½ê³ :", err);
    }

    // 4. ì˜µì…˜(Add-on) ìƒì„±
    let optionsHtml = '<div id="addonCategoryArea" style="margin-top:15px; display:flex; flex-direction:column; gap:15px;">';
    const addonCodes = Array.isArray(product.addons) ? product.addons : (product.addons ? product.addons.split(',') : []);
    
    if (addonCodes.length > 0) {
        const { data: addons } = await _sb.from('admin_addons').select('*').in('code', addonCodes);
        const { data: addonCats } = await _sb.from('addon_categories').select('*').order('sort_order', {ascending: true});

        if (addons && addonCats) {
            addonCats.forEach(cat => {
                const catAddons = addons.filter(a => a.category_code === cat.code);
                if (catAddons.length > 0) {
                    let catName = cat.name_kr || cat.name;
                    if (lang === 'ja' && cat.name_jp) catName = cat.name_jp;
                    if (lang === 'en' && cat.name_us) catName = cat.name_us;

                    const isColorCategory = cat.is_swatch || cat.code.includes('color') || catName.includes('ì»¬ëŸ¬') || catName.includes('Color');

                    optionsHtml += `
                        <div style="background:#fff; border:1px solid #e2e8f0; padding:15px; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.02);">
                            <div style="font-weight:800; font-size:14px; color:#1e1b4b; margin-bottom:12px; display:flex; align-items:center; gap:6px;">
                                <i class="fa-solid fa-layer-group" style="color:#6366f1;"></i> ${catName}
                            </div>`;

                    if (isColorCategory) {
                        // ì»¬ëŸ¬: 5ì—´ ê·¸ë¦¬ë“œ + ì´ë¦„ ì‚­ì œ
                        optionsHtml += `<div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:8px;">`;
                        catAddons.forEach(a => {
                            let basePrice = a.price_kr || a.price || 0;
                            if (lang === 'ja' && a.price_jp) basePrice = a.price_jp;
                            else if (lang === 'en' && a.price_us) basePrice = a.price_us;
                            const imgUrl = a.img_url || 'https://placehold.co/60/eeeeee/cccccc?text=+';

                            optionsHtml += `
                                <label class="color-btn-item" style="cursor:pointer; position:relative;" title="${a.name}">
                                    <input type="checkbox" name="userOption" value="${a.code}" data-price="${basePrice}" 
                                           style="position:absolute; opacity:0; width:0; height:0;" 
                                           onchange="window.updateModalTotal(); this.parentElement.classList.toggle('selected', this.checked);">
                                    <div class="color-btn-box" style="border:1px solid #e2e8f0; border-radius:8px; padding:8px 2px; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.2s; height:100%; background-color:#fff;">
                                        <img src="${imgUrl}" style="width:30px; height:30px; border-radius:50%; object-fit:cover; border:1px solid #eee;">
                                        ${basePrice > 0 ? `<span style="font-size:10px; color:#6366f1; margin-top:4px; font-weight:bold;">+${basePrice.toLocaleString()}</span>` : ''}
                                    </div>
                                </label>`;
                        });
                        optionsHtml += `</div><style>.color-btn-item.selected .color-btn-box { border:2px solid #6366f1; background:#eff6ff; box-shadow:0 0 0 1px #6366f1; }</style>`;
                    } else {
                        // ì¼ë°˜ ì˜µì…˜: ë¦¬ìŠ¤íŠ¸í˜• + ì¸ë„¤ì¼ + data-category (ë°°ì†¡ë¹„ êµ¬ë¶„ìš©)
                        optionsHtml += `<div style="display:flex; flex-direction:column; gap:8px;">`;
                        catAddons.forEach(a => {
                            let optName = a.name_kr || a.name;
                            let basePrice = a.price_kr || a.price || 0;
                            let priceStr = `+${basePrice.toLocaleString()}ì›`;
                            if (lang === 'ja') { if (a.name_jp) optName = a.name_jp; if (a.price_jp) { basePrice = a.price_jp; priceStr = `+Â¥${basePrice.toLocaleString()}`; } }
                            else if (lang === 'en') { if (a.name_us) optName = a.name_us; if (a.price_us) { basePrice = a.price_us; priceStr = `+$${basePrice.toLocaleString()}`; } }
                            const imgUrl = a.img_url || 'https://placehold.co/40?text=IMG';

                            optionsHtml += `
                            <div class="addon-item-row" style="display:flex; align-items:center; justify-content:space-between; padding:12px; border:1px solid #f1f5f9; background:#fff; border-radius:8px;">
                                <label style="display:flex; align-items:center; gap:12px; cursor:pointer; flex:1;">
                                    <input type="checkbox" name="userOption" value="${a.code}" data-price="${basePrice}" data-category="${catName}" style="width:18px; height:18px; accent-color:#6366f1;" onchange="window.updateModalTotal(); this.closest('.addon-item-row').querySelector('.addon-qty-box').style.display = this.checked ? 'flex' : 'none';">
                                    <img src="${imgUrl}" style="width:40px; height:40px; object-fit:cover; border-radius:6px; border:1px solid #eee;">
                                    <div style="display:flex; flex-direction:column;">
                                        <span style="font-size:13px; font-weight:600; color:#333;">${optName}</span>
                                        <span style="font-size:12px; color:#6366f1; font-weight:bold;">${priceStr}</span>
                                    </div>
                                </label>
                                <div class="addon-qty-box" style="display:none; align-items:center; border:1px solid #ddd; height:30px; border-radius:4px; overflow:hidden;">
                                    <button onclick="const inp=this.nextElementSibling; inp.value=Math.max(1, parseInt(inp.value)-1); window.updateModalTotal();" style="border:none; width:26px; height:100%; cursor:pointer;">-</button>
                                    <input type="number" class="addon-qty-input" value="1" min="1" oninput="window.updateModalTotal()" style="width:36px; text-align:center; border:none; font-weight:bold; font-size:12px; outline:none;">
                                    <button onclick="const inp=this.previousElementSibling; inp.value=parseInt(inp.value)+1; window.updateModalTotal();" style="border:none; width:26px; height:100%; cursor:pointer;">+</button>
                                </div>
                            </div>`;
                        });
                        optionsHtml += `</div>`;
                    }
                    optionsHtml += `</div>`;
                }
            });
        }
    }
    optionsHtml += '</div>';

    // 5. ìš°ì¸¡ UI (ê¸°ì¡´ ìœ ì§€)
    const formatPriceSimple = (p) => {
        if(lang === 'ja') return `Â¥${p.toLocaleString()}`;
        if(lang === 'en') return `$${p.toLocaleString()}`;
        return `${p.toLocaleString()}ì›`;
    };

    let productHeaderHtml = `
        <div class="choice-summary-card" style="background:#fff; border:1px solid #eee; padding:20px; border-radius:15px; text-align:center; margin-bottom:15px;">
            <img src="${product.img || product.img_url}" style="width:100%; max-height:180px; object-fit:contain; margin-bottom:10px; border-radius:8px;">
            <div style="font-size:16px; font-weight:bold; color:#1e1b4b; margin-bottom:5px;">${dName}</div>
    `;

    let rightSideUI = "";
    if (isCustom) {
        rightSideUI = productHeaderHtml + `
            <div style="background:#f8fafc; border-radius:8px; padding:10px; margin-top:10px;">
                <div style="font-size:12px; font-weight:bold; color:#6366f1; margin-bottom:8px;">ğŸ“ ${lang==='ja'?'ã‚µã‚¤ã‚ºå…¥åŠ› (mm)':lang==='en'?'Enter Size (mm)':'ì‚¬ì´ì¦ˆ ì…ë ¥ (mm)'}</div>
                <div style="display:flex; gap:5px;">
                    <input type="number" id="inputCustW" class="ai-input-pretty" placeholder="W" style="flex:1; margin:0; text-align:center;" oninput="window.calcCustomPrice(); window.updateModalTotal();">
                    <span style="display:flex; align-items:center; color:#999;">x</span>
                    <input type="number" id="inputCustH" class="ai-input-pretty" placeholder="H" style="flex:1; margin:0; text-align:center;" oninput="window.calcCustomPrice(); window.updateModalTotal();">
                </div>
            </div>
            <div style="margin-top:15px; font-size:12px; color:#64748b; font-weight:bold; text-align:left;">${lang==='ja'?'æ•°é‡':lang==='en'?'Quantity':'ìˆ˜ëŸ‰'}</div>
            <div class="qty-wrapper" style="display:flex; border:1px solid #cbd5e1; border-radius:8px; overflow:hidden; height:40px; margin-top:5px;">
                <button onclick="const i=document.getElementById('inputCustQty'); i.value=Math.max(1, parseInt(i.value)-1); window.calcCustomPrice(); window.updateModalTotal();" style="flex:1; border:none; background:#f8fafc; cursor:pointer; font-weight:bold;">-</button>
                <input type="number" id="inputCustQty" value="1" min="1" style="width:60px; text-align:center; border:none; font-weight:bold; font-size:15px;" oninput="window.calcCustomPrice(); window.updateModalTotal();">
                <button onclick="const i=document.getElementById('inputCustQty'); i.value=parseInt(i.value)+1; window.calcCustomPrice(); window.updateModalTotal();" style="flex:1; border:none; background:#f8fafc; cursor:pointer; font-weight:bold;">+</button>
            </div>
            <div style="background:#1e293b; color:white; padding:15px; border-radius:10px; text-align:center; margin-top:15px;">
                <div style="font-size:11px; opacity:0.8; margin-bottom:5px;">${lang==='ja'?'è¦‹ç©ä¾¡æ ¼':lang==='en'?'Estimated Price':'ì˜ˆìƒ ê²¬ì ê°€'}</div>
                <div id="calcResultPrice" style="font-size:20px; font-weight:800; color:#fbbf24;">${lang==='ja'?'Â¥0':lang==='en'?'$0':'0ì›'}</div>
                <div id="calcResultSize" style="font-size:11px; opacity:0.7; margin-top:2px;">-</div>
            </div>
        </div>`;
    } else {
        rightSideUI = productHeaderHtml + `
            <div style="font-size:20px; font-weight:900; color:#1e293b; margin-bottom:15px;">${formatPriceSimple(dPrice)}</div>
            <div class="qty-wrapper" style="display:flex; border:1px solid #cbd5e1; border-radius:8px; overflow:hidden; height:40px;">
                <button onclick="const i=document.getElementById('fixedProdQty'); i.value=Math.max(1, parseInt(i.value)-1); window.updateModalTotal();" style="flex:1; border:none; background:#f8fafc; cursor:pointer; font-weight:bold;">-</button>
                <input type="number" id="fixedProdQty" value="1" min="1" style="width:60px; text-align:center; border:none; font-weight:bold; font-size:15px;" oninput="window.updateModalTotal();">
                <button onclick="const i=document.getElementById('fixedProdQty'); i.value=parseInt(i.value)+1; window.updateModalTotal();" style="flex:1; border:none; background:#f8fafc; cursor:pointer; font-weight:bold;">+</button>
            </div>
        </div>`;
    }

    // 6. ëª¨ë‹¬ ì¡°ë¦½
    modalBox.innerHTML = `
        <div class="choice-layout" style="display:flex; flex-direction:${window.innerWidth <= 768 ? 'column' : 'row'}; height:90vh; overflow:hidden;">
            <button onclick="window.location.href = window.location.pathname" style="position:absolute; top:20px; right:20px; width:45px; height:45px; background:#FFEB3B; border-radius:50%; z-index:10001; cursor:pointer; display:flex; align-items:center; justify-content:center; border:3px solid #fff; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                <i class="fa-solid fa-xmark" style="font-size:20px; color:#333;"></i>
            </button>

            <div class="choice-left-content" style="flex:1; overflow-y:auto; padding:40px; background:#fff; text-align:left;">
                ${product.is_general_product ? '<div style="display:inline-flex; align-items:center; gap:6px; background:#f0fdf4; border:1px solid #bbf7d0; padding:5px 12px; border-radius:20px; margin-bottom:15px; font-size:12px; color:#16a34a; font-weight:600;"><i class="fa-solid fa-store"></i> '+(lang==='ja'?'ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹å•†å“':lang==='en'?'Marketplace Product':'ë§ˆì¼“í”Œë ˆì´ìŠ¤ ìƒí’ˆ')+'</div>' : ''}
                <h2 style="font-size:28px; font-weight:900; margin-bottom:20px; border-bottom:2px solid #f1f5f9; padding-bottom:15px;">${dName}</h2>
                ${commonInfoHtml}
                <div class="product-detail-render" style="line-height:1.8; width:100%;">
                    ${dDesc}
                </div>
            </div>

            <div class="choice-right-actions" style="width:${window.innerWidth <= 768 ? '100%' : '380px'}; background:#f8fafc; padding:30px; border-left:1px solid #eee; overflow-y:auto;">
                ${rightSideUI}
                ${optionsHtml}
                <div style="background:#fff; border:2px solid #6366f1; padding:15px; border-radius:15px; margin-top:20px; text-align:right;">
                    <div style="font-size:12px; color:#64748b;">Total</div>
                    <div id="modalRealtimeTotal" style="font-size:26px; font-weight:900; color:#6366f1;">0</div>
                </div>
                <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px; padding-bottom:50px;">
                    ${product.is_general_product ? '' : `<button onclick="window.confirmChoice('editor')" class="btn-round primary" style="height:60px; font-size:16px;">ğŸ¨ ${lang==='ja'?'ã‚¨ãƒ‡ã‚£ã‚¿ã§ãƒ‡ã‚¶ã‚¤ãƒ³':lang==='en'?'Design Editor':'ì—ë””í„°ë¡œ ë””ìì¸í•˜ê¸°'}</button>`}
                    <button onclick="window.confirmChoice('cart')" class="btn-round ${product.is_general_product ? 'primary' : ''}" style="height:60px; ${product.is_general_product ? 'font-size:16px;' : 'background:#4ccc02; color:white;'}">ğŸ›’ ${lang==='ja'?'ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã‚‹':lang==='en'?'Add to Cart':'ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°'}</button>
                </div>
            </div>
        </div>
    `;

    modal.style.display = 'flex';
    
    // â˜…â˜…â˜… [í•µì‹¬] ì• ë‹ˆë©”ì´ì…˜(AOS) ê°•ì œ ì¬ì‹¤í–‰ (ë¸”ë™ìŠ¤í¬ë¦° ë°©ì§€) â˜…â˜…â˜…
    setTimeout(() => {
        // ë¹„ë””ì˜¤ ìë™ ì¬ìƒ
        modalBox.querySelectorAll('video').forEach(v => {
            v.style.width = '100%'; v.muted = true; v.autoplay = true; v.loop = true; v.setAttribute('playsinline', 'true');
            v.play().catch(() => {});
        });

        // íŒì—… ì•ˆì˜ AOS ìš”ì†Œë“¤ì„ ì°¾ì•„ì„œ ê°•ì œë¡œ 'ë‚˜íƒ€ë‚œ ìƒíƒœ'ë¡œ ë§Œë“¦
        if (window.AOS) {
            const aosElements = modalBox.querySelectorAll('[data-aos]');
            aosElements.forEach(el => {
                el.classList.add('aos-animate'); // ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ê°•ì œ ì£¼ì…
                el.style.opacity = '1';          // íˆ¬ëª…ë„ ë³µêµ¬
                el.style.transform = 'none';     // ìœ„ì¹˜ ë³µêµ¬
            });
        }
    }, 400);

    window.updateModalTotal();

    // â˜… ë¦¬ë·° ì‹œìŠ¤í…œ ì´ˆê¸°í™” (choice-left-contentì— DOM append)
    setTimeout(() => {
        const leftContent = modalBox.querySelector('.choice-left-content');
        if (leftContent) {
            const old = document.getElementById('productReviewSection');
            if (old) old.remove();

            const reviewDiv = document.createElement('div');
            reviewDiv.id = 'productReviewSection';
            reviewDiv.className = 'product-review-section';
            reviewDiv.innerHTML = `
                <h3 class="review-section-title">${window.t('rv_title','ê³ ê° ë¦¬ë·°')}</h3>
                <div id="reviewSummary" class="review-summary"></div>
                <div id="reviewWriteArea"></div>
                <div id="reviewList" class="review-list"></div>
                <button id="btnLoadMoreReviews" onclick="window.loadMoreReviews()" class="btn-round" style="display:none;width:100%;margin-top:10px;">${window.t('rv_load_more','ë”ë³´ê¸°')}</button>
            `;
            leftContent.appendChild(reviewDiv);
        }
        window.currentReviewProductCode = key;
        window.currentReviewLang = lang;
        window.productReviewPage = 0;
        window.renderReviewWriteForm(key);
        window.loadProductReviews(key, 0);
    }, 300);
};
// ì‹¤ì‹œê°„ í•©ê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
// [ìˆ˜ì • 1] ê¸ˆì•¡ ê³„ì‚° í•¨ìˆ˜ (ë‹¨í’ˆ/ì˜µì…˜ ëª¨ë‘ ìˆ˜ëŸ‰ ê³±í•˜ê¸° ì ìš©)
// [ìµœì¢… ìˆ˜ì •] ê¸ˆì•¡ ê³„ì‚° í•¨ìˆ˜ (ìƒí’ˆê³¼ ì˜µì…˜ ìˆ˜ëŸ‰ ì™„ì „ ë¶„ë¦¬)
window.updateModalTotal = function() {
    const product = window.selectedProductForChoice;
    if(!product) return;

    // 1. [ìƒí’ˆ] ìˆ˜ëŸ‰ ë° ê°€ê²© ê³„ì‚°
    const prodQtyInput = document.getElementById('fixedProdQty') || document.getElementById('inputCustQty');
    const prodQty = prodQtyInput ? (parseInt(prodQtyInput.value) || 1) : 1;
    
    let productTotal = 0;

    if (window.isCustomModeCurrent) {
        // ì»¤ìŠ¤í…€: ì´ë¯¸ ê³„ì‚°ëœ(ìˆ˜ëŸ‰ í¬í•¨ëœ) ê°€ê²© ê°€ì ¸ì˜¤ê¸°
        const calcPriceEl = document.getElementById('calcResultPrice');
        productTotal = parseInt(calcPriceEl.innerText.replace(/[^0-9]/g, '')) || 0;
    } else {
        // ì¼ë°˜: (êµ­ê°€ë³„ ë‹¨ê°€) * (ìƒí’ˆ ìˆ˜ëŸ‰)
        const urlParams = new URLSearchParams(window.location.search);
        let lang = urlParams.get('lang');
        if (!lang && window.location.hostname.includes('cafe0101.com')) lang = 'ja';
        else if (!lang && window.location.hostname.includes('cafe3355.com')) lang = 'en';

        let unitPrice = product.price;
        if (lang === 'ja' && product.price_jp) unitPrice = product.price_jp;
        else if (lang === 'en' && product.price_us) unitPrice = product.price_us;

        productTotal = unitPrice * prodQty; 
    }

    // 2. [ì˜µì…˜] ìˆ˜ëŸ‰ ë° ê°€ê²© ê³„ì‚° (ìƒí’ˆ ìˆ˜ëŸ‰ê³¼ ë¬´ê´€í•˜ê²Œ ë…ë¦½ ê³„ì‚°)
    let optionTotal = 0;
    
    document.querySelectorAll('input[name="userOption"]:checked').forEach(chk => {
        let price = parseInt(chk.dataset.price || 0);
        
        // í•´ë‹¹ ì˜µì…˜ ì¤„(row)ì—ì„œ ìˆ˜ëŸ‰ ì…ë ¥ì¹¸ ì°¾ê¸°
        // (ë¦¬ìŠ¤íŠ¸í˜• ì˜µì…˜ì€ .addon-qty-inputì´ ìˆê³ , ë²„íŠ¼í˜•ì€ ë³´í†µ 1ê°œë¡œ ì¹¨)
        const row = chk.closest('.addon-item-row') || chk.closest('.color-btn-item');
        let optQty = 1; // ê¸°ë³¸ 1ê°œ

        if(row) {
            const qtyInput = row.querySelector('.addon-qty-input');
            if(qtyInput) {
                optQty = parseInt(qtyInput.value || 1);
            }
        }

        // â˜… í•µì‹¬: (ì˜µì…˜ë‹¨ê°€ * ì˜µì…˜ìˆ˜ëŸ‰)ë§Œ ë”í•¨. ìƒí’ˆìˆ˜ëŸ‰ì€ ê³±í•˜ì§€ ì•ŠìŒ.
        optionTotal += (price * optQty);
    });

    // 3. ìµœì¢… í•©ì‚°
    const finalTotal = productTotal + optionTotal;
    const display = document.getElementById('modalRealtimeTotal');
    
    if(display) display.innerText = fmtLocal(finalTotal);
};

    // [2] ì‹¤ì‹œê°„ ê°€ê²© ê³„ì‚° í•¨ìˆ˜ (êµ­ê°€ë³„ ë‹¨ê°€ ì ìš© ìˆ˜ì •íŒ)
    // [2] ì‹¤ì‹œê°„ ê°€ê²© ê³„ì‚° í•¨ìˆ˜ (êµ­ê°€ë³„ ë‹¨ê°€ ì ìš© ìˆ˜ì •íŒ)
    window.calcCustomPrice = function() {
        const wInput = document.getElementById('inputCustW');
        const hInput = document.getElementById('inputCustH');
        const qInput = document.getElementById('inputCustQty');
        const priceDisplay = document.getElementById('calcResultPrice');
        const sizeDisplay = document.getElementById('calcResultSize');

        if (!wInput || !hInput || !window.selectedProductForChoice) return;

        const w = parseInt(wInput.value || 0);
        const h = parseInt(hInput.value || 0);
        const qty = parseInt(qInput ? qInput.value : 1) || 1;
        const product = window.selectedProductForChoice;

        // â˜… [í•µì‹¬] ì–¸ì–´ ê°ì§€
        const urlParams = new URLSearchParams(window.location.search);
        let lang = urlParams.get('lang');
        if (!lang) {
            if (window.location.hostname.includes('cafe0101.com')) lang = 'ja';
            else if (window.location.hostname.includes('cafe3355.com')) lang = 'en';
            else lang = 'kr';
        }

        // â˜… [í•µì‹¬] ë‹¨ê°€(unitPrice)ë¥¼ ì–¸ì–´ì— ë§ê²Œ ê°€ì ¸ì˜¤ê¸°
        let unitPrice = product.price || 0; // ê¸°ë³¸ í•œêµ­ ê°€ê²©

        // ì¼ë³¸ì–´ë©´ price_jp ì‚¬ìš©
        if (lang === 'ja' && product.price_jp && product.price_jp > 0) {
            unitPrice = product.price_jp;
        } 
        // ì˜ì–´ë©´ price_us ì‚¬ìš©
        else if (lang === 'en' && product.price_us && product.price_us > 0) {
            unitPrice = product.price_us;
        }

        // í™”í í¬ë§·íŒ… í•¨ìˆ˜
        const formatValue = (val) => {
            if (lang === 'ja') return 'Â¥' + Math.floor(val).toLocaleString();
            if (lang === 'en') return '$' + val.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return Math.floor(val).toLocaleString() + 'ì›';
        };

        // [ìˆ˜ì •] í‚¤ë§(3cm~5cm)ë„ ì…ë ¥ë˜ë„ë¡ 100ì„ 30ìœ¼ë¡œ ë³€ê²½
if (w >= 20 && h >= 20) {
            // 1. ë©´ì  ê³„ì‚° (ã¡)
            const area = (w * h) / 1000000;
            
            // 2. ë‹¨ê°€ ê³„ì‚°
            let pricePerItem = area * unitPrice;
            const MIN_PRICE = 2000;

            if (lang === 'kr') {
                // í•œêµ­: 10ì› ë‹¨ìœ„ ì ˆì‚¬
                pricePerItem = Math.floor(pricePerItem / 10) * 10;
            } else {
                // ì¼ë³¸/ë¯¸êµ­: ì†Œìˆ˜ì  ë²„ë¦¼ (ì •ìˆ˜)
                pricePerItem = Math.floor(pricePerItem);
            }

            // 3. ìµœì¢… í•©ê³„
            const totalPrice = pricePerItem * qty;
            
            if (priceDisplay) priceDisplay.innerText = formatValue(totalPrice);
            if (sizeDisplay) sizeDisplay.innerText = `${w}mm x ${h}mm (${area.toFixed(2)}ã¡)`;
        } else {
            if (priceDisplay) priceDisplay.innerText = formatValue(0);
            if (sizeDisplay) sizeDisplay.innerText = lang === 'ja' ? 'æœ€ä½100mmä»¥ä¸Šå…¥åŠ›' : lang === 'en' ? 'Min 100mm required' : 'ìµœì†Œ 100mm ì´ìƒ ì…ë ¥';
        }
    };

    // [3] ì„ íƒ ì™„ë£Œ -> ì—ë””í„° ì´ë™ ë˜ëŠ” ì¥ë°”êµ¬ë‹ˆ (ì•ˆì „ì„± ê°•í™” ë²„ì „)
    window.confirmChoice = function(mode) {
        if (window.isDirectCartAddInProgress) return;
        
        // 1. ìƒí’ˆ ì •ë³´ í™•ì¸ (ì—†ìœ¼ë©´ ì¤‘ë‹¨)
        const product = window.selectedProductForChoice;
        if (!product) return alert("ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");

        // â˜… [í•µì‹¬] ìƒí’ˆ ì½”ë“œ í™•ì‹¤í•˜ê²Œ ê°€ì ¸ì˜¤ê¸° (ë³€ìˆ˜ ì˜ì¡´ì„± ì œê±°)
        const targetCode = product.code || window.currentProductKey;
        if (!targetCode) return alert("ìƒí’ˆ ì½”ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");

        // 2. ì–¸ì–´ ê°ì§€
        const urlParams = new URLSearchParams(window.location.search);
        let lang = urlParams.get('lang');
        if (!lang) {
            if (window.location.hostname.includes('cafe0101.com')) lang = 'ja';
            else if (window.location.hostname.includes('cafe3355.com')) lang = 'en';
            else lang = 'kr';
        }

        // 3. ë‹¨ê°€ ê²°ì • (êµ­ê°€ë³„ ê°€ê²©)
        let unitPrice = product.price || 0;
        if (lang === 'ja' && product.price_jp && product.price_jp > 0) unitPrice = product.price_jp;
        else if (lang === 'en' && product.price_us && product.price_us > 0) unitPrice = product.price_us;

        // 4. ìµœì¢… ê°€ê²© ë° ì‚¬ì´ì¦ˆ ê³„ì‚°
        let finalW = 0, finalH = 0;
        let finalPricePerItem = unitPrice;
        let finalQty = 1;

        // ì»¤ìŠ¤í…€ ëª¨ë“œì¼ ê²½ìš° ì¬ê³„ì‚°
        if (window.isCustomModeCurrent) {
            finalW = parseInt(document.getElementById('inputCustW').value || 0);
            finalH = parseInt(document.getElementById('inputCustH').value || 0);
            finalQty = parseInt(document.getElementById('inputCustQty').value || 1);
            
            if (finalW < 20 || finalH < 20) return alert("ìµœì†Œ ì‚¬ì´ì¦ˆëŠ” 100mm ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
            
            const area = (finalW * finalH) / 1000000;
            let rawPrice = area * unitPrice;

            if (lang === 'kr') {
                finalPricePerItem = Math.floor(rawPrice / 10) * 10;
            } else {
                finalPricePerItem = Math.floor(rawPrice);
            }
        } else {
            // ì¼ë°˜ ìƒí’ˆì´ë©´ ê¸°ë³¸ ì‚¬ì´ì¦ˆ ì‚¬ìš©
            finalW = product.width_mm || 0;
            finalH = product.height_mm || 0;
            finalQty = parseInt(document.getElementById('fixedProdQty') ? document.getElementById('fixedProdQty').value : 1);
        }

        // 5. ì˜µì…˜ ìˆ˜ì§‘
        const selectedAddonCodes = [];
        document.querySelectorAll('input[name="userOption"]:checked').forEach(chk => {
            selectedAddonCodes.push(chk.value);
        });

        // 6. ì‹¤í–‰ (ì—ë””í„° or ì¥ë°”êµ¬ë‹ˆ)
        if (mode === 'editor') {
            document.getElementById('choiceModal').style.display = 'none';
            window.pendingSelectedAddons = selectedAddonCodes; 
            
            // â˜… [ìˆ˜ì •] í™•ì‹¤í•˜ê²Œ ì°¾ì€ targetCodeë¥¼ ë„˜ê²¨ì¤Œ
            window.startEditorDirect(
                targetCode, 
                window.isCustomModeCurrent ? finalW : null, 
                window.isCustomModeCurrent ? finalH : null,
                window.isCustomModeCurrent ? finalPricePerItem : null
            );
        } else if (mode === 'cart') {
            window.isDirectCartAddInProgress = true;
            setTimeout(() => { window.isDirectCartAddInProgress = false; }, 3000);
            document.getElementById('choiceModal').style.display = 'none';

            import('./order.js?v=119').then(m => {
                const productToCart = { ...product };
                productToCart.price = finalPricePerItem;

                if (window.isCustomModeCurrent) {
                    productToCart.name += ` (${finalW}x${finalH}mm)`;
                    productToCart.width_mm = finalW;
                    productToCart.height_mm = finalH;
                    productToCart.is_custom = true;
                }
                
                m.addProductToCartDirectly(productToCart, finalQty, selectedAddonCodes); 
                document.getElementById('cartAddedModal').style.display = 'flex'; 
            });
        }
    };

    // ===== ìƒí’ˆ ë¦¬ë·° ì‹œìŠ¤í…œ =====
    window.productReviewPage = 0;
    window.REVIEW_PAGE_SIZE = 10;
    window.currentReviewProductCode = null;
    window.currentReviewLang = (function(){ var p = new URLSearchParams(window.location.search).get('lang'); if(p) return p.toLowerCase() === 'jp' ? 'ja' : p.toLowerCase() === 'us' ? 'en' : p.toLowerCase(); var h = window.location.hostname; if(h.includes('cafe0101.com')) return 'ja'; if(h.includes('cafe3355.com')) return 'en'; return 'kr'; })();
    window.productReviewRating = 5;

    window.loadProductReviews = async function(productCode, page) {
        const dbClient = window.sb || sb;
        if (!dbClient || typeof dbClient.from !== 'function') {
            console.warn('[ë¦¬ë·°] DB í´ë¼ì´ì–¸íŠ¸ ì—†ìŒ');
            window.renderReviews([], 0, 0);
            return;
        }
        const lang = window.currentReviewLang || 'kr';
        const from = page * window.REVIEW_PAGE_SIZE;
        const to = from + window.REVIEW_PAGE_SIZE - 1;

        try {
            const { data, count, error } = await dbClient.from('product_reviews')
                .select('*', { count: 'exact' })
                .eq('product_code', productCode)
                .eq('lang', lang)
                .order('created_at', { ascending: false })
                .range(from, to);

            if (error) {
                console.warn('[ë¦¬ë·°] ì¡°íšŒ ì—ëŸ¬:', error.message);
                window.renderReviews([], 0, 0, 0);
                return;
            }

            // page 0ì¼ ë•Œ í‰ê·  ë³„ì  ê³„ì‚°
            let avgRating = 0;
            if (page === 0 && (count || 0) > 0) {
                try {
                    const { data: allRatings } = await dbClient.from('product_reviews')
                        .select('rating')
                        .eq('product_code', productCode)
                        .eq('lang', lang);
                    if (allRatings && allRatings.length > 0) {
                        avgRating = allRatings.reduce((sum, r) => sum + r.rating, 0) / allRatings.length;
                    }
                } catch(e2) { console.warn('[ë¦¬ë·°] í‰ê·  ê³„ì‚° ì‹¤íŒ¨:', e2); }
            }
            window.renderReviews(data || [], count || 0, page, avgRating);
        } catch (e) {
            console.warn('[ë¦¬ë·°] ì˜ˆì™¸:', e);
            window.renderReviews([], 0, 0, 0);
        }
    };

    window.renderReviews = function(reviews, total, page, avgRating) {
        const listEl = document.getElementById('reviewList');
        const summaryEl = document.getElementById('reviewSummary');
        const moreBtn = document.getElementById('btnLoadMoreReviews');
        if (!listEl) return;

        // ìš”ì•½ (í‰ê·  ë³„ì  + ìˆ«ì)
        if (page === 0 && summaryEl) {
            if (total > 0) {
                const avg = avgRating ? avgRating.toFixed(1) : '0.0';
                const fullStars = Math.round(avgRating || 0);
                const avgStars = 'â˜…'.repeat(Math.min(fullStars, 5)) + 'â˜†'.repeat(Math.max(5 - fullStars, 0));
                const countText = total + ' ' + window.t('rv_total_reviews', 'ê°œì˜ ë¦¬ë·°');
                summaryEl.innerHTML = `
                    <div class="review-avg-score">${avg}</div>
                    <div>
                        <div class="review-avg-stars">${avgStars}</div>
                        <div style="font-size:13px;color:#64748b;margin-top:4px;">${countText}</div>
                    </div>`;
            } else {
                summaryEl.innerHTML = `<div style="color:#999;font-size:14px;">${window.t('rv_no_reviews','ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤')}</div>`;
            }
        }

        // ë¦¬ë·° ì¹´ë“œ ë Œë”ë§
        let html = '';
        reviews.forEach(r => {
            const stars = 'â˜…'.repeat(r.rating) + 'â˜†'.repeat(5 - r.rating);
            const date = new Date(r.created_at).toLocaleDateString();
            const hasPhoto = r.photo_url && r.photo_url.trim();
            const photoHtml = hasPhoto ? `
                <div class="review-photo-wrap">
                    <img src="${r.photo_url}" class="review-photo" alt="ë¦¬ë·° ì‚¬ì§„" onclick="window.openReviewPhoto('${r.photo_url}')" loading="lazy">
                </div>` : '';
            html += `
                <div class="review-card ${hasPhoto ? 'has-photo' : ''}">
                    <div class="review-stars">${stars}</div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
                        <span style="font-weight:700;font-size:14px;color:#333;">${r.user_name}</span>
                        <span style="font-size:12px;color:#94a3b8;">${date}</span>
                    </div>
                    <p style="margin-top:10px;font-size:14px;line-height:1.6;color:#475569;">${r.comment}</p>
                    ${photoHtml}
                </div>`;
        });

        if (page === 0) {
            listEl.innerHTML = html || '';
        } else {
            listEl.innerHTML += html;
        }

        // ë”ë³´ê¸° ë²„íŠ¼
        if (moreBtn) {
            const loaded = (page + 1) * window.REVIEW_PAGE_SIZE;
            moreBtn.style.display = loaded < total ? 'block' : 'none';
        }
    };

    window.loadMoreReviews = function() {
        window.productReviewPage++;
        window.loadProductReviews(window.currentReviewProductCode, window.productReviewPage);
    };

    window.setProductReviewRating = function(score) {
        window.productReviewRating = score;
        for (let i = 1; i <= 5; i++) {
            const el = document.getElementById('prvStar' + i);
            if (el) el.style.color = i <= score ? '#f59e0b' : '#e2e8f0';
        }
    };

    window._reviewFormRetryCount = 0;
    window.renderReviewWriteForm = function(productCode) {
        const area = document.getElementById('reviewWriteArea');
        if (!area) return;

        if (!window.currentUser) {
            // ì¸ì¦ ë¡œë”© ëŒ€ê¸° (ìµœëŒ€ 3ì´ˆ, 6íšŒ ì¬ì‹œë„)
            if (window._reviewFormRetryCount < 6) {
                window._reviewFormRetryCount++;
                area.innerHTML = `<div class="review-write-box" style="text-align:center;color:#94a3b8;font-size:14px;padding:15px;">
                    <i class="fa-solid fa-spinner fa-spin" style="margin-right:5px;"></i> ${window.t('rv_loading','ë¡œë”© ì¤‘...')}
                </div>`;
                setTimeout(() => window.renderReviewWriteForm(productCode), 500);
                return;
            }
            window._reviewFormRetryCount = 0;
            area.innerHTML = `<div class="review-write-box" style="text-align:center;color:#94a3b8;font-size:14px;padding:15px;">
                <i class="fa-solid fa-lock" style="margin-right:5px;"></i> ${window.t('rv_login_required','ë¡œê·¸ì¸ í›„ ë¦¬ë·°ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤')}
            </div>`;
            return;
        }
        window._reviewFormRetryCount = 0;

        area.innerHTML = `
            <div class="review-write-box">
                <div style="font-weight:700;font-size:15px;margin-bottom:12px;">${window.t('rv_write','ë¦¬ë·° ì‘ì„±')}</div>
                <div class="review-star-selector" style="margin-bottom:12px;">
                    <i class="fa-solid fa-star" id="prvStar1" style="color:#f59e0b;" onclick="window.setProductReviewRating(1)"></i>
                    <i class="fa-solid fa-star" id="prvStar2" style="color:#f59e0b;" onclick="window.setProductReviewRating(2)"></i>
                    <i class="fa-solid fa-star" id="prvStar3" style="color:#f59e0b;" onclick="window.setProductReviewRating(3)"></i>
                    <i class="fa-solid fa-star" id="prvStar4" style="color:#f59e0b;" onclick="window.setProductReviewRating(4)"></i>
                    <i class="fa-solid fa-star" id="prvStar5" style="color:#f59e0b;" onclick="window.setProductReviewRating(5)"></i>
                </div>
                <textarea id="prvComment" class="ai-input-pretty" placeholder="${window.t('rv_placeholder','ìƒí’ˆì— ëŒ€í•œ ì†”ì§í•œ ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”')}" style="height:80px;width:100%;resize:vertical;"></textarea>
                <div style="display:flex;align-items:center;gap:10px;margin-top:10px;">
                    <label style="cursor:pointer;display:flex;align-items:center;gap:5px;font-size:13px;color:#6366f1;">
                        <i class="fa-solid fa-camera"></i> ${window.t('rv_photo_add','ì‚¬ì§„ ì²¨ë¶€')}
                        <input type="file" id="prvPhoto" accept="image/*" style="display:none;">
                    </label>
                    <span id="prvPhotoName" style="font-size:12px;color:#94a3b8;"></span>
                    <div style="flex:1;"></div>
                    <button onclick="window.submitProductReview()" class="btn-round primary" style="padding:8px 20px;font-size:13px;">${window.t('rv_submit','ë¦¬ë·° ë“±ë¡')}</button>
                </div>
                <div id="prvPhotoPreview"></div>
            </div>`;

        document.getElementById('prvPhoto').addEventListener('change', function() {
            const file = this.files[0];
            const nameEl = document.getElementById('prvPhotoName');
            const previewEl = document.getElementById('prvPhotoPreview');
            if (file) {
                nameEl.innerText = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (previewEl) previewEl.innerHTML = `<img src="${e.target.result}" style="max-width:150px;max-height:150px;border-radius:8px;margin-top:8px;object-fit:cover;border:1px solid #eee;">`;
                };
                reader.readAsDataURL(file);
            } else {
                nameEl.innerText = '';
                if (previewEl) previewEl.innerHTML = '';
            }
        });
    };

    // ë¦¬ë·° ì‚¬ì§„ ë¼ì´íŠ¸ë°•ìŠ¤
    window.openReviewPhoto = function(url) {
        const overlay = document.createElement('div');
        overlay.className = 'review-lightbox';
        overlay.innerHTML = `<img src="${url}" alt="ë¦¬ë·° ì‚¬ì§„"><div class="review-lightbox-close">&times;</div>`;
        overlay.addEventListener('click', () => overlay.remove());
        document.body.appendChild(overlay);
    };

    window.submitProductReview = async function() {
        const dbClient = window.sb || sb;
        if (!dbClient || !window.currentUser) return alert(window.t('rv_login_required', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'));
        const comment = document.getElementById('prvComment').value.trim();
        if (!comment) return alert(window.t('rv_placeholder', 'ë¦¬ë·°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'));

        const productCode = window.currentReviewProductCode;
        const lang = window.currentReviewLang || 'kr';
        const rating = window.productReviewRating || 5;
        const email = window.currentUser.email || '';
        const userName = email.split('@')[0].substring(0, 2) + '**';

        let photoUrl = null;
        const fileInput = document.getElementById('prvPhoto');
        if (fileInput && fileInput.files[0]) {
            const file = fileInput.files[0];
            const ext = file.name.split('.').pop() || 'jpg';
            const fileName = `review_${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;
            try {
                const { data, error } = await dbClient.storage.from('review-photos').upload(fileName, file, {
                    cacheControl: '3600',
                    upsert: false
                });
                if (error) {
                    console.error('[ë¦¬ë·° ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨]', error.message);
                    // Storage ë²„í‚·ì´ ì—†ìœ¼ë©´ ë¦¬ë·° ìì²´ëŠ” ì‚¬ì§„ ì—†ì´ ì €ì¥
                } else if (data) {
                    const { data: urlData } = dbClient.storage.from('review-photos').getPublicUrl(data.path);
                    photoUrl = urlData.publicUrl;
                }
            } catch (uploadErr) {
                console.error('[ë¦¬ë·° ì‚¬ì§„ ì—…ë¡œë“œ ì˜ˆì™¸]', uploadErr);
            }
        }

        const { error } = await dbClient.from('product_reviews').insert({
            product_code: productCode,
            user_id: window.currentUser.id,
            user_name: userName,
            rating: rating,
            comment: comment,
            photo_url: photoUrl,
            lang: lang,
            is_fake: false
        });

        if (error) {
            alert(window.t('err_prefix', 'ì˜¤ë¥˜: ') + error.message);
        } else {
            alert(window.t('rv_submitted', 'ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!'));
            document.getElementById('prvComment').value = '';
            if (fileInput) fileInput.value = '';
            document.getElementById('prvPhotoName').innerText = '';
            window.productReviewPage = 0;
            window.loadProductReviews(productCode, 0);
        }
    };

    // [ì‹ ê·œ] ì™„ë£Œ ëª¨ë‹¬ : ê²°ì œí•˜ëŸ¬ ê°€ê¸° ë²„íŠ¼
    window.goToCartFromSuccess = function() {
        document.getElementById('cartAddedModal').style.display = 'none'; // ì™„ë£Œ ëª¨ë‹¬ ë‹«ê¸°
        document.getElementById('cartPage').style.display = 'block';      // ì¥ë°”êµ¬ë‹ˆ ì—´ê¸°
        if(window.renderCart) window.renderCart(); // ì¥ë°”êµ¬ë‹ˆ ê°±ì‹  (ì•ˆì „ì¥ì¹˜)
    };

    // [ì‹ ê·œ] ì™„ë£Œ ëª¨ë‹¬ : ë‹¤ë¥¸ ì œí’ˆ êµ¬ë§¤í•˜ê¸° ë²„íŠ¼ (ì‹œì‘í™”ë©´ìœ¼ë¡œ)
    window.continueShopping = function() {
        document.getElementById('cartAddedModal').style.display = 'none'; // ì™„ë£Œ ëª¨ë‹¬ ë‹«ê¸°
        document.getElementById('categoryDetailModal').style.display = 'none'; // ì¹´í…Œê³ ë¦¬ì°½ë„ ë‹«ê¸°(í•„ìš”ì‹œ)
        // ì‹œì‘ í™”ë©´ì€ ì´ë¯¸ ë°°ê²½ì— ê¹”ë ¤ ìˆìœ¼ë¯€ë¡œ ëª¨ë‹¬ë§Œ ë‹«ìœ¼ë©´ ë©ë‹ˆë‹¤.
        // ë§Œì•½ ìƒˆë¡œê³ ì¹¨ì´ í•„ìš”í•˜ë‹¤ë©´ location.reload()ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
    };

    // [ì¶”ê°€] ì¥ë°”êµ¬ë‹ˆ ì¼ê´„ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    window.handleBulkCartUpload = function(input) {
        if (input.files.length === 0) return;
        import('./order.js?v=119').then(m => {
            m.processBulkCartUpload(input.files);
            input.value = ''; // ì´ˆê¸°í™”
        });
    };

    const directUploadInput = document.getElementById("directUploadInput");
    if (directUploadInput) {
        directUploadInput.onchange = async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const product = window.selectedProductForChoice;
            if (!product) return alert("ìƒí’ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");

            const loading = document.getElementById("loading");
            if (loading) loading.style.display = "flex";

            try {
                let thumbUrl = 'https://placehold.co/100?text=FILE';
                let fileDataURI = null;

                if (file.type === 'application/pdf') {
                    if (window.pdfjsLib && !window.pdfjsLib.GlobalWorkerOptions.workerSrc) {
                        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    }
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        const page = await pdf.getPage(1);
                        const viewport = page.getViewport({ scale: 1 });
                        const scale = 150 / viewport.width;
                        const scaledViewport = page.getViewport({ scale });
                        const cvs = document.createElement('canvas');
                        const ctx = cvs.getContext('2d');
                        cvs.height = scaledViewport.height;
                        cvs.width = scaledViewport.width;
                        await page.render({ canvasContext: ctx, viewport: scaledViewport }).promise;
                        thumbUrl = cvs.toDataURL('image/jpeg', 0.8);
                    } catch (err) { console.warn("PDF Thumb Error:", err); }
                } else if (file.type.startsWith('image/')) {
                    fileDataURI = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = (evt) => resolve(evt.target.result);
                        reader.readAsDataURL(file);
                    });
                    thumbUrl = fileDataURI;
                }

                if (!fileDataURI) {
                     fileDataURI = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = (evt) => resolve(evt.target.result);
                        reader.readAsDataURL(file);
                    });
                }

                const newItem = {
                    uid: Date.now(),
                    product: product,
                    type: 'file',
                    fileName: file.name,
                    mimeType: file.type,
                    fileData: fileDataURI,
                    thumb: thumbUrl,
                    qty: 1,
                    selectedAddons: {},
                    isOpen: true
                };

                if (typeof cartData !== 'undefined') {
                    cartData.push(newItem);
                    try {
                        const user = typeof currentUser !== 'undefined' ? currentUser : null;
                        const storageKey = user ? `chameleon_cart_${user.id}` : 'chameleon_cart_guest';
                        localStorage.setItem(storageKey, JSON.stringify(cartData));
                    } catch(err) {}
                }

                if (window.renderCart) window.renderCart();
                document.getElementById('choiceModal').style.display = 'none';
                document.getElementById('cartPage').style.display = 'block';
                
            } catch (err) {
                console.error(err);
                alert("íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                if (loading) loading.style.display = "none";
                directUploadInput.value = ''; 
            }
        };
    }

    // ============================================================
    // [5] ì—ë””í„° ì‹œì‘ ë° í…œí”Œë¦¿ ë¡œë“œ
    // ============================================================
    // ============================================================
    // [5] ì—ë””í„° ì‹œì‘ ë° í…œí”Œë¦¿ ë¡œë“œ (ìˆ˜ì •ë¨: ë¡œê·¸ì¸ ì²´í¬ + í…œí”Œë¦¿ íŒì—…)
    // ============================================================
    // [í°íŠ¸ ë™ì  ë¡œë”© í•¨ìˆ˜ ì¶”ê°€]
    function loadEditorFonts() {
        if (window.isFontsLoaded) return; // ì´ë¯¸ ë¡œë“œí–ˆìœ¼ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
        console.log("ğŸ¨ ì—ë””í„°ìš© ì„œì²´ ë¡œë”© ì‹œì‘...");
        
        const fonts = [
            "https://cdn.jsdelivr.net/gh/orioncactus/GmarketSans/build/GmarketSans.css",
            "https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&family=Nanum+Myeongjo:wght@400;700;800&family=Do+Hyeon&family=Jua&display=swap"
        ];

        fonts.forEach(url => {
            const link = document.createElement('link');
            link.href = url;
            link.rel = 'stylesheet';
            document.head.appendChild(link);
        });
        window.isFontsLoaded = true;
    }

    // [ìˆ˜ì •ë¨] ì—ë””í„° ì§„ì… (DB ë°ì´í„° ì•ˆì „ ë¡œë”© ì¶”ê°€)
    // [ìˆ˜ì •ë¨] ì—ë””í„° ì§„ì… (DB ë°ì´í„° ì•ˆì „ ë¡œë”© ì¶”ê°€)
    window.startEditorDirect = async function(key, customW = null, customH = null, customPrice = null) {
        
        // 1. [ê²€ì¦] ë¡œê·¸ì¸ ì²´í¬
        const { data } = await sb.auth.getSession();
        if (!data || !data.session || !data.session.user) {
            alert(window.t('msg_login_required_design'));
            document.getElementById('loginModal').style.display = 'flex';
            return; 
        }

        if (!key) return alert("ìƒí’ˆ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");

        // 2. [ì„¤ì •] ìƒí’ˆ ì •ë³´ ë¡œë“œ (ì „ì—­ ë³€ìˆ˜ì— ì—†ìœ¼ë©´ DBì—ì„œ ê°€ì ¸ì˜´)
        window.currentProductKey = key;
        if(canvas) canvas.currentProductKey = key;
        
        if (!window.PRODUCT_DB) window.PRODUCT_DB = {};
        
        // â˜… [í•µì‹¬] ë°ì´í„°ê°€ ë¹„ì–´ìˆìœ¼ë©´ DBì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì•ˆì „ì¥ì¹˜
        if (!window.PRODUCT_DB[key]) {
            console.log("ğŸ”„ ì—ë””í„°ìš© ìƒí’ˆ ì •ë³´ ë¡œë”© ì¤‘...");
            const { data: prodData, error } = await sb.from('admin_products').select('*').eq('code', key).single();
            if (error || !prodData) {
                console.error("ìƒí’ˆ ë¡œë“œ ì‹¤íŒ¨:", error);
                return alert("ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            window.PRODUCT_DB[key] = prodData;
        }

        const product = window.PRODUCT_DB[key];

        // ì»¤ìŠ¤í…€ ê°€ê²©/ì‚¬ì´ì¦ˆ ì ìš©
        if (customPrice !== null) {
            product.price = customPrice;
            product.is_custom_size = true; 
            product.w_mm = customW; 
            product.h_mm = customH;
            console.log(`[ì—ë””í„° ì§„ì…] ê°€ê²© ì¡°ì •ë¨: ${customPrice.toLocaleString()}`);
        }

        // ì‚¬ì´ì¦ˆ ê³„ì‚°
        const displayW = customW || (product ? (product.w_mm || product.w || 210) : 210);
        const displayH = customH || (product ? (product.h_mm || product.h || 297) : 297);
        const maxSide = Math.max(displayW, displayH);

        if (product && maxSide >= 800) {
            alert(window.t('msg_large_product_warning'));
        }
        
        // í”½ì…€ ë³€í™˜ ë° ìº”ë²„ìŠ¤ ì„¤ì •
        const canvasW = Math.round(displayW * 3.7795);
        const canvasH = Math.round(displayH * 3.7795);
        const mode = (typeof key === 'string' && key.includes('Wall')) ? 'wall' : 'standard';

        if (typeof setMaxLimits === 'function') setMaxLimits(displayW, displayH);
        
        const limitLabel = document.getElementById("limitLabel");
        if(limitLabel) limitLabel.innerText = `Max: ${displayW}x${displayH}`;
        
        const inpW = document.getElementById("inputUserW");
        const inpH = document.getElementById("inputUserH");
        if(inpW) inpW.value = displayW;
        if(inpH) inpH.value = displayH;

        // 3. í™”ë©´ ì „í™˜
        document.getElementById("startScreen").style.display = "none";
        document.getElementById("mainEditor").style.display = "flex"; 
        
        const tplTabs = document.querySelector('.template-tabs');
        if(tplTabs) tplTabs.style.display = 'flex';
        document.body.classList.add('editor-active'); 

        // ì‚¬ì´ë“œë°” í…œí”Œë¦¿ ë¡œë“œ (PCë§Œ)
        if (window.innerWidth > 768 && typeof window.loadSideBarTemplates === 'function') {
            window.loadSideBarTemplates(key);
        }
        
        // if (window.ChannelIO) ChannelIO('hide'); // ì±„ë„í†¡ ë¹„í™œì„±í™”ë¨
        window.dispatchEvent(new Event('resize'));

        if (window.applySize) window.applySize(canvasW, canvasH, key, mode, 'replace');

        // 4. ë¦¬ì†ŒìŠ¤ ë¡œë”©
        loadEditorFonts(); 

        if (!window.isObjectsLoaded) {
            try {
                await import('./canvas-objects.js?v=119');
                window.isObjectsLoaded = true;
            } catch (e) {
                console.error("ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì‹¤íŒ¨:", e);
            }
        }

        if (window.initCanvasFonts) {
            window.initCanvasFonts().then(() => console.log("âœ… ì„œì²´ ë¡œë”© ì™„ë£Œ")); 
        }

        // í…œí”Œë¦¿ ì²˜ë¦¬
        if (window.pendingTemplate) {
            setTimeout(async () => {
                if (window.applyStartTemplate) await window.applyStartTemplate(window.pendingTemplate);
                window.pendingTemplate = null;
            }, 500);
        }

        // AI ì´ë¯¸ì§€ ì²˜ë¦¬
        if (window.pendingAiImage) {
            const loading = document.getElementById("loading");
            if(loading) loading.style.display = 'flex';

            fabric.Image.fromURL(window.pendingAiImage, (img) => {
                if (!img) return;
                const board = canvas.getObjects().find(o => o.isBoard);
                const cW = board ? board.width * board.scaleX : canvas.width;
                const cH = board ? board.height * board.scaleY : canvas.height;
                const cX = board ? board.left + cW / 2 : canvas.width / 2;
                const cY = board ? board.top + cH / 2 : canvas.height / 2;
                const scale = Math.min((cW * 0.8) / img.width, (cH * 0.8) / img.height);
                
                img.set({
                    scaleX: scale, scaleY: scale, left: cX, top: cY,
                    originX: 'center', originY: 'center'
                });
                canvas.add(img);
                canvas.setActiveObject(img);
                canvas.requestRenderAll();
                window.pendingAiImage = null;
                if(loading) loading.style.display = 'none';
            }, { crossOrigin: 'anonymous' });
        }
    };

    window.onTemplateClick = async function(tpl) {
        const startScreen = document.getElementById('startScreen');
        const isEditorOpen = startScreen && window.getComputedStyle(startScreen).display === 'none';

       if (isEditorOpen) {
            if(!confirm(window.t('msg_template_apply_confirm'))) return;
            await applyTemplateDirectly(tpl);
        } else {
            window.pendingTemplate = tpl; 
            showCategorySelectionModal(); 
        }
    };

    function finishLoading() {
        document.getElementById("loading").style.display = "none";
        document.getElementById('templateOverlay').style.display = 'none';
    }


    // ============================================================
    // [1] ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë“œ (ì•ˆì •í™” ìµœì¢… ë²„ì „)
    // ============================================================
    window.addEventListener('load', async () => {
        // 1. ì„¤ì • ë¡œë”© ëŒ€ê¸° (config.jsì˜ ì‘ì—…ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼)
        if (window.initConfig) await window.initConfig(); 
        else if (typeof initConfig === 'function') await initConfig();

        // 2. ì¹´í…Œê³ ë¦¬ ë©”ë‰´ ë Œë”ë§
        if (typeof renderQuickMenu === 'function') renderQuickMenu();
        
        // 3. í…œí”Œë¦¿ ë° ìƒí’ˆ ë¡œë“œ
        if(window.searchTemplates) window.searchTemplates('');
        if (window.preloadLanguageFont) window.preloadLanguageFont();
        if (typeof loadSpecialProducts === 'function') {
            loadSpecialProducts('hotDealSection', 'hotDealGrid', 'hotdeal', 6);
            loadSpecialProducts('bizDealSection', 'bizDealGrid', '23432424', 6);
        }

        // 4. ë¡œê·¸ì¸ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (config.js ì™„ë£Œ í›„ ì‹¤í–‰ë˜ë¯€ë¡œ ì•ˆì „í•¨)
        const btnLogin = document.getElementById('btnLoginBtn');
        const btnConsole = document.getElementById('btnPartnerConsole');
        
        // config.jsì—ì„œ ì„¤ì •ëœ currentUser ë³€ìˆ˜ ì‚¬ìš©
        if (window.currentUser) {
            console.log("âœ… ë¡œê·¸ì¸ ë¨:", window.currentUser.email);
            if (btnLogin) {
                // [ìˆ˜ì •] "ë¡œê·¸ì•„ì›ƒ" -> window.t('btn_logout')
                btnLogin.innerText = window.t('btn_logout');
                btnLogin.style.fontWeight = "bold"; 
                btnLogin.style.color = "#ef4444"; 
                btnLogin.onclick = async function() {
                    // [ìˆ˜ì •] "ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" -> window.t('msg_logout_confirm')
                    if (confirm(window.t('msg_logout_confirm'))) {
                        await sb.auth.signOut();
                        localStorage.removeItem('sb-qinvtnhiidtmrzosyvys-auth-token'); 
                        window.location.reload(); 
                    }
                };
            }
            if(btnConsole) btnConsole.style.removeProperty('display');
        } else {
            if (btnLogin) {
                // [ìˆ˜ì •] "ë¡œê·¸ì¸" -> window.t('btn_login')
                btnLogin.innerText = window.t('btn_login');
                btnLogin.onclick = () => document.getElementById('loginModal').style.display = 'flex';
            }
            if(btnConsole) btnConsole.style.setProperty('display', 'none', 'important');
        }

        // 5. ê²€ìƒ‰ì°½ ì—°ê²°
        const searchBtn = document.getElementById('btnStartSearch');
        const searchInput = document.getElementById('startSearchInput');
        if (searchBtn && searchInput) {
            const doSearch = () => { if(window.searchTemplates) window.searchTemplates(searchInput.value); };
            searchBtn.onclick = doSearch;
            searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') doSearch(); });
        }
    });


// ==========================================
    // [1] í…œí”Œë¦¿ í˜ì´ì§• ì‹œìŠ¤í…œ (28ê°œì”© ë³´ê¸°) - ìˆ˜ì •ë¨
    // ==========================================

    const ITEMS_PER_PAGE = 10; // í•œ í˜ì´ì§€ë‹¹ 28ê°œ
    let currentTemplatePage = 0;
    let lastSearchKeyword = '';

    // 1. ê²€ìƒ‰ ì‹œì‘ (ì´ˆê¸°í™”)
    window.searchTemplates = function(keyword = '') {
        lastSearchKeyword = keyword;
        currentTemplatePage = 0; 
        loadTemplatePage(0);
    };

    // 2. í˜ì´ì§€ ë³€ê²½ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ (HTMLì˜ onclickê³¼ ì—°ê²°ë¨)
    window.changeTemplatePage = function(delta) {
        const newPage = currentTemplatePage + delta;
        if (newPage < 0) return; // 0í˜ì´ì§€ ë¯¸ë§Œ ë°©ì§€
        loadTemplatePage(newPage);
    };

    // 3. ë°ì´í„° ë¡œë“œ ë° ê·¸ë¦¬ê¸° (í•µì‹¬ í•¨ìˆ˜)
    async function loadTemplatePage(page) {
        const grid = document.getElementById('startTemplateGrid');
        if (!grid) return;
        if (!sb) { console.warn("[loadTemplatePage] sbê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ"); return; }

        // ë¡œë”© í‘œì‹œ
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:60px; color:#888;"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><br><br>ë¡œë”© ì¤‘...</div>';

        try {
            // DB ì¿¼ë¦¬ ì¤€ë¹„
            let query = sb.from('library')
                .select('id, thumb_url, category, tags', { count: 'exact' }) // ì „ì²´ ê°œìˆ˜ë„ ê°™ì´ ê°€ì ¸ì˜´
                .order('created_at', { ascending: false })
                // â˜… [ìˆ˜ì •] ìœ ì € í…œí”Œë¦¿(ë²¡í„°/ì´ë¯¸ì§€) + ì‚¬ì§„(photo-bg)ê¹Œì§€ í¬í•¨
                .in('category', ['user_vector', 'user_image', 'photo-bg']) 
                .range(page * ITEMS_PER_PAGE, (page + 1) * ITEMS_PER_PAGE - 1); // ë²”ìœ„ ì„¤ì •

            // ê²€ìƒ‰ì–´ í•„í„° (íƒœê·¸ ê²€ìƒ‰)
            if (lastSearchKeyword && lastSearchKeyword.trim() !== '') {
                query = query.ilike('tags', `%${lastSearchKeyword}%`);
            }

            const { data, error, count } = await query;

            if (error) throw error;

            grid.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì§€ìš°ê¸°

            // ë°ì´í„°ê°€ ì—†ì„ ë•Œ
            if (!data || data.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:60px; color:#FFFFFF;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                updatePaginationButtons(page, 0);
                return;
            }

            // [ìˆ˜ì •] ì¹´ë“œ ìƒì„± (ì •ì‚¬ê°í˜• í”„ë ˆì„ + ëª¨ë“  ë±ƒì§€ í‘œì‹œ)
            data.forEach(tpl => {
                const card = document.createElement('div');
                card.className = 'tpl-card-start'; 
                
                // 1. ì¹´í…Œê³ ë¦¬ë³„ ë±ƒì§€ ì„¤ì • (ëª¨ë“  ì¢…ë¥˜ ì¶”ê°€)
                let badgeText = '';
                let badgeColor = '#64748b'; // ê¸°ë³¸ íšŒìƒ‰

                switch (tpl.category) {
                    case 'user_vector': badgeText = 'User Vector'; badgeColor = '#7c3aed'; break; // ë³´ë¼ìƒ‰
                    case 'user_image':  badgeText = 'User Image'; badgeColor = '#059669'; break;  // ì´ˆë¡ìƒ‰
                    case 'vector':      badgeText = 'Vector'; badgeColor = '#7c3aed'; break;
                    case 'photo-bg':    badgeText = 'Image'; badgeColor = '#059669'; break;
                    case 'graphic':     badgeText = 'Graphic'; badgeColor = '#2563eb'; break; // íŒŒë€ìƒ‰
                    case 'pattern':
                    case 'transparent-graphic': badgeText = 'Pattern'; badgeColor = '#db2777'; break; // í•‘í¬ìƒ‰
                    case 'logo':        badgeText = 'Logo'; badgeColor = '#d97706'; break; // ì£¼í™©ìƒ‰
                    case 'text':        badgeText = 'Text'; badgeColor = '#475569'; break;
                }

                // ë±ƒì§€ HTML ìƒì„±
                let badgeHtml = '';
                if (badgeText) {
                    badgeHtml = `<span style="position:absolute; top:10px; left:10px; background:${badgeColor}; color:white; font-size:10px; font-weight:800; padding:4px 8px; border-radius:6px; z-index:5; box-shadow:0 2px 4px rgba(0,0,0,0.2); text-transform:uppercase; letter-spacing:0.5px;">${badgeText}</span>`;
                }

                // 2. ì´ë¯¸ì§€ ìµœì í™” (ì •ì‚¬ê°í˜• 1:1 ë¹„ìœ¨ ìš”ì²­)
                let imgSrc = tpl.thumb_url || 'https://via.placeholder.com/300';
                if (imgSrc.includes('supabase.co')) {
                    const separator = imgSrc.includes('?') ? '&' : '?';
                    // widthì™€ heightë¥¼ ë˜‘ê°™ì´ ì„¤ì •í•˜ê³  resize=cover ì˜µì…˜ì„ ì£¼ì–´ ì •ì‚¬ê°í˜•ìœ¼ë¡œ ìë¦„
                    imgSrc += `${separator}width=400&height=400&resize=cover&format=webp&quality=70`;
                }

                // 3. HTML êµ¬ì„± ë° ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš©
                // aspect-ratio: 1/1 ì„ ì£¼ì–´ ê°•ì œë¡œ ì •ì‚¬ê°í˜•ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
                card.style.cssText = "aspect-ratio: 1/1; position: relative; overflow: hidden; border-radius: 16px; border: 1px solid #e5e7eb; background: #f8fafc;";
                
                card.innerHTML = `
                    ${badgeHtml}
                    <img src="${imgSrc}" class="tpl-card-img" loading="lazy" style="width:100%; height:100%; object-fit:cover; display:block;">
                    <div class="tpl-card-overlay"></div>
                `;
                
                card.onclick = () => { 
                    if(window.onTemplateClick) window.onTemplateClick(tpl); 
                };
                
                grid.appendChild(card);
            });

            // í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ ë° ë²„íŠ¼ ìƒíƒœ ê´€ë¦¬
            currentTemplatePage = page;
            updatePaginationButtons(page, data.length);

        } catch (e) {
            console.error("í…œí”Œë¦¿ ë¡œë“œ ì˜¤ë¥˜:", e);
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px;">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    // 4. ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ë° í˜ì´ì§€ ë²ˆí˜¸ í‘œì‹œ
    function updatePaginationButtons(page, currentItemsCount) {
    const btnPrev = document.getElementById('btnTplPrev');
    const btnNext = document.getElementById('btnTplNext');
    const lblPage = document.getElementById('tplPageLabel');

    // í•œê¸€ 'í˜ì´ì§€' ëŒ€ì‹  ì˜ë¬¸ 'PAGE'ë¡œ ì§ì ‘ ì£¼ì…
    if(lblPage) lblPage.innerHTML = `PAGE <span id="currentPageNum">${page + 1}</span>`;
    
    // ... ì´í•˜ ê¸°ì¡´ ì½”ë“œ ìœ ì§€

        // ì²« í˜ì´ì§€ë©´ 'ì´ì „' ë²„íŠ¼ ë¹„í™œì„±í™”
        if(btnPrev) {
            btnPrev.disabled = (page === 0);
            btnPrev.style.opacity = (page === 0) ? '0.5' : '1';
            btnPrev.style.cursor = (page === 0) ? 'default' : 'pointer';
        }

        // ê°€ì ¸ì˜¨ ë°ì´í„°ê°€ ì„¤ì • ê°œìˆ˜(28ê°œ)ë³´ë‹¤ ì ìœ¼ë©´ 'ë‹¤ìŒ' ë²„íŠ¼ ë¹„í™œì„±í™” (ë§ˆì§€ë§‰ í˜ì´ì§€)
        if(btnNext) {
            const isLastPage = currentItemsCount < ITEMS_PER_PAGE;
            btnNext.disabled = isLastPage;
            btnNext.style.opacity = isLastPage ? '0.5' : '1';
            btnNext.style.cursor = isLastPage ? 'default' : 'pointer';
        }
    }

    // PDF í°íŠ¸ ì„¤ì • (êµ­ê°€ë³„ ë¶„ê¸°)
    window.pdfFontCache = null;
    const _pdfFontMap = {
        'ja': { url: 'https://cdn.jsdelivr.net/gh/google/fonts@main/ofl/notosansjp/NotoSansJP-Regular.ttf', name: 'NotoSansJP' },
        'en': { url: 'https://cdn.jsdelivr.net/gh/google/fonts@main/ofl/inter/Inter%5Bopsz%2Cwght%5D.ttf', name: 'Inter' },
        'kr': { url: 'https://cdn.jsdelivr.net/gh/google/fonts@main/ofl/nanumgothic/NanumGothic-Regular.ttf', name: 'NanumGothic' }
    };
    const _pdfFont = _pdfFontMap[CURRENT_LANG] || _pdfFontMap['kr'];
    window.pdfFontName = _pdfFont.name;

    window.preloadLanguageFont = async function() {
        try {
            const r = await fetch(_pdfFont.url);
            if(r.ok) {
                const b = await r.blob();
                const rd = new FileReader();
                rd.onloadend = function() {
                    window.pdfFontCache = rd.result.split(',')[1];
                };
                rd.readAsDataURL(b);
            }
        } catch(e) { console.error("Font Load Error:", e); }
    };

    window.loadKoreanFontForPDF = async function(doc) {
        if(window.pdfFontCache) {
            try {
                const fileName = window.pdfFontName + '.ttf';
                doc.addFileToVFS(fileName, window.pdfFontCache);
                doc.addFont(fileName, window.pdfFontName, 'normal');
                doc.setFont(window.pdfFontName);
            } catch(e) { console.warn(e); }
        }
    };

    // ê¸°íƒ€ ìœ í‹¸
    window.toggleLockSelection = function() { if(!canvas)return; const a=canvas.getActiveObject(); if(!a)return alert("ì„ íƒí•„ìš”"); const l=!a.lockMovementX; a.set({lockMovementX:l,lockMovementY:l,lockRotation:l,lockScalingX:l,lockScalingY:l,hasControls:!l,selectable:true}); canvas.discardActiveObject(); canvas.requestRenderAll(); };
    window.setAsBackground = function() { 
    if(!canvas) return; 
    
    const a = canvas.getActiveObject(); 
    if(!a) return alert("ë°°ê²½ìœ¼ë¡œ ë§Œë“¤ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); 
    
    const b = canvas.getObjects().find(o => o.isBoard); 
    if(!b) return; 

    // 1.1ë°°(10%) ë” í¬ê²Œ í‚¤ìš°ê¸° ê³„ì‚°
    const scaleX = (b.width * b.scaleX) / a.width;
    const scaleY = (b.height * b.scaleY) / a.height;
    const s = Math.max(scaleX, scaleY) * 1.15; 

    // ì†ì„± ë³€ê²½
    a.set({
        scaleX: s,
        scaleY: s,
        left: b.left + (b.width * b.scaleX) / 2,
        top: b.top + (b.height * b.scaleY) / 2,
        originX: 'center',
        originY: 'center',
        angle: 0
    }); 
    
    // â˜… [í•µì‹¬ ìˆ˜ì •] ì¢Œí‘œ ê°•ì œ ì—…ë°ì´íŠ¸ (ì´ê²Œ ì—†ìœ¼ë©´ ì˜¤ë¥˜ê°€ ë‚©ë‹ˆë‹¤!)
    a.setCoords(); 
    
    canvas.sendToBack(a); 
    canvas.sendToBack(b); // ëŒ€ì§€ëŠ” í•­ìƒ ë§¨ ë’¤ë¡œ
    canvas.requestRenderAll(); 
};
    window.alignObject = function(d) { if(!canvas)return; const a=canvas.getActiveObject(); if(!a)return; const b=canvas.getObjects().find(o=>o.isBoard); const r=b?b.getBoundingRect():{left:0,top:0,width:canvas.width,height:canvas.height}; const w=a.getScaledWidth(); const h=a.getScaledHeight(); if(d=='left') a.left=r.left+w/2; if(d=='centerH') a.left=r.left+r.width/2; if(d=='right') a.left=r.left+r.width-w/2; if(d=='top') a.top=r.top+h/2; if(d=='centerV') a.top=r.top+r.height/2; if(d=='bottom') a.top=r.top+r.height-h/2; if(d=='center') { a.left=r.left+r.width/2; a.top=r.top+r.height/2; } a.setCoords(); canvas.requestRenderAll(); };

    if (window.pdfjsLib) window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // =========================================================
    // [ì‹ ê·œ] ì¼ë°˜ ìƒí’ˆ ëª¨ë‹¬ ë¡œì§ (ì˜¤ë¥˜ í•´ê²°ìš©)
    // =========================================================
    window.currentGenProduct = null;

    // 1. ëª¨ë‹¬ ì—´ê¸°
    window.openGeneralProductModal = function(code) {
        // ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì´ë¯¸ ì „ì—­ë³€ìˆ˜ì— ë¡œë“œë¨)
        const product = window.PRODUCT_DB[code];
        if (!product) return alert("ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        window.currentGenProduct = product;

        // ì´ë¯¸ì§€: img(ì¶•ì•½) ë˜ëŠ” img_url(ì›ë³¸) ëª¨ë‘ ëŒ€ì‘
        const imgUrl = product.img || product.img_url || 'https://placehold.co/400?text=No+Image';
        document.getElementById('genProdImg').src = imgUrl;

        // ìƒí’ˆëª…: ë‹¤êµ­ì–´ ëŒ€ì‘
        const localized = typeof getLocalizedData === 'function' ? getLocalizedData(product) : { name: product.name, price: product.price };
        document.getElementById('genProdTitle').innerText = localized.name || product.name;

        // ì„¤ëª…: HTML ë Œë”ë§ (Quill ì—ë””í„°ì—ì„œ ì‘ì„±ëœ ìƒì„¸ì„¤ëª…)
        const country = window.SITE_CONFIG?.COUNTRY || 'KR';
        let desc = '';
        if (country === 'JP') desc = product.description_jp || product.description || '';
        else if (country === 'US') desc = product.description_us || product.description || '';
        else desc = product.description || '';
        document.getElementById('genProdDesc').innerHTML = desc;

        document.getElementById('genProdPrice').innerText = fmtMoney(localized.price || product.price);
        
        // ìˆ˜ëŸ‰ ë° í•©ê³„ ì´ˆê¸°í™”
        document.getElementById('genProdQty').value = 1;
        window.updateGeneralTotal();

        // ëª¨ë‹¬ í‘œì‹œ
        document.getElementById('categoryDetailModal').style.display = 'none'; // ê¸°ì¡´ ì°½ ë‹«ê¸°
        document.getElementById('generalProductModal').style.display = 'flex';
    };

    // 2. í•©ê³„ ê¸ˆì•¡ ì‹¤ì‹œê°„ ê³„ì‚°
    window.updateGeneralTotal = function() {
        const qty = parseInt(document.getElementById('genProdQty').value) || 1;
        const price = window.currentGenProduct ? (window.currentGenProduct.price || 0) : 0;
        const total = price * qty;
        document.getElementById('genProdTotal').innerText = fmtMoney(total);
    };

    // 3. ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ì‹¤í–‰
    window.addGeneralToCart = function() {
        if (!window.currentGenProduct) return;
        const qty = parseInt(document.getElementById('genProdQty').value) || 1;

        // ì¤‘ë³µ ë°©ì§€ (ì´ë¯¸ ì§„í–‰ì¤‘ì´ë©´ ì°¨ë‹¨)
        if (window.isDirectCartAddInProgress) return;
        
        // ë¡œë”© í‘œì‹œ
        window.isDirectCartAddInProgress = true;
        
        // order.jsì˜ í•¨ìˆ˜ í˜¸ì¶œ (ìˆ˜ëŸ‰ í¬í•¨)
        addProductToCartDirectly(window.currentGenProduct, qty);

        // ëª¨ë‹¬ ë‹«ê¸° ë° ì™„ë£Œ ëª¨ë‹¬ ì—´ê¸° (order.jsì—ì„œ ì²˜ë¦¬ë˜ì§€ë§Œ ì•ˆì „ì¥ì¹˜)
        document.getElementById('generalProductModal').style.display = 'none';
        setTimeout(() => { window.isDirectCartAddInProgress = false; }, 1000);
    };
</script>
</script>
<script>
    document.addEventListener('click', function(e) {
        const card = e.target.closest('.size-card');
        if (card) {
            const onclickCode = card.getAttribute('onclick');
            if (onclickCode) {
                try { eval(onclickCode); } catch(err) { console.error("íŒí˜• í´ë¦­ ì˜¤ë¥˜:", err); }
            }
        }
    });
    
    window.closeSuccessModal = function() {
        const modal = document.getElementById('successModal');
        if (modal) {
            modal.style.display = 'none';
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const confirmBtn = document.querySelector('#successModal .btn-round.primary');
        if(confirmBtn) {
            confirmBtn.onclick = window.closeSuccessModal;
        }
    });
    
    // ì…ë ¥ì°½ ì˜¤ë¥˜ í•´ê²°
    window.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            if (e.code === 'Space' || e.key === ' ') {
                e.stopPropagation(); 
            }
        }
    }, true);
</script>
<script src="https://js.tosspayments.com/v1"></script>
<script src="https://js.stripe.com/v3/"></script>
<button id="btnPayTest" style="display:none; position:fixed; bottom:20px; right:20px; z-index:999999;">ê²°ì œí…ŒìŠ¤íŠ¸</button>


<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-11349651713"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-11349651713');
</script>
<!-- Event snippet for Google Shopping App Add To Cart conversion page -->
<script>
  gtag('event', 'conversion', {
      'send_to': 'AW-11349651713/P7AtCKeNgfYaEIHi96Mq',
      'value': 1.0,
      'currency': 'KRW'
  });

  // [ì„ íƒëœ ë””ìì¸ ë°°ê²½ ë§Œë“¤ê¸° - 10% í™•ëŒ€ + ì˜¤ë¥˜ ìˆ˜ì • ë²„ì „]

</script>

<div id="reviewWriteModal" class="modal-bg" style="z-index: 17000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 400px; text-align: center;">
        <h3 style="margin-top: 0;">ğŸ ìƒí’ˆì€ ë§ˆìŒì— ë“œì…¨ë‚˜ìš”?</h3>
        <p style="color: #666; font-size: 14px; margin-bottom: 20px;">êµ¬ë§¤ë¥¼ í™•ì •í•˜ê³  ì†Œì¤‘í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.<br>(ê°€ë§¹ì ì—ê²Œ í° í˜ì´ ë©ë‹ˆë‹¤!)</p>

        <div style="margin-bottom: 20px;">
            <div id="starContainer" style="font-size: 32px; color: #ddd; cursor: pointer;">
                <i class="fa-solid fa-star" onclick="setReviewRating(1)" id="star1"></i>
                <i class="fa-solid fa-star" onclick="setReviewRating(2)" id="star2"></i>
                <i class="fa-solid fa-star" onclick="setReviewRating(3)" id="star3"></i>
                <i class="fa-solid fa-star" onclick="setReviewRating(4)" id="star4"></i>
                <i class="fa-solid fa-star" onclick="setReviewRating(5)" id="star5"></i>
            </div>
            <div id="ratingText" style="font-weight: bold; color: #6366f1; margin-top: 5px;">5ì </div>
        </div>

        <textarea id="reviewCommentInput" class="ai-input-pretty" placeholder="í›„ê¸°ë¥¼ ê°„ë‹¨íˆ ë‚¨ê²¨ì£¼ì„¸ìš” (ì„ íƒì‚¬í•­)" style="height: 80px;"></textarea>
        
        <input type="hidden" id="targetReviewOrderId">
        <input type="hidden" id="targetReviewScore" value="5">

        <button onclick="submitOrderReview()" class="btn-round primary" style="width: 100%; margin-top: 10px;">
            í™•ì¸ ë° ì •ì‚°ì§€ê¸‰ ìŠ¹ì¸
        </button>
        <button onclick="document.getElementById('reviewWriteModal').style.display='none'" class="btn-round" style="margin-top: 5px; border: none; color: #888;">
            ë‚˜ì¤‘ì— í•˜ê¸°
        </button>
    </div>
</div>
<div id="withdrawModal" class="modal-bg" style="z-index: 25000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 500px; text-align: left;">
        <h3 style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 15px;">ğŸ’¸ ì •ì‚° ì¶œê¸ˆ ì‹ ì²­</h3>
        
        <div style="background: #f0f9ff; border: 1px solid #bae6fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #0369a1; line-height: 1.6;">
            <strong>[ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ ì •ë³´]</strong><br>
            ì•„ë˜ ì •ë³´ë¡œ ì„¸ê¸ˆê³„ì‚°ì„œë¥¼ ë°œí–‰í•˜ì—¬ ì²¨ë¶€í•´ì£¼ì„¸ìš”.<br><br>
            ìƒí˜¸ : <strong>(ì£¼)ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ…</strong> (ëŒ€í‘œ: ì¡°ì¬í˜¸)<br>
            ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ : <strong>470-81-02808</strong><br>
            ì£¼ì†Œ : ê²½ê¸°ë„ í™”ì„±ì‹œ ìš°ì •ì í•œë§ê¸¸ 72-2<br>
            ì´ë©”ì¼ : <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2f44405d4a4e161f1f4e5c6f48424e4643014c4042">[email&#160;protected]</a>
        </div>

        <div style="margin-bottom: 15px;">
            <label style="font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px;">ì¶œê¸ˆ ìš”ì²­ ê¸ˆì•¡ (ìˆ˜ìˆ˜ë£Œ ê³µì œ í›„)</label>
            <input id="wdAmount" class="ai-input-pretty" readonly style="background: #f8fafc; font-weight: 800; color: #6366f1; font-size: 18px;">
            <div style="font-size: 11px; color: #64748b; margin-top: 5px; line-height: 1.4;">
                * ê³µì œ ë‚´ì—­ (ì´ 20%): ë¶€ê°€ì„¸(10%) + ì¹´ë“œìˆ˜ìˆ˜ë£Œ(3.5%) + ê°€ë§¹ìˆ˜ìˆ˜ë£Œ(6.5%)<br>
                * ì‹¤ì œ ì…ê¸ˆì€ ì‹ ì²­ì¼ë¡œë¶€í„° <strong>ì˜ì—…ì¼ ê¸°ì¤€ 5ì¼ ì´ë‚´</strong> ì²˜ë¦¬ë©ë‹ˆë‹¤.
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <div style="flex: 1;">
                <label style="font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px;">ì˜ˆê¸ˆì£¼ (ì‹¤ëª…)</label>
                <input id="wdRealName" class="ai-input-pretty" placeholder="í™ê¸¸ë™" style="margin-bottom: 0;">
            </div>
            <div style="flex: 1;">
                <label style="font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px;">ì—°ë½ì²˜</label>
                <input id="wdPhone" class="ai-input-pretty" placeholder="010-0000-0000" style="margin-bottom: 0;">
            </div>
        </div>

        <div style="margin-bottom: 15px;">
            <label style="font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px;">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ (ì›ì²œì§•ìˆ˜ìš©)</label>
            <input id="wdRRN" class="ai-input-pretty" type="password" placeholder="000000-0000000" maxlength="14">
        </div>
        <div style="margin-bottom: 15px;">
            <label style="font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px;">ì…ê¸ˆë°›ì„ ê³„ì¢Œ ì •ë³´</label>
            <input id="wdBankInfo" class="ai-input-pretty" placeholder="ì€í–‰ëª… / ê³„ì¢Œë²ˆí˜¸ (ë³¸ì¸ ëª…ì˜)">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px;">ì„¸ê¸ˆê³„ì‚°ì„œ ì²¨ë¶€ (í•„ìˆ˜)</label>
            <div style="display: flex; gap: 10px;">
                <input type="file" id="wdTaxFile" class="ai-input-pretty" accept=".pdf,.jpg,.png" style="padding: 8px;">
            </div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button onclick="submitWithdrawal()" class="btn-round primary" style="flex: 1;">ì‹ ì²­í•˜ê¸°</button>
            <button onclick="document.getElementById('withdrawModal').style.display='none'" class="btn-round" style="flex: 1;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<audio id="orderAlertSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

<div id="contributorUploadModal" class="modal-bg" style="display: none; z-index: 20000; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 500px; max-width: 95%;">
        <h3 id="cUploadTitle" style="margin-top:0;" data-i18n="contrib_upload_title">ğŸ“¤ ì—…ë¡œë“œ</h3>

        <div style="margin-bottom: 15px;">
            <label class="form-label" style="font-weight:bold; display:block; margin-bottom:5px;" data-i18n="contrib_label_tags">ê²€ìƒ‰ í‚¤ì›Œë“œ (íƒœê·¸)</label>
            <input type="text" id="cUploadTags" class="ai-input-pretty" data-i18n-placeholder="contrib_ph_tags" placeholder="íŒŒì¼ì„ ì„ íƒí•˜ë©´ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.">
        </div>

        <div id="cUploadSvgArea" style="display:none; gap:10px; margin-bottom:15px;">
            <div style="flex:1;">
                <label class="form-label" style="font-size:12px; font-weight:bold;" data-i18n="contrib_label_thumb">1. ì¸ë„¤ì¼ (JPG/PNG)</label>
                <input type="file" id="cFileThumb" class="ai-input-pretty" accept="image/png, image/jpeg" style="padding:5px;" onchange="window.autoFillTags(this)">
            </div>
            <div style="flex:1;">
                <label class="form-label" style="font-size:12px; font-weight:bold;" data-i18n="contrib_label_svg">2. SVG ì›ë³¸</label>
                <input type="file" id="cFileSvg" class="ai-input-pretty" accept=".svg" style="padding:5px;">
            </div>
        </div>

        <div id="cUploadSimpleArea" style="margin-bottom:15px;">
            <label class="form-label" style="font-weight:bold; display:block; margin-bottom:5px;" data-i18n="contrib_label_file">íŒŒì¼ ì„ íƒ</label>
            <input type="file" id="cFileSimple" class="ai-input-pretty" accept="image/png, image/jpeg" multiple style="padding:5px;" onchange="window.autoFillTags(this)">
            <p style="font-size:11px; color:#666; margin-top:5px;" data-i18n="contrib_file_tip">* ë°°ê²½ì´ íˆ¬ëª…í•œ PNG íŒŒì¼ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="window.submitContributorUpload()" class="btn-round primary" style="flex:1;" data-i18n="contrib_btn_submit">ì—…ë¡œë“œ ë° ì ë¦½ë°›ê¸°</button>
            <button onclick="document.getElementById('contributorUploadModal').style.display='none'" class="btn-round" style="flex:1; background:#f1f5f9; color:#333;" data-i18n="contrib_btn_cancel">ì·¨ì†Œ</button>
        </div>
    </div>
</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="./text-wizard.js"></script>
<div id="vipOrderModal" class="modal-bg" style="z-index: 30000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 550px; max-width: 95%;">
        <div style="background: #1e1b4b; margin: -25px -25px 20px -25px; padding: 25px; color: white; border-radius: 12px 12px 0 0; text-align: center;">
            <h3 style="margin: 0; font-size: 22px; color: #fff;"><i class="fa-solid fa-crown" style="color: #fbbf24;"></i> VIP ìš°ì„  ì ‘ìˆ˜</h3>
            <p style="margin: 10px 0 0 0; opacity: 0.8; font-size: 13px;">ì „ë‹´ ë§¤ë‹ˆì €ë¥¼ ì„ íƒí•˜ê³  íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì„¸ìš”.</p>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <div style="flex:1;">
                <label class="form-label" style="font-weight:bold; font-size:13px;">ë‹´ë‹¹ì ì„±í•¨</label>
                <input id="vipName" class="ai-input-pretty" placeholder="ì˜ˆ: ê¹€ì² ìˆ˜ íŒ€ì¥" style="margin:0;">
            </div>
            <div style="flex:1;">
                <label class="form-label" style="font-weight:bold; font-size:13px;">ì—°ë½ì²˜</label>
                <input id="vipPhone" class="ai-input-pretty" placeholder="010-0000-0000" style="margin:0;">
            </div>
        </div>

        <div style="margin-bottom: 15px;">
            <label class="form-label" style="font-weight:bold; font-size:13px; margin-bottom:5px; display:block;" data-i18n="label_select_manager">ë‹´ë‹¹ ë§¤ë‹ˆì € ì„ íƒ (Optional)</label>
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:5px;">
                <label class="manager-select">
                    <input type="radio" name="vipManager" value="ì€ë¯¸ ë§¤ë‹ˆì €" checked>
                    <div class="mgr-box">ì€ë¯¸ ë§¤ë‹ˆì €</div>
                </label>
                <label class="manager-select">
                    <input type="radio" name="vipManager" value="ì§€ìˆ™ ë§¤ë‹ˆì €">
                    <div class="mgr-box">ì§€ìˆ™ ë§¤ë‹ˆì €</div>
                </label>
                <label class="manager-select">
                    <input type="radio" name="vipManager" value="ì„±í¬ ë§¤ë‹ˆì €">
                    <div class="mgr-box">ì„±í¬ ë§¤ë‹ˆì €</div>
                </label>
                <label class="manager-select">
                    <input type="radio" name="vipManager" value="ë³¸ì‚¬ë‹´ë‹¹ì">
                    <div class="mgr-box" style="background:#f1f5f9; color:#64748b;">ë³¸ì‚¬ë‹´ë‹¹ì</div>
                </label>
            </div>
            <style>
                .manager-select input { display:none; }
                .manager-select .mgr-box { border:1px solid #e2e8f0; padding:10px; text-align:center; border-radius:8px; cursor:pointer; font-weight:bold; color:#475569; transition:0.2s; font-size:13px; }
                .manager-select input:checked + .mgr-box { background:#e0e7ff; border-color:#6366f1; color:#4338ca; box-shadow:0 0 0 2px #6366f1 inset; }
            </style>
        </div>

        <div style="margin-bottom: 15px;">
            <label class="form-label" style="font-weight:bold; font-size:13px;">ìš”ì²­ì‚¬í•­ (ë©”ëª¨)</label>
            <textarea id="vipMemo" class="ai-input-pretty" placeholder="ê²¬ì  ìš”ì²­ ë‚´ìš©ì´ë‚˜ ì‘ì—… ì§€ì‹œì‚¬í•­ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”." style="height:80px; margin:0;"></textarea>
        </div>

        <div style="margin-bottom: 20px;">
            <label class="form-label" style="font-weight:bold; font-size:13px; display:block; margin-bottom:5px;">íŒŒì¼ ì—…ë¡œë“œ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>
            <div onclick="document.getElementById('vipFileInput').click()" style="border: 2px dashed #cbd5e1; background: #f8fafc; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s;">
                <i class="fa-solid fa-cloud-arrow-up" style="font-size: 24px; color: #94a3b8; margin-bottom: 5px;"></i>
                <div style="color: #64748b; font-size: 13px;">ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ (ì—¬ëŸ¬ê°œ ê°€ëŠ¥)</div>
                <div id="vipFileList" style="margin-top:10px; font-size:12px; color:#4338ca; text-align:left; padding-left:10px;"></div>
            </div>
            <input type="file" id="vipFileInput" multiple style="display: none;" onchange="updateVipFileList(this)">
        </div>

        <button onclick="window.submitVipOrder()" class="btn-round primary" style="width: 100%; height: 50px; font-size: 16px; background: #4338ca;">
            ğŸš€ ì ‘ìˆ˜í•˜ê¸°
        </button>
        <button onclick="document.getElementById('vipOrderModal').style.display='none'" class="btn-round" style="width: 100%; margin-top: 10px; border: none; color: #64748b;">
            ë‹«ê¸°
        </button>
    </div>
</div>

<div id="partnerApplyModal" class="modal-bg" style="z-index: 20000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 500px; max-width: 95%;">
        <h3 style="margin-top:0;">ğŸ¤ íŒŒíŠ¸ë„ˆ(ê°€ë§¹ì ) ì‹ ì²­</h3>
        <p style="color:#666; font-size:13px; margin-bottom:20px;">ì§€ì—­ ê´‘ê³ /ì œì¡° íŒŒíŠ¸ë„ˆê°€ ë˜ì–´ ìˆ˜ìµì„ ì°½ì¶œí•˜ì„¸ìš”.</p>
        
        <div style="margin-bottom:15px;">
            <label class="form-label" style="font-weight:bold;">ì—…ì²´ëª… (ìƒí˜¸)</label>
            <input id="applyCompName" class="ai-input-pretty" placeholder="ì˜ˆ: ì¹´ë©œë ˆì˜¨ë””ìì¸">
        </div>
        
        <div style="margin-bottom:15px;">
            <label class="form-label" style="font-weight:bold;">ì—°ë½ì²˜</label>
            <input id="applyPhone" class="ai-input-pretty" placeholder="010-1234-5678">
        </div>
        
        <div style="margin-bottom:15px;">
            <label class="form-label" style="font-weight:bold;">í™œë™ ì§€ì—­ (ë‹¤ì¤‘ ì…ë ¥ ê°€ëŠ¥)</label>
            <input id="applyRegion" class="ai-input-pretty" placeholder="ì˜ˆ: ì„œìš¸ ê°•ë‚¨êµ¬, ì„œì´ˆêµ¬, ê²½ê¸° í™”ì„±ì‹œ (ì‰¼í‘œë¡œ êµ¬ë¶„)">
            <p style="font-size:11px; color:#ef4444; margin-top:5px;">* ì—¬ëŸ¬ ì§€ì—­ í™œë™ ì‹œ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ëª¨ë‘ ì ì–´ì£¼ì„¸ìš”.</p>
        </div>
        <div style="margin-bottom:20px;">
            <label class="form-label" style="font-weight:bold;">ì£¼ ìƒì‚° í’ˆëª© (ì œì¡°ì‚¬ì¸ ê²½ìš°)</label>
            <input id="applyMainItems" class="ai-input-pretty" placeholder="ì˜ˆ: í˜„ìˆ˜ë§‰, ì•„í¬ë¦´, ê°„íŒ (ê´‘ê³ ì‚¬ëŠ” 'ê¸°íš/ë””ìì¸' ì…ë ¥)">
        </div>

        <button onclick="window.submitRealPartnerApp()" class="btn-round primary" style="width:100%;">ì‹ ì²­í•˜ê¸°</button>
        <button onclick="window.cancelPartnerApp()" class="btn-round" style="width:100%; margin-top:5px; background:#fff1f2; color:#be123c; border:1px solid #fda4af;">ì‹ ì²­ ì² íšŒí•˜ê¸°</button>
        <button onclick="document.getElementById('partnerApplyModal').style.display='none'" class="btn-round" style="width:100%; margin-top:10px; background:#f1f5f9; color:#333; border:none;">ë‹«ê¸°</button>
    </div>
</div>

<script>
function updateVipFileList(input) {
    const list = document.getElementById('vipFileList');
    list.innerHTML = '';
    if(input.files.length > 0) {
        for(let i=0; i<input.files.length; i++) {
            list.innerHTML += `<div>ğŸ“„ ${input.files[i].name}</div>`;
        }
    }
}
</script>
<script type="module">
    import { sb, initConfig } from './config.js?v=119';

    // [ìœ ì… ê²½ë¡œ ìƒì„¸ ë¶„ì„ í•¨ìˆ˜]
    function getTrafficSource() {
        const params = new URLSearchParams(window.location.search);
        const referrer = document.referrer;
        const currentUrl = window.location.href;

        // 1. [ê´‘ê³  ì²´í¬] URLì— gclid(êµ¬ê¸€ê´‘ê³ ID)ë‚˜ utm íŒŒë¼ë¯¸í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
        if (params.has('gclid') || params.get('utm_medium') === 'cpc' || params.get('utm_source') === 'ad') {
            return 'Google Ads (ê´‘ê³ )';
        }
        
        // 2. [ì§ì ‘ ì ‘ì†/ì¦ê²¨ì°¾ê¸°] ë¦¬í¼ëŸ¬ê°€ ì—†ëŠ” ê²½ìš°
        if (!referrer || referrer.trim() === '') {
            return 'Direct (ì¦ê²¨ì°¾ê¸°/ì£¼ì†Œì…ë ¥)';
        }

        // 3. [ê²€ìƒ‰ ì—”ì§„ ë° ì†Œì…œ] ë„ë©”ì¸ ë¶„ì„
        try {
            const refUrl = new URL(referrer);
            const hostname = refUrl.hostname.toLowerCase();

            if (hostname.includes('google.')) return 'Google Search (ìì—°ê²€ìƒ‰)';
            if (hostname.includes('naver.')) return 'Naver Search (ìì—°ê²€ìƒ‰)';
            if (hostname.includes('daum.') || hostname.includes('kakao.')) return 'Daum/Kakao';
            if (hostname.includes('instagram.')) return 'Instagram';
            if (hostname.includes('facebook.') || hostname.includes('fb.com')) return 'Facebook';
            if (hostname.includes('youtube.')) return 'Youtube';
            if (hostname.includes('bing.')) return 'Bing Search';

            // ê·¸ ì™¸ ì‚¬ì´íŠ¸ (ë¸”ë¡œê·¸ ë“±)ëŠ” ë„ë©”ì¸ ê·¸ëŒ€ë¡œ í‘œì‹œ
            return hostname;
        } catch (e) {
            return 'Other Websites';
        }
    }

    async function trackVisit() {
        // DB ì„¤ì • ë¡œë“œ ëŒ€ê¸°
        if (!sb || !sb.from) {
            if (typeof initConfig === 'function') await initConfig();
        }
        if (!sb) { console.warn("[trackVisit] sbê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ â€” ë°©ë¬¸ ì¶”ì  ìƒëµ"); return; }

        try {
            // ìƒì„¸ ë¶„ì„ëœ ìœ ì… ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
            const visitSource = getTrafficSource();

            // â˜… [ì¶”ê°€] ìœ ì… ê²½ë¡œê°€ 'ë‚´ ì‚¬ì´íŠ¸'ì´ê±°ë‚˜ 'ë‚´ë¶€ ì´ë™'ì´ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ (DB ì ˆì•½ & ì •í™•ë„ í–¥ìƒ)
            if (visitSource.includes(window.location.hostname) || visitSource.includes('cafe2626.com')) {
                console.log("ë‚´ë¶€ ì´ë™ì„ìœ¼ë¡œ ì¹´ìš´íŠ¸ ìƒëµ");
                return;
            }

            // 1. ë°©ë¬¸ ê¸°ë¡ ì €ì¥
            const { data, error } = await sb
                .from('page_views')
                .insert([{
                    referrer: visitSource,
                    duration: 0,
                    site: (window.SITE_CONFIG && window.SITE_CONFIG.COUNTRY) || 'KR'
                }])
                .select()
                .single();

            if (error) throw error;

            // 2. ì²´ë¥˜ì‹œê°„ ì—…ë°ì´íŠ¸ (5ì´ˆ ê°„ê²©)
            const visitId = data.id;
            const startTime = Date.now();
            
            setInterval(() => {
                const durationSec = Math.floor((Date.now() - startTime) / 1000);
                sb.from('page_views')
                  .update({ duration: durationSec })
                  .eq('id', visitId)
                  .then(() => {});
            }, 5000);

        } catch (e) {
            console.warn("Tracking skipped:", e.message);
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    window.addEventListener('load', trackVisit);
    // [ì‹ ê·œ] 'ë°°ì†¡' ì¹´í…Œê³ ë¦¬ ìë™ ì—´ê¸° í•¨ìˆ˜
    window.openDeliveryCategory = async function() {
        if (!sb) { console.warn("[openDeliveryCategory] sbê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ"); return; }
        document.getElementById('cartAddedModal').style.display = 'none'; // ì™„ë£Œ ëª¨ë‹¬ ë‹«ê¸°

        // ë¡œë”© í‘œì‹œë¥¼ ìœ„í•´ ì¹´í…Œê³ ë¦¬ ëª¨ë‹¬ì„ ë¨¼ì € ì—½ë‹ˆë‹¤ (ë¹ˆ ìƒíƒœ)
        const modal = document.getElementById('categoryDetailModal');
        const grid = document.getElementById('catProductGrid');
        modal.style.display = 'flex';
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px;"><i class="fa-solid fa-spinner fa-spin"></i> ë°°ì†¡ ì˜µì…˜ì„ ì°¾ëŠ” ì¤‘...</div>';

        try {
            // DBì—ì„œ ì´ë¦„ì´ 'ë°°ì†¡'ì¸ ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            const { data, error } = await sb.from('admin_categories')
                .select('*')
                .eq('name', 'ë°°ì†¡') // â˜… DBì— ì €ì¥ëœ ì •í™•í•œ ì´ë¦„ì´ì–´ì•¼ í•©ë‹ˆë‹¤
                .single();

            if (error || !data) {
                alert("ë°°ì†¡ ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.");
                modal.style.display = 'none';
                return;
            }

            // ì°¾ì€ ì¹´í…Œê³ ë¦¬ ì½”ë“œë¡œ ìƒí’ˆ ëª©ë¡ì„ ë„ì›ë‹ˆë‹¤.
            window.showCategoryProducts(data.code, data.name, data.description);

        } catch (e) {
            console.error(e);
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            modal.style.display = 'none';
        }
    };

    // [ì‹ ê·œ] ì¥ë°”êµ¬ë‹ˆ í™”ë©´ë§Œ ì—´ê¸° (ê²°ì œ ìœ ë„ X)
    window.goToCartPageOnly = function() {
        document.getElementById('cartAddedModal').style.display = 'none';
        document.getElementById('cartPage').style.display = 'block';
        if(window.renderCart) window.renderCart();
    };
    // [ìˆ˜ì • 1] í…œí”Œë¦¿ ë§Œë“¤ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ -> ì „ìš© ëª¨ë‹¬ ì—´ê¸°
    window.openTemplateCreator = function() {
        // 1. ë¡œê·¸ì¸ ì²´í¬
        if (!window.currentUser) {
            alert(window.t ? window.t('msg_login_required') : "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            document.getElementById('loginModal').style.display = 'flex';
            return;
        }

        // 2. ëª¨ë‹¬ ì—´ê¸° (ê°’ ì´ˆê¸°í™”)
        document.getElementById('tplCreateW').value = '1000';
        document.getElementById('tplCreateH').value = '1000';
        document.getElementById('templateCreatorModal').style.display = 'flex';
    };

    // [ìˆ˜ì • 2] "ë””ìì¸ ì‹œì‘í•˜ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ (ì´ˆê¸°í™” ë° ì—ë””í„° ì§„ì…)
    // [ìµœì¢… ìˆ˜ì •] "ë””ìì¸ ì‹œì‘í•˜ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ (ê°•ë ¥ ì´ˆê¸°í™” ì ìš©)
    window.confirmTemplateCreation = function() {
        const wVal = document.getElementById('tplCreateW').value;
        const hVal = document.getElementById('tplCreateH').value;
        const w = parseInt(wVal);
        const h = parseInt(hVal);

        if (!w || !h || w <= 0 || h <= 0) {
            alert(window.t('msg_invalid_size'));
            return;
        }

        // â˜… [í•µì‹¬] ìœ ë ¹ ì´ë¯¸ì§€ ì™„ë²½ ì°¨ë‹¨: ëª¨ë“  ê´€ë ¨ ë³€ìˆ˜ ì´ˆê¸°í™”
        window.pendingTemplate = null; 
        window.pendingAiImage = null;
        window.selectedTpl = null; // â˜… ì´ ë¶€ë¶„ì´ ì¤‘ìš”í•©ë‹ˆë‹¤ (ê°¤ëŸ¬ë¦¬ ì„ íƒ í•´ì œ)
        
        // íŒŒì¼ ì…ë ¥ì°½ë“¤ë„ ì‹¹ ë¹„ìš°ê¸°
        const inputs = ['contributorFileInput', 'imgUpload', 'logoFileInput', 'vipFileInput'];
        inputs.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.value = '';
        });

        // ëª¨ë‹¬ ë‹«ê¸°
        document.getElementById('templateCreatorModal').style.display = 'none';

        // ì—ë””í„° ì—´ê¸° (ë¹ˆ í™”ë©´)
        if (window.startEditorDirect) {
            // custom í‚¤ë¡œ ë¹ˆ ìº”ë²„ìŠ¤ ì‹œì‘
            window.startEditorDirect('custom', w, h);
            
            // [ì•ˆì „ì¥ì¹˜] ì—ë””í„° ë¡œë“œ ì§í›„ ìº”ë²„ìŠ¤ë¥¼ í•œ ë²ˆ ë” ë¹„ì›Œì¤Œ (0.5ì´ˆ ë’¤ ì‹¤í–‰)
            setTimeout(() => {
                if(window.canvas) {
                    // ë°°ê²½(Board)ì„ ì œì™¸í•œ ëª¨ë“  ê°ì²´ ì‚­ì œ
                    const objects = window.canvas.getObjects().filter(o => !o.isBoard);
                    objects.forEach(o => window.canvas.remove(o));
                    window.canvas.requestRenderAll();
                }
            }, 500);
        } else {
            alert(window.t('msg_editor_load_error'));
        }
    };


// =================================================================
// [ìµœì¢…] í…œí”Œë¦¿ ëª¨ë‹¬: ì¹´í…Œê³ ë¦¬ + ìƒí’ˆ í†µí•© ê²€ìƒ‰ ê¸°ëŠ¥
// =================================================================

// ì „ì—­ ë³€ìˆ˜ì— ëª¨ë‹¬ìš© ë°ì´í„°ë¥¼ ì €ì¥í•´ë‘¡ë‹ˆë‹¤.
window.modalGlobalData = {
    categories: [],
    products: [],
    thumbMap: {}
};

// 1. ëª¨ë‹¬ ì—´ê¸° ë° ë°ì´í„° ì¤€ë¹„
window.showCategorySelectionModal = async function() {
    const modal = document.getElementById('categoryDetailModal');
    const grid = document.getElementById('catProductGrid');
    const titleEl = document.getElementById('catModalTitle');
    const descEl = modal.querySelector('p');
    const searchInput = document.getElementById('modalProdSearch');

    // UI ì´ˆê¸°í™”
    if(titleEl) titleEl.innerHTML = `<span style="color:#6366f1;">${window.t('tpl_search_product')}</span>`;
    if(descEl) descEl.style.display = 'none'; // ì„¤ëª… ìˆ¨ê¹€
    
    // ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
    if(searchInput) {
        searchInput.value = ''; 
        setTimeout(() => searchInput.focus(), 100); 
    }

    modal.style.display = 'flex';
    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px;"><i class="fa-solid fa-spinner fa-spin" style="font-size:30px; color:#6366f1;"></i><br><br>ë°ì´í„° ë¡œë”© ì¤‘...</div>';
    
    try {
        if (typeof sb === 'undefined') throw new Error("DB ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤.");

        // (1) ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸°
        const { data: categories } = await sb.from('admin_categories')
            .select('*').order('sort_order', { ascending: true });

        // (2) ìƒí’ˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì½”ë“œ, ê°€ê²©, ì´ë¯¸ì§€ í¬í•¨)
        const { data: products } = await sb.from('admin_products')
            .select('category, img_url, name, code, price, width_mm, height_mm')
            .not('img_url', 'is', null)
            .neq('img_url', '');

        // (3) ë°ì´í„° ì „ì—­ ì €ì¥
        window.modalGlobalData.categories = categories || [];
        window.modalGlobalData.products = products || [];
        window.modalGlobalData.thumbMap = {};

        // ì¸ë„¤ì¼ ë§¤í•‘ (ì¹´í…Œê³ ë¦¬ ëŒ€í‘œ ì´ë¯¸ì§€ìš©)
        if (products) {
            products.forEach(p => {
                if (p.category && !window.modalGlobalData.thumbMap[p.category]) {
                    window.modalGlobalData.thumbMap[p.category] = p.img_url;
                }
            });
        }

        // (4) ì´ˆê¸° í™”ë©´ ê·¸ë¦¬ê¸° (ê²€ìƒ‰ì–´ ì—†ìŒ -> ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ)
        window.filterModalItems('');

    } catch (e) {
        console.error("ë¡œë”© ì‹¤íŒ¨:", e);
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
    }
};

// 2. ê²€ìƒ‰ ë° í™”ë©´ ê·¸ë¦¬ê¸° (í†µí•© ê²€ìƒ‰ ë¡œì§)
window.filterModalItems = function(keyword) {
    const term = keyword.toLowerCase().trim();
    const grid = document.getElementById('catProductGrid');
    if (!grid) return;

    // A. ê²€ìƒ‰ì–´ê°€ ì—†ì„ ë•Œ -> ì•ˆë‚´ ë¬¸êµ¬ë§Œ í‘œì‹œ (ê¹”ë”í•˜ê²Œ)
    if (term === '') {
        grid.innerHTML = `
            <div style="grid-column:1/-1; text-align:center; padding: 60px 0; color:#94a3b8;">
                <i class="fa-solid fa-magnifying-glass" style="font-size:40px; margin-bottom:15px; opacity:0.5;"></i><br>
                <span style="font-size:18px; font-weight:bold; color:#475569;">ì°¾ìœ¼ì‹œëŠ” ìƒí’ˆì„ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.</span><br>
                <span style="font-size:14px; margin-top:5px; display:inline-block;">(ì˜ˆ: ë°°ë„ˆ, í˜„ìˆ˜ë§‰, í…€ë¸”ëŸ¬ ë“±)</span>
            </div>
        `;
        return;
    }

    // B. ê²€ìƒ‰ì–´ê°€ ìˆì„ ë•Œ -> í•„í„°ë§ ì‹œì‘
    const { categories, products, thumbMap } = window.modalGlobalData;

    // 1) ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰
    const matchedCats = categories.filter(cat => (cat.name || '').toLowerCase().includes(term));
    
    // 2) ìƒí’ˆ ê²€ìƒ‰ (ì´ë¦„ ì¼ì¹˜)
    const matchedProds = products.filter(prod => (prod.name || '').toLowerCase().includes(term));

    // ê²°ê³¼ê°€ ì—†ì„ ë•Œ
    if (matchedCats.length === 0 && matchedProds.length === 0) {
        grid.innerHTML = `
            <div style="grid-column:1/-1; text-align:center; padding: 50px 0; color:#94a3b8;">
                <i class="fa-solid fa-circle-exclamation" style="font-size:30px; margin-bottom:10px;"></i><br>
                <span>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
            </div>
        `;
        return;
    }

    // C. ê²°ê³¼ ê·¸ë¦¬ê¸° (ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê³  ìƒˆë¡œ ê·¸ë¦¼)
    grid.innerHTML = '';

    // [í—¬í¼] ì•„ì´í…œ HTML ìƒì„± í•¨ìˆ˜
    const createItem = (item, type) => {
        const div = document.createElement('div');
        div.className = 'quick-item';
        
        // ì´ë¯¸ì§€ ì£¼ì†Œ ê²°ì •
        let rawUrl = '';
        let badgeHtml = '';
        let subText = '';

        if (type === 'category') {
            rawUrl = item.img_url || item.image || thumbMap[item.code] || '';
            // ì¹´í…Œê³ ë¦¬ëŠ” ë±ƒì§€ ì—†ìŒ
        } else {
            // ìƒí’ˆì¸ ê²½ìš°
            rawUrl = item.img_url || '';
            badgeHtml = `<span style="position:absolute; top:6px; left:6px; background:#6366f1; color:white; font-size:10px; font-weight:bold; padding:2px 6px; border-radius:4px; z-index:2;">ìƒí’ˆ</span>`;
            subText = `<div style="font-size:11px; color:#888; margin-top:2px;">${fmtMoney(item.price||0)}</div>`;
        }

        const iconUrl = window.getTinyThumb ? window.getTinyThumb(rawUrl, 150) : rawUrl;
        const imgTag = iconUrl 
            ? `<img src="${iconUrl}" loading="lazy" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentNode.innerHTML='<i class=\\'fa-solid fa-cube\\'></i>'">`
            : `<i class="fa-solid fa-folder-open" style="font-size:24px; color:#cbd5e1;"></i>`;

        // [ìˆ˜ì •] ìƒí’ˆëª…, ê°€ê²©, ì‚¬ì´ì¦ˆê°€ ëª¨ë‘ ë³´ì´ë„ë¡ HTML êµ¬ì¡° ë³€ê²½
        div.innerHTML = `
            ${imgHtml}
            
            <div class="quick-text" style="display:block !important; margin-top:8px; font-weight:bold; color:#1e293b; font-size:14px; line-height:1.3; width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                ${name}
            </div>

            <div style="font-size:15px; font-weight:800; color:#6366f1; margin-top:6px;">
                ${formattedPrice}
            </div>

            <div style="font-size:12px; color:#94a3b8; margin-top:2px;">
                ${p.width_mm || '-'} x ${p.height_mm || '-'} mm
            </div>
        `;

        // í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
        div.onclick = () => {
           if (type === 'category') {
                const urlParams = new URLSearchParams(window.location.search);
                const currentLang = urlParams.get('lang') || 'kr';
                // ì¼ë³¸ì–´ ëª¨ë“œê³  DBì— ì¼ë³¸ì–´ ì´ë¦„(name_ja)ì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì „ë‹¬
                const displayName = (currentLang === 'ja' && item.name_ja) ? item.name_ja : item.name;
                window.showCategoryProducts(item.code, displayName, item.description);
            } else {
                // ìƒí’ˆ í´ë¦­ ì‹œ ë¶„ê¸° ì²˜ë¦¬
                document.getElementById('categoryDetailModal').style.display = 'none'; // ëª¨ë‹¬ ë‹«ê¸°
                
                // ëª¨ë“  ìƒí’ˆ ë™ì¼ ì¸í„°í˜ì´ìŠ¤ (ìƒì„¸í˜ì´ì§€ + êµ¬ë§¤)
                window.loadProductDetailAndOpen(item.code);
            }
        };
        return div;
    };

    // ì¹´í…Œê³ ë¦¬ ë¨¼ì € ì¶”ê°€
    matchedCats.forEach(cat => grid.appendChild(createItem(cat, 'category')));
    // ìƒí’ˆ ê·¸ ë’¤ì— ì¶”ê°€
    matchedProds.forEach(prod => grid.appendChild(createItem(prod, 'product')));
};

</script>

<div id="cartAddedModal" class="modal-bg" style="z-index: 16000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 400px; text-align: center; padding: 40px 30px;">
        <h3 style="margin: 0 0 10px 0; font-size: 22px;" data-i18n="msg_added_to_cart">ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤!</h3>
        <p style="color: #666; margin-bottom: 30px;" data-i18n="msg_added_to_cart_desc">ì„ íƒí•˜ì‹  ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        
        <div style="display: flex; flex-direction: column; gap: 8px;">
            <button onclick="window.goToCartFromSuccess()" class="btn-round primary" data-i18n="btn_go_to_payment">ğŸ’³ ë°”ë¡œ ê²°ì œí•˜ëŸ¬ ê°€ê¸°</button>
            <button onclick="window.continueShopping()" class="btn-round" data-i18n="btn_continue_shopping">ğŸ›ï¸ ë‹¤ë¥¸ìƒí’ˆ ë” ì‡¼í•‘í•˜ê¸°</button>
        </div>
    </div>
</div>


</script>
<div id="templateCreatorModal" class="modal-bg" style="z-index: 21000; display: none; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 500px; max-width: 95%; text-align: left; border-radius: 16px; overflow: hidden; padding: 0;">
        
        <div style="background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%); padding: 20px 25px; color: white;">
            <h3 style="margin: 0; font-size: 20px; display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-palette"></i> <span data-i18n="tpl_create_title">í…œí”Œë¦¿ ë§Œë“¤ê¸° ì‹œì‘</span>
            </h3>
            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 13px;" data-i18n="tpl_create_desc">ë‚˜ë§Œì˜ ë©‹ì§„ ë””ìì¸ì„ ë“±ë¡í•˜ê³  ìˆ˜ìµì„ ì°½ì¶œí•˜ì„¸ìš”!</p>
        </div>

        <div style="padding: 25px;">
            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <ul style="margin: 0; padding-left: 20px; color: #475569; font-size: 13px; line-height: 1.8;">
                    <li data-i18n="tpl_create_tip_1">ğŸ“· <strong>ì´ë¯¸ì§€/ë²¡í„° êµ¬ë¶„:</strong> ë°°ê²½ì´ ë²¡í„°ë¼ë©´ ë²¡í„°ë¡œ, ì´ë¯¸ì§€ë¼ë©´ ì´ë¯¸ì§€ë¡œ ë“±ë¡.</li>
                    <li data-i18n="tpl_create_tip_2">ğŸ’¡ <strong>ê¿€íŒ:</strong> ê¸€ì”¨ ë°°ì¹˜ í›„ ë°°ê²½ë§Œ ë°”ê¾¸ë©´ ë¹ ë¥´ê²Œ ë“±ë¡ê°€ëŠ¥.</li>
                    <li data-i18n="tpl_create_tip_3">ğŸ’° <strong>ìˆ˜ìµ UP:</strong> íƒœê·¸ë¥¼ ë§ì´ ì…ë ¥í• ìˆ˜ë¡ ë…¸ì¶œì´ ì˜ ë˜ì–´ ìˆ˜ìµê¸ˆ ìƒìŠ¹.</li>
                    <li data-i18n="tpl_create_tip_4">âš¡ <strong>ì¦‰ì‹œ ì ë¦½:</strong> í…œí”Œë¦¿ ë“±ë¡ ì¦‰ì‹œ ìˆ˜ìµ + íŒë§¤ìˆ˜ìµê¹Œì§€.</li>
                </ul>
            </div>

            <label style="font-weight: bold; font-size: 14px; color: #1e293b; display: block; margin-bottom: 8px;" data-i18n="tpl_create_size_label">
                ğŸ“ ë§Œë“¤ê³  ì‹¶ì€ íƒ¬í”Œë¦¿ ì‚¬ì´ì¦ˆ (mm)
            </label>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <div style="flex: 1; position: relative;">
                    <input type="number" id="tplCreateW" class="ai-input-pretty" placeholder="ê°€ë¡œ" data-i18n-placeholder="ph_width" value="1000" style="padding-right: 30px; font-weight: bold; color: #334155;">
                    <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 12px;">mm</span>
                </div>
                <span style="display: flex; align-items: center; color: #cbd5e1;">X</span>
                <div style="flex: 1; position: relative;">
                    <input type="number" id="tplCreateH" class="ai-input-pretty" placeholder="ì„¸ë¡œ" data-i18n-placeholder="ph_height" value="1000" style="padding-right: 30px; font-weight: bold; color: #334155;">
                    <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 12px;">mm</span>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="document.getElementById('templateCreatorModal').style.display='none'" class="btn-round" style="flex: 1; justify-content: center; background: #fff; border: 1px solid #cbd5e1; color: #64748b;" data-i18n="btn_cancel">
                    ì·¨ì†Œ
                </button>
                <button onclick="window.confirmTemplateCreation()" class="btn-round primary" style="flex: 2; justify-content: center; height: 45px; font-size: 15px; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);" data-i18n="btn_start_design">
                    ğŸš€ ë””ìì¸ ì‹œì‘í•˜ê¸°
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ===== ì¹´ë©œë ˆì˜¨ AI ìƒë‹´ë´‡ ===== -->
<div id="cham-bot-trigger">
    <i class="fa-solid fa-comments" id="cham-bot-icon"></i>
    <span id="cham-bot-badge">1</span>
</div>

<div id="cham-bot-window">
    <div class="cham-header">
        <div class="cham-header-left">
            <div class="cham-avatar"><img src="https://gdadmin.signmini.com/data/common/favicon.ico" style="width:24px;height:24px;border-radius:50%;"></div>
            <div>
                <div class="cham-title" id="chamTitle">ì¹´ë©œë ˆì˜¨ AI ìƒë‹´</div>
                <div class="cham-subtitle" id="chamSubtitle"><i class="fa-solid fa-circle" style="color:#4ade80;font-size:7px;margin-right:4px;"></i>AI ì‹¤ì‹œê°„ ìƒë‹´ Â· 24ì‹œê°„</div>
            </div>
        </div>
        <button class="cham-close"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="cham-messages" id="chamMessages"></div>
    <div id="chamConnectBar" style="padding:6px 14px; background:#f0f9ff; border-top:1px solid #e0e7ff; display:flex; align-items:center; justify-content:center; gap:8px; flex-shrink:0;">
        <button id="chamConnectBtn" onclick="window.ChamBot_connectHuman ? window.ChamBot_connectHuman() : alert(typeof _ct==='function'?_ct('connectAlert'):'Please refresh and try again.');" style="background:none; border:1px solid #6366f1; color:#6366f1; padding:5px 14px; border-radius:20px; font-size:12px; cursor:pointer; font-weight:600; transition:all 0.2s;" onmouseover="this.style.background='#6366f1';this.style.color='#fff'" onmouseout="this.style.background='none';this.style.color='#6366f1'"><i class="fa-solid fa-headset"></i> <span id="chamConnectText">ìƒë‹´ì‚¬ ì—°ê²°</span></button>
    </div>
    <div class="cham-input-area">
        <label id="chamFileBtn" style="cursor:pointer; padding:8px; color:#6366f1; font-size:18px; display:flex; align-items:center;"><i class="fa-solid fa-paperclip"></i><input type="file" id="chamFileInput" style="display:none;" multiple accept="image/*,.pdf,.ai,.psd,.eps,.zip,.doc,.docx,.xlsx,.hwp"></label>
        <input type="text" id="chamInput" placeholder="ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”..." data-i18n-placeholder="cham_placeholder">
        <button class="cham-send" id="chamSendBtn"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>

<style>
#cham-bot-trigger{position:fixed;bottom:24px;right:24px;width:62px;height:62px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#4338ca);border:none;cursor:pointer;box-shadow:0 8px 30px rgba(99,102,241,.4);display:flex;align-items:center;justify-content:center;z-index:99998;transition:all .3s cubic-bezier(.4,0,.2,1);animation:chamPulse 2.5s infinite}
#cham-bot-trigger:hover{transform:scale(1.08);box-shadow:0 12px 40px rgba(99,102,241,.55)}
#cham-bot-trigger i{font-size:25px;color:#fff;transition:transform .3s}
#cham-bot-trigger.open i{transform:rotate(90deg)}
#cham-bot-badge{position:absolute;top:-2px;right:-2px;background:#ef4444;color:#fff;width:20px;height:20px;border-radius:50%;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;border:2px solid #fff;transition:opacity .3s}
#cham-bot-badge.hide{opacity:0;pointer-events:none}
@keyframes chamPulse{0%,100%{box-shadow:0 8px 30px rgba(99,102,241,.4)}50%{box-shadow:0 8px 30px rgba(99,102,241,.6),0 0 0 10px rgba(99,102,241,.08)}}
#cham-bot-window{position:fixed;bottom:100px;right:24px;width:400px;max-width:calc(100vw - 32px);height:640px;max-height:calc(100vh - 140px);background:#f8fafc;border-radius:18px;box-shadow:0 25px 80px rgba(30,27,75,.18);display:none;flex-direction:column;overflow:hidden;z-index:99999;border:1px solid #e2e8f0}
#cham-bot-window.visible{display:flex;animation:chamSlide .35s cubic-bezier(.34,1.56,.64,1)}
@keyframes chamSlide{from{opacity:0;transform:translateY(20px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}
.cham-header{background:linear-gradient(135deg,#6366f1 0%,#4338ca 100%);padding:16px 18px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.cham-header-left{display:flex;align-items:center;gap:10px}
.cham-avatar{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;font-size:20px}
.cham-title{color:#fff;font-size:15px;font-weight:800}
.cham-subtitle{color:rgba(255,255,255,.8);font-size:11px;margin-top:1px}
.cham-close{background:rgba(255,255,255,.12);border:none;color:#fff;width:30px;height:30px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s}
.cham-close:hover{background:rgba(255,255,255,.25)}
.cham-messages{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth}
.cham-messages::-webkit-scrollbar{width:4px}
.cham-messages::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px}
.cm-row{display:flex;gap:7px;max-width:88%;animation:cmIn .3s ease-out}
.cm-row.bot{align-self:flex-start}
.cm-row.user{align-self:flex-end;flex-direction:row-reverse}
@keyframes cmIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.cm-ava{width:28px;height:28px;border-radius:50%;background:#6366f1;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;flex-shrink:0;margin-top:2px}
.cm-row.user .cm-ava{display:none}
.cm-bub{padding:11px 15px;border-radius:16px;font-size:13.5px;line-height:1.7;word-break:keep-all;white-space:pre-line}
.cm-row.bot .cm-bub{background:#fff;border:1px solid #e2e8f0;border-top-left-radius:4px;color:#1e293b}
.cm-row.user .cm-bub{background:#6366f1;color:#fff;border-top-right-radius:4px}
.cm-typing{display:flex;gap:4px;padding:12px 16px}
.cm-typing span{width:6px;height:6px;background:#94a3b8;border-radius:50%;animation:cmBounce 1.4s infinite}
.cm-typing span:nth-child(2){animation-delay:.2s}
.cm-typing span:nth-child(3){animation-delay:.4s}
@keyframes cmBounce{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-5px);opacity:1}}
.cm-actions{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px}
.cm-qbtn{padding:6px 13px;border:1.5px solid #6366f1;border-radius:20px;background:#f5f3ff;color:#6366f1;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;font-family:inherit;white-space:nowrap}
.cm-qbtn:hover{background:#6366f1;color:#fff;transform:translateY(-1px)}
.cham-input-area{padding:10px 14px;background:#fff;border-top:1px solid #e2e8f0;display:flex;gap:7px;align-items:center;flex-shrink:0}
.cham-input-area input{flex:1;border:1.5px solid #e2e8f0;border-radius:12px;padding:10px 14px;font-size:13.5px;font-family:inherit;outline:none;transition:border-color .2s;background:#f8fafc}
.cham-input-area input:focus{border-color:#6366f1}
.cham-input-area input::placeholder{color:#94a3b8}
.cham-send{width:40px;height:40px;border-radius:50%;background:#6366f1;border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
.cham-send:hover{background:#4338ca;transform:scale(1.05)}
.cham-send:disabled{opacity:.4;cursor:not-allowed;transform:none}
.cham-send.loading i{animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:480px){
    #cham-bot-window{bottom:0;right:0;width:100vw;height:100vh;max-height:100vh;border-radius:0}
    #cham-bot-trigger{bottom:16px;right:16px;width:54px;height:54px}
}
</style>

<script>
(function() {
    'use strict';

    var SUPA_URL = "https://qinvtnhiidtmrzosyvys.supabase.co";
    var SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpbnZ0bmhpaWR0bXJ6b3N5dnlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMDE3NjQsImV4cCI6MjA3ODc3Nzc2NH0.3z0f7R4w3bqXTOMTi19ksKSeAkx8HOOTONNSos8Xz8Y";

    var db = window.sb || null;
    if (!db && typeof supabase !== 'undefined') {
        try { db = supabase.createClient(SUPA_URL, SUPA_KEY); window.sb = db; } catch(e) { console.warn('ì±—ë´‡ DB ì—°ê²° ì‹¤íŒ¨', e); }
    }
    if (!window.sb && db) window.sb = db;

    var chatHistory = [];
    var opened = false;
    var isProcessing = false;
    var _aiRoom = null;       // AI ëŒ€í™”ìš© ì±„íŒ…ë°©
    var _aiSub = null;        // ë§¤ë‹ˆì € ë¼ì–´ë“¤ê¸° ê°ì§€ìš© realtime êµ¬ë…

    // ì±—ë´‡ ì „ì—­ ì–¸ì–´ ê°ì§€ (í•œë²ˆë§Œ)
    var _chamLang = (function(){ var p = new URLSearchParams(window.location.search).get('lang'); if(p) return p.toLowerCase(); var h = window.location.hostname; if(h.includes('cafe0101.com')) return 'ja'; if(h.includes('cafe3355.com')) return 'en'; return 'kr'; })();
    var _chamI18n = {
        title:      { kr: 'ì¹´ë©œë ˆì˜¨ AI ìƒë‹´', ja: 'ã‚«ãƒ¡ãƒ¬ã‚ªãƒ³ AIç›¸è«‡', en: 'Chameleon AI Chat' },
        subtitle:   { kr: 'AI ì‹¤ì‹œê°„ ìƒë‹´ Â· 24ì‹œê°„', ja: 'AIãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›¸è«‡ãƒ»24æ™‚é–“', en: 'AI Live Support Â· 24/7' },
        placeholder:{ kr: 'ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”...', ja: 'ã”è³ªå•ã‚’ã©ã†ã...', en: 'Ask anything...' },
        connect:    { kr: 'ìƒë‹´ì‚¬ ì—°ê²°', ja: 'ç›¸è«‡å“¡ã«æ¥ç¶š', en: 'Connect to Agent' },
        connectTo:  { kr: 'ìƒë‹´ì‚¬ì—ê²Œ ì—°ê²°í•©ë‹ˆë‹¤', ja: 'ç›¸è«‡å“¡ã«æ¥ç¶šã—ã¾ã™', en: 'Connecting to Agent' },
        enterName:  { kr: 'ë¨¼ì € ì„±í•¨ì„ ì•Œë ¤ì£¼ì„¸ìš”!', ja: 'ã¾ãšãŠåå‰ã‚’æ•™ãˆã¦ãã ã•ã„ï¼', en: 'Please enter your name first!' },
        namePh:     { kr: 'ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)', ja: 'ãŠåå‰ (ä¾‹: ç”°ä¸­å¤ªéƒ)', en: 'Name (e.g. John)' },
        nameBtn:    { kr: 'í™•ì¸', ja: 'ç¢ºèª', en: 'OK' },
        nameErr:    { kr: 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', ja: 'ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼', en: 'Please enter your name!' },
        fileMsg:    { kr: 'íŒŒì¼ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤! íŒŒì¼ ê´€ë ¨ ìƒë‹´ì´ í•„ìš”í•˜ì‹œë©´ í•˜ë‹¨ \'ìƒë‹´ì‚¬ ì—°ê²°\' ë²„íŠ¼ì„ ëˆŒëŸ¬ ë§¤ë‹ˆì €ì—ê²Œ ì§ì ‘ ì „ë‹¬í•´ì£¼ì„¸ìš” ğŸ˜Š', ja: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¾ã—ãŸï¼ãƒ•ã‚¡ã‚¤ãƒ«ã«é–¢ã™ã‚‹ã”ç›¸è«‡ã¯ä¸‹ã®ã€Œç›¸è«‡å“¡ã«æ¥ç¶šã€ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«ç›´æ¥ãŠä¼ãˆãã ã•ã„ ğŸ˜Š', en: 'File received! For file-related inquiries, click \'Connect to Agent\' below to reach a manager directly ğŸ˜Š' },
        customer:   { kr: 'ê³ ê°', ja: 'ãŠå®¢æ§˜', en: 'Customer' },
        webCustomer:{ kr: 'ì›¹ ê³ ê°', ja: 'WebãŠå®¢æ§˜', en: 'Web Customer' },
        connectAlert:{ kr: 'ìƒë‹´ ì—°ê²°ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!', ja: 'ç›¸è«‡æ¥ç¶šã‚’æº–å‚™ä¸­ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ï¼', en: 'Preparing connection. Please refresh the page and try again!' }
    };
    function _ct(key) { return (_chamI18n[key] && _chamI18n[key][_chamLang]) || (_chamI18n[key] && _chamI18n[key]['en']) || ''; }

    function getEl(id) { return document.getElementById(id); }

    function escHtml(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function fmtBot(text) {
        return text
            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
            .replace(/`(.*?)`/g, '<code style="background:#f1f5f9;padding:1px 4px;border-radius:3px;font-size:12px;">$1</code>');
    }

    function addMsg(text, who) {
        who = who || 'bot';
        var c = getEl('chamMessages');
        if (!c) return;
        var r = document.createElement('div');
        r.className = 'cm-row ' + who;
        var html = (who === 'bot') ? fmtBot(text) : escHtml(text);
        if (who === 'bot') {
            r.innerHTML = '<div class="cm-ava"><img src="https://gdadmin.signmini.com/data/common/favicon.ico" style="width:20px;height:20px;border-radius:50%;"></div><div class="cm-bub">' + html + '</div>';
        } else {
            r.innerHTML = '<div class="cm-bub">' + html + '</div>';
        }
        c.appendChild(r);
        c.scrollTop = c.scrollHeight;
    }

    // ë§¤ë‹ˆì € ë©”ì‹œì§€ í‘œì‹œ (ë¼ì–´ë“¤ê¸° ì‹œ)
    function addManagerMsg(name, text) {
        var c = getEl('chamMessages');
        if (!c) return;
        var h = '<div style="display:flex; flex-direction:column; align-items:flex-start; padding:2px 0;">';
        h += '<span style="font-size:10px; color:#6366f1; font-weight:600; margin-bottom:2px; padding-left:4px;">\uD83D\uDCAC ' + escHtml(name) + '</span>';
        h += '<div style="background:#f1f5f9; color:#334155; padding:10px 14px; border-radius:4px 16px 16px 16px; max-width:75%; font-size:13px; line-height:1.5; box-shadow:0 1px 4px rgba(0,0,0,0.06);">' + escHtml(text) + '</div>';
        h += '</div>';
        c.insertAdjacentHTML('beforeend', h);
        c.scrollTop = c.scrollHeight;
    }

    function showTyping() {
        var c = getEl('chamMessages');
        if (!c) return;
        var r = document.createElement('div');
        r.className = 'cm-row bot';
        r.id = 'chamTyping';
        r.innerHTML = '<div class="cm-ava"><img src="https://gdadmin.signmini.com/data/common/favicon.ico" style="width:20px;height:20px;border-radius:50%;"></div><div class="cm-bub"><div class="cm-typing"><span></span><span></span><span></span></div></div>';
        c.appendChild(r);
        c.scrollTop = c.scrollHeight;
    }

    function removeTyping() {
        var el = getEl('chamTyping');
        if (el) el.remove();
    }

    function addQuickBtns(arr) {
        var c = getEl('chamMessages');
        if (!c || !c.lastElementChild) return;
        var bub = c.lastElementChild.querySelector('.cm-bub');
        if (!bub) return;
        var d = document.createElement('div');
        d.className = 'cm-actions';
        arr.forEach(function(label) {
            var b = document.createElement('button');
            b.className = 'cm-qbtn';
            b.textContent = label;
            b.addEventListener('click', function() {
                var actions = document.querySelectorAll('.cm-actions');
                actions.forEach(function(el) { el.remove(); });
                processInput(label);
            });
            d.appendChild(b);
        });
        bub.appendChild(d);
    }

    function setLoading(on) {
        var btn = getEl('chamSendBtn');
        var inp = getEl('chamInput');
        if (!btn || !inp) return;
        isProcessing = on;
        btn.disabled = on;
        inp.disabled = on;
        if (on) {
            btn.classList.add('loading');
            btn.innerHTML = '<i class="fa-solid fa-spinner"></i>';
        } else {
            btn.classList.remove('loading');
            btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
            inp.focus();
        }
    }

    function welcome() {
        var c = getEl('chamMessages');
        if (!c) return;
        var d = document.createElement('div');
        d.className = 'cm-actions';
        d.style.cssText = 'display:flex;flex-wrap:wrap;gap:5px;padding:8px 0;';
        var _lang = (function(){ var p = new URLSearchParams(window.location.search).get('lang'); if(p) return p.toLowerCase(); var h = window.location.hostname; if(h.includes('cafe0101.com')) return 'ja'; if(h.includes('cafe3355.com')) return 'en'; return 'kr'; })();
        var quickBtns = {
            kr: ['\uD83D\uDCB0 \uAC00\uACA9 \uACAC\uC801 \uBB38\uC758', '\uD83D\uDCE6 \uBC30\uC1A1\uC740 \uC5BC\uB9C8\uB098 \uAC78\uB824\uC694?', '\uD83C\uDFE2 \uC0AC\uC5C5\uC790 \uD560\uC778 \uD61C\uD0DD'],
            ja: ['\uD83D\uDCB0 ãŠè¦‹ç©ã‚‚ã‚Š', '\uD83D\uDCE6 é…é€æ—¥æ•°ã¯ï¼Ÿ', '\uD83C\uDFE2 æ³•äººå‰²å¼•ã«ã¤ã„ã¦'],
            us: ['\uD83D\uDCB0 Get a Quote', '\uD83D\uDCE6 Shipping Times?', '\uD83C\uDFE2 Business Discounts']
        };
        var btns = quickBtns[_lang] || quickBtns[(_lang==='en'?'us':_lang)] || quickBtns['kr'];
        btns.forEach(function(label) {
            var b = document.createElement('button');
            b.className = 'cm-qbtn';
            b.textContent = label;
            b.addEventListener('click', function() {
                var actions = document.querySelectorAll('.cm-actions');
                actions.forEach(function(el) { el.remove(); });
                processInput(label);
            });
            d.appendChild(b);
        });
        c.appendChild(d);
    }

    // â”€â”€ AI ëŒ€í™”ìš© ì±„íŒ…ë°© ìƒì„± (ì²« ë©”ì‹œì§€ ì‹œ 1íšŒ) â”€â”€
    function ensureAiRoom() {
        if (_aiRoom) return Promise.resolve(_aiRoom);
        if (!db) return Promise.resolve(null);
        var _lang = (function(){ var p = new URLSearchParams(window.location.search).get('lang'); if(p) return p.toLowerCase(); var h = window.location.hostname; if(h.includes('cafe0101.com')) return 'ja'; if(h.includes('cafe3355.com')) return 'en'; return 'kr'; })();
        var _custName = _lang === 'ja' ? 'ã‚¦ã‚§ãƒ–é¡§å®¢' : (_lang === 'us' || _lang === 'en' ? 'Web Customer' : 'ì›¹ ê³ ê°');
        return db.from('chat_rooms').insert({
            customer_name: _custName,
            status: 'ai_chatting',
            source: 'chatbot',
            assigned_manager: ''
        }).select().single().then(function(res) {
            if (res.error || !res.data) { console.warn('AI ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨:', res.error); return null; }
            _aiRoom = res.data;
            console.log('âœ… AI ì±„íŒ…ë°© ìƒì„±:', _aiRoom.id);
            // ë§¤ë‹ˆì € ë¼ì–´ë“¤ê¸° ê°ì§€ìš© realtime êµ¬ë…
            subscribeManagerIntervene();
            return _aiRoom;
        });
    }

    // DBì— ë©”ì‹œì§€ ì €ì¥
    function saveMsg(senderType, message) {
        if (!db || !_aiRoom) return;
        var _lang = (function(){ var p = new URLSearchParams(window.location.search).get('lang'); if(p) return p.toLowerCase(); var h = window.location.hostname; if(h.includes('cafe0101.com')) return 'ja'; if(h.includes('cafe3355.com')) return 'en'; return 'kr'; })();
        var _custLabel = _lang === 'ja' ? 'ã‚¦ã‚§ãƒ–é¡§å®¢' : (_lang === 'us' || _lang === 'en' ? 'Web Customer' : 'ì›¹ ê³ ê°');
        var _botLabel = _lang === 'ja' ? 'AI ãƒœãƒƒãƒˆ' : (_lang === 'us' || _lang === 'en' ? 'AI Bot' : 'AI ë´‡');
        db.from('chat_messages').insert({
            room_id: _aiRoom.id,
            sender_type: senderType,
            sender_name: senderType === 'customer' ? _custLabel : _botLabel,
            message: message
        }).then(function(r) {
            if (r.error) console.warn('ë©”ì‹œì§€ ì €ì¥ ì‹¤íŒ¨:', r.error);
        });
    }

    // ë§¤ë‹ˆì € ë¼ì–´ë“¤ê¸° ê°ì§€ (realtime êµ¬ë…)
    function subscribeManagerIntervene() {
        if (!db || !_aiRoom || _aiSub) return;
        var msgArea = getEl('chamMessages');
        _aiSub = db.channel('ai-room-' + _aiRoom.id)
            .on('postgres_changes', {
                event: 'INSERT', schema: 'public', table: 'chat_messages',
                filter: 'room_id=eq.' + _aiRoom.id
            }, function(payload) {
                var m = payload.new;
                if (m.sender_type === 'manager') {
                    // ë§¤ë‹ˆì €ê°€ ë¼ì–´ë“¤ì—ˆìŒ! â†’ ì‹¤ì‹œê°„ ìƒë‹´ ëª¨ë“œë¡œ ì „í™˜
                    switchToLiveFromAI(m.sender_name || 'ë§¤ë‹ˆì €');
                    addManagerMsg(m.sender_name || 'ë§¤ë‹ˆì €', m.message);
                } else if (m.sender_type === 'system') {
                    if (msgArea) {
                        msgArea.insertAdjacentHTML('beforeend', '<div style="text-align:center; padding:6px 0;"><div style="display:inline-block; background:linear-gradient(135deg,#f0fdf4,#dcfce7); border:1px solid #86efac; border-radius:20px; padding:6px 16px; font-size:12px; color:#065f46;">' + m.message + '</div></div>');
                        msgArea.scrollTop = msgArea.scrollHeight;
                    }
                }
            }).subscribe();
    }

    // ë§¤ë‹ˆì € ë¼ì–´ë“¤ê¸° ì‹œ â†’ AI ëª¨ë“œì—ì„œ ì‹¤ì‹œê°„ ìƒë‹´ìœ¼ë¡œ ì „í™˜
    function switchToLiveFromAI(managerName) {
        if (window._chamLiveMode) return; // ì´ë¯¸ ì‹¤ì‹œê°„ ëª¨ë“œë©´ ë¬´ì‹œ
        // ì¸ê°„ ìƒë‹´ ëª¨ë“ˆì— ë°© ì •ë³´ ì „ë‹¬
        window._chamAiRoomForLive = _aiRoom;
        window._chamLiveMode = true;
        // AI êµ¬ë… í•´ì œ (ì¸ê°„ ìƒë‹´ ëª¨ë“ˆì´ ìƒˆë¡œ êµ¬ë…)
        if (_aiSub) { _aiSub.unsubscribe(); _aiSub = null; }
        // í—¤ë” ë³€ê²½
        var _lang = (function(){ var p = new URLSearchParams(window.location.search).get('lang'); if(p) return p.toLowerCase(); var h = window.location.hostname; if(h.includes('cafe0101.com')) return 'ja'; if(h.includes('cafe3355.com')) return 'en'; return 'kr'; })();
        var title = document.querySelector('.cham-title');
        var sub = document.querySelector('.cham-subtitle');
        var _mgrChat = _lang === 'ja' ? managerName + ' ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ç›¸è«‡' : (_lang === 'us' || _lang === 'en' ? managerName + ' Manager Chat' : managerName + ' ë§¤ë‹ˆì € ìƒë‹´');
        var _mgrConn = _lang === 'ja' ? 'ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼æ¥ç¶šæ¸ˆã¿' : (_lang === 'us' || _lang === 'en' ? 'Manager Connected' : 'ë§¤ë‹ˆì € ì—°ê²°ë¨');
        if (title) title.textContent = _mgrChat;
        if (sub) sub.innerHTML = '<i class="fa-solid fa-circle" style="color:#4ade80;font-size:7px;margin-right:4px;"></i>' + _mgrConn;
        // ìƒë‹´ì‚¬ ì—°ê²° ë°” ìˆ¨ê¸°ê¸°
        var bar = getEl('chamConnectBar');
        if (bar) bar.style.display = 'none';
        // ì¸ê°„ ìƒë‹´ ëª¨ë“ˆì— ì „í™˜ ì•Œë¦¼
        if (window._chamOnManagerTakeover) window._chamOnManagerTakeover(_aiRoom, managerName);
    }

    function askAI(userMessage) {
        var _lang = (function(){ var p = new URLSearchParams(window.location.search).get('lang'); if(p) return p.toLowerCase(); var h = window.location.hostname; if(h.includes('cafe0101.com')) return 'ja'; if(h.includes('cafe3355.com')) return 'en'; return 'kr'; })();
        var _errOffline = {
            kr: "í˜„ì¬ ì„œë²„ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!\n\nê¸‰í•˜ì‹  ë¬¸ì˜ëŠ” í•˜ë‹¨ 'ìƒë‹´ì‚¬ ì—°ê²°' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš” ğŸ˜Š",
            ja: "ç¾åœ¨ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­ã§ã™ã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ï¼\n\nãŠæ€¥ãã®å ´åˆã¯ä¸‹ã®ã€Œç›¸è«‡å“¡ã«æ¥ç¶šã€ãƒœã‚¿ãƒ³ã‚’ã”åˆ©ç”¨ãã ã•ã„ ğŸ˜Š",
            us: "Connecting to server. Please try again shortly!\n\nFor urgent inquiries, click 'Connect to Agent' below ğŸ˜Š"
        };
        var _errEmpty = {
            kr: "ì‘ë‹µì„ ì²˜ë¦¬í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
            ja: "å¿œç­”ã‚’å‡¦ç†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
            us: "Could not process the response. Please try again."
        };
        var _errGeneral = {
            kr: "ì£„ì†¡í•©ë‹ˆë‹¤, ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš” ğŸ˜¥\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì‹œê±°ë‚˜, í•˜ë‹¨ 'ìƒë‹´ì‚¬ ì—°ê²°' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!",
            ja: "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€ä¸€æ™‚çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ ğŸ˜¥\nã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ã„ãŸã ãã‹ã€ä¸‹ã®ã€Œç›¸è«‡å“¡ã«æ¥ç¶šã€ãƒœã‚¿ãƒ³ã‚’ã”åˆ©ç”¨ãã ã•ã„ï¼",
            us: "Sorry, a temporary error occurred ğŸ˜¥\nPlease try again shortly, or click 'Connect to Agent' below!"
        };
        var _l = (_lang === 'en') ? 'us' : _lang;
        if (!db) {
            return Promise.resolve(_errOffline[_l] || _errOffline['kr']);
        }
        return db.functions.invoke('chatbot-ai', {
            body: { message: userMessage, history: chatHistory.slice(-8), lang: _lang }
        }).then(function(result) {
            if (result.error) throw result.error;
            return (result.data && result.data.reply) || (_errEmpty[_l] || _errEmpty['kr']);
        }).catch(function(e) {
            console.error('AI í˜¸ì¶œ ì˜¤ë¥˜:', e);
            return _errGeneral[_l] || _errGeneral['kr'];
        });
    }

    function processInput(text) {
        if (isProcessing) return;
        addMsg(text, 'user');
        chatHistory.push({ role: 'user', content: text });
        setLoading(true);
        showTyping();

        // ì²« ë©”ì‹œì§€ ì‹œ AI ì±„íŒ…ë°© ìƒì„± í›„ ì§„í–‰
        ensureAiRoom().then(function() {
            saveMsg('customer', text);
            return askAI(text);
        }).then(function(reply) {
            removeTyping();
            addMsg(reply);
            chatHistory.push({ role: 'assistant', content: reply });
            if (chatHistory.length > 20) chatHistory = chatHistory.slice(-16);
            saveMsg('chatbot', reply);
        }).catch(function() {
            removeTyping();
            addMsg("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }).finally(function() {
            setLoading(false);
        });
    }

    function toggleBot() {
        var win = getEl('cham-bot-window');
        var trg = getEl('cham-bot-trigger');
        var ico = getEl('cham-bot-icon');
        var badge = getEl('cham-bot-badge');
        if (!win || !trg) return;

        if (win.classList.contains('visible')) {
            win.classList.remove('visible');
            trg.classList.remove('open');
            if (ico) ico.className = 'fa-solid fa-comments';
        } else {
            win.classList.add('visible');
            trg.classList.add('open');
            if (ico) ico.className = 'fa-solid fa-xmark';
            if (badge) badge.classList.add('hide');
            if (!opened) { welcome(); opened = true; }
            setTimeout(function() { var inp = getEl('chamInput'); if(inp) inp.focus(); }, 300);
        }
    }

    function sendMsg() {
        // ì‹¤ì‹œê°„ ìƒë‹´ ëª¨ë“œë©´ AIê°€ ì•„ë‹Œ ë§¤ë‹ˆì €ì—ê²Œ ì „ì†¡
        if (window._chamLiveMode) return;
        if (isProcessing) return;
        var inp = getEl('chamInput');
        if (!inp) return;
        var text = inp.value.trim();
        if (!text) return;
        inp.value = '';
        processInput(text);
    }

    // íŒŒì¼ ì²¨ë¶€ ì²˜ë¦¬ (AI ëª¨ë“œ: ë¯¸ë¦¬ë³´ê¸° + DB ì €ì¥)
    function handleFileAttach(files) {
        var c = getEl('chamMessages');
        if (!c) return;
        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            if (file.type.startsWith('image/')) {
                var reader = new FileReader();
                reader.onload = (function(f) {
                    return function(e) {
                        c.insertAdjacentHTML('beforeend', '<div style="display:flex; justify-content:flex-end; padding:2px 0;"><img src="' + e.target.result + '" style="max-width:200px;border-radius:12px;box-shadow:0 2px 8px rgba(99,102,241,0.2);" onclick="window.open(this.src)"></div>');
                        c.scrollTop = c.scrollHeight;
                    };
                })(file);
                reader.readAsDataURL(file);
            } else {
                c.insertAdjacentHTML('beforeend', '<div style="display:flex; justify-content:flex-end; padding:2px 0;"><div style="background:linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff; padding:8px 14px; border-radius:12px 12px 4px 12px; font-size:13px;">ğŸ“ ' + escHtml(file.name) + '</div></div>');
                c.scrollTop = c.scrollHeight;
            }
        }
        addMsg(_ct('fileMsg'));
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”© (DOMContentLoaded - ë¡œë”© ìˆœì„œ ì•ˆì „)
    function bindEvents() {
        // ì±—ë´‡ UI ë‹¤êµ­ì–´ ì ìš©
        var chamTitle = getEl('chamTitle');
        if (chamTitle) chamTitle.textContent = _ct('title');
        var chamSub = getEl('chamSubtitle');
        if (chamSub) chamSub.innerHTML = '<i class="fa-solid fa-circle" style="color:#4ade80;font-size:7px;margin-right:4px;"></i>' + _ct('subtitle');
        var chamPh = getEl('chamInput');
        if (chamPh) chamPh.placeholder = _ct('placeholder');
        var chamConn = getEl('chamConnectText');
        if (chamConn) chamConn.textContent = _ct('connect');

        var trigger = getEl('cham-bot-trigger');
        if (trigger) trigger.addEventListener('click', toggleBot);

        var closeBtn = document.querySelector('.cham-close');
        if (closeBtn) closeBtn.addEventListener('click', toggleBot);

        var sendBtn = getEl('chamSendBtn');
        if (sendBtn) sendBtn.addEventListener('click', sendMsg);

        var input = getEl('chamInput');
        if (input) {
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.isComposing) sendMsg();
            });
        }

        var fileInput = getEl('chamFileInput');
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                if (window._chamLiveMode) return;
                if (e.target.files.length > 0) handleFileAttach(e.target.files);
                e.target.value = '';
            });
        }
    }

    // DOM ì¤€ë¹„ë˜ë©´ ë°”ì¸ë”©
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bindEvents);
    } else {
        bindEvents();
    }

    // ì „ì—­ ì ‘ê·¼ìš©
    window.ChamBot = { toggle: toggleBot, send: sendMsg };

    console.log('\uD83E\uDD8E \uCE74\uBA5C\uB808\uC628 AI \uC0C1\uB2F4\uBD07 \uB85C\uB4DC \uC644\uB8CC');

})();
</script>

<script>
// â•â•â• ì¸ê°„ ìƒë‹´ ì—°ê²° ëª¨ë“ˆ â•â•â•
(function() {
    'use strict';
    
    var _room = null, _sub = null, _live = false;
    
    function getSb() {
        if (window.sb) return window.sb;
        // window.sbê°€ ì—†ìœ¼ë©´ ì§ì ‘ ìƒì„±
        try {
            window.sb = supabase.createClient(
                "https://qinvtnhiidtmrzosyvys.supabase.co",
                "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpbnZ0bmhpaWR0bXJ6b3N5dnlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMDE3NjQsImV4cCI6MjA3ODc3Nzc2NH0.3z0f7R4w3bqXTOMTi19ksKSeAkx8HOOTONNSos8Xz8Y"
            );
            console.log('ğŸ”— ìƒë‹´ëª¨ë“ˆ: Supabase ì§ì ‘ ìƒì„± ì™„ë£Œ');
            return window.sb;
        } catch(e) {
            console.error('ìƒë‹´ëª¨ë“ˆ: Supabase ìƒì„± ì‹¤íŒ¨', e);
            return null;
        }
    }
    
    // ê¸°ë³¸ ìƒë‹´ì‚¬ (DB ë¡œë“œ ì‹¤íŒ¨ ì‹œ)
    var DEFAULT_MANAGERS = [
        {name:'ì§€ìˆ™', phone:'010-3455-1946'},
        {name:'ì€ë¯¸', phone:'010-7793-5393'},
        {name:'ì„±í¬', phone:'010-3490-3328'}
    ];

    // â”€â”€ ë§¤ë‹ˆì € ì„ íƒ UI í‘œì‹œ â”€â”€
    function showManagerPicker(managers, msgArea) {
        var h = '<div style="padding:4px 0;">';
        h += '<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); border-radius:16px; padding:16px; color:#fff; box-shadow:0 4px 15px rgba(102,126,234,0.3);">';
        h += '<div style="text-align:center; margin-bottom:12px;">';
        h += '<div style="font-size:28px; margin-bottom:4px;">ğŸ‘‹</div>';
        h += '<div style="font-weight:700; font-size:15px;">ìƒë‹´ ë§¤ë‹ˆì €ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>';
        h += '<div style="font-size:11px; opacity:0.8; margin-top:2px;">ì„ íƒí•˜ì‹œë©´ ë°”ë¡œ ì—°ê²°ë©ë‹ˆë‹¤</div>';
        h += '</div>';
        h += '<div style="display:flex; flex-direction:column; gap:8px;">';
        var colors = ['#4f46e5','#7c3aed','#2563eb','#0891b2','#059669'];
        managers.forEach(function(mgr, i) {
            var c = colors[i % colors.length];
            h += '<button class="cham-mgr-btn" data-name="' + mgr.name + '" style="background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); color:#fff; border:1px solid rgba(255,255,255,0.3); padding:12px 16px; border-radius:12px; cursor:pointer; font-size:14px; font-weight:600; display:flex; align-items:center; gap:10px; transition:all 0.2s;" onmouseover="this.style.background=\'rgba(255,255,255,0.3)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.15)\'">';
            h += '<span style="background:rgba(255,255,255,0.2); width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:16px;">ğŸ“</span>';
            h += '<span style="flex:1; text-align:left;"><div>' + mgr.name + ' ë§¤ë‹ˆì €</div>';
            if (mgr.phone) h += '<div style="font-size:11px; opacity:0.7; font-weight:400;">' + mgr.phone + '</div>';
            h += '</span><span style="font-size:18px;">â†’</span></button>';
        });
        h += '</div></div></div>';
        msgArea.insertAdjacentHTML('beforeend', h);
        msgArea.scrollTop = msgArea.scrollHeight;
        
        var btns = msgArea.querySelectorAll('.cham-mgr-btn');
        btns.forEach(function(btn) {
            btn.addEventListener('click', function() {
                startLive(btn.getAttribute('data-name'));
            });
        });
    }

    // â”€â”€ ìƒë‹´ì‚¬ ì—°ê²° (ì§„ì…ì ) â”€â”€
    var _customerName = '';
    
    window.ChamBot_connectHuman = function() {
        var msgArea = document.getElementById('chamMessages');
        if (!msgArea) return;
        
        // ë¨¼ì € ê³ ê° ì´ë¦„ ì…ë ¥ ë°›ê¸°
        var h = '<div style="padding:4px 0;">';
        h += '<div style="background:linear-gradient(135deg,#f0f9ff,#e0f2fe); border:1px solid #7dd3fc; border-radius:16px; padding:16px;">';
        h += '<div style="text-align:center; margin-bottom:10px;">';
        h += '<div style="font-size:24px;">âœ¨</div>';
        h += '<div style="font-weight:700; color:#0369a1; font-size:14px;">' + _ct('connectTo') + '</div>';
        h += '<div style="font-size:12px; color:#0284c7; margin-top:2px;">' + _ct('enterName') + '</div>';
        h += '</div>';
        h += '<div style="display:flex; gap:6px;">';
        h += '<input id="chamCustName" type="text" placeholder="' + _ct('namePh') + '" style="flex:1; padding:10px 14px; border:1.5px solid #7dd3fc; border-radius:10px; font-size:13px; outline:none; font-family:inherit;">';
        h += '<button id="chamCustNameBtn" style="background:#0284c7; color:#fff; border:none; padding:10px 16px; border-radius:10px; font-weight:700; cursor:pointer; font-size:13px; white-space:nowrap;">' + _ct('nameBtn') + '</button>';
        h += '</div></div></div>';
        msgArea.insertAdjacentHTML('beforeend', h);
        msgArea.scrollTop = msgArea.scrollHeight;
        
        var nameInput = document.getElementById('chamCustName');
        var nameBtn = document.getElementById('chamCustNameBtn');
        if (nameInput) nameInput.focus();
        
        function onNameSubmit() {
            var name = nameInput.value.trim();
            if (!name) { nameInput.style.borderColor = '#ef4444'; nameInput.placeholder = _ct('nameErr'); return; }
            _customerName = name;
            
            // ì´ë¦„ ì…ë ¥ UI ì œê±°
            var card = nameBtn.closest('div[style*="padding:4px"]');
            if (card) card.remove();
            
            // ë§¤ë‹ˆì € ì„ íƒ UI í‘œì‹œ
            var sb = getSb();
            if (!sb) { showManagerPicker(DEFAULT_MANAGERS, msgArea); return; }
            
            sb.from('chatbot_knowledge').select('question,answer')
              .eq('category', '_managers').eq('is_active', true)
              .then(function(res) {
                var mgrs = [];
                if (res.data && res.data.length > 0) {
                    res.data.forEach(function(m) {
                        try { mgrs.push(JSON.parse(m.answer)); } catch(e) { mgrs.push({name: m.question}); }
                    });
                }
                showManagerPicker(mgrs.length > 0 ? mgrs : DEFAULT_MANAGERS, msgArea);
            }).catch(function() {
                showManagerPicker(DEFAULT_MANAGERS, msgArea);
            });
        }
        
        if (nameBtn) nameBtn.addEventListener('click', onNameSubmit);
        if (nameInput) nameInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') onNameSubmit(); });
    };

    // â”€â”€ ì‹¤ì‹œê°„ ìƒë‹´ ì‹œì‘ â”€â”€
    function startLive(managerName) {
        var sb = getSb();
        var msgArea = document.getElementById('chamMessages');
        if (!sb || !msgArea) {
            if (msgArea) msgArea.insertAdjacentHTML('beforeend', '<div class="cham-msg bot">ì—°ê²° ì¤‘ ì˜¤ë¥˜! ğŸ“ ì§ì ‘ ì „í™”í•´ì£¼ì„¸ìš”.</div>');
            return;
        }
        
        // AI ëŒ€í™” ìš”ì•½
        var summary = '';
        try {
            var hist = window.ChamBot && window.ChamBot._history ? window.ChamBot._history : [];
            summary = hist.slice(-4).map(function(h) {
                return (h.role === 'user' ? 'ê³ ê°: ' : 'AI: ') + String(h.content).substring(0, 80);
            }).join('\n');
        } catch(e) {}
        
        sb.from('chat_rooms').insert({
            customer_name: _customerName || 'ê³ ê°',
            assigned_manager: managerName,
            status: 'waiting',
            source: 'chatbot',
            ai_summary: summary
        }).select().single().then(function(res) {
            if (res.error || !res.data) {
                console.error('chat_rooms INSERT ì—ëŸ¬:', res.error);
                msgArea.insertAdjacentHTML('beforeend', '<div class="cham-msg bot">ìƒë‹´ ì—°ê²° ì‹¤íŒ¨ ğŸ˜¥ ì§ì ‘ ì „í™”í•´ì£¼ì„¸ìš”!<br>ğŸ“ ì§€ìˆ™: 010-3455-1946</div>');
                return;
            }
            console.log('âœ… ìƒë‹´ë°© ìƒì„± ì„±ê³µ:', res.data.id);
            
            _room = res.data;
            _live = true; window._chamLiveMode = true;
            
            // í—¤ë” ë³€ê²½
            var title = document.querySelector('.cham-title');
            var sub = document.querySelector('.cham-subtitle');
            if (title) title.textContent = managerName + ' ë§¤ë‹ˆì € ìƒë‹´';
            if (sub) sub.innerHTML = '<i class="fa-solid fa-circle" style="color:#fbbf24;font-size:7px;margin-right:4px;"></i>' + (_customerName||'ê³ ê°') + 'ë‹˜ ì—°ê²° ëŒ€ê¸° ì¤‘...';
            
            // ì•ˆë‚´ ë©”ì‹œì§€
            msgArea.insertAdjacentHTML('beforeend',
                '<div style="padding:4px 0;">' +
                '<div style="background:linear-gradient(135deg,#d1fae5 0%,#a7f3d0 100%); border-radius:16px; padding:16px; border:1px solid #6ee7b7;">' +
                '<div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">' +
                '<span style="background:#10b981; color:#fff; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px;">ğŸ”—</span>' +
                '<div><div style="font-weight:700; color:#065f46; font-size:14px;">' + managerName + ' ë§¤ë‹ˆì €ì—ê²Œ ì—°ê²° ìš”ì²­!</div>' +
                '<div style="font-size:12px; color:#047857;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” ğŸ˜Š</div></div>' +
                '</div>' +
                '<div style="background:rgba(255,255,255,0.6); border-radius:10px; padding:10px; font-size:12px; color:#065f46;">' +
                'ğŸ’¡ <b>Tip:</b> ì•„ë˜ ğŸ“ ë²„íŠ¼ìœ¼ë¡œ ì‚¬ì§„/íŒŒì¼ë„ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”!' +
                '</div></div></div>'
            );
            
            // íŒŒì¼ ë²„íŠ¼: ì‹¤ì‹œê°„ ìƒë‹´ ëª¨ë“œ ì „ìš© í•¸ë“¤ëŸ¬ ë“±ë¡
            var fileInput = document.getElementById('chamFileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    if (!_live) return;
                    for (var i = 0; i < e.target.files.length; i++) uploadFile(e.target.files[i]);
                    e.target.value = '';
                }, true);
            }
            
            // ìƒë‹´ì‚¬ ì—°ê²° ë°” ìˆ¨ê¸°ê¸°
            var bar = document.getElementById('chamConnectBar');
            if (bar) bar.style.display = 'none';
            
            // Realtime êµ¬ë…
            _sub = sb.channel('room-' + _room.id)
                .on('postgres_changes', {
                    event: 'INSERT', schema: 'public', table: 'chat_messages',
                    filter: 'room_id=eq.' + _room.id
                }, function(payload) {
                    var m = payload.new;
                    if (m.sender_type === 'manager') {
                        var mn = m.sender_name || 'ë§¤ë‹ˆì €';
                        var mh = '<div style="display:flex; flex-direction:column; align-items:flex-start; padding:2px 0;">';
                        mh += '<span style="font-size:10px; color:#6366f1; font-weight:600; margin-bottom:2px; padding-left:4px;">ğŸ’¬ ' + mn + '</span>';
                        if (m.file_url) {
                            if (m.file_type && m.file_type.startsWith('image/'))
                                mh += '<img src="' + m.file_url + '" style="max-width:220px;border-radius:12px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.1);" onclick="window.open(this.src)">';
                            else
                                mh += '<a href="' + m.file_url + '" target="_blank" style="background:#f0f9ff;border:1px solid #7dd3fc;padding:8px 14px;border-radius:10px;color:#0284c7;text-decoration:none;font-size:13px;display:inline-block;">ğŸ“ ' + (m.file_name||'íŒŒì¼ ë‹¤ìš´ë¡œë“œ') + '</a>';
                        }
                        if (m.message) {
                            // URLì„ í´ë¦­ ê°€ëŠ¥í•œ ë§í¬ë¡œ ë³€í™˜
                            var msgText = m.message.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" style="color:#2563eb; text-decoration:underline;">$1</a>');
                            mh += '<div style="background:#f1f5f9; color:#334155; padding:10px 14px; border-radius:4px 16px 16px 16px; max-width:75%; font-size:13px; line-height:1.5; box-shadow:0 1px 4px rgba(0,0,0,0.06);">' + msgText + '</div>';
                        }
                        mh += '</div>';
                        msgArea.insertAdjacentHTML('beforeend', mh);
                    } else if (m.sender_type === 'system') {
                        msgArea.insertAdjacentHTML('beforeend', '<div style="text-align:center; padding:6px 0;"><div style="display:inline-block; background:linear-gradient(135deg,#f0fdf4,#dcfce7); border:1px solid #86efac; border-radius:20px; padding:6px 16px; font-size:12px; color:#065f46;">' + m.message + '</div></div>');
                        if (m.message.indexOf('ì ‘ì†') >= 0 && sub) sub.innerHTML = '<i class="fa-solid fa-circle" style="color:#4ade80;font-size:7px;margin-right:4px;"></i>ìƒë‹´ ì¤‘';
                        if (m.message.indexOf('ì¢…ë£Œ') >= 0) endLive();
                    }
                    msgArea.scrollTop = msgArea.scrollHeight;
                }).subscribe();
            
            msgArea.scrollTop = msgArea.scrollHeight;
        }).catch(function(err) {
            console.error('ìƒë‹´ ì—°ê²° ì—ëŸ¬:', err);
            msgArea.insertAdjacentHTML('beforeend', '<div class="cham-msg bot">ì—°ê²° ì˜¤ë¥˜! ğŸ“ ì§€ìˆ™ ë§¤ë‹ˆì €: 010-3455-1946</div>');
        });
    }
    
    // â”€â”€ íŒŒì¼ ì—…ë¡œë“œ â”€â”€
    function uploadFile(file) {
        if (!_room) return;
        var sb = getSb(); if (!sb) return;
        var msgArea = document.getElementById('chamMessages');
        // í•œê¸€ íŒŒì¼ëª… â†’ ì•ˆì „í•œ ì˜ë¬¸ëª… ë³€í™˜
        var ext = file.name.split('.').pop().toLowerCase();
        var safeName = Date.now() + '-' + Math.random().toString(36).substr(2,6) + '.' + ext;
        var path = 'room-' + _room.id + '/' + safeName;
        sb.storage.from('chat-files').upload(path, file, {upsert: true}).then(function(up) {
            if (up.error) { console.error('íŒŒì¼ ì—…ë¡œë“œ ì—ëŸ¬:', up.error); msgArea.insertAdjacentHTML('beforeend', '<div style="padding:4px 0;"><div style="background:#fef2f2; border:1px solid #fca5a5; border-radius:10px; padding:8px 12px; font-size:12px; color:#dc2626;">âŒ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (up.error.message||'ê¶Œí•œ ì˜¤ë¥˜') + '</div></div>'); return; }
            console.log('âœ… íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ:', path);
            var url = sb.storage.from('chat-files').getPublicUrl(path).data.publicUrl;
            console.log('ğŸ“ íŒŒì¼ URL:', url, 'íŒŒì¼íƒ€ì…:', file.type, 'íŒŒì¼ëª…:', file.name);
            sb.from('chat_messages').insert({
                room_id: _room.id,
                sender_type: 'customer',
                sender_name: _customerName || 'ê³ ê°',
                file_url: url,
                file_name: file.name,
                file_type: file.type,
                message: ''
            }).then(function(r) {
                if (r.error) console.error('âŒ íŒŒì¼ ë©”ì‹œì§€ DB ì €ì¥ ì—ëŸ¬:', r.error);
                else console.log('âœ… íŒŒì¼ ë©”ì‹œì§€ DB ì €ì¥ ì„±ê³µ, file_url:', url);
            });
            if (file.type.startsWith('image/'))
                msgArea.insertAdjacentHTML('beforeend', '<div style="display:flex; justify-content:flex-end; padding:2px 0;"><img src="' + url + '" style="max-width:200px;border-radius:12px;box-shadow:0 2px 8px rgba(99,102,241,0.2);cursor:pointer;" onclick="window.open(this.src)"></div>');
            else
                msgArea.insertAdjacentHTML('beforeend', '<div style="display:flex; justify-content:flex-end; padding:2px 0;"><div style="background:linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff; padding:8px 14px; border-radius:12px 12px 4px 12px; font-size:13px;">ğŸ“ ' + file.name + ' âœ…</div></div>');
            msgArea.scrollTop = msgArea.scrollHeight;
        });
    }

    // â”€â”€ ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë²„ë¼ì´ë“œ â”€â”€
    function overrideSend() {
        var sendBtn = document.getElementById('chamSendBtn');
        var input = document.getElementById('chamInput');
        if (sendBtn) {
            sendBtn.addEventListener('click', function(e) {
                if (_live) { e.stopImmediatePropagation(); liveSend(); }
            }, true);
        }
        if (input) {
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.isComposing && _live) { e.stopImmediatePropagation(); e.preventDefault(); liveSend(); }
            }, true);
        }
    }
    
    function liveSend() {
        var inp = document.getElementById('chamInput');
        if (!inp || !_room) return;
        var text = inp.value.trim(); if (!text) return;
        inp.value = '';
        var msgArea = document.getElementById('chamMessages');
        msgArea.insertAdjacentHTML('beforeend', '<div style="display:flex; justify-content:flex-end; padding:2px 0;"><div style="background:linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff; padding:10px 14px; border-radius:16px 16px 4px 16px; max-width:75%; font-size:13px; line-height:1.5; box-shadow:0 2px 8px rgba(99,102,241,0.2);">' + text + '</div></div>');
        msgArea.scrollTop = msgArea.scrollHeight;
        var sb = getSb();
        if (sb) {
            sb.from('chat_messages').insert({ room_id: _room.id, sender_type: 'customer', sender_name: _customerName || _ct('customer'), message: text })
              .then(function(r) { if(r.error) console.error('ë©”ì‹œì§€ ì „ì†¡ ì—ëŸ¬:', r.error); else console.log('âœ… ê³ ê° ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ'); });
        }
    }

    // â”€â”€ ìƒë‹´ ì¢…ë£Œ â”€â”€
    function endLive() {
        _live = false; _room = null; window._chamLiveMode = false;
        if (_sub) { _sub.unsubscribe(); _sub = null; }
        var title = document.querySelector('.cham-title');
        var sub = document.querySelector('.cham-subtitle');
        if (title) title.textContent = _ct('title');
        if (sub) sub.innerHTML = '<i class="fa-solid fa-circle" style="color:#4ade80;font-size:7px;margin-right:4px;"></i>' + _ct('subtitle');
        var bar = document.getElementById('chamConnectBar'); if (bar) bar.style.display = 'flex';
    }
    
    // â”€â”€ ë§¤ë‹ˆì € ë¼ì–´ë“¤ê¸° ì „í™˜ í•¸ë“¤ëŸ¬ â”€â”€
    // AI ì±—ë´‡ ëª¨ë“ˆì—ì„œ ë§¤ë‹ˆì €ê°€ ë¼ì–´ë“¤ë©´ ì´ í•¨ìˆ˜ê°€ í˜¸ì¶œë¨
    window._chamOnManagerTakeover = function(aiRoom, managerName) {
        var sb = getSb();
        if (!sb || !aiRoom) return;
        _room = aiRoom;
        _customerName = _customerName || _ct('webCustomer');
        _live = true;
        window._chamLiveMode = true;

        // íŒŒì¼ ë²„íŠ¼: ì‹¤ì‹œê°„ ìƒë‹´ ëª¨ë“œ ì „ìš© í•¸ë“¤ëŸ¬ ë“±ë¡
        var fileInput = document.getElementById('chamFileInput');
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                if (!_live) return;
                for (var i = 0; i < e.target.files.length; i++) uploadFile(e.target.files[i]);
                e.target.value = '';
            }, true);
        }

        // ìƒë‹´ì‚¬ ì—°ê²° ë°” ìˆ¨ê¸°ê¸°
        var bar = document.getElementById('chamConnectBar');
        if (bar) bar.style.display = 'none';

        // Realtime êµ¬ë… (ë§¤ë‹ˆì € ë©”ì‹œì§€ ìˆ˜ì‹ )
        var msgArea = document.getElementById('chamMessages');
        _sub = sb.channel('room-' + _room.id)
            .on('postgres_changes', {
                event: 'INSERT', schema: 'public', table: 'chat_messages',
                filter: 'room_id=eq.' + _room.id
            }, function(payload) {
                var m = payload.new;
                if (m.sender_type === 'manager') {
                    var mn = m.sender_name || 'ë§¤ë‹ˆì €';
                    var mh = '<div style="display:flex; flex-direction:column; align-items:flex-start; padding:2px 0;">';
                    mh += '<span style="font-size:10px; color:#6366f1; font-weight:600; margin-bottom:2px; padding-left:4px;">\uD83D\uDCAC ' + mn + '</span>';
                    if (m.file_url) {
                        if (m.file_type && m.file_type.startsWith('image/'))
                            mh += '<img src="' + m.file_url + '" style="max-width:220px;border-radius:12px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.1);" onclick="window.open(this.src)">';
                        else
                            mh += '<a href="' + m.file_url + '" target="_blank" style="background:#f0f9ff;border:1px solid #7dd3fc;padding:8px 14px;border-radius:10px;color:#0284c7;text-decoration:none;font-size:13px;display:inline-block;">ğŸ“ ' + (m.file_name||'íŒŒì¼ ë‹¤ìš´ë¡œë“œ') + '</a>';
                    }
                    if (m.message) {
                        var msgText = m.message.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" style="color:#2563eb; text-decoration:underline;">$1</a>');
                        mh += '<div style="background:#f1f5f9; color:#334155; padding:10px 14px; border-radius:4px 16px 16px 16px; max-width:75%; font-size:13px; line-height:1.5; box-shadow:0 1px 4px rgba(0,0,0,0.06);">' + msgText + '</div>';
                    }
                    mh += '</div>';
                    msgArea.insertAdjacentHTML('beforeend', mh);
                } else if (m.sender_type === 'system') {
                    msgArea.insertAdjacentHTML('beforeend', '<div style="text-align:center; padding:6px 0;"><div style="display:inline-block; background:linear-gradient(135deg,#f0fdf4,#dcfce7); border:1px solid #86efac; border-radius:20px; padding:6px 16px; font-size:12px; color:#065f46;">' + m.message + '</div></div>');
                    if (m.message.indexOf('ì¢…ë£Œ') >= 0) endLive();
                }
                msgArea.scrollTop = msgArea.scrollHeight;
            }).subscribe();
    };

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', overrideSend);
    else setTimeout(overrideSend, 300);

    console.log('ğŸ”— ì¸ê°„ ìƒë‹´ ì—°ê²° ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ');
})();
</script>

</body>
</html>