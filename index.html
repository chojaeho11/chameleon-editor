<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>카멜레온 무료에디터 카프 : Expert Studio (Full Version)</title>
<title>카멜레온 카프 : Expert Studio</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/svg2pdf.js@2.2.4/dist/svg2pdf.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/plugins/svg.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/kilobtye/potrace@master/potrace.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.17/paper-full.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/GmarketSans/build/GmarketSans.css">
<link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&family=Nanum+Myeongjo:wght@400;700;800&family=Do+Hyeon&family=Jua&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<head>
    <link rel="stylesheet" href="./style.css"> 
</head>

</head>

<body>
<div id="loading"><div class="loading-spin"></div><p style="margin-top:15px; font-weight:600;">로딩 중입니다...</p></div>

<div id="contextMenu">
    <div class="ctx-item" id="ctxUndo"><i class="fa-solid fa-rotate-left"></i> 실행 취소</div>
    <div class="ctx-item" id="ctxRedo"><i class="fa-solid fa-rotate-right"></i> 다시 실행</div>
    <div class="ctx-divider"></div>
    <div class="ctx-item" id="ctxCopy"><i class="fa-regular fa-copy"></i> 복사하기</div>
    <div class="ctx-item" id="ctxPaste"><i class="fa-regular fa-paste"></i> 붙여넣기</div>
    <div class="ctx-item" id="ctxDelete" style="color:#ef4444;"><i class="fa-solid fa-trash"></i> 삭제하기</div>
    <div class="ctx-divider"></div>
    <div class="ctx-item" id="ctxFront"><i class="fa-solid fa-arrow-up-from-bracket"></i> 맨 앞으로</div>
    <div class="ctx-item" id="ctxBack"><i class="fa-solid fa-arrow-down-from-bracket"></i> 맨 뒤로</div>
    <div class="ctx-divider"></div>
    <div class="ctx-item" id="ctxLock"><i class="fa-solid fa-lock"></i> 잠금 (Lock)</div>
</div>

<div id="startScreen">
    
    <div class="hero-section">
        <h1 class="hero-title">행사 준비하세요? <br><span>카멜레온</span>과 함께해요.</h1>
        <p class="hero-desc">행사 팝업스토어 기획자를 위한 도매쇼핑몰, 유저가 함께 만드는 무료에디터</p>
    </div>

    <div class="quick-menu-wrapper">
        <div class="quick-menu-label">맞춤형 디자인 시작하기</div>
        <div class="quick-menu-track" id="quickMenuContainer">
            </div>
    </div>
    
    <div class="gallery-section">
    <div class="gallery-header">함께 만드는 무료 에디터 - 카프</div>
    
    <div class="hero-search-wrap">
        <input type="search" 
               id="startSearchInput" 
               class="hero-search-input" 
               placeholder="어떤 디자인을 찾으세요? (예: 카페, 메뉴판, 여름)" 
               autocomplete="off" 
               readonly 
               onfocus="this.removeAttribute('readonly');"
        >
        <button id="btnStartSearch" class="hero-search-btn">
            <i class="fa-solid fa-magnifying-glass"></i> 검색
        </button>
    </div>

    <div id="startTemplateGrid" class="template-grid-start"></div>
    <div class="review-section">
    <div class="review-header">
        <h2>✨ 고객님들의 생생한 리얼 후기</h2>
        <p>카멜레온으로 완성된 멋진 결과물들을 확인해보세요.</p>
    </div>

    <div class="marquee-wrapper">
        <div class="marquee-track">
            <div class="review-card">
                <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000000048/image/detail/1000000048_detail_065.jpg');"></div>
                <div class="review-content">
                    <div class="review-stars">
                        <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                    </div>
                    <p class="review-text">"행사때마다 이용합니다. 기획사한테는 여기만한 곳이 없어요. 허니콤보드 진짜 저렴하고 빠르고 사장님 최고입니다."</p>
                    <div class="review-user">
                        <span class="u-name">제일기획 우*진 부장</span>
                        <span class="u-date">2024.03.15</span>
                    </div>
                </div>
            </div>

            <div class="review-card">
                <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000000049/image/detail/1000000049_detail_023.jpg');"></div>
                <div class="review-content">
                    <div class="review-stars">
                        <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                    </div>
                    <p class="review-text">"행사때 뭔가 포인트를 주고싶었는데 너무 좋았어요. 경기도에서 1개 시켰는데도 무료배송 너무 친절한 기사님까지 최고예요!"</p>
                    <div class="review-user">
                        <span class="u-name">이벤트기획 김*수</span>
                        <span class="u-date">2024.03.12</span>
                    </div>
                </div>
            </div>

            <div class="review-card">
                <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000004101/image/main/1000004101_main_028.png');"></div>
                <div class="review-content">
                    <div class="review-stars">
                        <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                    </div>
                    <p class="review-text">"키링 제작 진짜 너무 퀄리티 높은거 아닌가요? 소량구매는 안되서 아쉽지만 저희같은 판매자에게는 최고입니다."</p>
                    <div class="review-user">
                        <span class="u-name">도치맘**</span>
                        <span class="u-date">2024.03.10</span>
                    </div>
                </div>
            </div>

            <div class="review-card">
                <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000000428/image/detail/1000000428_detail_094.jpg');"></div>
                <div class="review-content">
                    <div class="review-stars">
                        <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star-half-stroke"></i>
                    </div>
                    <p class="review-text">"쉬폰인쇄 퀄리티 미쳤습니다. 여긴 달라요. UV로 만드는 색빠지는 그런거 아니고 찐 의류인쇄에 사용하는 방식이라는데 색감 퀄리티 빨아도 물 안빠지고 최고입니다. 강추!!!"</p>
                    <div class="review-user">
                        <span class="u-name">핸드메이드샵</span>
                        <span class="u-date">2024.03.08</span>
                    </div>
                </div>
            </div>

            <div class="review-card">
                <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000000113/image/main/1000000113_main_082.jpg');"></div>
                <div class="review-content">
                    <div class="review-stars">
                        <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                    </div>
                    <p class="review-text">"행사때마다 잘 이용하고 있습니다. 허니콤보드는 진짜 국내 1위라는게 헛말이 아닌곳. 이제 에디터까지 있어서 너무 편하고 좋습니다."</p>
                    <div class="review-user">
                        <span class="u-name">신화기획 최보람</span>
                        <span class="u-date">2025.12.15</span>
                    </div>
                </div>
            </div>
            <div class="review-card">
                <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000004088/image/detail/1000004088_detail_057.jpg');"></div>
                <div class="review-content">
                    <div class="review-stars">
                        <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                    </div>
                    <p class="review-text">"종이로 만든 원터치 매대, 써보니 진짜 튼튼해요 종이같지 않아요. 황서연 매니저라는분이 오셔서 설치 알려주셨는데 너무 친절하십니다."</p>
                    <div class="review-user">
                        <span class="u-name">몰타기획</span>
                        <span class="u-date">2024.03.12</span>
                    </div>
                </div>
            </div>

            <div class="review-card">
                <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000003080/image/detail/1000003080_detail_042.jpg');"></div>
                <div class="review-content">
                    <div class="review-stars">
                        <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                    </div>
                    <p class="review-text">"단상이 너무 옛날거라 촌스러워서 허니콤보드로 감싸서 사용했는데 행사의 품격이 올라갑니다."</p>
                    <div class="review-user">
                        <span class="u-name">엡손 김지수</span>
                        <span class="u-date">2024.03.10</span>
                    </div>
                </div>
            </div>

            <div class="review-card">
                <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000000051/image/detail/1000000051_detail_040.jpg');"></div>
                <div class="review-content">
                    <div class="review-stars">
                        <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star-half-stroke"></i>
                    </div>
                    <p class="review-text">"허니콤보드 종이가 이렇게까지 튼튼하고 예쁘다니 좋습니다. 진짜 맘에 들어요. 기획할때 꼭 넣어야하는 포인트"</p>
                    <div class="review-user">
                        <span class="u-name">에드팝사인기획</span>
                        <span class="u-date">2024.03.08</span>
                    </div>
                </div>
            </div>

            <div class="review-card">
                <div class="review-img" style="background-image: url('https://godomall.speedycdn.net/783b37df7f47037a1e127a356662e4f6/goods/1000003340/image/detail/1000000050_detail_061.jpg');"></div>
                <div class="review-content">
                    <div class="review-stars">
                        <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                    </div>
                    <p class="review-text">"일반배너와는 느낌이 달라요. 고급스럽고 독특하고 버리기도 편해서 좋아요."</p>
                    <div class="review-user">
                        <span class="u-name">최희수</span>
                        <span class="u-date">2025.12.15</span>
                    </div>
                </div>
            </div>
            
            
        </div>
    </div>
</div>
</div>

    <div class="footer-wrap">
        <div class="footer-inner">
            <div class="foot-left">
                <div class="foot-menu">
                    <ul>
                        <li><a href="#">회사소개</a></li>
                        <li><a href="#">공지사항</a></li>
                        <li><a href="#">이용약관</a></li>
                        <li><a href="#"><strong>개인정보처리방침</strong></a></li>
                    </ul>
                </div>
                <div class="foot-info">
                    <dl>
                        <dt>상호명 :</dt><dd>(주)카멜레온프린팅</dd>
                        <dt>대표 :</dt><dd>조재호</dd>
                    </dl>
                    <dl>
                        <dt>주소 :</dt><dd>경기도 화성시 우정읍 한말길 72-2</dd>
                    </dl>
                    <dl>
                        <dt>사업자등록번호 :</dt><dd>470-81-02808</dd>
                        <dt>통신판매업신고번호 :</dt><dd>2025-화성우정-0033</dd>
                    </dl>
                    <dl>
                        <dt>개인정보관리자 :</dt><dd>변지웅</dd>
                    </dl>
                    <p class="copyright">Copyright © <strong>Chameleon Canvas</strong>. all rights reserved.</p>
                </div>
            </div>

            <div class="cs-center">
                <h3>고객센터 (CS CENTER)</h3>
                <strong>031-366-1984</strong>
                <p>
                    평일 09:00 ~ 18:00 <br>
                    점심 12:00 ~ 13:00 <br>
                    <span>* 주말 및 공휴일 휴무</span>
                </p>
            </div>
        </div>
    </div>
    </div>
</div>

<div id="mainEditor">
    <div class="topbar">
    <div class="brand" onclick="location.reload()"><i class="fa-solid fa-palette"></i> Chameleon</div>
    
    <div class="template-tabs">
        <button id="btnMobileTemplateOpen" onclick="document.getElementById('templateOverlay').style.display='flex'">🎨 템플릿</button>
        <button class="tpl-tab" data-tpl="vector">배경</button>
        <button class="tpl-tab" data-tpl="graphic">백터</button>
        <button class="tpl-tab" data-tpl="photo-bg">사진</button>
        <button class="tpl-tab" data-tpl="transparent-graphic">패턴</button>
        <button class="tpl-tab" data-tpl="logo">로고</button>
    </div>
    
    <div style="flex:1;"></div>

    <button class="btn" id="btnMyLibrary" style="margin-right:5px; background:white; border:1px solid #ddd; color:#333; padding:8px 12px;">
        📂 <span class="pc-only">내 보관함</span>
    </button>

    <button class="btn" id="btnViewCart" onclick="document.getElementById('cartPage').style.display='block'" style="margin-right:5px; background:white; border:1px solid #ddd; color:#333; padding:8px 12px;">
        🛒 <span class="pc-only">장바구니</span>
    </button>
    <button class="btn primary" id="btnOrderTop" onclick="window.addToCartAndGo()" style="background:var(--primary); color:white; font-weight:bold; box-shadow:0 4px 12px rgba(99,102,241,0.4);">
        🚀 주문하기
    </button>
    
    <button class="btn" id="btnLoginBtn" style="margin-left:5px;">로그인</button>
</div>

    <div id="wallHeightControls">
        <div class="wall-label"><i class="fa-solid fa-ruler-vertical"></i> 가벽 높이선택</div>
        <button class="height-btn active" onclick="window.setWallHeight(2200, this)">220cm</button>
        <button class="height-btn" onclick="window.setWallHeight(2400, this)">240cm</button>
        <button class="height-btn" onclick="window.setWallHeight(3000, this)">300cm</button>
    </div>
    <div id="logoUploadModal" class="modal-bg">
    <div class="modal-box" style="width: 400px;">
        <h3 style="margin-top:0;">☁️ 로고 업로드</h3>
        <p style="color:#666; font-size:13px; margin-bottom:20px;">배경이 투명한 PNG 파일을 권장합니다.</p>
        
        <div class="upload-drop-zone" id="dropZone" onclick="document.getElementById('logoFileInput').click()">
            <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
            <span class="upload-text">클릭하여 파일 선택</span>
            <span class="upload-sub">또는 파일을 여기로 드래그하세요</span>
            
            <img id="previewImage">
            <div id="removeFileBtn" onclick="window.resetUpload(event)">✕</div>
        </div>

        <input type="file" id="logoFileInput" accept="image/png, image/jpeg, image/svg+xml" style="display:none;" onchange="window.handleFileSelect(this)">
        
        <div style="text-align:left; font-size:13px; font-weight:700; color:#333; margin-bottom:5px;">검색 태그</div>
        <input type="text" id="logoKeywordInput" class="ai-input-pretty" placeholder="예: 삼성, 로고, 심플 (쉼표로 구분)">
        
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="window.uploadUserLogo()" class="btn-round primary" style="flex:2;">업로드하기</button>
            <button onclick="document.getElementById('logoUploadModal').style.display='none'" class="btn-round" style="flex:1;">취소</button>
        </div>
    </div>
</div>


    <div class="editor-wrap">
        <div class="side" id="toolsPanel">
            <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:12px; margin-bottom:15px;">
                <div style="font-size:12px; font-weight:700; color:#64748b; margin-bottom:8px; display:flex; justify-content:space-between;">
                    <span>📏 사이즈 변경 (mm)</span>
                    <span id="limitLabel" style="color:#6366f1;">Max: -</span>
                </div>
                <div style="display:flex; gap:5px; align-items:center;">
                    <input type="number" id="inputUserW" class="ai-input-pretty" placeholder="가로" style="margin:0; padding:6px; font-size:13px; text-align:center;">
                    <span style="color:#999;">x</span>
                    <input type="number" id="inputUserH" class="ai-input-pretty" placeholder="세로" style="margin:0; padding:6px; font-size:13px; text-align:center;">
                </div>
                <button id="btnApplyUserSize" class="btn-round primary" style="width:100%; margin-top:8px; height:36px; font-size:13px;">
                    적용하기 (가격동일)
                </button>
                <p style="font-size:11px; color:#94a3b8; margin:5px 0 0 0; line-height:1.3;">
                    * 선택한 상품 크기 안에서만 조절 가능합니다.
                </p>
            </div>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button id="btnRotateCanvas" class="btn-round" style="flex:1;"><i class="fa-solid fa-rotate"></i> 캔버스 회전</button>
            </div>
            <div id="sizeTogglePanel" style="display:none; grid-template-columns: 1fr; gap:5px; margin-bottom:15px; padding:10px; background:#f8fafc; border-radius:10px; border:1px solid #e2e8f0;"></div>
            
            <div class="section-title">CANVAS TOOLS</div>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button id="btnFitScreen" class="btn-round" title="화면에 맞추기"><i class="fa-solid fa-compress"></i> 화면 맞춤</button>
                <button id="btnLockSelection" class="btn-round" onclick="window.toggleLockSelection()"><i class="fa-solid fa-lock"></i> 선택 잠금</button>
            </div>

            <div class="section-title">AI TOOLS</div>
            <button class="btn-round ai-red" id="btnAIBox"><i class="fa-solid fa-wand-magic-sparkles"></i> AI 이미지 생성</button>
            <button class="btn-round primary" id="btnRegisterTemplate" style="margin-top:5px; display:none;">👑 디자인 등록</button>
            <button class="btn-round" id="btnOpenSaveModal" style="margin-top:5px;">💾 디자인 저장</button>
            <button class="btn-round" onclick="document.getElementById('logoUploadModal').style.display='flex'" style="margin-top: 5px; margin-bottom: 20px; width: 100%; justify-content: center; background: #f8fafc; border: 1px solid #6366f1; color: #6366f1; font-weight: 800; flex-direction: column; height: auto; padding: 15px; gap: 5px;">
    <span style="font-size: 15px;"><i class="fa-solid fa-cloud-arrow-up"></i> 유저 로고 공유방</span>
    <span style="font-size: 11px; font-weight: normal; color: #64748b;">(PNG로고 5개 등록하면 등업됩니다. 등업이 완료되면 고화질 PDF 다운로드가능.)</span>
</button>
            
            <div class="section-title">BASIC TOOLS</div>
            <button class="btn-round" id="btnAddText">+ 텍스트 추가</button>
            <button class="btn-round" id="btnFontSelect" style="margin-top:5px;">🅰️ 폰트 변경</button>
            <div class="color-group"><span>면 색상</span><input id="fillColor" type="color" class="color-picker" value="#000000"></div>
            <div class="color-group" style="margin-top:5px;"><span>선 색상</span><input id="strokeColor" type="color" class="color-picker" value="#000000"></div>
            
            <div class="section-title">SHAPES</div>
            <div class="shape-panel">
                <button class="shape-btn" data-shape="rect">■</button>
                <button class="shape-btn" data-shape="circle">●</button>
                <button class="shape-btn" data-shape="triangle">▲</button>
                <button class="shape-btn" data-shape="star">★</button>
                <button class="shape-btn" data-shape="heart">♥</button>
                <button class="shape-btn" data-shape="arrow">➡</button>
                <button class="shape-btn" data-shape="round">▢</button>
                <button class="shape-btn" data-shape="line">━</button>
            </div>
            
            <div class="section-title">UPLOAD</div>
            <label class="upload-box" for="imgUpload"><span style="font-size:24px; margin-bottom:5px;"><i class="fa-solid fa-cloud-arrow-up"></i></span>이미지 / PDF 업로드</label>
            <input id="imgUpload" type="file" accept="image/*,.svg,.pdf" style="display:none;">
        </div>
        
        <div class="stage" id="stage">
            <div class="bottom-dock">
                <button id="btnZoomOut" class="zoom-btn"><i class="fa-solid fa-minus"></i></button>
                <button id="btnZoomIn" class="zoom-btn"><i class="fa-solid fa-plus"></i></button>
                <div class="divider"></div>
                <button id="guideToggle" class="zoom-btn" style="width:auto; padding:0 15px; border-radius:20px; font-size:12px;">가이드 켜기</button>
                <span class="help-text">Space: 화면이동 / 휠: 크기조절 / 방향키: 미세이동</span>
            </div>
            
            <div class="right-stack" id="rightStackPanel">
                <div class="panel-box" id="panelEdit">
                    <div class="section-title" style="margin-top:0;">편집 & 레이어</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:5px;">
                        <button class="tool-btn" id="btnUndo"><i class="fa-solid fa-rotate-left"></i> 실행취소</button>
                        <button class="tool-btn" id="btnRedo"><i class="fa-solid fa-rotate-right"></i> 다시실행</button>
                        <button class="tool-btn" id="btnCopy"><i class="fa-regular fa-copy"></i> 복사</button>
                        <button class="tool-btn" id="btnPaste"><i class="fa-regular fa-paste"></i> 붙여넣기</button>
                    </div>
                    
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <button class="tool-btn" id="btnRotateLeft15"><i class="fa-solid fa-rotate-left"></i> -15°</button>
                        <button class="tool-btn" id="btnRotateRight15"><i class="fa-solid fa-rotate-right"></i> +15°</button>
                    </div>

                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <button class="tool-btn" id="btnFront">맨앞</button>
                        <button class="tool-btn" id="btnBack">맨뒤</button>
                        <button class="tool-btn" id="btnDel" style="color:red;">삭제</button>
                    </div>
                    
                    <div class="section-title" style="margin-top:10px;">객체 정렬</div>
                    <div class="align-grid">
                        <button class="align-btn" id="btnAlignLeft"><i class="fa-solid fa-align-left"></i></button>
                        <button class="align-btn" id="btnAlignCenterH"><i class="fa-solid fa-arrows-left-right-to-line"></i></button>
                        <button class="align-btn" id="btnAlignRight"><i class="fa-solid fa-align-right"></i></button>
                        <button class="align-btn" id="btnAlignTop"><i class="fa-solid fa-align-left" style="transform:rotate(90deg)"></i></button>
                        <button class="align-btn" id="btnAlignMiddle"><i class="fa-solid fa-arrows-up-down-left-right"></i></button>
                        <button class="align-btn" id="btnAlignBottom"><i class="fa-solid fa-align-right" style="transform:rotate(90deg)"></i></button>
                    </div>
                    <button class="btn-round" id="btnCenterObject" onclick="window.alignObject('center')" style="margin-top:5px;">🎯 정중앙 정렬</button>
                    <button class="btn-round" onclick="window.setAsBackground()" style="margin-top:5px;">🖼 배경으로 꽉 채우기</button>
                </div>
                        <div class="section-title">CUTTING TOOLS</div>
<div class="tool-box-group">
    <div style="font-size:12px; color:#666; margin-bottom:8px; text-align:center;">
        이미지를 선택하고 클릭하세요
    </div>
    
    <button id="btn-create-outline" class="btn-round" style="width:100%; margin-bottom:8px; justify-content:center;">
        ✂️ 외곽선 만들기
    </button>

    <div style="display:flex; gap:8px;">
        <button id="btn-make-keyring" class="btn-round" style="flex:1; flex-direction:column; gap:5px; height:auto; padding:10px; font-size:12px;">
            <span>키링 고리</span>
        </button>
        
        <button id="btn-make-standee" class="btn-round" style="flex:1; flex-direction:column; gap:5px; height:auto; padding:10px; font-size:12px;">
            <span>등신대 받침</span>
        </button>
    </div>
</div>
                <div class="panel-box" id="panelText">
                    <div class="section-title" style="margin-top:0;">텍스트 설정</div>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <button class="tool-btn" id="btnAlignLeftText"><i class="fa-solid fa-align-left"></i></button>
                        <button class="tool-btn" id="btnAlignCenterText"><i class="fa-solid fa-align-center"></i></button>
                        <button class="tool-btn" id="btnAlignRightText"><i class="fa-solid fa-align-right"></i></button>
                    </div>
                    <div style="display:grid; grid-template-columns: 35px 1fr; gap:10px; align-items:center; margin-bottom:5px;">
                        <span style="font-size:12px; color:#666;">크기</span><input type="range" id="textSize" min="10" max="200" value="50" style="width:100%;">
                    </div>
                    <div style="display:grid; grid-template-columns: 35px 1fr; gap:10px; align-items:center; margin-bottom:5px;">
                        <span style="font-size:12px; color:#666;">자간</span><input type="range" id="textCharSpacing" min="-100" max="500" value="50" style="width:100%;">
                    </div>
                    <div style="display:grid; grid-template-columns: 35px 1fr; gap:10px; align-items:center;">
                        <span style="font-size:12px; color:#666;">행간</span><input type="range" id="textLineHeight" min="0.5" max="3.0" step="0.1" value="1.2" style="width:100%;">
                    </div>
                </div>
                
                <div class="panel-box">
                    <div class="section-title" style="margin-top:0; color:#333;">AI 이미지 도구</div>
                    <div class="ai-tool-stack">
                        <button class="tool-btn" id="btnCutout">✂️ 배경 제거</button>
                        <button class="tool-btn" id="btnEnhance">✨ 밝게 보정</button>
                        <button class="tool-btn" id="btnOutline">🔲 글자 테두리</button>
                    </div>
                    <div class="section-title">선 설정</div>
                    <input type="range" id="globalStroke" min="0" max="30" value="2" style="width:100%;">
                    
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button class="tool-btn" id="btnStrokeMiter" title="각지게"><i class="fa-solid fa-square"></i> 각지게</button>
                        <button class="tool-btn" id="btnStrokeRound" title="부드럽게"><i class="fa-solid fa-circle"></i> 둥글게</button>
                    </div>

                    <div class="section-title">투명도</div><input type="range" id="opacitySlider" min="0" max="100" value="100" style="width:100%;">
                </div>
            </div>
            <canvas id="designCanvas"></canvas>
        </div>
    </div>
</div>
<div id="mobileTextEditor" style="display:none;">
    <div class="m-text-header">
        <span style="color:#6366f1; font-weight:bold;"><i class="fa-solid fa-pen"></i> 텍스트 수정</span>
        
        <div style="display:flex; gap:5px;">
            <button onclick="window.deleteMobileObject()" style="background:#ef4444; color:white; border:none; padding:6px 12px; border-radius:6px; font-weight:bold; font-size:13px;">
                <i class="fa-solid fa-trash"></i> 삭제
            </button>
            
            <button onclick="window.closeMobileTextEditor()" style="background:#6366f1; color:white; border:none; padding:6px 12px; border-radius:6px; font-weight:bold; font-size:13px;">
                완료
            </button>
        </div>
    </div>
    <textarea id="mobileTextInput" placeholder="여기에 내용을 입력하세요..."></textarea>
</div>
<div id="templateActionModal" class="modal-bg" style="z-index: 20000;">
    <div class="modal-box" style="width: 500px; max-width: 90%;">
        <h3 style="margin-top:0; font-size: 20px;">🎨 템플릿 불러오기</h3>
        <p style="color:#666; font-size:15px; margin-bottom:30px; line-height: 1.5;">
            현재 작업 중인 디자인이 있습니다.<br>
            선택한 템플릿을 어떻게 적용하시겠습니까?
        </p>
        
        <div style="display:flex; gap:15px;">
            <button id="btnActionAdd" class="btn-round" style="flex:1; height:120px; flex-direction:column; justify-content:center; gap:10px; background:#f1f5f9; border:1px solid #cbd5e1; color:#334155;">
                <i class="fa-solid fa-layer-group" style="font-size:32px; color:#6366f1;"></i>
                <span style="font-size:16px; font-weight:bold;">현재 작업에 추가</span>
                <span style="font-size:12px; font-weight:normal; opacity:0.8;">기존 디자인 위에 겹치기</span>
            </button>

            <button id="btnActionReplace" class="btn-round ai-red" style="flex:1; height:120px; flex-direction:column; justify-content:center; gap:10px; border:none;">
                <i class="fa-solid fa-file-circle-check" style="font-size:32px;"></i>
                <span style="font-size:16px; font-weight:bold;">새 작업 시작</span>
                <span style="font-size:12px; font-weight:normal; opacity:0.8;">기존 내용 지우고 덮어쓰기</span>
            </button>
        </div>

        <button onclick="document.getElementById('templateActionModal').style.display='none'" class="btn-round" style="margin-top:20px; border:none; color:#999;">
            취소하고 돌아가기
        </button>
    </div>
</div>
<div id="sizeSelectModal" class="modal-bg" style="z-index: 15000;">
    <div class="modal-box" style="width: 800px; max-width: 95%;">
        <h3>📏 어떤 크기로 만드시겠습니까?</h3>
        <p style="margin-bottom:20px; color:#666;">선택한 제품 크기에 맞춰 템플릿이 자동으로 조절됩니다.</p>
        
        <div id="productSelectGrid" class="quick-menu-track" style="grid-template-columns: repeat(4, 1fr);"></div>
        
        <button onclick="document.getElementById('sizeSelectModal').style.display='none'" class="btn-round" style="margin-top:20px;">취소</button>
    </div>
</div>
<div id="aiDrawer" class="ai-drawer"><h3>✨ AI 이미지 생성</h3><p class="label">설명 (Prompt)</p><textarea id="aiPrompt" class="ai-input-pretty" placeholder="예: 숲속에 앉아있는 귀여운 갈색 토끼" style="height:100px;"></textarea><button id="aiGenerateBtn" class="btn-round primary" style="margin-top:10px;">생성하기</button><div id="aiResultArea" style="min-height:200px; background:#f9f9f9; margin-top:20px; display:flex; justify-content:center; align-items:center;"><span style="color:#ccc;">결과 대기 중</span></div><button id="aiUseBtn" class="btn-round" style="display:none; margin-top:10px;">캔버스에 넣기</button><button onclick="document.getElementById('aiDrawer').classList.remove('open')" class="btn-round" style="margin-top:10px;">닫기</button></div>
<div id="templateOverlay">
    <div class="tpl-modal-box">
        <div class="tpl-sidebar">
    <button class="tpl-cate-btn active" onclick="window.filterTpl('vector', this)"><span>배경</span></button>
    <button class="tpl-cate-btn" onclick="window.filterTpl('photo-bg', this)"><span>사진</span></button>
    <button class="tpl-cate-btn" onclick="window.filterTpl('graphic', this)"><span>백터</span></button>
    <button class="tpl-cate-btn" onclick="window.filterTpl('transparent-graphic', this)"><span>패턴</span></button>
    <button class="tpl-cate-btn" onclick="window.filterTpl('logo', this)"><span>로고</span></button>
</div>
        <div class="tpl-content">
            <div style="padding: 20px 30px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between;">
                <h2 style="margin:0;">검색</h2>
                <input type="text" id="tplSearchInput" class="ai-input-pretty" style="width:300px; margin-bottom:0;" placeholder="검색어 입력...">
                <button onclick="document.getElementById('templateOverlay').style.display='none'" style="border:none; background:none; cursor:pointer;">
                    <i class="fa-solid fa-xmark fa-2x"></i>
                </button>
            </div>
            <div id="tplGrid" class="tpl-grid"></div>
            <div style="padding:15px; text-align:right; border-top:1px solid #eee;">
                <button id="btnUseTpl" class="btn primary">선택한 템플릿 적용</button>
            </div> 
        </div>
    </div>
</div>
<div id="libraryModal" class="modal-bg" style="z-index: 11000;"><div class="modal-box" style="width: 800px; max-width: 90%; height: 80%; display: flex; flex-direction: column;"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h3 style="margin:0;">📂 내 디자인 보관함</h3><button onclick="document.getElementById('libraryModal').style.display='none'" style="border:none; background:none; cursor:pointer; font-size:20px;">✕</button></div><div id="myDesignGrid" style="flex:1; overflow-y:auto; display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:20px; padding:10px;"></div></div></div>
<div id="saveDesignModal" class="modal-bg" style="z-index: 11001;"><div class="modal-box"><h3>💾 디자인 저장하기</h3><p style="font-size:13px; color:#666;">보관함에 저장하여 나중에 다시 불러올 수 있습니다.</p><input id="saveDesignTitle" class="ai-input-pretty" placeholder="디자인 제목을 입력하세요 (예: 여름 이벤트 배너)"><div style="display:flex; gap:10px; margin-top:20px;"><button id="btnConfirmSave" class="btn-round primary">저장하기</button><button onclick="document.getElementById('saveDesignModal').style.display='none'" class="btn-round">취소</button></div></div></div>
<div id="loadModeModal" class="modal-bg" style="z-index: 10001;"><div class="modal-box" style="width: 450px;"><h3>🎨 템플릿 불러오기</h3><p style="color:#666; font-size:14px; margin-bottom:20px;">현재 캔버스 내용이 있습니다.</p><div style="display:flex; gap:10px;"><button id="btnLoadReplace" class="btn-round ai-red" style="height:100px;">새 작업으로<br>(기존 삭제)</button><button id="btnLoadAdd" class="btn-round primary" style="height:100px;">현재 작업에<br>추가하기</button></div><button onclick="document.getElementById('loadModeModal').style.display='none'" class="btn-round" style="margin-top:15px;">취소</button></div></div>
<div id="loginModal" class="modal-bg" style="z-index: 10002;"><div class="modal-box" style="width: 400px;"><h3 id="authTitle" style="margin-top:0;">로그인</h3><div style="display:flex; flex-direction:column; gap:10px; margin-bottom:15px;"><input id="loginId" class="ai-input-pretty" placeholder="이메일 주소" style="margin:0;"><input id="loginPw" class="ai-input-pretty" type="password" placeholder="비밀번호" style="margin:0;"><input id="loginPwConfirm" class="ai-input-pretty" type="password" placeholder="비밀번호 확인" style="margin:0; display:none;"></div><button class="btn-round primary" id="btnAuthAction" style="width:100%; justify-content:center; height:45px; font-size:15px;">로그인</button><div style="margin-top:15px; font-size:13px; color:#666;"><span id="authSwitchText">계정이 없으신가요?</span><span id="btnSwitchAuthMode" style="color:var(--primary); font-weight:bold; cursor:pointer; margin-left:5px; text-decoration:underline;">회원가입</span></div><hr style="margin:20px 0; border:0; border-top:1px solid #eee;"><div style="display:flex; flex-direction:column; gap:8px;"><button id="btnGoogleLogin" class="btn-round" style="border-color:#ddd; justify-content:center;"><i class="fa-brands fa-google" style="color:#DB4437; margin-right:8px;"></i> Google로 시작하기</button><button id="btnKakaoLogin" class="btn-round" style="border-color:#FEE500; background:#FEE500; color:#3C1E1E; justify-content:center;"><i class="fa-solid fa-comment" style="margin-right:8px;"></i> 카카오로 시작하기</button></div><button onclick="document.getElementById('loginModal').style.display='none'" class="btn-round" style="margin-top:15px; border:none; color:#888; width:100%;">닫기</button></div></div>
<div id="productDetailModal" class="modal-bg" style="z-index: 11000;"><div class="modal-box" style="width: 900px; max-width: 95%; display: flex; text-align: left; padding:0; overflow:hidden;"><div style="width: 45%; background: #f8fafc; display: flex; align-items: center; justify-content: center; padding: 20px;"><img id="pdpImage" src="" style="max-width: 100%; max-height: 300px; object-fit: contain;"></div><div style="width: 55%; padding: 40px; display: flex; flex-direction: column;"><h2 id="pdpTitle" style="margin: 0 0 10px 0;">상품명</h2><h3 id="pdpPrice" style="color: var(--primary); margin: 0 0 20px 0;">0원</h3><button id="btnActionDesign" class="btn-round primary" style="height: 50px;">🎨 직접 디자인하기</button><div style="margin-top:10px;"><input type="file" id="pdpFileUpload" style="display: none;"><button onclick="document.getElementById('pdpFileUpload').click()" class="btn-round">📂 파일 업로드 주문</button></div><button onclick="document.getElementById('productDetailModal').style.display='none'" style="margin-top: auto; border:none; background:none; cursor:pointer;">닫기</button></div></div></div>
<div id="cartPage" style="display:none; position:fixed; inset:0; background:#f1f5f9; z-index: 12000; overflow-y:auto; padding-top: 40px;">
    <div style="max-width: 1000px; margin: 0 auto; padding-bottom: 60px;">
        <div style="display:flex; justify-content:space-between; align-items:center; padding:0 20px;">
            <h1>🛒 장바구니 <span id="cartCount">(0)</span></h1>
            <button onclick="document.getElementById('cartPage').style.display='none'" class="btn-round" style="width:auto;">닫기</button>
        </div>

        <div style="display: flex; flex-direction: column; gap: 20px; padding: 0 20px;">
            
            <div id="cartListArea" style="width: 100%;"></div>
            
            <div style="width: 100%;">
                <div style="background:white; padding:20px; border-radius:12px;">
                    <h3>결제 금액</h3>
                    <div style="display:flex; justify-content:space-between;"><span>상품</span><span id="summaryItemPrice">0원</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>옵션</span><span id="summaryAddonPrice">0원</span></div>
                    <hr>
                    <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:20px;"><span>합계</span><span id="summaryTotal">0원</span></div>
                    <button id="btnGoCheckout" class="btn-round primary" style="margin-top:20px; width:100%;">💳 결제하기</button>
                    <button id="btnPrintQuote" class="btn-round btn-secondary" style="margin-top:10px; width:100%;"><i class="fa-solid fa-file-invoice"></i> 견적서 출력</button>
                </div>
            </div>

        </div>
    </div>
</div>
<div id="calendarModal" class="modal-bg" style="z-index: 12500;"><div class="modal-box"><h3>📅 배송요청 [제작기간 3일]</h3><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><button id="btnPrevMonth" class="btn-round" style="width:30px;">&lt;</button><span id="currentMonthYear" style="font-weight:bold;"></span><button id="btnNextMonth" class="btn-round" style="width:30px;">&gt;</button></div><div id="calendarGrid" class="calendar-grid"></div><button onclick="document.getElementById('calendarModal').style.display='none'" class="btn-round" style="margin-top:15px;">닫기</button></div></div>
<div id="deliveryInfoModal" class="modal-bg" style="z-index: 12600;"><div class="modal-box" style="text-align:left;"><h3 style="text-align:center;">📝 배송 정보 입력</h3><p>담당자명</p><input id="inputManagerName" class="ai-input-pretty"><p>연락처</p><input id="inputManagerPhone" class="ai-input-pretty"><p>주소</p><input id="inputAddress" class="ai-input-pretty"><p>요청사항</p><textarea id="inputRequest" class="ai-input-pretty"></textarea><button id="btnSubmitOrderInfo" class="btn-round primary" style="margin-top:10px;">주문서 생성 및 결제</button><button onclick="document.getElementById('deliveryInfoModal').style.display='none'" class="btn-round" style="margin-top:5px;">취소</button></div></div>
<div id="checkoutModal" class="modal-bg" style="z-index: 13000;">
    <div class="modal-box" style="text-align:left;">
        <h3 style="text-align:center; margin-bottom: 20px;">주문 확인 및 결제</h3>
        
        <label style="font-size:12px; color:#666; font-weight:bold;">주문자명</label>
        <input id="orderName" class="ai-input-pretty" readonly>
        
        <label style="font-size:12px; color:#666; font-weight:bold;">연락처</label>
        <input id="orderPhone" class="ai-input-pretty" readonly>
        
        <label style="font-size:12px; color:#666; font-weight:bold;">배송지</label>
        <input id="orderAddr" class="ai-input-pretty" readonly>
        
        <label style="font-size:12px; color:#666; font-weight:bold;">요청사항</label>
        <textarea id="orderMemo" class="ai-input-pretty" readonly></textarea>
        
        <button id="btnRealPayment" class="btn-round primary" style="margin-top:10px; height: 50px; font-size: 16px;">
            💳 카드 / 간편결제 (바로결제)
        </button>

        <div class="bank-transfer-container">
            <div class="bank-title">[계좌이체 안내]</div>
            <div class="bank-info">
                <span class="bank-name">국민은행</span>
                <span class="bank-num">647701-04-277763</span>
            </div>
            <div class="bank-owner">예금주: 카멜레온프린팅 주식회사</div>
            <div class="bank-note">
                * 입금자명과 주문자명이 동일하면 즉시 입금이 확인됩니다.
            </div>
            
            <button onclick="alert('입금 확인 요청이 접수되었습니다.\n에디터 화면으로 이동합니다.'); document.getElementById('checkoutModal').style.display='none';" class="btn-round btn-bank-confirm">
                ✅ 입금했어요 확인해주세요
            </button>
        </div>

        <button onclick="document.getElementById('checkoutModal').style.display='none'" class="btn-round" style="margin-top:10px; border:none; color:#888;">닫기</button>
    </div>
</div>

        <button onclick="document.getElementById('checkoutModal').style.display='none'" class="btn-round" style="margin-top:10px; border:none; color:#888;">닫기</button>
    </div>
</div>
</div>
<div id="successModal" class="modal-bg" style="z-index: 14000;"><div class="modal-box"><h2>🎉 주문 완료!</h2><button id="btnDownOrderSheet" class="btn-round">📄 작업지시서 다운로드</button><button id="btnDownQuotation" class="btn-round" style="margin-top:5px;">📑 견적서 다운로드</button><button onclick="window.closeSuccessModal()" class="btn-round primary" style="margin-top:15px;">확인</button></div></div>
<div id="sellModal" class="modal-bg" style="z-index: 10002;"><div class="modal-box"><h3>💎 디자인 등록</h3><input id="sellKw" class="ai-input-pretty" placeholder="#키워드"><button id="btnSellConfirm" class="btn-round primary">등록하기</button><button onclick="document.getElementById('sellModal').style.display='none'" class="btn-round" style="margin-top:5px;">취소</button></div></div>
<div id="fontModal" class="modal-bg" style="z-index: 10002;"><div class="modal-box"><h3>폰트 선택</h3><div id="fontList" style="max-height:300px; overflow-y:auto;"></div><button onclick="document.getElementById('fontModal').style.display='none'" class="btn-round" style="margin-top:10px;">닫기</button></div></div>
<div id="choiceModal" class="modal-bg" style="z-index: 15000;">
    <div class="modal-box" style="width: 900px; max-width: 95%;">
        
        <div class="choice-layout">
            <div class="choice-left">
                <h3 style="margin-top:0;">🎨 작업 방식을 선택해주세요</h3>
                <p style="color:#666; font-size:14px; margin-bottom:30px; line-height:1.5;">
                    선택하신 <span id="choiceProdName" style="color:#6366f1; font-weight:bold;">상품</span>으로 디자인을 시작하거나,<br>
                    이미 완성된 파일이 있다면 바로 주문할 수 있습니다.
                </p>

                <div style="display:flex; gap:15px; margin-bottom:20px;">
                    <button onclick="window.confirmChoice('editor')" class="btn-round primary" style="flex:1; height:120px; flex-direction:column; justify-content:center; gap:10px;">
                        <i class="fa-solid fa-palette" style="font-size:32px;"></i>
                        <span style="font-size:16px;">직접 디자인하기</span>
                        <span style="font-size:12px; font-weight:normal; opacity:0.8;">에디터에서 꾸미기</span>
                    </button>

                    <button onclick="window.confirmChoice('file')" class="btn-round" style="flex:1; height:120px; flex-direction:column; justify-content:center; gap:10px; background:#f1f5f9; color:#334155; border:1px solid #cbd5e1;">
                        <i class="fa-solid fa-cloud-arrow-up" style="font-size:32px;"></i>
                        <span style="font-size:16px;">내 파일로 주문</span>
                        <span style="font-size:12px; font-weight:normal; opacity:0.8;">PDF/이미지 파일 업로드</span>
                    </button>
                </div>

                <input type="file" id="directUploadInput" style="display:none;" accept="image/*,.pdf">
                
                <button onclick="document.getElementById('choiceModal').style.display='none'" class="btn-round" style="margin-top:auto;">닫기</button>
            </div>

            <div class="choice-right">
                <img id="choiceProductImg" src="" alt="상품 이미지">
            </div>
        </div>

    </div>
</div>
<div id="mobileControlDock">
    <button onclick="window.toggleMobilePanel('left')" class="mobile-fab left">
        <i class="fa-solid fa-shapes"></i>
        <span>요소추가</span>
    </button>

    <button onclick="window.toggleMobilePanel('right')" class="mobile-fab right">
        <i class="fa-solid fa-layer-group"></i>
        <span>편집/정렬</span>
    </button>
</div>
<div id="categoryDetailModal" class="modal-bg" style="z-index: 15000;">
    <div class="modal-box" style="width: 800px; max-width: 95%;">
        <h3 id="catModalTitle">📏 사이즈(제품)를 선택해주세요</h3>
        <p style="margin-bottom:20px; color:#666;">원하시는 규격을 선택하시면 디자인이 시작됩니다.</p>
        
        <div id="catProductGrid" class="quick-menu-track" style="grid-template-columns: repeat(4, 1fr);"></div>
        
        <button onclick="document.getElementById('categoryDetailModal').style.display='none'" class="btn-round" style="margin-top:20px;">닫기</button>
    </div>
</div>
<script type="module" src="./config.js"></script>
<script type="module" src="./canvas-core.js"></script>
<script type="module" src="./canvas-size.js"></script>
<script type="module" src="./canvas-guides.js"></script>
<script type="module" src="./canvas-zoom-pan.js"></script>
<script type="module" src="./canvas-objects.js"></script>
<script type="module" src="./canvas-image.js"></script>
<script type="module" src="./canvas-template.js"></script>
<script type="module" src="./canvas-ai.js"></script>
<script type="module" src="./canvas-utils.js"></script>
<script type="module" src="./shortcuts.js"></script>
<script type="module" src="./context-menu.js"></script>
<script type="module" src="./export.js"></script>
<script type="module" src="./order.js"></script>
<script type="module" src="./login.js"></script>
<script type="module" src="./my-design.js"></script>
<script type="module" src="./main.js"></script>

<script type="module">
    // setMaxLimits 추가됨
// setMaxLimits 추가됨
    import { canvas, setMaxLimits } from './canvas-core.js';
    import { openProductDetail, startDesignFromProduct } from './order.js';
    import { applySize } from './canvas-size.js';
    import { sb, PRODUCT_DB, cartData, currentUser } from './config.js';

    window.canvas = canvas;
    window.openProductDetail = openProductDetail;
    window.startDesignFromProduct = startDesignFromProduct;
    window.applySize = applySize;
    
    // 현재 선택된 제품 키 저장
    window.currentProductKey = 'A4';
    let selectedProductForChoice = null; // 선택된 상품 정보 저장용

    // ============================================================
    // [1] 아이콘 매핑
    // ============================================================
    const CATEGORY_ICONS = {
        'honeycomb': 'https://cdn-icons-png.flaticon.com/512/9425/9425781.png',
        'fabric': 'https://cdn-icons-png.flaticon.com/512/9069/9069036.png',
        'board': 'https://cdn-icons-png.flaticon.com/512/2665/2665873.png',
        'pet': 'https://cdn-icons-png.flaticon.com/512/2680/2680932.png',
        'default': 'https://cdn-icons-png.flaticon.com/512/3159/3159310.png'
    };

    // ============================================================
    // [2] 시작 화면: 카테고리 목록
    // ============================================================
    async function renderQuickMenu() {
        const container = document.getElementById('quickMenuContainer');
        if (!container) return;

        container.innerHTML = '<div style="grid-column:1/-1; text-align:center;">카테고리 로딩 중...</div>';
        
        const { data: categories, error } = await sb.from('admin_categories')
            .select('*')
            .order('sort_order', { ascending: true });

        container.innerHTML = '';

        if (!categories || categories.length === 0) {
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center;">등록된 카테고리가 없습니다.</div>';
            return;
        }

        categories.forEach(cat => {
            const n = cat.name; 
            let iconUrl = 'https://th.bing.com/th/id/OIP.Jj5QUnowN2oCX56cVuo45wHaHa?w=197&h=197&c=7&r=0&o=7&pid=1.7&rm=3'; 

            if (n.includes('허니콤') || n.includes('가벽') || n.includes('등신대') || n.includes('스카시') || n.includes('박스') || n.includes('판넬') || n.includes('테이블')) {
                iconUrl = 'https://search.pstatic.net/common/?src=https%3A%2F%2Fldb-phinf.pstatic.net%2F20241009_270%2F17284630974014y3f0_JPEG%2F1000190590.jpg&type=sc960_832'; 
            } 
            else if (n.includes('광목') || n.includes('쉬폰') || n.includes('린넨') || n.includes('캔버스') || n.includes('패브릭') || n.includes('텍') || n.includes('화이트') || n.includes('네츄럴') || n.includes('백아이')) {
                iconUrl = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQqWV5d7OPwqIbTMcek_s71sum2bh8Zh7CFGA&s'; 
            }
            else if (n.includes('매대') || n.includes('거치대') || n.includes('진열') || n.includes('다이') || n.includes('철제') || n.includes('스탠드')) {
                iconUrl = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT6MsafK1Bk4flaRnwnJ6yHsY_HHtS_rZ3lbA&s'; 
            }
            else if (n.includes('현수막') || n.includes('배너') || n.includes('리플렛') || n.includes('포맥스') || n.includes('폼보드') || n.includes('포스터') || n.includes('아크릴')) {
                iconUrl = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ-0q3W2v3GAdaDgS-5NpX3tfxYN_qTmh6cdA&s'; 
            }

            const div = document.createElement('div');
            div.className = 'quick-item';
            
            div.innerHTML = `
                <div class="quick-icon" style="background:#fff; border:1px solid #f1f5f9;">
                    <img src="${iconUrl}" style="width:45px; height:45px; object-fit:contain;">
                </div>
                <div class="quick-text">${cat.name}</div>
            `;
            
            div.onclick = () => showCategoryProducts(cat.code, cat.name);
            container.appendChild(div);
        });
    }

    // ============================================================
    // [3] 제품 선택 모달
    // ============================================================
    window.showCategoryProducts = async function(catKey, catName) {
        const grid = document.getElementById('catProductGrid');
        const modal = document.getElementById('categoryDetailModal');
        const titleEl = document.getElementById('catModalTitle');
        
        if(titleEl) titleEl.innerHTML = `<span style="color:#6366f1;">${catName}</span> 사이즈 선택`;
        
        grid.style.gridTemplateColumns = "repeat(4, 1fr)"; 
        grid.style.gap = "12px";

        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px;">로딩 중...</div>';
        modal.style.display = 'flex';

        const { data: products, error } = await sb.from('admin_products')
            .select('*')
            .eq('category', catKey)
            .order('sort_order', { ascending: true });

        grid.innerHTML = '';

        if (!products || products.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:#999;">등록된 상품이 없습니다.</div>';
            return;
        }

        products.forEach(p => {
            if (!window.PRODUCT_DB) window.PRODUCT_DB = {};
            window.PRODUCT_DB[p.code] = {
                name: p.name, w: p.width_mm, h: p.height_mm, price: p.price,
                img: p.img_url, addons: p.addons ? p.addons.split(',') : [], category: p.category
            };

            const div = document.createElement('div');
            div.className = 'quick-item'; 
            
            div.innerHTML = `
                <div class="quick-icon"><i class="fa-solid fa-cube"></i></div>
                <div class="quick-text">${p.name}</div>
                <div style="font-size:11px; color:#888; margin-top:3px;">
                    ${p.width_mm}x${p.height_mm} / ${p.price.toLocaleString()}원
                </div>
            `;

            div.onclick = () => {
                modal.style.display = 'none'; 
                window.currentProductKey = p.code;
                window.selectedProductForChoice = window.PRODUCT_DB[p.code];

                if(!p.code) return alert("상품 코드가 없습니다.");

                if(window.showChoiceModal) {
                    window.showChoiceModal(p.code);
                } else {
                    window.startEditorDirect(p.code);
                }
            };

            grid.appendChild(div);
        });
    };

    // ============================================================
    // [4] 작업 방식 선택 모달
    // ============================================================
    window.showChoiceModal = function(key) {
        window.currentProductKey = key;
        window.selectedProductForChoice = window.PRODUCT_DB[key];
        
        if (!window.selectedProductForChoice) return alert("상품 정보를 불러오는 중입니다. 다시 시도해주세요.");
        
        const nameEl = document.getElementById('choiceProdName');
        if(nameEl) nameEl.innerText = window.selectedProductForChoice.name;

        const imgEl = document.getElementById('choiceProductImg');
        if(imgEl) {
            imgEl.src = window.selectedProductForChoice.img || 'https://placehold.co/400?text=No+Image';
        }

        document.getElementById('choiceModal').style.display = 'flex';
    };

    window.confirmChoice = function(mode) {
        if (!window.selectedProductForChoice) return alert("상품 정보가 없습니다.");

        if (mode === 'editor') {
            document.getElementById('choiceModal').style.display = 'none';
            window.startEditorDirect(window.selectedProductForChoice.key || window.currentProductKey);
        } else {
            const input = document.getElementById('directUploadInput');
            if(input) input.click();
        }
    };

    // 파일 선택 시 장바구니 이동
    const directUploadInput = document.getElementById("directUploadInput");
    if (directUploadInput) {
        directUploadInput.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const product = window.selectedProductForChoice;
            if (!product) return alert("상품 정보가 없습니다.");

            const loading = document.getElementById("loading");
            if (loading) loading.style.display = "flex";

            const reader = new FileReader();
            reader.onload = function(evt) {
                const fileDataURI = evt.target.result;
                let thumbUrl = 'https://placehold.co/100?text=FILE';
                if (file.type.startsWith('image/')) {
                    thumbUrl = fileDataURI;
                }

                const newItem = {
                    uid: Date.now(),
                    product: product,
                    type: 'file',
                    fileName: file.name,
                    mimeType: file.type,
                    fileData: fileDataURI,
                    thumb: thumbUrl,
                    qty: 1,
                    selectedAddons: {},
                    isOpen: true
                };

                if (typeof cartData !== 'undefined') {
                    cartData.push(newItem);
                    try {
                        const user = typeof currentUser !== 'undefined' ? currentUser : null;
                        const storageKey = user ? `chameleon_cart_${user.id}` : 'chameleon_cart_guest';
                        localStorage.setItem(storageKey, JSON.stringify(cartData));
                    } catch(err) { console.error(err); }
                }

                if (window.renderCart) window.renderCart();
                document.getElementById('choiceModal').style.display = 'none';
                document.getElementById('cartPage').style.display = 'block';
                if (loading) loading.style.display = "none";
                directUploadInput.value = ''; 
            };
            reader.readAsDataURL(file);
        };
    }

    window.pendingTemplate = null; 

    window.startEditorDirect = async function(key) {
        if (!key) return alert("상품 코드가 올바르지 않습니다.");

        window.currentProductKey = key;
        if(canvas) canvas.currentProductKey = key;
        
        const product = window.PRODUCT_DB ? window.PRODUCT_DB[key] : null;

        const displayW = product ? (product.w_mm || product.width_mm || product.w || 210) : 210;
        const displayH = product ? (product.h_mm || product.height_mm || product.h || 297) : 297;
        const canvasW = product ? (product.w || 210) : 210;
        const canvasH = product ? (product.h || 297) : 297;
        const mode = (typeof key === 'string' && key.includes('Wall')) ? 'wall' : 'standard';

        if (typeof setMaxLimits === 'function') {
            setMaxLimits(displayW, displayH);
        }
        
        const limitLabel = document.getElementById("limitLabel");
        if(limitLabel) limitLabel.innerText = `Max: ${displayW}x${displayH}`;
        
        const inpW = document.getElementById("inputUserW");
        const inpH = document.getElementById("inputUserH");
        if(inpW) inpW.value = displayW;
        if(inpH) inpH.value = displayH;

        if (window.applySize) {
            window.applySize(canvasW, canvasH, key, mode, 'replace');
        }
        
        document.getElementById("startScreen").style.display = "none";
        document.getElementById("mainEditor").style.display = "flex";
        window.dispatchEvent(new Event('resize'));

        if (window.pendingTemplate) {
            setTimeout(async () => {
                if (typeof applyTemplateDirectly === 'function') {
                    await applyTemplateDirectly(window.pendingTemplate);
                }
                window.pendingTemplate = null; 
            }, 300);
        }
    };

    window.onTemplateClick = async function(tpl) {
        const startScreen = document.getElementById('startScreen');
        const isEditorOpen = startScreen && window.getComputedStyle(startScreen).display === 'none';

        if (isEditorOpen) {
            if(!confirm("현재 캔버스에 템플릿을 적용하시겠습니까?\n(기존 디자인 위에 추가됩니다)")) return;
            await applyTemplateDirectly(tpl);
        } else {
            window.pendingTemplate = tpl; 
            showCategorySelectionModal(); 
        }
    };

    async function showCategorySelectionModal() {
        const modal = document.getElementById('categoryDetailModal');
        const grid = document.getElementById('catProductGrid');
        const titleEl = document.getElementById('catModalTitle');
        
        if(titleEl) titleEl.innerHTML = `<span style="color:#6366f1;">Q. 무엇을 만들까요?</span> <span style="font-size:14px; color:#888; font-weight:normal;">(사이즈 선택)</span>`;
        
        modal.style.display = 'flex';
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">불러오는 중...</div>';
        
        const { data: categories, error } = await sb.from('admin_categories')
            .select('*').order('sort_order', { ascending: true });

        if (!categories || categories.length === 0) return;

        grid.innerHTML = '';
        
        categories.forEach(cat => {
            let iconUrl = 'https://cdn-icons-png.flaticon.com/512/3159/3159310.png';
            const n = cat.name;
            if (n.includes('허니콤') || n.includes('등신대')) iconUrl = 'data:image/png;base64,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'; 
            else if (n.includes('패브릭') || n.includes('광목')) iconUrl = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQqWV5d7OPwqIbTMcek_s71sum2bh8Zh7CFGA&s';
            else if (n.includes('매대') || n.includes('거치대')) iconUrl = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT6MsafK1Bk4flaRnwnJ6yHsY_HHtS_rZ3lbA&s';
            else if (n.includes('배너') || n.includes('현수막')) iconUrl = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ-0q3W2v3GAdaDgS-5NpX3tfxYN_qTmh6cdA&s';

            const div = document.createElement('div');
            div.className = 'quick-item';
            div.innerHTML = `
                <div class="quick-icon" style="background:#fff; border:1px solid #f1f5f9;">
                    <img src="${iconUrl}" style="width:45px; height:45px; object-fit:contain;">
                </div>
                <div class="quick-text">${cat.name}</div>
            `;
            
            div.onclick = () => window.showCategoryProducts(cat.code, cat.name);
            grid.appendChild(div);
        });
    }

    async function applyTemplateDirectly(tpl) {
        document.getElementById("loading").style.display = "flex";
        document.getElementById('templateOverlay').style.display = 'none';
        try {
            const { data: doc, error } = await sb.from('library').select('data_url').eq('id', tpl.id).single();
            if (error || !doc) return alert("데이터 로드 실패");
            await window.applyTemplateToCanvas(doc.data_url);
        } catch (e) {
            console.error(e);
        } finally {
            document.getElementById("loading").style.display = "none";
        }
    }

    window.applyTemplateToCanvas = async function(inputData) {
        if (!canvas) return;
        document.getElementById("loading").style.display = "flex";
        try {
            let jsonData = inputData;
            if (typeof inputData === 'string') {
                if (inputData.startsWith('http')) {
                    const res = await fetch(inputData);
                    jsonData = await res.json();
                } else if (inputData.trim().startsWith('{')) {
                    jsonData = JSON.parse(inputData);
                }
            }

            let board = canvas.getObjects().find(o => o.isBoard);
            let boardSize = board ? { w: board.width * board.scaleX, h: board.height * board.scaleY } : { w: canvas.width, h: canvas.height };
            let center = board ? { x: board.left + boardSize.w/2, y: board.top + boardSize.h/2 } : { x: canvas.width/2, y: canvas.height/2 };

            const onLoad = (objects, options) => {
                if(!objects || objects.length===0) return finishLoading();
                objects.forEach(o => { 
                    o.set({ selectable: true, evented: true, lockMovementX: false, lockMovementY: false });
                    if(o.type==='i-text'||o.type==='text') delete o.textBaseline; 
                });
                let group;
                if(options) group = fabric.util.groupSVGElements(objects, options);
                else group = new fabric.Group(objects);
                group.set({ originX: 'center', originY: 'center' });

                const scaleX = boardSize.w / group.width;
                const scaleY = boardSize.h / group.height;
                const scale = Math.max(scaleX, scaleY);

                group.set({ scaleX: scale, scaleY: scale, left: center.x, top: center.y });
                canvas.add(group);
                group.toActiveSelection();
                canvas.requestRenderAll();
                finishLoading();
            };

            if (typeof jsonData === 'string' && (jsonData.includes('<svg') || jsonData.includes('data:image/svg'))) {
                fabric.loadSVGFromString(jsonData, onLoad);
            } else if (typeof jsonData === 'object' && jsonData.objects) {
                const objs = jsonData.objects.filter(o => !o.isBoard);
                fabric.util.enlivenObjects(objs, (enlivened) => onLoad(enlivened, null));
            } else {
                fabric.Image.fromURL(inputData, (img) => {
                    if(img) onLoad([img], null); else finishLoading();
                });
            }
        } catch(e) { console.error(e); finishLoading(); }
    };

    function finishLoading() {
        document.getElementById("loading").style.display = "none";
        document.getElementById('templateOverlay').style.display = 'none';
    }

    // ============================================================
    // [수정] 메인 로드 이벤트 & 템플릿 로드 함수
    // ============================================================
    window.addEventListener('load', async () => {
        await new Promise(r => setTimeout(r, 500));
        renderQuickMenu();
        loadTemplates('startTemplateGrid', false); // 초기 로드
        window.preloadKoreanFont();

        // [추가] 검색 버튼 및 엔터키 이벤트 연결
        const searchBtn = document.getElementById('btnStartSearch');
        const searchInput = document.getElementById('startSearchInput');

        if (searchBtn && searchInput) {
            const doSearch = () => {
                loadTemplates('startTemplateGrid', false, searchInput.value);
            };

            searchBtn.onclick = doSearch;
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') doSearch();
            });
        }
    });

    // [수정] 템플릿 로드 (검색어 처리 + 50개 로드)
    async function loadTemplates(containerId, isModal = false, keyword = null) {
        const grid = document.getElementById(containerId);
        if (!grid) return;
        
        grid.innerHTML = '<div style="text-align:center; padding:20px; grid-column:1/-1;">Loading...</div>';
        
        if (!sb) await new Promise(r => setTimeout(r, 500)); 

        // 쿼리 작성 (50개 제한)
        let query = sb.from('library')
            .select('id, thumb_url, category, tags')
            .order('created_at', { ascending: false })
            .limit(49);

        // 검색어가 있으면 태그 필터링 (ilike)
        if (keyword && keyword.trim() !== '') {
            query = query.ilike('tags', `%${keyword.trim()}%`);
        }

        const { data, error } = await query;

        grid.innerHTML = '';

        if (!data || data.length === 0) { 
            grid.innerHTML = '<div style="text-align:center; padding:20px; color:#888; grid-column:1/-1;">검색 결과가 없습니다.</div>'; 
            return; 
        }
        
        data.forEach(tpl => {
            const card = document.createElement('div');
            card.className = isModal ? 'tpl-item' : 'tpl-card-start';
            let imgSrc = tpl.thumb_url || 'https://via.placeholder.com/300';
            
            card.innerHTML = isModal 
                ? `<img src="${imgSrc}" class="tpl-item-img">` 
                : `<img src="${imgSrc}" class="tpl-card-img"><div class="tpl-card-overlay"></div>`;
            
            card.onclick = () => { if(window.onTemplateClick) window.onTemplateClick(tpl); };
            grid.appendChild(card);
        });
    }

    // 기타 유틸
    window.toggleLockSelection = function() { if(!canvas)return; const a=canvas.getActiveObject(); if(!a)return alert("선택필요"); const l=!a.lockMovementX; a.set({lockMovementX:l,lockMovementY:l,lockRotation:l,lockScalingX:l,lockScalingY:l,hasControls:!l,selectable:true}); canvas.discardActiveObject(); canvas.requestRenderAll(); };
    window.setAsBackground = function() { if(!canvas)return; const a=canvas.getActiveObject(); if(!a)return alert("선택필요"); const b=canvas.getObjects().find(o=>o.isBoard); if(!b)return; const s=Math.max((b.width*b.scaleX)/a.width,(b.height*b.scaleY)/a.height); a.set({scaleX:s,scaleY:s,left:b.left+(b.width*b.scaleX)/2,top:b.top+(b.height*b.scaleY)/2,originX:'center',originY:'center',angle:0}); canvas.sendToBack(a); canvas.sendToBack(b); canvas.requestRenderAll(); };
    window.alignObject = function(d) { if(!canvas)return; const a=canvas.getActiveObject(); if(!a)return; const b=canvas.getObjects().find(o=>o.isBoard); const r=b?b.getBoundingRect():{left:0,top:0,width:canvas.width,height:canvas.height}; const w=a.getScaledWidth(); const h=a.getScaledHeight(); if(d=='left') a.left=r.left+w/2; if(d=='centerH') a.left=r.left+r.width/2; if(d=='right') a.left=r.left+r.width-w/2; if(d=='top') a.top=r.top+h/2; if(d=='centerV') a.top=r.top+r.height/2; if(d=='bottom') a.top=r.top+r.height-h/2; if(d=='center') { a.left=r.left+r.width/2; a.top=r.top+r.height/2; } a.setCoords(); canvas.requestRenderAll(); };

    if (window.pdfjsLib) window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    window.koreanFontCache = null;
    window.preloadKoreanFont = async function() { try { const r = await fetch('https://cdn.jsdelivr.net/gh/google/fonts@main/ofl/nanumgothic/NanumGothic-Regular.ttf'); if(r.ok) { const b = await r.blob(); const rd = new FileReader(); rd.onloadend = function() { window.koreanFontCache = rd.result.split(',')[1]; }; rd.readAsDataURL(b); } } catch(e) {} };
    window.loadKoreanFontForPDF = async function(doc) { if(window.koreanFontCache) { try { doc.addFileToVFS('NanumGothic.ttf', window.koreanFontCache); doc.addFont('NanumGothic.ttf', 'NanumGothic', 'normal'); doc.addFont('NanumGothic.ttf', 'NanumGothic', 'bold'); doc.setFont('NanumGothic'); } catch(e) {} } };    
</script>
<script>
    document.addEventListener('click', function(e) {
        const card = e.target.closest('.size-card');
        if (card) {
            const onclickCode = card.getAttribute('onclick');
            if (onclickCode) {
                try { eval(onclickCode); } catch(err) { console.error("판형 클릭 오류:", err); }
            }
        }
    });
    
    window.closeSuccessModal = function() {
        const modal = document.getElementById('successModal');
        if (modal) {
            modal.style.display = 'none';
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const confirmBtn = document.querySelector('#successModal .btn-round.primary');
        if(confirmBtn) {
            confirmBtn.onclick = window.closeSuccessModal;
        }
    });
    
    // 입력창 오류 해결
    window.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            if (e.code === 'Space' || e.key === ' ') {
                e.stopPropagation(); 
            }
        }
    }, true);
</script>
<script src="https://js.tosspayments.com/v1"></script>
<button id="btnPayTest" style="display:none; position:fixed; bottom:20px; right:20px; z-index:999999;">결제테스트</button>
<script>
  (function(){var w=window;if(w.ChannelIO){return w.console.error("ChannelIO script included twice.");}var ch=function(){ch.c(arguments);};ch.q=[];ch.c=function(args){ch.q.push(args);};w.ChannelIO=ch;function l(){if(w.ChannelIOInitialized){return;}w.ChannelIOInitialized=true;var s=document.createElement("script");s.type="text/javascript";s.async=true;s.src="https://cdn.channel.io/plugin/ch-plugin-web.js";var x=document.getElementsByTagName("script")[0];if(x.parentNode){x.parentNode.insertBefore(s,x);}}if(document.readyState==="complete"){l();}else{w.addEventListener("DOMContentLoaded",l);w.addEventListener("load",l);}})();
  ChannelIO('boot', { "pluginKey": "752ba9ff-a447-4e10-9813-715e051995cd" });
</script>
<script>
window.addToCartAndGo = async function() {
    // 1. 캔버스 확인
    if (!canvas) return alert("오류: 캔버스가 로드되지 않았습니다.");
    
    // 로딩 표시
    const loading = document.getElementById("loading");
    if(loading) loading.style.display = "flex";

    try {
        // 2. 현재 디자인 썸네일 & 데이터 생성
        // 배경(보드)만 따로 찾아서 그 크기만큼만 이미지를 뜹니다.
        const board = canvas.getObjects().find(o => o.isBoard);
        let thumbUrl = "";
        
        // 썸네일 생성 (화면 캡쳐)
        if (board) {
            // 잠시 뷰포트 초기화해서 정확히 캡쳐
            const vpt = canvas.viewportTransform;
            canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
            thumbUrl = canvas.toDataURL({
                format: 'png',
                multiplier: 0.5, // 용량 최적화를 위해 반으로 축소
                quality: 0.8,
                left: board.left,
                top: board.top,
                width: board.width * board.scaleX,
                height: board.height * board.scaleY
            });
            // 뷰포트 원상복구
            canvas.setViewportTransform(vpt);
        } else {
            thumbUrl = canvas.toDataURL({ format: 'png', multiplier: 0.5 });
        }

        // 3. 장바구니 아이템 만들기
        const currentProduct = window.PRODUCT_DB ? window.PRODUCT_DB[window.currentProductKey] : null;
        
        const newItem = {
            uid: Date.now(), // 고유 ID
            productName: currentProduct ? currentProduct.name : '나만의 디자인',
            type: 'design', // 유형: 디자인
            price: currentProduct ? currentProduct.price : 0, // 가격
            qty: 1,
            thumb: thumbUrl, // 방금 캡쳐한 이미지
            // ★ 핵심: 현재 캔버스 상태를 통째로 저장 (나중에 불러오기 가능)
            designData: JSON.stringify(canvas.toJSON(['id', 'isBoard', 'selectable', 'evented'])), 
            options: {} 
        };

        // 4. 전역 장바구니 배열에 추가
        if (typeof cartData !== 'undefined') {
            cartData.push(newItem);
            // 로컬 스토리지 저장 (새로고침 해도 유지되게)
            localStorage.setItem("chameleon_cart", JSON.stringify(cartData));
        }

        // 5. 장바구니 화면 열기
        if (window.renderCart) window.renderCart(); // 목록 새로고침
        document.getElementById('cartPage').style.display = 'block';
        
        // (선택) 알림 메시지
        // alert("현재 디자인이 장바구니에 담겼습니다.");

    } catch (e) {
        console.error(e);
        alert("장바구니 담기 중 오류가 발생했습니다: " + e.message);
    } finally {
        if(loading) loading.style.display = "none";
    }
};
</script>
</body>
</html>