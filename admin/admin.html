<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chameleon í†µí•© ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

    <style>
        /* [í†µí•© ìŠ¤íƒ€ì¼] */
        body { margin: 0; display: flex; height: 100vh; font-family: 'Pretendard', sans-serif; background: #f1f5f9; color: #334155; overflow: hidden; }
        
        /* 1. ì‚¬ì´ë“œë°” */
        .sidebar { width: 260px; background: #1e293b; color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; }
        .sidebar-header { padding: 25px 20px; font-weight: 800; font-size: 22px; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 10px; color: #818cf8; }
        .nav-menu { list-style: none; padding: 20px 10px; margin: 0; display: flex; flex-direction: column; gap: 5px; }
        .nav-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 15px; color: #cbd5e1; }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: #6366f1; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .nav-label { font-size: 11px; color: #64748b; padding: 0 15px; margin-top: 15px; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; }

        /* 2. ë©”ì¸ ì»¨í…ì¸  */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 60px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .page-title { font-size: 18px; font-weight: 700; color: #0f172a; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 30px; }

        /* ì„¹ì…˜ ê³µí†µ */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ì¹´ë“œ & UI ìš”ì†Œ */
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .input-text { padding: 10px 15px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; font-size: 14px; box-sizing: border-box; }
        
        /* í…Œì´ë¸” */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-weight: 600; font-size: 13px; border-bottom: 1px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #334155; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }
        
        /* ë²„íŠ¼ & ë°°ì§€ */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-danger { background: #fee2e2; color: #ef4444; }
        .btn-outline { background: #fff; border: 1px solid #cbd5e1; color: #334155; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .badge.admin { background: #dbeafe; color: #1e40af; }
        .badge.customer { background: #f1f5f9; color: #475569; }

        /* í…œí”Œë¦¿ ê´€ë¦¬ ì „ìš© ìŠ¤íƒ€ì¼ */
        .tpl-layout { display: flex; gap: 20px; align-items: flex-start; }
        .tpl-form { width: 320px; flex-shrink: 0; position: sticky; top: 0; }
        .tpl-grid-area { flex: 1; }
        
        .file-drop-zone { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; position: relative; background: #f8fafc; color: #64748b; margin-bottom: 10px; }
        .file-drop-zone:hover { border-color: #6366f1; background: #eff6ff; color: #6366f1; }
        .file-drop-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .preview-img { max-width: 100%; height: 150px; object-fit: contain; border-radius: 8px; border: 1px solid #eee; display: none; margin-top: 10px; background: white; }
        
        .tpl-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .tpl-card { background: white; border: 1px solid #e2e8f0; border-radius: 10px; overflow: hidden; transition: 0.2s; position: relative; }
        .tpl-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: #6366f1; }
        .tpl-thumb { width: 100%; aspect-ratio: 1/1; object-fit: contain; background: #f8fafc; border-bottom: 1px solid #f1f5f9; }
        .tpl-info { padding: 10px; }
        .tpl-badge { font-size: 10px; background: #e0e7ff; color: #4338ca; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 4px; }
        .tpl-del-btn { width: 100%; margin-top: 5px; background: #fee2e2; color: #ef4444; font-size: 11px; padding: 5px; }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header"><i class="fa-solid fa-layer-group"></i> Chameleon</div>
        
        <ul class="nav-menu">
            <div class="nav-label">Order Management</div>
            <li class="nav-item active" onclick="showSection('sec-orders', this)">
                <i class="fa-solid fa-truck-fast"></i> í†µí•© ì£¼ë¬¸ ê´€ë¦¬
            </li>
            
            <div class="nav-label">Customer Relation</div>
            <li class="nav-item" onclick="showSection('sec-members', this)">
                <i class="fa-solid fa-users"></i> íšŒì› ê´€ë¦¬ (CRM)
            </li>

            <div class="nav-label">Design Assets</div>
            <li class="nav-item" onclick="showSection('sec-templates', this)">
                <i class="fa-solid fa-palette"></i> í…œí”Œë¦¿ ë¼ì´ë¸ŒëŸ¬ë¦¬
            </li>
            
            <div class="nav-label">Settings</div>
            <li class="nav-item" onclick="showSection('sec-products', this)">
                <i class="fa-solid fa-tags"></i> ìƒí’ˆ ê´€ë¦¬ (ì¤€ë¹„ì¤‘)
            </li>
            <li class="nav-item" onclick="showSection('sec-wizard', this)">
                <i class="fa-solid fa-sitemap"></i> ìœ„ìë“œ ì„¤ì • (ì¤€ë¹„ì¤‘)
            </li>
        </ul>

        <div style="margin-top: auto; padding: 20px;">
            <button class="btn btn-danger" style="width: 100%;" onclick="logout()">
                <i class="fa-solid fa-right-from-bracket"></i> ë¡œê·¸ì•„ì›ƒ
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="page-title" id="pageTitle">í†µí•© ì£¼ë¬¸ ê´€ë¦¬</div>
            <div style="font-size: 14px; color: #64748b;">ê´€ë¦¬ìë‹˜, í™˜ì˜í•©ë‹ˆë‹¤ ğŸ‘‹</div>
        </div>

        <div class="content-scroll">
            
            <div id="sec-orders" class="section active">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div class="search-box" style="margin-bottom:0;">
                        <button class="btn btn-primary" onclick="filterOrders('ì ‘ìˆ˜ë¨', this)">ğŸ“¥ ì‹ ê·œ ì ‘ìˆ˜</button>
                        <button class="btn btn-outline" onclick="filterOrders('ì¹¼ì„ ì‘ì—…', this)">âœ‚ï¸ ì¹¼ì„ /ì‹œì•ˆ ì‘ì—…</button>
                        <button class="btn btn-outline" onclick="filterOrders('ë°°ì†¡ì¤€ë¹„', this)">ğŸ“¦ ë°°ì†¡ ì¤€ë¹„</button>
                        <button class="btn btn-outline" onclick="filterOrders('ë°°ì†¡ì¤‘', this)">ğŸšš ë°°ì†¡ ì¤‘</button>
                        <button class="btn btn-outline" onclick="filterOrders('ì™„ë£Œë¨', this)">âœ… ì™„ë£Œ</button>
                    </div>
                    <button class="btn btn-primary" onclick="loadOrders()"><i class="fa-solid fa-rotate"></i> ìƒˆë¡œê³ ì¹¨</button>
                </div>
                <div class="card" style="padding:0; overflow:hidden;">
                    <table style="margin:0;">
                        <thead>
                            <tr>
                                <th style="width:100px;">ë‚ ì§œ</th>
                                <th style="width:120px;">ê³ ê°ëª…</th>
                                <th>ì£¼ë¬¸ ë‚´ì—­ / ìš”ì²­ì‚¬í•­</th>
                                <th style="width:100px;">ìƒíƒœ</th>
                                <th style="width:200px; text-align:right;">ê´€ë¦¬ ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody id="orderListBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="sec-members" class="section">
                <div class="card">
                    <div class="search-box">
                        <input type="text" id="memberSearch" class="input-text" style="width:300px;" placeholder="ì´ë¦„, ì´ë©”ì¼ ê²€ìƒ‰..." onkeyup="filterMembers()">
                        <button class="btn btn-primary" onclick="loadMembers()"><i class="fa-solid fa-rotate"></i> ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ê°€ì…ì¼</th><th>ê³ ê°ëª…</th><th>ì´ë©”ì¼</th><th>ì „í™”ë²ˆí˜¸</th><th>ë“±ê¸‰</th><th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="memberListBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="sec-templates" class="section">
                <div class="tpl-layout">
                    <div class="card tpl-form">
                        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“¤ í…œí”Œë¦¿ ë“±ë¡</h3>
                        
                        <div class="form-group">
                            <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                            <select id="tplCategory" class="input-text" onchange="toggleFileInputs()">
                                <option value="vector">ë²¡í„° ë°°ê²½ (ì¼ëŸ¬ìŠ¤íŠ¸)</option>
                                <option value="photo-bg">ì‚¬ì§„ ë°°ê²½ (ì´ë¯¸ì§€)</option>
                                <option value="graphic">ê·¸ë˜í”½ ê°ì²´ (ì•„ì´ì½˜ ë“±)</option>
                                <option value="transparent-graphic">íˆ¬ëª… ëˆ„ë¼ ì´ë¯¸ì§€</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)</label>
                            <input id="tplTags" class="input-text" placeholder="ì˜ˆ: ì—¬ë¦„, ì„¸ì¼, ê½ƒ">
                        </div>

                        <div class="form-group">
                            <label class="form-label" id="lblThumb">1. ì¸ë„¤ì¼ ì´ë¯¸ì§€</label>
                            <div class="file-drop-zone">
                                <span><i class="fa-regular fa-image"></i> í´ë¦­í•˜ì—¬ ì„ íƒ</span>
                                <input type="file" id="fileThumb" accept="image/*">
                            </div>
                            <img id="previewThumb" class="preview-img">
                        </div>

                        <div class="form-group" id="groupDataFile">
                            <label class="form-label">2. ë°ì´í„° íŒŒì¼ (SVG/JSON)</label>
                            <div class="file-drop-zone">
                                <span><i class="fa-solid fa-bezier-curve"></i> í´ë¦­í•˜ì—¬ ì„ íƒ</span>
                                <input type="file" id="fileData" accept=".svg,.json">
                            </div>
                            <div id="dataStatus" style="font-size:12px; color:green; display:none;">íŒŒì¼ ë¡œë“œë¨</div>
                            <p style="font-size:11px; color:#999; margin-top:5px;">ì¼ëŸ¬ìŠ¤íŠ¸ ë²¡í„° íŒŒì¼ì„ ë“±ë¡í•˜ì„¸ìš”.</p>
                        </div>

                        <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="uploadTemplate()">DBì— ë“±ë¡í•˜ê¸°</button>
                    </div>

                    <div class="tpl-grid-area">
                        <div class="card" style="margin-bottom:20px; padding:15px; display:flex; justify-content:space-between;">
                            <div style="display:flex; gap:10px; align-items:center;">
                                <span style="font-weight:bold;">í•„í„°:</span>
                                <select id="filterTplCat" class="input-text" style="width:150px;" onchange="loadTemplates()">
                                    <option value="all">ì „ì²´ ë³´ê¸°</option>
                                    <option value="vector">ë²¡í„° ë°°ê²½</option>
                                    <option value="photo-bg">ì‚¬ì§„ ë°°ê²½</option>
                                    <option value="graphic">ê·¸ë˜í”½ ê°ì²´</option>
                                    <option value="transparent-graphic">íˆ¬ëª… ì´ë¯¸ì§€</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="loadTemplates()"><i class="fa-solid fa-rotate"></i> ìƒˆë¡œê³ ì¹¨</button>
                        </div>

                        <div id="tplGrid" class="tpl-card-grid">
                            </div>
                    </div>
                </div>
            </div>

            <div id="sec-products" class="section"><div class="card"><h3>ìƒí’ˆ ê´€ë¦¬ ì¤€ë¹„ì¤‘...</h3></div></div>
            <div id="sec-wizard" class="section"><div class="card"><h3>ìœ„ìë“œ ì„¤ì • ì¤€ë¹„ì¤‘...</h3></div></div>

        </div>
    </div>

    <div id="modalKnife" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
        <div class="card" style="width:400px;">
            <h3>âœ‚ï¸ ì¹¼ì„ /ì‹œì•ˆ íŒŒì¼ ì—…ë¡œë“œ</h3>
            <input type="hidden" id="knifeOrderId">
            <input type="file" id="knifeFile" class="input-text" style="width:100%; margin:15px 0;">
            <div style="text-align:right;"><button class="btn btn-danger" onclick="closeModal('modalKnife')">ì·¨ì†Œ</button> <button class="btn btn-primary" onclick="submitKnifeFile()">ì—…ë¡œë“œ</button></div>
        </div>
    </div>
    <div id="modalShipping" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
        <div class="card" style="width:400px;">
            <h3>ğŸšš ë°°ì†¡ ì •ë³´ ì…ë ¥</h3>
            <input type="hidden" id="shipOrderId">
            <div style="margin:10px 0;"><label>íƒë°°ì‚¬</label><select id="shipCarrier" class="input-text"><option>CJëŒ€í•œí†µìš´</option><option>ìš°ì²´êµ­íƒë°°</option><option>ë¡œì  íƒë°°</option></select></div>
            <div style="margin-bottom:20px;"><label>ì†¡ì¥ë²ˆí˜¸</label><input id="shipTracking" class="input-text" placeholder="ìˆ«ìë§Œ"></div>
            <div style="text-align:right;"><button class="btn btn-danger" onclick="closeModal('modalShipping')">ì·¨ì†Œ</button> <button class="btn btn-primary" onclick="submitShipping()">ë°œì†¡</button></div>
        </div>
    </div>

    <script type="module">
        import { sb, initConfig } from "./config.js";

        // ===========================================
        // 1. ê³µí†µ ë° ë„¤ë¹„ê²Œì´ì…˜
        // ===========================================
        window.showSection = (secId, navEl) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(secId);
            if(target) target.classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(navEl) navEl.classList.add('active');

            const titleMap = {
                'sec-orders': 'ğŸ“¦ í†µí•© ì£¼ë¬¸ ê´€ë¦¬', 'sec-members': 'ğŸ‘¥ íšŒì› ê´€ë¦¬ (CRM)',
                'sec-templates': 'ğŸ¨ í…œí”Œë¦¿ ë¼ì´ë¸ŒëŸ¬ë¦¬', 'sec-products': 'ğŸ·ï¸ ìƒí’ˆ ê´€ë¦¬', 'sec-wizard': 'ğŸ§  ìœ„ìë“œ ì„¤ì •'
            };
            document.getElementById('pageTitle').innerText = titleMap[secId] || 'ê´€ë¦¬ì';

            if(secId === 'sec-members') loadMembers();
            if(secId === 'sec-orders') loadOrders();
            if(secId === 'sec-templates') loadTemplates();
        };

        window.logout = async () => {
            if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await sb.auth.signOut(); location.href = "index.html"; }
        };

        window.addEventListener('DOMContentLoaded', async () => {
            await initConfig();
            loadOrders(); 
            initTemplateListeners(); // í…œí”Œë¦¿ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
        });

        // ===========================================
        // 2. í†µí•© ì£¼ë¬¸ ê´€ë¦¬
        // ===========================================
        let currentOrderStatus = 'ì ‘ìˆ˜ë¨';
        window.filterOrders = (status, btn) => {
            currentOrderStatus = status;
            document.querySelectorAll('#sec-orders .btn').forEach(b => {
                b.classList.remove('btn-primary');
                if(!b.classList.contains('btn-danger')) b.classList.add('btn-outline');
                b.style.background = '#fff'; b.style.color = '#334155';
            });
            if(btn) {
                btn.classList.remove('btn-outline'); btn.classList.add('btn-primary');
                btn.style.background = ''; btn.style.color = '';
            }
            loadOrders();
        };

        window.loadOrders = async () => {
            const tbody = document.getElementById('orderListBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">ë¡œë”© ì¤‘...</td></tr>';
            
            let query = sb.from('admin_orders_view').select('*').eq('status', currentOrderStatus).order('created_at', {ascending:false});
            let { data, error } = await query;
            
            if(error && error.code === '42P01') {
                const res = await sb.from('orders').select('*').eq('status', currentOrderStatus).order('created_at', {ascending:false});
                data = res.data; error = res.error;
            }
            if(error) return tbody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">${error.message}</td></tr>`;
            
            tbody.innerHTML = '';
            if(!data || data.length === 0) return tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px; color:#999;">ë°ì´í„° ì—†ìŒ</td></tr>';

            data.forEach(order => {
                const date = new Date(order.created_at).toLocaleDateString();
                const name = order.user_name || order.manager_name || 'ë¹„íšŒì›';
                let files = order.files && order.files.length > 0 ? `<div style="font-size:12px; color:#6366f1;">ğŸ“‚ íŒŒì¼ ${order.files.length}ê°œ</div>` : '';
                
                let btn = '';
                if(currentOrderStatus==='ì ‘ìˆ˜ë¨') btn = `<button class="btn btn-primary btn-sm" onclick="updateOrder(${order.id}, 'ì¹¼ì„ ì‘ì—…')">âœ‚ï¸ ì‘ì—… ì‹œì‘</button>`;
                else if(currentOrderStatus==='ì¹¼ì„ ì‘ì—…') btn = `<button class="btn btn-primary btn-sm" onclick="openKnifeModal(${order.id})">ğŸ“¤ ì—…ë¡œë“œ</button>`;
                else if(currentOrderStatus==='ë°°ì†¡ì¤€ë¹„') btn = `<button class="btn btn-primary btn-sm" onclick="openShippingModal(${order.id})">ğŸšš ë°œì†¡</button>`;
                else if(currentOrderStatus==='ë°°ì†¡ì¤‘') btn = `<button class="btn btn-primary btn-sm" onclick="updateOrder(${order.id}, 'ì™„ë£Œë¨')">âœ… ì™„ë£Œ</button>`;
                else btn = '<span class="badge customer">ì™„ë£Œ</span>';

                tbody.innerHTML += `<tr><td>${date}</td><td><b>${name}</b><br><span style="font-size:12px;">${order.phone||''}</span></td><td><b>${order.address||''}</b><br><span style="font-size:12px;">${order.request_note||''}</span>${files}</td><td><span class="badge admin">${order.status}</span></td><td style="text-align:right;">${btn}</td></tr>`;
            });
        };

        window.updateOrder = async (id, status) => {
            if(!confirm(`ìƒíƒœë¥¼ [${status}]ë¡œ ë³€ê²½í•©ë‹ˆê¹Œ?`)) return;
            await sb.from('orders').update({status}).eq('id', id); loadOrders();
        };

        // ëª¨ë‹¬ ë¡œì§
        window.closeModal = (id) => document.getElementById(id).style.display='none';
        window.openKnifeModal = (id) => { document.getElementById('knifeOrderId').value=id; document.getElementById('knifeFile').value=''; document.getElementById('modalKnife').style.display='flex'; };
        window.openShippingModal = (id) => { document.getElementById('shipOrderId').value=id; document.getElementById('shipTracking').value=''; document.getElementById('modalShipping').style.display='flex'; };
        
        window.submitKnifeFile = async () => {
            const id = document.getElementById('knifeOrderId').value;
            const file = document.getElementById('knifeFile').files[0];
            if(!file) return alert("íŒŒì¼ì„ íƒí•„ìš”");
            const btn = event.target; btn.innerText="ì—…ë¡œë“œì¤‘..."; btn.disabled=true;
            try {
                const name = `${id}_knife_${Date.now()}.${file.name.split('.').pop()}`;
                const {error} = await sb.storage.from('admin_uploads').upload(name, file);
                if(error) throw error;
                const {data} = sb.storage.from('admin_uploads').getPublicUrl(name);
                await sb.from('orders').update({knife_file_url:data.publicUrl, status:'ë°°ì†¡ì¤€ë¹„'}).eq('id', id);
                alert("ì™„ë£Œ"); closeModal('modalKnife'); loadOrders();
            } catch(e) { alert(e.message); } finally { btn.innerText="ì—…ë¡œë“œ"; btn.disabled=false; }
        };

        window.submitShipping = async () => {
            const id = document.getElementById('shipOrderId').value;
            const trk = document.getElementById('shipTracking').value;
            if(!trk) return alert("ì†¡ì¥ë²ˆí˜¸í•„ìš”");
            await sb.from('orders').update({tracking_number:trk, carrier:document.getElementById('shipCarrier').value, status:'ë°°ì†¡ì¤‘'}).eq('id', id);
            alert("ë°œì†¡ì²˜ë¦¬ë¨"); closeModal('modalShipping'); loadOrders();
        };

        // ===========================================
        // 3. íšŒì› ê´€ë¦¬
        // ===========================================
        window.loadMembers = async () => {
            const tbody = document.getElementById('memberListBody'); tbody.innerHTML='<tr><td colspan="6" style="text-align:center;">ë¡œë”©ì¤‘...</td></tr>';
            const {data, error} = await sb.from('profiles').select('*').order('created_at',{ascending:false});
            if(error || !data) return tbody.innerHTML='<tr><td colspan="6" style="text-align:center;">ë°ì´í„° ì—†ìŒ</td></tr>';
            tbody.innerHTML = '';
            data.forEach(u => {
                const cls = u.role==='admin'?'badge admin':'badge customer';
                tbody.innerHTML += `<tr><td>${new Date(u.created_at).toLocaleDateString()}</td><td>${u.username||'-'}</td><td>${u.email||'-'}</td><td>${u.phone||'-'}</td><td><span class="${cls}">${u.role}</span></td><td><select onchange="updateMemberRole('${u.id}',this.value)" style="border:1px solid #ddd;"><option value="customer" ${u.role==='customer'?'selected':''}>ì¼ë°˜</option><option value="admin" ${u.role==='admin'?'selected':''}>ê´€ë¦¬ì</option></select></td></tr>`;
            });
        };
        window.updateMemberRole = async (id, role) => { if(confirm("ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await sb.from('profiles').update({role}).eq('id',id); loadMembers(); }};
        window.filterMembers = () => {
            const v = document.getElementById('memberSearch').value.toLowerCase();
            const trs = document.getElementById('memberListBody').getElementsByTagName('tr');
            for(let tr of trs) tr.style.display = tr.innerText.toLowerCase().includes(v) ? '' : 'none';
        };

        // ===========================================
        // 4. [í…œí”Œë¦¿ ê´€ë¦¬] ë¡œì§ (í•µì‹¬ ì¶”ê°€ ë¶€ë¶„)
        // ===========================================
        let tplThumbData = null;
        let tplPayload = null;

        function initTemplateListeners() {
            // ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°
            document.getElementById('fileThumb').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    tplThumbData = ev.target.result;
                    const img = document.getElementById('previewThumb');
                    img.src = tplThumbData; img.style.display = 'block';
                };
                reader.readAsDataURL(file);
            });

            // ë°ì´í„° íŒŒì¼ (SVG/JSON) íŒŒì‹±
            document.getElementById('fileData').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const content = ev.target.result;
                    if(file.name.toLowerCase().endsWith('.svg')) {
                        // Fabric.jsë¥¼ ì´ìš©í•´ SVG -> JSON ë³€í™˜
                        if(typeof fabric === 'undefined') return alert("Fabric.js ë¡œë“œ ì‹¤íŒ¨");
                        fabric.loadSVGFromString(content, (objects, options) => {
                            const group = fabric.util.groupSVGElements(objects, options);
                            group.set({left:100, top:100}); // ê¸°ë³¸ ìœ„ì¹˜
                            tplPayload = { version:"5.3.0", objects:[group.toObject()] };
                            document.getElementById('dataStatus').style.display='block';
                        });
                    } else {
                        try {
                            tplPayload = JSON.parse(content);
                            document.getElementById('dataStatus').style.display='block';
                        } catch(err) { alert("JSON í˜•ì‹ ì˜¤ë¥˜"); }
                    }
                };
                reader.readAsText(file);
            });
        }

        // ì¹´í…Œê³ ë¦¬ì— ë”°ë¼ ì…ë ¥ì°½ ë³€ê²½ (ì‚¬ì§„ ë°°ê²½ì€ SVG í•„ìš” ì—†ìŒ)
        window.toggleFileInputs = () => {
            const cat = document.getElementById('tplCategory').value;
            const isPhoto = (cat === 'photo-bg' || cat === 'transparent-graphic');
            document.getElementById('groupDataFile').style.display = isPhoto ? 'none' : 'block';
            document.getElementById('lblThumb').innerText = isPhoto ? "1. ì›ë³¸ ì´ë¯¸ì§€ (ì¸ë„¤ì¼ ê²¸ìš©)" : "1. ì¸ë„¤ì¼ ì´ë¯¸ì§€";
        };

        // í…œí”Œë¦¿ ë“±ë¡ ì‹¤í–‰
        window.uploadTemplate = async () => {
            if(!tplThumbData) return alert("ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            const cat = document.getElementById('tplCategory').value;
            const isPhoto = (cat === 'photo-bg' || cat === 'transparent-graphic');
            
            // ì‚¬ì§„í˜•ì´ë©´ ì¸ë„¤ì¼ì„ ê·¸ëŒ€ë¡œ ë°ì´í„°ë¡œ ì‚¬ìš©
            let finalData = isPhoto ? 
                { version:"5.3.0", objects:[{type:"image", src:tplThumbData, left:500, top:500}] } 
                : tplPayload;

            if(!isPhoto && !finalData) return alert("ë°ì´í„° íŒŒì¼(SVG/JSON)ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

            if(!confirm("ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            const btn = event.target; btn.innerText="ì €ì¥ ì¤‘..."; btn.disabled=true;
            try {
                const {error} = await sb.from('library').insert([{
                    category: cat,
                    tags: document.getElementById('tplTags').value,
                    thumb_url: tplThumbData, // ì‹¤ì œë¡œëŠ” Storageì— ì˜¬ë ¤ì„œ URLë§Œ ë„£ëŠ”ê²Œ ì¢‹ì§€ë§Œ, í¸ì˜ìƒ Base64 ì €ì¥
                    data_url: finalData
                }]);
                if(error) throw error;
                alert("ë“±ë¡ ì™„ë£Œ!");
                loadTemplates();
                // í¼ ì´ˆê¸°í™”
                document.getElementById('fileThumb').value='';
                document.getElementById('fileData').value='';
                document.getElementById('previewThumb').style.display='none';
                tplThumbData=null; tplPayload=null;
            } catch(e) { alert("ë“±ë¡ ì‹¤íŒ¨: "+e.message); } 
            finally { btn.innerText="DBì— ë“±ë¡í•˜ê¸°"; btn.disabled=false; }
        };

        // í…œí”Œë¦¿ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        window.loadTemplates = async () => {
            const grid = document.getElementById('tplGrid');
            const cat = document.getElementById('filterTplCat').value;
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">ë¡œë”© ì¤‘...</div>';

            let query = sb.from('library').select('id, category, thumb_url, tags').order('created_at', {ascending:false});
            if(cat !== 'all') query = query.eq('category', cat);
            
            const {data, error} = await query;
            if(error) return grid.innerHTML = 'ì—ëŸ¬ ë°œìƒ';

            grid.innerHTML = '';
            if(!data || data.length === 0) return grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; color:#999;">ë“±ë¡ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.</div>';

            data.forEach(item => {
                // Base64 ì´ë¯¸ì§€ì¸ì§€ í™•ì¸
                let img = item.thumb_url || '';
                if(!img.startsWith('data:') && !img.startsWith('http')) img = 'https://via.placeholder.com/150';
                
                const div = document.createElement('div');
                div.className = 'tpl-card';
                div.innerHTML = `
                    <img src="${img}" class="tpl-thumb">
                    <div class="tpl-info">
                        <span class="tpl-badge">${item.category}</span>
                        <div style="font-size:12px; color:#666; margin-top:5px; height:1.2em; overflow:hidden;">${item.tags||'-'}</div>
                        <button class="btn tpl-del-btn" onclick="deleteTemplate(${item.id})">ì‚­ì œ</button>
                    </div>
                `;
                grid.appendChild(div);
            });
        };

        window.deleteTemplate = async (id) => {
            if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const {error} = await sb.from('library').delete().eq('id', id);
            if(error) alert("ì‚­ì œ ì‹¤íŒ¨"); else loadTemplates();
        };

    </script>
</body>
</html>