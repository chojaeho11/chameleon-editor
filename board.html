<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ë©œë ˆì˜¨ ì»¤ë®¤ë‹ˆí‹°</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <link rel="stylesheet" href="./style.css">
    
    <style>
        /* =========================================
           ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ìŠ¤íƒ€ì¼
           ========================================= */
        body { 
            background: #f1f5f9; 
            padding-top: 80px; 
            font-family: 'Pretendard', sans-serif;
            overflow-y: auto !important;
            height: auto !important;
            color: #333;
        }

        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        .topbar {
            position: fixed; 
            top: 0; left: 0; right: 0; 
            z-index: 999;
            height: 60px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .brand { 
            font-weight: 900; 
            font-size: 20px; 
            cursor: pointer;
            color: #111;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .board-container { 
            max-width: 1100px; 
            margin: 0 auto; 
            padding: 30px 20px; 
            padding-bottom: 100px;
        }
        
        /* ê²Œì‹œíŒ í—¤ë” (ì œëª©, í•„í„°, ê¸€ì“°ê¸° ë²„íŠ¼) */
        .board-header-wrap {
            background: white; 
            border-radius: 20px; 
            padding: 25px 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); 
            margin-bottom: 30px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .country-badge { 
            background: #eff6ff; 
            color: #6366f1; 
            padding: 5px 12px; 
            border-radius: 30px; 
            font-size: 13px; 
            font-weight: 700; 
            margin-bottom: 5px; 
            display: inline-block;
        }

        /* =========================================
           ê²Œì‹œê¸€ ëª©ë¡ (Grid System)
           ========================================= */
        .post-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); 
            gap: 25px; 
        }

        .post-card {
            background: white; 
            border-radius: 16px; 
            overflow: hidden; 
            border: 1px solid #e2e8f0;
            cursor: pointer; 
            transition: all 0.3s ease; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            height: 100%;
        }

        .post-card:hover { 
            transform: translateY(-7px); 
            box-shadow: 0 15px 30px rgba(0,0,0,0.1); 
            border-color: #6366f1; 
        }
        
        /* ì¸ë„¤ì¼ ì˜ì—­ */
        .card-thumb { 
            width: 100%; 
            height: 180px; 
            background-color: #f8fafc; 
            overflow: hidden; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-bottom: 1px solid #f1f5f9;
        }
        
        .card-thumb img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: transform 0.3s; 
        }
        
        .post-card:hover .card-thumb img { 
            transform: scale(1.05); 
        }
        
        .card-body { 
            padding: 20px; 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
        }
        
        .card-title { 
            font-size: 16px; 
            font-weight: 700; 
            color: #333; 
            margin: 0 0 10px 0; 
            line-height: 1.4; 
            flex: 1;
            /* ê¸´ ì œëª© ë§ì¤„ì„ ì²˜ë¦¬ */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .card-meta { 
            font-size: 12px; 
            color: #94a3b8; 
            display: flex; 
            justify-content: space-between; 
            margin-top: auto; 
            padding-top: 15px;
            border-top: 1px solid #f8fafc;
        }

        /* =========================================
           ê²Œì‹œê¸€ ìƒì„¸ ë³´ê¸° (View)
           ========================================= */
        .view-wrap { 
            background: white; 
            padding: 40px; 
            border-radius: 20px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); 
            display: none; /* JSë¡œ ì œì–´ */
            position: relative; 
        }
        
        .view-title-row { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        
        .view-title { 
            font-size: 32px; 
            font-weight: 900; 
            color: #111; 
            line-height: 1.3; 
            margin: 0; 
        }
        
        .view-meta-row { 
            display: flex; 
            gap: 20px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 20px; 
            margin-bottom: 40px; 
            color: #666; 
            font-size: 14px; 
        }

        /* ìƒì„¸ ë³¸ë¬¸ ì´ë¯¸ì§€ ê°•ì œ ë¦¬ì‚¬ì´ì§• (ë ˆì´ì•„ì›ƒ ê¹¨ì§ ë°©ì§€) */
        .view-content img { 
            max-width: 100% !important; 
            height: auto !important; 
            border-radius: 8px; 
            margin: 15px 0; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        
        .view-content { 
            font-size: 16px; 
            line-height: 1.8; 
            color: #333; 
            min-height: 200px; 
            margin-bottom: 50px; 
        }

        /* =========================================
           ë³„ì  (Star Rating) ìŠ¤íƒ€ì¼
           ========================================= */
        .star-display-lg { 
            color: #f59e0b; 
            font-size: 20px; 
            margin-bottom: 5px; 
        }
        
        .star-rating { 
            display: flex; 
            gap: 2px; 
            cursor: pointer; 
            margin-left: 10px; 
        }
        
        .star-rating i { 
            color: #cbd5e1; 
            font-size: 24px; 
            transition: color 0.2s; 
        }
        
        .star-rating i.active { 
            color: #f59e0b; 
        }

        /* =========================================
           ëŒ“ê¸€ ì˜ì—­
           ========================================= */
        .comment-section { 
            background: #f8fafc; 
            padding: 20px; 
            border-radius: 12px; 
            margin-top: 30px; 
        }
        
        .comment-header { 
            font-size: 18px; 
            font-weight: 800; 
            margin-bottom: 15px; 
            color: #333; 
        }
        
        .comment-list { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            margin-bottom: 20px; 
            max-height: 500px; 
            overflow-y: auto; 
        }
        
        .comment-item { 
            background: white; 
            padding: 15px; 
            border-radius: 10px; 
            border: 1px solid #e2e8f0; 
        }
        
        .comment-top { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 5px; 
            font-size: 13px; 
        }
        
        .comment-author { 
            font-weight: 700; 
            color: #333; 
        }
        
        .comment-date { 
            color: #999; 
        }
        
        .comment-text { 
            font-size: 14px; 
            color: #555; 
            line-height: 1.5; 
        }

        /* ëŒ“ê¸€ ì‘ì„± í¼ */
        .comment-form { 
            display: flex; 
            gap: 10px; 
            background: white; 
            padding: 15px; 
            border-radius: 10px; 
            border: 1px solid #e2e8f0; 
        }

        /* =========================================
           ê¸€ì“°ê¸° ì—ë””í„° (Write)
           ========================================= */
        .write-wrap { 
            display: none; /* JSë¡œ ì œì–´ */
            background: white; 
            padding: 30px; 
            border-radius: 20px; 
            flex-direction: column; 
            gap: 20px; 
        }
        
        #editor-container { 
            height: 500px; 
            font-size: 16px; 
        } 

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn:hover { background: #f8fafc; }
        
        .btn.primary {
            background: #2563eb;
            color: white;
            border: none;
        }
        .btn.primary:hover { background: #1d4ed8; }

        .btn-edit { 
            background: #dbeafe; 
            color: #2563eb; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-right: 5px; 
        }
        .btn-edit:hover { background: #bfdbfe; }
        
        .btn-delete { 
            background: #fee2e2; 
            color: #ef4444; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
        }
        .btn-delete:hover { background: #fecaca; }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .ai-input-pretty {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .ai-input-pretty:focus {
            outline: none;
            border-color: #6366f1;
        }

        /* Quill íˆ´ë°” ì»¤ìŠ¤í…€ */
        .ql-toolbar.ql-snow { 
            border-top-left-radius: 10px; 
            border-top-right-radius: 10px; 
            border-color: #e2e8f0; 
            background: #f8fafc; 
        }
        .ql-container.ql-snow { 
            border-bottom-left-radius: 10px; 
            border-bottom-right-radius: 10px; 
            border-color: #e2e8f0; 
            font-family: 'Pretendard'; 
        }
    </style>
</head>
<body>

    <div class="topbar">
        <div class="brand" onclick="location.href='/'">
            <i class="fa-solid fa-palette"></i> Chameleon
        </div>
        <div style="flex:1;"></div>
    </div>

    <div class="board-container">
        
        <div class="board-header-wrap">
            <div class="board-title">
                <span class="country-badge" id="countryBadge">KR</span>
                <h1 id="pageTitle" style="margin:0; font-size:24px; font-weight:800;">Board</h1>
            </div>
            <div>
                <select id="countrySelect" class="ai-input-pretty" style="width:auto; display:inline-block; margin:0;">
                    <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
                    <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
                    <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option>
                </select>
                <button id="btnWrite" class="btn primary" style="display:inline-block; margin-left:10px;">âœï¸ ê¸€ì“°ê¸°</button>
            </div>
        </div>

        <div id="boardList" class="post-grid">Loading...</div>

        <div id="boardView" class="view-wrap">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <button onclick="goToList()" class="btn">â† ëª©ë¡ìœ¼ë¡œ</button>
                <div id="btnGroupAuth" style="display:none;">
                    <button id="btnEditPost" class="btn-edit" onclick="editCurrentPost()"><i class="fa-solid fa-pen"></i> ìˆ˜ì •</button>
                    <button id="btnDeletePost" class="btn-delete" onclick="deleteCurrentPost()"><i class="fa-solid fa-trash"></i> ì‚­ì œ</button>
                </div>
            </div>
            
            <div class="view-title-row">
                <div id="viewRatingArea" class="star-display-lg" style="display:none;"></div>
                <h1 id="viewTitle" class="view-title"></h1>
            </div>

            <div class="view-meta-row">
                <span id="viewAuthor"><i class="fa-regular fa-user"></i> ì‘ì„±ì</span>
                <span id="viewDate"><i class="fa-regular fa-clock"></i> ë‚ ì§œ</span>
                <span id="viewCount"><i class="fa-regular fa-eye"></i> ì¡°íšŒìˆ˜</span>
            </div>
            
            <article id="viewContent" class="view-content"></article>
            
            <div class="comment-section">
                <div class="comment-header">ğŸ’¬ ëŒ“ê¸€</div>
                <div id="commentList" class="comment-list"></div>
                <div class="comment-form">
                    <textarea id="commentInput" class="ai-input-pretty" style="height:60px; margin:0; flex:1;" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea>
                    <button id="btnSubmitComment" class="btn primary" style="height:60px;">ë“±ë¡</button>
                </div>
            </div>
        </div>

        <div id="boardWrite" class="write-wrap">
            <h2 style="margin:0;">âœ¨ ë©‹ì§„ ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”</h2>
            
            <div style="display:flex; align-items:center; gap:10px;">
                <input id="inputTitle" class="ai-input-pretty" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex:1; margin:0;">
                
                <div id="ratingInputArea" style="display:none; align-items:center; background:#f8fafc; padding:8px 15px; border-radius:8px; border:1px solid #e2e8f0;">
                    <span style="font-size:13px; font-weight:bold; color:#666;">ë§Œì¡±ë„</span>
                    <div class="star-rating" id="starInput">
                        <i class="fa-solid fa-star active" data-score="1"></i>
                        <i class="fa-solid fa-star active" data-score="2"></i>
                        <i class="fa-solid fa-star active" data-score="3"></i>
                        <i class="fa-solid fa-star active" data-score="4"></i>
                        <i class="fa-solid fa-star active" data-score="5"></i>
                    </div>
                </div>
            </div>

            <div style="background:white;">
                <div id="editor-container"></div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="goToList()" class="btn">ì·¨ì†Œ</button>
                <button id="btnSubmitPost" class="btn primary">ë“±ë¡í•˜ê¸°</button>
            </div>
        </div>

    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script type="module">
    import { sb, initConfig, currentUser, isAdmin } from './config.js';

    const urlParams = new URLSearchParams(window.location.search);
    const category = urlParams.get('cat') || 'free';
    const currentCountry = (urlParams.get('country') || 'KR').toUpperCase();
    const postId = urlParams.get('id');

    let quill; 
    let currentRating = 5; 
    let isEditMode = false;
    let currentPage = 0;
    const ITEMS_PER_PAGE = 12;
    let isLastPage = false;

    // [SEO]
    function updateBoardSEO() {
        const metaData = {
            'KR': { title: `ì¹´ë©œë ˆì˜¨ ì»¤ë®¤ë‹ˆí‹° - ${category}`, desc: "ê³ ê° í›„ê¸°, ì¤‘ê³  ê±°ë˜, êµ¬ì¸êµ¬ì§ ë“± ì¹´ë©œë ˆì˜¨ í”„ë¦°íŒ… ì»¤ë®¤ë‹ˆí‹°ì…ë‹ˆë‹¤." },
            'US': { title: `Chameleon Community - ${category}`, desc: "Customer reviews, marketplace, and community forum for Chameleon Printing." },
            'JP': { title: `ã‚«ãƒ¡ãƒ¬ã‚ªãƒ³ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ - ${category}`, desc: "ã‚«ãƒ¡ãƒ¬ã‚ªãƒ³ãƒ—ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°ã®ãŠå®¢æ§˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒ–ãƒ­ã‚°ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ã™ã€‚" }
        };
        const data = metaData[currentCountry] || metaData['KR'];
        document.title = data.title;
        let descTag = document.querySelector('meta[name="description"]');
        if (!descTag) {
            descTag = document.createElement('meta');
            descTag.name = "description";
            document.head.appendChild(descTag);
        }
        descTag.setAttribute('content', data.desc);
        document.documentElement.setAttribute('lang', currentCountry.toLowerCase());
    }

    async function init() {
        await initConfig();
        updateBoardSEO();

        const countrySelect = document.getElementById('countrySelect');
        countrySelect.value = currentCountry;
        countrySelect.onchange = (e) => location.href = `/board.html?cat=${category}&country=${e.target.value}`;
        document.getElementById('countryBadge').innerText = currentCountry;
        
        const titleMap = {
            'blog': { KR: 'ì¹´ë©œë ˆì˜¨ ë¸”ë¡œê·¸', US: 'Chameleon Blog', JP: 'ã‚«ãƒ¡ãƒ¬ã‚ªãƒ³ãƒ–ãƒ­ã‚°' },
            'review': { KR: 'ê³ ê° ì œì‘í›„ê¸°', US: 'Customer Reviews', JP: 'ãŠå®¢æ§˜ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼' },
            'promo': { KR: 'ì§€ì—­ê´‘ê³ ì‚¬ í™ë³´', US: 'Local Partners', JP: 'åœ°åŸŸåºƒå‘Šä¼šç¤¾' },
            'trade': { KR: 'ì¤‘ê³ ì¥ë¹„ ê±°ë˜', US: 'Used Equipment', JP: 'ä¸­å¤æ©Ÿå™¨å–å¼•' },
            'job': { KR: 'êµ¬ì¸êµ¬ì§', US: 'Job Market', JP: 'æ±‚äººãƒ»æ±‚è·' },
            'free': { KR: 'ì œí’ˆì„¤ëª…ì„œ', US: 'Product Description', JP: 'è£½å“èª¬æ˜æ›¸' }
        }[category] || { KR: 'ê²Œì‹œíŒ', US: 'Board', JP: 'æ²ç¤ºæ¿' };
        
        document.getElementById('pageTitle').innerText = titleMap[currentCountry] || titleMap['KR'];
        document.getElementById('btnWrite').style.display = 'inline-block';

        quill = new Quill('#editor-container', {
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'align': [] }],
                    ['image', 'link'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['clean']
                ]
            },
            placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...',
            theme: 'snow'
        });

        setupStarRating();

        if (postId) loadPostDetail(postId);
        else {
            createLoadMoreButton();
            loadPostList(); 
        }

        setupEventListeners();
    }

    // â˜…â˜…â˜… [í•µì‹¬] ì´ë¯¸ì§€ ê°•ì œ ì••ì¶• (Supabase Pro ê¸°ëŠ¥ ì‚¬ìš©) â˜…â˜…â˜…
    function getResizedImage(url) {
        if (!url) return null;
        if (url.startsWith('data:image')) return url; // Base64ëŠ” íŒ¨ìŠ¤
        
        // Supabase ì´ë¯¸ì§€ë¼ë©´ ì„œë²„ì—ì„œ 300px, WebP í¬ë§·ìœ¼ë¡œ ë³€í™˜í•´ì„œ ê°€ì ¸ì˜¤ê²Œ í•¨
        if (url.includes('supabase.co')) {
            const baseUrl = url.split('?')[0];
            return `${baseUrl}?width=300&height=300&resize=cover&quality=50&format=webp`;
        }
        
        // ì™¸ë¶€ ì´ë¯¸ì§€ëŠ” wsrv.nl ê²½ìœ 
        return `https://wsrv.nl/?url=${encodeURIComponent(url)}&w=300&q=50&output=webp`;
    }

    async function loadPostList(isAppend = false) {
        showSection('list');
        const listEl = document.getElementById('boardList');
        const loadMoreArea = document.getElementById('loadMoreArea');
        
        if (!isAppend) {
            listEl.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px;"><i class="fa-solid fa-spinner fa-spin fa-2x" style="color:#6366f1;"></i><br><br>ë¡œë”© ì¤‘...</div>';
            currentPage = 0;
            isLastPage = false;
        }

        try {
            const from = currentPage * ITEMS_PER_PAGE;
            const to = from + ITEMS_PER_PAGE - 1;

            // [ìµœì í™”] content ì»¬ëŸ¼ ì œì™¸í•˜ê³  ê°€ì ¸ì˜¤ê¸° (ë°ì´í„° ì–‘ ì¤„ì„)
            const { data, error } = await sb.from('community_posts')
                .select('id, title, author_name, created_at, view_count, thumbnail, rating') 
                .eq('category', category).eq('country_code', currentCountry)
                .order('created_at', { ascending: false })
                .range(from, to);
            
            if (error) throw error;

            if (!isAppend) listEl.innerHTML = ''; 

            if (!data || data.length === 0) {
                if (!isAppend) listEl.innerHTML = `<div style="text-align:center; padding:100px; color:#999; grid-column:1/-1;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                if(loadMoreArea) loadMoreArea.style.display = 'none';
                return;
            }

            if (data.length < ITEMS_PER_PAGE) {
                isLastPage = true;
                if(loadMoreArea) loadMoreArea.style.display = 'none';
            } else {
                if(loadMoreArea) loadMoreArea.style.display = 'block';
            }
            
            listEl.style.display = 'grid';

            data.forEach(post => {
                // â˜… ì¸ë„¤ì¼ì„ ì••ì¶•ëœ URLë¡œ êµì²´
                const thumbSrc = getResizedImage(post.thumbnail);
                
                let starHtml = '';
                if (category === 'review' && post.rating) {
                    starHtml = `<div style="color:#f59e0b; font-size:12px; margin-bottom:5px;">`;
                    for(let i=0; i<5; i++) starHtml += i < post.rating ? '<i class="fa-solid fa-star"></i>' : '<i class="fa-regular fa-star"></i>';
                    starHtml += `</div>`;
                }

                const card = document.createElement('div');
                card.className = 'post-card';
                
                // ì´ë¯¸ì§€ê°€ ê¹¨ì§€ë©´ ì›ë³¸ì„ ì‹œë„í•˜ë˜, ê¸°ë³¸ì ìœ¼ë¡œëŠ” ì••ì¶•ëœ ê²ƒë§Œ ë¡œë“œ
                card.innerHTML = `
                    <div class="card-thumb">
                        ${thumbSrc 
                            ? `<img src="${thumbSrc}" loading="lazy" alt="ì¸ë„¤ì¼" onerror="this.src='${post.thumbnail}'">` 
                            : `<i class="fa-regular fa-image" style="font-size:40px; color:#ddd;"></i>`}
                    </div>
                    <div class="card-body">
                        ${starHtml}
                        <div class="card-title">${post.title}</div>
                        <div class="card-meta">
                            <span>${post.author_name || 'ìµëª…'}</span>
                            <span>${new Date(post.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
                card.onclick = () => location.href = `/board.html?cat=${category}&country=${currentCountry}&id=${post.id}`;
                listEl.appendChild(card);
            });

        } catch (e) {
            console.error(e);
            if(!isAppend) {
                listEl.style.display = 'block';
                listEl.innerHTML = `<div style="text-align:center; padding:50px; color:#ef4444;">ì„œë²„ ì—°ê²°ì´ ì›í™œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br><span style="font-size:12px;">(${e.message})</span></div>`;
            }
        }
    }

    async function loadPostDetail(id) {
        showSection('view');
        try {
            await sb.rpc('increment_view_count', { post_id: id });
            const { data: post, error } = await sb.from('community_posts').select('*').eq('id', id).single();
            if (error) throw error;
            if (!post) return alert('ì‚­ì œëœ ê¸€ì…ë‹ˆë‹¤.'), goToList();
            
            const ratingArea = document.getElementById('viewRatingArea');
            if (category === 'review' && post.rating) {
                let starHtml = '';
                for(let i=0; i<5; i++) starHtml += i < post.rating ? '<i class="fa-solid fa-star"></i>' : '<i class="fa-regular fa-star"></i>';
                ratingArea.innerHTML = starHtml;
                ratingArea.style.display = 'block';
            } else ratingArea.style.display = 'none';

            document.getElementById('viewTitle').innerText = post.title;
            document.getElementById('viewAuthor').innerHTML = `<i class="fa-regular fa-user"></i> ${post.author_name}`;
            document.getElementById('viewDate').innerHTML = `<i class="fa-regular fa-clock"></i> ${new Date(post.created_at).toLocaleString()}`;
            document.getElementById('viewCount').innerHTML = `<i class="fa-regular fa-eye"></i> ${post.view_count}`;
            document.getElementById('viewContent').innerHTML = post.content;

            const btnGroup = document.getElementById('btnGroupAuth');
            if (currentUser && (isAdmin || currentUser.id === post.author_id)) btnGroup.style.display = 'block';
            else btnGroup.style.display = 'none';
            
            loadComments(id);
        } catch(e) {
            console.error(e);
            alert("ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            goToList();
        }
    }

    async function loadComments(postId) {
        const listDiv = document.getElementById('commentList');
        listDiv.innerHTML = 'ëŒ“ê¸€ ë¡œë”© ì¤‘...';
        try {
            const { data: comments } = await sb.from('community_comments').select('*').eq('post_id', postId).order('created_at', { ascending: true });
            listDiv.innerHTML = '';
            if(!comments || comments.length === 0) { listDiv.innerHTML = '<p style="color:#999; text-align:center;">ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”!</p>'; return; }
            comments.forEach(cmt => {
                const item = document.createElement('div');
                item.className = 'comment-item';
                item.innerHTML = `<div class="comment-top"><span class="comment-author">${cmt.author_name}</span><span class="comment-date">${new Date(cmt.created_at).toLocaleDateString()}</span></div><div class="comment-text">${cmt.content.replace(/\n/g, '<br>')}</div>`;
                listDiv.appendChild(item);
            });
        } catch(e) { listDiv.innerHTML = '<p style="color:red;">ëŒ“ê¸€ ë¡œë”© ì‹¤íŒ¨</p>'; }
    }

    function createLoadMoreButton() {
        const listContainer = document.querySelector('.board-container');
        const btnDiv = document.createElement('div');
        btnDiv.id = 'loadMoreArea';
        btnDiv.style.textAlign = 'center';
        btnDiv.style.marginTop = '20px';
        btnDiv.style.display = 'none';
        btnDiv.innerHTML = `<button id="btnLoadMore" class="btn" style="width:200px; padding:10px;">ë” ë³´ê¸° (+)</button>`;
        listContainer.appendChild(btnDiv);
        document.getElementById('btnLoadMore').onclick = () => { currentPage++; loadPostList(true); };
    }

    function showSection(sec) {
        document.getElementById('boardList').style.display = sec === 'list' ? 'grid' : 'none';
        document.getElementById('boardView').style.display = sec === 'view' ? 'block' : 'none';
        document.getElementById('boardWrite').style.display = sec === 'write' ? 'flex' : 'none';
        const btnWrite = document.getElementById('btnWrite');
        const loadMore = document.getElementById('loadMoreArea');
        if (sec === 'list') {
            btnWrite.style.display = 'inline-block';
            if(loadMore && !isLastPage) loadMore.style.display = 'block';
        } else {
            btnWrite.style.display = 'none';
            if(loadMore) loadMore.style.display = 'none';
        }
    }

    window.editCurrentPost = function() {
        if(!confirm("ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        isEditMode = true; 
        document.getElementById('inputTitle').value = document.getElementById('viewTitle').innerText;
        quill.root.innerHTML = document.getElementById('viewContent').innerHTML;
        if (category === 'review') document.getElementById('ratingInputArea').style.display = 'flex';
        showSection('write');
    };

    window.deleteCurrentPost = async function() {
        if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
            await sb.from('community_comments').delete().eq('post_id', postId);
            await sb.from('community_posts').delete().eq('id', postId);
            alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            goToList();
        } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨"); }
    };

    function setupStarRating() {
        const stars = document.querySelectorAll('#starInput i');
        stars.forEach(star => {
            star.onclick = function() {
                currentRating = parseInt(this.getAttribute('data-score'));
                stars.forEach(s => {
                    if(parseInt(s.getAttribute('data-score')) <= currentRating) s.classList.add('active');
                    else s.classList.remove('active');
                });
            };
        });
    }

    function setupEventListeners() {
        document.getElementById('btnWrite').onclick = () => {
            isEditMode = false; 
            document.getElementById('inputTitle').value = "";
            quill.setContents([]);
            if (category === 'review') {
                document.getElementById('ratingInputArea').style.display = 'flex';
                currentRating = 5; 
                document.querySelectorAll('#starInput i').forEach(s => s.classList.add('active'));
            } else document.getElementById('ratingInputArea').style.display = 'none';
            showSection('write');
        };

        document.getElementById('btnSubmitPost').onclick = async () => {
            const title = document.getElementById('inputTitle').value;
            const content = quill.root.innerHTML; 
            if (!title) return alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            let thumbUrl = null;
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');
            const firstImg = doc.querySelector('img');
            if (firstImg) thumbUrl = firstImg.src;

            const ratingValue = (category === 'review') ? currentRating : null;
            const authorId = currentUser ? currentUser.id : null; 
            const authorName = currentUser ? (currentUser.user_metadata.full_name || currentUser.email.split('@')[0]) : 'ìµëª…(Guest)';
            const authorEmail = currentUser ? currentUser.email : '';
            const payload = { title, content, rating: ratingValue, thumbnail: thumbUrl };

            if (isEditMode) {
                if (!currentUser) return alert("ìµëª… ê¸€ì€ ìˆ˜ì • ë¶ˆê°€");
                const { error } = await sb.from('community_posts').update(payload).eq('id', postId);
                if (error) alert("ìˆ˜ì • ì‹¤íŒ¨"); else { alert("ìˆ˜ì • ì™„ë£Œ"); location.reload(); }
            } else {
                payload.category = category;
                payload.country_code = currentCountry;
                payload.author_id = authorId;
                payload.author_name = authorName;
                payload.author_email = authorEmail;
                const { error } = await sb.from('community_posts').insert(payload);
                if (error) alert("ë“±ë¡ ì‹¤íŒ¨"); else { alert('ë“±ë¡ ì™„ë£Œ'); goToList(); }
            }
        };

        document.getElementById('btnSubmitComment').onclick = async () => {
            const txt = document.getElementById('commentInput').value;
            if(!txt.trim()) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
            const cmtAuthorId = currentUser ? currentUser.id : null;
            const cmtAuthorName = currentUser ? (currentUser.user_metadata.full_name || currentUser.email.split('@')[0]) : 'ìµëª…(Guest)';
            const { error } = await sb.from('community_comments').insert({ post_id: postId, author_id: cmtAuthorId, author_name: cmtAuthorName, content: txt });
            if(error) alert("ì‹¤íŒ¨"); else { document.getElementById('commentInput').value = ''; loadComments(postId); }
        };
    }

    init();
</script>
<script type="module">
    // 1. config.jsì—ì„œ sbì™€ initConfigë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    import { sb, initConfig } from './config.js?v=119';

    // [ìœ ì… ê²½ë¡œ ìƒì„¸ ë¶„ì„ í•¨ìˆ˜]
    function getTrafficSource() {
        const params = new URLSearchParams(window.location.search);
        const referrer = document.referrer;
        
        // 1. [ê´‘ê³  ì²´í¬]
        if (params.has('gclid') || params.get('utm_medium') === 'cpc' || params.get('utm_source') === 'ad') {
            return 'Google Ads (ê´‘ê³ )';
        }
        
        // 2. [ì§ì ‘ ì ‘ì†]
        if (!referrer || referrer.trim() === '') {
            return 'Direct (ì¦ê²¨ì°¾ê¸°/ì£¼ì†Œì…ë ¥)';
        }

        // 3. [ì‚¬ì´íŠ¸ ë¶„ì„]
        try {
            const refUrl = new URL(referrer);
            const hostname = refUrl.hostname.toLowerCase();

            // ë‚´ë¶€ ì´ë™ (ë©”ì¸ -> ë¸”ë¡œê·¸ ë“±)
            if (hostname.includes(window.location.hostname)) return 'Internal (ë‚´ë¶€ì´ë™)';

            if (hostname.includes('google.')) return 'Google Search (ìì—°ê²€ìƒ‰)';
            if (hostname.includes('naver.')) return 'Naver Search (ìì—°ê²€ìƒ‰)';
            if (hostname.includes('daum.') || hostname.includes('kakao.')) return 'Daum/Kakao';
            if (hostname.includes('instagram.')) return 'Instagram';
            if (hostname.includes('facebook.') || hostname.includes('fb.com')) return 'Facebook';
            if (hostname.includes('youtube.')) return 'Youtube';
            
            return hostname;
        } catch (e) {
            return 'Other Websites';
        }
    }

    async function trackVisit() {
        // â˜… [í•µì‹¬ ìˆ˜ì •] DB(sb)ê°€ ì•„ì§ ì¤€ë¹„ ì•ˆ ëìœ¼ë©´(nullì´ë©´), ê°•ì œë¡œ ì—°ê²°ì„ ì‹œë„í•˜ê³  ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
        if (!sb || !sb.from) {
            console.log("â³ DB ì—°ê²° ëŒ€ê¸° ì¤‘..."); 
            if(typeof initConfig === 'function') await initConfig();
        }

        try {
            // ìƒì„¸ ë¶„ì„ëœ ìœ ì… ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
            const sourceName = getTrafficSource();
            // ë¸”ë¡œê·¸ ìœ ì…ì„ì„ í‘œì‹œí•˜ê¸° ìœ„í•´ [Blog] íƒœê·¸ ì¶”ê°€
            const finalReferrer = `[Blog] ${sourceName}`; 

            const { data, error } = await sb
                .from('page_views')
                .insert([{ 
                    referrer: finalReferrer, 
                    duration: 0 
                }])
                .select()
                .single();

            if (error) throw error;

            console.log("âœ… ë¸”ë¡œê·¸ ë°©ë¬¸ ê¸°ë¡ ì„±ê³µ:", finalReferrer);

            // ì²´ë¥˜ì‹œê°„ ì—…ë°ì´íŠ¸ (5ì´ˆ ê°„ê²©)
            const visitId = data.id;
            const startTime = Date.now();
            
            setInterval(() => {
                const durationSec = Math.floor((Date.now() - startTime) / 1000);
                sb.from('page_views')
                  .update({ duration: durationSec })
                  .eq('id', visitId)
                  .then(() => {});
            }, 5000);

        } catch (e) {
            console.warn("Tracking skipped:", e.message);
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    trackVisit();
</script>
</body>
</html>