<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>ì¹´ë©œë ˆì˜¨ ì»¤ë®¤ë‹ˆí‹° | í—ˆë‹ˆì½¤ë³´ë“œÂ·ì‹¤ì‚¬ì¶œë ¥Â·ë¬´ë£Œë””ìì¸ì—ë””í„° ì •ë³´</title>
    <meta name="description" content="ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ… ê³µì‹ ì»¤ë®¤ë‹ˆí‹°. í—ˆë‹ˆì½¤ë³´ë“œ, ì¢…ì´ë§¤ëŒ€, íŒ¨ë¸Œë¦­ì¸ì‡„, ì¢…ì´ê°€êµ¬ ì œì‘ í›„ê¸° ë° ì‹¤ì‚¬ì¶œë ¥ ë…¸í•˜ìš°. ë¬´ë£Œë””ìì¸ì—ë””í„° ì‚¬ìš©ë²•ê³¼ ê·¸ë¦¼ë¶€ì—… ì •ë³´ë¥¼ ê³µìœ í•˜ëŠ” ì¸ì‡„ë„ë§¤ì‡¼í•‘ëª° ì†Œí†µ ê³µê°„ì…ë‹ˆë‹¤.">
    <meta name="keywords" content="ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ…, í—ˆë‹ˆì½¤ë³´ë“œ, íŒ¨ë¸Œë¦­ì¸ì‡„, ì¢…ì´ë§¤ëŒ€, ì¢…ì´ê°€êµ¬, ì‹¤ì‚¬ì¶œë ¥, ë¬´ë£Œë””ìì¸ì—ë””í„°, ì¸ì‡„ë„ë§¤ì‡¼í•‘ëª°, ê·¸ë¦¼ë¶€ì—…, êµ¿ì¦ˆì œì‘, í¼ë³´ë“œì¸ì‡„">
    <meta name="author" content="Chameleon Printing">
    <meta name="robots" content="index, follow">

    <meta property="og:type" content="website">
    <meta property="og:site_name" content="ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ…">
    <meta property="og:title" content="ì¹´ë©œë ˆì˜¨ ì»¤ë®¤ë‹ˆí‹° - ì¸ì‡„/ë””ìì¸/ë¶€ì—… ì •ë³´">
    <meta property="og:description" content="í—ˆë‹ˆì½¤ë³´ë“œ, ì¢…ì´ë§¤ëŒ€, ì‹¤ì‚¬ì¶œë ¥ ì œì‘ í›„ê¸°ì™€ ê·¸ë¦¼ë¶€ì—… ë…¸í•˜ìš°ë¥¼ í™•ì¸í•˜ì„¸ìš”.">
    <meta property="og:image" content="https://www.cafe2626.com/images/og_board_thumb.jpg"> 
    <meta property="og:url" content="https://www.cafe2626.com/board.html">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ì¹´ë©œë ˆì˜¨ ì»¤ë®¤ë‹ˆí‹°">
    <meta name="twitter:description" content="ì¸ì‡„ë„ë§¤ì‡¼í•‘ëª° ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ…ì˜ ì»¤ë®¤ë‹ˆí‹°ì…ë‹ˆë‹¤.">

    <link rel="canonical" href="https://www.cafe2626.com/board.html" />

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
    
    <style>
        body { 
            background: #f1f5f9; 
            padding-top: 80px; 
            font-family: 'Pretendard', sans-serif;
            overflow-y: auto !important;
            height: auto !important;
        }

        .board-container { 
            max-width: 1100px; 
            margin: 0 auto; 
            padding: 30px 20px; 
            padding-bottom: 100px;
        }
        
        .board-header-wrap {
            background: white; border-radius: 20px; padding: 25px 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .country-badge { background: #eff6ff; color: #6366f1; padding: 5px 12px; border-radius: 30px; font-size: 13px; font-weight: 700; margin-bottom: 5px; display:inline-block;}

        .board-nav {
            display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; 
            padding-bottom: 5px; 
            scrollbar-width: none; 
        }
        .board-nav::-webkit-scrollbar { display: none; } 
        
        .nav-item {
            padding: 10px 18px; background: white; border: 1px solid #e2e8f0;
            border-radius: 50px; font-size: 14px; font-weight: 600; color: #64748b;
            cursor: pointer; white-space: nowrap; transition: 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .nav-item:hover { background: #f8fafc; color: #333; }
        .nav-item.active { background: #6366f1; color: white; border-color: #6366f1; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3); }
        .nav-item.home { background: #334155; color: white; border-color: #334155; }

        /* ê²Œì‹œê¸€ ê·¸ë¦¬ë“œ */
        .post-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; }
        .post-card {
            background: white; border-radius: 16px; overflow: hidden; border: 1px solid #e2e8f0;
            cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .post-card:hover { transform: translateY(-7px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); border-color: #6366f1; }
        .card-thumb { width: 100%; height: 180px; background-color: #f8fafc; overflow: hidden; display:flex; align-items:center; justify-content:center; }
        .card-thumb img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .post-card:hover .card-thumb img { transform: scale(1.05); }
        .card-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        .card-title { font-size: 16px; font-weight: 700; color: #333; margin: 0 0 10px 0; line-height: 1.4; flex: 1; }
        .card-meta { font-size: 12px; color: #94a3b8; display: flex; justify-content: space-between; margin-top: auto; }

        /* ìƒì„¸ë³´ê¸° */
        .view-wrap { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); display: none; position: relative; }
        .view-title-row { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .view-title { font-size: 32px; font-weight: 900; color: #111; line-height: 1.3; margin: 0; }
        .view-meta-row { display: flex; gap: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 40px; color: #666; font-size: 14px; }
        .view-content img { max-width: 100%; border-radius: 8px; margin: 15px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .view-content { font-size: 16px; line-height: 1.8; color: #333; min-height: 200px; margin-bottom: 50px; }

        .star-display-lg { color: #f59e0b; font-size: 20px; margin-bottom: 5px; }
        .star-rating { display: flex; gap: 2px; cursor: pointer; margin-left: 10px; }
        .star-rating i { color: #cbd5e1; font-size: 24px; transition: color 0.2s; }
        .star-rating i.active { color: #f59e0b; }

        .comment-section { background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 30px; }
        .comment-header { font-size: 18px; font-weight: 800; margin-bottom: 15px; color: #333; }
        .comment-list { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; max-height: 500px; overflow-y: auto; }
        .comment-item { background: white; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; }
        .comment-top { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px; }
        .comment-author { font-weight: 700; color: #333; }
        .comment-date { color: #999; }
        .comment-text { font-size: 14px; color: #555; line-height: 1.5; }

        .comment-form { display: flex; gap: 10px; background: white; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; }
        .write-wrap { display: none; background: white; padding: 30px; border-radius: 20px; flex-direction: column; gap: 20px; }
        #editor-container { height: 500px; font-size: 16px; } 

        .btn-edit { background: #dbeafe; color: #2563eb; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-right: 5px; }
        .btn-edit:hover { background: #bfdbfe; }
        .btn-delete { background: #fee2e2; color: #ef4444; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-delete:hover { background: #fecaca; }

        .ql-toolbar.ql-snow { border-top-left-radius: 10px; border-top-right-radius: 10px; border-color: #e2e8f0; background: #f8fafc; }
        .ql-container.ql-snow { border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; border-color: #e2e8f0; font-family: 'Pretendard'; }
        
        /* [ì¶”ê°€] ë²„íŠ¼ì´ ë¹„í™œì„±í™”(disabled) ë˜ì—ˆì„ ë•Œ ì‹œê°ì  í”¼ë“œë°± */
        button:disabled {
            background-color: #ccc !important;
            cursor: not-allowed !important;
            opacity: 0.7;
        }
    </style>
</head>
<body>

    <div class="topbar" style="position:fixed; top:0; left:0; right:0; z-index: 999;">
        <div class="brand" onclick="location.href='/'"><i class="fa-solid fa-palette"></i> Chameleon</div>
        <div style="flex:1;"></div>
    </div>

    <div class="board-container">
        
        <div class="board-header-wrap">
            <div class="board-title">
                <span class="country-badge" id="countryBadge">KR</span>
                <h1 id="pageTitle" style="margin:0; font-size:24px; font-weight:800;">Board</h1>
            </div>
            <div>
                <select id="countrySelect" class="ai-input-pretty" style="width:auto; display:inline-block; margin:0;">
                    <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
                    <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
                    <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option>
                </select>
                <button id="btnWrite" class="btn primary" style="display:none; margin-left:10px;">âœï¸ ê¸€ì“°ê¸°</button>
            </div>
        </div>

        <div class="board-nav">
            <button class="nav-item home" onclick="location.href='index.html'">
                <i class="fa-solid fa-house"></i> HOME
            </button>
            <button class="nav-item" onclick="moveCategory('free')" id="nav-free">
                <i class="fa-regular fa-file-lines"></i> ì œí’ˆì„¤ëª…ì„œ
            </button>
            <button class="nav-item" onclick="moveCategory('blog')" id="nav-blog">
                <i class="fa-solid fa-pen-nib"></i> ë¸”ë¡œê·¸
            </button>
            <button class="nav-item" onclick="moveCategory('review')" id="nav-review">
                <i class="fa-regular fa-star"></i> ê³ ê°í›„ê¸°
            </button>
            <button class="nav-item" onclick="moveCategory('promo')" id="nav-promo">
                <i class="fa-solid fa-bullhorn"></i> ì—…ì²´í™ë³´
            </button>
            <button class="nav-item" onclick="moveCategory('trade')" id="nav-trade">
                <i class="fa-solid fa-handshake"></i> ì¤‘ê³ ê±°ë˜
            </button>
            <button class="nav-item" onclick="moveCategory('job')" id="nav-job">
                <i class="fa-solid fa-briefcase"></i> êµ¬ì¸êµ¬ì§
            </button>
        </div>

        <div id="boardList" class="post-grid">Loading...</div>

        <div id="boardView" class="view-wrap">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <button onclick="goToList()" class="btn">â† ëª©ë¡ìœ¼ë¡œ</button>
                <div id="btnGroupAuth" style="display:none;">
                    <button id="btnEditPost" class="btn-edit" onclick="editCurrentPost()"><i class="fa-solid fa-pen"></i> ìˆ˜ì •</button>
                    <button id="btnDeletePost" class="btn-delete" onclick="deleteCurrentPost()"><i class="fa-solid fa-trash"></i> ì‚­ì œ</button>
                </div>
            </div>
            
            <div class="view-title-row">
                <div id="viewRatingArea" class="star-display-lg" style="display:none;"></div>
                <h1 id="viewTitle" class="view-title"></h1>
            </div>

            <div class="view-meta-row">
                <span id="viewAuthor"><i class="fa-regular fa-user"></i> ì‘ì„±ì</span>
                <span id="viewDate"><i class="fa-regular fa-clock"></i> ë‚ ì§œ</span>
                <span id="viewCount"><i class="fa-regular fa-eye"></i> ì¡°íšŒìˆ˜</span>
            </div>
            
            <article id="viewContent" class="view-content"></article>
            
            <div class="comment-section">
                <div class="comment-header">ğŸ’¬ ëŒ“ê¸€</div>
                <div id="commentList" class="comment-list"></div>
                <div class="comment-form">
                    <textarea id="commentInput" class="ai-input-pretty" style="height:60px; margin:0; flex:1;" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea>
                    <button id="btnSubmitComment" class="btn primary" style="height:60px;">ë“±ë¡</button>
                </div>
            </div>
        </div>

        <div id="boardWrite" class="write-wrap">
            <h2 style="margin:0;">âœ¨ ë©‹ì§„ ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”</h2>
            
            <div style="display:flex; align-items:center; gap:10px;">
                <input id="inputTitle" class="ai-input-pretty" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex:1; margin:0;">
                
                <div id="ratingInputArea" style="display:none; align-items:center; background:#f8fafc; padding:8px 15px; border-radius:8px; border:1px solid #e2e8f0;">
                    <span style="font-size:13px; font-weight:bold; color:#666;">ë§Œì¡±ë„</span>
                    <div class="star-rating" id="starInput">
                        <i class="fa-solid fa-star active" data-score="1"></i>
                        <i class="fa-solid fa-star active" data-score="2"></i>
                        <i class="fa-solid fa-star active" data-score="3"></i>
                        <i class="fa-solid fa-star active" data-score="4"></i>
                        <i class="fa-solid fa-star active" data-score="5"></i>
                    </div>
                </div>
            </div>

            <div style="background:white;">
                <div id="editor-container"></div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="goToList()" class="btn">ì·¨ì†Œ</button>
                <button id="btnSubmitPost" class="btn primary">ë“±ë¡í•˜ê¸°</button>
            </div>
        </div>

    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script type="module">
    // [ì„œë²„ ë³´í˜¸ ëª¨ë“œ] config.js ë¡œë”© ì—†ì´ ì§ì ‘ ê°€ë³ê²Œ ì—°ê²°
    let sb = null;
    let currentUser = null;
    let isAdmin = false;

    // â–¼â–¼â–¼ [ê°•ì œ ê´€ë¦¬ì] DBê°€ ëŠë ¤ë„ ê¸€ì“°ê¸° ë²„íŠ¼ ì¦‰ì‹œ ë…¸ì¶œ â–¼â–¼â–¼
    const FORCE_ADMIN_EMAILS = [
        "korea900@daum.net", 
        "korea900as@gmail.com", 
        "nadiaseo@kakao.com", 
        "ceo@test.com"
    ];

    const urlParams = new URLSearchParams(window.location.search);
    const category = urlParams.get('cat') || 'free';
    const currentCountry = (urlParams.get('country') || 'KR').toUpperCase();
    const postId = urlParams.get('id');

    let quill; 
    let currentRating = 5; 
    let isEditMode = false;

    // ê²Œì‹œíŒ ì„¤ì •
    const boardMetaInfo = {
        'blog': { title: { KR: 'ì¹´ë©œë ˆì˜¨ ë¸”ë¡œê·¸', US: 'Blog', JP: 'ãƒ–ãƒ­ã‚°' }, desc: 'ê³µì‹ ë¸”ë¡œê·¸' },
        'review': { title: { KR: 'ê³ ê° ì œì‘í›„ê¸°', US: 'Reviews', JP: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼' }, desc: 'ìƒìƒí•œ í›„ê¸°' },
        'promo': { title: { KR: 'ì§€ì—­ê´‘ê³ ì‚¬ í™ë³´', US: 'Partners', JP: 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼' }, desc: 'ì—…ì²´ í™ë³´' },
        'trade': { title: { KR: 'ì¤‘ê³ ì¥ë¹„ ê±°ë˜', US: 'Used Market', JP: 'ä¸­å¤å–å¼•' }, desc: 'ì¤‘ê³  ì¥ë¹„' },
        'job': { title: { KR: 'êµ¬ì¸êµ¬ì§', US: 'Job Market', JP: 'æ±‚äºº' }, desc: 'ì±„ìš© ì •ë³´' },
        'free': { title: { KR: 'ì œí’ˆì„¤ëª…ì„œ', US: 'Manuals', JP: 'ãƒãƒ‹ãƒ¥ã‚¢ãƒ«' }, desc: 'ì œí’ˆ ì„¤ëª…ì„œ' }
    };

    // [í•µì‹¬ 1] ì´ë¯¸ì§€ ìš©ëŸ‰ 1/50ë¡œ ì••ì¶•í•˜ì—¬ ë¡œë”© (ì„œë²„ ë¶€í•˜ ê°ì†Œ)
    function optimizeImage(url) {
        if (!url) return null;
        if (url.includes('supabase.co')) {
            const sep = url.includes('?') ? '&' : '?';
            return `${url}${sep}width=300&height=200&resize=cover&quality=50&format=webp`;
        }
        return url;
    }

    async function init() {
        if (typeof window.supabase === 'undefined') await new Promise(r => setTimeout(r, 100));
        
        if (typeof window.supabase !== 'undefined') {
            const { createClient } = window.supabase;
            const SUPABASE_URL = 'https://qinvtnhiidtmrzosyvys.supabase.co'; 
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpbnZ0bmhpaWR0bXJ6b3N5dnlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMDE3NjQsImV4cCI6MjA3ODc3Nzc2NH0.3z0f7R4w3bqXTOMTi19ksKSeAkx8HOOTONNSos8Xz8Y';
            sb = createClient(SUPABASE_URL, SUPABASE_KEY);
            
            try {
                const { data } = await sb.auth.getSession();
                if (data?.session?.user) {
                    currentUser = data.session.user;
                    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (ê°•ì œ ë¦¬ìŠ¤íŠ¸ ìš°ì„ )
                    if (FORCE_ADMIN_EMAILS.includes(currentUser.email)) {
                        isAdmin = true;
                    } else {
                        // DB ì²´í¬ (ë¹„ë™ê¸°, ì‹¤íŒ¨í•´ë„ í˜ì´ì§€ëŠ” ëœ¸)
                        sb.from('profiles').select('role').eq('id', currentUser.id).single()
                          .then(({data}) => { if(data?.role === 'admin') isAdmin = true; });
                    }
                }
            } catch(e) {}
        }

        // UI ì´ˆê¸°í™”
        const meta = boardMetaInfo[category] || boardMetaInfo['free'];
        const titleText = meta.title[currentCountry] || meta.title['KR'];
        document.getElementById('pageTitle').innerText = titleText;
        document.getElementById('countryBadge').innerText = currentCountry;
        
        const nav = document.getElementById(`nav-${category}`);
        if(nav) nav.classList.add('active');

        // ë²„íŠ¼ í‘œì‹œ
        const btnWrite = document.getElementById('btnWrite');
        if (btnWrite && currentUser) {
            if (category === 'blog' && !isAdmin) btnWrite.style.display = 'none';
            else btnWrite.style.display = 'inline-block';
        }

        // ì—ë””í„°
        if(typeof Quill !== 'undefined' && document.getElementById('editor-container')) {
            quill = new Quill('#editor-container', {
                modules: { toolbar: [ [{ header: [1, 2, false] }], ['bold', 'italic'], ['image', 'link'], [{ list: 'ordered' }, { list: 'bullet' }] ] },
                placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...', theme: 'snow'
            });
        }

        setupEventListeners();

        if (postId) loadPostDetail(postId);
        else loadPostList();
    }

    // [í•µì‹¬ 2] ëª©ë¡ ë¡œë”© ì‹œ 'ë³¸ë¬¸(content)' ì œì™¸í•˜ê³  20ê°œë§Œ ë¡œë“œ
    async function loadPostList() {
        showSection('list');
        const listEl = document.getElementById('boardList');
        listEl.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:60px;"><i class="fa-solid fa-spinner fa-spin"></i> ë¡œë”© ì¤‘...</div>';

        try {
            // content ì»¬ëŸ¼ì„ ë¹¼ê³  ê°€ì ¸ì™€ì•¼ ë°ì´í„°ëŸ‰ì´ 99% ì¤„ì–´ë“­ë‹ˆë‹¤.
            const { data, error } = await sb.from('community_posts')
                .select('id, title, author_name, created_at, view_count, rating, content') // contentëŠ” ì¸ë„¤ì¼ ì¶”ì¶œìš©ìœ¼ë¡œë§Œ ì‚¬ìš©
                .eq('category', category)
                .eq('country_code', currentCountry)
                .order('created_at', { ascending: false })
                .limit(20); // â˜… 20ê°œ ì œí•œ í•„ìˆ˜

            if (error) throw error;

            listEl.innerHTML = '';
            if (!data || data.length === 0) {
                listEl.style.display = 'block';
                listEl.innerHTML = `<div style="text-align:center; padding:100px; color:#999;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }
            listEl.style.display = 'grid';

            data.forEach(post => {
                // ë³¸ë¬¸ì—ì„œ ì´ë¯¸ì§€ URLë§Œ ì™ ë¹¼ë‚´ê¸° (ì •ê·œì‹)
                let thumbUrl = null;
                if (post.content && post.content.includes('<img')) {
                    const match = post.content.match(/<img[^>]+src="([^">]+)"/);
                    if (match) thumbUrl = match[1];
                }
                const optimizedSrc = optimizeImage(thumbUrl);

                let starHtml = '';
                if (category === 'review' && post.rating) {
                    starHtml = `<div style="color:#f59e0b; font-size:12px; margin-bottom:5px;">${'â˜…'.repeat(post.rating)}${'â˜†'.repeat(5-post.rating)}</div>`;
                }

                const card = document.createElement('div');
                card.className = 'post-card';
                card.innerHTML = `
                    <div class="card-thumb">
                        ${optimizedSrc 
                            ? `<img src="${optimizedSrc}" loading="lazy" decoding="async" alt="thumb" style="width:100%; height:100%; object-fit:cover;">` 
                            : `<i class="fa-regular fa-image" style="font-size:30px; color:#e2e8f0;"></i>`
                        }
                    </div>
                    <div class="card-body">
                        ${starHtml}
                        <div class="card-title">${post.title}</div>
                        <div class="card-meta">
                            <span>${post.author_name || 'User'}</span>
                            <span>${new Date(post.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
                card.onclick = () => location.href = `/board.html?cat=${category}&country=${currentCountry}&id=${post.id}`;
                listEl.appendChild(card);
            });

        } catch (e) {
            console.error("List Load Error:", e);
            listEl.innerHTML = '<div style="grid-column:1/-1; text-align:center;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ (ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”)</div>';
        }
    }

    // [í•µì‹¬ 3] ìƒì„¸ ë³´ê¸° (ì•ˆì „ ì¥ì¹˜ ì¶”ê°€)
    async function loadPostDetail(id) {
        showSection('view');
        
        // â˜… [ìˆ˜ì •ë¨] ì—ëŸ¬ê°€ ë°œìƒí•˜ë˜ ë¶€ë¶„: .catch()ë¥¼ ì œê±°í•˜ê³  try-catch ë¸”ë¡ìœ¼ë¡œ ê°ìŒŒìŠµë‹ˆë‹¤.
        try {
            await sb.rpc('increment_view_count', { post_id: id });
        } catch (err) {
            console.warn("ì¡°íšŒìˆ˜ ì¦ê°€ ì‹¤íŒ¨ (ë¬´ì‹œë¨):", err);
        }

        const { data: post, error } = await sb.from('community_posts').select('*').eq('id', id).single();
        
        if (error || !post) {
            alert('ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            goToList();
            return;
        }

        // ë³„ì 
        if (category === 'review' && post.rating) {
            document.getElementById('viewRatingArea').innerHTML = 'â˜…'.repeat(post.rating) + 'â˜†'.repeat(5-post.rating);
            document.getElementById('viewRatingArea').style.display = 'block';
        }

        document.getElementById('viewTitle').innerText = post.title;
        document.getElementById('viewAuthor').innerText = post.author_name;
        document.getElementById('viewDate').innerText = new Date(post.created_at).toLocaleString();
        document.getElementById('viewCount').innerText = `ì¡°íšŒ ${post.view_count}`;
        document.getElementById('viewContent').innerHTML = post.content;

        // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ê¶Œí•œ
        const btnGroup = document.getElementById('btnGroupAuth');
        if (currentUser && (isAdmin || currentUser.id === post.author_id)) {
            btnGroup.style.display = 'block';
        } else {
            btnGroup.style.display = 'none';
        }

        loadComments(id);
    }

    async function loadComments(postId) {
        const listDiv = document.getElementById('commentList');
        // ëŒ“ê¸€ë„ ìµœëŒ€ 50ê°œë§Œ ë¡œë“œ
        const { data: comments } = await sb.from('community_comments')
            .select('*').eq('post_id', postId).order('created_at', { ascending: true }).limit(50);

        listDiv.innerHTML = '';
        if(!comments?.length) {
            listDiv.innerHTML = '<p style="color:#999; text-align:center;">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>';
            return;
        }
        comments.forEach(cmt => {
            const item = document.createElement('div');
            item.className = 'comment-item';
            item.innerHTML = `
                <div class="comment-top"><span class="comment-author">${cmt.author_name}</span></div>
                <div class="comment-text">${cmt.content.replace(/\n/g, '<br>')}</div>
            `;
            listDiv.appendChild(item);
        });
    }

    function showSection(sec) {
        document.getElementById('boardList').style.display = sec === 'list' ? 'grid' : 'none';
        document.getElementById('boardView').style.display = sec === 'view' ? 'block' : 'none';
        document.getElementById('boardWrite').style.display = sec === 'write' ? 'flex' : 'none';
    }

    window.goToList = () => { location.href = `/board.html?cat=${category}&country=${currentCountry}`; };
    window.moveCategory = (cat) => { location.href = `/board.html?cat=${cat}&country=${currentCountry}`; };

    function setupEventListeners() {
        const btnWrite = document.getElementById('btnWrite');
        if(btnWrite) btnWrite.onclick = () => {
            if (!currentUser) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            isEditMode = false;
            document.getElementById('inputTitle').value = "";
            if(quill) quill.setContents([]);
            if (category === 'review') document.getElementById('ratingInputArea').style.display = 'flex';
            showSection('write');
        };

        const btnSubmit = document.getElementById('btnSubmitPost');
        if(btnSubmit) btnSubmit.onclick = async () => {
            if (btnSubmit.disabled) return;
            const title = document.getElementById('inputTitle').value;
            const content = quill.root.innerHTML;
            if (!title) return alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            btnSubmit.disabled = true; btnSubmit.innerText = "ì €ì¥ ì¤‘...";

            try {
                const ratingValue = (category === 'review') ? currentRating : null;
                const payload = {
                    title, content, rating: ratingValue, updated_at: new Date()
                };

                if (isEditMode) {
                    await sb.from('community_posts').update(payload).eq('id', postId);
                    alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    payload.category = category;
                    payload.country_code = currentCountry;
                    payload.author_id = currentUser.id;
                    payload.author_name = currentUser.user_metadata.full_name || currentUser.email.split('@')[0];
                    await sb.from('community_posts').insert(payload);
                    alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
                location.href = `/board.html?cat=${category}&country=${currentCountry}`;
            } catch(e) {
                alert("ì‹¤íŒ¨: " + e.message);
                btnSubmit.disabled = false; btnSubmit.innerText = "ë“±ë¡í•˜ê¸°";
            }
        };

        // ë³„ì  ë¡œì§
        const stars = document.querySelectorAll('#starInput i');
        stars.forEach(star => {
            star.onclick = function() {
                currentRating = parseInt(this.getAttribute('data-score'));
                stars.forEach(s => {
                    if(parseInt(s.getAttribute('data-score')) <= currentRating) s.classList.add('active');
                    else s.classList.remove('active');
                });
            };
        });
        
        // ëŒ“ê¸€ ë“±ë¡
        document.getElementById('btnSubmitComment').onclick = async () => {
            if(!currentUser) return alert('ë¡œê·¸ì¸ í•„ìš”');
            const txt = document.getElementById('commentInput').value;
            if(!txt.trim()) return;
            await sb.from('community_comments').insert({
                post_id: postId, author_id: currentUser.id,
                author_name: currentUser.user_metadata.full_name || 'User', content: txt
            });
            document.getElementById('commentInput').value = '';
            loadComments(postId);
        };
    }

    // ìˆ˜ì •/ì‚­ì œ ì „ì—­ í•¨ìˆ˜
    window.editCurrentPost = () => {
        if(!confirm("ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        isEditMode = true; 
        document.getElementById('inputTitle').value = document.getElementById('viewTitle').innerText;
        quill.root.innerHTML = document.getElementById('viewContent').innerHTML;
        if (category === 'review') document.getElementById('ratingInputArea').style.display = 'flex';
        showSection('write');
    };

    window.deleteCurrentPost = async () => {
        if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await sb.from('community_posts').delete().eq('id', postId);
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        goToList();
    };

    init();
</script>