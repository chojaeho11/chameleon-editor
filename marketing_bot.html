<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë§ˆì¼€íŒ… ë´‡ ê´€ë¦¬</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Pretendard',sans-serif; background:#0f172a; color:#e2e8f0; min-height:100vh; }

/* ìƒë‹¨ í—¤ë” */
.top-header { background:#1e293b; border-bottom:1px solid #334155; padding:12px 24px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
.top-header .logo { display:flex; align-items:center; gap:10px; font-size:18px; font-weight:800; color:#a78bfa; cursor:pointer; }
.top-header .logo i { font-size:22px; }
.top-header .user-info { font-size:13px; color:#94a3b8; }
.top-header .back-btn { background:none; border:1px solid #475569; color:#94a3b8; padding:6px 14px; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600; transition:all .2s; }
.top-header .back-btn:hover { background:#334155; color:#fff; }

/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
.tab-nav { background:#1e293b; border-bottom:1px solid #334155; padding:0 24px; display:flex; gap:0; overflow-x:auto; }
.tab-nav .tab { padding:14px 20px; font-size:13px; font-weight:600; color:#64748b; cursor:pointer; border-bottom:3px solid transparent; white-space:nowrap; transition:all .2s; display:flex; align-items:center; gap:8px; }
.tab-nav .tab:hover { color:#a78bfa; background:rgba(167,139,250,.05); }
.tab-nav .tab.active { color:#a78bfa; border-bottom-color:#a78bfa; }
.tab-nav .tab i { font-size:14px; }

/* ë©”ì¸ ì½˜í…ì¸  */
.main-content { max-width:1200px; margin:0 auto; padding:24px; }
.tab-panel { display:none; }
.tab-panel.active { display:block; }

/* ì¹´ë“œ */
.card { background:#1e293b; border:1px solid #334155; border-radius:12px; padding:20px; margin-bottom:16px; }
.card-title { font-size:15px; font-weight:700; color:#f1f5f9; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.card-title i { color:#a78bfa; }

/* í†µê³„ ê·¸ë¦¬ë“œ */
.stat-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:20px; }
.stat-box { background:#1e293b; border:1px solid #334155; border-radius:12px; padding:16px; text-align:center; }
.stat-box .num { font-size:28px; font-weight:800; color:#a78bfa; }
.stat-box .label { font-size:12px; color:#94a3b8; margin-top:4px; }
.stat-box.green .num { color:#22c55e; }
.stat-box.blue .num { color:#3b82f6; }
.stat-box.orange .num { color:#f97316; }
.stat-box.pink .num { color:#ec4899; }

/* í¼ ìŠ¤íƒ€ì¼ */
.form-group { margin-bottom:14px; }
.form-group label { display:block; font-size:12px; font-weight:600; color:#94a3b8; margin-bottom:6px; }
.form-input { width:100%; background:#0f172a; border:1px solid #334155; border-radius:8px; padding:10px 14px; color:#e2e8f0; font-size:14px; font-family:inherit; }
.form-input:focus { outline:none; border-color:#a78bfa; }
select.form-input { cursor:pointer; }
textarea.form-input { resize:vertical; min-height:80px; }

/* ë²„íŠ¼ */
.btn { padding:10px 20px; border:none; border-radius:8px; font-size:13px; font-weight:700; cursor:pointer; transition:all .2s; display:inline-flex; align-items:center; gap:6px; font-family:inherit; }
.btn-primary { background:#7c3aed; color:#fff; }
.btn-primary:hover { background:#6d28d9; }
.btn-success { background:#16a34a; color:#fff; }
.btn-success:hover { background:#15803d; }
.btn-danger { background:#dc2626; color:#fff; }
.btn-danger:hover { background:#b91c1c; }
.btn-outline { background:transparent; border:1px solid #475569; color:#94a3b8; }
.btn-outline:hover { background:#334155; color:#fff; }
.btn-sm { padding:6px 12px; font-size:12px; }
.btn-lg { padding:12px 28px; font-size:15px; }

/* ì½˜í…ì¸  ë¦¬ìŠ¤íŠ¸ */
.content-item { background:#0f172a; border:1px solid #334155; border-radius:10px; padding:16px; margin-bottom:10px; transition:all .2s; }
.content-item:hover { border-color:#475569; }
.content-item .ci-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
.content-item .ci-title { font-size:14px; font-weight:700; color:#f1f5f9; }
.content-item .ci-meta { font-size:11px; color:#64748b; display:flex; gap:10px; flex-wrap:wrap; }
.content-item .ci-body { font-size:13px; color:#94a3b8; line-height:1.6; margin-top:8px; }
.content-item .ci-actions { margin-top:10px; display:flex; gap:6px; flex-wrap:wrap; }

/* ìƒíƒœ ë±ƒì§€ */
.badge { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; border-radius:20px; font-size:11px; font-weight:700; }
.badge-draft { background:#1e293b; border:1px solid #475569; color:#94a3b8; }
.badge-approved { background:#052e16; border:1px solid #166534; color:#22c55e; }
.badge-published { background:#172554; border:1px solid #1e40af; color:#3b82f6; }
.badge-failed { background:#450a0a; border:1px solid #991b1b; color:#f87171; }
.badge-platform { background:#2e1065; border:1px solid #6d28d9; color:#a78bfa; }

/* ì£¼ì œ ì¹´ë“œ */
.topic-card { background:#0f172a; border:1px solid #334155; border-radius:10px; padding:14px; margin-bottom:8px; display:flex; align-items:center; gap:12px; }
.topic-card .tc-info { flex:1; }
.topic-card .tc-name { font-size:14px; font-weight:700; color:#f1f5f9; }
.topic-card .tc-keywords { font-size:12px; color:#64748b; margin-top:4px; }
.topic-card .tc-toggle { width:44px; height:24px; border-radius:12px; background:#334155; cursor:pointer; position:relative; transition:all .2s; border:none; }
.topic-card .tc-toggle.on { background:#7c3aed; }
.topic-card .tc-toggle::after { content:''; position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:50%; background:#fff; transition:all .2s; }
.topic-card .tc-toggle.on::after { left:23px; }

/* YouTube ì„¤ì • */
.yt-status { display:flex; align-items:center; gap:8px; padding:12px 16px; border-radius:10px; margin-bottom:16px; }
.yt-status.connected { background:#052e16; border:1px solid #166534; }
.yt-status.disconnected { background:#450a0a; border:1px solid #991b1b; }
.yt-status i { font-size:18px; }

/* ëª¨ë‹¬ */
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:1000; align-items:center; justify-content:center; }
.modal-overlay.show { display:flex; }
.modal-box { background:#1e293b; border:1px solid #334155; border-radius:16px; padding:24px; width:90%; max-width:600px; max-height:85vh; overflow-y:auto; }
.modal-box h3 { font-size:17px; font-weight:800; margin-bottom:16px; color:#f1f5f9; }

/* ë¡œë”© */
.loading-spinner { display:inline-block; width:18px; height:18px; border:3px solid #334155; border-top-color:#a78bfa; border-radius:50%; animation:spin .8s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }

/* ë¹ˆ ìƒíƒœ */
.empty-state { text-align:center; padding:40px; color:#64748b; }
.empty-state i { font-size:40px; margin-bottom:12px; color:#334155; }
.empty-state p { font-size:14px; }

/* ë°˜ì‘í˜• */
@media (max-width:768px) {
    .tab-nav .tab { padding:12px 14px; font-size:12px; }
    .tab-nav .tab span { display:none; }
    .stat-grid { grid-template-columns:repeat(2, 1fr); }
    .main-content { padding:16px; }
}

/* ìƒì„± ì§„í–‰ ìƒíƒœ */
.gen-progress { background:#0f172a; border:1px solid #334155; border-radius:10px; padding:16px; margin-bottom:16px; }
.gen-progress .step { display:flex; align-items:center; gap:10px; padding:6px 0; font-size:13px; color:#64748b; }
.gen-progress .step.active { color:#a78bfa; }
.gen-progress .step.done { color:#22c55e; }
.gen-progress .step i { width:20px; text-align:center; }

/* ë¸”ë¡œê·¸ ë¯¸ë¦¬ë³´ê¸° */
.blog-preview { background:#fff; color:#1e293b; border-radius:12px; padding:24px; }
.blog-preview h2 { font-size:20px; margin-bottom:12px; }
.blog-preview p { line-height:1.8; font-size:14px; color:#475569; }

/* ì›í´ë¦­ ë¸”ë¡œê·¸ ë°œí–‰ */
.upload-dropzone { border:2px dashed #475569; border-radius:12px; padding:40px 20px; text-align:center; cursor:pointer; transition:all .3s; background:#0f172a; }
.upload-dropzone:hover, .upload-dropzone.dragover { border-color:#a78bfa; background:rgba(167,139,250,.08); }
.upload-dropzone i { font-size:36px; color:#64748b; margin-bottom:10px; }
.upload-dropzone p { color:#94a3b8; font-size:13px; }
.upload-dropzone img { max-width:100%; max-height:200px; border-radius:8px; object-fit:cover; }
.oneclick-btn { width:100%; padding:16px; font-size:16px; font-weight:800; background:linear-gradient(135deg,#7c3aed,#a78bfa); color:#fff; border:none; border-radius:12px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition:all .3s; }
.oneclick-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(167,139,250,.3); }
.oneclick-btn:disabled { opacity:.5; cursor:not-allowed; transform:none; box-shadow:none; }
.oneclick-progress { background:#1e293b; border:1px solid #334155; border-radius:12px; padding:16px; margin-top:12px; display:none; }
.oneclick-progress .step { display:flex; align-items:center; gap:10px; padding:6px 0; color:#64748b; font-size:13px; }
.oneclick-progress .step.active { color:#a78bfa; }
.oneclick-progress .step.done { color:#22c55e; }
.oneclick-progress .step i { width:18px; text-align:center; }
.blog-history-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:12px; }
.blog-history-card { background:#0f172a; border:1px solid #334155; border-radius:10px; overflow:hidden; cursor:pointer; transition:all .2s; }
.blog-history-card:hover { border-color:#a78bfa; transform:translateY(-2px); }
.blog-history-card img { width:100%; height:100px; object-fit:cover; }
.blog-history-card .info { padding:10px; }
.blog-history-card .info .title { font-size:12px; font-weight:600; color:#e2e8f0; line-height:1.4; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
.blog-history-card .info .meta { font-size:10px; color:#64748b; margin-top:6px; }
.site-badge { display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; }
.site-badge.kr { background:rgba(59,130,246,.15); color:#60a5fa; }
.site-badge.jp { background:rgba(248,113,113,.15); color:#f87171; }
.site-badge.us { background:rgba(52,211,153,.15); color:#34d399; }

/* Video Pipeline */
.video-canvas-container { position:relative; width:100%; max-width:220px; aspect-ratio:9/16; margin:16px auto; border-radius:12px; overflow:hidden; background:#000; border:2px solid #334155; }
.video-canvas-container canvas { width:100%; height:100%; display:block; }
.video-preview-label { position:absolute; top:8px; left:8px; background:rgba(0,0,0,.7); color:#a78bfa; font-size:10px; font-weight:700; padding:3px 8px; border-radius:4px; z-index:2; }
.pipeline-steps { display:flex; flex-direction:column; gap:2px; margin-top:16px; }
.pipeline-steps .p-step { display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius:8px; font-size:13px; color:#64748b; transition:all .3s; }
.pipeline-steps .p-step.active { color:#a78bfa; background:rgba(167,139,250,.08); }
.pipeline-steps .p-step.done { color:#22c55e; }
.pipeline-steps .p-step.error { color:#f87171; }
.pipeline-steps .p-step i { width:20px; text-align:center; }
.video-meta-preview { background:#0f172a; border:1px solid #334155; border-radius:10px; padding:14px; margin-top:12px; }
.video-meta-preview .meta-title { font-size:14px; font-weight:700; color:#f1f5f9; margin-bottom:8px; }
.video-meta-preview .meta-tags { font-size:12px; color:#a78bfa; margin-top:6px; }
.video-meta-preview .meta-desc { font-size:12px; color:#94a3b8; line-height:1.6; }
</style>
</head>
<body>
<script src="toast.js?v=123"></script>

<!-- ìƒë‹¨ í—¤ë” -->
<div class="top-header">
    <div class="logo" onclick="location.href='global_admin.html'">
        <i class="fa-solid fa-robot"></i> ë§ˆì¼€íŒ… ë´‡
    </div>
    <div style="display:flex; align-items:center; gap:12px;">
        <span class="user-info" id="userInfo">ë¡œë”© ì¤‘...</span>
        <button class="back-btn" onclick="location.href='global_admin.html'"><i class="fa-solid fa-arrow-left"></i> ê´€ë¦¬ì</button>
    </div>
</div>

<!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
<div class="tab-nav">
    <div class="tab active" onclick="switchTab('dashboard',this)"><i class="fa-solid fa-chart-pie"></i> <span>ëŒ€ì‹œë³´ë“œ</span></div>
    <div class="tab" onclick="switchTab('content',this)"><i class="fa-solid fa-file-lines"></i> <span>ì½˜í…ì¸ </span></div>
    <div class="tab" onclick="switchTab('generate',this)"><i class="fa-solid fa-wand-magic-sparkles"></i> <span>AI ìƒì„±</span></div>
    <div class="tab" onclick="switchTab('topics',this)"><i class="fa-solid fa-tags"></i> <span>ì£¼ì œ ì„¤ì •</span></div>
    <div class="tab" onclick="switchTab('youtube',this)"><i class="fa-brands fa-youtube"></i> <span>YouTube</span></div>
    <div class="tab" onclick="switchTab('blog',this)"><i class="fa-solid fa-blog"></i> <span>ë¸”ë¡œê·¸</span></div>
    <div class="tab" onclick="switchTab('settings',this)"><i class="fa-solid fa-gear"></i> <span>ì„¤ì •</span></div>
</div>

<!-- ===== ëŒ€ì‹œë³´ë“œ íƒ­ ===== -->
<div class="main-content">
<div class="tab-panel active" id="panel-dashboard">
    <div class="stat-grid">
        <div class="stat-box"><div class="num" id="statTotal">0</div><div class="label">ì „ì²´ ì½˜í…ì¸ </div></div>
        <div class="stat-box green"><div class="num" id="statPublished">0</div><div class="label">ë°œí–‰ë¨</div></div>
        <div class="stat-box blue"><div class="num" id="statDraft">0</div><div class="label">ëŒ€ê¸°ì¤‘</div></div>
        <div class="stat-box orange"><div class="num" id="statScheduled">0</div><div class="label">ì˜ˆì•½ë¨</div></div>
    </div>

    <div class="card">
        <div class="card-title"><i class="fa-solid fa-clock-rotate-left"></i> ìµœê·¼ ìƒì„± ì½˜í…ì¸ </div>
        <div id="recentContent">
            <div class="empty-state"><i class="fa-solid fa-inbox"></i><p>ì•„ì§ ìƒì„±ëœ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>
        </div>
    </div>

    <div class="card">
        <div class="card-title"><i class="fa-brands fa-youtube"></i> YouTube í™œë™</div>
        <div id="youtubeActivity">
            <div class="empty-state"><i class="fa-solid fa-link-slash"></i><p>YouTube ì±„ë„ì„ ì—°ê²°í•´ì£¼ì„¸ìš”</p></div>
        </div>
    </div>
</div>

<!-- ===== ì½˜í…ì¸  ê´€ë¦¬ íƒ­ ===== -->
<div class="tab-panel" id="panel-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <div style="display:flex; gap:8px;">
            <button class="btn btn-outline btn-sm" onclick="filterContent('all')">ì „ì²´</button>
            <button class="btn btn-outline btn-sm" onclick="filterContent('draft')">ëŒ€ê¸°</button>
            <button class="btn btn-outline btn-sm" onclick="filterContent('approved')">ìŠ¹ì¸</button>
            <button class="btn btn-outline btn-sm" onclick="filterContent('published')">ë°œí–‰</button>
        </div>
        <button class="btn btn-primary btn-sm" onclick="switchTab('generate',document.querySelector('.tab:nth-child(3)'))"><i class="fa-solid fa-plus"></i> ìƒˆ ì½˜í…ì¸ </button>
    </div>
    <div id="contentList">
        <div class="empty-state"><i class="fa-solid fa-folder-open"></i><p>ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤. AI ìƒì„± íƒ­ì—ì„œ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p></div>
    </div>
</div>

<!-- ===== AI ì½˜í…ì¸  ìƒì„± íƒ­ ===== -->
<div class="tab-panel" id="panel-generate">
    <div class="card">
        <div class="card-title"><i class="fa-solid fa-wand-magic-sparkles"></i> AI ì½˜í…ì¸  ìƒì„±</div>

        <div class="form-group">
            <label>í”Œë«í¼ ì„ íƒ</label>
            <select class="form-input" id="genPlatform">
                <option value="youtube_shorts">YouTube Shorts (60ì´ˆ ëŒ€ë³¸)</option>
                <option value="blog">ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸</option>
                <option value="instagram">Instagram ê²Œì‹œë¬¼</option>
                <option value="tiktok">TikTok ëŒ€ë³¸</option>
                <option value="website">ìì‚¬ ì‚¬ì´íŠ¸ ì½˜í…ì¸ </option>
            </select>
        </div>

        <div class="form-group">
            <label>ì£¼ì œ ì„ íƒ (ë˜ëŠ” ì§ì ‘ ì…ë ¥)</label>
            <select class="form-input" id="genTopic">
                <option value="">-- ì €ì¥ëœ ì£¼ì œì—ì„œ ì„ íƒ --</option>
            </select>
        </div>

        <div class="form-group">
            <label>ì»¤ìŠ¤í…€ ì£¼ì œ/í‚¤ì›Œë“œ (ì§ì ‘ ì…ë ¥)</label>
            <input type="text" class="form-input" id="genCustomTopic" placeholder="ì˜ˆ: í—ˆë‹ˆì»´ë³´ë“œ ì¸í…Œë¦¬ì–´ í™œìš©ë²•, ì¹´í˜ í¬í† ì¡´ ë§Œë“¤ê¸°">
        </div>

        <div class="form-group">
            <label>í†¤ & ìŠ¤íƒ€ì¼</label>
            <select class="form-input" id="genTone">
                <option value="professional">ì „ë¬¸ì /ì‹ ë¢°ê°</option>
                <option value="casual">ìºì£¼ì–¼/ì¹œê·¼</option>
                <option value="energetic">ì—ë„ˆì§€/ì—´ì •ì </option>
                <option value="educational">êµìœ¡ì /ì •ë³´ì œê³µ</option>
                <option value="storytelling">ìŠ¤í† ë¦¬í…”ë§</option>
            </select>
        </div>

        <div class="form-group">
            <label>ì–¸ì–´</label>
            <select class="form-input" id="genLang">
                <option value="kr">í•œêµ­ì–´</option>
                <option value="ja">ì¼ë³¸ì–´</option>
                <option value="en">ì˜ì–´</option>
            </select>
        </div>

        <div class="form-group">
            <label>ì¶”ê°€ ì§€ì‹œì‚¬í•­ (ì„ íƒ)</label>
            <textarea class="form-input" id="genInstructions" placeholder="ì˜ˆ: CTAì— cafe2626.com ë§í¬ í¬í•¨, í”„ë¡œëª¨ì…˜ í• ì¸ ì–¸ê¸‰"></textarea>
        </div>

        <button class="btn btn-primary btn-lg" onclick="generateContent()" id="btnGenerate">
            <i class="fa-solid fa-sparkles"></i> AI ì½˜í…ì¸  ìƒì„±
        </button>

        <div id="genProgress" style="display:none; margin-top:16px;">
            <div class="gen-progress">
                <div class="step" id="step1"><i class="fa-solid fa-circle-notch fa-spin"></i> ì£¼ì œ ë¶„ì„ ì¤‘...</div>
                <div class="step" id="step2"><i class="fa-solid fa-circle"></i> ì½˜í…ì¸  ìƒì„± ì¤‘...</div>
                <div class="step" id="step3"><i class="fa-solid fa-circle"></i> í•´ì‹œíƒœê·¸ ìµœì í™”...</div>
                <div class="step" id="step4"><i class="fa-solid fa-circle"></i> ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸ ìƒì„±...</div>
            </div>
        </div>

        <div id="genResult" style="display:none; margin-top:16px;"></div>
    </div>
</div>

<!-- ===== ì£¼ì œ ì„¤ì • íƒ­ ===== -->
<div class="tab-panel" id="panel-topics">
    <div class="card">
        <div class="card-title"><i class="fa-solid fa-plus-circle"></i> ìƒˆ ì£¼ì œ ë“±ë¡</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <input type="text" class="form-input" id="newTopicName" placeholder="ì£¼ì œëª… (ì˜ˆ: ì¹´í˜ ì¸í…Œë¦¬ì–´)" style="flex:1; min-width:200px;">
            <input type="text" class="form-input" id="newTopicKeywords" placeholder="í‚¤ì›Œë“œ (ì½¤ë§ˆ êµ¬ë¶„)" style="flex:1; min-width:200px;">
            <select class="form-input" id="newTopicFreq" style="width:120px;">
                <option value="daily">ë§¤ì¼</option>
                <option value="weekly">ì£¼ 1íšŒ</option>
                <option value="biweekly">ì£¼ 2íšŒ</option>
            </select>
            <button class="btn btn-primary" onclick="addTopic()"><i class="fa-solid fa-plus"></i> ì¶”ê°€</button>
        </div>
    </div>
    <div id="topicList">
        <div class="empty-state"><i class="fa-solid fa-tags"></i><p>ë“±ë¡ëœ ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤</p></div>
    </div>
</div>

<!-- ===== YouTube íƒ­ ===== -->
<div class="tab-panel" id="panel-youtube">
    <div class="card">
        <div class="card-title"><i class="fa-brands fa-youtube"></i> YouTube ì±„ë„ ì—°ê²°</div>
        <div id="ytConnectionStatus" class="yt-status disconnected">
            <i class="fa-solid fa-circle-xmark" style="color:#f87171;"></i>
            <span>YouTube ì±„ë„ì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</span>
        </div>

        <div class="form-group">
            <label>YouTube Data API Key</label>
            <input type="password" class="form-input" id="ytApiKey" placeholder="AIzaSy...">
        </div>
        <div class="form-group">
            <label>OAuth2 Client ID</label>
            <input type="password" class="form-input" id="ytClientId" placeholder="xxxxx.apps.googleusercontent.com">
        </div>
        <div class="form-group">
            <label>OAuth2 Client Secret</label>
            <input type="password" class="form-input" id="ytClientSecret" placeholder="GOCSPX-...">
        </div>
        <div style="display:flex; gap:8px;">
            <button class="btn btn-primary" onclick="saveYoutubeConfig()"><i class="fa-solid fa-floppy-disk"></i> ì €ì¥</button>
            <button class="btn btn-success" onclick="connectYoutube()"><i class="fa-brands fa-google"></i> Google OAuth ì¸ì¦</button>
        </div>
    </div>

    <!-- ì›í´ë¦­ Shorts ìë™ ìƒì„± íŒŒì´í”„ë¼ì¸ -->
    <div class="card">
        <div class="card-title"><i class="fa-solid fa-wand-magic-sparkles"></i> ì›í´ë¦­ Shorts ìƒì„±</div>
        <p style="font-size:13px; color:#94a3b8; margin-bottom:16px;">
            ì‚¬ì§„ ì—…ë¡œë“œ (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥) â†’ AI ë¶„ì„ â†’ ì˜ìƒ ìë™ ìƒì„± â†’ YouTube Shorts ì—…ë¡œë“œ
        </p>

        <div class="upload-dropzone" id="ytShortsDropzone" onclick="document.getElementById('ytShortsPhotoInput').click()">
            <div id="ytShortsDropzoneContent">
                <i class="fa-solid fa-image" style="font-size:36px; color:#475569;"></i>
                <p style="margin-top:8px;">ìƒí’ˆ/ì„œë¹„ìŠ¤ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš” (ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥)</p>
                <p style="font-size:11px; color:#475569; margin-top:4px;">JPG, PNG, WebP (ê° ìµœëŒ€ 5MB) - ì„¸ë¡œ ì‚¬ì§„ ì¶”ì²œ | ì—¬ëŸ¬ ì¥ â†’ ë°°ì¹˜ ìë™ ì²˜ë¦¬</p>
            </div>
        </div>
        <input type="file" id="ytShortsPhotoInput" accept="image/jpeg,image/png,image/webp" multiple style="display:none" onchange="handleShortsPhoto(this)">

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:16px;">
            <div class="form-group" style="margin:0;">
                <label>ì–¸ì–´</label>
                <select class="form-input" id="shortsLang">
                    <option value="kr">í•œêµ­ì–´ (KR)</option>
                    <option value="ja">æ—¥æœ¬èª (JP)</option>
                    <option value="en">English (US)</option>
                </select>
            </div>
            <div class="form-group" style="margin:0;">
                <label>ì˜ìƒ ê¸¸ì´</label>
                <select class="form-input" id="shortsDuration">
                    <option value="15">15ì´ˆ</option>
                    <option value="20" selected>20ì´ˆ (ì¶”ì²œ - TTS ìë™ ì¡°ì ˆ)</option>
                    <option value="30">30ì´ˆ</option>
                </select>
            </div>
        </div>

        <div class="form-group" style="margin-top:12px;">
            <label>ì£¼ì œ (ì„ íƒ - ë¹„ì›Œë‘ë©´ AIê°€ ì´ë¯¸ì§€ì—ì„œ ìë™ ê°ì§€)</label>
            <input type="text" class="form-input" id="shortsTopic" placeholder="ì˜ˆ: í—ˆë‹ˆì½¤ë³´ë“œ ì¹´í˜ ì¸í…Œë¦¬ì–´">
        </div>

        <button class="oneclick-btn" id="shortsOneClickBtn" onclick="generateShortsOneClick()" style="margin-top:16px;">
            <i class="fa-solid fa-rocket"></i> AI Shorts ìƒì„± & YouTube ì—…ë¡œë“œ
        </button>

        <div class="pipeline-steps" id="shortsPipelineSteps" style="display:none;">
            <div class="p-step" id="sp-upload"><i class="fa-solid fa-circle-notch"></i> ì´ë¯¸ì§€ ë¶„ì„ ì¤€ë¹„ ì¤‘...</div>
            <div class="p-step" id="sp-ai"><i class="fa-solid fa-circle-notch"></i> AIê°€ ì½˜í…ì¸  ìƒì„± ì¤‘...</div>
            <div class="p-step" id="sp-tts"><i class="fa-solid fa-circle-notch"></i> AI ìŒì„± ìƒì„± ì¤‘ (OpenAI TTS)...</div>
            <div class="p-step" id="sp-video"><i class="fa-solid fa-circle-notch"></i> ì˜ìƒ + ìŒì„± í•©ì„± ì¤‘...</div>
            <div class="p-step" id="sp-youtube"><i class="fa-solid fa-circle-notch"></i> YouTubeì— ì—…ë¡œë“œ ì¤‘...</div>
        </div>

        <div id="shortsPreviewArea" style="display:none; margin-top:20px;">
            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <div class="video-canvas-container">
                    <div class="video-preview-label">ë¯¸ë¦¬ë³´ê¸°</div>
                    <canvas id="shortsCanvas" width="1080" height="1920"></canvas>
                </div>
                <div style="flex:1; min-width:200px;">
                    <div class="video-meta-preview" id="shortsMetaPreview"></div>
                    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-success btn-sm" onclick="confirmAndUpload()"><i class="fa-brands fa-youtube"></i> ì—…ë¡œë“œ í™•ì¸</button>
                        <button class="btn btn-outline btn-sm" onclick="cancelPipeline()"><i class="fa-solid fa-xmark"></i> ì·¨ì†Œ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìˆ˜ë™ MP4 ì—…ë¡œë“œ (ì ‘íŒ ìƒíƒœ) -->
    <div class="card">
        <div class="card-title" style="cursor:pointer;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'">
            <i class="fa-solid fa-upload"></i> ìˆ˜ë™ ì—…ë¡œë“œ (MP4 íŒŒì¼)
            <i class="fa-solid fa-chevron-down" style="margin-left:auto; font-size:11px; color:#64748b;"></i>
        </div>
        <div style="display:none;">
            <div class="form-group"><label>ì˜ìƒ íŒŒì¼ (MP4, 60ì´ˆ ì´í•˜)</label><input type="file" class="form-input" id="ytVideoFile" accept="video/mp4"></div>
            <div class="form-group"><label>ì œëª©</label><input type="text" class="form-input" id="ytVideoTitle" placeholder="ì˜ìƒ ì œëª©"></div>
            <div class="form-group"><label>ì„¤ëª…</label><textarea class="form-input" id="ytVideoDesc" placeholder="ì˜ìƒ ì„¤ëª…"></textarea></div>
            <div class="form-group"><label>íƒœê·¸ (ì½¤ë§ˆ êµ¬ë¶„)</label><input type="text" class="form-input" id="ytVideoTags" placeholder="ì¸í…Œë¦¬ì–´,ê°„íŒ,í¬í† ì¡´"></div>
            <button class="btn btn-danger" onclick="uploadToYoutube()"><i class="fa-brands fa-youtube"></i> YouTube ì—…ë¡œë“œ</button>
            <div id="uploadProgress" style="display:none; margin-top:12px;"></div>
        </div>
    </div>

    <div class="card">
        <div class="card-title"><i class="fa-solid fa-reply"></i> ëŒ“ê¸€ ìë™ ë‹µê¸€</div>
        <div class="form-group">
            <label>ìë™ ë‹µê¸€ í™œì„±í™”</label>
            <div style="display:flex; align-items:center; gap:12px;">
                <button class="tc-toggle" id="autoReplyToggle" onclick="toggleAutoReply()"></button>
                <span id="autoReplyStatus" style="font-size:13px; color:#64748b;">ë¹„í™œì„±</span>
            </div>
        </div>
        <div class="form-group">
            <label>ë‹µê¸€ í…œí”Œë¦¿</label>
            <textarea class="form-input" id="autoReplyTemplate" placeholder="ê°ì‚¬í•©ë‹ˆë‹¤! ë” ê¶ê¸ˆí•œ ì ì€ cafe2626.comì„ ë°©ë¬¸í•´ì£¼ì„¸ìš” ğŸ˜Š"></textarea>
            <div style="font-size:11px; color:#64748b; margin-top:4px;">
                ë³€ìˆ˜: {commenter} = ëŒ“ê¸€ ì‘ì„±ì, {video_title} = ì˜ìƒ ì œëª©
            </div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="saveAutoReply()"><i class="fa-solid fa-save"></i> ë‹µê¸€ ì„¤ì • ì €ì¥</button>

        <div style="margin-top:16px;">
            <div class="card-title"><i class="fa-solid fa-clock-rotate-left"></i> ìµœê·¼ ìë™ ë‹µê¸€</div>
            <div id="replyLog">
                <div class="empty-state" style="padding:20px;"><p>ì•„ì§ ìë™ ë‹µê¸€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p></div>
            </div>
        </div>
    </div>
</div>

<!-- ===== ë¸”ë¡œê·¸ íƒ­ (ì›í´ë¦­ ë°œí–‰) ===== -->
<div class="tab-panel" id="panel-blog">
    <div class="card">
        <div class="card-title"><i class="fa-solid fa-bolt"></i> ì›í´ë¦­ ë¸”ë¡œê·¸ ë°œí–‰</div>
        <p style="font-size:13px; color:#94a3b8; margin-bottom:16px;">
            ì‚¬ì§„ ì—…ë¡œë“œ â†’ AIê°€ <strong style="color:#a78bfa;">í•œêµ­ì–´/æ—¥æœ¬èª/English/ä¸­æ–‡/Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©/EspaÃ±ol/Deutsch/FranÃ§ais</strong> 8ê°œêµ­ì–´ ë¸”ë¡œê·¸ ìë™ ì‘ì„± â†’ ë™ì‹œ ê²Œì‹œ (SEO ìµœì í™”)
        </p>

        <!-- ì‚¬ì§„ ì—…ë¡œë“œ -->
        <div class="upload-dropzone" id="blogDropzone" onclick="document.getElementById('blogPhotoInput').click()">
            <div id="blogDropzoneContent">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <p>í´ë¦­ ë˜ëŠ” ì‚¬ì§„ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš” (ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥)</p>
                <p style="font-size:11px; color:#475569; margin-top:4px;">JPG, PNG, WebP (ê° ìµœëŒ€ 5MB) | ì‚¬ì§„ 1ì¥ â†’ 8ê°œêµ­ì–´ ë¸”ë¡œê·¸ ìë™ ìƒì„±</p>
            </div>
        </div>
        <input type="file" id="blogPhotoInput" accept="image/jpeg,image/png,image/webp" multiple style="display:none" onchange="handleBlogPhoto(this)">

        <!-- ì£¼ì œ -->
        <div style="margin-top:16px;">
            <div class="form-group" style="margin:0;">
                <label>ì£¼ì œ (ì„ íƒì‚¬í•­ - ë¹„ìš°ë©´ AIê°€ ì‚¬ì§„ì—ì„œ ìë™ ê°ì§€)</label>
                <input type="text" class="form-input" id="blogTopic" placeholder="ì˜ˆ: í—ˆë‹ˆì»´ë³´ë“œë¡œ ì¹´í˜ ì¸í…Œë¦¬ì–´ ê¾¸ë¯¸ê¸°">
            </div>
        </div>
        <div style="font-size:12px; color:#64748b; margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <span>ê²Œì‹œ ëŒ€ìƒ:</span>
            <span style="background:#1e293b; padding:3px 8px; border-radius:4px; color:#60a5fa; font-weight:600; font-size:11px;">KR í•œêµ­ì–´</span>
            <span style="background:#1e293b; padding:3px 8px; border-radius:4px; color:#f472b6; font-weight:600; font-size:11px;">JP æ—¥æœ¬èª</span>
            <span style="background:#1e293b; padding:3px 8px; border-radius:4px; color:#34d399; font-weight:600; font-size:11px;">US English</span>
            <span style="background:#1e293b; padding:3px 8px; border-radius:4px; color:#ef4444; font-weight:600; font-size:11px;">CN ä¸­æ–‡</span>
            <span style="background:#1e293b; padding:3px 8px; border-radius:4px; color:#f59e0b; font-weight:600; font-size:11px;">AR Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>
            <span style="background:#1e293b; padding:3px 8px; border-radius:4px; color:#a855f7; font-weight:600; font-size:11px;">ES EspaÃ±ol</span>
            <span style="background:#1e293b; padding:3px 8px; border-radius:4px; color:#eab308; font-weight:600; font-size:11px;">DE Deutsch</span>
            <span style="background:#1e293b; padding:3px 8px; border-radius:4px; color:#3b82f6; font-weight:600; font-size:11px;">FR FranÃ§ais</span>
        </div>

        <!-- ì›í´ë¦­ ë²„íŠ¼ -->
        <button class="oneclick-btn" id="blogOneClickBtn" onclick="publishBlogOneClick()" style="margin-top:20px;">
            <i class="fa-solid fa-rocket"></i> AI ìƒì„± & 8ê°œêµ­ì–´ ë¸”ë¡œê·¸ ë°œí–‰
        </button>

        <!-- ì§„í–‰ ìƒí™© -->
        <div class="oneclick-progress" id="blogProgress">
            <div class="step" id="step-upload"><i class="fa-solid fa-circle-notch fa-spin"></i> ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘...</div>
            <div class="step" id="step-ai-kr"><i class="fa-solid fa-circle-notch fa-spin"></i> í•œêµ­ì–´ ë¸”ë¡œê·¸ ìƒì„± ì¤‘...</div>
            <div class="step" id="step-ai-ja"><i class="fa-solid fa-circle-notch fa-spin"></i> æ—¥æœ¬èª ë¸”ë¡œê·¸ ìƒì„± ì¤‘...</div>
            <div class="step" id="step-ai-en"><i class="fa-solid fa-circle-notch fa-spin"></i> English ë¸”ë¡œê·¸ ìƒì„± ì¤‘...</div>
            <div class="step" id="step-ai-cn"><i class="fa-solid fa-circle-notch fa-spin"></i> ä¸­æ–‡ ë¸”ë¡œê·¸ ìƒì„± ì¤‘...</div>
            <div class="step" id="step-ai-ar"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ë¸”ë¡œê·¸ ìƒì„± ì¤‘...</div>
            <div class="step" id="step-ai-es"><i class="fa-solid fa-circle-notch fa-spin"></i> EspaÃ±ol ë¸”ë¡œê·¸ ìƒì„± ì¤‘...</div>
            <div class="step" id="step-ai-de"><i class="fa-solid fa-circle-notch fa-spin"></i> Deutsch ë¸”ë¡œê·¸ ìƒì„± ì¤‘...</div>
            <div class="step" id="step-ai-fr"><i class="fa-solid fa-circle-notch fa-spin"></i> FranÃ§ais ë¸”ë¡œê·¸ ìƒì„± ì¤‘...</div>
            <div class="step" id="step-publish"><i class="fa-solid fa-circle-notch fa-spin"></i> 8ê°œêµ­ì–´ ê²Œì‹œ ì¤‘...</div>
        </div>
    </div>

    <!-- ë¯¸ë¦¬ë³´ê¸° -->
    <div class="card" id="blogPreviewCard" style="display:none;">
        <div class="card-title"><i class="fa-solid fa-eye"></i> ë°œí–‰ ì™„ë£Œ ë¯¸ë¦¬ë³´ê¸°</div>
        <div class="blog-preview" id="blogPreview"></div>
        <div style="margin-top:12px; display:flex; gap:6px; flex-wrap:wrap;">
            <a id="blogViewLinkKR" href="#" target="_blank" class="btn" style="background:#2563eb; color:#fff; padding:6px 10px; border-radius:6px; font-size:11px; font-weight:600; text-decoration:none;">
                <i class="fa-solid fa-external-link-alt"></i> KR
            </a>
            <a id="blogViewLinkJP" href="#" target="_blank" class="btn" style="background:#db2777; color:#fff; padding:6px 10px; border-radius:6px; font-size:11px; font-weight:600; text-decoration:none;">
                <i class="fa-solid fa-external-link-alt"></i> JP
            </a>
            <a id="blogViewLinkEN" href="#" target="_blank" class="btn" style="background:#059669; color:#fff; padding:6px 10px; border-radius:6px; font-size:11px; font-weight:600; text-decoration:none;">
                <i class="fa-solid fa-external-link-alt"></i> EN
            </a>
            <a id="blogViewLinkCN" href="#" target="_blank" class="btn" style="background:#dc2626; color:#fff; padding:6px 10px; border-radius:6px; font-size:11px; font-weight:600; text-decoration:none;">
                <i class="fa-solid fa-external-link-alt"></i> CN
            </a>
            <a id="blogViewLinkAR" href="#" target="_blank" class="btn" style="background:#d97706; color:#fff; padding:6px 10px; border-radius:6px; font-size:11px; font-weight:600; text-decoration:none;">
                <i class="fa-solid fa-external-link-alt"></i> AR
            </a>
            <a id="blogViewLinkES" href="#" target="_blank" class="btn" style="background:#7c3aed; color:#fff; padding:6px 10px; border-radius:6px; font-size:11px; font-weight:600; text-decoration:none;">
                <i class="fa-solid fa-external-link-alt"></i> ES
            </a>
            <a id="blogViewLinkDE" href="#" target="_blank" class="btn" style="background:#ca8a04; color:#fff; padding:6px 10px; border-radius:6px; font-size:11px; font-weight:600; text-decoration:none;">
                <i class="fa-solid fa-external-link-alt"></i> DE
            </a>
            <a id="blogViewLinkFR" href="#" target="_blank" class="btn" style="background:#2563eb; color:#fff; padding:6px 10px; border-radius:6px; font-size:11px; font-weight:600; text-decoration:none;">
                <i class="fa-solid fa-external-link-alt"></i> FR
            </a>
        </div>
    </div>

    <!-- ìµœê·¼ ë°œí–‰ ì´ë ¥ -->
    <div class="card">
        <div class="card-title"><i class="fa-solid fa-clock-rotate-left"></i> ìµœê·¼ ë°œí–‰ëœ ë¸”ë¡œê·¸</div>
        <div id="blogHistoryGrid" class="blog-history-grid">
            <div class="empty-state" style="grid-column:1/-1;"><i class="fa-solid fa-newspaper"></i><p>ì•„ì§ ë°œí–‰ëœ ë¸”ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>
        </div>
    </div>
</div>

<!-- ===== ì„¤ì • íƒ­ ===== -->
<div class="tab-panel" id="panel-settings">
    <div class="card">
        <div class="card-title"><i class="fa-solid fa-globe"></i> ì‚¬ì´íŠ¸ ì •ë³´</div>
        <div class="form-group">
            <label>íšŒì‚¬/ë¸Œëœë“œëª…</label>
            <input type="text" class="form-input" id="setBrandName" value="ì¹´ë©œë ˆì˜¨ í”„ë¦°íŠ¸">
        </div>
        <div class="form-group">
            <label>ì‚¬ì´íŠ¸ URL (KR)</label>
            <input type="text" class="form-input" id="setSiteKr" value="https://cafe2626.com">
        </div>
        <div class="form-group">
            <label>ì‚¬ì´íŠ¸ URL (JP)</label>
            <input type="text" class="form-input" id="setSiteJp" value="https://cafe0101.com">
        </div>
        <div class="form-group">
            <label>ì‚¬ì´íŠ¸ URL (US)</label>
            <input type="text" class="form-input" id="setSiteUs" value="https://cafe3355.com">
        </div>
    </div>

    <div class="card">
        <div class="card-title"><i class="fa-solid fa-bullseye"></i> ë§ˆì¼€íŒ… í¬ì¸íŠ¸</div>
        <div class="form-group">
            <label>í•µì‹¬ í‚¤ì›Œë“œ (ì „ì²´ ì½˜í…ì¸ ì— ë°˜ì˜)</label>
            <input type="text" class="form-input" id="setCoreKeywords" value="í—ˆë‹ˆì»´ë³´ë“œ,íŒ¨ë¸Œë¦­ì¸ì‡„,í¬í† ì¡´,ë“±ì‹ ëŒ€,ì¹´í˜ì¸í…Œë¦¬ì–´,ì¹œí™˜ê²½ì¸ì‡„">
        </div>
        <div class="form-group">
            <label>USP (í•µì‹¬ ê°•ì )</label>
            <textarea class="form-input" id="setUsp">ì¹œí™˜ê²½ ì¢…ì´ í—ˆë‹ˆì»´ë³´ë“œ ì „ë¬¸, ë¬´ë£Œ ì˜¨ë¼ì¸ ë””ìì¸ ì—ë””í„°, ì „êµ­ ë‹¹ì¼ë°°ì†¡, í¬í† ì¡´/ë“±ì‹ ëŒ€/ë°°ë„ˆ ì „ë¬¸ ì¸ì‡„</textarea>
        </div>
        <div class="form-group">
            <label>CTA ë©”ì‹œì§€</label>
            <input type="text" class="form-input" id="setCtaMsg" value="ì§€ê¸ˆ ë°”ë¡œ ë¬´ë£Œ ë””ìì¸ ì‹œì‘í•˜ê¸° â†’ cafe2626.com">
        </div>
        <button class="btn btn-primary" onclick="saveSettings()"><i class="fa-solid fa-save"></i> ì„¤ì • ì €ì¥</button>
    </div>
</div>

</div><!-- /main-content -->

<!-- ì½˜í…ì¸  ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal-overlay" id="contentDetailModal">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h3 id="modalTitle">ì½˜í…ì¸  ìƒì„¸</h3>
            <button class="btn btn-outline btn-sm" onclick="closeModal('contentDetailModal')"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="modalBody"></div>
        <div style="margin-top:16px; display:flex; gap:8px; justify-content:flex-end;" id="modalActions"></div>
    </div>
</div>

<script type="module">
import { initConfig, sb as _sb, currentUser, isAdmin } from './config.js?v=123';

let sb;
const SUPABASE_URL = 'https://qinvtnhiidtmrzosyvys.supabase.co';

// ===== ì´ˆê¸°í™” =====
(async function init() {
    await initConfig();
    sb = window.sb || _sb;
    if (!sb) { showToast('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨', 'error'); return; }

    const { data: { user } } = await sb.auth.getUser();
    if (!user) { location.href = 'index.html'; return; }

    document.getElementById('userInfo').innerText = user.email;

    // ê´€ë¦¬ì í™•ì¸
    const adminEmails = ['korea900as@gmail.com', 'ceo@test.com'];
    if (!adminEmails.includes(user.email)) {
        showToast('ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
        location.href = 'index.html';
        return;
    }

    // OAuth ì½œë°± ì²˜ë¦¬ (sb ì´ˆê¸°í™” í›„ ì‹¤í–‰)
    handleOAuthCallback();

    // ë°ì´í„° ë¡œë“œ
    loadDashboard();
    loadTopics();
    loadYoutubeConfig();
})();

// ===== íƒ­ ì „í™˜ =====
window.switchTab = function(tabId, el) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('panel-' + tabId).classList.add('active');
    if (el) el.classList.add('active');

    if (tabId === 'dashboard') loadDashboard();
    if (tabId === 'content') loadContentList();
    if (tabId === 'topics') loadTopics();
    if (tabId === 'blog') loadBlogHistory();
};

// ===== ëŒ€ì‹œë³´ë“œ =====
async function loadDashboard() {
    try {
        const { data: contents } = await sb.from('marketing_content').select('id, status, platform, title, created_at').order('created_at', { ascending: false }).limit(50);
        if (!contents) return;

        document.getElementById('statTotal').innerText = contents.length;
        document.getElementById('statPublished').innerText = contents.filter(c => c.status === 'published').length;
        document.getElementById('statDraft').innerText = contents.filter(c => c.status === 'draft' || c.status === 'approved').length;
        document.getElementById('statScheduled').innerText = contents.filter(c => c.status === 'scheduled').length;

        // ìµœê·¼ ì½˜í…ì¸ 
        const recent = contents.slice(0, 5);
        if (recent.length === 0) return;

        const platformIcon = { youtube_shorts: 'fa-brands fa-youtube', blog: 'fa-solid fa-blog', instagram: 'fa-brands fa-instagram', tiktok: 'fa-brands fa-tiktok', website: 'fa-solid fa-globe' };
        const platformName = { youtube_shorts: 'YouTube Shorts', blog: 'ë¸”ë¡œê·¸', instagram: 'Instagram', tiktok: 'TikTok', website: 'ì‚¬ì´íŠ¸' };

        let html = '';
        recent.forEach(c => {
            const date = new Date(c.created_at).toLocaleDateString('ko-KR');
            html += `<div class="content-item" onclick="viewContent(${c.id})" style="cursor:pointer;">
                <div class="ci-header">
                    <div class="ci-title">${c.title || '(ì œëª© ì—†ìŒ)'}</div>
                    <span class="badge badge-${c.status}">${c.status}</span>
                </div>
                <div class="ci-meta">
                    <span><i class="${platformIcon[c.platform] || 'fa-solid fa-file'}"></i> ${platformName[c.platform] || c.platform}</span>
                    <span>${date}</span>
                </div>
            </div>`;
        });
        document.getElementById('recentContent').innerHTML = html;
    } catch(e) { console.error('Dashboard error:', e); }
}

// ===== ì½˜í…ì¸  ëª©ë¡ =====
let contentFilter = 'all';
window.filterContent = function(f) { contentFilter = f; loadContentList(); };

async function loadContentList() {
    const container = document.getElementById('contentList');
    container.innerHTML = '<div style="text-align:center; padding:20px;"><div class="loading-spinner"></div></div>';

    let query = sb.from('marketing_content').select('*').order('created_at', { ascending: false });
    if (contentFilter !== 'all') query = query.eq('status', contentFilter);

    const { data } = await query.limit(50);
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fa-solid fa-folder-open"></i><p>ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
    }

    const platformIcon = { youtube_shorts: 'fa-brands fa-youtube', blog: 'fa-solid fa-blog', instagram: 'fa-brands fa-instagram', tiktok: 'fa-brands fa-tiktok', website: 'fa-solid fa-globe' };

    let html = '';
    data.forEach(c => {
        const date = new Date(c.created_at).toLocaleDateString('ko-KR');
        const body = (c.body || c.short_script || '').substring(0, 120);
        const tags = (c.hashtags || []).slice(0, 5).map(t => `#${t}`).join(' ');
        html += `<div class="content-item">
            <div class="ci-header">
                <div>
                    <div class="ci-title">${c.title || '(ì œëª© ì—†ìŒ)'}</div>
                    <div class="ci-meta">
                        <span><i class="${platformIcon[c.platform] || 'fa-solid fa-file'}"></i> ${c.platform}</span>
                        <span>${date}</span>
                        ${tags ? '<span style="color:#a78bfa;">'+tags+'</span>' : ''}
                    </div>
                </div>
                <span class="badge badge-${c.status}">${c.status}</span>
            </div>
            <div class="ci-body">${body}${body.length >= 120 ? '...' : ''}</div>
            <div class="ci-actions">
                <button class="btn btn-outline btn-sm" onclick="viewContent(${c.id})"><i class="fa-solid fa-eye"></i> ë³´ê¸°</button>
                ${c.status === 'draft' ? '<button class="btn btn-success btn-sm" onclick="approveContent('+c.id+')"><i class="fa-solid fa-check"></i> ìŠ¹ì¸</button>' : ''}
                ${c.status === 'approved' ? '<button class="btn btn-primary btn-sm" onclick="publishContent('+c.id+')"><i class="fa-solid fa-paper-plane"></i> ë°œí–‰</button>' : ''}
                <button class="btn btn-outline btn-sm" onclick="copyContent(${c.id})"><i class="fa-solid fa-copy"></i> ë³µì‚¬</button>
                <button class="btn btn-danger btn-sm" onclick="deleteContent(${c.id})"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>`;
    });
    container.innerHTML = html;
}

// ===== AI ì½˜í…ì¸  ìƒì„± =====
window.generateContent = async function() {
    const platform = document.getElementById('genPlatform').value;
    const topicSelect = document.getElementById('genTopic').value;
    const customTopic = document.getElementById('genCustomTopic').value.trim();
    const tone = document.getElementById('genTone').value;
    const lang = document.getElementById('genLang').value;
    const instructions = document.getElementById('genInstructions').value.trim();

    const topic = customTopic || topicSelect;
    if (!topic) { showToast('ì£¼ì œë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”', 'warn'); return; }

    const btn = document.getElementById('btnGenerate');
    const progress = document.getElementById('genProgress');
    const result = document.getElementById('genResult');

    btn.disabled = true;
    btn.innerHTML = '<div class="loading-spinner"></div> ìƒì„± ì¤‘...';
    progress.style.display = 'block';
    result.style.display = 'none';

    // ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    const coreKeywords = document.getElementById('setCoreKeywords')?.value || '';
    const usp = document.getElementById('setUsp')?.value || '';
    const ctaMsg = document.getElementById('setCtaMsg')?.value || '';

    try {
        // Step 1
        updateStep(1, 'active');

        const { data, error } = await sb.functions.invoke('marketing-content', {
            body: { platform, topic, tone, lang, instructions, coreKeywords, usp, ctaMsg }
        });

        if (error) throw error;

        updateStep(1, 'done');
        updateStep(2, 'done');
        updateStep(3, 'done');
        updateStep(4, 'done');

        if (data && data.content) {
            const content = data.content;

            // DBì— ì €ì¥
            const { data: saved, error: saveErr } = await sb.from('marketing_content').insert({
                topic_id: topicSelect ? parseInt(topicSelect) : null,
                platform: platform,
                title: content.title || '',
                body: content.body || '',
                short_script: content.short_script || '',
                hashtags: content.hashtags || [],
                thumbnail_prompt: content.thumbnail_prompt || '',
                status: 'draft'
            }).select().single();

            if (saveErr) console.error('Save error:', saveErr);

            // ê²°ê³¼ í‘œì‹œ
            result.style.display = 'block';
            result.innerHTML = renderGeneratedContent(content, saved?.id);
        }
    } catch(e) {
        console.error('Generate error:', e);
        result.style.display = 'block';
        result.innerHTML = `<div class="card" style="border-color:#991b1b;"><div class="card-title" style="color:#f87171;"><i class="fa-solid fa-circle-exclamation"></i> ìƒì„± ì‹¤íŒ¨</div><p style="color:#94a3b8; font-size:13px;">${e.message || e}</p></div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-sparkles"></i> AI ì½˜í…ì¸  ìƒì„±';
    }
};

function updateStep(num, state) {
    const el = document.getElementById('step' + num);
    el.className = 'step ' + state;
    if (state === 'active') el.querySelector('i').className = 'fa-solid fa-circle-notch fa-spin';
    if (state === 'done') el.querySelector('i').className = 'fa-solid fa-circle-check';
}

function renderGeneratedContent(content, savedId) {
    return `<div class="card" style="border-color:#166534;">
        <div class="card-title" style="color:#22c55e;"><i class="fa-solid fa-check-circle"></i> ì½˜í…ì¸  ìƒì„± ì™„ë£Œ!</div>
        <div class="form-group"><label>ì œëª©</label><div style="font-size:16px; font-weight:700; color:#f1f5f9;">${content.title || ''}</div></div>
        ${content.short_script ? `<div class="form-group"><label>ìˆì¸  ëŒ€ë³¸ (60ì´ˆ)</label><div style="background:#0f172a; padding:12px; border-radius:8px; font-size:13px; line-height:1.8; color:#e2e8f0; white-space:pre-wrap;">${content.short_script}</div></div>` : ''}
        ${content.body ? `<div class="form-group"><label>ë³¸ë¬¸</label><div style="background:#0f172a; padding:12px; border-radius:8px; font-size:13px; line-height:1.8; color:#e2e8f0; white-space:pre-wrap;">${content.body}</div></div>` : ''}
        ${content.hashtags && content.hashtags.length ? `<div class="form-group"><label>í•´ì‹œíƒœê·¸</label><div style="color:#a78bfa; font-size:13px;">${content.hashtags.map(t => '#'+t).join(' ')}</div></div>` : ''}
        ${content.thumbnail_prompt ? `<div class="form-group"><label>ì¸ë„¤ì¼ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸</label><div style="background:#0f172a; padding:12px; border-radius:8px; font-size:12px; color:#94a3b8;">${content.thumbnail_prompt}</div></div>` : ''}
        <div style="display:flex; gap:8px; margin-top:12px;">
            ${savedId ? `<button class="btn btn-success" onclick="approveContent(${savedId})"><i class="fa-solid fa-check"></i> ìŠ¹ì¸</button>` : ''}
            <button class="btn btn-outline" onclick="switchTab('content',document.querySelector('.tab:nth-child(2)'))"><i class="fa-solid fa-list"></i> ì½˜í…ì¸  ëª©ë¡</button>
        </div>
    </div>`;
}

// ===== ì½˜í…ì¸  ì•¡ì…˜ =====
window.viewContent = async function(id) {
    const { data } = await sb.from('marketing_content').select('*').eq('id', id).single();
    if (!data) return;

    document.getElementById('modalTitle').innerText = data.title || '(ì œëª© ì—†ìŒ)';
    let html = '';
    if (data.short_script) html += `<div class="form-group"><label>ìˆì¸  ëŒ€ë³¸</label><div style="background:#0f172a; padding:12px; border-radius:8px; font-size:13px; line-height:1.8; white-space:pre-wrap;">${data.short_script}</div></div>`;
    if (data.body) html += `<div class="form-group"><label>ë³¸ë¬¸</label><div style="background:#0f172a; padding:12px; border-radius:8px; font-size:13px; line-height:1.8; white-space:pre-wrap;">${data.body}</div></div>`;
    if (data.hashtags?.length) html += `<div class="form-group"><label>í•´ì‹œíƒœê·¸</label><div style="color:#a78bfa;">${data.hashtags.map(t=>'#'+t).join(' ')}</div></div>`;
    if (data.thumbnail_prompt) html += `<div class="form-group"><label>ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸</label><div style="font-size:12px; color:#94a3b8;">${data.thumbnail_prompt}</div></div>`;
    html += `<div style="font-size:12px; color:#64748b; margin-top:8px;">ìƒíƒœ: <span class="badge badge-${data.status}">${data.status}</span> | ìƒì„±: ${new Date(data.created_at).toLocaleString('ko-KR')}</div>`;

    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalActions').innerHTML = `
        ${data.status === 'draft' ? '<button class="btn btn-success" onclick="approveContent('+id+'); closeModal(\'contentDetailModal\');"><i class="fa-solid fa-check"></i> ìŠ¹ì¸</button>' : ''}
        ${data.status === 'approved' ? '<button class="btn btn-primary" onclick="publishContent('+id+'); closeModal(\'contentDetailModal\');"><i class="fa-solid fa-paper-plane"></i> ë°œí–‰</button>' : ''}
        <button class="btn btn-outline" onclick="closeModal('contentDetailModal')">ë‹«ê¸°</button>`;
    document.getElementById('contentDetailModal').classList.add('show');
};

window.approveContent = async function(id) {
    await sb.from('marketing_content').update({ status: 'approved' }).eq('id', id);
    loadContentList();
    loadDashboard();
};

window.publishContent = async function(id) {
    const { data } = await sb.from('marketing_content').select('*').eq('id', id).single();
    if (!data) return;

    if (data.platform === 'blog' || data.platform === 'website') {
        // ë¸”ë¡œê·¸/ì‚¬ì´íŠ¸: community_postsì— ì‹¤ì œ ê²Œì‹œ + marketing_content ìƒíƒœ ì—…ë°ì´íŠ¸
        try {
            const { data: { user } } = await sb.auth.getUser();
            const authorName = user?.user_metadata?.full_name || user?.email?.split('@')[0] || 'ì¹´ë©œë ˆì˜¨';

            // ë§ˆí¬ë‹¤ìš´ â†’ HTML ê°„ë‹¨ ë³€í™˜
            let htmlBody = (data.body || '')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/## (.*)/g, '<h2>$1</h2>')
                .replace(/### (.*)/g, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            htmlBody = '<p>' + htmlBody + '</p>';

            // KR ë¸”ë¡œê·¸ì— ê²Œì‹œ
            await sb.from('community_posts').insert({
                category: 'blog',
                country_code: 'KR',
                title: data.title || '(ì œëª© ì—†ìŒ)',
                content: htmlBody,
                author_name: authorName,
                author_email: user?.email || '',
                author_id: user?.id || null,
                thumbnail: data.thumbnail_url || null
            });

            await sb.from('marketing_content').update({
                status: 'published',
                published_at: new Date().toISOString()
            }).eq('id', id);

            showToast('ë¸”ë¡œê·¸ì— ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤! board.html?cat=blog ì—ì„œ í™•ì¸í•˜ì„¸ìš”.', 'success');
        } catch(e) {
            console.error('Blog publish error:', e);
            showToast('ë¸”ë¡œê·¸ ê²Œì‹œ ì‹¤íŒ¨: ' + e.message, 'error');
        }
    } else if (data.platform === 'youtube_shorts') {
        // YouTube: ì—…ë¡œë“œ íƒ­ìœ¼ë¡œ ì´ë™í•˜ê³  ë°ì´í„° ì±„ìš°ê¸°
        switchTab('youtube', document.querySelector('.tab:nth-child(5)'));
        if (data.title) document.getElementById('ytVideoTitle').value = data.title;
        if (data.body || data.short_script) document.getElementById('ytVideoDesc').value = data.body || data.short_script;
        if (data.hashtags?.length) document.getElementById('ytVideoTags').value = data.hashtags.join(',');
        showToast('YouTube íƒ­ì— ì½˜í…ì¸ ê°€ ì±„ì›Œì¡ŒìŠµë‹ˆë‹¤. ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•˜ê³  ì—…ë¡œë“œí•˜ì„¸ìš”.', 'info');
    } else {
        // Instagram/TikTok: ì½˜í…ì¸  ë³µì‚¬
        const text = `${data.title}\n\n${data.body || data.short_script || ''}\n\n${(data.hashtags || []).map(t=>'#'+t).join(' ')}`;
        await navigator.clipboard.writeText(text);
        await sb.from('marketing_content').update({ status: 'published', published_at: new Date().toISOString() }).eq('id', id);
        showToast('ì½˜í…ì¸ ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! Instagram/TikTokì— ì§ì ‘ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.', 'success');
    }
    loadContentList();
    loadDashboard();
};

window.copyContent = async function(id) {
    const { data } = await sb.from('marketing_content').select('*').eq('id', id).single();
    if (!data) return;
    const text = `${data.title || ''}\n\n${data.body || data.short_script || ''}\n\n${(data.hashtags || []).map(t=>'#'+t).join(' ')}`;
    await navigator.clipboard.writeText(text);
    showToast('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
};

window.deleteContent = async function(id) {
    if (!confirm('ì´ ì½˜í…ì¸ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    await sb.from('marketing_content').delete().eq('id', id);
    loadContentList();
    loadDashboard();
};

window.closeModal = function(id) { document.getElementById(id).classList.remove('show'); };

// ===== ì£¼ì œ ê´€ë¦¬ =====
async function loadTopics() {
    const { data } = await sb.from('marketing_topics').select('*').order('created_at', { ascending: false });
    const container = document.getElementById('topicList');
    const select = document.getElementById('genTopic');

    // ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    if (select) {
        select.innerHTML = '<option value="">-- ì €ì¥ëœ ì£¼ì œì—ì„œ ì„ íƒ --</option>';
        (data || []).forEach(t => {
            select.innerHTML += `<option value="${t.id}">${t.topic}</option>`;
        });
    }

    if (!data || data.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fa-solid fa-tags"></i><p>ë“±ë¡ëœ ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
    }

    let html = '';
    data.forEach(t => {
        const kw = (t.keywords || []).join(', ');
        html += `<div class="topic-card">
            <div class="tc-info">
                <div class="tc-name">${t.topic}</div>
                <div class="tc-keywords">${kw} | ${t.frequency || 'daily'}</div>
            </div>
            <button class="tc-toggle ${t.is_active ? 'on' : ''}" onclick="toggleTopic(${t.id}, ${!t.is_active})"></button>
            <button class="btn btn-danger btn-sm" onclick="deleteTopic(${t.id})" style="margin-left:6px;"><i class="fa-solid fa-trash"></i></button>
        </div>`;
    });
    container.innerHTML = html;
}

window.addTopic = async function() {
    const name = document.getElementById('newTopicName').value.trim();
    const keywords = document.getElementById('newTopicKeywords').value.split(',').map(k => k.trim()).filter(Boolean);
    const freq = document.getElementById('newTopicFreq').value;
    if (!name) { showToast('ì£¼ì œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warn'); return; }

    await sb.from('marketing_topics').insert({ topic: name, keywords, frequency: freq });
    document.getElementById('newTopicName').value = '';
    document.getElementById('newTopicKeywords').value = '';
    loadTopics();
};

window.toggleTopic = async function(id, active) {
    await sb.from('marketing_topics').update({ is_active: active }).eq('id', id);
    loadTopics();
};

window.deleteTopic = async function(id) {
    if (!confirm('ì´ ì£¼ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    await sb.from('marketing_topics').delete().eq('id', id);
    loadTopics();
};

// ===== YouTube ì„¤ì • =====
async function loadYoutubeConfig() {
    const { data } = await sb.from('marketing_youtube_config').select('*').limit(1).single();
    if (!data) return;

    if (data.api_key) document.getElementById('ytApiKey').value = data.api_key;
    if (data.client_id) document.getElementById('ytClientId').value = data.client_id;
    if (data.client_secret) document.getElementById('ytClientSecret').value = data.client_secret;
    if (data.auto_reply_template) document.getElementById('autoReplyTemplate').value = data.auto_reply_template;

    const toggle = document.getElementById('autoReplyToggle');
    const status = document.getElementById('autoReplyStatus');
    if (data.auto_reply_enabled) {
        toggle.classList.add('on');
        status.innerText = 'í™œì„±';
        status.style.color = '#22c55e';
    }

    if (data.channel_name || data.access_token) {
        const el = document.getElementById('ytConnectionStatus');
        el.className = 'yt-status connected';
        el.innerHTML = `<i class="fa-solid fa-circle-check" style="color:#22c55e;"></i> <span>ì—°ê²°ë¨: ${data.channel_name || 'YouTube ì±„ë„'}</span>`;
    }

    // ëŒ“ê¸€ ë‹µê¸€ ë¡œê·¸
    const { data: replies } = await sb.from('marketing_comment_replies').select('*').order('replied_at', { ascending: false }).limit(10);
    if (replies && replies.length > 0) {
        let html = '';
        replies.forEach(r => {
            html += `<div style="padding:8px 0; border-bottom:1px solid #334155; font-size:12px;">
                <div style="color:#94a3b8;">ì˜ìƒ: ${r.video_id} | ${new Date(r.replied_at).toLocaleString('ko-KR')}</div>
                <div style="color:#64748b; margin-top:2px;">ì›ê¸€: ${(r.comment_text || '').substring(0, 50)}</div>
                <div style="color:#a78bfa; margin-top:2px;">ë‹µê¸€: ${r.reply_text}</div>
            </div>`;
        });
        document.getElementById('replyLog').innerHTML = html;
    }
}

window.saveYoutubeConfig = async function() {
    const config = {
        api_key: document.getElementById('ytApiKey').value,
        client_id: document.getElementById('ytClientId').value,
        client_secret: document.getElementById('ytClientSecret').value,
        updated_at: new Date().toISOString()
    };

    const { data: existing } = await sb.from('marketing_youtube_config').select('id').limit(1).single();
    if (existing) {
        await sb.from('marketing_youtube_config').update(config).eq('id', existing.id);
    } else {
        await sb.from('marketing_youtube_config').insert(config);
    }
    showToast('YouTube ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
};

window.connectYoutube = async function() {
    const clientId = document.getElementById('ytClientId').value.trim();
    if (!clientId) { showToast('OAuth2 Client IDë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”', 'warn'); return; }

    const currentUrl = window.location.protocol + '//' + window.location.host + window.location.pathname;
    const scope = encodeURIComponent('https://www.googleapis.com/auth/youtube https://www.googleapis.com/auth/youtube.force-ssl');
    const authUrl = 'https://accounts.google.com/o/oauth2/v2/auth'
        + '?client_id=' + encodeURIComponent(clientId)
        + '&redirect_uri=' + encodeURIComponent(currentUrl)
        + '&response_type=code'
        + '&scope=' + scope
        + '&access_type=offline'
        + '&prompt=consent';
    window.location.href = authUrl;
};

window.toggleAutoReply = function() {
    const toggle = document.getElementById('autoReplyToggle');
    const status = document.getElementById('autoReplyStatus');
    toggle.classList.toggle('on');
    const isOn = toggle.classList.contains('on');
    status.innerText = isOn ? 'í™œì„±' : 'ë¹„í™œì„±';
    status.style.color = isOn ? '#22c55e' : '#64748b';
};

window.saveAutoReply = async function() {
    const toggle = document.getElementById('autoReplyToggle');
    const template = document.getElementById('autoReplyTemplate').value;

    const { data: existing } = await sb.from('marketing_youtube_config').select('id').limit(1).single();
    const update = { auto_reply_enabled: toggle.classList.contains('on'), auto_reply_template: template, updated_at: new Date().toISOString() };

    if (existing) {
        await sb.from('marketing_youtube_config').update(update).eq('id', existing.id);
    } else {
        await sb.from('marketing_youtube_config').insert(update);
    }
    showToast('ìë™ ë‹µê¸€ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
};

// ===== YouTube ì—…ë¡œë“œ =====
window.uploadToYoutube = async function() {
    const file = document.getElementById('ytVideoFile').files[0];
    const title = document.getElementById('ytVideoTitle').value;
    const desc = document.getElementById('ytVideoDesc').value;
    const tags = document.getElementById('ytVideoTags').value.split(',').map(t => t.trim()).filter(Boolean);

    if (!file) { showToast('ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'warn'); return; }
    if (!title) { showToast('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warn'); return; }

    const progress = document.getElementById('uploadProgress');
    progress.style.display = 'block';
    progress.innerHTML = '<div class="loading-spinner"></div> YouTube ì—…ë¡œë“œ ì¤‘...';

    try {
        const { data: config } = await sb.from('marketing_youtube_config').select('access_token').limit(1).single();
        if (!config?.access_token) {
            progress.innerHTML = '<span style="color:#f87171;">Google OAuth ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € "Google OAuth ì¸ì¦" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</span>';
            return;
        }

        // YouTube Data API v3 - Resumable Upload
        const metadata = {
            snippet: { title, description: desc, tags, categoryId: '22' },
            status: { privacyStatus: 'public', selfDeclaredMadeForKids: false }
        };

        // Step 1: Initiate upload
        const initRes = await fetch('https://www.googleapis.com/upload/youtube/v3/videos?uploadType=resumable&part=snippet,status', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + config.access_token,
                'Content-Type': 'application/json; charset=UTF-8',
                'X-Upload-Content-Length': file.size,
                'X-Upload-Content-Type': file.type
            },
            body: JSON.stringify(metadata)
        });

        if (!initRes.ok) {
            const errText = await initRes.text();
            throw new Error('Upload init failed: ' + errText);
        }

        const uploadUrl = initRes.headers.get('Location');

        // Step 2: Upload video
        const uploadRes = await fetch(uploadUrl, {
            method: 'PUT',
            headers: { 'Content-Type': file.type },
            body: file
        });

        if (!uploadRes.ok) throw new Error('Upload failed: ' + uploadRes.status);

        const result = await uploadRes.json();
        progress.innerHTML = `<span style="color:#22c55e;"><i class="fa-solid fa-check-circle"></i> ì—…ë¡œë“œ ì™„ë£Œ! Video ID: ${result.id}</span>
            <br><a href="https://youtube.com/shorts/${result.id}" target="_blank" style="color:#a78bfa;">YouTubeì—ì„œ ë³´ê¸°</a>`;

    } catch(e) {
        console.error('Upload error:', e);
        progress.innerHTML = `<span style="color:#f87171;"><i class="fa-solid fa-circle-exclamation"></i> ì—…ë¡œë“œ ì‹¤íŒ¨: ${e.message}</span>`;
    }
};

// ===== ì›í´ë¦­ ë¸”ë¡œê·¸ ë°œí–‰ (3ê°œêµ­ì–´ ë™ì‹œ) =====
let blogPhotoFiles = []; // ë‹¤ì¤‘ ì‚¬ì§„ ì§€ì›

const langConfig = {
    kr: { countryCode: 'KR', site: 'cafe2626.com', label: 'í•œêµ­ì–´', flag: 'KR', color: '#60a5fa' },
    ja: { countryCode: 'JP', site: 'cafe0101.com', label: 'æ—¥æœ¬èª', flag: 'JP', color: '#f472b6' },
    en: { countryCode: 'US', site: 'cafe3355.com', label: 'English', flag: 'EN', color: '#34d399' },
    cn: { countryCode: 'CN', site: 'cafe2626.com', label: 'ä¸­æ–‡', flag: 'CN', color: '#ef4444' },
    ar: { countryCode: 'AR', site: 'cafe3355.com', label: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', flag: 'AR', color: '#f59e0b' },
    es: { countryCode: 'ES', site: 'cafe3355.com', label: 'EspaÃ±ol', flag: 'ES', color: '#a855f7' },
    de: { countryCode: 'DE', site: 'cafe3355.com', label: 'Deutsch', flag: 'DE', color: '#eab308' },
    fr: { countryCode: 'FR', site: 'cafe3355.com', label: 'FranÃ§ais', flag: 'FR', color: '#3b82f6' }
};
const blogLangs = ['kr', 'ja', 'en', 'cn', 'ar', 'es', 'de', 'fr']; // 8ê°œêµ­ì–´ ìƒì„±

window.handleBlogPhoto = function(input) {
    const files = Array.from(input.files).filter(f => f.type.startsWith('image/') && f.size <= 5 * 1024 * 1024);
    if (files.length === 0) { showToast('ìœ íš¨í•œ ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš” (5MB ì´í•˜)', 'warn'); return; }
    blogPhotoFiles = files;
    const dzc = document.getElementById('blogDropzoneContent');
    if (files.length === 1) {
        const reader = new FileReader();
        reader.onload = (e) => {
            dzc.innerHTML = `<img src="${e.target.result}" alt="preview" style="max-height:120px; border-radius:8px;"><p style="margin-top:8px; color:#a78bfa; font-size:12px;">1ì¥ ì„ íƒë¨ â†’ 8ê°œêµ­ì–´ ë¸”ë¡œê·¸ ìƒì„±</p>`;
        };
        reader.readAsDataURL(files[0]);
    } else {
        dzc.innerHTML = `<i class="fa-solid fa-images" style="font-size:36px; color:#a78bfa;"></i>
            <p style="margin-top:8px; color:#a78bfa; font-weight:700;">${files.length}ì¥ ì„ íƒë¨</p>
            <p style="font-size:11px; color:#94a3b8;">ê° ì‚¬ì§„ë§ˆë‹¤ 8ê°œêµ­ì–´ ë¸”ë¡œê·¸ì”© (ì´ ${files.length * 8}ê°œ) ìë™ ìƒì„±</p>`;
    }
};

// ë“œë˜ê·¸ì•¤ë“œë¡­
document.addEventListener('DOMContentLoaded', () => {
    const dz = document.getElementById('blogDropzone');
    if (!dz) return;
    dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('dragover'); });
    dz.addEventListener('dragleave', () => { dz.classList.remove('dragover'); });
    dz.addEventListener('drop', (e) => {
        e.preventDefault(); dz.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
        if (files.length > 0) {
            const input = document.getElementById('blogPhotoInput');
            const dt = new DataTransfer();
            files.forEach(f => dt.items.add(f));
            input.files = dt.files;
            handleBlogPhoto(input);
        }
    });
});

function setStep(stepId, state) {
    const el = document.getElementById(stepId);
    if (!el) return;
    el.className = 'step ' + state;
    if (state === 'active') el.querySelector('i').className = 'fa-solid fa-circle-notch fa-spin';
    else if (state === 'done') el.querySelector('i').className = 'fa-solid fa-check-circle';
}

window.publishBlogOneClick = async function() {
    if (blogPhotoFiles.length === 0) { showToast('ì‚¬ì§„ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”', 'warn'); return; }

    const btn = document.getElementById('blogOneClickBtn');
    const progress = document.getElementById('blogProgress');
    const topic = document.getElementById('blogTopic').value.trim() || 'ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ… ì œí’ˆ í™œìš© ì‚¬ë¡€ ì†Œê°œ';
    let settings = {}; try { settings = JSON.parse(localStorage.getItem('mkt_settings') || '{}'); } catch(e) {}
    const totalFiles = blogPhotoFiles.length;

    btn.disabled = true;
    progress.style.display = 'block';

    const previewCard = document.getElementById('blogPreviewCard');
    previewCard.style.display = 'block';
    document.getElementById('blogPreview').innerHTML = '';

    let batchResults = [];
    const { data: { user } } = await sb.auth.getUser();
    const authorName = user?.user_metadata?.full_name || user?.email?.split('@')[0] || 'ì¹´ë©œë ˆì˜¨';

    // ë§ˆí¬ë‹¤ìš´ â†’ HTML ë³€í™˜ í•¨ìˆ˜
    function mdToHtml(bodyText, photoUrl, title, hashtags, metaDesc, focusKw, lang) {
        let htmlBody = bodyText
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>')
            .replace(/## (.*)/g, '<h2>$1</h2>')
            .replace(/### (.*)/g, '<h3>$1</h3>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        // SEO: ì´ë¯¸ì§€ altì— focus keyword í¬í•¨
        const altText = focusKw || title || topic;
        htmlBody = `<p><img src="${photoUrl}" alt="${altText}" style="max-width:100%; border-radius:12px; margin-bottom:20px;" loading="lazy"/></p><p>${htmlBody}</p>`;
        if (hashtags?.length) {
            htmlBody += `<p style="color:#6366f1; margin-top:20px;">${hashtags.map(t => '#' + t).join(' ')}</p>`;
        }
        // SEO: ë‹¤êµ­ì–´ hreflang ì•ˆë‚´ (ê²€ìƒ‰ì—”ì§„ í¬ë¡¤ëŸ¬ìš© hidden)
        const domain = { kr: 'www.cafe2626.com', ja: 'www.cafe0101.com', en: 'www.cafe3355.com', cn: 'www.cafe2626.com', ar: 'www.cafe3355.com', es: 'www.cafe3355.com', de: 'www.cafe3355.com', fr: 'www.cafe3355.com' };
        htmlBody += `<div style="display:none;" data-seo="hreflang" data-lang="${lang}" data-domain="${domain[lang]}"></div>`;
        return htmlBody;
    }

    for (let i = 0; i < totalFiles; i++) {
        const file = blogPhotoFiles[i];
        const photoLabel = totalFiles > 1 ? `ì‚¬ì§„ ${i + 1}/${totalFiles}` : '';

        // ìŠ¤í… ì´ˆê¸°í™”
        ['step-upload','step-ai-kr','step-ai-ja','step-ai-en','step-ai-cn','step-ai-ar','step-ai-es','step-ai-de','step-ai-fr','step-publish'].forEach(s => {
            const el = document.getElementById(s); if(el) el.className = 'step';
        });

        // ì‚¬ì§„ êµ¬ë¶„ í—¤ë”
        if (totalFiles > 1) {
            document.getElementById('blogPreview').innerHTML += `
                <div style="padding:8px 12px; margin:12px 0 4px; background:#334155; border-radius:6px; font-size:13px; color:#e2e8f0; font-weight:600;">
                    <i class="fa-solid fa-image"></i> ${photoLabel}
                </div>`;
        }

        try {
            // 1. ì‚¬ì§„ ì—…ë¡œë“œ (1ë²ˆë§Œ)
            setStep('step-upload', 'active');
            document.getElementById('step-upload').lastChild.textContent = ` ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘... ${photoLabel}`;
            const ext = file.name.split('.').pop().toLowerCase();
            const filePath = `blog_${Date.now()}_${Math.random().toString(36).substring(2,7)}.${ext}`;
            const { error: uploadErr } = await sb.storage.from('community').upload(filePath, file);
            if (uploadErr) throw new Error('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + uploadErr.message);
            const { data: urlData } = sb.storage.from('community').getPublicUrl(filePath);
            const photoUrl = urlData.publicUrl;
            setStep('step-upload', 'done');

            // 2. 3ê°œêµ­ì–´ AI ë¸”ë¡œê·¸ ìƒì„± (ìˆœì°¨ - API ë¶€í•˜ ë°©ì§€)
            const langResults = {};
            for (const lang of blogLangs) {
                const cfg = langConfig[lang];
                const stepId = `step-ai-${lang}`;
                setStep(stepId, 'active');

                try {
                    const { data: aiData, error: aiErr } = await sb.functions.invoke('marketing-content', {
                        body: {
                            platform: 'blog',
                            topic: topic,
                            tone: 'professional',
                            lang: lang,
                            instructions: `ì‚¬ì§„ì´ í¬í•¨ëœ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ${cfg.site} ì‚¬ì´íŠ¸ì— ê²Œì‹œë  ${cfg.label} ì½˜í…ì¸ ì…ë‹ˆë‹¤. í•´ë‹¹ ì–¸ì–´ ì‹œì¥ì˜ ê²€ìƒ‰ íŠ¸ë Œë“œë¥¼ ë°˜ì˜í•˜ì—¬ SEOì— ìµœì í™”ëœ ê³ í’ˆì§ˆ ê¸€ì„ ì‘ì„±í•˜ì„¸ìš”. ì›¹ì‚¬ì´íŠ¸ ë§í¬ëŠ” ë°˜ë“œì‹œ https://${cfg.site} ì„ ì‚¬ìš©í•˜ì„¸ìš”.`,
                            coreKeywords: settings.coreKeywords || '',
                            usp: settings.usp || '',
                            ctaMsg: settings.ctaMsg || ''
                        }
                    });
                    if (aiErr) throw new Error(aiErr.message);
                    const content = aiData.content || aiData;
                    if (content.error) throw new Error(content.error);
                    langResults[lang] = content;
                    setStep(stepId, 'done');
                } catch (langErr) {
                    console.error(`AI generation failed for ${lang}:`, langErr);
                    langResults[lang] = null;
                    setStep(stepId, 'error');
                }

                // API ë¶€í•˜ ë°©ì§€ ëŒ€ê¸°
                if (lang !== blogLangs[blogLangs.length - 1]) {
                    await new Promise(r => setTimeout(r, 1500));
                }
            }

            // 3. 3ê°œ ì‚¬ì´íŠ¸ì— ë™ì‹œ ê²Œì‹œ
            setStep('step-publish', 'active');
            let publishedCount = 0;

            for (const lang of blogLangs) {
                const content = langResults[lang];
                if (!content) continue;

                const cfg = langConfig[lang];
                const bodyText = content.body || '';
                const metaDesc = content.meta_description || '';
                const focusKw = content.focus_keyword || '';
                const htmlBody = mdToHtml(bodyText, photoUrl, content.title, content.hashtags, metaDesc, focusKw, lang);

                // community_postsì— ê²Œì‹œ (SEO ë©”íƒ€ë°ì´í„°ë¥¼ markdown í•„ë“œì— JSONìœ¼ë¡œ ì €ì¥)
                const seoMeta = JSON.stringify({
                    meta_description: metaDesc,
                    focus_keyword: focusKw,
                    hashtags: content.hashtags || [],
                    og_image: photoUrl
                });

                const { error: postErr } = await sb.from('community_posts').insert({
                    category: 'blog',
                    country_code: cfg.countryCode,
                    title: content.title || topic,
                    content: htmlBody,
                    author_name: authorName,
                    author_email: user?.email || '',
                    author_id: user?.id || null,
                    thumbnail: photoUrl,
                    markdown: seoMeta
                });

                if (postErr) {
                    console.error(`Publish failed for ${lang}:`, postErr);
                    document.getElementById('blogPreview').innerHTML += `
                        <div style="padding:6px 10px; margin-bottom:4px; background:#450a0a; border:1px solid #991b1b; border-radius:6px; font-size:12px;">
                            <span style="color:${cfg.color}; font-weight:600;">${cfg.flag}</span>
                            <span style="color:#f87171;"> ê²Œì‹œ ì‹¤íŒ¨: ${postErr.message}</span>
                        </div>`;
                    batchResults.push({ success: false, lang, error: postErr.message });
                    continue;
                }

                // marketing_contentì—ë„ ì €ì¥
                try {
                    await sb.from('marketing_content').insert({
                        platform: 'blog',
                        title: content.title || topic,
                        body: bodyText,
                        hashtags: content.hashtags || [],
                        thumbnail_prompt: content.thumbnail_prompt || '',
                        thumbnail_url: photoUrl,
                        status: 'published',
                        published_at: new Date().toISOString()
                    });
                } catch(_) {}

                publishedCount++;
                batchResults.push({ success: true, lang, title: content.title || topic });

                // ê²°ê³¼ í‘œì‹œ
                document.getElementById('blogPreview').innerHTML += `
                    <div style="padding:6px 10px; margin-bottom:4px; background:#052e16; border:1px solid #166534; border-radius:6px; font-size:12px; display:flex; align-items:center; gap:8px;">
                        <span style="background:${cfg.color}22; color:${cfg.color}; padding:2px 6px; border-radius:3px; font-weight:700; font-size:11px;">${cfg.flag}</span>
                        <span style="color:#22c55e; font-weight:600;">${content.title || topic}</span>
                    </div>`;
            }

            if (publishedCount > 0) setStep('step-publish', 'done');
            else setStep('step-publish', 'error');

        } catch(e) {
            console.error(`Blog pipeline error (photo ${i + 1}/${totalFiles}):`, e);
            batchResults.push({ success: false, error: e.message });

            document.getElementById('blogPreview').innerHTML += `
                <div style="padding:10px; margin-bottom:8px; background:#450a0a; border:1px solid #991b1b; border-radius:8px;">
                    <span style="color:#f87171; font-weight:600;"><i class="fa-solid fa-circle-exclamation"></i> ${photoLabel} ì‹¤íŒ¨: ${e.message}</span>
                </div>`;

            ['step-upload','step-ai-kr','step-ai-ja','step-ai-en','step-publish'].forEach(id => {
                const el = document.getElementById(id);
                if (el && el.className.includes('active')) el.className = 'step error';
            });
        }

        // ë‹¤ìŒ ì‚¬ì§„ ì²˜ë¦¬ ì „ ëŒ€ê¸°
        if (i < totalFiles - 1) await new Promise(r => setTimeout(r, 2000));
    }

    // ì™„ë£Œ ìš”ì•½
    const successCount = batchResults.filter(r => r.success).length;
    const failCount = batchResults.filter(r => !r.success).length;
    const totalExpected = totalFiles * 8;
    document.getElementById('blogPreview').innerHTML += `
        <div style="padding:12px; margin-top:12px; background:#1e293b; border-radius:8px; text-align:center;">
            <span style="color:#f1f5f9; font-weight:700;">
                ì‚¬ì§„ ${totalFiles}ì¥ Ã— 8ê°œêµ­ì–´ = ì´ ${totalExpected}ê°œ ì¤‘
                <span style="color:#22c55e;">${successCount}ê°œ ë°œí–‰ ì„±ê³µ</span>${failCount > 0 ? `, <span style="color:#f87171;">${failCount}ê°œ ì‹¤íŒ¨</span>` : ''}
            </span>
        </div>`;

    // ì‚¬ì´íŠ¸ë³„ ë§í¬ ì—…ë°ì´íŠ¸
    document.getElementById('blogViewLinkKR').href = 'https://www.cafe2626.com/board.html?cat=blog&country=KR';
    document.getElementById('blogViewLinkJP').href = 'https://www.cafe0101.com/board.html?cat=blog&country=JP';
    document.getElementById('blogViewLinkEN').href = 'https://www.cafe3355.com/board.html?cat=blog&country=US';
    document.getElementById('blogViewLinkCN').href = 'https://www.cafe2626.com/board.html?cat=blog&country=CN';
    document.getElementById('blogViewLinkAR').href = 'https://www.cafe3355.com/board.html?cat=blog&country=AR';
    document.getElementById('blogViewLinkES').href = 'https://www.cafe3355.com/board.html?cat=blog&country=ES';
    document.getElementById('blogViewLinkDE').href = 'https://www.cafe3355.com/board.html?cat=blog&country=DE';
    document.getElementById('blogViewLinkFR').href = 'https://www.cafe3355.com/board.html?cat=blog&country=FR';

    // Googleì— ìƒˆ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ì•Œë¦¼ (ì‚¬ì´íŠ¸ë§µ ping)
    if (successCount > 0) {
        const sitemapUrls = [
            'https://www.cafe2626.com/sitemap.xml',
            'https://www.cafe0101.com/sitemap.xml',
            'https://www.cafe3355.com/sitemap.xml'
        ];
        for (const smUrl of sitemapUrls) {
            fetch(`https://www.google.com/ping?sitemap=${encodeURIComponent(smUrl)}`, { mode: 'no-cors' }).catch(() => {});
        }
        console.log('Google sitemap ping sent for all 3 domains');
    }

    // ì´ˆê¸°í™”
    blogPhotoFiles = [];
    document.getElementById('blogPhotoInput').value = '';
    document.getElementById('blogDropzoneContent').innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i><p>í´ë¦­ ë˜ëŠ” ì‚¬ì§„ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš” (ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥)</p><p style="font-size:11px; color:#475569; margin-top:4px;">JPG, PNG, WebP (ê° ìµœëŒ€ 5MB) | ì‚¬ì§„ 1ì¥ â†’ 8ê°œêµ­ì–´ ë¸”ë¡œê·¸ ìë™ ìƒì„±</p>';
    document.getElementById('blogTopic').value = '';
    loadBlogHistory();

    btn.disabled = false;
    setTimeout(() => { progress.style.display = 'none'; }, 5000);
};

// ìµœê·¼ ë°œí–‰ ë¸”ë¡œê·¸ ì´ë ¥
async function loadBlogHistory() {
    const { data } = await sb.from('community_posts')
        .select('id, title, thumbnail, created_at, country_code')
        .eq('category', 'blog')
        .order('created_at', { ascending: false })
        .limit(6);

    const grid = document.getElementById('blogHistoryGrid');
    if (!data || data.length === 0) {
        grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><i class="fa-solid fa-newspaper"></i><p>ì•„ì§ ë°œí–‰ëœ ë¸”ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
    }

    grid.innerHTML = data.map(p => {
        const date = new Date(p.created_at).toLocaleDateString('ko-KR');
        const cc = (p.country_code || 'KR').toLowerCase();
        const site = langConfig[cc]?.site || 'cafe2626.com';
        return `<div class="blog-history-card" onclick="window.open('https://${site}/board?cat=blog','_blank')">
            ${p.thumbnail ? `<img src="${p.thumbnail}" alt="">` : '<div style="height:100px; background:#1e293b; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-image" style="color:#475569; font-size:24px;"></i></div>'}
            <div class="info">
                <div class="title">${p.title || '(ì œëª© ì—†ìŒ)'}</div>
                <div class="meta">${date} <span class="site-badge ${cc}">${(p.country_code || 'KR')}</span></div>
            </div>
        </div>`;
    }).join('');
}

// ===== ì„¤ì • =====
window.saveSettings = function() {
    try { localStorage.setItem('mkt_settings', JSON.stringify({
        brandName: document.getElementById('setBrandName').value,
        siteKr: document.getElementById('setSiteKr').value,
        siteJp: document.getElementById('setSiteJp').value,
        siteUs: document.getElementById('setSiteUs').value,
        coreKeywords: document.getElementById('setCoreKeywords').value,
        usp: document.getElementById('setUsp').value,
        ctaMsg: document.getElementById('setCtaMsg').value
    })); } catch(e) {}
    showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
};

// ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
(function loadSettings() {
    try {
        const saved = JSON.parse(localStorage.getItem('mkt_settings') || '{}');
        if (saved.brandName) document.getElementById('setBrandName').value = saved.brandName;
        if (saved.siteKr) document.getElementById('setSiteKr').value = saved.siteKr;
        if (saved.siteJp) document.getElementById('setSiteJp').value = saved.siteJp;
        if (saved.siteUs) document.getElementById('setSiteUs').value = saved.siteUs;
        if (saved.coreKeywords) document.getElementById('setCoreKeywords').value = saved.coreKeywords;
        if (saved.usp) document.getElementById('setUsp').value = saved.usp;
        if (saved.ctaMsg) document.getElementById('setCtaMsg').value = saved.ctaMsg;
    } catch(e) {}
})();

// OAuth ì½œë°± ì²˜ë¦¬ (init ì—ì„œ sb ì´ˆê¸°í™” í›„ í˜¸ì¶œë¨)
async function handleOAuthCallback() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    if (!code) return;

    // URL ì •ë¦¬
    window.history.replaceState({}, document.title, window.location.pathname);

    try {
        const { data: config } = await sb.from('marketing_youtube_config').select('client_id, client_secret').limit(1).single();
        if (!config) { showToast('YouTube ì„¤ì •ì„ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”', 'warn'); return; }

        // í† í° êµí™˜
        const tokenRes = await fetch('https://oauth2.googleapis.com/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                code,
                client_id: config.client_id,
                client_secret: config.client_secret,
                redirect_uri: window.location.origin + window.location.pathname,
                grant_type: 'authorization_code'
            })
        });

        const tokens = await tokenRes.json();
        if (tokens.error) throw new Error(tokens.error_description || tokens.error);

        // ì±„ë„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const channelRes = await fetch('https://www.googleapis.com/youtube/v3/channels?part=snippet&mine=true', {
            headers: { 'Authorization': 'Bearer ' + tokens.access_token }
        });
        const channelData = await channelRes.json();
        const channelName = channelData.items?.[0]?.snippet?.title || 'Unknown';
        const channelId = channelData.items?.[0]?.id || '';

        // DBì— í† í° ì €ì¥
        const { data: existing } = await sb.from('marketing_youtube_config').select('id').limit(1).single();
        const update = {
            access_token: tokens.access_token,
            refresh_token: tokens.refresh_token || null,
            token_expires_at: new Date(Date.now() + (tokens.expires_in * 1000)).toISOString(),
            channel_id: channelId,
            channel_name: channelName,
            updated_at: new Date().toISOString()
        };

        if (existing) {
            await sb.from('marketing_youtube_config').update(update).eq('id', existing.id);
        } else {
            await sb.from('marketing_youtube_config').insert({ ...update, api_key: '', client_id: '', client_secret: '' });
        }

        showToast(`YouTube ì±„ë„ ì—°ê²° ì™„ë£Œ: ${channelName}`, 'success');
        loadYoutubeConfig();
    } catch(e) {
        console.error('OAuth error:', e);
        showToast('YouTube ì¸ì¦ ì‹¤íŒ¨: ' + e.message, 'error');
    }
}

// ===== ì›í´ë¦­ YouTube Shorts ìë™ ìƒì„± íŒŒì´í”„ë¼ì¸ =====
let shortsPhotoFiles = []; // ë‹¤ì¤‘ ì‚¬ì§„ ì§€ì›
let shortsAiContent = null;
let shortsVideoBlob = null;

window.handleShortsPhoto = function(input) {
    const files = Array.from(input.files).filter(f => f.type.startsWith('image/') && f.size <= 5 * 1024 * 1024);
    if (files.length === 0) { showToast('ìœ íš¨í•œ ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš” (5MB ì´í•˜)', 'warn'); return; }
    shortsPhotoFiles = files;
    const dzc = document.getElementById('ytShortsDropzoneContent');
    if (files.length === 1) {
        const reader = new FileReader();
        reader.onload = (e) => {
            dzc.innerHTML = `<img src="${e.target.result}" alt="preview" style="max-height:120px; border-radius:8px;">
                <p style="margin-top:8px; color:#a78bfa; font-size:12px;">1ì¥ ì„ íƒë¨ - í´ë¦­í•˜ì—¬ ë³€ê²½</p>`;
        };
        reader.readAsDataURL(files[0]);
    } else {
        dzc.innerHTML = `<i class="fa-solid fa-images" style="font-size:36px; color:#a78bfa;"></i>
            <p style="margin-top:8px; color:#a78bfa; font-weight:700;">${files.length}ì¥ ì„ íƒë¨</p>
            <p style="font-size:11px; color:#94a3b8;">ê° ì‚¬ì§„ë§ˆë‹¤ ì˜ìƒ 1ê°œì”© ìë™ ìƒì„±ë©ë‹ˆë‹¤</p>`;
    }
};

// ë“œë˜ê·¸&ë“œë¡­ ì§€ì›
document.addEventListener('DOMContentLoaded', function() {
    const dz = document.getElementById('ytShortsDropzone');
    if (dz) {
        dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('dragover'); });
        dz.addEventListener('dragleave', () => { dz.classList.remove('dragover'); });
        dz.addEventListener('drop', (e) => {
            e.preventDefault(); dz.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            if (files.length > 0) {
                const input = document.getElementById('ytShortsPhotoInput');
                const dt = new DataTransfer();
                files.forEach(f => dt.items.add(f));
                input.files = dt.files;
                handleShortsPhoto(input);
            }
        });
    }
});

// ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ í›„ base64 ë³€í™˜ (AI ì „ì†¡ìš©, ìµœëŒ€ 1024px)
function resizeImageToBase64(file, maxDim) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
            let w = img.width, h = img.height;
            if (w > maxDim || h > maxDim) {
                if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
                else { w = Math.round(w * maxDim / h); h = maxDim; }
            }
            const cv = document.createElement('canvas');
            cv.width = w; cv.height = h;
            cv.getContext('2d').drawImage(img, 0, 0, w, h);
            const dataUrl = cv.toDataURL('image/jpeg', 0.85);
            resolve(dataUrl.split(',')[1]);
            URL.revokeObjectURL(img.src);
        };
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
    });
}

// AI ì½˜í…ì¸  ìƒì„± í˜¸ì¶œ
async function generateShortsAI(imageBase64, lang, topic) {
    let settings = {}; try { settings = JSON.parse(localStorage.getItem('mkt_settings') || '{}'); } catch(e) {}
    const { data, error } = await sb.functions.invoke('marketing-content', {
        body: {
            platform: 'youtube_shorts_from_image',
            topic: topic || 'ì´ë¯¸ì§€ ìƒí’ˆì„ ë°˜ê°’ìœ¼ë¡œ ì œì‘í•˜ëŠ” ê¿€íŒ - ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ… í™œìš©ë²•',
            tone: 'fast_energetic',
            lang: lang,
            instructions: 'ë¹¨ë¦¬ ì½ëŠ” ë§íˆ¬ë¡œ ë¹ ë¥´ê²Œ ì„¤ëª…í•˜ëŠ” ê¿€íŒ ì‡¼ì¸  ë‚˜ë ˆì´ì…˜ì„ ìƒì„±í•˜ì„¸ìš”. "OOO ë°˜ê°’ìœ¼ë¡œ ì œì‘í•˜ê¸° ê¿€íŒ!" ìŠ¤íƒ€ì¼ë¡œ, ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ…ì—ì„œ ì œì‘í•˜ë©´ ì™œ ë°˜ê°’ì¸ì§€ ì´ìœ ë¥¼ ì„¤ëª…í•˜ê³ , ì—ë””í„°ë¡œ ì‰½ê²Œ ë””ìì¸ â†’ ë¹ ë¥´ê²Œ ì£¼ë¬¸í•˜ëŠ” ê³¼ì •ì„ ë¹ ë¥¸ ë§íˆ¬ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”. narration ë°°ì—´ì— 5ê°œ ë¬¸ì¥ì„ ë„£ì–´ì£¼ì„¸ìš”.',
            coreKeywords: settings.coreKeywords || '',
            usp: settings.usp || '',
            ctaMsg: settings.ctaMsg || '',
            imageBase64: imageBase64
        }
    });
    if (error) throw new Error('AI ìƒì„± ì‹¤íŒ¨: ' + error.message);
    const content = data?.content || data;
    if (content?.error) throw new Error('AI ì˜¤ë¥˜: ' + content.error);
    return content;
}

// Canvas í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ (CJK ì§€ì›)
function wrapCanvasText(ctx, text, maxWidth) {
    if (!text) return [''];
    // ë„ì–´ì“°ê¸° ë‹¨ìœ„ë¡œ ì¤„ë°”ê¿ˆ (í•œêµ­ì–´/ì˜ì–´ ëª¨ë‘ ë™ì¼ ë¡œì§)
    const words = text.split(' ').filter(w => w.length > 0);
    if (words.length === 0) return [text];
    const lines = [];
    let currentLine = '';
    words.forEach(word => {
        const testLine = currentLine ? currentLine + ' ' + word : word;
        if (ctx.measureText(testLine).width > maxWidth && currentLine) {
            lines.push(currentLine);
            currentLine = word;
        } else {
            currentLine = testLine;
        }
    });
    if (currentLine) lines.push(currentLine);
    // í•œ ë‹¨ì–´ê°€ maxWidthë¥¼ ì´ˆê³¼í•˜ëŠ” ê²½ìš°ë§Œ ê°•ì œ ì¤„ë°”ê¿ˆ
    const result = [];
    lines.forEach(line => {
        if (ctx.measureText(line).width > maxWidth * 1.2) {
            // ê¸€ì ë‹¨ìœ„ë¡œ ë¶„í•  (ë§¤ìš° ê¸´ ë‹¨ì–´ì¼ ë•Œë§Œ)
            let sub = '';
            for (const ch of line) {
                if (ctx.measureText(sub + ch).width > maxWidth && sub) {
                    result.push(sub);
                    sub = ch;
                } else {
                    sub += ch;
                }
            }
            if (sub) result.push(sub);
        } else {
            result.push(line);
        }
    });
    return result.length > 0 ? result : [text];
}

// â˜… OpenAI TTS APIë¥¼ í†µí•´ ê³ í’ˆì§ˆ ë‚˜ë ˆì´ì…˜ ì˜¤ë””ì˜¤ ìƒì„±
async function generateTTSAudio(texts, lang) {
    console.log('ğŸ™ï¸ TTS ìƒì„± ìš”ì²­:', texts.length, 'ë¬¸ì¥');
    // Supabase edge functionì„ ì§ì ‘ fetch (ë°”ì´ë„ˆë¦¬ MP3 ì‘ë‹µ)
    const supabaseUrl = SUPABASE_URL || 'https://qinvtnhiidtmrzosyvys.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpbnZ0bmhpaWR0bXJ6b3N5dnlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMDE3NjQsImV4cCI6MjA3ODc3Nzc2NH0.3z0f7R4w3bqXTOMTi19ksKSeAkx8HOOTONNSos8Xz8Y';
    const resp = await fetch(`${supabaseUrl}/functions/v1/tts-generate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${supabaseKey}`,
            'apikey': supabaseKey
        },
        body: JSON.stringify({ texts, lang, speed: 1.05 })
    });
    if (!resp.ok) {
        const errData = await resp.text();
        throw new Error('TTS ìƒì„± ì‹¤íŒ¨: ' + errData);
    }
    // MP3 ë°”ì´ë„ˆë¦¬ â†’ ArrayBuffer â†’ AudioBuffer
    const mp3Buffer = await resp.arrayBuffer();
    console.log('ğŸ™ï¸ TTS MP3 ìˆ˜ì‹ :', (mp3Buffer.byteLength / 1024).toFixed(0), 'KB');
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffer = await audioCtx.decodeAudioData(mp3Buffer);
    console.log('ğŸ™ï¸ TTS ì˜¤ë””ì˜¤ ìƒì„± ì™„ë£Œ:', audioBuffer.duration.toFixed(1), 'ì´ˆ');
    return { audioCtx, audioBuffer };
}

// â˜… í•µì‹¬: Canvas + OpenAI TTS ë‚˜ë ˆì´ì…˜ ì˜ìƒ ìƒì„± ì—”ì§„ (ê³ í’ˆì§ˆ ìŒì„± í¬í•¨)
async function generateVideoFromImage(imageFile, aiContent, durationSec, lang) {
    return new Promise(async (resolve, reject) => {
        try {
            // 1. ì´ë¯¸ì§€ ë¡œë“œ
            const img = new Image();
            const imgUrl = URL.createObjectURL(imageFile);
            await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = imgUrl; });

            // 2. ìº”ë²„ìŠ¤ ì…‹ì—… (9:16 ì„¸ë¡œ Shorts)
            const W = 1080, H = 1920;
            const cvs = document.getElementById('shortsCanvas');
            cvs.width = W; cvs.height = H;
            const ctx = cvs.getContext('2d');
            await document.fonts.ready;

            // 3. ë‚˜ë ˆì´ì…˜ ì¤€ë¹„
            const narrationTexts = aiContent.narration || [];
            const overlays = aiContent.overlay_texts || {};

            // 4. OpenAI TTSë¡œ ê³ í’ˆì§ˆ ìŒì„± ìƒì„±
            let audioCtx, audioBuffer, audioSource, audioDest;
            let hasTTS = false;
            try {
                if (narrationTexts.length > 0) {
                    const tts = await generateTTSAudio(narrationTexts, lang);
                    audioCtx = tts.audioCtx;
                    audioBuffer = tts.audioBuffer;
                    hasTTS = true;
                    // TTS ì˜¤ë””ì˜¤ ê¸¸ì´ì— ë§ì¶° ì˜ìƒ ê¸¸ì´ ìë™ ì¡°ì • (ìµœì†Œ 15ì´ˆ, ìµœëŒ€ 59ì´ˆ = ì‡¼ì¸  ì œí•œ)
                    durationSec = Math.max(15, Math.min(59, Math.ceil(audioBuffer.duration) + 2));
                    console.log('ğŸ¬ TTS ê¸°ë°˜ ì˜ìƒ ê¸¸ì´:', durationSec, 'ì´ˆ');
                }
            } catch (ttsErr) {
                console.warn('âš ï¸ TTS ì‹¤íŒ¨, ë¬´ìŒ ì˜ìƒìœ¼ë¡œ ì§„í–‰:', ttsErr.message);
            }

            // 5. ì˜¤ë””ì˜¤+ë¹„ë””ì˜¤ ê²°í•© ìŠ¤íŠ¸ë¦¼ ìƒì„±
            const videoStream = cvs.captureStream(30);
            let combinedStream;
            if (hasTTS) {
                // AudioContext â†’ MediaStreamDestinationìœ¼ë¡œ ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ìƒì„±
                audioDest = audioCtx.createMediaStreamDestination();
                audioSource = audioCtx.createBufferSource();
                audioSource.buffer = audioBuffer;
                audioSource.connect(audioDest);
                audioSource.connect(audioCtx.destination); // ìŠ¤í”¼ì»¤ë¡œë„ ì¶œë ¥
                // ë¹„ë””ì˜¤ + ì˜¤ë””ì˜¤ íŠ¸ë™ ê²°í•©
                combinedStream = new MediaStream([
                    ...videoStream.getVideoTracks(),
                    ...audioDest.stream.getAudioTracks()
                ]);
            } else {
                combinedStream = videoStream;
            }

            const mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp9')
                ? 'video/webm;codecs=vp9' : 'video/webm;codecs=vp8';
            const recorder = new MediaRecorder(combinedStream, { mimeType, videoBitsPerSecond: 5000000 });
            const chunks = [];
            recorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: mimeType });
                URL.revokeObjectURL(imgUrl);
                if (audioCtx) audioCtx.close();
                resolve(blob);
            };
            recorder.onerror = (e) => reject(e.error || new Error('MediaRecorder error'));

            // 6. ìë§‰ íƒ€ì´ë° (ê· ë“± ë¶„ë°°)
            const segCount = narrationTexts.length || 5;
            const segDur = 1.0 / segCount;
            const textSegments = [];
            const captionTexts = narrationTexts.length > 0 ? narrationTexts : [
                overlays.hook || aiContent.title || '',
                overlays.main || '',
                overlays.detail || '',
                overlays.cta || '',
            ];
            captionTexts.forEach((text, i) => {
                if (!text) return;
                const start = i * segDur;
                const end = start + segDur - 0.02;
                textSegments.push({
                    text, start, end,
                    fontSize: i === 0 ? 44 : i === captionTexts.length - 1 ? 42 : 38,
                    y: 0.72
                });
            });

            // 7. ì• ë‹ˆë©”ì´ì…˜ íŒŒë¼ë¯¸í„°
            const totalMs = durationSec * 1000;
            const startTime = performance.now();
            const zoomDir = aiContent.video_style?.zoom_direction || 'in';
            const accentColor = aiContent.video_style?.color_accent || '#a78bfa';

            // 8. ë…¹í™” ì‹œì‘ + TTS ì¬ìƒ
            recorder.start(100);
            if (hasTTS && audioSource) audioSource.start(0);

            // 9. í”„ë ˆì„ ë Œë”ë§ ë£¨í”„
            function drawFrame() {
                const elapsed = performance.now() - startTime;
                const progress = Math.min(elapsed / totalMs, 1.0);

                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, W, H);

                // Ken Burns íš¨ê³¼ (ë¶€ë“œëŸ¬ìš´ ì¤Œ/íŒ¬)
                const imgAspect = img.width / img.height;
                const canvasAspect = W / H;
                let baseScale = imgAspect > canvasAspect ? H / img.height : W / img.width;
                let scale, offsetX, offsetY;
                switch (zoomDir) {
                    case 'out':
                        scale = baseScale * (1.4 - 0.4 * progress);
                        offsetX = -(img.width * scale - W) / 2 + (progress * 80);
                        offsetY = -(img.height * scale - H) / 2;
                        break;
                    case 'left_to_right':
                        scale = baseScale * 1.2;
                        offsetX = -(img.width * scale - W) * progress;
                        offsetY = -(img.height * scale - H) / 2;
                        break;
                    case 'right_to_left':
                        scale = baseScale * 1.2;
                        offsetX = -(img.width * scale - W) * (1 - progress);
                        offsetY = -(img.height * scale - H) / 2;
                        break;
                    default:
                        scale = baseScale * (1.0 + 0.35 * progress);
                        offsetX = -(img.width * scale - W) / 2 - (progress * 80);
                        offsetY = -(img.height * scale - H) / 2 - (progress * 50);
                }
                ctx.drawImage(img, offsetX, offsetY, img.width * scale, img.height * scale);

                // ë¹„ë„¤íŒ… (ë‘¥ê·¼ ëª¨ì„œë¦¬ ì–´ë‘¡ê²Œ) - ì˜í™”ê°™ì€ ëŠë‚Œ
                const vigGrad = ctx.createRadialGradient(W/2, H/2, Math.min(W,H)*0.3, W/2, H/2, Math.max(W,H)*0.8);
                vigGrad.addColorStop(0, 'rgba(0,0,0,0)');
                vigGrad.addColorStop(1, 'rgba(0,0,0,0.4)');
                ctx.fillStyle = vigGrad;
                ctx.fillRect(0, 0, W, H);

                // ìƒë‹¨ ê·¸ë¼ë°ì´ì…˜
                const topGrad = ctx.createLinearGradient(0, 0, 0, H * 0.15);
                topGrad.addColorStop(0, 'rgba(0,0,0,0.6)');
                topGrad.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = topGrad;
                ctx.fillRect(0, 0, W, H * 0.15);

                // í•˜ë‹¨ ê·¸ë¼ë°ì´ì…˜ (ìë§‰ ì˜ì—­)
                const botGrad = ctx.createLinearGradient(0, H * 0.55, 0, H);
                botGrad.addColorStop(0, 'rgba(0,0,0,0)');
                botGrad.addColorStop(0.3, 'rgba(0,0,0,0.55)');
                botGrad.addColorStop(1, 'rgba(0,0,0,0.85)');
                ctx.fillStyle = botGrad;
                ctx.fillRect(0, H * 0.55, W, H * 0.45);

                // ìë§‰ ë Œë”ë§
                textSegments.forEach(seg => {
                    if (progress >= seg.start && progress <= seg.end && seg.text) {
                        const segP = (progress - seg.start) / (seg.end - seg.start);
                        let alpha = 1;
                        if (segP < 0.06) alpha = segP / 0.06;
                        else if (segP > 0.94) alpha = (1 - segP) / 0.06;
                        alpha = Math.max(0, Math.min(1, alpha));

                        // íƒ€ì´í•‘ íš¨ê³¼
                        const charProgress = Math.min(segP * 2.0, 1.0);
                        const visibleChars = Math.ceil(seg.text.length * charProgress);
                        const displayText = seg.text.substring(0, visibleChars);

                        ctx.save();
                        ctx.globalAlpha = alpha;
                        ctx.textAlign = 'center';
                        ctx.font = `800 ${seg.fontSize}px "Pretendard", "Noto Sans JP", "Inter", sans-serif`;

                        const maxW = W - 120;
                        const lines = wrapCanvasText(ctx, displayText, maxW);
                        const lineH = seg.fontSize * 1.45;
                        const startY = H * seg.y - ((lines.length - 1) * lineH) / 2;

                        // ìë§‰ ë°°ê²½ (ë‘¥ê·¼ ë°˜íˆ¬ëª… ë°•ìŠ¤)
                        lines.forEach((line, li) => {
                            const y = startY + li * lineH;
                            const tw = ctx.measureText(line).width;
                            const pad = 18;
                            ctx.fillStyle = 'rgba(0,0,0,0.55)';
                            ctx.beginPath();
                            ctx.roundRect(W/2 - tw/2 - pad, y - seg.fontSize + 2, tw + pad*2, seg.fontSize + pad, 10);
                            ctx.fill();
                        });

                        // ìë§‰ í…ìŠ¤íŠ¸ (ì™¸ê³½ì„  + í°ìƒ‰)
                        lines.forEach((line, li) => {
                            const y = startY + li * lineH;
                            ctx.strokeStyle = 'rgba(0,0,0,0.85)';
                            ctx.lineWidth = 6;
                            ctx.lineJoin = 'round';
                            ctx.strokeText(line, W / 2, y);
                            ctx.fillStyle = '#ffffff';
                            ctx.fillText(line, W / 2, y);
                        });

                        ctx.restore();
                    }
                });

                // ì§„í–‰ë¥  ë°” (í•˜ë‹¨, ê·¸ë¼ë°ì´ì…˜)
                const barGrad = ctx.createLinearGradient(0, 0, W * progress, 0);
                barGrad.addColorStop(0, accentColor);
                barGrad.addColorStop(1, '#ffffff');
                ctx.fillStyle = barGrad;
                ctx.fillRect(0, H - 6, W * progress, 6);

                // ë¸Œëœë“œ ì›Œí„°ë§ˆí¬ (ìƒë‹¨ ì¤‘ì•™)
                ctx.save();
                ctx.globalAlpha = 0.8;
                ctx.font = '700 28px "Pretendard", sans-serif';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#ffffff';
                ctx.strokeStyle = 'rgba(0,0,0,0.7)';
                ctx.lineWidth = 4;
                ctx.lineJoin = 'round';
                const domainByLang = { kr: 'cafe2626.com', ja: 'cafe0101.com', en: 'cafe3355.com' };
                const siteUrl = domainByLang[lang] || 'cafe2626.com';
                const brandText = 'ğŸ¦ ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ… | ' + siteUrl;
                ctx.strokeText(brandText, W / 2, 55);
                ctx.fillText(brandText, W / 2, 55);
                ctx.restore();

                if (progress < 1.0) {
                    requestAnimationFrame(drawFrame);
                } else {
                    if (audioSource) try { audioSource.stop(); } catch(e) {}
                    setTimeout(() => recorder.stop(), 300);
                }
            }

            requestAnimationFrame(drawFrame);
        } catch (err) {
            reject(err);
        }
    });
}

// YouTube í† í° ê°±ì‹  (ë§Œë£Œ ì‹œ ìë™)
async function getValidYoutubeToken() {
    const { data: config } = await sb.from('marketing_youtube_config')
        .select('id, access_token, refresh_token, client_id, client_secret, token_expires_at')
        .limit(1).single();
    if (!config?.access_token) throw new Error('Google OAuth ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. YouTube ì±„ë„ì„ ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.');

    // í† í° ë§Œë£Œ ì²´í¬ (5ë¶„ ì—¬ìœ )
    const expiresAt = config.token_expires_at ? new Date(config.token_expires_at).getTime() : 0;
    if (Date.now() < expiresAt - 300000) return config.access_token;

    // ê°±ì‹  í•„ìš”
    if (!config.refresh_token) throw new Error('Refresh tokenì´ ì—†ìŠµë‹ˆë‹¤. YouTube ì±„ë„ì„ ë‹¤ì‹œ ì—°ê²°í•´ì£¼ì„¸ìš”.');
    console.log('YouTube í† í° ê°±ì‹  ì¤‘...');

    const tokenRes = await fetch('https://oauth2.googleapis.com/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
            client_id: config.client_id,
            client_secret: config.client_secret,
            refresh_token: config.refresh_token,
            grant_type: 'refresh_token'
        })
    });

    const tokens = await tokenRes.json();
    if (tokens.error) throw new Error('í† í° ê°±ì‹  ì‹¤íŒ¨: ' + (tokens.error_description || tokens.error));

    // DB ì—…ë°ì´íŠ¸
    await sb.from('marketing_youtube_config').update({
        access_token: tokens.access_token,
        token_expires_at: new Date(Date.now() + (tokens.expires_in * 1000)).toISOString()
    }).eq('id', config.id);

    console.log('YouTube í† í° ê°±ì‹  ì™„ë£Œ');
    return tokens.access_token;
}

// blob â†’ YouTube ì—…ë¡œë“œ (í† í° ìë™ ê°±ì‹ )
async function uploadVideoToYoutube(videoBlob, title, description, tags) {
    const accessToken = await getValidYoutubeToken();

    const metadata = {
        snippet: { title, description, tags, categoryId: '22' },
        status: { privacyStatus: 'public', selfDeclaredMadeForKids: false }
    };

    const initRes = await fetch('https://www.googleapis.com/upload/youtube/v3/videos?uploadType=resumable&part=snippet,status', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'application/json; charset=UTF-8',
            'X-Upload-Content-Length': videoBlob.size,
            'X-Upload-Content-Type': videoBlob.type
        },
        body: JSON.stringify(metadata)
    });

    if (!initRes.ok) {
        const errText = await initRes.text();
        throw new Error('YouTube ì—…ë¡œë“œ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + errText);
    }
    const uploadUrl = initRes.headers.get('Location');

    const uploadRes = await fetch(uploadUrl, {
        method: 'PUT',
        headers: { 'Content-Type': videoBlob.type },
        body: videoBlob
    });

    if (!uploadRes.ok) throw new Error('YouTube ì—…ë¡œë“œ ì‹¤íŒ¨: ' + uploadRes.status);
    return await uploadRes.json();
}

// íŒŒì´í”„ë¼ì¸ ìŠ¤í… ìƒíƒœ ì—…ë°ì´íŠ¸
function setPipelineStep(id, state) {
    const el = document.getElementById(id);
    if (!el) return;
    el.className = 'p-step ' + state;
    const icon = el.querySelector('i');
    if (!icon) return;
    if (state === 'active') icon.className = 'fa-solid fa-circle-notch fa-spin';
    else if (state === 'done') icon.className = 'fa-solid fa-circle-check';
    else if (state === 'error') icon.className = 'fa-solid fa-circle-exclamation';
    else icon.className = 'fa-solid fa-circle-notch';
}

// â˜… ë©”ì¸ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° (ë‹¤ì¤‘ ì‚¬ì§„ ë°°ì¹˜ ì²˜ë¦¬)
window.generateShortsOneClick = async function() {
    if (shortsPhotoFiles.length === 0) { showToast('ì‚¬ì§„ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”', 'warn'); return; }

    if (!window.MediaRecorder || !HTMLCanvasElement.prototype.captureStream) {
        showToast('ì´ ê¸°ëŠ¥ì€ Chrome ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì§€ì›ë©ë‹ˆë‹¤.', 'warn');
        return;
    }

    const btn = document.getElementById('shortsOneClickBtn');
    const steps = document.getElementById('shortsPipelineSteps');
    const previewArea = document.getElementById('shortsPreviewArea');
    const lang = document.getElementById('shortsLang').value;
    const topic = document.getElementById('shortsTopic').value.trim();
    const duration = parseInt(document.getElementById('shortsDuration').value) || 30;
    const totalFiles = shortsPhotoFiles.length;

    btn.disabled = true;
    steps.style.display = 'flex';
    previewArea.style.display = 'block';

    // ë°°ì¹˜ ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
    document.getElementById('shortsMetaPreview').innerHTML = '';
    let batchResults = [];

    for (let i = 0; i < totalFiles; i++) {
        const file = shortsPhotoFiles[i];
        const label = totalFiles > 1 ? ` (${i + 1}/${totalFiles})` : '';

        // ìŠ¤í… ì´ˆê¸°í™”
        ['sp-upload','sp-ai','sp-tts','sp-video','sp-youtube'].forEach(id => setPipelineStep(id, ''));

        try {
            // Step 1: ì´ë¯¸ì§€ â†’ base64
            setPipelineStep('sp-upload', 'active');
            document.getElementById('sp-upload').lastChild.textContent = ` ì´ë¯¸ì§€ ë¶„ì„ ì¤€ë¹„ ì¤‘...${label}`;
            const base64 = await resizeImageToBase64(file, 1024);
            setPipelineStep('sp-upload', 'done');

            // Step 2: AI ì½˜í…ì¸  ìƒì„±
            setPipelineStep('sp-ai', 'active');
            document.getElementById('sp-ai').lastChild.textContent = ` AIê°€ ì½˜í…ì¸  ìƒì„± ì¤‘...${label}`;
            const aiContent = await generateShortsAI(base64, lang, topic);
            setPipelineStep('sp-ai', 'done');

            // Step 3: TTS ìŒì„± ìƒì„± + ì˜ìƒ ë Œë”ë§ (generateVideoFromImage ë‚´ë¶€ì—ì„œ TTS í˜¸ì¶œ)
            setPipelineStep('sp-tts', 'active');
            document.getElementById('sp-tts').lastChild.textContent = ` AI ìŒì„± ìƒì„± ì¤‘ (OpenAI TTS)...${label}`;
            // TTSëŠ” generateVideoFromImage ë‚´ë¶€ì—ì„œ ìë™ í˜¸ì¶œë¨
            await new Promise(r => setTimeout(r, 100)); // UI ì—…ë°ì´íŠ¸ ëŒ€ê¸°

            setPipelineStep('sp-video', 'active');
            document.getElementById('sp-video').lastChild.textContent = ` ì˜ìƒ + ìŒì„± í•©ì„± ì¤‘...${label}`;
            const videoBlob = await generateVideoFromImage(file, aiContent, duration, lang);
            setPipelineStep('sp-tts', 'done');
            setPipelineStep('sp-video', 'done');

            // Step 4: YouTube ì—…ë¡œë“œ
            setPipelineStep('sp-youtube', 'active');
            document.getElementById('sp-youtube').lastChild.textContent = ` YouTubeì— ì—…ë¡œë“œ ì¤‘...${label}`;

            const title = aiContent.title || 'Shorts Video';
            const desc = aiContent.body || '';
            const tags = aiContent.hashtags || ['Shorts'];
            if (!tags.includes('Shorts')) tags.unshift('Shorts');

            const result = await uploadVideoToYoutube(videoBlob, title, desc, tags);
            setPipelineStep('sp-youtube', 'done');

            // marketing_contentì— ê¸°ë¡
            await sb.from('marketing_content').insert({
                platform: 'youtube_shorts',
                title: title,
                body: desc,
                hashtags: tags,
                thumbnail_prompt: '',
                status: 'published',
                published_at: new Date().toISOString()
            });

            batchResults.push({ success: true, title, videoId: result.id });

            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('shortsMetaPreview').innerHTML += `
                <div style="padding:10px; margin-bottom:8px; background:#052e16; border:1px solid #166534; border-radius:8px;">
                    <span style="color:#22c55e; font-weight:600;"><i class="fa-solid fa-check-circle"></i> ${i + 1}. ${title}</span>
                    <a href="https://youtube.com/shorts/${result.id}" target="_blank" style="color:#a78bfa; margin-left:8px; font-size:12px;">YouTubeì—ì„œ ë³´ê¸°</a>
                </div>`;

        } catch(e) {
            console.error(`Shorts pipeline error (${i + 1}/${totalFiles}):`, e);
            batchResults.push({ success: false, error: e.message });

            document.getElementById('shortsMetaPreview').innerHTML += `
                <div style="padding:10px; margin-bottom:8px; background:#450a0a; border:1px solid #991b1b; border-radius:8px;">
                    <span style="color:#f87171; font-weight:600;"><i class="fa-solid fa-circle-exclamation"></i> ${i + 1}. ì‹¤íŒ¨: ${e.message}</span>
                </div>`;

            ['sp-upload','sp-ai','sp-tts','sp-video','sp-youtube'].forEach(id => {
                const el = document.getElementById(id);
                if (el && el.classList.contains('active')) setPipelineStep(id, 'error');
            });
        }

        // ë‹¤ìŒ ì‚¬ì§„ ì²˜ë¦¬ ì „ ì ì‹œ ëŒ€ê¸° (API ë¶€í•˜ ë°©ì§€)
        if (i < totalFiles - 1) await new Promise(r => setTimeout(r, 2000));
    }

    // ì™„ë£Œ ìš”ì•½
    const successCount = batchResults.filter(r => r.success).length;
    const failCount = batchResults.filter(r => !r.success).length;
    document.getElementById('shortsMetaPreview').innerHTML += `
        <div style="padding:12px; margin-top:12px; background:#1e293b; border-radius:8px; text-align:center;">
            <span style="color:#f1f5f9; font-weight:700;">
                ì´ ${totalFiles}ê°œ ì¤‘ <span style="color:#22c55e;">${successCount}ê°œ ì„±ê³µ</span>${failCount > 0 ? `, <span style="color:#f87171;">${failCount}ê°œ ì‹¤íŒ¨</span>` : ''}
            </span>
        </div>`;

    btn.disabled = false;
    resetShortsPipeline();
};

// ë” ì´ìƒ ë¯¸ë¦¬ë³´ê¸° í›„ í™•ì¸ ë¶ˆí•„ìš” (ìë™ ì²˜ë¦¬), í•˜ì§€ë§Œ ìˆ˜ë™ ì—…ë¡œë“œìš©ì€ ìœ ì§€
window.confirmAndUpload = async function() {
    // ë°°ì¹˜ ëª¨ë“œì—ì„œëŠ” ìë™ ì²˜ë¦¬ë˜ë¯€ë¡œ ì´ í•¨ìˆ˜ëŠ” ìˆ˜ë™ ì—…ë¡œë“œ ì‹œì—ë§Œ ì‚¬ìš©
    showToast('ë°°ì¹˜ ì²˜ë¦¬ê°€ ìë™ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.', 'info');
};

window.cancelPipeline = function() {
    shortsVideoBlob = null;
    shortsAiContent = null;
    document.getElementById('shortsPreviewArea').style.display = 'none';
    document.getElementById('shortsPipelineSteps').style.display = 'none';
};

function resetShortsPipeline() {
    shortsPhotoFiles = [];
    shortsAiContent = null;
    shortsVideoBlob = null;
    const input = document.getElementById('ytShortsPhotoInput');
    if (input) input.value = '';
}

</script>
</body>
</html>