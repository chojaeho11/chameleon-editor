<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë§ˆì¼€íŒ… ë´‡ ê´€ë¦¬</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Pretendard',sans-serif; background:#0f172a; color:#e2e8f0; min-height:100vh; }

/* ìƒë‹¨ í—¤ë” */
.top-header { background:#1e293b; border-bottom:1px solid #334155; padding:12px 24px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
.top-header .logo { display:flex; align-items:center; gap:10px; font-size:18px; font-weight:800; color:#a78bfa; cursor:pointer; }
.top-header .logo i { font-size:22px; }
.top-header .user-info { font-size:13px; color:#94a3b8; }
.top-header .back-btn { background:none; border:1px solid #475569; color:#94a3b8; padding:6px 14px; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600; transition:all .2s; }
.top-header .back-btn:hover { background:#334155; color:#fff; }

/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
.tab-nav { background:#1e293b; border-bottom:1px solid #334155; padding:0 24px; display:flex; gap:0; overflow-x:auto; }
.tab-nav .tab { padding:14px 20px; font-size:13px; font-weight:600; color:#64748b; cursor:pointer; border-bottom:3px solid transparent; white-space:nowrap; transition:all .2s; display:flex; align-items:center; gap:8px; }
.tab-nav .tab:hover { color:#a78bfa; background:rgba(167,139,250,.05); }
.tab-nav .tab.active { color:#a78bfa; border-bottom-color:#a78bfa; }
.tab-nav .tab i { font-size:14px; }

/* ë©”ì¸ ì½˜í…ì¸  */
.main-content { max-width:1200px; margin:0 auto; padding:24px; }
.tab-panel { display:none; }
.tab-panel.active { display:block; }

/* ì¹´ë“œ */
.card { background:#1e293b; border:1px solid #334155; border-radius:12px; padding:20px; margin-bottom:16px; }
.card-title { font-size:15px; font-weight:700; color:#f1f5f9; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.card-title i { color:#a78bfa; }

/* í†µê³„ ê·¸ë¦¬ë“œ */
.stat-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:20px; }
.stat-box { background:#1e293b; border:1px solid #334155; border-radius:12px; padding:16px; text-align:center; }
.stat-box .num { font-size:28px; font-weight:800; color:#a78bfa; }
.stat-box .label { font-size:12px; color:#94a3b8; margin-top:4px; }
.stat-box.green .num { color:#22c55e; }
.stat-box.blue .num { color:#3b82f6; }
.stat-box.orange .num { color:#f97316; }
.stat-box.pink .num { color:#ec4899; }

/* í¼ ìŠ¤íƒ€ì¼ */
.form-group { margin-bottom:14px; }
.form-group label { display:block; font-size:12px; font-weight:600; color:#94a3b8; margin-bottom:6px; }
.form-input { width:100%; background:#0f172a; border:1px solid #334155; border-radius:8px; padding:10px 14px; color:#e2e8f0; font-size:14px; font-family:inherit; }
.form-input:focus { outline:none; border-color:#a78bfa; }
select.form-input { cursor:pointer; }
textarea.form-input { resize:vertical; min-height:80px; }

/* ë²„íŠ¼ */
.btn { padding:10px 20px; border:none; border-radius:8px; font-size:13px; font-weight:700; cursor:pointer; transition:all .2s; display:inline-flex; align-items:center; gap:6px; font-family:inherit; }
.btn-primary { background:#7c3aed; color:#fff; }
.btn-primary:hover { background:#6d28d9; }
.btn-success { background:#16a34a; color:#fff; }
.btn-success:hover { background:#15803d; }
.btn-danger { background:#dc2626; color:#fff; }
.btn-danger:hover { background:#b91c1c; }
.btn-outline { background:transparent; border:1px solid #475569; color:#94a3b8; }
.btn-outline:hover { background:#334155; color:#fff; }
.btn-sm { padding:6px 12px; font-size:12px; }
.btn-lg { padding:12px 28px; font-size:15px; }

/* ì½˜í…ì¸  ë¦¬ìŠ¤íŠ¸ */
.content-item { background:#0f172a; border:1px solid #334155; border-radius:10px; padding:16px; margin-bottom:10px; transition:all .2s; }
.content-item:hover { border-color:#475569; }
.content-item .ci-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
.content-item .ci-title { font-size:14px; font-weight:700; color:#f1f5f9; }
.content-item .ci-meta { font-size:11px; color:#64748b; display:flex; gap:10px; flex-wrap:wrap; }
.content-item .ci-body { font-size:13px; color:#94a3b8; line-height:1.6; margin-top:8px; }
.content-item .ci-actions { margin-top:10px; display:flex; gap:6px; flex-wrap:wrap; }

/* ìƒíƒœ ë±ƒì§€ */
.badge { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; border-radius:20px; font-size:11px; font-weight:700; }
.badge-draft { background:#1e293b; border:1px solid #475569; color:#94a3b8; }
.badge-approved { background:#052e16; border:1px solid #166534; color:#22c55e; }
.badge-published { background:#172554; border:1px solid #1e40af; color:#3b82f6; }
.badge-failed { background:#450a0a; border:1px solid #991b1b; color:#f87171; }
.badge-platform { background:#2e1065; border:1px solid #6d28d9; color:#a78bfa; }

/* ì£¼ì œ ì¹´ë“œ */
.topic-card { background:#0f172a; border:1px solid #334155; border-radius:10px; padding:14px; margin-bottom:8px; display:flex; align-items:center; gap:12px; }
.topic-card .tc-info { flex:1; }
.topic-card .tc-name { font-size:14px; font-weight:700; color:#f1f5f9; }
.topic-card .tc-keywords { font-size:12px; color:#64748b; margin-top:4px; }
.topic-card .tc-toggle { width:44px; height:24px; border-radius:12px; background:#334155; cursor:pointer; position:relative; transition:all .2s; border:none; }
.topic-card .tc-toggle.on { background:#7c3aed; }
.topic-card .tc-toggle::after { content:''; position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:50%; background:#fff; transition:all .2s; }
.topic-card .tc-toggle.on::after { left:23px; }

/* YouTube ì„¤ì • */
.yt-status { display:flex; align-items:center; gap:8px; padding:12px 16px; border-radius:10px; margin-bottom:16px; }
.yt-status.connected { background:#052e16; border:1px solid #166534; }
.yt-status.disconnected { background:#450a0a; border:1px solid #991b1b; }
.yt-status i { font-size:18px; }

/* ëª¨ë‹¬ */
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:1000; align-items:center; justify-content:center; }
.modal-overlay.show { display:flex; }
.modal-box { background:#1e293b; border:1px solid #334155; border-radius:16px; padding:24px; width:90%; max-width:600px; max-height:85vh; overflow-y:auto; }
.modal-box h3 { font-size:17px; font-weight:800; margin-bottom:16px; color:#f1f5f9; }

/* ë¡œë”© */
.loading-spinner { display:inline-block; width:18px; height:18px; border:3px solid #334155; border-top-color:#a78bfa; border-radius:50%; animation:spin .8s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }

/* ë¹ˆ ìƒíƒœ */
.empty-state { text-align:center; padding:40px; color:#64748b; }
.empty-state i { font-size:40px; margin-bottom:12px; color:#334155; }
.empty-state p { font-size:14px; }

/* ë°˜ì‘í˜• */
@media (max-width:768px) {
    .tab-nav .tab { padding:12px 14px; font-size:12px; }
    .tab-nav .tab span { display:none; }
    .stat-grid { grid-template-columns:repeat(2, 1fr); }
    .main-content { padding:16px; }
}

/* ìƒì„± ì§„í–‰ ìƒíƒœ */
.gen-progress { background:#0f172a; border:1px solid #334155; border-radius:10px; padding:16px; margin-bottom:16px; }
.gen-progress .step { display:flex; align-items:center; gap:10px; padding:6px 0; font-size:13px; color:#64748b; }
.gen-progress .step.active { color:#a78bfa; }
.gen-progress .step.done { color:#22c55e; }
.gen-progress .step i { width:20px; text-align:center; }

/* ë¸”ë¡œê·¸ ë¯¸ë¦¬ë³´ê¸° */
.blog-preview { background:#fff; color:#1e293b; border-radius:12px; padding:24px; }
.blog-preview h2 { font-size:20px; margin-bottom:12px; }
.blog-preview p { line-height:1.8; font-size:14px; color:#475569; }
</style>
</head>
<body>

<!-- ìƒë‹¨ í—¤ë” -->
<div class="top-header">
    <div class="logo" onclick="location.href='global_admin.html'">
        <i class="fa-solid fa-robot"></i> ë§ˆì¼€íŒ… ë´‡
    </div>
    <div style="display:flex; align-items:center; gap:12px;">
        <span class="user-info" id="userInfo">ë¡œë”© ì¤‘...</span>
        <button class="back-btn" onclick="location.href='global_admin.html'"><i class="fa-solid fa-arrow-left"></i> ê´€ë¦¬ì</button>
    </div>
</div>

<!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
<div class="tab-nav">
    <div class="tab active" onclick="switchTab('dashboard',this)"><i class="fa-solid fa-chart-pie"></i> <span>ëŒ€ì‹œë³´ë“œ</span></div>
    <div class="tab" onclick="switchTab('content',this)"><i class="fa-solid fa-file-lines"></i> <span>ì½˜í…ì¸ </span></div>
    <div class="tab" onclick="switchTab('generate',this)"><i class="fa-solid fa-wand-magic-sparkles"></i> <span>AI ìƒì„±</span></div>
    <div class="tab" onclick="switchTab('topics',this)"><i class="fa-solid fa-tags"></i> <span>ì£¼ì œ ì„¤ì •</span></div>
    <div class="tab" onclick="switchTab('youtube',this)"><i class="fa-brands fa-youtube"></i> <span>YouTube</span></div>
    <div class="tab" onclick="switchTab('blog',this)"><i class="fa-solid fa-blog"></i> <span>ë¸”ë¡œê·¸</span></div>
    <div class="tab" onclick="switchTab('settings',this)"><i class="fa-solid fa-gear"></i> <span>ì„¤ì •</span></div>
</div>

<!-- ===== ëŒ€ì‹œë³´ë“œ íƒ­ ===== -->
<div class="main-content">
<div class="tab-panel active" id="panel-dashboard">
    <div class="stat-grid">
        <div class="stat-box"><div class="num" id="statTotal">0</div><div class="label">ì „ì²´ ì½˜í…ì¸ </div></div>
        <div class="stat-box green"><div class="num" id="statPublished">0</div><div class="label">ë°œí–‰ë¨</div></div>
        <div class="stat-box blue"><div class="num" id="statDraft">0</div><div class="label">ëŒ€ê¸°ì¤‘</div></div>
        <div class="stat-box orange"><div class="num" id="statScheduled">0</div><div class="label">ì˜ˆì•½ë¨</div></div>
    </div>

    <div class="card">
        <div class="card-title"><i class="fa-solid fa-clock-rotate-left"></i> ìµœê·¼ ìƒì„± ì½˜í…ì¸ </div>
        <div id="recentContent">
            <div class="empty-state"><i class="fa-solid fa-inbox"></i><p>ì•„ì§ ìƒì„±ëœ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>
        </div>
    </div>

    <div class="card">
        <div class="card-title"><i class="fa-brands fa-youtube"></i> YouTube í™œë™</div>
        <div id="youtubeActivity">
            <div class="empty-state"><i class="fa-solid fa-link-slash"></i><p>YouTube ì±„ë„ì„ ì—°ê²°í•´ì£¼ì„¸ìš”</p></div>
        </div>
    </div>
</div>

<!-- ===== ì½˜í…ì¸  ê´€ë¦¬ íƒ­ ===== -->
<div class="tab-panel" id="panel-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <div style="display:flex; gap:8px;">
            <button class="btn btn-outline btn-sm" onclick="filterContent('all')">ì „ì²´</button>
            <button class="btn btn-outline btn-sm" onclick="filterContent('draft')">ëŒ€ê¸°</button>
            <button class="btn btn-outline btn-sm" onclick="filterContent('approved')">ìŠ¹ì¸</button>
            <button class="btn btn-outline btn-sm" onclick="filterContent('published')">ë°œí–‰</button>
        </div>
        <button class="btn btn-primary btn-sm" onclick="switchTab('generate',document.querySelector('.tab:nth-child(3)'))"><i class="fa-solid fa-plus"></i> ìƒˆ ì½˜í…ì¸ </button>
    </div>
    <div id="contentList">
        <div class="empty-state"><i class="fa-solid fa-folder-open"></i><p>ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤. AI ìƒì„± íƒ­ì—ì„œ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p></div>
    </div>
</div>

<!-- ===== AI ì½˜í…ì¸  ìƒì„± íƒ­ ===== -->
<div class="tab-panel" id="panel-generate">
    <div class="card">
        <div class="card-title"><i class="fa-solid fa-wand-magic-sparkles"></i> AI ì½˜í…ì¸  ìƒì„±</div>

        <div class="form-group">
            <label>í”Œë«í¼ ì„ íƒ</label>
            <select class="form-input" id="genPlatform">
                <option value="youtube_shorts">YouTube Shorts (60ì´ˆ ëŒ€ë³¸)</option>
                <option value="blog">ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸</option>
                <option value="instagram">Instagram ê²Œì‹œë¬¼</option>
                <option value="tiktok">TikTok ëŒ€ë³¸</option>
                <option value="website">ìì‚¬ ì‚¬ì´íŠ¸ ì½˜í…ì¸ </option>
            </select>
        </div>

        <div class="form-group">
            <label>ì£¼ì œ ì„ íƒ (ë˜ëŠ” ì§ì ‘ ì…ë ¥)</label>
            <select class="form-input" id="genTopic">
                <option value="">-- ì €ì¥ëœ ì£¼ì œì—ì„œ ì„ íƒ --</option>
            </select>
        </div>

        <div class="form-group">
            <label>ì»¤ìŠ¤í…€ ì£¼ì œ/í‚¤ì›Œë“œ (ì§ì ‘ ì…ë ¥)</label>
            <input type="text" class="form-input" id="genCustomTopic" placeholder="ì˜ˆ: í—ˆë‹ˆì»´ë³´ë“œ ì¸í…Œë¦¬ì–´ í™œìš©ë²•, ì¹´í˜ í¬í† ì¡´ ë§Œë“¤ê¸°">
        </div>

        <div class="form-group">
            <label>í†¤ & ìŠ¤íƒ€ì¼</label>
            <select class="form-input" id="genTone">
                <option value="professional">ì „ë¬¸ì /ì‹ ë¢°ê°</option>
                <option value="casual">ìºì£¼ì–¼/ì¹œê·¼</option>
                <option value="energetic">ì—ë„ˆì§€/ì—´ì •ì </option>
                <option value="educational">êµìœ¡ì /ì •ë³´ì œê³µ</option>
                <option value="storytelling">ìŠ¤í† ë¦¬í…”ë§</option>
            </select>
        </div>

        <div class="form-group">
            <label>ì–¸ì–´</label>
            <select class="form-input" id="genLang">
                <option value="kr">í•œêµ­ì–´</option>
                <option value="ja">ì¼ë³¸ì–´</option>
                <option value="en">ì˜ì–´</option>
            </select>
        </div>

        <div class="form-group">
            <label>ì¶”ê°€ ì§€ì‹œì‚¬í•­ (ì„ íƒ)</label>
            <textarea class="form-input" id="genInstructions" placeholder="ì˜ˆ: CTAì— cafe2626.com ë§í¬ í¬í•¨, í”„ë¡œëª¨ì…˜ í• ì¸ ì–¸ê¸‰"></textarea>
        </div>

        <button class="btn btn-primary btn-lg" onclick="generateContent()" id="btnGenerate">
            <i class="fa-solid fa-sparkles"></i> AI ì½˜í…ì¸  ìƒì„±
        </button>

        <div id="genProgress" style="display:none; margin-top:16px;">
            <div class="gen-progress">
                <div class="step" id="step1"><i class="fa-solid fa-circle-notch fa-spin"></i> ì£¼ì œ ë¶„ì„ ì¤‘...</div>
                <div class="step" id="step2"><i class="fa-solid fa-circle"></i> ì½˜í…ì¸  ìƒì„± ì¤‘...</div>
                <div class="step" id="step3"><i class="fa-solid fa-circle"></i> í•´ì‹œíƒœê·¸ ìµœì í™”...</div>
                <div class="step" id="step4"><i class="fa-solid fa-circle"></i> ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸ ìƒì„±...</div>
            </div>
        </div>

        <div id="genResult" style="display:none; margin-top:16px;"></div>
    </div>
</div>

<!-- ===== ì£¼ì œ ì„¤ì • íƒ­ ===== -->
<div class="tab-panel" id="panel-topics">
    <div class="card">
        <div class="card-title"><i class="fa-solid fa-plus-circle"></i> ìƒˆ ì£¼ì œ ë“±ë¡</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <input type="text" class="form-input" id="newTopicName" placeholder="ì£¼ì œëª… (ì˜ˆ: ì¹´í˜ ì¸í…Œë¦¬ì–´)" style="flex:1; min-width:200px;">
            <input type="text" class="form-input" id="newTopicKeywords" placeholder="í‚¤ì›Œë“œ (ì½¤ë§ˆ êµ¬ë¶„)" style="flex:1; min-width:200px;">
            <select class="form-input" id="newTopicFreq" style="width:120px;">
                <option value="daily">ë§¤ì¼</option>
                <option value="weekly">ì£¼ 1íšŒ</option>
                <option value="biweekly">ì£¼ 2íšŒ</option>
            </select>
            <button class="btn btn-primary" onclick="addTopic()"><i class="fa-solid fa-plus"></i> ì¶”ê°€</button>
        </div>
    </div>
    <div id="topicList">
        <div class="empty-state"><i class="fa-solid fa-tags"></i><p>ë“±ë¡ëœ ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤</p></div>
    </div>
</div>

<!-- ===== YouTube íƒ­ ===== -->
<div class="tab-panel" id="panel-youtube">
    <div class="card">
        <div class="card-title"><i class="fa-brands fa-youtube"></i> YouTube ì±„ë„ ì—°ê²°</div>
        <div id="ytConnectionStatus" class="yt-status disconnected">
            <i class="fa-solid fa-circle-xmark" style="color:#f87171;"></i>
            <span>YouTube ì±„ë„ì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</span>
        </div>

        <div class="form-group">
            <label>YouTube Data API Key</label>
            <input type="password" class="form-input" id="ytApiKey" placeholder="AIzaSy...">
        </div>
        <div class="form-group">
            <label>OAuth2 Client ID</label>
            <input type="password" class="form-input" id="ytClientId" placeholder="xxxxx.apps.googleusercontent.com">
        </div>
        <div class="form-group">
            <label>OAuth2 Client Secret</label>
            <input type="password" class="form-input" id="ytClientSecret" placeholder="GOCSPX-...">
        </div>
        <div style="display:flex; gap:8px;">
            <button class="btn btn-primary" onclick="saveYoutubeConfig()"><i class="fa-solid fa-floppy-disk"></i> ì €ì¥</button>
            <button class="btn btn-success" onclick="connectYoutube()"><i class="fa-brands fa-google"></i> Google OAuth ì¸ì¦</button>
        </div>
    </div>

    <div class="card">
        <div class="card-title"><i class="fa-solid fa-upload"></i> Shorts ì—…ë¡œë“œ</div>
        <div class="form-group">
            <label>ì˜ìƒ íŒŒì¼ (MP4, 60ì´ˆ ì´í•˜)</label>
            <input type="file" class="form-input" id="ytVideoFile" accept="video/mp4">
        </div>
        <div class="form-group">
            <label>ì œëª©</label>
            <input type="text" class="form-input" id="ytVideoTitle" placeholder="ì˜ìƒ ì œëª©">
        </div>
        <div class="form-group">
            <label>ì„¤ëª…</label>
            <textarea class="form-input" id="ytVideoDesc" placeholder="ì˜ìƒ ì„¤ëª…"></textarea>
        </div>
        <div class="form-group">
            <label>íƒœê·¸ (ì½¤ë§ˆ êµ¬ë¶„)</label>
            <input type="text" class="form-input" id="ytVideoTags" placeholder="ì¸í…Œë¦¬ì–´,ê°„íŒ,í¬í† ì¡´">
        </div>
        <button class="btn btn-danger" onclick="uploadToYoutube()"><i class="fa-brands fa-youtube"></i> YouTube ì—…ë¡œë“œ</button>
        <div id="uploadProgress" style="display:none; margin-top:12px;"></div>
    </div>

    <div class="card">
        <div class="card-title"><i class="fa-solid fa-reply"></i> ëŒ“ê¸€ ìë™ ë‹µê¸€</div>
        <div class="form-group">
            <label>ìë™ ë‹µê¸€ í™œì„±í™”</label>
            <div style="display:flex; align-items:center; gap:12px;">
                <button class="tc-toggle" id="autoReplyToggle" onclick="toggleAutoReply()"></button>
                <span id="autoReplyStatus" style="font-size:13px; color:#64748b;">ë¹„í™œì„±</span>
            </div>
        </div>
        <div class="form-group">
            <label>ë‹µê¸€ í…œí”Œë¦¿</label>
            <textarea class="form-input" id="autoReplyTemplate" placeholder="ê°ì‚¬í•©ë‹ˆë‹¤! ë” ê¶ê¸ˆí•œ ì ì€ cafe2626.comì„ ë°©ë¬¸í•´ì£¼ì„¸ìš” ğŸ˜Š"></textarea>
            <div style="font-size:11px; color:#64748b; margin-top:4px;">
                ë³€ìˆ˜: {commenter} = ëŒ“ê¸€ ì‘ì„±ì, {video_title} = ì˜ìƒ ì œëª©
            </div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="saveAutoReply()"><i class="fa-solid fa-save"></i> ë‹µê¸€ ì„¤ì • ì €ì¥</button>

        <div style="margin-top:16px;">
            <div class="card-title"><i class="fa-solid fa-clock-rotate-left"></i> ìµœê·¼ ìë™ ë‹µê¸€</div>
            <div id="replyLog">
                <div class="empty-state" style="padding:20px;"><p>ì•„ì§ ìë™ ë‹µê¸€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p></div>
            </div>
        </div>
    </div>
</div>

<!-- ===== ë¸”ë¡œê·¸ íƒ­ ===== -->
<div class="tab-panel" id="panel-blog">
    <div class="card">
        <div class="card-title"><i class="fa-solid fa-blog"></i> ìì‚¬ ì‚¬ì´íŠ¸ ë¸”ë¡œê·¸ ê´€ë¦¬</div>
        <p style="font-size:13px; color:#94a3b8; margin-bottom:16px;">
            AIê°€ ìƒì„±í•œ ë¸”ë¡œê·¸ ì½˜í…ì¸ ë¥¼ ìì‚¬ ì‚¬ì´íŠ¸(cafe2626.com/cafe0101.com/cafe3355.com)ì— ê²Œì‹œí•©ë‹ˆë‹¤.
        </p>
        <div id="blogContentList">
            <div class="empty-state"><i class="fa-solid fa-newspaper"></i><p>ë°œí–‰í•  ë¸”ë¡œê·¸ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤. AI ìƒì„± íƒ­ì—ì„œ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p></div>
        </div>
    </div>

    <div class="card">
        <div class="card-title"><i class="fa-solid fa-eye"></i> ë¸”ë¡œê·¸ ë¯¸ë¦¬ë³´ê¸°</div>
        <div id="blogPreview">
            <div class="empty-state" style="padding:20px;"><p>ì½˜í…ì¸ ë¥¼ ì„ íƒí•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤</p></div>
        </div>
    </div>
</div>

<!-- ===== ì„¤ì • íƒ­ ===== -->
<div class="tab-panel" id="panel-settings">
    <div class="card">
        <div class="card-title"><i class="fa-solid fa-globe"></i> ì‚¬ì´íŠ¸ ì •ë³´</div>
        <div class="form-group">
            <label>íšŒì‚¬/ë¸Œëœë“œëª…</label>
            <input type="text" class="form-input" id="setBrandName" value="ì¹´ë©œë ˆì˜¨ í”„ë¦°íŠ¸">
        </div>
        <div class="form-group">
            <label>ì‚¬ì´íŠ¸ URL (KR)</label>
            <input type="text" class="form-input" id="setSiteKr" value="https://cafe2626.com">
        </div>
        <div class="form-group">
            <label>ì‚¬ì´íŠ¸ URL (JP)</label>
            <input type="text" class="form-input" id="setSiteJp" value="https://cafe0101.com">
        </div>
        <div class="form-group">
            <label>ì‚¬ì´íŠ¸ URL (US)</label>
            <input type="text" class="form-input" id="setSiteUs" value="https://cafe3355.com">
        </div>
    </div>

    <div class="card">
        <div class="card-title"><i class="fa-solid fa-bullseye"></i> ë§ˆì¼€íŒ… í¬ì¸íŠ¸</div>
        <div class="form-group">
            <label>í•µì‹¬ í‚¤ì›Œë“œ (ì „ì²´ ì½˜í…ì¸ ì— ë°˜ì˜)</label>
            <input type="text" class="form-input" id="setCoreKeywords" value="í—ˆë‹ˆì»´ë³´ë“œ,íŒ¨ë¸Œë¦­ì¸ì‡„,í¬í† ì¡´,ë“±ì‹ ëŒ€,ì¹´í˜ì¸í…Œë¦¬ì–´,ì¹œí™˜ê²½ì¸ì‡„">
        </div>
        <div class="form-group">
            <label>USP (í•µì‹¬ ê°•ì )</label>
            <textarea class="form-input" id="setUsp">ì¹œí™˜ê²½ ì¢…ì´ í—ˆë‹ˆì»´ë³´ë“œ ì „ë¬¸, ë¬´ë£Œ ì˜¨ë¼ì¸ ë””ìì¸ ì—ë””í„°, ì „êµ­ ë‹¹ì¼ë°°ì†¡, í¬í† ì¡´/ë“±ì‹ ëŒ€/ë°°ë„ˆ ì „ë¬¸ ì¸ì‡„</textarea>
        </div>
        <div class="form-group">
            <label>CTA ë©”ì‹œì§€</label>
            <input type="text" class="form-input" id="setCtaMsg" value="ì§€ê¸ˆ ë°”ë¡œ ë¬´ë£Œ ë””ìì¸ ì‹œì‘í•˜ê¸° â†’ cafe2626.com">
        </div>
        <button class="btn btn-primary" onclick="saveSettings()"><i class="fa-solid fa-save"></i> ì„¤ì • ì €ì¥</button>
    </div>
</div>

</div><!-- /main-content -->

<!-- ì½˜í…ì¸  ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal-overlay" id="contentDetailModal">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h3 id="modalTitle">ì½˜í…ì¸  ìƒì„¸</h3>
            <button class="btn btn-outline btn-sm" onclick="closeModal('contentDetailModal')"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="modalBody"></div>
        <div style="margin-top:16px; display:flex; gap:8px; justify-content:flex-end;" id="modalActions"></div>
    </div>
</div>

<script type="module">
import { initConfig, sb as _sb, currentUser, isAdmin } from './config.js?v=119';

let sb;
const SUPABASE_URL = 'https://qinvtnhiidtmrzosyvys.supabase.co';

// ===== ì´ˆê¸°í™” =====
(async function init() {
    await initConfig();
    sb = window.sb || _sb;
    if (!sb) { alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨'); return; }

    const { data: { user } } = await sb.auth.getUser();
    if (!user) { location.href = 'index.html'; return; }

    document.getElementById('userInfo').innerText = user.email;

    // ê´€ë¦¬ì í™•ì¸
    const adminEmails = ['korea900as@gmail.com', 'ceo@test.com'];
    if (!adminEmails.includes(user.email)) {
        alert('ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤');
        location.href = 'index.html';
        return;
    }

    // OAuth ì½œë°± ì²˜ë¦¬ (sb ì´ˆê¸°í™” í›„ ì‹¤í–‰)
    handleOAuthCallback();

    // ë°ì´í„° ë¡œë“œ
    loadDashboard();
    loadTopics();
    loadYoutubeConfig();
})();

// ===== íƒ­ ì „í™˜ =====
window.switchTab = function(tabId, el) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('panel-' + tabId).classList.add('active');
    if (el) el.classList.add('active');

    if (tabId === 'dashboard') loadDashboard();
    if (tabId === 'content') loadContentList();
    if (tabId === 'topics') loadTopics();
    if (tabId === 'blog') loadBlogContent();
};

// ===== ëŒ€ì‹œë³´ë“œ =====
async function loadDashboard() {
    try {
        const { data: contents } = await sb.from('marketing_content').select('id, status, platform, title, created_at').order('created_at', { ascending: false }).limit(50);
        if (!contents) return;

        document.getElementById('statTotal').innerText = contents.length;
        document.getElementById('statPublished').innerText = contents.filter(c => c.status === 'published').length;
        document.getElementById('statDraft').innerText = contents.filter(c => c.status === 'draft' || c.status === 'approved').length;
        document.getElementById('statScheduled').innerText = contents.filter(c => c.status === 'scheduled').length;

        // ìµœê·¼ ì½˜í…ì¸ 
        const recent = contents.slice(0, 5);
        if (recent.length === 0) return;

        const platformIcon = { youtube_shorts: 'fa-brands fa-youtube', blog: 'fa-solid fa-blog', instagram: 'fa-brands fa-instagram', tiktok: 'fa-brands fa-tiktok', website: 'fa-solid fa-globe' };
        const platformName = { youtube_shorts: 'YouTube Shorts', blog: 'ë¸”ë¡œê·¸', instagram: 'Instagram', tiktok: 'TikTok', website: 'ì‚¬ì´íŠ¸' };

        let html = '';
        recent.forEach(c => {
            const date = new Date(c.created_at).toLocaleDateString('ko-KR');
            html += `<div class="content-item" onclick="viewContent(${c.id})" style="cursor:pointer;">
                <div class="ci-header">
                    <div class="ci-title">${c.title || '(ì œëª© ì—†ìŒ)'}</div>
                    <span class="badge badge-${c.status}">${c.status}</span>
                </div>
                <div class="ci-meta">
                    <span><i class="${platformIcon[c.platform] || 'fa-solid fa-file'}"></i> ${platformName[c.platform] || c.platform}</span>
                    <span>${date}</span>
                </div>
            </div>`;
        });
        document.getElementById('recentContent').innerHTML = html;
    } catch(e) { console.error('Dashboard error:', e); }
}

// ===== ì½˜í…ì¸  ëª©ë¡ =====
let contentFilter = 'all';
window.filterContent = function(f) { contentFilter = f; loadContentList(); };

async function loadContentList() {
    const container = document.getElementById('contentList');
    container.innerHTML = '<div style="text-align:center; padding:20px;"><div class="loading-spinner"></div></div>';

    let query = sb.from('marketing_content').select('*').order('created_at', { ascending: false });
    if (contentFilter !== 'all') query = query.eq('status', contentFilter);

    const { data } = await query.limit(50);
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fa-solid fa-folder-open"></i><p>ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
    }

    const platformIcon = { youtube_shorts: 'fa-brands fa-youtube', blog: 'fa-solid fa-blog', instagram: 'fa-brands fa-instagram', tiktok: 'fa-brands fa-tiktok', website: 'fa-solid fa-globe' };

    let html = '';
    data.forEach(c => {
        const date = new Date(c.created_at).toLocaleDateString('ko-KR');
        const body = (c.body || c.short_script || '').substring(0, 120);
        const tags = (c.hashtags || []).slice(0, 5).map(t => `#${t}`).join(' ');
        html += `<div class="content-item">
            <div class="ci-header">
                <div>
                    <div class="ci-title">${c.title || '(ì œëª© ì—†ìŒ)'}</div>
                    <div class="ci-meta">
                        <span><i class="${platformIcon[c.platform] || 'fa-solid fa-file'}"></i> ${c.platform}</span>
                        <span>${date}</span>
                        ${tags ? '<span style="color:#a78bfa;">'+tags+'</span>' : ''}
                    </div>
                </div>
                <span class="badge badge-${c.status}">${c.status}</span>
            </div>
            <div class="ci-body">${body}${body.length >= 120 ? '...' : ''}</div>
            <div class="ci-actions">
                <button class="btn btn-outline btn-sm" onclick="viewContent(${c.id})"><i class="fa-solid fa-eye"></i> ë³´ê¸°</button>
                ${c.status === 'draft' ? '<button class="btn btn-success btn-sm" onclick="approveContent('+c.id+')"><i class="fa-solid fa-check"></i> ìŠ¹ì¸</button>' : ''}
                ${c.status === 'approved' ? '<button class="btn btn-primary btn-sm" onclick="publishContent('+c.id+')"><i class="fa-solid fa-paper-plane"></i> ë°œí–‰</button>' : ''}
                <button class="btn btn-outline btn-sm" onclick="copyContent(${c.id})"><i class="fa-solid fa-copy"></i> ë³µì‚¬</button>
                <button class="btn btn-danger btn-sm" onclick="deleteContent(${c.id})"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>`;
    });
    container.innerHTML = html;
}

// ===== AI ì½˜í…ì¸  ìƒì„± =====
window.generateContent = async function() {
    const platform = document.getElementById('genPlatform').value;
    const topicSelect = document.getElementById('genTopic').value;
    const customTopic = document.getElementById('genCustomTopic').value.trim();
    const tone = document.getElementById('genTone').value;
    const lang = document.getElementById('genLang').value;
    const instructions = document.getElementById('genInstructions').value.trim();

    const topic = customTopic || topicSelect;
    if (!topic) { alert('ì£¼ì œë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }

    const btn = document.getElementById('btnGenerate');
    const progress = document.getElementById('genProgress');
    const result = document.getElementById('genResult');

    btn.disabled = true;
    btn.innerHTML = '<div class="loading-spinner"></div> ìƒì„± ì¤‘...';
    progress.style.display = 'block';
    result.style.display = 'none';

    // ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    const coreKeywords = document.getElementById('setCoreKeywords')?.value || '';
    const usp = document.getElementById('setUsp')?.value || '';
    const ctaMsg = document.getElementById('setCtaMsg')?.value || '';

    try {
        // Step 1
        updateStep(1, 'active');

        const { data, error } = await sb.functions.invoke('marketing-content', {
            body: { platform, topic, tone, lang, instructions, coreKeywords, usp, ctaMsg }
        });

        if (error) throw error;

        updateStep(1, 'done');
        updateStep(2, 'done');
        updateStep(3, 'done');
        updateStep(4, 'done');

        if (data && data.content) {
            const content = data.content;

            // DBì— ì €ì¥
            const { data: saved, error: saveErr } = await sb.from('marketing_content').insert({
                topic_id: topicSelect ? parseInt(topicSelect) : null,
                platform: platform,
                title: content.title || '',
                body: content.body || '',
                short_script: content.short_script || '',
                hashtags: content.hashtags || [],
                thumbnail_prompt: content.thumbnail_prompt || '',
                status: 'draft'
            }).select().single();

            if (saveErr) console.error('Save error:', saveErr);

            // ê²°ê³¼ í‘œì‹œ
            result.style.display = 'block';
            result.innerHTML = renderGeneratedContent(content, saved?.id);
        }
    } catch(e) {
        console.error('Generate error:', e);
        result.style.display = 'block';
        result.innerHTML = `<div class="card" style="border-color:#991b1b;"><div class="card-title" style="color:#f87171;"><i class="fa-solid fa-circle-exclamation"></i> ìƒì„± ì‹¤íŒ¨</div><p style="color:#94a3b8; font-size:13px;">${e.message || e}</p></div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-sparkles"></i> AI ì½˜í…ì¸  ìƒì„±';
    }
};

function updateStep(num, state) {
    const el = document.getElementById('step' + num);
    el.className = 'step ' + state;
    if (state === 'active') el.querySelector('i').className = 'fa-solid fa-circle-notch fa-spin';
    if (state === 'done') el.querySelector('i').className = 'fa-solid fa-circle-check';
}

function renderGeneratedContent(content, savedId) {
    return `<div class="card" style="border-color:#166534;">
        <div class="card-title" style="color:#22c55e;"><i class="fa-solid fa-check-circle"></i> ì½˜í…ì¸  ìƒì„± ì™„ë£Œ!</div>
        <div class="form-group"><label>ì œëª©</label><div style="font-size:16px; font-weight:700; color:#f1f5f9;">${content.title || ''}</div></div>
        ${content.short_script ? `<div class="form-group"><label>ìˆì¸  ëŒ€ë³¸ (60ì´ˆ)</label><div style="background:#0f172a; padding:12px; border-radius:8px; font-size:13px; line-height:1.8; color:#e2e8f0; white-space:pre-wrap;">${content.short_script}</div></div>` : ''}
        ${content.body ? `<div class="form-group"><label>ë³¸ë¬¸</label><div style="background:#0f172a; padding:12px; border-radius:8px; font-size:13px; line-height:1.8; color:#e2e8f0; white-space:pre-wrap;">${content.body}</div></div>` : ''}
        ${content.hashtags && content.hashtags.length ? `<div class="form-group"><label>í•´ì‹œíƒœê·¸</label><div style="color:#a78bfa; font-size:13px;">${content.hashtags.map(t => '#'+t).join(' ')}</div></div>` : ''}
        ${content.thumbnail_prompt ? `<div class="form-group"><label>ì¸ë„¤ì¼ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸</label><div style="background:#0f172a; padding:12px; border-radius:8px; font-size:12px; color:#94a3b8;">${content.thumbnail_prompt}</div></div>` : ''}
        <div style="display:flex; gap:8px; margin-top:12px;">
            ${savedId ? `<button class="btn btn-success" onclick="approveContent(${savedId})"><i class="fa-solid fa-check"></i> ìŠ¹ì¸</button>` : ''}
            <button class="btn btn-outline" onclick="switchTab('content',document.querySelector('.tab:nth-child(2)'))"><i class="fa-solid fa-list"></i> ì½˜í…ì¸  ëª©ë¡</button>
        </div>
    </div>`;
}

// ===== ì½˜í…ì¸  ì•¡ì…˜ =====
window.viewContent = async function(id) {
    const { data } = await sb.from('marketing_content').select('*').eq('id', id).single();
    if (!data) return;

    document.getElementById('modalTitle').innerText = data.title || '(ì œëª© ì—†ìŒ)';
    let html = '';
    if (data.short_script) html += `<div class="form-group"><label>ìˆì¸  ëŒ€ë³¸</label><div style="background:#0f172a; padding:12px; border-radius:8px; font-size:13px; line-height:1.8; white-space:pre-wrap;">${data.short_script}</div></div>`;
    if (data.body) html += `<div class="form-group"><label>ë³¸ë¬¸</label><div style="background:#0f172a; padding:12px; border-radius:8px; font-size:13px; line-height:1.8; white-space:pre-wrap;">${data.body}</div></div>`;
    if (data.hashtags?.length) html += `<div class="form-group"><label>í•´ì‹œíƒœê·¸</label><div style="color:#a78bfa;">${data.hashtags.map(t=>'#'+t).join(' ')}</div></div>`;
    if (data.thumbnail_prompt) html += `<div class="form-group"><label>ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸</label><div style="font-size:12px; color:#94a3b8;">${data.thumbnail_prompt}</div></div>`;
    html += `<div style="font-size:12px; color:#64748b; margin-top:8px;">ìƒíƒœ: <span class="badge badge-${data.status}">${data.status}</span> | ìƒì„±: ${new Date(data.created_at).toLocaleString('ko-KR')}</div>`;

    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalActions').innerHTML = `
        ${data.status === 'draft' ? '<button class="btn btn-success" onclick="approveContent('+id+'); closeModal(\'contentDetailModal\');"><i class="fa-solid fa-check"></i> ìŠ¹ì¸</button>' : ''}
        ${data.status === 'approved' ? '<button class="btn btn-primary" onclick="publishContent('+id+'); closeModal(\'contentDetailModal\');"><i class="fa-solid fa-paper-plane"></i> ë°œí–‰</button>' : ''}
        <button class="btn btn-outline" onclick="closeModal('contentDetailModal')">ë‹«ê¸°</button>`;
    document.getElementById('contentDetailModal').classList.add('show');
};

window.approveContent = async function(id) {
    await sb.from('marketing_content').update({ status: 'approved' }).eq('id', id);
    loadContentList();
    loadDashboard();
};

window.publishContent = async function(id) {
    const { data } = await sb.from('marketing_content').select('*').eq('id', id).single();
    if (!data) return;

    if (data.platform === 'blog' || data.platform === 'website') {
        // ë¸”ë¡œê·¸/ì‚¬ì´íŠ¸: community_postsì— ì‹¤ì œ ê²Œì‹œ + marketing_content ìƒíƒœ ì—…ë°ì´íŠ¸
        try {
            const { data: { user } } = await sb.auth.getUser();
            const authorName = user?.user_metadata?.full_name || user?.email?.split('@')[0] || 'ì¹´ë©œë ˆì˜¨';

            // ë§ˆí¬ë‹¤ìš´ â†’ HTML ê°„ë‹¨ ë³€í™˜
            let htmlBody = (data.body || '')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/## (.*)/g, '<h2>$1</h2>')
                .replace(/### (.*)/g, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            htmlBody = '<p>' + htmlBody + '</p>';

            // KR ë¸”ë¡œê·¸ì— ê²Œì‹œ
            await sb.from('community_posts').insert({
                category: 'blog',
                country_code: 'KR',
                title: data.title || '(ì œëª© ì—†ìŒ)',
                content: htmlBody,
                author_name: authorName,
                author_email: user?.email || '',
                author_id: user?.id || null,
                thumbnail: data.thumbnail_url || null
            });

            await sb.from('marketing_content').update({
                status: 'published',
                published_at: new Date().toISOString()
            }).eq('id', id);

            alert('ë¸”ë¡œê·¸ì— ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤! board.html?cat=blog ì—ì„œ í™•ì¸í•˜ì„¸ìš”.');
        } catch(e) {
            console.error('Blog publish error:', e);
            alert('ë¸”ë¡œê·¸ ê²Œì‹œ ì‹¤íŒ¨: ' + e.message);
        }
    } else if (data.platform === 'youtube_shorts') {
        // YouTube: ì—…ë¡œë“œ íƒ­ìœ¼ë¡œ ì´ë™í•˜ê³  ë°ì´í„° ì±„ìš°ê¸°
        switchTab('youtube', document.querySelector('.tab:nth-child(5)'));
        if (data.title) document.getElementById('ytVideoTitle').value = data.title;
        if (data.body || data.short_script) document.getElementById('ytVideoDesc').value = data.body || data.short_script;
        if (data.hashtags?.length) document.getElementById('ytVideoTags').value = data.hashtags.join(',');
        alert('YouTube íƒ­ì— ì½˜í…ì¸ ê°€ ì±„ì›Œì¡ŒìŠµë‹ˆë‹¤. ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•˜ê³  ì—…ë¡œë“œí•˜ì„¸ìš”.');
    } else {
        // Instagram/TikTok: ì½˜í…ì¸  ë³µì‚¬
        const text = `${data.title}\n\n${data.body || data.short_script || ''}\n\n${(data.hashtags || []).map(t=>'#'+t).join(' ')}`;
        await navigator.clipboard.writeText(text);
        await sb.from('marketing_content').update({ status: 'published', published_at: new Date().toISOString() }).eq('id', id);
        alert('ì½˜í…ì¸ ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! Instagram/TikTokì— ì§ì ‘ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
    }
    loadContentList();
    loadDashboard();
};

window.copyContent = async function(id) {
    const { data } = await sb.from('marketing_content').select('*').eq('id', id).single();
    if (!data) return;
    const text = `${data.title || ''}\n\n${data.body || data.short_script || ''}\n\n${(data.hashtags || []).map(t=>'#'+t).join(' ')}`;
    await navigator.clipboard.writeText(text);
    alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
};

window.deleteContent = async function(id) {
    if (!confirm('ì´ ì½˜í…ì¸ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    await sb.from('marketing_content').delete().eq('id', id);
    loadContentList();
    loadDashboard();
};

window.closeModal = function(id) { document.getElementById(id).classList.remove('show'); };

// ===== ì£¼ì œ ê´€ë¦¬ =====
async function loadTopics() {
    const { data } = await sb.from('marketing_topics').select('*').order('created_at', { ascending: false });
    const container = document.getElementById('topicList');
    const select = document.getElementById('genTopic');

    // ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    if (select) {
        select.innerHTML = '<option value="">-- ì €ì¥ëœ ì£¼ì œì—ì„œ ì„ íƒ --</option>';
        (data || []).forEach(t => {
            select.innerHTML += `<option value="${t.id}">${t.topic}</option>`;
        });
    }

    if (!data || data.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fa-solid fa-tags"></i><p>ë“±ë¡ëœ ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
    }

    let html = '';
    data.forEach(t => {
        const kw = (t.keywords || []).join(', ');
        html += `<div class="topic-card">
            <div class="tc-info">
                <div class="tc-name">${t.topic}</div>
                <div class="tc-keywords">${kw} | ${t.frequency || 'daily'}</div>
            </div>
            <button class="tc-toggle ${t.is_active ? 'on' : ''}" onclick="toggleTopic(${t.id}, ${!t.is_active})"></button>
            <button class="btn btn-danger btn-sm" onclick="deleteTopic(${t.id})" style="margin-left:6px;"><i class="fa-solid fa-trash"></i></button>
        </div>`;
    });
    container.innerHTML = html;
}

window.addTopic = async function() {
    const name = document.getElementById('newTopicName').value.trim();
    const keywords = document.getElementById('newTopicKeywords').value.split(',').map(k => k.trim()).filter(Boolean);
    const freq = document.getElementById('newTopicFreq').value;
    if (!name) { alert('ì£¼ì œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

    await sb.from('marketing_topics').insert({ topic: name, keywords, frequency: freq });
    document.getElementById('newTopicName').value = '';
    document.getElementById('newTopicKeywords').value = '';
    loadTopics();
};

window.toggleTopic = async function(id, active) {
    await sb.from('marketing_topics').update({ is_active: active }).eq('id', id);
    loadTopics();
};

window.deleteTopic = async function(id) {
    if (!confirm('ì´ ì£¼ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    await sb.from('marketing_topics').delete().eq('id', id);
    loadTopics();
};

// ===== YouTube ì„¤ì • =====
async function loadYoutubeConfig() {
    const { data } = await sb.from('marketing_youtube_config').select('*').limit(1).single();
    if (!data) return;

    if (data.api_key) document.getElementById('ytApiKey').value = data.api_key;
    if (data.client_id) document.getElementById('ytClientId').value = data.client_id;
    if (data.client_secret) document.getElementById('ytClientSecret').value = data.client_secret;
    if (data.auto_reply_template) document.getElementById('autoReplyTemplate').value = data.auto_reply_template;

    const toggle = document.getElementById('autoReplyToggle');
    const status = document.getElementById('autoReplyStatus');
    if (data.auto_reply_enabled) {
        toggle.classList.add('on');
        status.innerText = 'í™œì„±';
        status.style.color = '#22c55e';
    }

    if (data.channel_name || data.access_token) {
        const el = document.getElementById('ytConnectionStatus');
        el.className = 'yt-status connected';
        el.innerHTML = `<i class="fa-solid fa-circle-check" style="color:#22c55e;"></i> <span>ì—°ê²°ë¨: ${data.channel_name || 'YouTube ì±„ë„'}</span>`;
    }

    // ëŒ“ê¸€ ë‹µê¸€ ë¡œê·¸
    const { data: replies } = await sb.from('marketing_comment_replies').select('*').order('replied_at', { ascending: false }).limit(10);
    if (replies && replies.length > 0) {
        let html = '';
        replies.forEach(r => {
            html += `<div style="padding:8px 0; border-bottom:1px solid #334155; font-size:12px;">
                <div style="color:#94a3b8;">ì˜ìƒ: ${r.video_id} | ${new Date(r.replied_at).toLocaleString('ko-KR')}</div>
                <div style="color:#64748b; margin-top:2px;">ì›ê¸€: ${(r.comment_text || '').substring(0, 50)}</div>
                <div style="color:#a78bfa; margin-top:2px;">ë‹µê¸€: ${r.reply_text}</div>
            </div>`;
        });
        document.getElementById('replyLog').innerHTML = html;
    }
}

window.saveYoutubeConfig = async function() {
    const config = {
        api_key: document.getElementById('ytApiKey').value,
        client_id: document.getElementById('ytClientId').value,
        client_secret: document.getElementById('ytClientSecret').value,
        updated_at: new Date().toISOString()
    };

    const { data: existing } = await sb.from('marketing_youtube_config').select('id').limit(1).single();
    if (existing) {
        await sb.from('marketing_youtube_config').update(config).eq('id', existing.id);
    } else {
        await sb.from('marketing_youtube_config').insert(config);
    }
    alert('YouTube ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
};

window.connectYoutube = async function() {
    const clientId = document.getElementById('ytClientId').value.trim();
    if (!clientId) { alert('OAuth2 Client IDë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”'); return; }

    // í˜„ì¬ ì ‘ì† URL ê¸°ë°˜ redirect_uri ìƒì„± (í”„ë¡œí† ì½œ+í˜¸ìŠ¤íŠ¸+ê²½ë¡œ, ì¿¼ë¦¬/í•´ì‹œ ì œì™¸)
    const currentUrl = window.location.protocol + '//' + window.location.host + window.location.pathname;

    // ë””ë²„ê¹…: ì‹¤ì œ ì „ì†¡ë˜ëŠ” redirect_uri í‘œì‹œ
    console.log('redirect_uri:', currentUrl);
    console.log('client_id:', clientId);

    if (!confirm('redirect_uri: ' + currentUrl + '\n\nGoogle Consoleì— ì´ URIê°€ ë“±ë¡ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const scope = encodeURIComponent('https://www.googleapis.com/auth/youtube https://www.googleapis.com/auth/youtube.force-ssl');
    const authUrl = 'https://accounts.google.com/o/oauth2/v2/auth'
        + '?client_id=' + encodeURIComponent(clientId)
        + '&redirect_uri=' + encodeURIComponent(currentUrl)
        + '&response_type=code'
        + '&scope=' + scope
        + '&access_type=offline'
        + '&prompt=consent';
    window.location.href = authUrl;
};

window.toggleAutoReply = function() {
    const toggle = document.getElementById('autoReplyToggle');
    const status = document.getElementById('autoReplyStatus');
    toggle.classList.toggle('on');
    const isOn = toggle.classList.contains('on');
    status.innerText = isOn ? 'í™œì„±' : 'ë¹„í™œì„±';
    status.style.color = isOn ? '#22c55e' : '#64748b';
};

window.saveAutoReply = async function() {
    const toggle = document.getElementById('autoReplyToggle');
    const template = document.getElementById('autoReplyTemplate').value;

    const { data: existing } = await sb.from('marketing_youtube_config').select('id').limit(1).single();
    const update = { auto_reply_enabled: toggle.classList.contains('on'), auto_reply_template: template, updated_at: new Date().toISOString() };

    if (existing) {
        await sb.from('marketing_youtube_config').update(update).eq('id', existing.id);
    } else {
        await sb.from('marketing_youtube_config').insert(update);
    }
    alert('ìë™ ë‹µê¸€ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
};

// ===== YouTube ì—…ë¡œë“œ =====
window.uploadToYoutube = async function() {
    const file = document.getElementById('ytVideoFile').files[0];
    const title = document.getElementById('ytVideoTitle').value;
    const desc = document.getElementById('ytVideoDesc').value;
    const tags = document.getElementById('ytVideoTags').value.split(',').map(t => t.trim()).filter(Boolean);

    if (!file) { alert('ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
    if (!title) { alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

    const progress = document.getElementById('uploadProgress');
    progress.style.display = 'block';
    progress.innerHTML = '<div class="loading-spinner"></div> YouTube ì—…ë¡œë“œ ì¤‘...';

    try {
        const { data: config } = await sb.from('marketing_youtube_config').select('access_token').limit(1).single();
        if (!config?.access_token) {
            progress.innerHTML = '<span style="color:#f87171;">Google OAuth ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € "Google OAuth ì¸ì¦" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</span>';
            return;
        }

        // YouTube Data API v3 - Resumable Upload
        const metadata = {
            snippet: { title, description: desc, tags, categoryId: '22' },
            status: { privacyStatus: 'public', selfDeclaredMadeForKids: false }
        };

        // Step 1: Initiate upload
        const initRes = await fetch('https://www.googleapis.com/upload/youtube/v3/videos?uploadType=resumable&part=snippet,status', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + config.access_token,
                'Content-Type': 'application/json; charset=UTF-8',
                'X-Upload-Content-Length': file.size,
                'X-Upload-Content-Type': file.type
            },
            body: JSON.stringify(metadata)
        });

        if (!initRes.ok) {
            const errText = await initRes.text();
            throw new Error('Upload init failed: ' + errText);
        }

        const uploadUrl = initRes.headers.get('Location');

        // Step 2: Upload video
        const uploadRes = await fetch(uploadUrl, {
            method: 'PUT',
            headers: { 'Content-Type': file.type },
            body: file
        });

        if (!uploadRes.ok) throw new Error('Upload failed: ' + uploadRes.status);

        const result = await uploadRes.json();
        progress.innerHTML = `<span style="color:#22c55e;"><i class="fa-solid fa-check-circle"></i> ì—…ë¡œë“œ ì™„ë£Œ! Video ID: ${result.id}</span>
            <br><a href="https://youtube.com/shorts/${result.id}" target="_blank" style="color:#a78bfa;">YouTubeì—ì„œ ë³´ê¸°</a>`;

    } catch(e) {
        console.error('Upload error:', e);
        progress.innerHTML = `<span style="color:#f87171;"><i class="fa-solid fa-circle-exclamation"></i> ì—…ë¡œë“œ ì‹¤íŒ¨: ${e.message}</span>`;
    }
};

// ===== ë¸”ë¡œê·¸ ì½˜í…ì¸  =====
async function loadBlogContent() {
    const { data } = await sb.from('marketing_content').select('*').in('platform', ['blog', 'website']).order('created_at', { ascending: false });
    const container = document.getElementById('blogContentList');

    if (!data || data.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fa-solid fa-newspaper"></i><p>ë¸”ë¡œê·¸ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
    }

    let html = '';
    data.forEach(c => {
        const date = new Date(c.created_at).toLocaleDateString('ko-KR');
        html += `<div class="content-item" style="cursor:pointer;" onclick="previewBlog(${c.id})">
            <div class="ci-header">
                <div class="ci-title">${c.title || '(ì œëª© ì—†ìŒ)'}</div>
                <span class="badge badge-${c.status}">${c.status}</span>
            </div>
            <div class="ci-meta"><span>${date}</span></div>
            <div class="ci-actions" style="margin-top:8px;">
                ${c.status === 'draft' ? '<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); approveContent('+c.id+')"><i class="fa-solid fa-check"></i> ìŠ¹ì¸</button>' : ''}
                ${c.status === 'approved' ? '<button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); publishContent('+c.id+')"><i class="fa-solid fa-paper-plane"></i> ë°œí–‰</button>' : ''}
            </div>
        </div>`;
    });
    container.innerHTML = html;
}

window.previewBlog = async function(id) {
    const { data } = await sb.from('marketing_content').select('*').eq('id', id).single();
    if (!data) return;

    document.getElementById('blogPreview').innerHTML = `
        <div class="blog-preview">
            <h2>${data.title || ''}</h2>
            <p>${(data.body || '').replace(/\n/g, '<br>')}</p>
            ${data.hashtags?.length ? '<div style="margin-top:16px; color:#6366f1; font-size:13px;">'+data.hashtags.map(t=>'#'+t).join(' ')+'</div>' : ''}
        </div>`;
};

// ===== ì„¤ì • =====
window.saveSettings = function() {
    localStorage.setItem('mkt_settings', JSON.stringify({
        brandName: document.getElementById('setBrandName').value,
        siteKr: document.getElementById('setSiteKr').value,
        siteJp: document.getElementById('setSiteJp').value,
        siteUs: document.getElementById('setSiteUs').value,
        coreKeywords: document.getElementById('setCoreKeywords').value,
        usp: document.getElementById('setUsp').value,
        ctaMsg: document.getElementById('setCtaMsg').value
    }));
    alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
};

// ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
(function loadSettings() {
    try {
        const saved = JSON.parse(localStorage.getItem('mkt_settings') || '{}');
        if (saved.brandName) document.getElementById('setBrandName').value = saved.brandName;
        if (saved.siteKr) document.getElementById('setSiteKr').value = saved.siteKr;
        if (saved.siteJp) document.getElementById('setSiteJp').value = saved.siteJp;
        if (saved.siteUs) document.getElementById('setSiteUs').value = saved.siteUs;
        if (saved.coreKeywords) document.getElementById('setCoreKeywords').value = saved.coreKeywords;
        if (saved.usp) document.getElementById('setUsp').value = saved.usp;
        if (saved.ctaMsg) document.getElementById('setCtaMsg').value = saved.ctaMsg;
    } catch(e) {}
})();

// OAuth ì½œë°± ì²˜ë¦¬ (init ì—ì„œ sb ì´ˆê¸°í™” í›„ í˜¸ì¶œë¨)
async function handleOAuthCallback() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    if (!code) return;

    // URL ì •ë¦¬
    window.history.replaceState({}, document.title, window.location.pathname);

    try {
        const { data: config } = await sb.from('marketing_youtube_config').select('client_id, client_secret').limit(1).single();
        if (!config) { alert('YouTube ì„¤ì •ì„ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”'); return; }

        // í† í° êµí™˜
        const tokenRes = await fetch('https://oauth2.googleapis.com/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                code,
                client_id: config.client_id,
                client_secret: config.client_secret,
                redirect_uri: window.location.origin + window.location.pathname,
                grant_type: 'authorization_code'
            })
        });

        const tokens = await tokenRes.json();
        if (tokens.error) throw new Error(tokens.error_description || tokens.error);

        // ì±„ë„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const channelRes = await fetch('https://www.googleapis.com/youtube/v3/channels?part=snippet&mine=true', {
            headers: { 'Authorization': 'Bearer ' + tokens.access_token }
        });
        const channelData = await channelRes.json();
        const channelName = channelData.items?.[0]?.snippet?.title || 'Unknown';
        const channelId = channelData.items?.[0]?.id || '';

        // DBì— í† í° ì €ì¥
        const { data: existing } = await sb.from('marketing_youtube_config').select('id').limit(1).single();
        const update = {
            access_token: tokens.access_token,
            refresh_token: tokens.refresh_token || null,
            token_expires_at: new Date(Date.now() + (tokens.expires_in * 1000)).toISOString(),
            channel_id: channelId,
            channel_name: channelName,
            updated_at: new Date().toISOString()
        };

        if (existing) {
            await sb.from('marketing_youtube_config').update(update).eq('id', existing.id);
        } else {
            await sb.from('marketing_youtube_config').insert({ ...update, api_key: '', client_id: '', client_secret: '' });
        }

        alert(`YouTube ì±„ë„ ì—°ê²° ì™„ë£Œ: ${channelName}`);
        loadYoutubeConfig();
    } catch(e) {
        console.error('OAuth error:', e);
        alert('YouTube ì¸ì¦ ì‹¤íŒ¨: ' + e.message);
    }
}

</script>
</body>
</html>