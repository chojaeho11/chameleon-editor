<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#6366f1">
    
    <title>ë°°ì†¡ íŒŒíŠ¸ë„ˆ</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    
    <style>
        /* ì•±ìŠ¤ëŸ¬ìš´ UI ë””ìì¸ */
        body { margin: 0; background: #f1f5f9; font-family: 'Pretendard', sans-serif; color: #334155; -webkit-tap-highlight-color: transparent; padding-bottom: 30px; }
        
        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        .navbar { background: #6366f1; color: white; padding: 15px 20px; padding-top: env(safe-area-inset-top, 20px); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(99,102,241,0.3); }
        .app-header { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 6px; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ (ê¸°ì‚¬ì„ íƒ/ë‚ ì§œ) */
        .controls { background: white; padding: 15px; margin: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 10px; }
        .form-row { display: flex; gap: 10px; }
        .input-box { border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; font-size: 14px; width: 100%; background: #f8fafc; color: #333; outline: none; }
        .input-box:focus { border-color: #6366f1; }

        /* ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
        .task-list { padding: 0 15px; }
        .task-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #f1f5f9; position: relative; overflow: hidden; transition: 0.2s; }
        .task-card.completed { border: 2px solid #22c55e; background: #f0fdf4; }
        
        .status-tag { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 800; background: #e2e8f0; color: #64748b; margin-bottom: 10px; }
        .status-tag.active { background: #e0e7ff; color: #4338ca; }
        .status-tag.done { background: #22c55e; color: white; }

        .client-name { font-size: 18px; font-weight: 800; color: #1e293b; margin-bottom: 5px; }
        .client-addr { font-size: 14px; color: #64748b; line-height: 1.5; display: flex; align-items: start; gap: 5px; }
        .note-box { background: #fff1f2; color: #be123c; padding: 10px; border-radius: 8px; font-size: 13px; margin-top: 10px; line-height: 1.4; border: 1px solid #fecdd3; }

        /* [ì¶”ê°€] ë…¸í•˜ìš° ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .knowhow-area { margin-top: 15px; border-top: 1px dashed #e2e8f0; padding-top: 15px; }
        .knowhow-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 13px; font-weight: 700; color: #d97706; }
        .knowhow-content { background: #fffbeb; padding: 10px; border-radius: 8px; font-size: 13px; color: #92400e; border: 1px solid #fcd34d; line-height: 1.4; }
        .knowhow-input { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; margin-bottom: 5px; resize: none; height: 60px; }
        .btn-knowhow-save { background: #d97706; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; float: right; }

        /* ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .action-btn { padding: 12px; border-radius: 10px; border: none; font-weight: 700; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; text-decoration: none; transition: 0.1s; }
        .btn-call { background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; }
        .btn-map { background: #ecfdf5; color: #059669; border: 1px solid #d1fae5; }
        .btn-call:active, .btn-map:active { transform: scale(0.98); }

        /* ì‹œê°„ ì„ íƒ & ì™„ë£Œ ë²„íŠ¼ */
        .time-select { width: 100%; padding: 12px; margin-top: 15px; border-radius: 10px; border: 2px solid #e2e8f0; font-weight: bold; color: #334155; background: #fff; appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; }
        
        .finish-btn { width: 100%; margin-top: 10px; padding: 15px; border-radius: 12px; border: none; font-size: 16px; font-weight: 800; cursor: pointer; color: white; background: #1e293b; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .finish-btn.done { background: #22c55e; pointer-events: none; }
        .finish-btn:active { transform: scale(0.98); }

        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #94a3b8; }
    </style>
</head>
<body>

<div id="loading">
    <i class="fa-solid fa-circle-notch fa-spin fa-3x" style="color:#6366f1;"></i>
    <div style="font-weight:bold; color:#6366f1;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<div class="navbar">
    <div class="app-header">
        <div class="logo"><i class="fa-solid fa-box"></i> ë°°ì†¡ íŒŒíŠ¸ë„ˆ</div>
        <div style="font-size:13px; opacity:0.8;">v1.1</div>
    </div>
</div>

<div class="controls">
    <div style="font-size:12px; font-weight:bold; color:#64748b; margin-bottom:5px;">ì‘ì—… ì„¤ì •</div>
    <div class="form-row">
        <select id="driverSelect" class="input-box" onchange="saveDriverAndLoad()">
            <option value="">ê¸°ì‚¬ë‹˜ ì„ íƒ...</option>
        </select>
    </div>
    <div class="form-row">
        <input type="date" id="workDate" class="input-box" onchange="loadMyTasks()">
    </div>
</div>

<div id="taskList" class="task-list"></div>

<script type="module">
    import { sb, initConfig } from "./config.js";

    window.addEventListener('DOMContentLoaded', async () => {
        await initConfig();
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('workDate').value = today;

        await loadDriverList();
        
        const savedDriverId = localStorage.getItem('my_driver_id');
        if(savedDriverId) {
            document.getElementById('driverSelect').value = savedDriverId;
            loadMyTasks();
        } else {
            document.getElementById('loading').style.display = 'none';
        }
    });

    // ê¸°ì‚¬ë‹˜ ëª©ë¡ ë¡œë“œ
    async function loadDriverList() {
        const { data } = await sb.from('admin_staff').select('*').eq('role', 'driver');
        const sel = document.getElementById('driverSelect');
        if(data) {
            data.forEach(d => {
                sel.innerHTML += `<option value="${d.id}">${d.name} ê¸°ì‚¬ë‹˜</option>`;
            });
        }
    }

    // ê¸°ì‚¬ ì„ íƒ ì‹œ ì €ì¥ ë° ë¡œë“œ
    window.saveDriverAndLoad = () => {
        const id = document.getElementById('driverSelect').value;
        if(id) localStorage.setItem('my_driver_id', id);
        loadMyTasks();
    };

    // ë°ì´í„° ë¡œë“œ
    window.loadMyTasks = async () => {
        const driverId = document.getElementById('driverSelect').value;
        const date = document.getElementById('workDate').value;
        
        if(!driverId) return;
        document.getElementById('loading').style.display = 'flex';

        // 1. ì£¼ë¬¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const { data: orders, error } = await sb.from('orders')
            .select('*')
            .eq('staff_driver_id', driverId)
            .eq('delivery_target_date', date)
            .order('delivery_time', {ascending: true});

        const list = document.getElementById('taskList');
        list.innerHTML = '';

        if(!orders || orders.length === 0) {
            list.innerHTML = `
                <div class="empty-state">
                    <i class="fa-solid fa-mug-hot fa-3x" style="margin-bottom:15px; opacity:0.5;"></i><br>
                    <strong>ì˜¤ëŠ˜ì€ ë°°ì†¡ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</strong><br>
                    <small>ë‚ ì§œë¥¼ í™•ì¸í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</small>
                </div>`;
            document.getElementById('loading').style.display = 'none';
            return;
        }

        // 2. [ì¶”ê°€] ì´ë²ˆ ì£¼ë¬¸ë“¤ì— í•´ë‹¹í•˜ëŠ” ì£¼ì†Œì˜ ë…¸í•˜ìš° ë°ì´í„° í•œ ë²ˆì— ê°€ì ¸ì˜¤ê¸°
        const addresses = orders.map(o => o.address).filter(a => a); // ì£¼ì†Œë§Œ ì¶”ì¶œ
        let knowhowMap = {};
        
        if(addresses.length > 0) {
            // delivery_knowhow í…Œì´ë¸”ì—ì„œ í•´ë‹¹ ì£¼ì†Œë“¤ ê²€ìƒ‰
            const { data: tips } = await sb.from('delivery_knowhow').select('*').in('address', addresses);
            if(tips) {
                tips.forEach(t => {
                    knowhowMap[t.address] = t; // ì£¼ì†Œë¥¼ í‚¤ë¡œ í•˜ì—¬ ë§µí•‘
                });
            }
        }

        // 3. ì¹´ë“œ ë Œë”ë§
        orders.forEach(o => {
            const isDone = o.status === 'ë°°ì†¡ì™„ë£Œ';
            const timeVal = o.delivery_time || '';
            
            // ì‹œê°„ ì˜µì…˜
            let timeOptions = `<option value="">â±ï¸ ë„ì°© ì˜ˆì • ì‹œê°„ ì…ë ¥</option>`;
            for(let i=8; i<=22; i+=1) {
                 let t = (i<10?'0'+i:i) + ":00";
                 let t_next = (i+1<10?'0'+(i+1):(i+1)) + ":00";
                 timeOptions += `<option value="${t}" ${timeVal===t?'selected':''}>${t} ~ ${t_next}</option>`;
            }

            // ë…¸í•˜ìš° ë°ì´í„° í™•ì¸
            const tip = knowhowMap[o.address];
            let knowhowHtml = '';

            if (tip) {
                // ë…¸í•˜ìš°ê°€ ìˆëŠ” ê²½ìš°
                knowhowHtml = `
                    <div class="knowhow-area">
                        <div class="knowhow-header">
                            <span><i class="fa-solid fa-lightbulb"></i> ë™ë£Œ ê¸°ì‚¬ë‹˜ì˜ ê³µìœ  ë…¸í•˜ìš°</span>
                            <span style="color:#999; font-weight:normal; cursor:pointer;" onclick="toggleEditKnowhow('${o.id}')">ìˆ˜ì •</span>
                        </div>
                        <div id="view_tip_${o.id}" class="knowhow-content">
                            ${tip.content.replace(/\n/g, '<br>')}
                            <div style="margin-top:5px; font-size:11px; opacity:0.7; text-align:right;">- ${tip.writer_name || 'ë™ë£Œê¸°ì‚¬'}ë‹˜ ì‘ì„±</div>
                        </div>
                        <div id="edit_tip_${o.id}" style="display:none;">
                            <textarea id="input_tip_${o.id}" class="knowhow-input" placeholder="ì´ê³³ì˜ ì£¼ì°¨/ë°°ì†¡ ê¿€íŒì„ ê³µìœ í•´ì£¼ì„¸ìš”!">${tip.content}</textarea>
                            <button class="btn-knowhow-save" onclick="saveKnowhow('${o.address}', '${o.id}')">ìˆ˜ì • ì €ì¥</button>
                        </div>
                    </div>
                `;
            } else {
                // ë…¸í•˜ìš°ê°€ ì—†ëŠ” ê²½ìš°
                knowhowHtml = `
                    <div class="knowhow-area">
                        <div class="knowhow-header" onclick="toggleEditKnowhow('${o.id}')" style="cursor:pointer; color:#94a3b8;">
                            <span><i class="fa-regular fa-lightbulb"></i> ì£¼ì°¨/ë°°ì†¡ ë…¸í•˜ìš° ë“±ë¡í•˜ê¸° <i class="fa-solid fa-chevron-down"></i></span>
                        </div>
                        <div id="edit_tip_${o.id}" style="display:none; margin-top:5px;">
                            <textarea id="input_tip_${o.id}" class="knowhow-input" placeholder="ì˜ˆ: 101ë™ ë’¤ìª½ ìª½ë¬¸ ì´ìš©, ë¹„ë°€ë²ˆí˜¸ 1234"></textarea>
                            <button class="btn-knowhow-save" onclick="saveKnowhow('${o.address}', '${o.id}')">ê³µìœ í•˜ê¸°</button>
                        </div>
                    </div>
                `;
            }

            list.innerHTML += `
                <div class="task-card ${isDone ? 'completed' : ''}">
                    <span class="status-tag ${isDone ? 'done' : 'active'}">
                        ${isDone ? 'ë°°ì†¡ì™„ë£Œ' : 'ë°°ì†¡ì¤‘'}
                    </span>
                    
                    <div class="client-name">${o.manager_name}</div>
                    <div class="client-addr">
                        <i class="fa-solid fa-map-pin" style="margin-top:3px; color:#ef4444;"></i> 
                        ${o.address}
                    </div>
                    
                    ${o.request_note ? `<div class="note-box"><i class="fa-solid fa-bullhorn"></i> ${o.request_note}</div>` : ''}

                    ${knowhowHtml}

                    <select class="time-select" onchange="updateDeliveryTime('${o.id}', this.value)" ${isDone?'disabled':''}>
                        ${timeOptions}
                    </select>

                    <div class="btn-group">
                        <a href="tel:${o.phone}" class="action-btn btn-call">
                            <i class="fa-solid fa-phone"></i> ì „í™”ê±¸ê¸°
                        </a>
                        <a href="https://map.naver.com/v5/search/${encodeURIComponent(o.address)}" target="_blank" class="action-btn btn-map">
                            <i class="fa-solid fa-map"></i> ì§€ë„ë³´ê¸°
                        </a>
                    </div>

                    <button class="finish-btn ${isDone?'done':''}" onclick="toggleComplete('${o.id}', '${o.status}')">
                        ${isDone ? '<i class="fa-solid fa-check"></i> ì™„ë£Œëœ ë°°ì†¡ì…ë‹ˆë‹¤' : 'ğŸ“¦ ë°°ì†¡ ì™„ë£Œ ì²˜ë¦¬'}
                    </button>
                </div>
            `;
        });
        document.getElementById('loading').style.display = 'none';
    };

    // ë…¸í•˜ìš° ì…ë ¥ì°½ í† ê¸€
    window.toggleEditKnowhow = (id) => {
        const viewDiv = document.getElementById(`view_tip_${id}`);
        const editDiv = document.getElementById(`edit_tip_${id}`);
        
        if (viewDiv) viewDiv.style.display = 'none';
        if (editDiv) editDiv.style.display = (editDiv.style.display === 'none') ? 'block' : 'none';
    };

    // ë…¸í•˜ìš° ì €ì¥ (Upsert)
    window.saveKnowhow = async (address, orderId) => {
        const content = document.getElementById(`input_tip_${orderId}`).value;
        if (!content.trim()) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        // í˜„ì¬ ì„ íƒëœ ê¸°ì‚¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        const driverSelect = document.getElementById('driverSelect');
        const driverName = driverSelect.options[driverSelect.selectedIndex].text.replace(' ê¸°ì‚¬ë‹˜', '');

        // ì£¼ì†Œê°€ ê°™ì€ ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ì¶”ê°€
        // address ì»¬ëŸ¼ì´ Unique ì œì•½ì¡°ê±´ì´ ì—†ë‹¤ë©´ select í›„ update/insert ë¶„ê¸° ì²˜ë¦¬
        
        // 1. ê¸°ì¡´ ë°ì´í„° í™•ì¸
        const { data: existing } = await sb.from('delivery_knowhow').select('id').eq('address', address).single();
        
        let error;
        if (existing) {
            // ì—…ë°ì´íŠ¸
            const res = await sb.from('delivery_knowhow').update({ 
                content: content, 
                writer_name: driverName,
                created_at: new Date()
            }).eq('id', existing.id);
            error = res.error;
        } else {
            // ì‹ ê·œ ë“±ë¡
            const res = await sb.from('delivery_knowhow').insert([{ 
                address: address, 
                content: content, 
                writer_name: driverName 
            }]);
            error = res.error;
        }

        if (error) {
            alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
        } else {
            alert("ë…¸í•˜ìš°ê°€ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤! ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ‘");
            loadMyTasks(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë°˜ì˜
        }
    };

    window.updateDeliveryTime = async (orderId, time) => {
        if(!time) return;
        const { error } = await sb.from('orders').update({ delivery_time: time }).eq('id', orderId);
        if(error) alert("ì €ì¥ ì‹¤íŒ¨");
    };

    window.toggleComplete = async (orderId, currentStatus) => {
        if(currentStatus === 'ë°°ì†¡ì™„ë£Œ') return;
        if(!confirm("ë°°ì†¡ì„ ì™„ë£Œ ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê´€ë¦¬ì í˜ì´ì§€ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤)")) return;

        const { error } = await sb.from('orders').update({ status: 'ë°°ì†¡ì™„ë£Œ' }).eq('id', orderId);
        if(error) alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
        else loadMyTasks();
    };
</script>

</body>
</html>