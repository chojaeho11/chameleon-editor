<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Today's Chameleon</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Pretendard', sans-serif;
            margin: 0;
            padding: 20px;
            color: #334155;
            -webkit-font-smoothing: antialiased;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 800;
            margin: 0;
            color: #1e293b;
        }

        .refresh-btn {
            background: #fff;
            border: 1px solid #e2e8f0;
            width: 40px; height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s;
        }
        .refresh-btn:active { transform: scale(0.95); background: #f1f5f9; }

        .date-badge {
            display: inline-block;
            background: #e0e7ff;
            color: #4338ca;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        /* 메인 카드 (매출) */
        .main-card {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
            color: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.4);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .main-card .label { font-size: 14px; opacity: 0.8; margin-bottom: 5px; font-weight: 600; }
        .main-card .value { font-size: 36px; font-weight: 900; letter-spacing: -1px; }
        .main-card .sub-value { font-size: 14px; margin-top: 5px; opacity: 0.9; }

        /* 그리드 카드 */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .stat-icon {
            width: 40px; height: 40px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .stat-card .label { font-size: 12px; color: #64748b; font-weight: 600; margin-bottom: 2px; }
        .stat-card .value { font-size: 24px; font-weight: 800; color: #0f172a; }

        /* 색상 테마 */
        .theme-blue { background: #eff6ff; color: #3b82f6; }
        .theme-green { background: #f0fdf4; color: #22c55e; }
        .theme-purple { background: #f5f3ff; color: #8b5cf6; }
        .theme-orange { background: #fff7ed; color: #f97316; }
        .theme-red { background: #fef2f2; color: #ef4444; }

        #loading { display: none; margin-top: 10px; font-size: 12px; color: #666; text-align: center; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1>Dashboard</h1>
            <div style="font-size: 12px; color: #94a3b8;">Mobile View (No Login)</div>
        </div>
        <button class="refresh-btn" onclick="loadTodayData()">
            <i class="fa-solid fa-rotate-right"></i>
        </button>
    </div>

    <div class="date-badge" id="todayDate">2024.01.01 (월)</div>

    <div class="main-card">
        <div class="label">오늘 주문 총액</div>
        <div class="value" id="todayRevenue">0</div>
        <div class="sub-value">총 <span id="todayOrderCount">0</span>건 주문</div>
    </div>

    <div class="grid-container">
        <div class="stat-card">
            <div class="stat-icon theme-purple"><i class="fa-solid fa-crown"></i></div>
            <div class="label">VIP 문의</div>
            <div class="value" id="todayVip">0</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon theme-blue"><i class="fa-solid fa-truck-fast"></i></div>
            <div class="label">오늘 발송예정</div>
            <div class="value" id="todayShip">0</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon theme-green"><i class="fa-solid fa-user-plus"></i></div>
            <div class="label">신규 회원</div>
            <div class="value" id="todayNewMember">0</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon theme-orange"><i class="fa-solid fa-cloud-arrow-up"></i></div>
            <div class="label">템플릿/로고</div>
            <div class="value" id="todayUpload">0</div>
        </div>
    </div>

    <div id="loading"><i class="fa-solid fa-spinner fa-spin"></i> 데이터 갱신 중...</div>

    <script type="module">
        import { sb, initConfig } from './config.js?v=119';

        // 전역 함수로 등록
        window.loadTodayData = async () => {
            const btn = document.querySelector('.refresh-btn');
            const loading = document.getElementById('loading');
            
            btn.style.opacity = '0.5';
            loading.style.display = 'block';

            try {
                // 1. 오늘 날짜 구하기 (KST 기준 00:00:00)
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const day = now.getDate();
                
                // 오늘 시작 시간
                const todayStart = new Date(year, month, day, 0, 0, 0).toISOString();
                // 내일 시작 시간 (오늘 종료)
                const todayEnd = new Date(year, month, day, 23, 59, 59).toISOString();

                // 날짜 표시 업데이트
                const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
                document.getElementById('todayDate').innerText = `${year}.${month+1}.${day} (${dayNames[now.getDay()]})`;

                // 2. 병렬 쿼리 실행 (속도 최적화)
                const [
                    ordersRes, 
                    vipRes, 
                    shipRes, 
                    memberRes, 
                    uploadRes
                ] = await Promise.all([
                    // A. 주문 총액 & 건수 (취소된 주문 제외)
                    sb.from('orders')
                      .select('total_amount, id')
                      .gte('created_at', todayStart)
                      .lte('created_at', todayEnd)
                      .neq('status', '취소됨')
                      .neq('payment_status', '결제취소'),

                    // B. VIP 문의 건수
                    sb.from('vip_orders')
                      .select('id', { count: 'exact', head: true })
                      .gte('created_at', todayStart),

                    // C. 오늘 배송 건수 (배송예정일이 오늘인 것)
                    sb.from('orders')
                      .select('id', { count: 'exact', head: true })
                      .eq('delivery_target_date', now.toISOString().split('T')[0]),

                    // D. 신규 회원 수
                    sb.from('profiles')
                      .select('id', { count: 'exact', head: true })
                      .gte('created_at', todayStart),

                    // E. 템플릿/로고 업로드 수
                    sb.from('library')
                      .select('id', { count: 'exact', head: true })
                      .gte('created_at', todayStart)
                ]);

                // 3. 데이터 계산 및 표시
                
                // A. 매출 계산 (Javascript로 합산)
                let totalRev = 0;
                let orderCount = 0;
                if (ordersRes.data) {
                    orderCount = ordersRes.data.length;
                    totalRev = ordersRes.data.reduce((acc, cur) => acc + (cur.total_amount || 0), 0);
                }
                
                // 숫자 애니메이션 효과
                animateValue("todayRevenue", totalRev, true);
                animateValue("todayOrderCount", orderCount);
                animateValue("todayVip", vipRes.count || 0);
                animateValue("todayShip", shipRes.count || 0);
                animateValue("todayNewMember", memberRes.count || 0);
                animateValue("todayUpload", uploadRes.count || 0);

            } catch (e) {
                console.error(e);
                alert("데이터 로드 실패: " + e.message);
            } finally {
                btn.style.opacity = '1';
                loading.style.display = 'none';
            }
        };

        // 숫자 카운팅 애니메이션 함수
        function animateValue(id, end, isCurrency = false) {
            const obj = document.getElementById(id);
            const start = 0;
            const duration = 1000;
            let startTimestamp = null;
            
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const val = Math.floor(progress * (end - start) + start);
                
                if (isCurrency) {
                    obj.innerHTML = val.toLocaleString() + '<span style="font-size:16px; font-weight:normal;">원</span>';
                } else {
                    obj.innerHTML = val.toLocaleString();
                }
                
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // 초기 실행
        window.addEventListener('DOMContentLoaded', async () => {
            await initConfig(); // config.js 초기화 대기
            loadTodayData();
        });
    </script>
</body>
</html>