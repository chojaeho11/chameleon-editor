<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Today's Chameleon</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Pretendard', sans-serif;
            margin: 0; padding: 20px;
            color: #334155;
            -webkit-font-smoothing: antialiased;
            max-width: 600px; margin: 0 auto;
        }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { font-size: 20px; font-weight: 800; color: #1e293b; }

        .refresh-btn {
            background: #fff; border: 1px solid #e2e8f0; width: 40px; height: 40px;
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            color: #64748b; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s;
        }
        .refresh-btn:active { transform: scale(0.95); background: #f1f5f9; }

        .date-badge {
            display: inline-block; background: #e0e7ff; color: #4338ca;
            padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; margin-bottom: 15px;
        }

        /* ë©”ì¸ ì¹´ë“œ */
        .main-card {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
            color: white; padding: 25px; border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.4);
            margin-bottom: 20px; text-align: center;
        }
        .main-card .label { font-size: 14px; opacity: 0.8; margin-bottom: 5px; font-weight: 600; }
        .main-card .value { font-size: 32px; font-weight: 900; letter-spacing: -1px; }
        .main-card .sub-value { font-size: 13px; margin-top: 10px; opacity: 0.9; display: flex; justify-content: center; gap: 10px;}
        .main-card .divider { width: 1px; background: rgba(255,255,255,0.3); }

        .section-title { font-size: 14px; font-weight: 700; color: #475569; margin: 25px 0 10px 5px; }

        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }

        .stat-card {
            background: white; padding: 15px; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #f1f5f9;
            text-align: center; display: flex; flex-direction: column; align-items: center;
        }
        .stat-icon {
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; margin-bottom: 8px;
        }
        .stat-card .label { font-size: 11px; color: #64748b; font-weight: 600; margin-bottom: 2px; }
        .stat-card .value { font-size: 20px; font-weight: 800; color: #0f172a; }

        .list-card {
            background: white; border-radius: 16px; padding: 15px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #f1f5f9;
        }
        .list-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid #f1f5f9;
        }
        .list-row:last-child { border-bottom: none; }
        .rank-num { width: 24px; font-weight: 800; color: #cbd5e1; font-style: italic; }
        .row-info { flex: 1; font-size: 13px; font-weight: 500; color: #334155; }
        .row-value { font-size: 13px; font-weight: 700; color: #1e293b; }

        .progress-bg { height: 6px; background: #f1f5f9; border-radius: 3px; margin-top: 5px; width: 100%; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 3px; }

        .theme-blue { background: #eff6ff; color: #3b82f6; }
        .theme-green { background: #f0fdf4; color: #22c55e; }
        .theme-purple { background: #f5f3ff; color: #8b5cf6; }
        .theme-orange { background: #fff7ed; color: #f97316; }
        .theme-red { background: #fef2f2; color: #ef4444; }
        .theme-teal { background: #ccfbf1; color: #14b8a6; }

        /* ì°¨íŠ¸ ê´€ë ¨ */
        .chart-row { display: flex; gap: 12px; margin-bottom: 20px; }
        .chart-card {
            background: white; padding: 15px; border-radius: 16px; flex: 1;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #f1f5f9;
        }
        .chart-label { font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 8px; text-align: center; }
        .chart-total { font-size: 18px; font-weight: 900; color: #0f172a; text-align: center; margin-bottom: 4px; }

        /* êµ­ê°€ ì¹´ë“œ */
        .country-card {
            background: white; padding: 14px 10px; border-radius: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #f1f5f9;
            text-align: center;
        }
        .country-flag { font-size: 28px; margin-bottom: 4px; }
        .country-name { font-size: 11px; color: #64748b; font-weight: 600; }
        .country-amount { font-size: 15px; font-weight: 800; color: #0f172a; margin-top: 4px; }
        .country-orders { font-size: 11px; color: #94a3b8; margin-top: 2px; }

        /* ì¹´í…Œê³ ë¦¬/ì œí’ˆ ë°” */
        .sale-bar-row { margin-bottom: 10px; }
        .sale-bar-top { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
        .sale-bar-name { font-weight: 600; color: #334155; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 8px; }
        .sale-bar-val { font-weight: 700; color: #1e293b; white-space: nowrap; }

        #loading { display: none; margin-top: 10px; font-size: 12px; color: #666; text-align: center; }

        /* íƒ­ ë²„íŠ¼ */
        .period-tabs { display: flex; gap: 6px; margin-bottom: 12px; }
        .period-tab {
            padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;
            border: 1px solid #e2e8f0; background: white; color: #64748b; cursor: pointer;
        }
        .period-tab.active { background: #4f46e5; color: white; border-color: #4f46e5; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1>Dashboard</h1>
            <div style="font-size: 12px; color: #94a3b8;">Mobile View (Live)</div>
        </div>
        <button class="refresh-btn" onclick="loadTodayData()">
            <i class="fa-solid fa-rotate-right"></i>
        </button>
    </div>

    <div class="date-badge" id="todayDate">-</div>

    <div class="main-card">
        <div class="label">ì˜¤ëŠ˜ ì£¼ë¬¸ ì´ì•¡ (í•œí™”)</div>
        <div class="value" id="todayRevenue">0</div>
        <div class="sub-value">
            <span>ì£¼ë¬¸ <span id="todayOrderCount">0</span>ê±´</span>
            <span class="divider"></span>
            <span>ì´ë²ˆ ë‹¬: <span id="monthRevenue">0</span>ì›</span>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px;" id="todayCountryCards">
        </div>
    </div>

    <!-- 30ì¼ ì ‘ì†ì ì¶”ì´ -->
    <div class="section-title">ì ‘ì†ì (30ì¼) <span id="monthVisitorTotal" style="float:right; font-weight:900; color:#6366f1;">-</span></div>
    <div class="chart-card" style="margin-bottom:12px; padding:10px 12px;">
        <div style="height:80px; position:relative;"><canvas id="visitorChart"></canvas></div>
    </div>

    <!-- 30ì¼ ë§¤ì¶œ ì¶”ì´ -->
    <div class="section-title">ë§¤ì¶œ (30ì¼) <span id="monthSalesTotal" style="float:right; font-weight:900; color:#22c55e;">-</span></div>
    <div class="chart-card" style="margin-bottom:16px; padding:10px 12px;">
        <div style="height:80px; position:relative;"><canvas id="salesChart"></canvas></div>
    </div>

    <!-- êµ­ê°€ë³„ ë§¤ì¶œ -->
    <div class="section-title">êµ­ê°€ë³„ ë§¤ì¶œ (ì´ë²ˆ ë‹¬)</div>
    <div style="margin-bottom:20px;">
        <div class="chart-card" style="display:flex; align-items:center; justify-content:center; margin-bottom:12px;">
            <canvas id="countryChart" width="120" height="120"></canvas>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;" id="countrySalesCards">
            <!-- JSë¡œ ì±„ì›€ -->
        </div>
    </div>

    <!-- êµ­ê°€ë³„ ì ‘ì†ì -->
    <div class="section-title" id="countryVisitorTitle">êµ­ê°€ë³„ ì ‘ì†ì (ì˜¤ëŠ˜)</div>
    <div class="list-card" id="countryVisitorList">
        <div style="text-align:center; color:#ccc; font-size:12px;">ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</div>
    </div>

    <!-- ìœ ì… ê²½ë¡œ -->
    <div class="section-title" id="trafficTitle">ìœ ì… ê²½ë¡œ Top 10</div>
    <div class="list-card" id="trafficList">
        <div style="text-align:center; color:#ccc; font-size:12px;">ë°ì´í„° ì¤€ë¹„ì¤‘</div>
    </div>

    <div class="section-title" style="margin-top: 30px;">ë¸”ë¡œê·¸/ì»¤ë®¤ë‹ˆí‹°/ì™¸ë¶€ìœ ì… ìƒì„¸</div>
    <div class="list-card" id="blogTrafficList">
        <div style="text-align:center; color:#ccc; font-size:12px;">ë°ì´í„° ì¤€ë¹„ì¤‘</div>
    </div>

    <!-- ì£¼ìš” í˜„í™© -->
    <div class="section-title">ì£¼ìš” í˜„í™©</div>
    <div class="grid-container">
        <div class="stat-card">
            <div class="stat-icon theme-blue"><i class="fa-solid fa-truck-fast"></i></div>
            <div class="label">ì˜¤ëŠ˜ ë°œì†¡ì˜ˆì •</div>
            <div class="value" id="todayShip">0</div>
        </div>
        <div class="stat-card" style="cursor:pointer;" onclick="toggleNewMemberDetail()">
            <div class="stat-icon theme-green"><i class="fa-solid fa-user-plus"></i></div>
            <div class="label">ì‹ ê·œ íšŒì›</div>
            <div class="value" id="todayNewMember">0</div>
            <div id="newMemberDetail" style="display:none; margin-top:6px; font-size:11px; color:#64748b;"></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon theme-purple"><i class="fa-solid fa-crown"></i></div>
            <div class="label">VIP ë¬¸ì˜</div>
            <div class="value" id="todayVip">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon theme-orange"><i class="fa-solid fa-cloud-arrow-up"></i></div>
            <div class="label">í…œí”Œë¦¿/ë¡œê³ </div>
            <div class="value" id="todayUpload">0</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon theme-red"><i class="fa-solid fa-users"></i></div>
            <div class="label">ì˜¤ëŠ˜ ë°©ë¬¸ì</div>
            <div class="value" id="todayVisitors">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon theme-teal"><i class="fa-regular fa-clock"></i></div>
            <div class="label">í‰ê·  ì²´ë¥˜ì‹œê°„</div>
            <div class="value" id="avgStayTime" style="font-size: 16px;">-</div>
        </div>
    </div>

    <!-- ì‹ ê·œ íšŒì› êµ­ì ë³„ -->
    <div class="section-title">ì‹ ê·œ íšŒì› êµ­ì ë³„ (ì˜¤ëŠ˜)</div>
    <div id="newMemberCountryCard" class="list-card" style="padding:16px;">
        <div style="text-align:center; color:#ccc; font-size:12px;">ì§‘ê³„ ì¤‘...</div>
    </div>

    <!-- ì˜¤ëŠ˜ì˜ ì‹¤ì‹œê°„ ì£¼ë¬¸ -->
    <div class="section-title">ì˜¤ëŠ˜ì˜ ì‹¤ì‹œê°„ ì£¼ë¬¸</div>
    <div class="list-card" id="todayOrderList">
        <div style="text-align:center; color:#ccc; font-size:12px;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </div>

    <!-- ì§€ì—­ë³„ íŒë§¤ ìˆœìœ„ -->
    <div class="section-title">ì§€ì—­ë³„ íŒë§¤ ìˆœìœ„ (Top 5)</div>
    <div class="list-card" id="regionList">
        <div style="text-align:center; color:#ccc; font-size:12px;">ë°ì´í„° ë¶„ì„ ì¤‘...</div>
    </div>

    <div id="loading"><i class="fa-solid fa-spinner fa-spin"></i> ë°ì´í„° ê°±ì‹  ì¤‘...</div>

    <script type="module">
        import { sb, initConfig } from './config.js?v=123';

        let visitorChartInstance = null;
        let salesChartInstance = null;
        let countryChartInstance = null;

        window.loadTodayData = async () => {
            const btn = document.querySelector('.refresh-btn');
            const loading = document.getElementById('loading');

            btn.style.opacity = '0.5';
            loading.style.display = 'block';

            const now = new Date();
            const dateString = now.toISOString().split('T')[0];
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0).toISOString();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0).toISOString();
            const thirtyDaysAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 29, 0, 0, 0).toISOString();

            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            document.getElementById('todayDate').innerText = `${now.getFullYear()}.${now.getMonth()+1}.${now.getDate()} (${dayNames[now.getDay()]})`;

            try {
                // ===== 1. ì˜¤ëŠ˜ ì£¼ë¬¸ =====
                const { data: rawOrders, error: orderErr } = await sb.from('orders')
                    .select('id, total_amount, manager_name, items, created_at, status, site_code')
                    .gte('created_at', todayStart)
                    .neq('status', 'ì·¨ì†Œë¨').neq('status', 'ì·¨ì†Œ')
                    .neq('status', 'ì‚­ì œë¨').neq('status', 'ì‚­ì œ')
                    .neq('status', 'deleted').neq('status', 'trash')
                    .neq('status', 'ì„ì‹œì‘ì„±').neq('status', 'ê´€ë¦¬ìì°¨ë‹¨')
                    .order('created_at', { ascending: false });

                if (!orderErr && rawOrders) {
                    const uniqueMap = new Map();
                    rawOrders.forEach(o => { if (!uniqueMap.has(o.id)) uniqueMap.set(o.id, o); });
                    const todayOrders = Array.from(uniqueMap.values());
                    const total = todayOrders.reduce((acc, cur) => acc + (cur.total_amount || 0), 0);
                    animateValue("todayRevenue", total, true);
                    animateValue("todayOrderCount", todayOrders.length);
                    renderTodayCountryCards(todayOrders);
                    renderTodayOrders(todayOrders);
                }

                // ===== 2. ì›”ê°„ ì£¼ë¬¸ (êµ­ê°€/ì¹´í…Œê³ ë¦¬/ì œí’ˆ ë¶„ì„ìš©) =====
                const { data: monthOrders } = await sb.from('orders')
                    .select('total_amount, address, site_code, items, created_at')
                    .gte('created_at', monthStart)
                    .neq('status', 'ì·¨ì†Œë¨').neq('status', 'ì·¨ì†Œ')
                    .neq('status', 'ì‚­ì œë¨').neq('status', 'ì‚­ì œ')
                    .neq('status', 'deleted').neq('status', 'trash')
                    .neq('status', 'ì„ì‹œì‘ì„±').neq('status', 'ê´€ë¦¬ìì°¨ë‹¨');

                if (monthOrders) {
                    const mTotal = monthOrders.reduce((acc, cur) => acc + (cur.total_amount || 0), 0);
                    document.getElementById("monthRevenue").innerText = mTotal.toLocaleString();

                    renderCountrySales(monthOrders);
                    analyzeRegionRank(monthOrders);
                }

                // ===== 3. 30ì¼ê°„ ì£¼ë¬¸ ë°ì´í„° (ì°¨íŠ¸ìš©) =====
                const { data: monthChartOrders } = await sb.from('orders')
                    .select('total_amount, created_at')
                    .gte('created_at', thirtyDaysAgo)
                    .neq('status', 'ì·¨ì†Œë¨').neq('status', 'ì·¨ì†Œ')
                    .neq('status', 'ì‚­ì œë¨').neq('status', 'ì‚­ì œ')
                    .neq('status', 'deleted').neq('status', 'trash')
                    .neq('status', 'ì„ì‹œì‘ì„±').neq('status', 'ê´€ë¦¬ìì°¨ë‹¨');

                // ===== 4. ê¸°íƒ€ í†µê³„ =====
                const { count: shipCount } = await sb.from('orders').select('id', { count: 'exact', head: true }).eq('delivery_target_date', dateString);
                animateValue("todayShip", shipCount || 0);

                const { data: newMembers } = await sb.from('profiles').select('site').gte('created_at', todayStart);
                const memberCount = newMembers ? newMembers.length : 0;
                animateValue("todayNewMember", memberCount);
                // êµ­ê°€ë³„ ì‹ ê·œíšŒì› ì§‘ê³„
                const countryCardEl = document.getElementById('newMemberCountryCard');
                if (newMembers && newMembers.length > 0) {
                    const siteMap = {};
                    const flags = { KR: 'ğŸ‡°ğŸ‡·', JP: 'ğŸ‡¯ğŸ‡µ', US: 'ğŸ‡ºğŸ‡¸', CN: 'ğŸ‡¨ğŸ‡³', AR: 'ğŸ‡¦ğŸ‡·', ES: 'ğŸ‡ªğŸ‡¸' };
                    const names = { KR: 'í•œêµ­', JP: 'ì¼ë³¸', US: 'ë¯¸êµ­', CN: 'ì¤‘êµ­', AR: 'ì•„ë¥´í—¨í‹°ë‚˜', ES: 'ìŠ¤í˜ì¸' };
                    newMembers.forEach(m => { const s = m.site || 'KR'; siteMap[s] = (siteMap[s] || 0) + 1; });
                    const detailHtml = Object.entries(siteMap).map(([code, cnt]) => `${flags[code] || 'ğŸŒ'} ${code} ${cnt}ëª…`).join(' &nbsp;');
                    document.getElementById('newMemberDetail').innerHTML = detailHtml;

                    // êµ­ì ë³„ ì¹´ë“œ ë Œë”ë§
                    const sorted = Object.entries(siteMap).sort((a, b) => b[1] - a[1]);
                    const maxCnt = sorted[0][1];
                    countryCardEl.innerHTML = sorted.map(([code, cnt]) => {
                        const pct = Math.round(cnt / memberCount * 100);
                        const barW = Math.max(Math.round(cnt / maxCnt * 100), 8);
                        return `<div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                            <span style="font-size:20px; min-width:28px;">${flags[code] || 'ğŸŒ'}</span>
                            <div style="flex:1; min-width:0;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:3px;">
                                    <span style="font-size:13px; font-weight:600; color:#1e293b;">${names[code] || code}</span>
                                    <span style="font-size:13px; color:#64748b;">${cnt}ëª… (${pct}%)</span>
                                </div>
                                <div style="height:8px; background:#f1f5f9; border-radius:4px; overflow:hidden;">
                                    <div style="height:100%; width:${barW}%; background:linear-gradient(90deg,#6366f1,#818cf8); border-radius:4px;"></div>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    countryCardEl.innerHTML = '<div style="text-align:center; color:#94a3b8; font-size:13px; padding:12px 0;">ì˜¤ëŠ˜ ì‹ ê·œ ê°€ì… ì—†ìŒ</div>';
                }

                const { count: vipCount } = await sb.from('vip_orders').select('id', { count: 'exact', head: true }).gte('created_at', todayStart);
                animateValue("todayVip", vipCount || 0);

                const { count: upCount } = await sb.from('library').select('id', { count: 'exact', head: true }).gte('created_at', todayStart);
                animateValue("todayUpload", upCount || 0);

                // ===== 5. ë°©ë¬¸ì/ìœ ì…ê²½ë¡œ (ì˜¤ëŠ˜) =====
                // select('*') ì‚¬ìš© â€” site ì»¬ëŸ¼ ë¯¸ì¡´ì¬ ì‹œì—ë„ ì•ˆì „
                const { data: visits, count: totalVisitorCount, error: visitErr } = await sb.from('page_views')
                    .select('*', { count: 'exact' })
                    .gte('created_at', todayStart)
                    .limit(50000);

                if (!visitErr && visits) {
                    animateValue("todayVisitors", totalVisitorCount || 0);

                    if (visits.length > 0) {
                        const totalDur = visits.reduce((acc, cur) => acc + (cur.duration || 0), 0);
                        const avgSec = Math.floor(totalDur / visits.length);
                        document.getElementById("avgStayTime").innerText = `${Math.floor(avgSec/60)}ë¶„ ${avgSec%60}ì´ˆ`;
                    }

                    renderTraffic(visits);
                    renderBlogTraffic(visits);
                    renderCountryVisitors(visits, totalVisitorCount);
                }

                // ===== 6. 30ì¼ê°„ ì ‘ì†ì (ì¼ë³„ count ì¿¼ë¦¬ â€” í–‰ ì œí•œ ë¬´ê´€) =====
                const dayCountPromises = [];
                for (let i = 29; i >= 0; i--) {
                    const ds = new Date(now.getFullYear(), now.getMonth(), now.getDate() - i, 0, 0, 0).toISOString();
                    const de = new Date(now.getFullYear(), now.getMonth(), now.getDate() - i + 1, 0, 0, 0).toISOString();
                    dayCountPromises.push(
                        sb.from('page_views')
                            .select('id', { count: 'exact', head: true })
                            .gte('created_at', ds)
                            .lt('created_at', de)
                    );
                }
                const dayCountResults = await Promise.all(dayCountPromises);
                const visitorDayCounts = dayCountResults.map(r => r.count || 0);

                // ì°¨íŠ¸ ë Œë”ë§
                render30DayCharts(now, monthChartOrders || [], visitorDayCounts);

            } catch (e) {
                console.error("Error:", e);
            } finally {
                btn.style.opacity = '1';
                loading.style.display = 'none';
            }
        };

        // ===== 30ì¼ ì¶”ì´ ì°¨íŠ¸ =====
        function render30DayCharts(now, monthChartOrders, visitorDayCounts) {
            const labels = [];
            const salesData = [];

            // ë§¤ì¶œ ë‚ ì§œë³„ ê·¸ë£¹í•‘
            const orderByDate = {};
            monthChartOrders.forEach(o => {
                const d = o.created_at.split('T')[0];
                orderByDate[d] = (orderByDate[d] || 0) + (o.total_amount || 0);
            });

            let totalVisitors30 = 0;
            let totalSales30 = 0;

            for (let i = 29; i >= 0; i--) {
                const dt = new Date(now.getFullYear(), now.getMonth(), now.getDate() - i);
                const key = dt.toISOString().split('T')[0];
                const dayLabel = `${dt.getMonth()+1}/${dt.getDate()}`;
                labels.push(dayLabel);

                const sc = orderByDate[key] || 0;
                salesData.push(sc);
                totalVisitors30 += visitorDayCounts[29 - i] || 0;
                totalSales30 += sc;
            }

            document.getElementById('monthVisitorTotal').innerText = totalVisitors30.toLocaleString() + 'ëª…';
            document.getElementById('monthSalesTotal').innerText = totalSales30.toLocaleString() + 'ì›';

            const chartOpts = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                interaction: { mode: 'nearest', axis: 'x', intersect: false },
                scales: {
                    x: {
                        ticks: { font: { size: 9 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 10 },
                        grid: { display: false }
                    },
                    y: { ticks: { font: { size: 10 } }, grid: { color: '#f1f5f9' }, beginAtZero: true }
                }
            };

            // ì ‘ì†ì ì°¨íŠ¸
            if (visitorChartInstance) visitorChartInstance.destroy();
            const ctx1 = document.getElementById('visitorChart').getContext('2d');
            visitorChartInstance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        data: visitorDayCounts,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99,102,241,0.08)',
                        fill: true,
                        tension: 0.3,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        pointBackgroundColor: '#6366f1'
                    }]
                },
                options: {
                    ...chartOpts,
                    scales: {
                        ...chartOpts.scales,
                        y: { ...chartOpts.scales.y, ticks: { font: { size: 10 }, callback: v => v >= 1000 ? (v/1000)+'k' : v } }
                    }
                }
            });

            // ë§¤ì¶œ ì°¨íŠ¸
            if (salesChartInstance) salesChartInstance.destroy();
            const ctx2 = document.getElementById('salesChart').getContext('2d');
            salesChartInstance = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        data: salesData,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34,197,94,0.08)',
                        fill: true,
                        tension: 0.3,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        pointBackgroundColor: '#22c55e'
                    }]
                },
                options: {
                    ...chartOpts,
                    scales: {
                        ...chartOpts.scales,
                        y: { ...chartOpts.scales.y, ticks: { font: { size: 10 }, callback: v => v >= 10000 ? Math.round(v/10000)+'ë§Œ' : v.toLocaleString() } }
                    }
                }
            });
        }

        // ===== êµ­ê°€ë³„ ë§¤ì¶œ =====
        function renderCountrySales(orders) {
            const countrySales = { KR: 0, JP: 0, US: 0, CN: 0, AR: 0, ES: 0 };
            const countryCount = { KR: 0, JP: 0, US: 0, CN: 0, AR: 0, ES: 0 };

            orders.forEach(o => {
                const site = o.site_code || 'KR';
                countrySales[site] = (countrySales[site] || 0) + (o.total_amount || 0);
                countryCount[site] = (countryCount[site] || 0) + 1;
            });

            const config = {
                KR: { flag: '\uD83C\uDDF0\uD83C\uDDF7', name: 'í•œêµ­', unit: 'ì›', color: '#6366f1' },
                JP: { flag: '\uD83C\uDDEF\uD83C\uDDF5', name: 'ì¼ë³¸', unit: 'å††', color: '#f97316' },
                US: { flag: '\uD83C\uDDFA\uD83C\uDDF8', name: 'ë¯¸êµ­', unit: '$', color: '#22c55e' },
                CN: { flag: '\uD83C\uDDE8\uD83C\uDDF3', name: 'ì¤‘êµ­', unit: 'Â¥', color: '#ef4444' },
                AR: { flag: '\uD83C\uDDF8\uD83C\uDDE6', name: 'ì‚¬ìš°ë””', unit: 'ï·¼', color: '#a855f7' },
                ES: { flag: '\uD83C\uDDEA\uD83C\uDDF8', name: 'ìŠ¤í˜ì¸', unit: 'â‚¬', color: '#14b8a6' }
            };

            // ì¹´ë“œ
            const cardsEl = document.getElementById('countrySalesCards');
            let cardsHtml = '';
            // DBëŠ” KRW ê¸°ì¤€ ì €ì¥ â†’ í˜„ì§€ í†µí™”ë¡œ í™˜ì‚° í›„ í‘œì‹œ
            const currRates = { KR: 1, JP: 0.2, US: 0.002, CN: 0.01, AR: 0.005, ES: 0.001 };
            let totalKrw = 0;
            ['KR', 'JP', 'US', 'CN', 'AR', 'ES'].forEach(code => {
                const c = config[code];
                const krwAmt = countrySales[code] || 0;
                totalKrw += krwAmt;
                const rate = currRates[code] || 1;
                const localAmt = code === 'ES' ? (krwAmt * rate).toFixed(2) : Math.round(krwAmt * rate);
                const cnt = countryCount[code] || 0;
                let display;
                if (code === 'US') display = `$${Number(localAmt).toLocaleString()}`;
                else if (code === 'CN') display = `Â¥${Number(localAmt).toLocaleString()}`;
                else if (code === 'AR') display = `${Number(localAmt).toLocaleString()} ï·¼`;
                else if (code === 'ES') display = `â‚¬${Number(localAmt).toLocaleString()}`;
                else display = `${Number(localAmt).toLocaleString()}${c.unit}`;
                const krwDisplay = code === 'KR' ? '' : `<div style="font-size:10px; color:#94a3b8; margin-top:1px;">â‰ˆ ${krwAmt.toLocaleString()}ì›</div>`;
                cardsHtml += `
                <div class="country-card">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:22px;">${c.flag}</span>
                        <div style="text-align:left;">
                            <div style="font-size:11px; color:#64748b; font-weight:600;">${c.name}</div>
                            <div style="font-size:16px; font-weight:800; color:#0f172a;">${display}</div>${krwDisplay}
                            <div style="font-size:11px; color:#94a3b8;">${cnt}ê±´</div>
                        </div>
                    </div>
                </div>`;
            });
            // ì „ì²´ í•©ì‚° (í•œí™”)
            const totalCnt = ['KR','JP','US','CN','AR','ES'].reduce((s,c) => s + (countryCount[c]||0), 0);
            cardsHtml += `
                <div class="country-card" style="grid-column:1/-1; background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%); color:#fff;">
                    <div style="display:flex; align-items:center; gap:8px; justify-content:center;">
                        <span style="font-size:22px;">ğŸ†</span>
                        <div style="text-align:left;">
                            <div style="font-size:11px; color:rgba(255,255,255,0.8); font-weight:600;">ì „ì²´ (í•œí™”)</div>
                            <div style="font-size:16px; font-weight:800; color:#fff;">${totalKrw.toLocaleString()}ì›</div>
                            <div style="font-size:11px; color:rgba(255,255,255,0.7);">${totalCnt}ê±´</div>
                        </div>
                    </div>
                </div>`;
            cardsEl.innerHTML = cardsHtml;

            // ë„ë„› ì°¨íŠ¸
            if (countryChartInstance) countryChartInstance.destroy();
            const ctx = document.getElementById('countryChart').getContext('2d');
            const allCodes = ['KR', 'JP', 'US', 'CN', 'AR', 'ES'];
            const values = allCodes.map(c => countrySales[c] || 0);
            const colors = allCodes.map(c => config[c].color);

            countryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: allCodes.map(c => config[c].name),
                    datasets: [{
                        data: values.every(v => v === 0) ? allCodes.map(() => 1) : values,
                        backgroundColor: values.every(v => v === 0) ? allCodes.map(() => '#e2e8f0') : colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '60%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: !values.every(v => v === 0) }
                    }
                }
            });
        }

        // ===== êµ­ê°€ë³„ ì ‘ì†ì =====
        function classifyReferrer(ref) {
            if (!ref) return 'direct';
            const r = ref.toLowerCase();
            // ê´‘ê³  (Google Ads, Naver Ads, ê¸°íƒ€ CPC)
            if (r.includes('google ads') || r.includes('naver ads') || r.includes('ads (ê´‘ê³ )') || r.includes('gclid') || r.includes('syndicatedsearch') || r.includes('nclid') || r.includes('na_click_id')) return 'ads';
            if (r.includes('ads') && r.includes('ê´‘ê³ ')) return 'ads';
            // ìì—°ê²€ìƒ‰
            if (r.includes('search') || r.includes('ìì—°ê²€ìƒ‰') || r.includes('yahoo')) return 'organic';
            // ì§ì ‘ ì ‘ì†
            if (r.includes('direct') || r.includes('ì§ì ‘') || r.includes('ì¦ê²¨ì°¾ê¸°')) return 'direct';
            // SNS
            if (r.includes('facebook') || r.includes('instagram') || r.includes('youtube') || r.includes('tiktok') || r.includes('twitter') || r.includes('t.co')) return 'sns';
            // ë¸”ë¡œê·¸
            if (r.includes('[blog]') || r.includes('blog')) return 'blog';
            // ë‚´ë¶€
            if (r.includes('cafe2626') || r.includes('cafe0101') || r.includes('cafe3355')) return 'internal';
            return 'other';
        }

        function renderCountryVisitors(visits, totalCount) {
            const container = document.getElementById('countryVisitorList');
            const titleEl = document.getElementById('countryVisitorTitle');

            // êµ­ê°€ë³„ + ìœ ì…ìœ í˜•ë³„ ì§‘ê³„
            const siteMap = {};
            const siteDetail = {}; // { KR: { ads: 0, organic: 0, direct: 0, sns: 0, blog: 0, other: 0 } }
            let hasSiteData = false;

            visits.forEach(v => {
                const site = v.site || null;
                if (!site) return;
                hasSiteData = true;
                siteMap[site] = (siteMap[site] || 0) + 1;

                if (!siteDetail[site]) siteDetail[site] = { ads: 0, organic: 0, direct: 0, sns: 0, blog: 0, other: 0 };
                const ref = v.referrer || '';
                let type = classifyReferrer(ref);
                if (type === 'internal') type = 'other';
                siteDetail[site][type] = (siteDetail[site][type] || 0) + 1;
            });

            if (!hasSiteData) {
                container.innerHTML = '<div style="text-align:center; padding:12px; font-size:12px; color:#999;">êµ­ê°€ë³„ ë°ì´í„° ìˆ˜ì§‘ì´ ì‹œì‘ë˜ë©´ í‘œì‹œë©ë‹ˆë‹¤</div>';
                return;
            }

            const total = Object.values(siteMap).reduce((a, b) => a + b, 0);
            if (titleEl) titleEl.innerText = `êµ­ê°€ë³„ ì ‘ì†ì (ì˜¤ëŠ˜: ${(totalCount || total).toLocaleString()}ëª…)`;

            const config = {
                KR: { flag: '\uD83C\uDDF0\uD83C\uDDF7', name: 'í•œêµ­', color: '#6366f1' },
                JP: { flag: '\uD83C\uDDEF\uD83C\uDDF5', name: 'ì¼ë³¸', color: '#f97316' },
                US: { flag: '\uD83C\uDDFA\uD83C\uDDF8', name: 'ë¯¸êµ­', color: '#22c55e' },
                EU: { flag: '\uD83C\uDDEA\uD83C\uDDFA', name: 'ìœ ëŸ½', color: '#8b5cf6' },
                CN: { flag: '\uD83C\uDDE8\uD83C\uDDF3', name: 'ì¤‘êµ­', color: '#ef4444' },
                TW: { flag: '\uD83C\uDDF9\uD83C\uDDFC', name: 'ëŒ€ë§Œ', color: '#f43f5e' },
                HK: { flag: '\uD83C\uDDED\uD83C\uDDF0', name: 'í™ì½©', color: '#fb7185' },
                SEA: { flag: '\uD83C\uDF0F', name: 'ë™ë‚¨ì•„', color: '#14b8a6' },
                IN: { flag: '\uD83C\uDDEE\uD83C\uDDF3', name: 'ì¸ë„', color: '#f59e0b' },
                ME: { flag: '\uD83D\uDD4C', name: 'ì¤‘ë™', color: '#d97706' },
                AU: { flag: '\uD83C\uDDE6\uD83C\uDDFA', name: 'í˜¸ì£¼/NZ', color: '#0ea5e9' },
                RU: { flag: '\uD83C\uDDF7\uD83C\uDDFA', name: 'ëŸ¬ì‹œì•„', color: '#dc2626' },
                LATAM: { flag: '\uD83C\uDF0E', name: 'ì¤‘ë‚¨ë¯¸', color: '#10b981' },
                AF: { flag: '\uD83C\uDF0D', name: 'ì•„í”„ë¦¬ì¹´', color: '#a855f7' },
                OTHER: { flag: '\uD83C\uDF10', name: 'ê¸°íƒ€', color: '#94a3b8' }
            };

            const typeLabels = {
                ads: { label: 'ê´‘ê³ ', color: '#ef4444', icon: 'fa-bullhorn' },
                organic: { label: 'ìì—°ê²€ìƒ‰', color: '#22c55e', icon: 'fa-magnifying-glass' },
                direct: { label: 'ì§ì ‘/ì¦ê²¨ì°¾ê¸°', color: '#6366f1', icon: 'fa-bookmark' },
                sns: { label: 'SNS', color: '#f59e0b', icon: 'fa-share-nodes' },
                blog: { label: 'ë¸”ë¡œê·¸', color: '#8b5cf6', icon: 'fa-newspaper' },
                other: { label: 'ê¸°íƒ€', color: '#94a3b8', icon: 'fa-ellipsis' }
            };

            const sorted = Object.entries(siteMap).sort(([,a],[,b]) => b - a);

            let html = '';
            sorted.forEach(([code, cnt]) => {
                const c = config[code] || config['OTHER'];
                const pct = total > 0 ? Math.round((cnt / total) * 100) : 0;
                const detail = siteDetail[code] || {};

                // ìœ ì… ìœ í˜• ë°” (stacked bar)
                const detailSum = (detail.ads||0) + (detail.organic||0) + (detail.direct||0) + (detail.sns||0) + (detail.blog||0) + (detail.other||0);
                let stackedBar = '';
                let detailTags = '';
                if (detailSum > 0) {
                    ['ads','organic','direct','sns','blog','other'].forEach(type => {
                        const n = detail[type] || 0;
                        if (n === 0) return;
                        const w = Math.max(Math.round((n / detailSum) * 100), 2);
                        const t = typeLabels[type];
                        stackedBar += `<div title="${t.label} ${n}ëª…" style="width:${w}%; height:100%; background:${t.color};"></div>`;
                        detailTags += `<span style="display:inline-flex; align-items:center; gap:3px; font-size:11px; color:${t.color}; margin-right:8px; white-space:nowrap;"><i class="fa-solid ${t.icon}" style="font-size:9px;"></i>${t.label} <b>${n}</b></span>`;
                    });
                }

                html += `
                <div style="margin-bottom:14px;">
                    <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;">
                        <span style="font-weight:600;">${c.flag} ${c.name}</span>
                        <span style="font-weight:bold;">${cnt.toLocaleString()}ëª… (${pct}%)</span>
                    </div>
                    <div style="height:8px; background:#f1f5f9; border-radius:4px; overflow:hidden; display:flex;">
                        ${stackedBar}
                    </div>
                    <div style="margin-top:4px; display:flex; flex-wrap:wrap; gap:2px 0;">
                        ${detailTags}
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // ===== ì£¼ë¬¸ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ê¸°ì¡´) =====
        function renderTodayCountryCards(orders) {
            const el = document.getElementById('todayCountryCards');
            if (!el) return;
            const countrySales = { KR: 0, JP: 0, US: 0, CN: 0, AR: 0, ES: 0 };
            const countryCount = { KR: 0, JP: 0, US: 0, CN: 0, AR: 0, ES: 0 };
            orders.forEach(o => {
                const site = o.site_code || 'KR';
                countrySales[site] = (countrySales[site] || 0) + (o.total_amount || 0);
                countryCount[site] = (countryCount[site] || 0) + 1;
            });
            const cfg = {
                KR: { flag: '\uD83C\uDDF0\uD83C\uDDF7', unit: 'ì›', color: '#6366f1' },
                JP: { flag: '\uD83C\uDDEF\uD83C\uDDF5', unit: 'å††', color: '#f97316' },
                US: { flag: '\uD83C\uDDFA\uD83C\uDDF8', unit: '$', color: '#22c55e' },
                CN: { flag: '\uD83C\uDDE8\uD83C\uDDF3', unit: 'Â¥', color: '#ef4444' },
                AR: { flag: '\uD83C\uDDF8\uD83C\uDDE6', unit: 'ï·¼', color: '#a855f7' },
                ES: { flag: '\uD83C\uDDEA\uD83C\uDDF8', unit: 'â‚¬', color: '#14b8a6' }
            };
            const rates = { KR: 1, JP: 0.2, US: 0.002, CN: 0.01, AR: 0.005, ES: 0.001 };
            let html = '';
            ['KR', 'JP', 'US', 'CN', 'AR', 'ES'].forEach(code => {
                const c = cfg[code];
                const krw = countrySales[code] || 0;
                const local = code === 'ES' ? (krw * (rates[code] || 1)).toFixed(2) : Math.round(krw * (rates[code] || 1));
                const cnt = countryCount[code] || 0;
                let display;
                if (code === 'US') display = `$${Number(local).toLocaleString()}`;
                else if (code === 'CN') display = `Â¥${Number(local).toLocaleString()}`;
                else if (code === 'AR') display = `${Number(local).toLocaleString()} ï·¼`;
                else if (code === 'ES') display = `â‚¬${Number(local).toLocaleString()}`;
                else display = `${Number(local).toLocaleString()}${c.unit}`;
                const krwSub = code === 'KR' ? '' : `<span style="font-size:10px; color:#94a3b8;"> â‰ˆ${krw.toLocaleString()}ì›</span>`;
                html += `<div style="background:#f8fafc; border-radius:8px; padding:6px 8px; border-left:3px solid ${c.color};">
                    <div style="font-size:10px; color:#64748b;">${c.flag} ${cnt}ê±´</div>
                    <div style="font-size:13px; font-weight:800; color:#0f172a;">${display}</div>${krwSub}
                </div>`;
            });
            el.innerHTML = html;
        }

        function renderTodayOrders(orders) {
            const container = document.getElementById('todayOrderList');
            if (!orders || orders.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#999; font-size:13px;">ì˜¤ëŠ˜ ë“¤ì–´ì˜¨ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const siteFlags = { KR: '\uD83C\uDDF0\uD83C\uDDF7', JP: '\uD83C\uDDEF\uD83C\uDDF5', US: '\uD83C\uDDFA\uD83C\uDDF8', CN: '\uD83C\uDDE8\uD83C\uDDF3', AR: '\uD83C\uDDF8\uD83C\uDDE6', ES: '\uD83C\uDDEA\uD83C\uDDF8' };
            const rates = { KR: 1, JP: 0.2, US: 0.002, CN: 0.01, AR: 0.005, ES: 0.001 };
            const units = { KR: 'ì›', JP: 'å††', US: '$', CN: 'Â¥', AR: 'ï·¼', ES: 'â‚¬' };
            let html = '';
            orders.forEach(order => {
                let itemText = 'ìƒí’ˆ ì •ë³´ ì—†ìŒ';
                try {
                    const items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
                    if (Array.isArray(items) && items.length > 0) {
                        const firstItemName = items[0].productName || (items[0].product && items[0].product.name) || 'ìƒí’ˆ';
                        itemText = items.length > 1 ? `${firstItemName} ì™¸ ${items.length - 1}ê±´` : firstItemName;
                    }
                } catch (e) {}

                const timeStr = new Date(order.created_at).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                const site = order.site_code || 'KR';
                const flag = siteFlags[site] || '\uD83C\uDDF0\uD83C\uDDF7';
                const krwAmt = order.total_amount || 0;
                const localAmt = site === 'ES' ? (krwAmt * (rates[site] || 1)).toFixed(2) : Math.round(krwAmt * (rates[site] || 1));
                let amtDisplay;
                if (site === 'US') amtDisplay = `$${Number(localAmt).toLocaleString()}`;
                else if (site === 'CN') amtDisplay = `Â¥${Number(localAmt).toLocaleString()}`;
                else if (site === 'AR') amtDisplay = `${Number(localAmt).toLocaleString()} ï·¼`;
                else if (site === 'ES') amtDisplay = `â‚¬${Number(localAmt).toLocaleString()}`;
                else amtDisplay = `${Number(localAmt).toLocaleString()}${units[site] || 'ì›'}`;
                const krwSub = site !== 'KR' ? `<div style="font-size:10px; color:#94a3b8;">â‰ˆ${krwAmt.toLocaleString()}ì›</div>` : '';

                html += `
                <div class="list-row" style="align-items:flex-start;">
                    <div style="flex:1;">
                        <div style="font-size:14px; font-weight:700; color:#1e293b; margin-bottom:4px;">
                            ${flag} ${order.manager_name || 'ê³ ê°'}
                            <span style="font-size:11px; color:#94a3b8; font-weight:400; margin-left:5px;">${timeStr}</span>
                            <span style="font-size:11px; background:#fee2e2; color:#ef4444; padding:2px 6px; border-radius:4px; font-weight:bold; margin-left:5px;">
                                ${order.status || 'ì—†ìŒ'}
                            </span>
                        </div>
                        <div style="font-size:13px; color:#64748b; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:200px;">
                            ${itemText}
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="row-value" style="color:#6366f1;">${amtDisplay}</div>${krwSub}
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // ===== ì§€ì—­ ë¶„ì„ (ê¸°ì¡´) =====
        function analyzeRegionRank(orders) {
            const container = document.getElementById('regionList');
            const regionMap = {};

            const mappingRules = [
                { label: 'ì„œìš¸ (Seoul)', keywords: ['ì„œìš¸', 'ê°•ë‚¨', 'ì„œì´ˆ', 'ì†¡íŒŒ', 'ì ì‹¤', 'ë§ˆí¬', 'í™ëŒ€', 'ì˜ë“±í¬', 'ì—¬ì˜ë„', 'ì„±ë™', 'ì„±ë¶', 'ìš©ì‚°'] },
                { label: 'ê²½ê¸° (Gyeonggi)', keywords: ['ê²½ê¸°', 'í™”ì„±', 'ìˆ˜ì›', 'ìš©ì¸', 'ì„±ë‚¨', 'ë¶„ë‹¹', 'íŒêµ', 'ë¶€ì²œ', 'ì•ˆì‚°', 'ë‚¨ì–‘ì£¼', 'ì•ˆì–‘', 'í‰íƒ', 'ì‹œí¥', 'íŒŒì£¼', 'ê¹€í¬', 'ê´‘ëª…', 'ì¼ì‚°'] },
                { label: 'ì¸ì²œ (Incheon)', keywords: ['ì¸ì²œ', 'ë¶€í‰', 'ì†¡ë„', 'ì²­ë¼'] },
                { label: 'ë¶€ì‚° (Busan)', keywords: ['ë¶€ì‚°', 'í•´ìš´ëŒ€', 'ì„œë©´'] },
                { label: 'ì œì£¼ (Jeju)', keywords: ['ì œì£¼', 'ì„œê·€í¬'] },
                { label: 'ê°•ì› (Gangwon)', keywords: ['ê°•ì›', 'ì¶˜ì²œ', 'ì›ì£¼', 'ê°•ë¦‰', 'ì†ì´ˆ'] },
                { label: 'ëŒ€êµ¬ (Daegu)', keywords: ['ëŒ€êµ¬', 'ë™ì„±ë¡œ'] },
                { label: 'ëŒ€ì „ (Daejeon)', keywords: ['ëŒ€ì „', 'ìœ ì„±'] },
                { label: 'ê´‘ì£¼ (Gwangju)', keywords: ['ê´‘ì£¼'] },
                { label: 'ê²½ë‚¨ (Gyeongnam)', keywords: ['ê²½ë‚¨', 'ì°½ì›', 'ê¹€í•´'] },
                { label: 'ê²½ë¶ (Gyeongbuk)', keywords: ['ê²½ë¶', 'í¬í•­', 'êµ¬ë¯¸', 'ê²½ì£¼'] },
                { label: 'ì¶©ë‚¨ (Chungnam)', keywords: ['ì¶©ë‚¨', 'ì²œì•ˆ', 'ì•„ì‚°'] },
                { label: 'ì¶©ë¶ (Chungbuk)', keywords: ['ì¶©ë¶', 'ì²­ì£¼'] },
                { label: 'ì „ë‚¨ (Jeonnam)', keywords: ['ì „ë‚¨', 'ì—¬ìˆ˜', 'ìˆœì²œ'] },
                { label: 'ì „ë¶ (Jeonbuk)', keywords: ['ì „ë¶', 'ì „ì£¼'] },
                { label: '\uD83C\uDDEF\uD83C\uDDF5 ë„ì¿„ (Tokyo)', keywords: ['ë„ì¿„', 'Tokyo', 'æ±äº¬'] },
                { label: '\uD83C\uDDEF\uD83C\uDDF5 ì˜¤ì‚¬ì¹´ (Osaka)', keywords: ['ì˜¤ì‚¬ì¹´', 'Osaka', 'å¤§é˜ª'] },
                { label: '\uD83C\uDDEF\uD83C\uDDF5 í›„ì¿ ì˜¤ì¹´ (Fukuoka)', keywords: ['í›„ì¿ ì˜¤ì¹´', 'Fukuoka', 'ç¦å²¡'] }
            ];

            orders.forEach(order => {
                const addr = (order.address || "").trim();
                if (addr.length < 2) return;

                let matched = false;
                for (const rule of mappingRules) {
                    if (rule.keywords.some(k => addr.includes(k))) {
                        regionMap[rule.label] = (regionMap[rule.label] || 0) + 1;
                        matched = true;
                        break;
                    }
                }
                if (!matched) {
                    if (/[ê°€-í£a-zA-Z]/.test(addr)) regionMap['ê¸°íƒ€ ì§€ì—­'] = (regionMap['ê¸°íƒ€ ì§€ì—­'] || 0) + 1;
                }
            });

            const sorted = Object.entries(regionMap).sort(([,a], [,b]) => b - a).slice(0, 5);

            if (sorted.length === 0) {
                container.innerHTML = '<div style="text-align:center; font-size:12px; color:#999;">ì§€ì—­ ë°ì´í„° ì—†ìŒ</div>';
                return;
            }

            let html = '';
            sorted.forEach(([name, count], idx) => {
                const rankColor = idx === 0 ? '#eab308' : (idx === 1 ? '#94a3b8' : (idx === 2 ? '#b45309' : '#cbd5e1'));
                html += `
                <div class="list-row">
                    <div class="rank-num" style="color:${rankColor}">${idx+1}</div>
                    <div class="row-info">${name}</div>
                    <div class="row-value">${count}ê±´</div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // ===== ìœ ì…ê²½ë¡œ (ê¸°ì¡´) =====
        function renderTraffic(visits) {
            if(!visits || visits.length === 0) {
                document.getElementById('trafficList').innerHTML = '<div style="text-align:center; padding:10px; font-size:12px; color:#999;">ë°©ë¬¸ ê¸°ë¡ ì—†ìŒ</div>';
                return;
            }

            const container = document.getElementById('trafficList');
            const trafficMap = {};
            let validTotal = 0;

            visits.forEach(v => {
                let s = v.referrer || "ì§ì ‘/ì¦ê²¨ì°¾ê¸°";
                if (s.includes('cafe2626.com') || s.includes('cafe0101.com') || s.includes('cafe3355.com')) return;

                validTotal++;

                // ê´‘ê³  ë¶„ë¥˜ (Google Ads, Naver Ads, ê¸°íƒ€)
                if (s.includes('Google Ads') || s.includes('gclid') || s.includes('syndicatedsearch')) s = 'Google Ads (ê´‘ê³ )';
                else if (s.includes('Naver Ads') || s.includes('nclid') || s.includes('na_click_id')) s = 'Naver Ads (ê´‘ê³ )';
                else if (s.includes('Ads (ê´‘ê³ )')) s = 'ê¸°íƒ€ Ads (ê´‘ê³ )';
                else if (s.includes('Direct') || s.includes('ì§ì ‘')) s = 'ì§ì ‘ ì ‘ì† (ì¦ê²¨ì°¾ê¸°)';
                else if (s.includes('Google Search') || (s.includes('google') && s.includes('ìì—°ê²€ìƒ‰'))) s = 'Google Search (ìì—°ê²€ìƒ‰)';
                else if (s.includes('Naver Search') || (s.includes('naver') && s.includes('ìì—°ê²€ìƒ‰'))) s = 'Naver Search (ìì—°ê²€ìƒ‰)';
                else if (s.includes('Search') || s.includes('ìì—°ê²€ìƒ‰')) { }
                else if (s.includes('yahoo')) s = "Yahoo Search";
                else if (s.includes('instagram') || s.includes('facebook') || s.includes('youtube') || s.includes('tiktok')) s = "SNS ìœ ì…";

                trafficMap[s] = (trafficMap[s] || 0) + 1;
            });

            const titleEl = document.getElementById('trafficTitle');
            if(titleEl) titleEl.innerText = `ìœ ì… ê²½ë¡œ Top 10 (ìœ íš¨ ìœ ì…: ${validTotal.toLocaleString()}ëª…)`;

            const sorted = Object.entries(trafficMap).sort(([,a], [,b]) => b - a).slice(0, 10);

            let html = '';
            sorted.forEach(([source, count], idx) => {
                const pct = validTotal > 0 ? Math.round((count / validTotal) * 100) : 0;

                let barColor = '#cbd5e1';
                if (source.includes('Google Ads')) barColor = '#ef4444';
                else if (source.includes('Naver Ads')) barColor = '#ff6b35';
                else if (source.includes('Ads') || source.includes('ê´‘ê³ ')) barColor = '#ef4444';
                else if (source.includes('Google')) barColor = '#3b82f6';
                else if (source.includes('Naver')) barColor = '#22c55e';
                else if (source.includes('Yahoo')) barColor = '#7c3aed';
                else if (source.includes('ì§ì ‘')) barColor = '#6366f1';
                else if (source.includes('SNS')) barColor = '#f59e0b';
                else if (idx === 0) barColor = '#6366f1';

                html += `
                <div style="margin-bottom:12px;">
                    <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;">
                        <span style="font-weight:600; color:#334155;">${source}</span>
                        <span style="font-weight:bold; color:#1e293b;">${count}ëª… (${pct}%)</span>
                    </div>
                    <div class="progress-bg"><div class="progress-fill" style="width:${pct}%; background:${barColor}"></div></div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // ===== ë¸”ë¡œê·¸/ì»¤ë®¤ë‹ˆí‹° ìœ ì… (ê¸°ì¡´) =====
        function renderBlogTraffic(visits) {
            const container = document.getElementById('blogTrafficList');
            const blogMap = {};
            let totalBlogCount = 0;

            visits.forEach(v => {
                let ref = (v.referrer || "").toLowerCase();

                if (!ref
                    || ref.includes('direct') || ref.includes('ì§ì ‘')
                    || ref.includes('search') || ref.includes('ìì—°ê²€ìƒ‰') || ref.includes('google') || ref.includes('naver') || ref.includes('daum') || ref.includes('kakao')
                    || ref.includes('ads') || ref.includes('ê´‘ê³ ')
                    || ref.includes('instagram') || ref.includes('facebook') || ref.includes('youtube')
                    || ref.includes('cafe2626.com') || ref.includes('cafe0101.com') || ref.includes('cafe3355.com')
                    || ref.includes(window.location.hostname)) {
                    return;
                }

                try {
                    let domain = ref.replace('https://', '').replace('http://', '').split('/')[0];
                    if (domain) {
                        blogMap[domain] = (blogMap[domain] || 0) + 1;
                        totalBlogCount++;
                    }
                } catch(e) {}
            });

            if (totalBlogCount === 0) {
                container.innerHTML = '<div style="text-align:center; padding:15px; font-size:12px; color:#999;">ë¸”ë¡œê·¸/ì»¤ë®¤ë‹ˆí‹° ìœ ì… ì—†ìŒ</div>';
                return;
            }

            const sorted = Object.entries(blogMap).sort(([,a], [,b]) => b - a);

            let html = '';
            sorted.forEach(([site, count], idx) => {
                html += `
                <div class="list-row">
                    <div class="rank-num" style="color:#64748b; font-weight:normal;">${idx+1}</div>
                    <div class="row-info" style="color:#334155;">${site}</div>
                    <div class="row-value" style="color:#059669;">${count}ëª…</div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function toggleNewMemberDetail() {
            const el = document.getElementById('newMemberDetail');
            if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function animateValue(id, end, isCurrency = false) {
            const obj = document.getElementById(id);
            if(!obj) return;
            if(obj.innerText.replace(/,/g,'') == end) return;

            const start = 0; const duration = 800;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const val = Math.floor(progress * (end - start) + start);
                obj.innerHTML = val.toLocaleString() + (isCurrency ? '<span style="font-size:16px; font-weight:normal;">ì›</span>' : '');
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        window.addEventListener('DOMContentLoaded', async () => {
            await initConfig();
            loadTodayData();
        });
    </script>

</body>
</html>
