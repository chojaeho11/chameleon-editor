<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Today's Chameleon</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Pretendard', sans-serif;
            margin: 0; padding: 20px;
            color: #334155;
            -webkit-font-smoothing: antialiased;
            max-width: 600px; margin: 0 auto;
        }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { font-size: 20px; font-weight: 800; color: #1e293b; }
        
        .refresh-btn {
            background: #fff; border: 1px solid #e2e8f0; width: 40px; height: 40px;
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            color: #64748b; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s;
        }
        .refresh-btn:active { transform: scale(0.95); background: #f1f5f9; }

        .date-badge {
            display: inline-block; background: #e0e7ff; color: #4338ca;
            padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; margin-bottom: 15px;
        }

        /* ë©”ì¸ ì¹´ë“œ */
        .main-card {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
            color: white; padding: 25px; border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.4);
            margin-bottom: 20px; text-align: center;
        }
        .main-card .label { font-size: 14px; opacity: 0.8; margin-bottom: 5px; font-weight: 600; }
        .main-card .value { font-size: 32px; font-weight: 900; letter-spacing: -1px; }
        .main-card .sub-value { font-size: 13px; margin-top: 10px; opacity: 0.9; display: flex; justify-content: center; gap: 10px;}
        .main-card .divider { width: 1px; background: rgba(255,255,255,0.3); }

        .section-title { font-size: 14px; font-weight: 700; color: #475569; margin: 25px 0 10px 5px; }

        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }

        .stat-card {
            background: white; padding: 15px; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #f1f5f9;
            text-align: center; display: flex; flex-direction: column; align-items: center;
        }
        .stat-icon {
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; margin-bottom: 8px;
        }
        .stat-card .label { font-size: 11px; color: #64748b; font-weight: 600; margin-bottom: 2px; }
        .stat-card .value { font-size: 20px; font-weight: 800; color: #0f172a; }

        .list-card {
            background: white; border-radius: 16px; padding: 15px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #f1f5f9;
        }
        .list-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid #f1f5f9;
        }
        .list-row:last-child { border-bottom: none; }
        .rank-num { width: 24px; font-weight: 800; color: #cbd5e1; font-style: italic; }
        .row-info { flex: 1; font-size: 13px; font-weight: 500; color: #334155; }
        .row-value { font-size: 13px; font-weight: 700; color: #1e293b; }

        .progress-bg { height: 6px; background: #f1f5f9; border-radius: 3px; margin-top: 5px; width: 100%; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 3px; }

        .theme-blue { background: #eff6ff; color: #3b82f6; }
        .theme-green { background: #f0fdf4; color: #22c55e; }
        .theme-purple { background: #f5f3ff; color: #8b5cf6; }
        .theme-orange { background: #fff7ed; color: #f97316; }
        .theme-red { background: #fef2f2; color: #ef4444; }
        .theme-teal { background: #ccfbf1; color: #14b8a6; }

        #loading { display: none; margin-top: 10px; font-size: 12px; color: #666; text-align: center; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1>Dashboard</h1>
            <div style="font-size: 12px; color: #94a3b8;">Mobile View (Live)</div>
        </div>
        <button class="refresh-btn" onclick="loadTodayData()">
            <i class="fa-solid fa-rotate-right"></i>
        </button>
    </div>

    <div class="date-badge" id="todayDate">-</div>

    <div class="main-card">
        <div class="label">ì˜¤ëŠ˜ ì£¼ë¬¸ ì´ì•¡</div>
        <div class="value" id="todayRevenue">0</div>
        <div class="sub-value">
            <span>ì£¼ë¬¸ <span id="todayOrderCount">0</span>ê±´</span>
            <span class="divider"></span>
            <span>ì´ë²ˆ ë‹¬: <span id="monthRevenue">0</span>ì›</span>
        </div>
    </div>

    <div class="section-title">ì£¼ìš” í˜„í™©</div>
    <div class="grid-container">
        <div class="stat-card">
            <div class="stat-icon theme-blue"><i class="fa-solid fa-truck-fast"></i></div>
            <div class="label">ì˜¤ëŠ˜ ë°œì†¡ì˜ˆì •</div>
            <div class="value" id="todayShip">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon theme-green"><i class="fa-solid fa-user-plus"></i></div>
            <div class="label">ì‹ ê·œ íšŒì›</div>
            <div class="value" id="todayNewMember">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon theme-purple"><i class="fa-solid fa-crown"></i></div>
            <div class="label">VIP ë¬¸ì˜</div>
            <div class="value" id="todayVip">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon theme-orange"><i class="fa-solid fa-cloud-arrow-up"></i></div>
            <div class="label">í…œí”Œë¦¿/ë¡œê³ </div>
            <div class="value" id="todayUpload">0</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon theme-red"><i class="fa-solid fa-users"></i></div>
            <div class="label">ì˜¤ëŠ˜ ë°©ë¬¸ì</div>
            <div class="value" id="todayVisitors">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon theme-teal"><i class="fa-regular fa-clock"></i></div>
            <div class="label">í‰ê·  ì²´ë¥˜ì‹œê°„</div>
            <div class="value" id="avgStayTime" style="font-size: 16px;">-</div>
        </div>
    </div>

    <div class="section-title">ìœ ì… ê²½ë¡œ</div>
    <div class="list-card" id="trafficList">
        <div style="text-align:center; color:#ccc; font-size:12px;">ë°ì´í„° ì¤€ë¹„ì¤‘</div>
    </div>

    <div class="section-title">ì§€ì—­ë³„ íŒë§¤ ìˆœìœ„ (Top 5)</div>
    <div class="list-card" id="regionList">
        <div style="text-align:center; color:#ccc; font-size:12px;">ë°ì´í„° ë¶„ì„ ì¤‘...</div>
    </div>

    <div id="loading"><i class="fa-solid fa-spinner fa-spin"></i> ë°ì´í„° ê°±ì‹  ì¤‘...</div>

    <script type="module">
        import { sb, initConfig } from './config.js?v=119';

        window.loadTodayData = async () => {
            const btn = document.querySelector('.refresh-btn');
            const loading = document.getElementById('loading');
            
            btn.style.opacity = '0.5';
            loading.style.display = 'block';

            // ë‚ ì§œ ì„¤ì •
            const now = new Date();
            const dateString = now.toISOString().split('T')[0];
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0).toISOString();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0).toISOString();
            
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            document.getElementById('todayDate').innerText = `${now.getFullYear()}.${now.getMonth()+1}.${now.getDate()} (${dayNames[now.getDay()]})`;

            try {
                // 1. [ë§¤ì¶œ] ì˜¤ëŠ˜ ë°ì´í„° (orders)
                const { data: todayOrders, error: orderErr } = await sb.from('orders')
                    .select('total_amount')
                    .gte('created_at', todayStart)
                    .neq('status', 'ì·¨ì†Œë¨');
                
                if (!orderErr && todayOrders) {
                    const total = todayOrders.reduce((acc, cur) => acc + (cur.total_amount || 0), 0);
                    animateValue("todayRevenue", total, true);
                    animateValue("todayOrderCount", todayOrders.length);
                }

                // 2. [ì›”ê°„ ë°ì´í„°] ë§¤ì¶œ ë° **ì£¼ì†Œ ë¶„ì„ìš© ë°ì´í„°** ê°€ì ¸ì˜¤ê¸°
                // ì´ë²ˆ ë‹¬ ëª¨ë“  ì£¼ë¬¸ì˜ ì£¼ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                const { data: monthOrders } = await sb.from('orders')
                    .select('total_amount, address')
                    .gte('created_at', monthStart)
                    .neq('status', 'ì·¨ì†Œë¨');

                if (monthOrders) {
                    // ë§¤ì¶œ í•©ê³„ í‘œì‹œ
                    const mTotal = monthOrders.reduce((acc, cur) => acc + (cur.total_amount || 0), 0);
                    document.getElementById("monthRevenue").innerText = mTotal.toLocaleString();

                    // [í•µì‹¬] ì§€ì—­ë³„ ìˆœìœ„ ë¶„ì„ ì‹¤í–‰
                    analyzeRegionRank(monthOrders); 
                }

                // 3. [ë°œì†¡/íšŒì›/VIP]
                const { count: shipCount } = await sb.from('orders').select('id', { count: 'exact', head: true }).eq('delivery_target_date', dateString);
                animateValue("todayShip", shipCount || 0);

                const { count: memberCount } = await sb.from('profiles').select('id', { count: 'exact', head: true }).gte('created_at', todayStart);
                animateValue("todayNewMember", memberCount || 0);

                const { count: vipCount } = await sb.from('vip_orders').select('id', { count: 'exact', head: true }).gte('created_at', todayStart);
                animateValue("todayVip", vipCount || 0);

                const { count: upCount } = await sb.from('library').select('id', { count: 'exact', head: true }).gte('created_at', todayStart);
                animateValue("todayUpload", upCount || 0);


                // 4. [ë°©ë¬¸ì/ìœ ì…ê²½ë¡œ] (í…Œì´ë¸” ì¡´ì¬ ì‹œ)
                const { data: visits, error: visitErr } = await sb.from('page_views')
                    .select('referrer, duration')
                    .gte('created_at', todayStart);
                
                if (!visitErr && visits) {
                    animateValue("todayVisitors", visits.length);
                    if (visits.length > 0) {
                        const totalDur = visits.reduce((acc, cur) => acc + (cur.duration || 0), 0);
                        const avgSec = Math.floor(totalDur / visits.length);
                        document.getElementById("avgStayTime").innerText = `${Math.floor(avgSec/60)}ë¶„ ${avgSec%60}ì´ˆ`;
                    }
                    renderTraffic(visits);
                }

            } catch (e) {
                console.error("Error:", e);
            } finally {
                btn.style.opacity = '1';
                loading.style.display = 'none';
            }
        };

        // ==========================================
        // [í•µì‹¬] ì£¼ì†Œ í…ìŠ¤íŠ¸ ë¶„ì„ ë° ë­í‚¹ í•¨ìˆ˜
        // ==========================================
        // ==========================================
        // [ì—…ê·¸ë ˆì´ë“œ] ìŠ¤ë§ˆíŠ¸ ì§€ì—­ ë¶„ì„ ë° ë­í‚¹ í•¨ìˆ˜
        // ==========================================
        function analyzeRegionRank(orders) {
            const container = document.getElementById('regionList');
            const regionMap = {};

            // [ë³´ì • ë¡œì§] ë„ì‹œ ì´ë¦„ì´ ë‚˜ì˜¤ë©´ í•´ë‹¹ ê´‘ì—­ ì§€ì—­ìœ¼ë¡œ ë§¤í•‘
            const mappingRules = [
                // 1. í•œêµ­ ì£¼ìš” ê´‘ì—­ì‹œ/ë„ ë§¤í•‘ (ìƒì„¸ ì£¼ì†Œë§Œ ì ì—ˆì„ ê²½ìš° ëŒ€ë¹„)
                { label: 'ì„œìš¸ (Seoul)', keywords: ['ì„œìš¸', 'ê°•ë‚¨', 'ì„œì´ˆ', 'ì†¡íŒŒ', 'ì ì‹¤', 'ë§ˆí¬', 'í™ëŒ€', 'ì˜ë“±í¬', 'ì—¬ì˜ë„', 'ì„±ë™', 'ì„±ë¶', 'ìš©ì‚°'] },
                { label: 'ê²½ê¸° (Gyeonggi)', keywords: ['ê²½ê¸°', 'í™”ì„±', 'ìˆ˜ì›', 'ìš©ì¸', 'ì„±ë‚¨', 'ë¶„ë‹¹', 'íŒêµ', 'ë¶€ì²œ', 'ì•ˆì‚°', 'ë‚¨ì–‘ì£¼', 'ì•ˆì–‘', 'í‰íƒ', 'ì‹œí¥', 'íŒŒì£¼', 'ê¹€í¬', 'ê´‘ëª…', 'ì¼ì‚°'] },
                { label: 'ì¸ì²œ (Incheon)', keywords: ['ì¸ì²œ', 'ë¶€í‰', 'ì†¡ë„', 'ì²­ë¼'] },
                { label: 'ë¶€ì‚° (Busan)', keywords: ['ë¶€ì‚°', 'í•´ìš´ëŒ€', 'ì„œë©´'] },
                { label: 'ì œì£¼ (Jeju)', keywords: ['ì œì£¼', 'ì„œê·€í¬'] },
                { label: 'ê°•ì› (Gangwon)', keywords: ['ê°•ì›', 'ì¶˜ì²œ', 'ì›ì£¼', 'ê°•ë¦‰', 'ì†ì´ˆ'] },
                { label: 'ëŒ€êµ¬ (Daegu)', keywords: ['ëŒ€êµ¬', 'ë™ì„±ë¡œ'] },
                { label: 'ëŒ€ì „ (Daejeon)', keywords: ['ëŒ€ì „', 'ìœ ì„±'] },
                { label: 'ê´‘ì£¼ (Gwangju)', keywords: ['ê´‘ì£¼'] }, // ê²½ê¸°ë„ ê´‘ì£¼ì™€ ê²¹ì¹  ìˆ˜ ìˆìœ¼ë‚˜ ë³´í†µ ê´‘ì—­ì‹œê°€ ìš°ì„ 
                { label: 'ê²½ë‚¨ (Gyeongnam)', keywords: ['ê²½ë‚¨', 'ì°½ì›', 'ê¹€í•´'] },
                { label: 'ê²½ë¶ (Gyeongbuk)', keywords: ['ê²½ë¶', 'í¬í•­', 'êµ¬ë¯¸', 'ê²½ì£¼'] },
                { label: 'ì¶©ë‚¨ (Chungnam)', keywords: ['ì¶©ë‚¨', 'ì²œì•ˆ', 'ì•„ì‚°'] },
                { label: 'ì¶©ë¶ (Chungbuk)', keywords: ['ì¶©ë¶', 'ì²­ì£¼'] },
                { label: 'ì „ë‚¨ (Jeonnam)', keywords: ['ì „ë‚¨', 'ì—¬ìˆ˜', 'ìˆœì²œ'] },
                { label: 'ì „ë¶ (Jeonbuk)', keywords: ['ì „ë¶', 'ì „ì£¼'] },

                // 2. ì¼ë³¸ (ì£¼ìš” ë„ì‹œ)
                { label: 'ğŸ‡¯ğŸ‡µ ë„ì¿„ (Tokyo)', keywords: ['ë„ì¿„', 'Tokyo', 'æ±äº¬', 'ì‹ ì£¼ì¿ ', 'ì‹œë¶€ì•¼'] },
                { label: 'ğŸ‡¯ğŸ‡µ ì˜¤ì‚¬ì¹´ (Osaka)', keywords: ['ì˜¤ì‚¬ì¹´', 'Osaka', 'å¤§é˜ª', 'ë‚œë°”'] },
                { label: 'ğŸ‡¯ğŸ‡µ í›„ì¿ ì˜¤ì¹´ (Fukuoka)', keywords: ['í›„ì¿ ì˜¤ì¹´', 'Fukuoka', 'í•˜ì¹´íƒ€'] },
                { label: 'ğŸ‡¯ğŸ‡µ ì‚¿í¬ë¡œ (Sapporo)', keywords: ['ì‚¿í¬ë¡œ', 'Sapporo'] },
                { label: 'ğŸ‡¯ğŸ‡µ ë‚˜ê³ ì•¼ (Nagoya)', keywords: ['ë‚˜ê³ ì•¼', 'Nagoya'] },
                { label: 'ğŸ‡¯ğŸ‡µ ì˜¤í‚¤ë‚˜ì™€ (Okinawa)', keywords: ['ì˜¤í‚¤ë‚˜ì™€', 'Okinawa'] },
                { label: 'ğŸ‡¯ğŸ‡µ êµí†  (Kyoto)', keywords: ['êµí† ', 'Kyoto'] }
            ];

            orders.forEach(order => {
                const addr = (order.address || "").trim();
                if (addr.length < 2) return; // ì£¼ì†Œê°€ ë„ˆë¬´ ì§§ìœ¼ë©´ íŒ¨ìŠ¤

                let matched = false;

                // ì •ì˜ëœ ê·œì¹™ ìˆœíšŒí•˜ë©° ë§¤ì¹­
                for (const rule of mappingRules) {
                    // í‚¤ì›Œë“œ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´ í•´ë‹¹ ì§€ì—­ìœ¼ë¡œ ì¹´ìš´íŠ¸
                    if (rule.keywords.some(k => addr.includes(k))) {
                        regionMap[rule.label] = (regionMap[rule.label] || 0) + 1;
                        matched = true;
                        break; 
                    }
                }

                // ë§¤ì¹­ ì•ˆë˜ë©´ 'ê¸°íƒ€'ë¡œ ë¶„ë¥˜ (í•´ì™¸ ê¸°íƒ€ ë“±)
                if (!matched) {
                    // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš°(ìš°í¸ë²ˆí˜¸) ë“±ì€ ì œì™¸í•˜ê³  ì‹¤ì œ í…ìŠ¤íŠ¸ê°€ ìˆì„ ë•Œë§Œ
                    if (/[ê°€-í£a-zA-Z]/.test(addr)) {
                        regionMap['ê¸°íƒ€ ì§€ì—­'] = (regionMap['ê¸°íƒ€ ì§€ì—­'] || 0) + 1;
                    }
                }
            });

            // ì •ë ¬ (ê±´ìˆ˜ ë§ì€ ìˆœ Top 5)
            const sorted = Object.entries(regionMap).sort(([,a], [,b]) => b - a).slice(0, 5);

            // í™”ë©´ ê·¸ë¦¬ê¸°
            if (sorted.length === 0) {
                container.innerHTML = '<div style="text-align:center; font-size:12px; color:#999;">ì§€ì—­ ë°ì´í„° ì—†ìŒ</div>';
                return;
            }

            let html = '';
            sorted.forEach(([name, count], idx) => {
                // 1~3ìœ„ëŠ” ìƒ‰ìƒ ê°•ì¡°
                const rankColor = idx === 0 ? '#eab308' : (idx === 1 ? '#94a3b8' : (idx === 2 ? '#b45309' : '#cbd5e1'));
                html += `
                <div class="list-row">
                    <div class="rank-num" style="color:${rankColor}">${idx+1}</div>
                    <div class="row-info">${name}</div>
                    <div class="row-value">${count}ê±´</div>
                </div>`;
            });
            container.innerHTML = html;
        }


        // ê¸°íƒ€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function renderTraffic(visits) {
            if(!visits || visits.length === 0) return;
            const container = document.getElementById('trafficList');
            const trafficMap = {};
            visits.forEach(v => {
                let s = "ì§ì ‘/ì¦ê²¨ì°¾ê¸°";
                if (v.referrer && v.referrer.includes('google')) s = "êµ¬ê¸€ ê²€ìƒ‰";
                else if (v.referrer && v.referrer.includes('naver')) s = "ë„¤ì´ë²„ ê²€ìƒ‰";
                else if (v.referrer && (v.referrer.includes('instagram') || v.referrer.includes('facebook'))) s = "SNS ê´‘ê³ ";
                else if (v.referrer) s = "ê¸°íƒ€ ì›¹ì‚¬ì´íŠ¸";
                trafficMap[s] = (trafficMap[s] || 0) + 1;
            });

            const sorted = Object.entries(trafficMap).sort(([,a], [,b]) => b - a).slice(0, 3);
            let html = '';
            sorted.forEach(([source, count], idx) => {
                const pct = Math.round((count / visits.length) * 100);
                let color = idx === 0 ? '#3b82f6' : '#cbd5e1';
                html += `
                <div style="margin-bottom:12px;">
                    <div style="display:flex; justify-content:space-between; font-size:13px;">
                        <span>${source}</span>
                        <span style="font-weight:bold;">${count}ëª… (${pct}%)</span>
                    </div>
                    <div class="progress-bg"><div class="progress-fill" style="width:${pct}%; background:${color}"></div></div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function animateValue(id, end, isCurrency = false) {
            const obj = document.getElementById(id);
            if(!obj) return;
            if(obj.innerText.replace(/,/g,'') == end) return;
            
            const start = 0; const duration = 800;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const val = Math.floor(progress * (end - start) + start);
                obj.innerHTML = val.toLocaleString() + (isCurrency ? '<span style="font-size:16px; font-weight:normal;">ì›</span>' : '');
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        window.addEventListener('DOMContentLoaded', async () => {
            await initConfig();
            loadTodayData();
        });
    </script>
    
</body>
</html>