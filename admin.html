<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chameleon Global Admin + Bankda</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Pretendard', sans-serif; background: #f1f5f9; color: #334155; overflow: hidden; }
        
        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 260px; background: #1e293b; color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; }
        .sidebar-header { padding: 25px 20px; font-weight: 800; font-size: 20px; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 10px; color: #818cf8; }
        .nav-menu { list-style: none; padding: 20px 10px; margin: 0; display: flex; flex-direction: column; gap: 5px; }
        .nav-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 15px; color: #cbd5e1; }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: #6366f1; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .nav-label { font-size: 11px; color: #64748b; padding: 0 15px; margin-top: 15px; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; }
        
        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 60px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .page-title { font-size: 18px; font-weight: 700; color: #0f172a; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 30px; }
        
        /* ì„¹ì…˜ ë° ì¹´ë“œ ë ˆì´ì•„ì›ƒ */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .product-layout { display: grid; grid-template-columns: 380px 1fr; gap: 20px; align-items: start; }
        
        /* í¼ ìš”ì†Œ */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 5px; }
        .input-text { padding: 10px 15px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; font-size: 14px; box-sizing: border-box; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        
        /* í…Œì´ë¸” */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-weight: 600; font-size: 13px; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #334155; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }
        
        /* ë²„íŠ¼ */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-sky { background: #0ea5e9; color: white; }
        .btn-sky:hover { background: #0284c7; }
        .btn-vip { background: #d97706; color: white; } 
        .btn-danger { background: #fee2e2; color: #ef4444; }
        .btn-success { background: #22c55e; color: white; } 
        .btn-outline { background: #fff; border: 1px solid #cbd5e1; color: #334155; }
        .btn-sm { padding: 4px 8px; font-size: 11px; }
        .btn-file { background: #fff; color: #334155; border: 1px solid #cbd5e1; padding: 6px 10px; font-size: 12px; border-radius: 4px; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; cursor: pointer; margin-right: 5px; margin-bottom: 3px; max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .btn-file:hover { border-color: #6366f1; color: #6366f1; }
        
        /* ë±ƒì§€ */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .badge.draggable { cursor: grab; }
        .badge-site { font-size: 11px; padding: 3px 6px; border-radius: 4px; margin-right: 4px; font-weight: 800; border: 1px solid #e2e8f0; background: #fff; display: inline-block; min-width: 30px; text-align: center; }
        .badge-site.kr { color: #cf2e2e; border-color: #fecaca; background: #fef2f2; }
        .badge-site.jp { color: #ea580c; border-color: #ffedd5; background: #fff7ed; }
        .badge-site.us { color: #2563eb; border-color: #dbeafe; background: #eff6ff; }

        /* íŒŒì¼ ì—…ë¡œë“œ & í…œí”Œë¦¿ ì¹´ë“œ */
        .file-drop-zone { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; position: relative; background: #f8fafc; color: #64748b; margin-bottom: 10px; }
        .file-drop-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .preview-img { max-width: 100%; height: 150px; object-fit: contain; border-radius: 8px; border: 1px solid #eee; display: none; margin-top: 10px; background: white; }
        .tpl-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .tpl-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; transition: 0.2s; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tpl-thumb { width: 100%; height: 150px; object-fit: contain; background: #f8fafc; border-bottom: 1px solid #f1f5f9; padding: 10px; }
        .tpl-info { padding: 12px; }
        .tpl-del-btn { width: 100%; margin-top: 8px; background: #fee2e2; color: #ef4444; font-size: 12px; padding: 6px; border-radius: 6px; border:none; cursor:pointer; font-weight: 600; }
        
        /* ì˜µì…˜ */
        .addon-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; max-height: 150px; overflow-y: auto; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; }
        .addon-check-item { display: flex; align-items: center; gap: 5px; font-size: 13px; background: white; padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }

        /* ê²°ì œ ë±ƒì§€ */
        .pay-badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-bottom: 4px; }
        .pay-done { background: #fee2e2; color: #ef4444; border: 1px solid #fca5a5; }
        .pay-wait { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.7); z-index: 99999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #6366f1; border-radius: 50%; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .color-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; vertical-align: middle; border: 1px solid rgba(0,0,0,0.1); }
        .staff-select { padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px; width: 100%; margin-bottom: 4px; background: white; cursor: pointer; }

        /* í†µê³„ */
        .stat-card-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 20px; }
        .stat-icon { width: 60px; height: 60px; border-radius: 12px; background: #eff6ff; color: #2563eb; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .stat-info div:first-child { font-size: 14px; color: #64748b; font-weight: 600; margin-bottom: 5px; }
        .stat-info div:last-child { font-size: 24px; font-weight: 800; color: #0f172a; }
        .progress-bar-bg { width: 100%; height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-bar-fill { height: 100%; border-radius: 4px; transition: 0.5s; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-box { background: white; border-radius: 12px; padding: 25px; width: 500px; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 15px; }
        .modal-header { font-size: 18px; font-weight: 800; border-bottom: 1px solid #eee; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .file-list-area { max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; background: #f8fafc; }
        .file-item-row { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px 12px; margin-bottom: 6px; border: 1px solid #eee; border-radius: 6px; font-size: 13px; }
        .file-item-row:last-child { margin-bottom: 0; }
    </style>
</head>
<body>
    <div id="loading"><div class="spinner"></div></div>
    
    <div id="fileManagerModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span>ğŸ“‚ ì£¼ë¬¸ íŒŒì¼ ê´€ë¦¬</span>
                <button class="btn btn-outline btn-sm" onclick="closeFileModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="fileMgrList" class="file-list-area">
                </div>
            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border: 1px dashed #bae6fd;">
                <div style="font-size: 12px; font-weight: bold; color: #0369a1; margin-bottom: 8px;">â• ìƒˆ íŒŒì¼ ì¶”ê°€</div>
                <div style="display: flex; gap: 8px;">
                    <input type="file" id="fileMgrInput" class="input-text" style="padding: 6px;">
                    <button class="btn btn-primary" onclick="uploadFileToOrder()">ì—…ë¡œë“œ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header"><i class="fa-solid fa-earth-americas"></i> Global Admin</div>
        <ul class="nav-menu">
            <div class="nav-label">Business</div>
            <li class="nav-item active" onclick="showSection('sec-orders', this)"><i class="fa-solid fa-cart-shopping"></i> í†µí•© ì£¼ë¬¸ ê´€ë¦¬</li>
            <li class="nav-item" onclick="showSection('sec-bankda', this)"><i class="fa-solid fa-won-sign"></i> ğŸ’° ë±…í¬ë‹¤ ì…ê¸ˆë‚´ì—­</li>
            <li class="nav-item" onclick="showSection('sec-stats', this)"><i class="fa-solid fa-chart-line"></i> ë§¤ì¶œ & í†µê³„</li>
            <li class="nav-item" onclick="showSection('sec-tasks', this)"><i class="fa-solid fa-calendar-check"></i> ì˜¤ëŠ˜ í• ì¼ (ë°°ì†¡ê´€ë¦¬)</li>

            <li class="nav-item" onclick="showSection('sec-withdrawals', this)">
                <i class="fa-solid fa-hand-holding-dollar"></i> ì¶œê¸ˆ ìš”ì²­ ê´€ë¦¬
            </li>
            <li class="nav-item" onclick="showSection('sec-partner-apps', this)">
    <i class="fa-solid fa-store"></i> ê°€ë§¹ì  ì‹ ì²­ ê´€ë¦¬ <span id="partnerPendingCount" class="badge" style="background:#ef4444; color:white; font-size:10px; display:none;">N</span>
</li>
            <div class="nav-label">Product & Stock</div>
            <li class="nav-item" onclick="showSection('sec-products', this)"><i class="fa-solid fa-tags"></i> ìƒí’ˆ & ì˜µì…˜</li>
            
            <div class="nav-label">Management</div>
            <li class="nav-item" onclick="showSection('sec-staff', this)"><i class="fa-solid fa-id-card"></i> ìŠ¤íƒœí”„ ê´€ë¦¬</li>
            <li class="nav-item" onclick="showSection('sec-members', this)"><i class="fa-solid fa-users"></i> íšŒì› ê´€ë¦¬</li>

            <div class="nav-label">Assets</div>
            <li class="nav-item" onclick="showSection('sec-templates', this)"><i class="fa-solid fa-palette"></i> í…œí”Œë¦¿ & ë¡œê³ </li>
            <li class="nav-item" onclick="showSection('sec-fonts', this)"><i class="fa-solid fa-font"></i> í°íŠ¸(ì„œì²´) ê´€ë¦¬</li>
        </ul>
        <div style="margin-top: auto; padding: 20px;">
            <button class="btn btn-danger" style="width: 100%;" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="page-title">í†µí•© ì£¼ë¬¸ ê´€ë¦¬</div>
            <div style="font-size: 14px; color: #64748b;">Global Admin Connected ğŸŸ¢</div>
        </div>

        <div class="content-scroll">
            
            <div id="sec-orders" class="section active">
                <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px;">
        <div style="display:flex; gap:5px;">
            <button class="btn btn-primary" id="btnFilterNew" onclick="filterOrders('ì ‘ìˆ˜ë¨', this)">ğŸ“Œ ì‹ ê·œ ì ‘ìˆ˜</button>
            <button class="btn btn-outline" id="btnFilterKnife" onclick="filterOrders('ì¹¼ì„ ì‘ì—…', this)">âœ‚ï¸ ì¹¼ì„ /ì œì‘ì‘ì—…</button>
            <button class="btn btn-outline" id="btnFilterDone" onclick="filterOrders('ì™„ë£Œë¨', this)">âœ… ì™„ë£Œ</button>
        </div>
        
        <div style="display:flex; gap:5px; align-items:center; background:#f0fdf4; padding:5px 10px; border-radius:8px; border:1px solid #bbf7d0;">
            <span style="font-size:12px; font-weight:bold; color:#166534;">ğŸ“Š ë§¤ì¶œì •ì‚° ì—‘ì…€:</span>
            <input type="month" id="excelMonth" class="input-text" style="width:130px; height:32px; font-size:12px;">
            <button class="btn btn-success btn-sm" onclick="downloadMonthlyExcel()">
                <i class="fa-solid fa-file-excel"></i> ë‹¤ìš´ë¡œë“œ
            </button>
        </div>

        <div style="display:flex; gap:5px; align-items:center;">
            <div id="action-buttons" style="display:flex; gap:5px; margin-right: 15px; border-right: 1px solid #ddd; padding-right: 15px;"></div>
            <select id="filterSite" class="input-text" style="width:130px; font-weight:bold;" onchange="loadOrders()">
                <option value="all">ğŸŒ ì „ì²´ êµ­ê°€</option>
                <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
                <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option>
                <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
            </select>
            <button class="btn btn-outline" onclick="loadOrders()"><i class="fa-solid fa-rotate"></i></button>
        </div>
    </div>
    <table style="margin:0; font-size:12px;">
        <thead>
            <tr>
                <th style="width:30px;"><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></th>
                <th style="width:40px;">Site</th>
                <th style="width:80px;">ë‚ ì§œ</th>
                <th style="width:150px;">ê³ ê° ì •ë³´</th>
                <th style="">ì£¼ë¬¸ ë‚´ì—­</th>
                
                <th style="width:80px; text-align:right; background:#f8fafc;">ì£¼ë¬¸ì´ì•¡</th>
                <th style="width:70px; text-align:right; color:#ef4444; background:#f8fafc;">í• ì¸ì•¡</th>
                <th style="width:70px; text-align:right; color:#d97706; background:#f8fafc;">ì˜ˆì¹˜ê¸ˆ</th>
                <th style="width:80px; text-align:right; color:#15803d; background:#dcfce7;">ì‹¤ì…ê¸ˆì•¡</th>
                
                <th style="width:160px; background:#f0f9ff;">ğŸ“… ë°°ì†¡/ë‹´ë‹¹</th>
                <th style="width:130px;">íŒŒì¼</th>
                <th style="width:70px;">ìƒíƒœ</th>
            </tr>
        </thead>
        <tbody id="orderListBody"></tbody>
    </table>
</div>
            </div>

            <div id="sec-partner-apps" class="section">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">ğŸª ê°€ë§¹ì  ì‹ ì²­ ë‚´ì—­ (ëŒ€ê¸°ì¤‘)</h3>
            <button class="btn btn-outline btn-sm" onclick="loadPartnerApplications()">
                <i class="fa-solid fa-rotate"></i> ìƒˆë¡œê³ ì¹¨
            </button>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th width="150">ì‹ ì²­ì¼</th>
                    <th>ì‹ ì²­ì (ì´ë©”ì¼)</th>
                    <th>ì—…ì²´ëª… (ìƒí˜¸)</th>
                    <th>ì—°ë½ì²˜</th>
                    <th>í¬ë§ ì§€ì—­</th>
                    <th width="100">ìŠ¹ì¸</th>
                </tr>
            </thead>
            <tbody id="partnerAppListBody">
                <tr><td colspan="6" style="text-align:center; padding:30px;">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>
</div>

            <div id="sec-bankda" class="section">
                <div class="card" style="margin-bottom:20px; background:#f0fdf4; border:1px solid #bbf7d0;">
                    <h3 style="margin-top:0; border-bottom:1px solid #bbf7d0; padding-bottom:15px; display:flex; align-items:center; gap:10px; color:#15803d;">
                        <i class="fa-solid fa-robot"></i> ë±…í¬ë‹¤(Bankda) ì‹¤ì‹œê°„ ì…ê¸ˆ í™•ì¸
                    </h3>
                    <div style="display:flex; gap:15px; align-items:flex-end;">
    <div>
        <label class="form-label">ì¡°íšŒ ì‹œì‘ì¼</label>
        <input type="date" id="bankStartDate" class="input-text">
    </div>
    <div>
        <label class="form-label">ì¡°íšŒ ì¢…ë£Œì¼</label>
        <input type="date" id="bankEndDate" class="input-text">
    </div>
    <button class="btn btn-success" style="height:42px;" onclick="loadBankdaList()">
        <i class="fa-solid fa-magnifying-glass"></i> ë‚´ì—­ ì¡°íšŒ
    </button>
    
    <button class="btn btn-outline" style="height:42px; margin-left:auto;" onclick="openManualDepositModal()">
        <i class="fa-solid fa-plus"></i> ì…ê¸ˆê±´ ìˆ˜ë™ ë“±ë¡
    </button>
    </div>
                    <p style="font-size:12px; color:#166534; margin-top:10px; margin-bottom:0;">
                        * ì‹¤ì‹œê°„ ê³„ì¢Œ ê°±ì‹ ì€ ë°±ì—”ë“œ ì„œë²„ì˜ ë±…í¬ë‹¤ ëª¨ë“ˆì„ í˜¸ì¶œí•˜ì—¬ ìµœì‹  ë‚´ì—­ì„ DBë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
                    </p>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <h4 style="margin:0;">ğŸ¦ ì…ê¸ˆ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ (DB: bank_transactions)</h4>
                        <span class="badge" style="background:#f1f5f9; color:#64748b;">ìë™ë§¤ì¹­ í¬í•¨</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th width="150">ê±°ë˜ì¼ì‹œ</th>
                                <th width="120">ì…ê¸ˆìëª…</th>
                                <th width="120" style="text-align:right;">ì…ê¸ˆì•¡</th>
                                <th width="120">ì€í–‰/ê³„ì¢Œ</th>
                                <th width="100">ë§¤ì¹­ ìƒíƒœ</th>
                                <th>ê´€ë¦¬ (ì£¼ë¬¸ì—°ë™)</th>
                            </tr>
                        </thead>
                        <tbody id="bankListBody">
                            <tr><td colspan="6" style="text-align:center; padding:30px;">ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="sec-stats" class="section">
                <div class="card" style="margin-bottom:20px;">
                    <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:15px; display:flex; align-items:center; gap:10px;">
                        <i class="fa-solid fa-calendar-days" style="color:#6366f1;"></i> ê¸°ê°„ë³„ ë§¤ì¶œ ì¡°íšŒ
                    </h3>
                    <div style="display:flex; gap:10px; align-items:flex-end; background:#f8fafc; padding:20px; border-radius:8px;">
                        <div><label class="form-label">ì‹œì‘ì¼</label><input type="date" id="statStartDate" class="input-text"></div>
                        <div><label class="form-label">ì¢…ë£Œì¼</label><input type="date" id="statEndDate" class="input-text"></div>
                        <button class="btn btn-primary" style="height:42px;" onclick="loadStatsData()"><i class="fa-solid fa-magnifying-glass"></i> ì¡°íšŒí•˜ê¸°</button>
                    </div>
                </div>
                <div class="stat-card-group">
                    <div class="stat-card"><div class="stat-icon"><i class="fa-solid fa-won-sign"></i></div><div class="stat-info"><div>ê¸°ê°„ ë‚´ ì´ ë§¤ì¶œ (ê³„ì‚°ë¨)</div><div id="totalRevenue">0</div></div></div>
                    <div class="stat-card"><div class="stat-icon" style="background:#ecfdf5; color:#059669;"><i class="fa-solid fa-receipt"></i></div><div class="stat-info"><div>ì´ ì£¼ë¬¸ ê±´ìˆ˜</div><div id="totalCount">0ê±´</div></div></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div class="card"><h4 style="margin-top:0;">ğŸ‘¨â€ğŸ’¼ ë‹´ë‹¹ ë§¤ë‹ˆì €ë³„ ì‹¤ì </h4><table style="margin-top:0;"><thead><tr><th>ë§¤ë‹ˆì €</th><th style="text-align:right;">ë§¤ì¶œ ê¸°ì—¬ë„</th></tr></thead><tbody id="statManagerBody"></tbody></table></div>
                    <div class="card"><h4 style="margin-top:0;">ğŸšš ë°°ì†¡ ê¸°ì‚¬ë³„ ì‹¤ì </h4><table style="margin-top:0;"><thead><tr><th>ê¸°ì‚¬ë‹˜</th><th style="text-align:right;">ë§¤ì¶œ ê¸°ì—¬ë„</th></tr></thead><tbody id="statDriverBody"></tbody></table></div>
                </div>
            </div>

            <div id="sec-tasks" class="section">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
            <h3 style="margin:0; display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-truck-fast" style="color:#6366f1;"></i> ë‚ ì§œë³„ ë°°ì†¡ ìŠ¤ì¼€ì¤„
            </h3>
            <div style="display:flex; gap:8px; align-items:center;">
                <select id="filterTaskDriver" class="input-text" style="width:200px; font-weight:bold;" onchange="loadDailyTasks()">
                    <option value="all">ğŸš› ì „ì²´ ê¸°ì‚¬ ë³´ê¸°</option>
                </select>
                
                <input type="date" id="taskDate" class="input-text" style="width:140px;" onchange="loadDailyTasks()">
                <button class="btn btn-primary" onclick="loadDailyTasks()">ì¡°íšŒ</button>
            </div>
        </div>
        <table style="margin-top:0;">
            <thead>
                <tr>
                    <th style="width:90px; white-space:nowrap;">ìƒíƒœ</th>
                    <th style="width:180px;">ê³ ê° ì •ë³´ (ì´ë¦„/ì—°ë½ì²˜)</th>
                    <th>ì£¼ë¬¸ íŒŒì¼</th>
                    <th style="width:180px;">ğŸšš ë°°ì†¡ ê¸°ì‚¬ ë°°ì •</th>
                    <th style="width:160px;">â° ì‹œê°„ / ì™„ë£Œì²´í¬</th>
                </tr>
            </thead>
            <tbody id="taskListBody"></tbody>
        </table>
    </div>
</div>

            <div id="sec-withdrawals" class="section">
                <div class="card">
                    <h3 style="margin-top:0;">ğŸ’¸ ê³ ê° ì¶œê¸ˆ ì‹ ì²­ ëª©ë¡</h3>
                    <button class="btn btn-outline btn-sm" onclick="loadWithdrawals()">ìƒˆë¡œê³ ì¹¨</button>
                    <table>
                        <thead><tr><th>ì‹ ì²­ì¼</th><th>ìœ ì €</th><th>ì¶œê¸ˆì•¡</th><th>ê³„ì¢Œì •ë³´</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="withdrawalListBody"></tbody>
                    </table>
                </div>
            </div>
            <div id="sec-products" class="section">
                <div class="card" style="background:#fff7ed; border:1px solid #ffedd5; margin-bottom:20px;">
                    <h3 style="margin-top:0; color:#c2410c;">ğŸ‘‘ ëŒ€ë¶„ë¥˜(Top Category) ê´€ë¦¬</h3>
                    <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                        <div style="flex:1; min-width:120px;"><label class="form-label">ì½”ë“œ (ì˜ë¬¸)</label><input id="newTopCatCode" class="input-text" placeholder="ì˜ˆ: banner_stand"></div>
                        <div style="flex:1; min-width:120px;"><label class="form-label">ğŸ‡°ğŸ‡· í•œêµ­ëª…</label><input id="newTopCatName" class="input-text" placeholder="ì˜ˆ: ë°°ë„ˆê±°ì¹˜ëŒ€"></div>
                        <div style="flex:1; min-width:120px;"><label class="form-label">ğŸ‡¯ğŸ‡µ ì¼ë³¸ëª…</label><input id="newTopCatNameJP" class="input-text" placeholder="ìë™ë²ˆì—­ë¨"></div>
                        <div style="flex:1; min-width:120px;"><label class="form-label">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ëª…</label><input id="newTopCatNameUS" class="input-text" placeholder="ìë™ë²ˆì—­ë¨"></div>
                        
                        <button class="btn btn-vip" onclick="autoTranslateTopCategoryInputs()" style="height:40px;">
                            <i class="fa-solid fa-language"></i> ëŒ€ë¶„ë¥˜ ë²ˆì—­
                        </button>
                        <button class="btn btn-primary" onclick="addTopCategoryDB()" style="height:40px; background:#f97316;">ì €ì¥</button>
                    </div>
                    <div id="topCategoryListArea" style="margin-top:15px; border-top:1px solid #ffedd5; padding-top:10px;"></div>
                </div>

                <div class="card" style="background:#f0f9ff; border:1px solid #bae6fd; margin-bottom:20px;">
                    <h3 style="margin-top:0; color:#0369a1;">0ï¸âƒ£ ì†Œë¶„ë¥˜(Sub Category) ê´€ë¦¬</h3>
                    <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                        
                        <div style="width:140px;">
                            <label class="form-label">ğŸ“‚ ëŒ€ë¶„ë¥˜ ì„ íƒ</label>
                            <select id="newCatTop" class="input-text" style="background:#fff;">
                                <option value="">(ìƒìœ„ ì—†ìŒ)</option>
                            </select>
                        </div>

                        <div style="flex:1; min-width:120px;"><label class="form-label">í´ë” ì½”ë“œ (ì˜ë¬¸)</label><input id="newCatCode" class="input-text" placeholder="ì˜ˆ: honeycomb"></div>
                        <div style="flex:1; min-width:120px;"><label class="form-label">ğŸ‡°ğŸ‡· í•œêµ­ëª…</label><input id="newCatName" class="input-text" placeholder="ì˜ˆ: í—ˆë‹ˆì½¤"></div>
                        <div style="flex:1; min-width:120px;"><label class="form-label">ğŸ‡¯ğŸ‡µ ì¼ë³¸ëª…</label><input id="newCatNameJP" class="input-text" placeholder="ì˜ˆ: ãƒãƒ‹ã‚«ãƒ "></div>
                        <div style="flex:1; min-width:120px;"><label class="form-label">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ëª…</label><input id="newCatNameUS" class="input-text" placeholder="ì˜ˆ: Honeycomb"></div>
                        
                        <button class="btn btn-vip" onclick="autoTranslateCategoryInputs()" style="height:40px;">
                            <i class="fa-solid fa-language"></i> ì†Œë¶„ë¥˜ ë²ˆì—­
                        </button>
                        
                        <button class="btn btn-primary" onclick="addCategoryDB()" style="height:40px;">ìƒì„±/ìˆ˜ì •</button>
                    </div>
                    <div style="text-align:right; margin-top:5px;">
                        <button class="btn btn-outline btn-sm" onclick="bulkTranslateCategories()">
                            <i class="fa-solid fa-bolt"></i> ì¹´í…Œê³ ë¦¬ ì¼ê´„ ë²ˆì—­ (ì „ì²´)
                        </button>
                    </div>
                    <div id="categoryListArea" style="margin-top:15px; border-top:1px solid #bae6fd; padding-top:10px;"></div>
                </div>

                <div class="product-layout">
                    <div class="card product-form">
                        <h3 style="margin-top:0;">2ï¸âƒ£ ìƒí’ˆ ë“±ë¡ (Product)</h3>
                        <div class="form-group" style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                            <label class="form-label">ğŸŒ íŒë§¤ êµ­ê°€ (Site Code)</label>
                            <select id="newProdSite" class="input-text" style="font-weight:bold; color:#6366f1;">
                                <option value="KR" selected>ğŸ‡°ğŸ‡· í•œêµ­ (Korea)</option>
                                <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸ (Japan)</option>
                                <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ (USA)</option>
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label><select id="newProdCategory" class="input-text"><option value="">ë¡œë”© ì¤‘...</option></select></div>
                        <div class="form-group"><label class="form-label">ìƒí’ˆì½”ë“œ (ê³ ìœ ê°’)</label><input id="newProdCode" class="input-text" placeholder="Wall_1_KR"></div>
                        
                        <div class="form-group" style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <label class="form-label" style="margin:0;">ìƒí’ˆëª… (ë‹¤êµ­ì–´)</label>
                                <button class="btn btn-vip btn-sm" onclick="autoTranslateInputs()">
                                    <i class="fa-solid fa-language"></i> í˜„ì¬ë‚´ìš© ìë™ë²ˆì—­
                                </button>
                            </div>
                            <input id="newProdName" class="input-text" placeholder="ğŸ‡°ğŸ‡· í•œêµ­ì–´ (ê¸°ë³¸)" style="margin-bottom:5px;">
                            <input id="newProdNameJP" class="input-text" placeholder="ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´" style="margin-bottom:5px;">
                            <input id="newProdNameUS" class="input-text" placeholder="ğŸ‡ºğŸ‡¸ ì˜ì–´">
                        </div>

                        <div class="input-row">
                            <div style="flex:1;"><label class="form-label">ê°€ë¡œ(mm)</label><input id="newProdW" type="number" class="input-text"></div>
                            <div style="flex:1;"><label class="form-label">ì„¸ë¡œ(mm)</label><input id="newProdH" type="number" class="input-text"></div>
                        </div>

                        <div class="form-group" style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                            <label class="form-label">ê°€ê²© ì„¤ì • (êµ­ê°€ë³„)</label>
                            <div style="display:flex; gap:5px; margin-bottom:5px;">
                                <input id="newProdPrice" type="number" class="input-text" placeholder="ğŸ‡°ğŸ‡· KRW">
                                <input id="newProdPriceJP" type="number" class="input-text" placeholder="ğŸ‡¯ğŸ‡µ JPY">
                            </div>
                            <input id="newProdPriceUS" type="number" class="input-text" placeholder="ğŸ‡ºğŸ‡¸ USD">
                        </div>
                        <div class="form-group"><label class="form-label">ì´ë¯¸ì§€</label><div class="file-drop-zone"><input type="file" id="newProdFile" accept="image/*" onchange="previewProductImage(this)"><span>ì—…ë¡œë“œ</span></div><input id="newProdImg" class="input-text" style="margin-top:5px;" placeholder="URL"><img id="prodPreview" class="preview-img"></div>
                        <div class="form-group"><label class="form-label">ì˜µì…˜ ì—°ê²°</label><div id="addonCheckboxArea" class="addon-checkbox-group"></div></div>
                        <button id="btnProductSave" class="btn btn-primary" style="width:100%;" onclick="addProductDB()">ìƒí’ˆ ë“±ë¡í•˜ê¸°</button>
                        <div style="margin-top:10px; display:flex; gap:5px;"><button id="btnProductClone" class="btn btn-vip" style="flex:1; display:none;" onclick="cloneProduct()">ë³µì œ</button><button id="btnCancelEdit" class="btn btn-outline" style="flex:1; display:none;" onclick="resetProductForm()">ì·¨ì†Œ</button></div>
                    </div>

                    <div class="product-grid-area">
                        <div class="card" style="margin-bottom:20px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <h3 style="margin:0;">1ï¸âƒ£ ì˜µì…˜ í†µí•© ê´€ë¦¬ (3ê°œêµ­ ë™ì‹œ)</h3>
                                <button class="btn btn-vip btn-sm" onclick="autoTranslateAddonInputs()">
                                    <i class="fa-solid fa-language"></i> í˜„ì¬ë‚´ìš© ìë™ë²ˆì—­
                                </button>
                            </div>
                            
                            <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                                <div style="width:100px;"><label class="form-label">êµ¬ë¶„</label><select id="newAddonCat" class="input-text"><option value="addon">ì¶”ê°€</option><option value="material">ì¬ì§ˆ</option><option value="finish">ë§ˆê°</option></select></div>
                                <div style="flex:1; min-width:100px;"><label class="form-label">ì½”ë“œ (ì˜ë¬¸)</label><input id="newAddonCode" class="input-text"></div>
                                <div style="flex:1; min-width:100px;"><label class="form-label">ğŸ‡°ğŸ‡· ëª…ì¹­/ê°€ê²©</label><input id="nmKR" class="input-text" placeholder="ì´ë¦„"><input id="prKR" type="number" class="input-text" placeholder="ì›" style="margin-top:2px;"></div>
                                <div style="flex:1; min-width:100px;"><label class="form-label">ğŸ‡¯ğŸ‡µ ëª…ì¹­/ê°€ê²©</label><input id="nmJP" class="input-text" placeholder="åå‰"><input id="prJP" type="number" class="input-text" placeholder="å††" style="margin-top:2px;"></div>
                                <div style="flex:1; min-width:100px;"><label class="form-label">ğŸ‡ºğŸ‡¸ ëª…ì¹­/ê°€ê²©</label><input id="nmUS" class="input-text" placeholder="Name"><input id="prUS" type="number" class="input-text" placeholder="$" style="margin-top:2px;"></div>
                                <button class="btn btn-primary" onclick="addAddonDB()">ì €ì¥</button>
                            </div>
                            <div style="margin-top:10px;">
                                <select onchange="loadSystemDB(this.value)" id="newAddonSite" class="input-text" style="width:150px; font-size:12px; margin-bottom:5px;"><option value="KR">ğŸ‡°ğŸ‡· í•œêµ­ ì˜µì…˜</option><option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸ ì˜µì…˜</option><option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ì˜µì…˜</option></select>
                            </div>
                            <div style="max-height:200px; overflow-y:auto; border-top:1px solid #eee;">
                                <table style="font-size:12px;"><tbody id="addonTableBody"></tbody></table>
                            </div>
                        </div>
                        <div class="card">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <h3>ğŸ“œ ìƒí’ˆ ëª©ë¡</h3>
                                <button id="btnBulkTranslate" class="btn btn-success btn-sm" onclick="bulkTranslateAll()">
                                    <i class="fa-solid fa-bolt"></i> ì „ì²´ ìƒí’ˆ/ì˜µì…˜/ì¹´í…Œê³ ë¦¬ ìë™ ë²ˆì—­
                                </button>
                            </div>
                            <div style="margin-bottom:10px; display:flex; gap:10px; align-items:center;">
                                <span style="font-weight:bold; color:#64748b;">ğŸ” í•„í„°:</span>
                                <select id="filterProdSite" onchange="filterProductList()" class="input-text" style="width:130px;">
                                    <option value="all">ğŸŒ êµ­ê°€ ì „ì²´</option>
                                    <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
                                    <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option>
                                    <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
                                </select>
                                <select id="filterProdCat" onchange="filterProductList()" class="input-text" style="width:150px;">
                                    <option value="all">ğŸ“‚ ì¹´í…Œê³ ë¦¬ ì „ì²´</option>
                                    </select>
                            </div>
                            <table><thead><tr><th width="50">êµ­ê°€</th><th width="60">ì´ë¯¸ì§€</th><th>ì½”ë“œ/ìƒí’ˆëª…</th><th>ì‚¬ì´ì¦ˆ</th><th>ê°€ê²©</th><th width="80">ê´€ë¦¬</th></tr></thead><tbody id="prodTableBody"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-staff" class="section">
                <div class="product-layout">
                    <div class="card tpl-form">
                        <h3 style="margin-top:0;">ğŸ‘¤ ìŠ¤íƒœí”„ ë“±ë¡</h3>
                        <div class="form-group"><label class="form-label">ì´ë¦„</label><input id="staffName" class="input-text" placeholder="ì˜ˆ: í™ê¸¸ë™"></div>
                        <div class="form-group"><label class="form-label">ì—­í• </label><select id="staffRole" class="input-text"><option value="manager">ë‹´ë‹¹ ë§¤ë‹ˆì €</option><option value="driver">ë°°ì†¡ ê¸°ì‚¬</option></select></div>
                        <div class="form-group"><label class="form-label">ìƒ‰ìƒ</label><input id="staffColor" type="color" class="input-text" style="height:40px; padding:2px;" value="#6366f1"></div>
                        <button class="btn btn-primary" style="width:100%;" onclick="addStaffDB()">ë“±ë¡í•˜ê¸°</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-top:0;">ğŸ“‹ ìŠ¤íƒœí”„ ëª©ë¡</h3>
                        <button class="btn btn-outline btn-sm" onclick="loadStaffList()" style="margin-bottom:10px;">ìƒˆë¡œê³ ì¹¨</button>
                        <table><thead><tr><th width="50">ìƒ‰ìƒ</th><th>ì´ë¦„</th><th>ì—­í• </th><th>ê´€ë¦¬</th></tr></thead><tbody id="staffListBody"></tbody></table>
                    </div>
                </div>
            </div>

            <div id="sec-members" class="section">
    <div class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
            <h3>ğŸ‘¥ íšŒì› ëª©ë¡ & ë“±ê¸‰ ê´€ë¦¬</h3>
            <div style="display:flex; gap:5px;">
                <input type="text" id="memberSearchInput" class="input-text" placeholder="ì´ë©”ì¼ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰" style="width:200px;" onkeyup="if(event.key=='Enter') loadMembers()">
                <button class="btn btn-primary" onclick="loadMembers()"><i class="fa-solid fa-magnifying-glass"></i> ê²€ìƒ‰</button>
            </div>
        </div>
        <table>
            <thead>
    <tr>
        <th>ê°€ì…ì¼</th>
        <th>ì´ë©”ì¼/ì´ë¦„</th>
        <th>ëˆ„ì  êµ¬ë§¤ì•¡ / ë¡œê³ ìˆ˜</th>
        <th>ğŸ’° ì˜ˆì¹˜ê¸ˆ ê´€ë¦¬</th> <th>í˜„ì¬ ë“±ê¸‰</th>
        <th>ë“±ê¸‰ ë³€ê²½</th>
    </tr>
</thead>
            <tbody id="memberListBody"></tbody>
        </table>
    </div>
</div>

            <div id="sec-templates" class="section">
                 <div class="product-layout">
                    <div class="card tpl-form">
                        <h3 style="margin-top:0;">ğŸ“¤ í…œí”Œë¦¿ ë“±ë¡</h3>
                        <div class="form-group">
                            <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                            <select id="tplCategory" class="input-text" onchange="toggleFileInputs()">
                                <option value="logo">ğŸ¨ ë¡œê³  (Logo)</option>
                                <option value="transparent-graphic">ğŸ íŒ¨í„´ (Pattern)</option>
                                <option value="vector">ğŸ–¼ ë²¡í„° ë°°ê²½ (Vector)</option>
                                <option value="photo-bg">ğŸ“· ì‚¬ì§„ ë°°ê²½ (Photo)</option>
                                <option value="graphic">ğŸ§¸ ê·¸ë˜í”½/ìŠ¤í‹°ì»¤ (Graphic)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ê²€ìƒ‰ì–´ (íƒœê·¸)</label>
                            <input id="tplTags" class="input-text" placeholder="ì˜ˆ: ì‚¼ì„±, ë¡œê³ , ì—¬ë¦„">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ì—°ê²° ì œí’ˆ (Product Key)</label>
                            <select id="tplProductKey" class="input-text">
                                <option value="custom">ê³µí†µ / ì§€ì •ì•ˆí•¨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" id="lblThumb">1. ì¸ë„¤ì¼ (í•„ìˆ˜)</label>
                            <div class="file-drop-zone">
                                <input type="file" id="fileThumb" accept="image/*">
                                <span>ì´ë¯¸ì§€ ì„ íƒ</span>
                            </div>
                            <img id="previewThumb" class="preview-img">
                        </div>
                        <div class="form-group" id="groupDataFile">
                            <label class="form-label">2. ë²¡í„° ë°ì´í„° (ì„ íƒ)</label>
                            <div class="file-drop-zone">
                                <input type="file" id="fileData" accept=".svg,.json">
                                <span>SVG íŒŒì¼ ì„ íƒ</span>
                            </div>
                            <div id="dataStatus" style="font-size:12px; color:#16a34a; display:none;">âœ… ì›ë³¸ ì¤€ë¹„ë¨!</div>
                        </div>
                        <button class="btn btn-primary" style="width:100%;" onclick="uploadTemplate()">ë“±ë¡í•˜ê¸°</button>
                    </div>

                    <div class="card">
                        <div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <h3 style="margin:0;">ğŸ—‚ï¸ í…œí”Œë¦¿ ê´€ë¦¬</h3>
                                <button class="btn btn-danger" onclick="deleteSelectedTemplates()">
                                    <i class="fa-solid fa-trash-can"></i> ì„ íƒí•­ëª© ì¼ê´„ì‚­ì œ
                                </button>
                            </div>
                            
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <input type="text" id="tplSearchInput" class="input-text" style="flex:2;" placeholder="íƒœê·¸ ë˜ëŠ” ID ê²€ìƒ‰..." onkeyup="if(event.key=='Enter') loadTemplates()">
                                
                                <select id="filterTplCat" class="input-text" style="flex:1;" onchange="loadTemplates()">
                                    <option value="all">ğŸ“‚ ì¹´í…Œê³ ë¦¬: ì „ì²´</option>
                                    <option value="logo">ğŸ¨ ë¡œê³ </option>
                                    <option value="transparent-graphic">ğŸ íŒ¨í„´</option>
                                    <option value="vector">ğŸ–¼ ë²¡í„° ë°°ê²½</option>
                                    <option value="photo-bg">ğŸ“· ì‚¬ì§„ ë°°ê²½</option>
                                    <option value="graphic">ğŸ§¸ ê·¸ë˜í”½</option>
                                </select>
                                
                                <select id="filterTplProduct" class="input-text" style="flex:1;" onchange="loadTemplates()">
                                    <option value="all">ğŸ“¦ ì œí’ˆì—°ê²°: ì „ì²´</option>
                                    <option value="custom">ğŸ”¹ ê³µí†µ í…œí”Œë¦¿</option>
                                    <option value="assigned">ğŸ”¸ ì œí’ˆ ì „ìš©</option>
                                    <optgroup label="--- ê°œë³„ ì œí’ˆ ---"></optgroup>
                                </select>
                                
                                <button class="btn btn-primary" onclick="loadTemplates()"><i class="fa-solid fa-magnifying-glass"></i> ê²€ìƒ‰</button>
                            </div>
                            
                            <div style="margin-top:10px;">
                                <label style="cursor:pointer; font-weight:bold; font-size:13px;">
                                    <input type="checkbox" onchange="toggleAllTemplates(this)"> ì „ì²´ ì„ íƒ
                                </label>
                            </div>
                        </div>
                        <div id="tplGrid" class="tpl-card-grid"></div>
                    </div>
                </div>
            </div>

            <div id="sec-fonts" class="section">
                <div class="product-layout">
                    <div class="card tpl-form">
                        <h3 style="margin-top:0;">ğŸ”¤ í°íŠ¸ ë“±ë¡</h3>
                        <div class="form-group"><label class="form-label">êµ­ê°€</label><select id="fontSite" class="input-text"><option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option><option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option><option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option></select></div>
                        <div class="form-group"><label class="form-label">í°íŠ¸ëª…</label><input id="fontName" class="input-text" placeholder="ì˜ˆ: Noto Sans JP"></div>
                        <div class="form-group"><label class="form-label">CSS Family</label><input id="fontFamily" class="input-text" placeholder="ì˜ˆ: NotoSansJP"></div>
                        <div class="form-group"><label class="form-label">íŒŒì¼ (.woff2)</label><div class="file-drop-zone"><input type="file" id="fontFile" accept=".woff2,.ttf"><span>íŒŒì¼ ì„ íƒ</span></div></div>
                        <button class="btn btn-primary" style="width:100%;" onclick="uploadFont()">ë“±ë¡í•˜ê¸°</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-top:0;">í°íŠ¸ ëª©ë¡</h3>
                        <button class="btn btn-outline btn-sm" onclick="loadFonts()" style="margin-bottom:10px;">ìƒˆë¡œê³ ì¹¨</button>
                        <table><thead><tr><th width="60">êµ­ê°€</th><th>í‘œì‹œëª…</th><th>ë¯¸ë¦¬ë³´ê¸°</th><th>ì‚­ì œ</th></tr></thead><tbody id="fontListBody"></tbody></table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="walletModal" class="modal-overlay" style="display:none;">
    <div class="modal-box" style="width: 400px;">
        <div class="modal-header">
            <span>ğŸ’° ì˜ˆì¹˜ê¸ˆ ê´€ë¦¬</span>
            <button class="btn btn-outline btn-sm" onclick="document.getElementById('walletModal').style.display='none'">âœ•</button>
        </div>
        
        <div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:15px; text-align:center;">
            <div id="walletTargetName" style="font-weight:bold; color:#334155;">-</div>
            <div style="font-size:12px; color:#64748b;">í˜„ì¬ ì”ì•¡</div>
            <div id="walletTargetBalance" style="font-size:24px; font-weight:800; color:#6366f1;">0ì›</div>
        </div>

        <input type="hidden" id="walletTargetId">
        <input type="hidden" id="walletMode" value="add">

        <div class="form-group">
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="btn btn-primary" style="flex:1;" onclick="setWalletMode('add')" id="btnWalletAdd">â• ì¶©ì „ (ì…ê¸ˆí™•ì¸)</button>
                <button class="btn btn-outline" style="flex:1;" onclick="setWalletMode('sub')" id="btnWalletSub">â– ì°¨ê° (ì·¨ì†Œ/íšŒìˆ˜)</button>
            </div>
            <label class="form-label">ê¸ˆì•¡</label>
            <input type="number" id="walletAmount" class="input-text" placeholder="ìˆ«ìë§Œ ì…ë ¥">
        </div>

        <div class="form-group">
            <label class="form-label">ì‚¬ìœ  (ê³ ê°ì—ê²Œë„ ë³´ì„)</label>
            <input type="text" id="walletDesc" class="input-text" placeholder="ì˜ˆ: ë¬´í†µì¥ ì…ê¸ˆ í™•ì¸">
        </div>

        <button id="btnWalletSubmit" class="btn btn-vip" style="width:100%; margin-top:10px;" onclick="submitWalletChange()">ì ìš©í•˜ê¸°</button>
    </div>
</div>

<script>
    // [ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜]
    window.openWalletModal = (id, email, balance) => {
        document.getElementById('walletTargetId').value = id;
        document.getElementById('walletTargetName').innerText = email;
        document.getElementById('walletTargetBalance').innerText = balance.toLocaleString() + 'ì›';
        document.getElementById('walletAmount').value = '';
        document.getElementById('walletDesc').value = '';
        setWalletMode('add'); // ê¸°ë³¸ì€ ì¶©ì „ ëª¨ë“œ
        document.getElementById('walletModal').style.display = 'flex';
    };

    // [ì¶©ì „/ì°¨ê° ëª¨ë“œ ì „í™˜] â˜… ìˆ˜ì •ë¨: IDë¡œ ë²„íŠ¼ ì°¾ê¸°
    window.setWalletMode = (mode) => {
        document.getElementById('walletMode').value = mode;
        
        const btnAdd = document.getElementById('btnWalletAdd');
        const btnSub = document.getElementById('btnWalletSub');
        const btnSubmit = document.getElementById('btnWalletSubmit'); // â˜… IDë¡œ ì°¾ìŒ

        if(mode === 'add') {
            btnAdd.className = 'btn btn-primary'; 
            btnSub.className = 'btn btn-outline';
            
            btnSubmit.innerText = "ì¶©ì „í•˜ê¸° (ì§€ê¸‰)";
            btnSubmit.className = "btn btn-primary"; // íŒŒë€ìƒ‰
        } else {
            btnAdd.className = 'btn btn-outline'; 
            btnSub.className = 'btn btn-danger';
            
            btnSubmit.innerText = "ì°¨ê°í•˜ê¸° (íšŒìˆ˜)";
            btnSubmit.className = "btn btn-danger"; // ë¹¨ê°„ìƒ‰
        }
    };

    // [ì‹¤ì œ ì ìš© í•¨ìˆ˜]
    window.submitWalletChange = async () => {
        const id = document.getElementById('walletTargetId').value;
        const mode = document.getElementById('walletMode').value;
        const amt = parseInt(document.getElementById('walletAmount').value);
        const desc = document.getElementById('walletDesc').value;

        if(!amt || amt <= 0) return alert("ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        if(!desc) return alert("ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        const finalAmount = mode === 'add' ? amt : -amt;
        const type = mode === 'add' ? 'admin_deposit' : 'admin_withdraw';

        if(!confirm(`${amt.toLocaleString()}ì›ì„ ${mode==='add'?'ì¶©ì „':'ì°¨ê°'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        // 1. ì”ì•¡ ì—…ë°ì´íŠ¸
        const { data: pf } = await sb.from('profiles').select('deposit').eq('id', id).single();
        const newBalance = (pf?.deposit || 0) + finalAmount;

        const { error } = await sb.from('profiles').update({ deposit: newBalance }).eq('id', id);
        if(error) return alert("ì”ì•¡ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: " + error.message);

        // 2. ë¡œê·¸ ê¸°ë¡
        const { error: logErr } = await sb.from('wallet_logs').insert({
            user_id: id,
            type: type,
            amount: finalAmount,
            description: `[ê´€ë¦¬ì] ${desc}`
        });

        if(logErr) alert("ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨(ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìˆìŒ): " + logErr.message);
        else alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");

        document.getElementById('walletModal').style.display = 'none';
        loadMembers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    };
    
    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        const modal = document.getElementById('walletModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>

    <script type="module">
        import { sb, initConfig } from "./config.js";

    // [ë³´ì•ˆ] ê´€ë¦¬ì ê¶Œí•œ ì²´í¬ í•¨ìˆ˜
    async function checkAdminAccess() {
        const { data: { session } } = await sb.auth.getSession();
        
        // 1. ë¹„ë¡œê·¸ì¸ ìƒíƒœë©´ ì¶”ë°©
        if (!session) {
            alert("ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.replace("index.html"); 
            return false;
        }

        // 2. ë“±ê¸‰ í™•ì¸ (admin ì•„ë‹ˆë©´ ì¶”ë°©)
        const { data: profile, error } = await sb.from('profiles').select('role').eq('id', session.user.id).single();
        
        if (error || !profile || profile.role !== 'admin') {
            alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ì ì „ìš©)");
            await sb.auth.signOut(); 
            window.location.replace("index.html");
            return false;
        }

        // 3. í†µê³¼ (í™”ë©´ ë³´ì´ê¸°)
        document.body.style.visibility = 'visible';
        return true;
    }

        // ==========================================
        // 1. ì „ì—­ ë³€ìˆ˜ ë° ê³µí†µ ìœ í‹¸
        // ==========================================
        let currentOrderStatus = 'ì ‘ìˆ˜ë¨'; 
        let allOrders = [];
        let editingProdId = null;
        let editingAddonId = null;
        let editingTopCatId = null; 
        let allProducts = [];
        let staffList = []; 

        let currentMgrOrderId = null;
        let currentMgrFiles = [];

        const formatCurrency = (amount, siteCode) => {
            if (!amount) return '0';
            const site = siteCode || 'KR';
            if (site === 'JP') return 'Â¥' + amount.toLocaleString();
            if (site === 'US') return '$' + amount.toLocaleString();
            return amount.toLocaleString() + 'ì›';
        }

        window.showSection = (secId, navEl) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(secId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(navEl) navEl.classList.add('active');
            
            if(secId === 'sec-orders') loadOrders();
            if(secId === 'sec-bankda') loadBankdaList(); // [ì¶”ê°€] ë±…í¬ë‹¤ ì„¹ì…˜ ë¡œë“œ
            if(secId === 'sec-stats') loadStatsData();
            if(secId === 'sec-members') loadMembers();
            if(secId === 'sec-templates') { loadTemplates(); loadProductKeys(); }
            if(secId === 'sec-fonts') loadFonts(); 
            if(secId === 'sec-products') { loadTopCategoriesList(); loadCategories(); loadSystemDB(); }
            if(secId === 'sec-staff') loadStaffList(); 
        };

        window.logout = async () => { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await sb.auth.signOut(); location.href = "index.html"; } };
        window.closeModal = (id) => document.getElementById(id).style.display='none';
        function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

        // [ì‹ ê·œ] ì˜ˆì¹˜ê¸ˆ ëª¨ë‹¬ ì—´ê¸°
window.openWalletModal = (id, email, currentBalance) => {
    document.getElementById('walletTargetId').value = id;
    document.getElementById('walletTargetName').innerText = email;
    document.getElementById('walletTargetBalance').innerText = currentBalance.toLocaleString() + 'ì›';
    document.getElementById('walletAmount').value = '';
    document.getElementById('walletDesc').value = '';
    
    // ê¸°ë³¸ê°’: ì¶©ì „ ëª¨ë“œ
    setWalletMode('add');
    document.getElementById('walletModal').style.display = 'flex';
};

// [ì‹ ê·œ] ëª¨ë“œ ì „í™˜ (ì¶©ì „/ì°¨ê°)
window.setWalletMode = (mode) => {
    document.getElementById('walletMode').value = mode;
    const btnAdd = document.getElementById('btnWalletAdd');
    const btnSub = document.getElementById('btnWalletSub');
    
    if(mode === 'add') {
        btnAdd.className = 'btn btn-primary';
        btnSub.className = 'btn btn-outline';
        document.querySelector('#walletModal .btn-vip').innerText = 'ì¶©ì „í•˜ê¸° (ì§€ê¸‰)';
        document.querySelector('#walletModal .btn-vip').className = 'btn btn-primary';
    } else {
        btnAdd.className = 'btn btn-outline';
        btnSub.className = 'btn btn-danger';
        document.querySelector('#walletModal .btn-primary').innerText = 'ì°¨ê°í•˜ê¸° (íšŒìˆ˜)';
        document.querySelector('#walletModal .btn-primary').className = 'btn btn-danger';
    }
};

// [ì‹ ê·œ] ì˜ˆì¹˜ê¸ˆ ë³€ê²½ ì‹¤í–‰
window.submitWalletChange = async () => {
    const id = document.getElementById('walletTargetId').value;
    const mode = document.getElementById('walletMode').value;
    const amountStr = document.getElementById('walletAmount').value;
    const desc = document.getElementById('walletDesc').value;

    if(!amountStr || parseInt(amountStr) <= 0) return alert("ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    if(!desc) return alert("ê´€ë¦¬ ê¸°ë¡ì„ ìœ„í•´ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    const amount = parseInt(amountStr);
    const finalAmount = (mode === 'add') ? amount : -amount; // ì°¨ê°ì´ë©´ ìŒìˆ˜
    const type = (mode === 'add') ? 'admin_deposit' : 'admin_withdraw';

    if(!confirm(`${Math.abs(amount).toLocaleString()}ì›ì„ ${mode==='add'?'ì¶©ì „':'ì°¨ê°'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
        // 1. í”„ë¡œí•„ ì”ì•¡ ì—…ë°ì´íŠ¸ (RPC í•¨ìˆ˜ê°€ ì—†ìœ¼ë¯€ë¡œ ì¡°íšŒ í›„ ì—…ë°ì´íŠ¸ ë°©ì‹ ì‚¬ìš© - ê°„ë‹¨ êµ¬í˜„)
        // â€» ë” ì•ˆì „í•˜ê²Œ í•˜ë ¤ë©´ Supabase RPC(Database Function)ì„ ë§Œë“¤ì–´ ì“°ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
        
        // í˜„ì¬ ì”ì•¡ ê°€ì ¸ì˜¤ê¸°
        const { data: profile } = await sb.from('profiles').select('deposit').eq('id', id).single();
        const currentDeposit = profile ? (profile.deposit || 0) : 0;
        const newDeposit = currentDeposit + finalAmount;

        // ì”ì•¡ ì—…ë°ì´íŠ¸
        const { error: updateErr } = await sb.from('profiles').update({ deposit: newDeposit }).eq('id', id);
        if(updateErr) throw updateErr;

        // 2. ë¡œê·¸ ê¸°ë¡ (wallet_logs)
        const { error: logErr } = await sb.from('wallet_logs').insert({
            user_id: id,
            type: type,
            amount: finalAmount,
            description: `[ê´€ë¦¬ì] ${desc}`
        });
        
        if(logErr) console.warn("ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:", logErr);

        alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        closeModal('walletModal');
        loadMembers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨

    } catch(e) {
        alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
    }
};

        // ==========================================
        // [ì¶”ê°€] ë±…í¬ë‹¤(Bankda) ê´€ë ¨ í•¨ìˆ˜
        // ==========================================
        window.loadBankdaList = async () => {
            let start = document.getElementById('bankStartDate').value;
            let end = document.getElementById('bankEndDate').value;
            
            if(!start || !end) { 
                const now = new Date(); 
                end = now.toISOString().split('T')[0];
                const weekAgo = new Date(now);
                weekAgo.setDate(now.getDate() - 7);
                start = weekAgo.toISOString().split('T')[0];
                document.getElementById('bankStartDate').value = start;
                document.getElementById('bankEndDate').value = end;
            }

            showLoading(true);
            const tbody = document.getElementById('bankListBody');
            tbody.innerHTML = '';

            try {
                // 1. ì£¼ë¬¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ë§¤ì¹­ìš©)
                const { data: orders } = await sb.from('orders')
                    .select('id, manager_name, total_amount, payment_status, created_at')
                    .gte('created_at', start + 'T00:00:00')
                    .neq('payment_status', 'ê²°ì œì™„ë£Œ');

                // 2. ì…ê¸ˆ ë‚´ì—­ ê°€ì ¸ì˜¤ê¸° (ê°€ì •ëœ í…Œì´ë¸”: bank_transactions)
                const { data: transactions, error } = await sb.from('bank_transactions')
                    .select('*')
                    .gte('transaction_date', start + 'T00:00:00')
                    .lte('transaction_date', end + 'T23:59:59')
                    .order('transaction_date', { ascending: false });

                if (error) {
                    console.error(error);
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px; color:red;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (í…Œì´ë¸” í™•ì¸ í•„ìš”)</td></tr>`;
                    showLoading(false);
                    return;
                }

                if (!transactions || transactions.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:30px; color:#999;">ê¸°ê°„ ë‚´ ì…ê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                    showLoading(false);
                    return;
                }

                transactions.forEach(tx => {
                    // ë§¤ì¹­ ë¡œì§ (ë‹¨ìˆœ ì´ë¦„ ë§¤ì¹­)
                    const matchOrder = orders.find(o => 
                        o.manager_name === tx.depositor && 
                        Math.abs((o.total_amount || 0) - tx.amount) < 100 // ê¸ˆì•¡ ì˜¤ì°¨ë²”ìœ„ 100ì›
                    );

                    let statusBadge = '<span class="badge" style="background:#f1f5f9; color:#94a3b8;">ë¯¸ë§¤ì¹­</span>';
                    let actionBtn = `<button class="btn btn-outline btn-sm" onclick="matchOrderManual('${tx.id}', '${tx.depositor}')">ìˆ˜ë™ ì—°ê²°</button>`;

                    if (matchOrder) {
                        statusBadge = `<span class="badge" style="background:#dcfce7; color:#166534; border:1px solid #bbf7d0;">âœ… ë§¤ì¹­ë¨ (${matchOrder.manager_name})</span>`;
                        actionBtn = `<button class="btn btn-success btn-sm" onclick="confirmBankMatch('${tx.id}', '${matchOrder.id}')">ì…ê¸ˆí™•ì¸ ì²˜ë¦¬</button>`;
                    } else if (tx.match_status === 'matched') {
                        statusBadge = `<span class="badge" style="background:#e0e7ff; color:#3730a3;">ì²˜ë¦¬ì™„ë£Œ</span>`;
                        actionBtn = `-`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td>${new Date(tx.transaction_date).toLocaleString()}</td>
                            <td style="font-weight:bold;">${tx.depositor}</td>
                            <td style="text-align:right; font-weight:bold; color:#0f172a;">${tx.amount.toLocaleString()}ì›</td>
                            <td><span style="font-size:12px; color:#666;">${tx.bank_name || 'ì€í–‰'}</span></td>
                            <td>${statusBadge}</td>
                            <td>${actionBtn}</td>
                        </tr>
                    `;
                });

            } catch(e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">ì˜¤ë¥˜: ${e.message}</td></tr>`;
            } finally {
                showLoading(false);
            }
        };

        window.runBankdaScraping = async () => {
            if(!confirm("ë±…í¬ë‹¤ ëª¨ë“ˆì„ ì‹¤í–‰í•˜ì—¬ ìµœì‹  ì…ê¸ˆë‚´ì—­ì„ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì„œë²„ ë¶€í•˜ ë°©ì§€ë¥¼ ìœ„í•´ 1ë¶„ ê°„ê²© ê¶Œì¥)")) return;
            
            showLoading(true);
            try {
                // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” Supabase Edge Function URLì„ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
                // const res = await fetch('YOUR_SUPABASE_EDGE_FUNCTION_URL/bankda-scraping', { method: 'POST' });
                
                // [ì‹œë®¬ë ˆì´ì…˜] 2ì´ˆ ëŒ€ê¸° í›„ ì™„ë£Œ ë©”ì‹œì§€
                await new Promise(r => setTimeout(r, 2000));
                
                alert("âœ… ìµœì‹  ë‚´ì—­ ê°±ì‹  ì™„ë£Œ!");
                loadBankdaList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch(e) {
                alert("ìŠ¤í¬ë˜í•‘ ì‹¤íŒ¨: " + e.message);
            } finally {
                showLoading(false);
            }
        };

        window.confirmBankMatch = async (txId, orderId) => {
            if(!confirm("ì´ ì…ê¸ˆë‚´ì—­ìœ¼ë¡œ ì£¼ë¬¸ì„ 'ê²°ì œì™„ë£Œ' ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                // 1. ì£¼ë¬¸ ì—…ë°ì´íŠ¸
                const { error: ordErr } = await sb.from('orders').update({
                    payment_status: 'ê²°ì œì™„ë£Œ',
                    payment_method: 'ë¬´í†µì¥ì…ê¸ˆ'
                }).eq('id', orderId);
                if(ordErr) throw ordErr;

                // 2. ë±…í¬ë‹¤ í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€)
                const { error: txErr } = await sb.from('bank_transactions').update({
                    match_status: 'matched',
                    matched_order_id: orderId
                }).eq('id', txId);
                
                alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadBankdaList();
            } catch(e) {
                alert("ì²˜ë¦¬ ì‹¤íŒ¨: " + e.message);
            }
        };
        
        // ==========================================
        // ê¸°ì¡´ í•¨ìˆ˜ë“¤ (ìœ ì§€)
        // ==========================================
        // [ìˆ˜ì •ë¨] ëŒ€ë¶„ë¥˜ ëª©ë¡ ë¡œë“œ ë° ë“œë˜ê·¸ ê¸°ëŠ¥ ì¶”ê°€
window.loadTopCategoriesList = async () => {
    const listArea = document.getElementById('topCategoryListArea');
    if(!listArea) return;
    listArea.innerHTML = '';

    // sort_order ìˆœìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
    const { data } = await sb.from('admin_top_categories').select('*').order('sort_order', { ascending: true });
    
    if(data) {
        data.forEach(cat => {
            const span = document.createElement('span');
            // 'draggable' í´ë˜ìŠ¤ ì¶”ê°€
            span.className = 'badge draggable';
            // ë“œë˜ê·¸ ê°€ëŠ¥ ì†ì„± true
            span.draggable = true;
            span.dataset.id = cat.id;
            
            // ìŠ¤íƒ€ì¼: cursor:grab ì¶”ê°€ë¨
            span.style.cssText = "border:1px solid #fdba74; color:#c2410c; background:#fff7ed; margin-right:5px; margin-bottom:5px; display:inline-block; padding:6px 10px; cursor:grab; user-select:none;";
            
            span.innerHTML = `<b>${cat.name}</b> (${cat.code}) 
                <i class="fa-solid fa-pen" style="font-size:10px; margin-left:5px; color:#aaa; cursor:pointer;" onclick="editTopCategoryLoad(${cat.id})"></i>
                <i class="fa-solid fa-xmark" style="font-size:10px; margin-left:5px; color:#ef4444; cursor:pointer;" onclick="deleteTopCategoryDB(${cat.id})"></i>`;
            
            // [ë“œë˜ê·¸ ì´ë²¤íŠ¸] ì‹œì‘
            span.addEventListener('dragstart', () => span.classList.add('dragging'));
            
            // [ë“œë˜ê·¸ ì´ë²¤íŠ¸] ì¢…ë£Œ (ìˆœì„œ ì €ì¥)
            span.addEventListener('dragend', async () => {
                span.classList.remove('dragging');
                await saveTopCategoryOrder(); // ìˆœì„œ ì €ì¥ í•¨ìˆ˜ í˜¸ì¶œ
            });

            listArea.appendChild(span);
        });

        // [ì»¨í…Œì´ë„ˆ ì´ë²¤íŠ¸] ë“œë˜ê·¸ ì¤‘ ìœ„ì¹˜ ê³„ì‚° (ê¸°ì¡´ getDragAfterElementX í•¨ìˆ˜ ì¬ì‚¬ìš©)
        listArea.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElementX(listArea, e.clientX);
            const draggable = document.querySelector('.badge.dragging');
            if (afterElement == null) {
                listArea.appendChild(draggable);
            } else {
                listArea.insertBefore(draggable, afterElement);
            }
        });
    }
};

// [ì‹ ê·œ] ëŒ€ë¶„ë¥˜ ìˆœì„œ ì €ì¥ í•¨ìˆ˜
async function saveTopCategoryOrder() {
    // topCategoryListArea ì•ˆì— ìˆëŠ” ë°°ì§€ë“¤ì„ ìˆœì„œëŒ€ë¡œ ê°€ì ¸ì˜´
    const badges = document.querySelectorAll('#topCategoryListArea .badge');
    const updates = [];
    
    badges.forEach((b, i) => {
        // i+1ì„ í•˜ì—¬ sort_orderë¥¼ 1, 2, 3... ìˆœìœ¼ë¡œ ì—…ë°ì´íŠ¸
        updates.push(sb.from('admin_top_categories').update({ sort_order: i + 1 }).eq('id', b.dataset.id));
    });
    
    // ë¹„ë™ê¸° ë³‘ë ¬ ì²˜ë¦¬ë¡œ DB ì—…ë°ì´íŠ¸
    await Promise.all(updates);
    // console.log("ëŒ€ë¶„ë¥˜ ìˆœì„œ ì €ì¥ ì™„ë£Œ");
}

        window.addTopCategoryDB = async () => {
            const codeRaw = document.getElementById('newTopCatCode').value;
            const name = document.getElementById('newTopCatName').value;
            const name_jp = document.getElementById('newTopCatNameJP').value;
            const name_us = document.getElementById('newTopCatNameUS').value;

            if (!codeRaw || !name) return alert("í•„ìˆ˜í•­ëª© ëˆ„ë½: ì½”ë“œì™€ í•œêµ­ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
            const code = codeRaw.toLowerCase().replace(/\s/g, '_');

            try {
                // ì¤‘ë³µ ì²´í¬ ë° ìˆœì„œ ê³„ì‚°
                const { data: exist } = await sb.from('admin_top_categories').select('id, sort_order').eq('code', code).single();
                let nextOrder = 1;
                
                if (exist) {
                    if (!confirm(`âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ëŒ€ë¶„ë¥˜ ì½”ë“œì…ë‹ˆë‹¤: '${code}'\nìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                    nextOrder = exist.sort_order;
                } else {
                    const { data: maxData } = await sb.from('admin_top_categories').select('sort_order').order('sort_order', { ascending: false }).limit(1);
                    if (maxData && maxData.length > 0) nextOrder = (maxData[0].sort_order || 0) + 1;
                }

                const { error } = await sb.from('admin_top_categories').upsert([{
                    code, name, name_jp, name_us, sort_order: nextOrder
                }], { onConflict: 'code' });

                if (error) throw error;
                alert("âœ… ëŒ€ë¶„ë¥˜ ì €ì¥ ì™„ë£Œ");
                
                // ì´ˆê¸°í™”
                document.getElementById('newTopCatCode').value = '';
                document.getElementById('newTopCatName').value = '';
                document.getElementById('newTopCatNameJP').value = '';
                document.getElementById('newTopCatNameUS').value = '';
                
                loadTopCategoriesList(); // ëª©ë¡ ê°±ì‹ 
                loadCategories(); // ì†Œë¶„ë¥˜ ì„ íƒë°•ìŠ¤ë„ ê°±ì‹ 

            } catch (e) {
                alert("ì €ì¥ ì˜¤ë¥˜: " + e.message);
            }
        };

        window.editTopCategoryLoad = async (id) => {
            const { data } = await sb.from('admin_top_categories').select('*').eq('id', id).single();
            if (data) {
                document.getElementById('newTopCatCode').value = data.code;
                document.getElementById('newTopCatName').value = data.name;
                document.getElementById('newTopCatNameJP').value = data.name_jp || '';
                document.getElementById('newTopCatNameUS').value = data.name_us || '';
                // ìŠ¤í¬ë¡¤ ì´ë™
                document.querySelector('#sec-products .card').scrollIntoView({ behavior: 'smooth' });
            }
        };

        window.deleteTopCategoryDB = async (id) => {
            if(!confirm("ì´ ëŒ€ë¶„ë¥˜ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì—°ê²°ëœ ì†Œë¶„ë¥˜ê°€ ìˆë‹¤ë©´ ì—°ê²°ì´ ëŠì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)")) return;
            try {
                const { error } = await sb.from('admin_top_categories').delete().eq('id', id);
                if(error) throw error;
                loadTopCategoriesList();
                loadCategories();
            } catch(e) {
                alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
            }
        };

        // ëŒ€ë¶„ë¥˜ ìë™ ë²ˆì—­
        window.autoTranslateTopCategoryInputs = async () => {
            const krName = document.getElementById('newTopCatName').value;
            if (!krName) return alert("í•œêµ­ì–´ ëª…ì¹­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const btn = document.querySelector('button[onclick="autoTranslateTopCategoryInputs()"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;

            const translate = async (text, targetLang) => {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=${targetLang}&dt=t&q=${encodeURI(text)}`;
                const res = await fetch(url);
                const data = await res.json();
                return data[0][0][0];
            };

            try {
                document.getElementById('newTopCatNameJP').value = await translate(krName, 'ja');
                document.getElementById('newTopCatNameUS').value = await translate(krName, 'en');
                alert("âœ… ë²ˆì—­ ì™„ë£Œ!");
            } catch(e) {
                console.error(e);
                alert("ë²ˆì—­ ì‹¤íŒ¨");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        // ==========================================
        // [ì‹ ê·œ] ì†Œë¶„ë¥˜ ë‹¨ê±´ ìë™ ë²ˆì—­
        // ==========================================
        window.autoTranslateCategoryInputs = async () => {
            const krName = document.getElementById('newCatName').value;
            if (!krName) return alert("í•œêµ­ì–´ ëª…ì¹­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const btn = document.querySelector('button[onclick="autoTranslateCategoryInputs()"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;

            const translate = async (text, targetLang) => {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=${targetLang}&dt=t&q=${encodeURI(text)}`;
                const res = await fetch(url);
                const data = await res.json();
                return data[0][0][0];
            };

            try {
                document.getElementById('newCatNameJP').value = await translate(krName, 'ja');
                document.getElementById('newCatNameUS').value = await translate(krName, 'en');
                alert("âœ… ë²ˆì—­ ì™„ë£Œ!");
            } catch(e) {
                console.error(e);
                alert("ë²ˆì—­ ì‹¤íŒ¨");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        // ==========================================
        // [ì‹ ê·œ] ì¹´í…Œê³ ë¦¬ ì¼ê´„ ë²ˆì—­ (Bulk) - ëŒ€ë¶„ë¥˜+ì†Œë¶„ë¥˜ ëª¨ë‘ ì²˜ë¦¬
        // ==========================================
        window.bulkTranslateCategories = async () => {
            if (!confirm("ì „ì²´ ì¹´í…Œê³ ë¦¬(ëŒ€ë¶„ë¥˜/ì†Œë¶„ë¥˜) ì¤‘ ë²ˆì—­ì´ ë¹ˆ ê³³ì„ ìë™ìœ¼ë¡œ ì±„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?\nì‹œê°„ì´ ì¡°ê¸ˆ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")) return;
            
            // ë²ˆì—­ í•¨ìˆ˜ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
            const safeTranslate = async (text, targetLang) => {
                if (!text) return "";
                let attempt = 0;
                const maxRetries = 5;
                while (attempt < maxRetries) {
                    try {
                        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=${targetLang}&dt=t&q=${encodeURI(text)}`;
                        const res = await fetch(url);
                        if (!res.ok) throw new Error("API Limit");
                        const data = await res.json();
                        return data[0][0][0];
                    } catch (e) {
                        attempt++;
                        console.warn(`Retry ${attempt}...`);
                        await new Promise(r => setTimeout(r, 20000)); // 20ì´ˆ ëŒ€ê¸°
                    }
                }
                return text;
            };

            const delay = (ms) => new Promise(r => setTimeout(r, ms));

            try {
                let count = 0;

                // 1. ëŒ€ë¶„ë¥˜ ì²˜ë¦¬
                const { data: topCats } = await sb.from('admin_top_categories').select('*');
                const targetTop = topCats.filter(c => c.name && (!c.name_jp || !c.name_us));
                
                for (const c of targetTop) {
                    const updates = {};
                    let needsUpdate = false;
                    if (!c.name_jp) { updates.name_jp = await safeTranslate(c.name, 'ja'); needsUpdate = true; await delay(1000); }
                    if (!c.name_us) { updates.name_us = await safeTranslate(c.name, 'en'); needsUpdate = true; await delay(1000); }
                    if (needsUpdate) { await sb.from('admin_top_categories').update(updates).eq('id', c.id); count++; }
                }

                // 2. ì†Œë¶„ë¥˜ ì²˜ë¦¬
                const { data: cats } = await sb.from('admin_categories').select('*');
                const targetCats = cats.filter(c => c.name && (!c.name_jp || !c.name_us));
                
                for (const c of targetCats) {
                    const updates = {};
                    let needsUpdate = false;
                    if (!c.name_jp) { updates.name_jp = await safeTranslate(c.name, 'ja'); needsUpdate = true; await delay(1000); }
                    if (!c.name_us) { updates.name_us = await safeTranslate(c.name, 'en'); needsUpdate = true; await delay(1000); }
                    if (needsUpdate) { await sb.from('admin_categories').update(updates).eq('id', c.id); count++; }
                }

                alert(`âœ… ì´ ${count}ê°œ ì¹´í…Œê³ ë¦¬(ëŒ€/ì†Œë¶„ë¥˜ í†µí•©) ë²ˆì—­ ì™„ë£Œ!`);
                loadTopCategoriesList();
                loadCategories(); 

            } catch (e) {
                alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            }
        };

        // ==========================================
        // [ì‹ ê·œ] ìë™ ë²ˆì—­ ë° í™˜ìœ¨ ê³„ì‚° í•¨ìˆ˜ (ë‹¨ê±´) - ìƒí’ˆìš©
        // ==========================================
        window.autoTranslateInputs = async () => {
            const krName = document.getElementById('newProdName').value;
            const krPrice = document.getElementById('newProdPrice').value;
            const wMM = document.getElementById('newProdW').value || 0;
            const hMM = document.getElementById('newProdH').value || 0;

            if (!krName) return alert("í•œêµ­ì–´ ìƒí’ˆëª…ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if (!krPrice) return alert("í•œêµ­ ê°€ê²©(KRW)ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const btn = document.querySelector('button[onclick="autoTranslateInputs()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ë³€í™˜ ì¤‘...';
            btn.disabled = true;

            try {
                const rateJPY = 0.2; 
                const rateUSD = 0.002;

                // ê°€ê²© ê³„ì‚°
                document.getElementById('newProdPriceJP').value = Math.round(krPrice * rateJPY);
                document.getElementById('newProdPriceUS').value = (krPrice * rateUSD).toFixed(2);

                const translate = async (text, targetLang) => {
                    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=${targetLang}&dt=t&q=${encodeURI(text)}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    return data[0][0][0];
                };

                // ë²ˆì—­ ì‹¤í–‰
                const jpResult = await translate(krName, 'ja');
                document.getElementById('newProdNameJP').value = jpResult;

                const usResult = await translate(krName, 'en');
                
                // í”¼íŠ¸(ft) ë‹¨ìœ„ ë³€í™˜ ë° ì¶”ê°€
                let sizeSuffix = "";
                if (wMM > 0 && hMM > 0) {
                    const wFt = (wMM * 0.00328084).toFixed(1);
                    const hFt = (hMM * 0.00328084).toFixed(1);
                    sizeSuffix = ` (${wFt} x ${hFt} ft)`;
                }
                
                document.getElementById('newProdNameUS').value = usResult + sizeSuffix;

                alert("âœ… ë³€í™˜ ì™„ë£Œ! (í”¼íŠ¸ ë‹¨ìœ„ í¬í•¨)");

            } catch (e) {
                console.error(e);
                alert("ë²ˆì—­ ì¤‘ ì˜¤ë¥˜: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // ==========================================
        // [ì‹ ê·œ] ìë™ ë²ˆì—­ ë° í™˜ìœ¨ ê³„ì‚° í•¨ìˆ˜ (ë‹¨ê±´) - ì˜µì…˜ìš©
        // ==========================================
        window.autoTranslateAddonInputs = async () => {
            const krName = document.getElementById('nmKR').value;
            const krPrice = document.getElementById('prKR').value;

            if (!krName) return alert("í•œêµ­ì–´ ëª…ì¹­ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
            // ê°€ê²©ì´ 0ì›ì¼ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ë¹ˆê°’ë§Œ ì²´í¬
            if (krPrice === '') return alert("í•œêµ­ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const btn = document.querySelector('button[onclick="autoTranslateAddonInputs()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ë³€í™˜ ì¤‘...';
            btn.disabled = true;

            try {
                const rateJPY = 0.115;
                const rateUSD = 0.001;

                // ê°€ê²© ê³„ì‚°
                document.getElementById('prJP').value = Math.round(krPrice * rateJPY);
                document.getElementById('prUS').value = (krPrice * rateUSD).toFixed(2);

                const translate = async (text, targetLang) => {
                    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=${targetLang}&dt=t&q=${encodeURI(text)}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    return data[0][0][0];
                };

                // ì¼ë³¸ì–´ ë²ˆì—­
                document.getElementById('nmJP').value = await translate(krName, 'ja');

                // ì˜ì–´ ë²ˆì—­ (ì˜µì…˜ì€ ì‚¬ì´ì¦ˆê°€ ì—†ìœ¼ë¯€ë¡œ í”¼íŠ¸ ë³€í™˜ ì—†ìŒ)
                document.getElementById('nmUS').value = await translate(krName, 'en');

                alert("âœ… ì˜µì…˜ ë³€í™˜ ì™„ë£Œ!");

            } catch(e) {
                console.error(e);
                alert("ì˜¤ë¥˜: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // ============================================================
// [ì‹ ê·œ] ê°€ë§¹ì  ì‹ ì²­ ê´€ë¦¬ ê¸°ëŠ¥ (admin.html ìŠ¤í¬ë¦½íŠ¸ ë§¨ ëì— ì¶”ê°€)
// ============================================================

// 1. ì‹ ì²­ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
window.loadPartnerApplications = async () => {
    const tbody = document.getElementById('partnerAppListBody');
    if (!tbody) return; // í•´ë‹¹ ì„¹ì…˜ì´ ì—†ìœ¼ë©´ íŒ¨ìŠ¤
    
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;"><div class="spinner"></div></td></tr>';

    try {
        // ëŒ€ê¸°ì¤‘(pending)ì¸ ì‹ ì²­ì„œë§Œ ê°€ì ¸ì˜¤ê¸°
        const { data: apps, error } = await sb
            .from('partner_applications')
            .select('*')
            .eq('status', 'pending')
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!apps || apps.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#999;">ëŒ€ê¸° ì¤‘ì¸ ê°€ë§¹ì  ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            updateBadge(0);
            return;
        }

        updateBadge(apps.length); // ë±ƒì§€ ì—…ë°ì´íŠ¸

        // ì‹ ì²­ìë“¤ì˜ ì´ë©”ì¼ì„ ì•Œê¸° ìœ„í•´ profiles ì¡°íšŒ
        const userIds = apps.map(a => a.user_id);
        const { data: profiles } = await sb.from('profiles').select('id, email').in('id', userIds);
        const emailMap = {};
        if (profiles) profiles.forEach(p => emailMap[p.id] = p.email);

        tbody.innerHTML = '';
        
        apps.forEach(app => {
            const email = emailMap[app.user_id] || 'ì´ë©”ì¼ ì—†ìŒ';
            
            tbody.innerHTML += `
                <tr>
                    <td>${new Date(app.created_at).toLocaleDateString()} <span style="font-size:11px; color:#888;">${new Date(app.created_at).toLocaleTimeString()}</span></td>
                    <td>
                        <div style="font-weight:bold; color:#334155;">${email}</div>
                        <div style="font-size:11px; color:#94a3b8;">UID: ${app.user_id.substring(0,8)}...</div>
                    </td>
                    <td style="font-weight:bold;">${app.company_name}</td>
                    <td>${app.contact_phone}</td>
                    <td><span class="badge" style="background:#e0e7ff; color:#4338ca;">${app.region}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="approvePartnerApp('${app.id}', '${app.user_id}', '${app.region}', '${app.company_name}')">
                            âœ… ìŠ¹ì¸
                        </button>
                    </td>
                </tr>
            `;
        });

    } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">ë¡œë“œ ì˜¤ë¥˜: ${e.message}</td></tr>`;
    }
};

// 2. [í•µì‹¬] ê°€ë§¹ì  ìŠ¹ì¸ ì²˜ë¦¬ (ì›ìŠ¤í†±)
window.approvePartnerApp = async (appId, userId, region, companyName) => {
    if (!confirm(`[ìŠ¹ì¸ í™•ì¸]\n\nì—…ì²´ëª…: ${companyName}\nì§€ì—­: ${region}\n\nì´ íšŒì›ì„ 'ê°€ë§¹ì (Franchise)' ë“±ê¸‰ìœ¼ë¡œ ìŠ¹ê²©ì‹œí‚¤ê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
        // [1ë‹¨ê³„] í”„ë¡œí•„ í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ë“±ê¸‰ ë³€ê²½ + ì§€ì—­ ì„¤ì •)
        const { error: profileErr } = await sb
            .from('profiles')
            .update({ 
                role: 'franchise',   // ë“±ê¸‰ì„ ê°€ë§¹ì ìœ¼ë¡œ!
                region: region       // ì‹ ì²­í•œ ì§€ì—­ ìë™ ì…ë ¥
            })
            .eq('id', userId);

        if (profileErr) throw profileErr;

        // [2ë‹¨ê³„] ì‹ ì²­ì„œ ìƒíƒœë¥¼ 'approved'ë¡œ ë³€ê²½ (ëª©ë¡ì—ì„œ ì‚¬ë¼ì§€ê²Œ)
        const { error: appErr } = await sb
            .from('partner_applications')
            .update({ status: 'approved' })
            .eq('id', appId);

        if (appErr) throw appErr;

        alert(`ğŸ‰ ìŠ¹ì¸ ì™„ë£Œ!\nì´ì œ '${companyName}'ë‹˜ì€ íŒŒíŠ¸ë„ˆìŠ¤ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        loadPartnerApplications(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨

    } catch (e) {
        alert("ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
    }
};

// ë±ƒì§€ ìˆ«ì í‘œì‹œ í—¬í¼
function updateBadge(count) {
    const badge = document.getElementById('partnerPendingCount');
    if(badge) {
        if(count > 0) {
            badge.style.display = 'inline-block';
            badge.innerText = count;
        } else {
            badge.style.display = 'none';
        }
    }
}

// (ì„ íƒ) í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ í•¨ìˆ˜ë“¤ê³¼ í•¨ê»˜ ì‹¤í–‰ë˜ë„ë¡ ìˆ˜ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ
// ë§Œì•½ ê¸°ì¡´ showSection í•¨ìˆ˜ê°€ ìˆë‹¤ë©´ ê±°ê¸°ì— 'sec-partner-apps' ì¼€ì´ìŠ¤ë¥¼ ì¶”ê°€í•´ì•¼ í•¨.
// í•˜ì§€ë§Œ ì¼ë‹¨ ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€í•´ë“œë¦½ë‹ˆë‹¤.

// ê¸°ì¡´ showSection í•¨ìˆ˜ ë®ì–´ì“°ê¸° (admin.html ì•ˆì— ìˆëŠ” í•¨ìˆ˜)
const originalShowSection = window.showSection;
window.showSection = (secId, navEl) => {
    // ê¸°ì¡´ ê¸°ëŠ¥ ì‹¤í–‰
    document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
    document.getElementById(secId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    if(navEl) navEl.classList.add('active');

    // ê¸°ì¡´ ì„¹ì…˜ë³„ ë¡œë“œ
    if(secId === 'sec-orders') loadOrders();
    if(secId === 'sec-bankda') loadBankdaList();
    if(secId === 'sec-stats') loadStatsData();
    if(secId === 'sec-members') loadMembers();
    if(secId === 'sec-templates') { loadTemplates(); loadProductKeys(); }
    if(secId === 'sec-fonts') loadFonts(); 
    if(secId === 'sec-products') { loadTopCategoriesList(); loadCategories(); loadSystemDB(); }
    if(secId === 'sec-staff') loadStaffList();
    if(secId === 'sec-withdrawals') loadWithdrawals();

    // â˜… [ì¶”ê°€ë¨] ê°€ë§¹ì  ì‹ ì²­ íƒ­ í´ë¦­ ì‹œ ë¡œë“œ
    if(secId === 'sec-partner-apps') loadPartnerApplications();
};

        // ==========================================
        // [ìµœì¢… ê°•í™”íŒ] ì°¨ë‹¨ ê°ì§€ ë° ìë™ ì¬ì‹œë„ ê¸°ëŠ¥ í¬í•¨ëœ ì¼ê´„ ë²ˆì—­
        // ==========================================
        window.bulkTranslateAll = async () => {
            if (!confirm("ì „ì²´ ìƒí’ˆê³¼ ì˜µì…˜ì„ ë²ˆì—­í•©ë‹ˆë‹¤.\n\nâ€» êµ¬ê¸€ API ì°¨ë‹¨ ì‹œ ìë™ìœ¼ë¡œ 30ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤.\nì™„ë£Œ ë©”ì‹œì§€ê°€ ëœ° ë•Œê¹Œì§€ ì°½ì„ ë‹«ì§€ ë§ˆì„¸ìš”.")) return;

            const btn = document.getElementById('btnBulkTranslate');
            const originalText = btn.innerHTML;
            btn.disabled = true;

            // í™˜ìœ¨ ì„¤ì • (10ë§Œì› -> 100ë‹¬ëŸ¬)
            const rateJPY = 0.115; 
            const rateUSD = 0.001; 

            // [í•µì‹¬] ì¬ì‹œë„(Retry) ê¸°ëŠ¥ì´ ìˆëŠ” ë²ˆì—­ í•¨ìˆ˜
            const safeTranslate = async (text, targetLang) => {
                if (!text) return "";
                let attempt = 0;
                const maxRetries = 10; // ìµœëŒ€ 10ë²ˆê¹Œì§€ ì¬ì‹œë„

                while (attempt < maxRetries) {
                    try {
                        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=${targetLang}&dt=t&q=${encodeURI(text)}`;
                        const res = await fetch(url);

                        if (!res.ok) throw new Error(`ì°¨ë‹¨ë¨ (${res.status})`);

                        const data = await res.json();
                        return data[0][0][0]; 

                    } catch (e) {
                        attempt++;
                        console.warn(`[ì¬ì‹œë„ ${attempt}/${maxRetries}] êµ¬ê¸€ API ì°¨ë‹¨ ê°ì§€. 30ì´ˆ ëŒ€ê¸°í•©ë‹ˆë‹¤...`);
                        
                        btn.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> API ëŒ€ê¸°ì¤‘... (${attempt}íšŒ ì¬ì‹œë„)`;
                        
                        await new Promise(r => setTimeout(r, 30000));
                    }
                }
                return text; 
            };

            const delay = (ms) => new Promise(res => setTimeout(res, ms));

            try {
                // 1. ìƒí’ˆ (Products)
                const { data: allProds } = await sb.from('admin_products').select('*');
                const targetProds = allProds.filter(p => p.name && (!p.name_jp || !p.name_us || !p.price_jp || !p.price_us));
                
                let pCount = 0;
                for (const p of targetProds) {
                    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ìƒí’ˆ ë²ˆì—­ì¤‘ (${pCount + 1}/${targetProds.length})`;
                    
                    const updates = {};
                    let needsUpdate = false;

                    if (!p.name_jp) {
                        updates.name_jp = await safeTranslate(p.name, 'ja');
                        needsUpdate = true;
                        await delay(1000); 
                    }
                    if (!p.price_jp) {
                        updates.price_jp = Math.round(p.price * rateJPY);
                        needsUpdate = true;
                    }

                    if (!p.name_us) {
                        let enName = await safeTranslate(p.name, 'en');
                        if (p.width_mm > 0 && p.height_mm > 0) {
                            const wFt = (p.width_mm * 0.00328084).toFixed(1);
                            const hFt = (p.height_mm * 0.00328084).toFixed(1);
                            enName += ` (${wFt} x ${hFt} ft)`;
                        }
                        updates.name_us = enName;
                        needsUpdate = true;
                        await delay(1000); 
                    }
                    if (!p.price_us) {
                        updates.price_us = (p.price * rateUSD).toFixed(2);
                        needsUpdate = true;
                    }

                    if (needsUpdate) {
                        await sb.from('admin_products').update(updates).eq('id', p.id);
                        pCount++;
                    }
                }

                // 2. ì˜µì…˜ (Addons)
                const { data: allAddons } = await sb.from('admin_addons').select('*');
                const targetAddons = allAddons.filter(a => (a.name_kr || a.name) && (!a.name_jp || !a.name_us));

                let aCount = 0;
                for (const a of targetAddons) {
                    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ì˜µì…˜ ë²ˆì—­ì¤‘ (${aCount + 1}/${targetAddons.length})`;

                    const updates = {};
                    let needsUpdate = false;
                    const srcName = a.name_kr || a.name;

                    if (!a.name_jp) {
                        updates.name_jp = await safeTranslate(srcName, 'ja');
                        needsUpdate = true;
                        await delay(1000);
                    }
                    if (!a.price_jp) {
                        updates.price_jp = Math.round((a.price_kr || a.price || 0) * rateJPY);
                        needsUpdate = true;
                    }

                    if (!a.name_us) {
                        updates.name_us = await safeTranslate(srcName, 'en');
                        needsUpdate = true;
                        await delay(1000);
                    }
                    if (!a.price_us) {
                        updates.price_us = ((a.price_kr || a.price || 0) * rateUSD).toFixed(2);
                        needsUpdate = true;
                    }

                    if (needsUpdate) {
                        await sb.from('admin_addons').update(updates).eq('id', a.id);
                        aCount++;
                    }
                }

                alert(`âœ… ì‘ì—… ì™„ë£Œ!\nìƒí’ˆ ${pCount}ê°œ, ì˜µì…˜ ${aCount}ê°œê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                loadSystemDB();

            } catch (e) {
                console.error(e);
                alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // 2. ì£¼ë¬¸ ê´€ë¦¬ (Orders)
        // ==========================================
        window.filterOrders = (status, btn) => {
            currentOrderStatus = status;
            document.querySelectorAll('#sec-orders .btn-primary').forEach(b => { b.classList.remove('btn-primary'); b.classList.add('btn-outline'); });
            if(btn) { btn.classList.remove('btn-outline'); btn.classList.add('btn-primary'); }
            updateActionButtons();
            loadOrders();
        };

        function updateActionButtons() {
            const btnGroup = document.getElementById('action-buttons');
            btnGroup.innerHTML = "";
            if (currentOrderStatus === 'ì ‘ìˆ˜ë¨') {
                btnGroup.innerHTML = `<button class="btn btn-primary" onclick="changeStatusSelected('ì¹¼ì„ ì‘ì—…')">ì„ íƒ ì‘ì—…ì‹œì‘</button><button class="btn btn-danger" onclick="deleteOrdersSelected(false)">ì„ íƒ ì‚­ì œ</button>`;
            } else if (currentOrderStatus === 'ì¹¼ì„ ì‘ì—…') {
                btnGroup.innerHTML = `<button class="btn btn-success" onclick="downloadBulkFiles()">ì¼ê´„ ë‹¤ìš´ë¡œë“œ</button><button class="btn btn-vip" onclick="changeStatusSelected('ì™„ë£Œë¨')">ì„ íƒ ì™„ë£Œì²˜ë¦¬</button>`;
            } else if (currentOrderStatus === 'ì™„ë£Œë¨') {
                btnGroup.innerHTML = `<button class="btn btn-outline" onclick="changeStatusSelected('ì¹¼ì„ ì‘ì—…')"><i class="fa-solid fa-rotate-left"></i> ë‹¤ì‹œì¶œë ¥</button><button class="btn btn-danger" onclick="deleteOrdersSelected(true)">ì˜êµ¬ì‚­ì œ</button>`;
            }
        }

        // admin.html ë‚´ë¶€ ìŠ¤í¬ë¦½íŠ¸ì˜ window.loadOrders í•¨ìˆ˜ êµì²´

// [1] ìˆ˜ì •ëœ ì£¼ë¬¸ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜
window.loadOrders = async () => {
    showLoading(true);
    updateActionButtons(); 

    const siteFilter = document.getElementById('filterSite').value;
    await fetchStaffForOrders();

    const { data: partners } = await sb.from('partner_applications').select('user_id, company_name').eq('status', 'approved');
    const partnerMap = {}; if(partners) partners.forEach(p => partnerMap[p.user_id] = p.company_name);

    let query = sb.from('orders').select('*').order('created_at', {ascending:false});
    if (currentOrderStatus === 'ì ‘ìˆ˜ë¨') query = query.in('status', ['ì ‘ìˆ˜ë¨', 'íŒŒì¼ì²˜ë¦¬ì¤‘', 'ì ‘ìˆ˜ëŒ€ê¸°', 'ì œì‘ì¤€ë¹„']);
    else if (currentOrderStatus === 'ì¹¼ì„ ì‘ì—…') query = query.eq('status', 'ì¹¼ì„ ì‘ì—…');
    else if (currentOrderStatus === 'ì™„ë£Œë¨') query = query.in('status', ['ì™„ë£Œë¨', 'ë°œì†¡ì™„ë£Œ', 'ì™„ë£Œ', 'êµ¬ë§¤í™•ì •']);

    const { data, error } = await query;
    const tbody = document.getElementById('orderListBody');
    tbody.innerHTML = '';

    if (!data || data.length === 0) { 
        tbody.innerHTML = '<tr><td colspan="12" style="text-align:center; padding:30px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; 
        showLoading(false); return; 
    }

    const filteredData = siteFilter === 'all' ? data : data.filter(o => (o.site_code || 'KR') === siteFilter);
    allOrders = filteredData; 

    // ìƒí’ˆ ê°€ê²© ë§¤í•‘
    const { data: allProds } = await sb.from('admin_products').select('price, name');
    const prodMap = {}; if(allProds) allProds.forEach(p => prodMap[p.name] = p.price);

    filteredData.forEach(order => {
        const site = order.site_code || 'KR'; 
        const managerSelect = createStaffSelectHTML(order.id, 'manager', order.staff_manager_id);
        const driverSelect = createStaffSelectHTML(order.id, 'driver', order.staff_driver_id);

        // --- [ê¸ˆì•¡ ìƒì„¸ ê³„ì‚°] ---
        let items = [];
        if (order.items) {
            if (Array.isArray(order.items)) items = order.items;
            else if (typeof order.items === 'string') { try { items = JSON.parse(order.items); } catch(e) { items = []; } }
        }

        // 1. ì£¼ë¬¸ ì´ì•¡ (ì›ê°€)
        let rawTotalAmount = 0; 
        items.forEach(item => {
            if (item.isFileDerived) return;
            let unitPrice = item.price || (item.product ? item.product.price : 0) || 0;
            if (unitPrice === 0 && item.product && prodMap[item.product.name]) unitPrice = prodMap[item.product.name];
            rawTotalAmount += (unitPrice * (item.qty || 1));
        });
        if(rawTotalAmount === 0) rawTotalAmount = order.total_amount; 

        // 2. ì‹¤ ê²°ì œì•¡ (DB ì €ì¥ê°’)
        const finalPaidAmount = order.total_amount || 0;

        // 3. í• ì¸ì•¡
        let discountAmt = 0;
        if (rawTotalAmount > finalPaidAmount) {
            discountAmt = rawTotalAmount - finalPaidAmount;
        }

        // 4. ì˜ˆì¹˜ê¸ˆ/ì‹¤ì…ê¸ˆì•¡ êµ¬ë¶„
        let depositUsed = 0;
        let realCashPaid = 0;

        if (order.payment_method === 'deposit' || order.payment_method === 'ì˜ˆì¹˜ê¸ˆ') {
            depositUsed = finalPaidAmount; 
            realCashPaid = 0; 
        } else {
            depositUsed = 0;
            realCashPaid = finalPaidAmount; 
        }

        // ì•„ì´í…œ í‘œì‹œ
        let itemsDisplayHtml = '';
        items.forEach(i => {
            let pName = i.productName || (i.product ? i.product.name : i.name) || 'ìƒí’ˆ';
            itemsDisplayHtml += `<div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">- ${pName} (${i.qty})</div>`;
        });

        // ê°€ë§¹ì  ë±ƒì§€
        let franchiseBadge = '';
        if (order.franchise_id) {
            franchiseBadge = `<span class="badge" style="background:#eff6ff; color:#1e40af;">íŒŒíŠ¸ë„ˆì ‘ìˆ˜</span>`;
        }

        // ê²°ì œ ìƒíƒœ
        const isPaid = (order.payment_status === 'ê²°ì œì™„ë£Œ' || order.payment_status === 'paid');
        const payStatusColor = isPaid ? '#15803d' : '#94a3b8';

        tbody.innerHTML += `
            <tr>
                <td><input type="checkbox" class="row-chk" value="${order.id}"></td>
                <td><span class="badge-site ${site.toLowerCase()}">${site}</span></td>
                <td>${new Date(order.created_at).toLocaleDateString()}</td>
                <td>
                    <b>${order.manager_name}</b><br>
                    <span style="font-size:11px; color:#666;">${order.phone}</span>
                </td>
                <td style="color:#334155; font-size:11px;">${itemsDisplayHtml}</td>

                <td style="text-align:right; color:#64748b;">${rawTotalAmount.toLocaleString()}</td>
                <td style="text-align:right; color:#ef4444;">${discountAmt > 0 ? '-' + discountAmt.toLocaleString() : '-'}</td>
                <td style="text-align:right; color:#d97706;">${depositUsed > 0 ? depositUsed.toLocaleString() : '-'}</td>
                <td style="text-align:right; font-weight:bold; color:#15803d; background:#f0fdf4;">${realCashPaid.toLocaleString()}</td>

                <td>
                    ${franchiseBadge}
                    <div style="margin-top:2px;">${managerSelect}</div>
                    <div style="margin-top:2px;">${driverSelect}</div>
                </td>
                <td>
                    <button class="btn btn-outline btn-sm" onclick="openFileModal('${order.id}')">íŒŒì¼ë³´ê¸°</button>
                </td>
                <td>
                    <span style="color:${payStatusColor}; font-weight:bold;">${order.payment_status}</span><br>
                    <span style="font-size:10px; color:#888;">${order.payment_method}</span>
                </td>
            </tr>
        `;
    });
    showLoading(false);
};

// [2] [ì‹ ê·œ] ì›”ë³„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
window.downloadMonthlyExcel = async () => {
    const monthVal = document.getElementById('excelMonth').value; 
    if (!monthVal) return alert("ë‹¤ìš´ë¡œë“œí•  'ì›”'ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

    const [year, month] = monthVal.split('-');
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0, 23, 59, 59);

    if (!confirm(`${monthVal}ì›” ë§¤ì¶œ ë‚´ì—­ì„ ì—‘ì…€ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    showLoading(true);

    try {
        const { data: orders, error } = await sb.from('orders')
            .select('*')
            .gte('created_at', startDate.toISOString())
            .lte('created_at', endDate.toISOString())
            .order('created_at', { ascending: true });

        if (error) throw error;
        if (!orders || orders.length === 0) {
            showLoading(false);
            return alert("í•´ë‹¹ ì›”ì— ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
        }

        const excelData = orders.map(o => {
            let items = [];
            try { items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items; } catch(e){}

            let rawTotal = 0;
            if(items) {
                items.forEach(i => {
                    let price = i.price || (i.product ? i.product.price : 0) || 0;
                    rawTotal += price * (i.qty || 1);
                });
            }
            if(rawTotal === 0) rawTotal = o.total_amount; 

            const finalPay = o.total_amount || 0;
            const discount = (rawTotal > finalPay) ? (rawTotal - finalPay) : 0;
            const isDeposit = (o.payment_method === 'deposit' || o.payment_method === 'ì˜ˆì¹˜ê¸ˆ');

            return {
                "ì£¼ë¬¸ì¼ì": new Date(o.created_at).toLocaleDateString(),
                "ì£¼ë¬¸ë²ˆí˜¸": o.id,
                "êµ­ê°€": o.site_code || 'KR',
                "ì£¼ë¬¸ì": o.manager_name,
                "ì£¼ë¬¸ë‚´ì—­": items ? items.map(i => `${i.productName}(${i.qty})`).join(', ') : '',
                "ê²°ì œìƒíƒœ": o.payment_status,
                "ê²°ì œìˆ˜ë‹¨": o.payment_method,
                "ì£¼ë¬¸ì´ì•¡(ì›ê°€)": rawTotal,
                "í• ì¸ì•¡": discount,
                "ì˜ˆì¹˜ê¸ˆì‚¬ìš©": isDeposit ? finalPay : 0,
                "ì‹¤ì œì…ê¸ˆì•¡": isDeposit ? 0 : finalPay
            };
        });

        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ë§¤ì¶œì¥ë¶€");
        XLSX.writeFile(wb, `ë§¤ì¶œì¥ë¶€_${monthVal}.xlsx`);

    } catch (e) {
        alert("ì—‘ì…€ ì˜¤ë¥˜: " + e.message);
    } finally {
        showLoading(false);
    }
};
        

        window.openFileModal = async (orderId) => {
            currentMgrOrderId = orderId;
            showLoading(true);
            try {
                const { data, error } = await sb.from('orders').select('files').eq('id', orderId).single();
                if (error) throw error;
                currentMgrFiles = data.files || [];
                renderFileMgrList();
                document.getElementById('fileManagerModal').style.display = 'flex';
            } catch(e) {
                alert("íŒŒì¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: " + e.message);
            } finally {
                showLoading(false);
            }
        };

        window.closeFileModal = () => {
            document.getElementById('fileManagerModal').style.display = 'none';
            currentMgrOrderId = null;
            currentMgrFiles = [];
            document.getElementById('fileMgrInput').value = '';
        };

        function renderFileMgrList() {
            const listArea = document.getElementById('fileMgrList');
            listArea.innerHTML = '';
            
            if (currentMgrFiles.length === 0) {
                listArea.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">ë“±ë¡ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            currentMgrFiles.forEach((file, index) => {
                let badge = '';
                if (file.name.includes('ê²¬ì ì„œ')) badge = '<span class="badge" style="background:#f1f5f9; color:#64748b; margin-right:5px;">ê²¬ì ì„œ</span>';
                else if (file.name.includes('ì‘ì—…ì§€ì‹œì„œ')) badge = '<span class="badge" style="background:#fee2e2; color:#ef4444; margin-right:5px;">ì§€ì‹œì„œ</span>';
                else if (file.type === 'admin_added') badge = '<span class="badge" style="background:#dbeafe; color:#2563eb; margin-right:5px;">ì¶”ê°€ë¨</span>';

                listArea.innerHTML += `
                    <div class="file-item-row">
                        <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:flex; align-items:center;">
                            ${badge}
                            <a href="${file.url}" target="_blank" style="text-decoration:none; color:#334155; font-weight:bold;">${file.name}</a>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteFileFromOrder(${index})" style="margin-left:10px;">ì‚­ì œ</button>
                    </div>
                `;
            });
        }

        window.deleteFileFromOrder = async (index) => {
            if (!confirm("ì •ë§ ì´ íŒŒì¼ì„ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            currentMgrFiles.splice(index, 1);
            await updateOrderFilesDB();
        };

        window.uploadFileToOrder = async () => {
            const input = document.getElementById('fileMgrInput');
            if (!input.files || input.files.length === 0) return alert("ì¶”ê°€í•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            
            const file = input.files[0];
            showLoading(true);
            try {
                const parts = file.name.split('.');
                const ext = parts.length > 1 ? parts.pop() : ''; 
                const timestamp = Date.now();
                const randomStr = Math.random().toString(36).substring(2, 10); 
                const safeStorageName = `added_${timestamp}_${randomStr}.${ext}`;

                const path = `orders/${currentMgrOrderId}/${safeStorageName}`;
                
                const { error: uploadErr } = await sb.storage.from('orders').upload(path, file, {
                    upsert: true
                });

                if (uploadErr) throw uploadErr;
                
                const { data: publicUrlData } = sb.storage.from('orders').getPublicUrl(path);
                
                const newFileObj = {
                    name: file.name, 
                    url: publicUrlData.publicUrl, 
                    type: 'admin_added' 
                };
                
                currentMgrFiles.push(newFileObj);
                await updateOrderFilesDB();
                
                input.value = ''; 
            } catch (e) {
                console.error(e);
                alert("íŒŒì¼ ì¶”ê°€ ì‹¤íŒ¨: " + e.message);
                showLoading(false);
            }
        };

        async function updateOrderFilesDB() {
            if (!currentMgrOrderId) return;
            showLoading(true);
            try {
                const { error } = await sb.from('orders').update({ files: currentMgrFiles }).eq('id', currentMgrOrderId);
                if (error) throw error;
                renderFileMgrList(); 
                loadOrders(); 
            } catch(e) {
                alert("DB ì €ì¥ ì˜¤ë¥˜: " + e.message);
            } finally {
                showLoading(false);
            }
        }

        async function fetchStaffForOrders() { const { data } = await sb.from('admin_staff').select('*'); staffList = data || []; }
        function createStaffSelectHTML(orderId, role, selectedId) {
            const roleName = role === 'manager' ? 'ë‹´ë‹¹' : 'ë°°ì†¡';
            const filteredStaff = staffList.filter(s => s.role === role);
            const selectedStaff = staffList.find(s => s.id == selectedId);
            const dotColor = selectedStaff ? selectedStaff.color : '#ccc';
            const bgColor = selectedStaff ? selectedStaff.color + '10' : '#fff'; 
            let options = `<option value="">${roleName} ë¯¸ì§€ì •</option>`;
            filteredStaff.forEach(s => { options += `<option value="${s.id}" ${s.id == selectedId ? 'selected' : ''}>${s.name}</option>`; });
            return `<div style="position:relative;"><span class="color-dot" style="background:${dotColor}; position:absolute; left:8px; top:10px; pointer-events:none;"></span><select class="staff-select" style="padding-left:25px; background:${bgColor}; border-color:${selectedStaff ? dotColor : '#e2e8f0'};" onchange="updateOrderStaff('${orderId}', '${role}', this.value)">${options}</select></div>`;
        }
        window.updateOrderStaff = async (orderId, role, staffId) => { const field = role === 'manager' ? 'staff_manager_id' : 'staff_driver_id'; const val = staffId ? parseInt(staffId) : null; const { error } = await sb.from('orders').update({ [field]: val }).eq('id', orderId); if(error) alert("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: " + error.message); else loadOrders(); };
        window.toggleAll = (source) => { document.querySelectorAll('.row-chk').forEach(el => el.checked = source.checked); };
        window.changeStatusSelected = async (newStatus) => {
            const checks = document.querySelectorAll('.row-chk:checked');
            if (checks.length === 0) return alert("ì„ íƒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");
            if (!confirm(`ì„ íƒí•œ ${checks.length}ê±´ì„ '${newStatus}' ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const ids = Array.from(checks).map(c => c.value);
            const { error } = await sb.from('orders').update({ status: newStatus }).in('id', ids);
            if (error) alert("ì˜¤ë¥˜: " + error.message); else loadOrders();
        };
        window.deleteOrdersSelected = async (isPermanent) => {
            const checks = document.querySelectorAll('.row-chk:checked');
            if (checks.length === 0) return alert("ì‚­ì œí•  ì£¼ë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            if (!confirm(isPermanent ? "ì •ë§ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const ids = Array.from(checks).map(c => c.value);
            const { error } = await sb.from('orders').delete().in('id', ids);
            if (error) alert("ì‹¤íŒ¨: " + error.message); else loadOrders();
        };
        
        window.downloadBulkFiles = async () => {
            const checks = document.querySelectorAll('.row-chk:checked');
            if (checks.length === 0) return alert("ë‹¤ìš´ë¡œë“œí•  ì£¼ë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            showLoading(true);
            try {
                const zip = new JSZip();
                let fileCount = 0;
                const fetchPromises = [];
                checks.forEach(chk => {
                    const customerName = chk.dataset.manager || 'ê³ ê°ë¯¸ìƒ';
                    const files = JSON.parse(chk.dataset.files || '[]');
                    const items = JSON.parse(chk.dataset.items || '[]');
                    if (files.length === 0) return;
                    const clean = (str) => (str || '').replace(/[\\/:*?"<>|]/g, "").trim();
                    let prodItemIndex = 0; 
                    files.forEach(file => {
                        const originalName = file.name || '';
                        const ext = originalName.split('.').pop(); 
                        let newFileName = "";
                        if (originalName.includes("ê²¬ì ì„œ")) {
                            newFileName = `${clean(customerName)}_ê²¬ì ì„œ.${ext}`;
                        } else if (originalName.includes("ì‘ì—…ì§€ì‹œì„œ")) {
                            newFileName = `${clean(customerName)}_ì‘ì—…ì§€ì‹œì„œ.${ext}`;
                        } else {
                            let currentProductName = 'ê¸°íƒ€'; 
                            if (items.length > 0) {
                                const targetItem = items[prodItemIndex] || items[0]; 
                                if (targetItem.product) currentProductName = targetItem.product.name;
                                else currentProductName = targetItem.productName || targetItem.name || 'ì œí’ˆ';
                            }
                            const random3 = String(Math.floor(Math.random() * 900) + 100);
                            newFileName = `${clean(customerName)}_${random3}_${clean(currentProductName)}.${ext}`;
                            prodItemIndex++;
                        }
                        if(zip.file(newFileName)) newFileName = newFileName.replace(`.${ext}`, `_copy.${ext}`);
                        const promise = fetch(file.url).then(res => { if (!res.ok) throw new Error('Network response was not ok'); return res.blob(); }).then(blob => { zip.file(newFileName, blob); fileCount++; }).catch(err => console.error("File loading error:", err));
                        fetchPromises.push(promise);
                    });
                });
                if (fetchPromises.length === 0) { showLoading(false); return alert("ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."); }
                await Promise.all(fetchPromises);
                if (fileCount === 0) { showLoading(false); return alert("íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); }
                const content = await zip.generateAsync({ type: "blob" });
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                saveAs(content, `ì£¼ë¬¸íŒŒì¼ì¼ê´„_${today}.zip`);
            } catch (e) { console.error(e); alert("ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜: " + e.message); } finally { showLoading(false); }
        };
        
        window.confirmPayment = async (id) => { if(!confirm("ì…ê¸ˆì„ í™•ì¸í•˜ê³  'ê²°ì œì™„ë£Œ' ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; const { error } = await sb.from('orders').update({ payment_status: 'ê²°ì œì™„ë£Œ', payment_method: 'ê³„ì¢Œì´ì²´' }).eq('id', id); if(error) alert("ì˜¤ë¥˜: " + error.message); else loadOrders(); };

        window.loadStatsData = async () => { let start = document.getElementById('statStartDate').value; let end = document.getElementById('statEndDate').value; if(!start || !end) { const now = new Date(); const firstDay = new Date(now.getFullYear(), now.getMonth(), 1); start = firstDay.toISOString().split('T')[0]; end = now.toISOString().split('T')[0]; document.getElementById('statStartDate').value = start; document.getElementById('statEndDate').value = end; } document.getElementById('loading').style.display = 'flex'; const { data: orders, error } = await sb.from('orders').select('*').gte('created_at', start + 'T00:00:00').lte('created_at', end + 'T23:59:59'); if(error) { alert("ë¡œë“œ ì‹¤íŒ¨"); document.getElementById('loading').style.display = 'none'; return; } const { data: allProds } = await sb.from('admin_products').select('price, name'); const prodMap = {}; if(allProds) allProds.forEach(p => prodMap[p.name] = p.price); let totalRevenue = 0; const managerStats = {}; const driverStats = {}; orders.forEach(o => { let amt = o.total_amount || 0; let items = o.items; if (typeof items === 'string') { try { items = JSON.parse(items); } catch(e) { items = []; } } if(amt === 0 && Array.isArray(items)) { items.forEach(i => { let p = 0; if(i.product && i.product.price) p = i.product.price; else if(i.product && prodMap[i.product.name]) p = prodMap[i.product.name]; if(!p) p = i.price || 10000; amt += p * (i.qty || 1); }); } totalRevenue += amt; if(o.staff_manager_id) managerStats[o.staff_manager_id] = (managerStats[o.staff_manager_id] || 0) + amt; if(o.staff_driver_id) driverStats[o.staff_driver_id] = (driverStats[o.staff_driver_id] || 0) + amt; }); document.getElementById('totalRevenue').innerText = totalRevenue.toLocaleString() + "ì›"; document.getElementById('totalCount').innerText = orders.length + "ê±´"; const { data: staff } = await sb.from('admin_staff').select('*'); renderStaffStats('statManagerBody', managerStats, staff || [], totalRevenue); renderStaffStats('statDriverBody', driverStats, staff || [], totalRevenue); document.getElementById('loading').style.display = 'none'; };
        function renderStaffStats(elemId, statsObj, staffList, totalRev) { const tbody = document.getElementById(elemId); tbody.innerHTML = ''; const sortedIds = Object.keys(statsObj).sort((a,b) => statsObj[b] - statsObj[a]); if(sortedIds.length === 0) { tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;">ë°ì´í„° ì—†ìŒ</td></tr>'; return; } sortedIds.forEach(id => { const s = staffList.find(st => st.id == id); if(!s) return; const amt = statsObj[id]; const percent = totalRev > 0 ? Math.round((amt / totalRev) * 100) : 0; tbody.innerHTML += `<tr><td style="padding:12px 0;"><div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;"><div style="width:12px; height:12px; border-radius:50%; background:${s.color};"></div><span style="font-weight:bold;">${s.name}</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${percent}%; background:${s.color};"></div></div></td><td style="text-align:right;"><div>${amt.toLocaleString()}ì›</div><div style="font-size:11px; color:#999;">${percent}%</div></td></tr>`; }); }
        
        window.loadCategories = async () => { 
            const { data: topCats } = await sb.from('admin_top_categories').select('*').order('sort_order');
            const topSelect = document.getElementById('newCatTop');
            if (topSelect && topCats) {
                topSelect.innerHTML = '<option value="">(ìƒìœ„ ì—†ìŒ)</option>';
                topCats.forEach(t => { topSelect.innerHTML += `<option value="${t.code}">${t.name}</option>`; });
            }

            const { data } = await sb.from('admin_categories').select('*').order('sort_order', {ascending:true}); 
            const selectBox = document.getElementById('newProdCategory'); 
            const listArea = document.getElementById('categoryListArea'); 
            selectBox.innerHTML = '<option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>'; 
            listArea.innerHTML = ''; 
            
            if(data) data.forEach(cat => { 
                const option = document.createElement('option'); 
                option.value = cat.code; 
                option.innerText = `${cat.name} (${cat.code})`; 
                selectBox.appendChild(option); 
                
                const span = document.createElement('span'); 
                span.className = 'badge draggable'; 
                span.draggable = true; 
                span.dataset.id = cat.id; 
                span.style.cssText = "border:1px solid #bae6fd; color:#0284c7; margin-right:5px; margin-bottom:5px; display:inline-block; user-select:none; background:white; padding:6px 10px;"; 
                
                const parentName = topCats && cat.top_category_code 
                    ? (topCats.find(t => t.code === cat.top_category_code)?.name || cat.top_category_code) + " > " : "";

                span.innerHTML = `<span style="color:#94a3b8; font-size:11px;">${parentName}</span> <b>${cat.name}</b> (${cat.code}) 
                    <i class="fa-solid fa-pen" style="font-size:10px; margin-left:5px; color:#aaa; cursor:pointer;" onclick="editCategoryLoad(${cat.id})"></i>
                    <i class="fa-solid fa-xmark" style="font-size:10px; margin-left:5px; color:#ef4444; cursor:pointer;" onclick="deleteCategoryDB(${cat.id})"></i>`; 
                span.addEventListener('dragstart', () => span.classList.add('dragging')); 
                span.addEventListener('dragend', async () => { span.classList.remove('dragging'); await saveCategoryOrder(); }); 
                listArea.appendChild(span); 
            }); 
            
            listArea.addEventListener('dragover', e => { 
                e.preventDefault(); 
                const afterElement = getDragAfterElementX(listArea, e.clientX); 
                const draggable = document.querySelector('.badge.dragging'); 
                if (afterElement == null) listArea.appendChild(draggable); 
                else listArea.insertBefore(draggable, afterElement); 
            }); 
        };

        window.addCategoryDB = async () => {
            const topCode = document.getElementById('newCatTop').value || null;
            const codeRaw = document.getElementById('newCatCode').value;
            const name = document.getElementById('newCatName').value;
            const name_jp = document.getElementById('newCatNameJP').value;
            const name_us = document.getElementById('newCatNameUS').value;

            if (!codeRaw || !name) return alert("í•„ìˆ˜í•­ëª© ëˆ„ë½: ì½”ë“œì™€ í•œêµ­ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
            const code = codeRaw.toLowerCase().replace(/\s/g, '_');

            try {
                const { data: exist } = await sb.from('admin_categories').select('id, sort_order').eq('code', code).single();
                let nextOrder = 1;
                if (exist) {
                    if (!confirm(`âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤: '${code}'\nìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                    nextOrder = exist.sort_order;
                } else {
                    const { data: maxData } = await sb.from('admin_categories').select('sort_order').order('sort_order', { ascending: false }).limit(1);
                    if (maxData && maxData.length > 0) nextOrder = (maxData[0].sort_order || 0) + 1;
                }

                const { error } = await sb.from('admin_categories').upsert([{
                    code, name, name_jp, name_us, top_category_code: topCode, sort_order: nextOrder
                }], { onConflict: 'code' });

                if (error) throw error;
                alert("âœ… ì¹´í…Œê³ ë¦¬ ì €ì¥ ì™„ë£Œ");
                document.getElementById('newCatCode').value = '';
                document.getElementById('newCatName').value = '';
                document.getElementById('newCatNameJP').value = '';
                document.getElementById('newCatNameUS').value = '';
                document.getElementById('newCatTop').value = '';
                loadCategories();
            } catch (e) {
                alert("ì €ì¥ ì˜¤ë¥˜: " + e.message);
            }
        };

        window.editCategoryLoad = async (id) => { 
            const {data} = await sb.from('admin_categories').select('*').eq('id',id).single(); 
            if(data) { 
                document.getElementById('newCatTop').value = data.top_category_code || '';
                document.getElementById('newCatCode').value=data.code; 
                document.getElementById('newCatName').value=data.name; 
                document.getElementById('newCatNameJP').value=data.name_jp||''; 
                document.getElementById('newCatNameUS').value=data.name_us||''; 
                document.querySelector('.card').scrollIntoView({behavior:'smooth'}); 
            } 
        };

        window.deleteCategoryDB = async (id) => {
            if(!confirm("ì´ ì†Œë¶„ë¥˜ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                const { error } = await sb.from('admin_categories').delete().eq('id', id);
                if(error) throw error;
                loadCategories();
            } catch(e) {
                alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
            }
        };

        async function saveCategoryOrder() { const badges = document.querySelectorAll('#categoryListArea .badge'); const updates=[]; badges.forEach((b,i)=>updates.push(sb.from('admin_categories').update({sort_order:i+1}).eq('id',b.dataset.id))); await Promise.all(updates); }
        function getDragAfterElementX(container, x) { const draggables = [...container.querySelectorAll('.badge:not(.dragging)')]; return draggables.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = x - box.left - box.width / 2; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest; }, { offset: Number.NEGATIVE_INFINITY }).element; }
        
        window.loadSystemDB = async (filterSite = 'KR') => { 
            const catSelect = document.getElementById('filterProdCat');
            const savedCatValue = catSelect ? catSelect.value : 'all';

            const { data: addons } = await sb.from('admin_addons').select('*').order('category'); 
            const addonBody = document.getElementById('addonTableBody'); 
            const chkArea = document.getElementById('addonCheckboxArea'); 
            if(addonBody) addonBody.innerHTML = ''; 
            if(chkArea) chkArea.innerHTML = ''; 
            if(addons) { 
                addons.forEach(item => { 
                    const color = item.category==='material'?'#16a34a':(item.category==='finish'?'#2563eb':'#d97706'); 
                    let dName = item.name_kr || item.name; 
                    let dPrice = item.price_kr || item.price; 
                    if(filterSite === 'JP') { dName = item.name_jp || item.name; dPrice = item.price_jp || 0; } 
                    if(filterSite === 'US') { dName = item.name_us || item.name; dPrice = item.price_us || 0; } 
                    const priceStr = formatCurrency(dPrice, filterSite); 
                    if(addonBody) { addonBody.innerHTML += `<tr style="background:${editingAddonId===item.id?'#f0f9ff':'transparent'}"><td><span style="color:${color};font-weight:bold;">${item.category}</span></td><td><b>${item.code}</b></td><td><div>ğŸ‡°ğŸ‡· ${item.name_kr||item.name} (${item.price_kr||item.price})</div><div style="font-size:11px;color:#888;">ğŸ‡¯ğŸ‡µ ${item.name_jp||'-'} / ğŸ‡ºğŸ‡¸ ${item.name_us||'-'}</div></td><td><button class="btn btn-outline" style="padding:4px;" onclick="editAddonLoad(${item.id})">ìˆ˜ì •</button> <button class="btn btn-danger" style="padding:4px;" onclick="deleteSystemData('admin_addons',${item.id})">x</button></td></tr>`; } 
                    if(chkArea) { chkArea.innerHTML += `<label class="addon-check-item"><span class="badge-site ${filterSite.toLowerCase()}" style="font-size:10px;">${filterSite}</span> ${dName} (${priceStr}) <input type="checkbox" name="prodAddon" value="${item.code}"></label>`; } 
                }); 
            } 
            
            const { data: cats } = await sb.from('admin_categories').select('*').order('sort_order');
            if (catSelect && cats) {
                catSelect.innerHTML = '<option value="all">ğŸ“‚ ì¹´í…Œê³ ë¦¬ ì „ì²´</option>';
                cats.forEach(c => { catSelect.innerHTML += `<option value="${c.code}">${c.name}</option>`; });
                if (savedCatValue) catSelect.value = savedCatValue;
            }

            const { data: prods } = await sb.from('admin_products').select('*').order('sort_order').order('id'); 
            allProducts = prods || []; 
            filterProductList(); 
        };

        window.editAddonLoad = async (id) => { const { data } = await sb.from('admin_addons').select('*').eq('id', id).single(); if(!data) return; editingAddonId = id; document.getElementById('newAddonCat').value = data.category; document.getElementById('newAddonCode').value = data.code; document.getElementById('nmKR').value = data.name_kr||data.name; document.getElementById('prKR').value = data.price_kr||data.price; document.getElementById('nmJP').value = data.name_jp||''; document.getElementById('prJP').value = data.price_jp||0; document.getElementById('nmUS').value = data.name_us||''; document.getElementById('prUS').value = data.price_us||0; const btn = document.querySelector('#newAddonCode').parentElement.parentElement.querySelector('.btn-primary'); btn.innerText = "ìˆ˜ì • ì™„ë£Œ"; btn.classList.remove('btn-primary'); btn.classList.add('btn-vip'); };
        window.addAddonDB = async () => { const cat = document.getElementById('newAddonCat').value; const code = document.getElementById('newAddonCode').value; const nKR = document.getElementById('nmKR').value; const pKR = document.getElementById('prKR').value; const nJP = document.getElementById('nmJP').value; const pJP = document.getElementById('prJP').value; const nUS = document.getElementById('nmUS').value; const pUS = document.getElementById('prUS').value; if(!code) return alert("ì½”ë“œ í•„ìˆ˜"); const payload = { category: cat, code: code, name_kr: nKR, price_kr: parseInt(pKR||0), name_jp: nJP, price_jp: parseInt(pJP||0), name_us: nUS, price_us: parseInt(pUS||0), name: nKR, price: parseInt(pKR||0) }; if(editingAddonId) { await sb.from('admin_addons').update(payload).eq('id', editingAddonId); alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); } else { await sb.from('admin_addons').insert([payload]); alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); } editingAddonId = null; document.getElementById('newAddonCode').value = ''; document.getElementById('nmKR').value=''; document.getElementById('prKR').value=''; document.getElementById('nmJP').value=''; document.getElementById('prJP').value=''; document.getElementById('nmUS').value=''; document.getElementById('prUS').value=''; const btn = document.querySelector('#newAddonCode').parentElement.parentElement.querySelector('.btn'); btn.innerText = "ì €ì¥"; btn.classList.remove('btn-vip'); btn.classList.add('btn-primary'); loadSystemDB('KR'); };
        
        window.filterProductList = () => {
            const siteFilter = document.getElementById('filterProdSite').value;
            const catFilter = document.getElementById('filterProdCat').value;

            let filtered = allProducts;
            if (siteFilter !== 'all') filtered = filtered.filter(p => p.site_code === siteFilter);
            if (catFilter !== 'all') filtered = filtered.filter(p => p.category === catFilter);

            renderProductList(filtered);
        };

        window.renderProductList = (products) => { 
            const prodBody = document.getElementById('prodTableBody'); 
            prodBody.innerHTML = ''; 
            if(!products || products.length === 0) {
                prodBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">ì¡°ê±´ì— ë§ëŠ” ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            products.forEach(item => { 
                const site = item.site_code || 'KR'; 
                const displayPrice = formatCurrency(item.price, site); 
                const tr = document.createElement('tr'); 
                tr.className = 'draggable-row'; 
                tr.draggable = true; 
                tr.dataset.id = item.id; 
                tr.innerHTML = `<td><span class="badge-site ${site.toLowerCase()}">${site}</span></td><td><img src="${item.img_url}" style="width:40px; height:40px; object-fit:cover; border-radius:4px; background:#eee;" onerror="this.src='https://placehold.co/40?text=NoImg'"></td><td><div style="font-size:11px; color:#6366f1; font-weight:bold;">${item.category || '-'}</div><b>${item.code}</b><br>${item.name}</td><td>${item.width_mm}x${item.height_mm}</td><td>${displayPrice}</td><td><button class="btn btn-outline" style="padding:4px;" onclick="editProductLoad(${item.id})">ìˆ˜ì •</button> <button class="btn btn-danger" style="padding:4px;" onclick="deleteSystemData('admin_products', ${item.id})">ì‚­ì œ</button></td>`; 
                addDragListeners(tr); 
                prodBody.appendChild(tr); 
            }); 
        };
        
        window.addProductDB = async () => {
            const site = document.getElementById('newProdSite').value;
            const cat = document.getElementById('newProdCategory').value;
            const code = document.getElementById('newProdCode').value;
            const w = document.getElementById('newProdW').value;
            const h = document.getElementById('newProdH').value;
            const img = document.getElementById('newProdImg').value;
            const name = document.getElementById('newProdName').value;
            const nameJP = document.getElementById('newProdNameJP').value;
            const nameUS = document.getElementById('newProdNameUS').value;
            const price = document.getElementById('newProdPrice').value;
            const priceJP = document.getElementById('newProdPriceJP').value;
            const priceUS = document.getElementById('newProdPriceUS').value;

            if(!code || !name) return alert("ìƒí’ˆì½”ë“œì™€ í•œêµ­ì–´ ìƒí’ˆëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

            const addons = Array.from(document.querySelectorAll('input[name="prodAddon"]:checked')).map(cb => cb.value).join(',');
            const payload = { site_code: site, currency: 'KRW', category: cat, code, width_mm: parseInt(w||0), height_mm: parseInt(h||0), img_url: img, addons, name, name_jp: nameJP || null, name_us: nameUS || null, price: parseInt(price||0), price_jp: parseInt(priceJP||0), price_us: parseInt(priceUS||0) };

            let res;
            if(editingProdId) res = await sb.from('admin_products').update(payload).eq('id', editingProdId);
            else res = await sb.from('admin_products').insert([payload]);

            if(res.error) alert(res.error.message);
            else { alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); resetProductForm(); loadSystemDB(site); }
        };

        window.editProductLoad = async (id) => {
            const { data } = await sb.from('admin_products').select('*').eq('id', id).single();
            if(!data) return;
            editingProdId = id;
            document.getElementById('newProdSite').value = data.site_code;
            document.getElementById('newProdCategory').value = data.category;
            document.getElementById('newProdCode').value = data.code;
            document.getElementById('newProdW').value = data.width_mm;
            document.getElementById('newProdH').value = data.height_mm;
            document.getElementById('newProdImg').value = data.img_url;
            const preview = document.getElementById('prodPreview');
            preview.src = data.img_url; preview.style.display = 'block';
            document.getElementById('newProdName').value = data.name || '';
            document.getElementById('newProdNameJP').value = data.name_jp || '';
            document.getElementById('newProdNameUS').value = data.name_us || '';
            document.getElementById('newProdPrice').value = data.price || 0;
            document.getElementById('newProdPriceJP').value = data.price_jp || 0;
            document.getElementById('newProdPriceUS').value = data.price_us || 0;
            const addons = data.addons ? data.addons.split(',') : [];
            document.querySelectorAll('input[name="prodAddon"]').forEach(c => c.checked = addons.includes(c.value));
            document.getElementById('btnProductSave').innerText = "ìˆ˜ì • ì €ì¥";
            document.getElementById('btnProductClone').style.display = 'inline-block';
            document.getElementById('btnCancelEdit').style.display = 'inline-block';
            document.querySelector('.product-form').scrollIntoView({behavior:'smooth'});
        };
        window.cloneProduct = () => { editingProdId=null; document.getElementById('newProdCode').value += "_copy"; document.getElementById('btnProductSave').innerText="ìƒˆ ìƒí’ˆ ë“±ë¡"; alert("ë³µì œ ëª¨ë“œ"); };
        window.resetProductForm = () => {
            editingProdId = null;
            document.getElementById('newProdCode').value = ''; document.getElementById('newProdW').value = ''; document.getElementById('newProdH').value = ''; document.getElementById('newProdImg').value = ''; document.getElementById('prodPreview').style.display = 'none';
            document.getElementById('newProdName').value = ''; document.getElementById('newProdNameJP').value = ''; document.getElementById('newProdNameUS').value = '';
            document.getElementById('newProdPrice').value = ''; document.getElementById('newProdPriceJP').value = ''; document.getElementById('newProdPriceUS').value = '';
            document.querySelectorAll('input[name="prodAddon"]').forEach(c => c.checked = false);
            document.getElementById('btnProductSave').innerText = "ìƒí’ˆ ë“±ë¡"; document.getElementById('btnProductClone').style.display = 'none'; document.getElementById('btnCancelEdit').style.display = 'none';
        };
        window.previewProductImage = async (input) => { if(!input.files[0]) return; const file=input.files[0]; const reader=new FileReader(); reader.onload=(e)=>{document.getElementById('prodPreview').src=e.target.result; document.getElementById('prodPreview').style.display='block';}; reader.readAsDataURL(file); const btn=document.getElementById('btnProductSave'); btn.innerText="ì—…ë¡œë“œì¤‘..."; btn.disabled=true; try { const path=`products/${Date.now()}_${file.name}`; await sb.storage.from('products').upload(path, file); const {data}=sb.storage.from('products').getPublicUrl(path); document.getElementById('newProdImg').value=data.publicUrl; } catch(e){alert("ì—…ë¡œë“œì‹¤íŒ¨");} finally {btn.innerText="ìƒí’ˆ ë“±ë¡"; btn.disabled=false;} };
        window.deleteSystemData = async (t, id) => { if(confirm("ì‚­ì œ?")) { await sb.from(t).delete().eq('id',id); loadSystemDB(); }};
        function addDragListeners(row) { row.addEventListener('dragstart',()=>row.classList.add('dragging')); row.addEventListener('dragend',async()=>{row.classList.remove('dragging'); await saveSortOrder();}); const container=document.getElementById('prodTableBody'); container.addEventListener('dragover',e=>{e.preventDefault(); const after=getDragAfterElementY(container,e.clientY); const drag=document.querySelector('.draggable-row.dragging'); if(after==null) container.appendChild(drag); else container.insertBefore(drag,after);}); }
        function getDragAfterElementY(container,y) { return [...container.querySelectorAll('.draggable-row:not(.dragging)')].reduce((closest,child)=>{const box=child.getBoundingClientRect(); const offset=y-box.top-box.height/2; if(offset<0&&offset>closest.offset) return {offset:offset, element:child}; else return closest;},{offset:Number.NEGATIVE_INFINITY}).element; }
        async function saveSortOrder() { const updates=[]; document.querySelectorAll('#prodTableBody tr').forEach((r,i)=>updates.push(sb.from('admin_products').update({sort_order:i+1}).eq('id',r.dataset.id))); await Promise.all(updates); }
        window.loadStaffList = async () => { const {data}=await sb.from('admin_staff').select('*').order('created_at',{ascending:false}); const tbody=document.getElementById('staffListBody'); tbody.innerHTML=''; data?.forEach(s=>{ tbody.innerHTML+=`<tr><td><div class="color-dot" style="background:${s.color}"></div></td><td>${s.name}</td><td>${s.role}</td><td><button class="btn btn-danger btn-sm" onclick="deleteStaffDB(${s.id})">ì‚­ì œ</button></td></tr>`; }); };
        window.addStaffDB = async () => { const name=document.getElementById('staffName').value; const role=document.getElementById('staffRole').value; const color=document.getElementById('staffColor').value; if(!name) return; await sb.from('admin_staff').insert([{name,role,color}]); loadStaffList(); };
        window.deleteStaffDB = async (id) => { if(confirm("ì‚­ì œ?")) await sb.from('admin_staff').delete().eq('id',id); loadStaffList(); };

        window.loadFonts = async () => { 
            const tbody = document.getElementById('fontListBody'); 
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ë¡œë”© ì¤‘...</td></tr>';
            try { 
                const { data, error } = await sb.from('site_fonts').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                tbody.innerHTML = '';
                if (!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ë“±ë¡ëœ í°íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }
                data.forEach(f => {
                    const fontFace = new FontFace(f.font_family, `url(${f.file_url})`);
                    fontFace.load().then(loaded => document.fonts.add(loaded)).catch(e => console.warn(e));
                    let flag = ''; if(f.site_code === 'KR') flag = 'ğŸ‡°ğŸ‡·'; else if(f.site_code === 'JP') flag = 'ğŸ‡¯ğŸ‡µ'; else if(f.site_code === 'US') flag = 'ğŸ‡ºğŸ‡¸';
                    tbody.innerHTML += `<tr><td>${flag} ${f.site_code}</td><td>${f.font_name}<br><span style="font-size:11px; color:#888;">(${f.font_family})</span></td><td style="font-family:'${f.font_family}'; font-size:16px;">ë‹¤ëŒì¥ í—Œ ì³‡ë°”í€´ (Preview)</td><td><button class="btn btn-danger btn-sm" onclick="deleteFontDB(${f.id})">ì‚­ì œ</button></td></tr>`; 
                }); 
            } catch(e) { console.error(e); tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">ë¡œë“œ ì‹¤íŒ¨</td></tr>'; } 
        };

        window.uploadFont = async () => { 
            const site = document.getElementById('fontSite').value; 
            const name = document.getElementById('fontName').value; 
            const fam = document.getElementById('fontFamily').value; 
            const fileInput = document.getElementById('fontFile');
            const file = fileInput.files[0]; 
            if (!name || !fam || !file) return alert("í•„ìˆ˜ ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            const btn = document.querySelector('#sec-fonts .btn-primary');
            const oldText = btn.innerText; btn.innerText = "ì—…ë¡œë“œ ì¤‘..."; btn.disabled = true;
            try { 
                const timestamp = Date.now();
                const safeName = `${timestamp}_${Math.random().toString(36).substring(2,10)}.ttf`;
                const path = `${site}/${safeName}`; 
                const { data: uploadData, error: uploadErr } = await sb.storage.from('fonts').upload(path, file); 
                if(uploadErr) throw new Error(uploadErr.message);
                const { data: urlData } = sb.storage.from('fonts').getPublicUrl(path); 
                const { error: dbErr } = await sb.from('site_fonts').insert([{ site_code: site, font_name: name, font_family: fam, file_url: urlData.publicUrl }]);
                if (dbErr) throw new Error(dbErr.message);
                alert("âœ… í°íŠ¸ ë“±ë¡ ì™„ë£Œ!"); 
                document.getElementById('fontName').value = ''; document.getElementById('fontFamily').value = ''; fileInput.value = '';
                loadFonts(); 
            } catch(e) { alert("ì—ëŸ¬ ë°œìƒ: " + e.message); } finally { btn.innerText = oldText; btn.disabled = false; }
        };

        window.deleteFontDB = async (id) => { if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; try { const { error } = await sb.from('site_fonts').delete().eq('id', id); if(error) throw error; loadFonts(); } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); } };
        // [ìˆ˜ì •] íšŒì› ëª©ë¡ ì¡°íšŒ (ê²€ìƒ‰ ë° í†µê³„ í¬í•¨)
// [ìˆ˜ì •] íšŒì› ëª©ë¡ ì¡°íšŒ (ì˜ˆì¹˜ê¸ˆ ê´€ë¦¬ ë²„íŠ¼ í¬í•¨)
window.loadMembers = async () => { 
    const keyword = document.getElementById('memberSearchInput') ? document.getElementById('memberSearchInput').value.trim() : '';
    const tbody = document.getElementById('memberListBody'); 
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">ë¡œë”© ì¤‘...</td></tr>';
    
    let query = sb.from('profiles').select('*').order('created_at', {ascending:false});
    
    if(keyword) query = query.ilike('email', `%${keyword}%`);
    else query = query.limit(50);

    const {data: members, error} = await query;
    
    if(error) {
        alert("ë¡œë”© ì‹¤íŒ¨: " + error.message);
        return;
    }

    tbody.innerHTML = '';
    
    if(!members || members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }

    members.forEach(m => {
        const r = m.role || 'customer';
        const deposit = m.deposit || 0; // ì˜ˆì¹˜ê¸ˆ ì”ì•¡

        // ë“±ê¸‰ ì„ íƒ ë°•ìŠ¤
        const select = `
            <select onchange="updateMemberRole('${m.id}', this.value)" style="padding:4px; border:1px solid #cbd5e1; border-radius:4px;">
                <option value="customer" ${r==='customer'?'selected':''}>ì¼ë°˜</option>
                <option value="gold" ${r==='gold'?'selected':''}>ğŸ¥‡ ê³¨ë“œ</option>
                <option value="platinum" ${r==='platinum'?'selected':''}>ğŸ’ í”Œë˜í‹°ë„˜</option>
                <option value="franchise" ${r==='franchise'?'selected':''}>ğŸ¢ ê°€ë§¹ì </option>
                <option value="admin" ${r==='admin'?'selected':''}>ğŸ›  ê´€ë¦¬ì</option>
            </select>
        `;

        // â˜… [í•µì‹¬] ì˜ˆì¹˜ê¸ˆ ê´€ë¦¬ ë²„íŠ¼
        const walletBtn = `
            <button class="btn btn-outline btn-sm" onclick="openWalletModal('${m.id}', '${m.email}', ${deposit})">
                <i class="fa-solid fa-coins" style="color:#eab308;"></i> â‚©${deposit.toLocaleString()} ê´€ë¦¬
            </button>
        `;

        tbody.innerHTML += `
            <tr>
                <td>${new Date(m.created_at).toLocaleDateString()}</td>
                <td>
                    <div style="font-weight:bold;">${m.email}</div>
                    <div style="font-size:12px; color:#888;">${m.full_name || '-'}</div>
                </td>
                <td>
                    <span style="color:#6366f1;">${(m.total_spend || 0).toLocaleString()}ì›</span> / 
                    <span style="color:#059669;">${m.logo_count || 0}ê°œ</span>
                </td>
                <td>${walletBtn}</td> <td><span class="badge" style="background:#f1f5f9;">${r.toUpperCase()}</span></td>
                <td>${select}</td>
            </tr>
        `;
    });
};

// [ìˆ˜ì •] íšŒì› ë“±ê¸‰ ë³€ê²½ í•¨ìˆ˜
window.updateMemberRole = async (id, newRole) => { 
    if(!confirm(`í•´ë‹¹ íšŒì›ì˜ ë“±ê¸‰ì„ '${newRole}'(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { 
        loadMembers(); // ì·¨ì†Œ ì‹œ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¼
        return; 
    } 
    
    const { error } = await sb.from('profiles').update({ role: newRole }).eq('id', id); 
    
    if(error) alert("ë³€ê²½ ì‹¤íŒ¨: " + error.message); 
    else alert("âœ… ë“±ê¸‰ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); 
};
        function initTemplateListeners() { const fThumb = document.getElementById('fileThumb'); if(fThumb) fThumb.addEventListener('change', e=>{const f=e.target.files[0]; const r=new FileReader(); r.onload=ev=>{document.getElementById('previewThumb').src=ev.target.result; document.getElementById('previewThumb').style.display='block';}; r.readAsDataURL(f);}); const fData = document.getElementById('fileData'); if(fData) fData.addEventListener('change', e=>{const f=e.target.files[0]; const r=new FileReader(); r.onload=ev=>{if(f.name.endsWith('.svg')){document.getElementById('dataStatus').style.display='block';}}; r.readAsDataURL(f);}); }
        
        window.toggleFileInputs = () => { 
            const cat = document.getElementById('tplCategory').value;
            const groupData = document.getElementById('groupDataFile');
            const needsVector = ['vector', 'transparent-graphic', 'logo', 'graphic'].includes(cat);
            if (needsVector) { groupData.style.display = 'block'; } else { groupData.style.display = 'none'; }
        };
        
        window.loadProductKeys = async () => {
            const regSelect = document.getElementById('tplProductKey'); 
            const filterSelect = document.getElementById('filterTplProduct'); 
            if(!regSelect || !filterSelect) return;
            regSelect.innerHTML = '<option value="custom">ê³µí†µ / ì§€ì •ì•ˆí•¨</option>';
            filterSelect.innerHTML = `<option value="all">ğŸ“¦ ì œí’ˆì—°ê²°: ì „ì²´ ë³´ê¸°</option><option value="custom">ğŸ”¹ ê³µí†µ í…œí”Œë¦¿ë§Œ ë³´ê¸°</option><option value="assigned">ğŸ”¸ ì œí’ˆ ì „ìš©ë§Œ ë³´ê¸°</option><optgroup label="--- ê°œë³„ ì œí’ˆ ì„ íƒ ---"></optgroup>`;
            const { data: prods } = await sb.from('admin_products').select('code, name').order('name');
            if(prods) { prods.forEach(p => { const optionHtml = `<option value="${p.code}">${p.name} (${p.code})</option>`; regSelect.innerHTML += optionHtml; filterSelect.innerHTML += optionHtml; }); }
        };

        // [ìˆ˜ì •ë¨] í…œí”Œë¦¿ ëª©ë¡ ë¡œë“œ (ê²€ìƒ‰ ê¸°ëŠ¥ + ì²´í¬ë°•ìŠ¤ ì¶”ê°€)
        window.loadTemplates = async () => { 
            const grid = document.getElementById('tplGrid'); 
            const catFilter = document.getElementById('filterTplCat').value; 
            const prodFilter = document.getElementById('filterTplProduct').value;
            const searchKeyword = document.getElementById('tplSearchInput').value.trim(); // ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°

            if(!grid) return; 
            grid.innerHTML = '<div style="padding:20px; text-align:center; grid-column:1/-1;">ë¡œë”© ì¤‘...</div>'; 
            
            let query = sb.from('library').select('id, category, thumb_url, tags, product_key').order('id', {ascending:false}).limit(100); 
            
            // í•„í„° ì ìš©
            if (catFilter !== 'all') { query = query.eq('category', catFilter); } 
            
            if (prodFilter === 'custom') { query = query.or('product_key.eq.custom,product_key.is.null'); } 
            else if (prodFilter === 'assigned') { query = query.neq('product_key', 'custom').not('product_key', 'is', null); } 
            else if (prodFilter !== 'all') { query = query.eq('product_key', prodFilter); }

            // [ì¶”ê°€] ê²€ìƒ‰ì–´ ì ìš© (íƒœê·¸ ì»¬ëŸ¼ ê²€ìƒ‰)
            if (searchKeyword) {
                // ìˆ«ìì¸ ê²½ìš° ID ê²€ìƒ‰, ë¬¸ìë©´ íƒœê·¸ ê²€ìƒ‰
                if (!isNaN(searchKeyword)) {
                    query = query.eq('id', searchKeyword);
                } else {
                    query = query.ilike('tags', `%${searchKeyword}%`);
                }
            }

            const { data, error } = await query; 
            
            grid.innerHTML = ''; 
            if (error) { grid.innerHTML = '<div style="padding:20px; color:red; grid-column:1/-1;">ì—ëŸ¬: ' + error.message + '</div>'; return; } 
            
            if (data && data.length > 0) { 
                data.forEach(t => { 
                    const tagText = t.tags ? t.tags : '-'; 
                    const pKey = (t.product_key && t.product_key !== 'custom') ? t.product_key : 'ê³µí†µ'; 
                    const isCustom = pKey === 'ê³µí†µ'; 
                    const badgeStyle = isCustom ? "background:#f1f5f9; color:#64748b;" : "background:#eff6ff; color:#2563eb; border:1px solid #bfdbfe;"; 
                    
                    // [ì¶”ê°€] ì²´í¬ë°•ìŠ¤ UI ì‚½ì…
                    grid.innerHTML += `
                    <div class="tpl-card">
                        <div style="position:absolute; top:10px; right:10px; z-index:10;">
                            <input type="checkbox" class="tpl-chk" value="${t.id}" style="width:18px; height:18px; cursor:pointer;">
                        </div>
                        <img src="${t.thumb_url}" class="tpl-thumb" loading="lazy" style="cursor:pointer;" onclick="window.open('${t.thumb_url}')">
                        <div class="tpl-info">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <span class="tpl-badge" style="font-size:10px;">${t.category}</span>
                                <span style="font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; ${badgeStyle}">${pKey}</span>
                            </div>
                            <div style="font-size:12px; font-weight:bold; color:#334155; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${tagText}">${tagText}</div>
                            <button class="tpl-del-btn" onclick="deleteTemplate(${t.id})">ê°œë³„ ì‚­ì œ</button>
                        </div>
                    </div>`; 
                }); 
            } else { 
                grid.innerHTML = '<div style="padding:40px; color:#999; text-align:center; width:100%; grid-column:1/-1;">ì¡°ê±´ì— ë§ëŠ” í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; 
            } 
        };

        // [ì‹ ê·œ] í…œí”Œë¦¿ ì „ì²´ ì„ íƒ/í•´ì œ
        window.toggleAllTemplates = (source) => {
            document.querySelectorAll('.tpl-chk').forEach(chk => chk.checked = source.checked);
        };

        // [ì‹ ê·œ] ì„ íƒëœ í…œí”Œë¦¿ ì¼ê´„ ì‚­ì œ
        window.deleteSelectedTemplates = async () => {
            const checks = document.querySelectorAll('.tpl-chk:checked');
            if (checks.length === 0) return alert("ì‚­ì œí•  í…œí”Œë¦¿ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            
            if (!confirm(`ì„ íƒí•œ ${checks.length}ê°œì˜ ì´ë¯¸ì§€ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)`)) return;

            const ids = Array.from(checks).map(c => c.value);
            const btn = document.querySelector('button[onclick="deleteSelectedTemplates()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ì‚­ì œ ì¤‘...';
            btn.disabled = true;

            try {
                // Supabaseì—ì„œ ì¼ê´„ ì‚­ì œ
                const { error } = await sb.from('library').delete().in('id', ids);
                if (error) throw error;
                
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadTemplates(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (e) {
                alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
        
        window.uploadTemplate = async () => { 
            const cat = document.getElementById('tplCategory').value; const tags = document.getElementById('tplTags').value; const prodKey = document.getElementById('tplProductKey').value; 
            const thumbFile = document.getElementById('fileThumb').files[0]; const dataFile = document.getElementById('fileData').files[0]; 
            if (!thumbFile) return alert("ì¸ë„¤ì¼ ì´ë¯¸ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."); 
            const btn = document.querySelector('#sec-templates .btn-primary'); const originalText = btn.innerText; btn.innerText = "ì—…ë¡œë“œ ì¤‘..."; btn.disabled = true; 
            try { 
                const timestamp = Date.now(); const thumbPath = `thumbs/${timestamp}_${thumbFile.name}`; 
                const { error: thumbErr } = await sb.storage.from('design').upload(thumbPath, thumbFile); if(thumbErr) throw thumbErr; 
                const { data: thumbUrlData } = sb.storage.from('design').getPublicUrl(thumbPath); const thumbUrl = thumbUrlData.publicUrl; 
                let dataUrl = thumbUrl; 
                if ((cat === 'transparent-graphic' || cat === 'vector') && dataFile) { const dataPath = `assets/${timestamp}_${dataFile.name}`; const { error: dataErr } = await sb.storage.from('design').upload(dataPath, dataFile); if(dataErr) throw dataErr; const { data: dataUrlData } = sb.storage.from('design').getPublicUrl(dataPath); dataUrl = dataUrlData.publicUrl; } 
                const { error: dbErr } = await sb.from('library').insert({ category: cat, tags: tags || 'ê´€ë¦¬ìë“±ë¡', thumb_url: thumbUrl, data_url: dataUrl, width: 1000, height: 1000, product_key: prodKey }); if (dbErr) throw dbErr; 
                alert("âœ… í…œí”Œë¦¿ ë“±ë¡ ì„±ê³µ!"); document.getElementById('tplTags').value = ''; document.getElementById('fileThumb').value = ''; document.getElementById('fileData').value = ''; document.getElementById('previewThumb').style.display = 'none'; document.getElementById('dataStatus').style.display = 'none'; loadTemplates(); 
            } catch(e) { alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message); } finally { btn.innerText = originalText; btn.disabled = false; } 
        };
        window.deleteTemplate = async (id) => { if(confirm("ì‚­ì œ?")) await sb.from('library').delete().eq('id',id); loadTemplates(); };

        function getDeliveryTimeOptions(selectedTime) { let html = '<option value="">ì‹œê°„ ë¯¸ì •</option>'; for (let i = 8; i <= 24; i += 2) { let timeStr = (i < 10 ? '0' + i : i) + ":00"; let isSelected = selectedTime === timeStr ? 'selected' : ''; html += `<option value="${timeStr}" ${isSelected}>${timeStr}</option>`; } return html; }

        window.loadDailyTasks = async () => {
            const dateInput = document.getElementById('taskDate'); if (!dateInput.value) { const today = new Date().toISOString().split('T')[0]; dateInput.value = today; }
            const targetDate = dateInput.value; const driverFilterId = document.getElementById('filterTaskDriver').value;
            showLoading(true); const tbody = document.getElementById('taskListBody'); tbody.innerHTML = '';
            if (staffList.length === 0) await fetchStaffForOrders();
            const filterSelect = document.getElementById('filterTaskDriver'); if(filterSelect.options.length === 1) { staffList.filter(s => s.role === 'driver').forEach(s => { filterSelect.innerHTML += `<option value="${s.id}">${s.name} ê¸°ì‚¬ë‹˜</option>`; }); }
            let { data: orders, error } = await sb.from('orders').select('*').eq('delivery_target_date', targetDate);
            if (error) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px;">ë¡œë“œ ì—ëŸ¬: ${error.message}</td></tr>`; showLoading(false); return; }
            if (!orders || orders.length === 0) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:#999;">${targetDate} ë°°ì†¡ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; showLoading(false); return; }
            if(driverFilterId !== 'all') { orders = orders.filter(o => o.staff_driver_id == driverFilterId); }
            if(orders.length === 0) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:#999;">í•´ë‹¹ ê¸°ì‚¬ë‹˜ì˜ ë°°ì†¡ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; showLoading(false); return; }
            orders.sort((a, b) => { const driverA = staffList.find(s=>s.id == a.staff_driver_id)?.name || 'zzz'; const driverB = staffList.find(s=>s.id == b.staff_driver_id)?.name || 'zzz'; if (driverA !== driverB) return driverA.localeCompare(driverB); const timeA = a.delivery_time || "99:99"; const timeB = b.delivery_time || "99:99"; return timeA.localeCompare(timeB); });
            orders.forEach(o => { const isDone = (o.status === 'ë°°ì†¡ì™„ë£Œ'); const dotColor = isDone ? '#22c55e' : '#cbd5e1'; const dotShadow = isDone ? '0 0 5px #4ade80' : 'none'; const statusBadge = isDone ? `<span class="badge" style="background:#dcfce7; color:#15803d; border:1px solid #bbf7d0; white-space:nowrap;">ë°°ì†¡ì™„ë£Œ</span>` : `<span class="badge" style="background:#f1f5f9; color:#64748b; white-space:nowrap;">${o.status}</span>`; const rowStyle = isDone ? 'background-color: #f0fdf4;' : ''; const textStyle = isDone ? 'opacity: 0.6;' : ''; let fileLinks = ''; if(o.files && Array.isArray(o.files)) { o.files.forEach(f => { fileLinks += `<a href="${f.url}" target="_blank" class="btn-file" style="margin-right:4px;">ğŸ“„ ${f.name}</a>`; }); } else { fileLinks = '<span style="color:#ccc;">íŒŒì¼ ì—†ìŒ</span>'; } let driverOpts = `<option value="">ë¯¸ì§€ì •</option>`; staffList.filter(s => s.role === 'driver').forEach(s => { const selected = o.staff_driver_id == s.id ? 'selected' : ''; driverOpts += `<option value="${s.id}" ${selected}>${s.name}</option>`; }); const timeOpts = getDeliveryTimeOptions(o.delivery_time); const tr = document.createElement('tr'); tr.style.cssText = rowStyle; tr.innerHTML = `<td style="text-align:center;">${statusBadge}</td><td style="${textStyle}"><div style="font-weight:bold; font-size:15px;">${o.manager_name}</div><div style="font-size:13px; color:#6366f1;">${o.phone}</div><div style="font-size:12px; color:#666; margin-top:2px;">${o.address}</div></td><td style="${textStyle}"><div style="display:flex; flex-wrap:wrap;">${fileLinks}</div></td><td><select class="input-text" onchange="updateTaskDB('${o.id}', 'staff_driver_id', this.value)" style="width:100%; ${isDone ? 'background:transparent; border:none; font-weight:bold; appearance:none;' : ''}" ${isDone?'disabled':''}>${driverOpts}</select></td><td><div style="display:flex; align-items:center; gap:8px;"><select class="input-text" onchange="updateTaskDB('${o.id}', 'delivery_time', this.value)" style="flex:1; font-weight:bold; color:#0f172a; ${isDone ? 'background:transparent; border:none; appearance:none;' : ''}" ${isDone?'disabled':''}>${timeOpts}</select><div title="${isDone ? 'ë°°ì†¡ ì™„ë£Œë¨' : 'ë°°ì†¡ ì¤‘'}" style="width:18px; height:18px; border-radius:50%; background:${dotColor}; box-shadow:${dotShadow}; flex-shrink:0; cursor:default; border:2px solid white; outline:1px solid ${isDone?'#22c55e':'#cbd5e1'};"></div></div></td>`; tbody.appendChild(tr); }); showLoading(false);
        };
        window.updateTaskDB = async (orderId, field, value) => { const valToSave = value === "" ? null : value; const { error } = await sb.from('orders').update({ [field]: valToSave }).eq('id', orderId); if (error) { alert("ì €ì¥ ì‹¤íŒ¨: " + error.message); } };
        window.addEventListener('DOMContentLoaded', async () => { 
            // 1. í™”ë©´ ê¹œë¹¡ì„ ë°©ì§€ë¥¼ ìœ„í•´ ì¼ë‹¨ ìˆ¨ê¹€
            document.body.style.visibility = 'hidden';
            
            await initConfig(); 
            
            // 2. ë³´ì•ˆ ì²´í¬ ì‹¤í–‰ (í†µê³¼ ëª»í•˜ë©´ ì—¬ê¸°ì„œ ë©ˆì¶”ê³  ì«“ê²¨ë‚¨)
            const isAdmin = await checkAdminAccess();
            if (!isAdmin) return;

            // 3. í†µê³¼ëœ ê²½ìš°ì—ë§Œ ë°ì´í„° ë¡œë“œ ì‹œì‘
            loadOrders(); 
            initTemplateListeners(); 
            loadCategories(); 
            loadFonts(); 
        });

        // [ì‹ ê·œ] ì¶œê¸ˆ ëª©ë¡ ë¡œë“œ
        // [ìˆ˜ì •ë¨] ì¶œê¸ˆ ëª©ë¡ ë¡œë“œ (ì˜¤ë¥˜ ë°©ì§€ ë²„ì „)
        // [ìˆ˜ì •ëœ admin.htmlìš© ì¶œê¸ˆ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜]
window.loadWithdrawals = async () => {
    const tbody = document.getElementById('withdrawalListBody');
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">ë¡œë”© ì¤‘...</td></tr>';
    
    try {
        const { data: requests, error } = await sb.from('withdrawal_requests')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!requests || requests.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">ì¶œê¸ˆ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        const userIds = [...new Set(requests.map(r => r.user_id))];
        const { data: users } = await sb.from('profiles').select('id, email, full_name').in('id', userIds);
        const userMap = {};
        if (users) users.forEach(u => userMap[u.id] = u);

        tbody.innerHTML = '';
        requests.forEach(r => {
            const user = userMap[r.user_id];
            const displayUser = user ? `${user.email}<br><span style='font-size:11px; color:#888;'>${user.full_name||''}</span>` : r.user_id;
            
            // ì„¸ê¸ˆê³„ì‚°ì„œ ë§í¬
            const taxLink = r.tax_invoice_url 
                ? `<a href="${r.tax_invoice_url}" target="_blank" class="btn btn-outline btn-sm" style="margin-top:2px;">ğŸ“„ ì„¸ê¸ˆê³„ì‚°ì„œ</a>` 
                : '<span style="color:#aaa; font-size:11px;">ë¯¸ì²¨ë¶€</span>';

            const statusBadge = r.status === 'pending' 
                ? '<span class="badge" style="background:#fff7ed; color:#c2410c; border:1px solid #ffedd5;">ëŒ€ê¸°ì¤‘</span>'
                : '<span class="badge" style="background:#dcfce7; color:#15803d; border:1px solid #bbf7d0;">ì™„ë£Œë¨</span>';
            
            const actionBtn = r.status === 'pending'
                ? `<button class="btn btn-primary btn-sm" onclick="approveWithdrawal(${r.id})">ì…ê¸ˆí™•ì¸ ì²˜ë¦¬</button>`
                : `<span style="color:#cbd5e1; font-size:12px;">ì²˜ë¦¬ì™„ë£Œ</span>`;

            // â˜… ì¤‘ìš”: bank_nameì— í†µí•©ëœ ì •ë³´ë¥¼ ë³´ì—¬ì£¼ë„ë¡ ìˆ˜ì •
            tbody.innerHTML += `
                <tr>
                    <td>${new Date(r.created_at).toLocaleString()}</td>
                    <td>${displayUser}</td>
                    <td style="font-weight:bold; color:#d97706;">${r.amount.toLocaleString()}ì›</td>
                    <td>
                        <div style="font-weight:bold; font-size:13px;">${r.bank_name}</div>
                        ${taxLink}
                    </td>
                    <td>${statusBadge}</td>
                    <td>${actionBtn}</td>
                </tr>
            `;
        });

    } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${e.message}</td></tr>`;
    }
};
// [ì‹ ê·œ] ê´€ë¦¬ì ì¶œê¸ˆ ìŠ¹ì¸ (ì…ê¸ˆí™•ì¸ ì²˜ë¦¬) í•¨ìˆ˜
window.approveWithdrawal = async (requestId) => {
    if(!confirm("í•´ë‹¹ ê±´ì„ 'ì…ê¸ˆì™„ë£Œ' ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {
        // 1. ìƒíƒœ ì—…ë°ì´íŠ¸ (pending -> approved)
        const { error } = await sb.from('withdrawal_requests')
            .update({ 
                status: 'approved',
                processed_at: new Date().toISOString()
            })
            .eq('id', requestId);

        if(error) throw error;

        alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadWithdrawals(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨

    } catch(e) {
        alert("ì²˜ë¦¬ ì‹¤íŒ¨: " + e.message);
    }
};

// [ì‹ ê·œ] ë³¸ì‚¬ ì§ì ‘ ì ‘ìˆ˜ í•¨ìˆ˜ (íŒŒíŠ¸ë„ˆìŠ¤ í™”ë©´ì—ì„œ ì ê¸ˆ ì²˜ë¦¬ë¨)
    window.claimOrderAdmin = async (orderId) => {
        if(!confirm("ì´ ì£¼ë¬¸ì„ ë³¸ì‚¬(HQ)ì—ì„œ ì§ì ‘ ì œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\níŒŒíŠ¸ë„ˆìŠ¤ ë¦¬ìŠ¤íŠ¸ì—ì„œëŠ” 'ë³¸ì‚¬ ì œì‘ì¤‘'ìœ¼ë¡œ í‘œì‹œë˜ë©° ì„ íƒì´ ë¶ˆê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.")) return;

        try {
            const { data: { user } } = await sb.auth.getUser();
            if(!user) return alert("ê´€ë¦¬ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            // ë³¸ì‚¬ ê´€ë¦¬ì IDë¡œ ì—…ë°ì´íŠ¸ -> íŒŒíŠ¸ë„ˆìŠ¤ í™”ë©´ì—ì„œ 'Lock' ë¨
            const { error } = await sb.from('orders').update({
                franchise_id: user.id, 
                status: 'ì œì‘ì¤€ë¹„'      
            }).eq('id', orderId);

            if(error) throw error;

            alert("âœ… ë³¸ì‚¬ ì œì‘ê±´ìœ¼ë¡œ ì§€ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadOrders(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } catch(e) {
            alert("ì²˜ë¦¬ ì‹¤íŒ¨: " + e.message);
        }
    };

    // [ì‹ ê·œ] ì ‘ìˆ˜ ì·¨ì†Œ í•¨ìˆ˜ (ì´ˆê¸°í™”)
    window.cancelFranchiseClaim = async (orderId) => {
        if(!confirm("í˜„ì¬ ë‹´ë‹¹ì(íŒŒíŠ¸ë„ˆ/ë³¸ì‚¬) ì§€ì •ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në‹¤ì‹œ 'ëŒ€ê¸°ì¤‘' ìƒíƒœê°€ ë˜ì–´ íŒŒíŠ¸ë„ˆë“¤ì´ ë³¼ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.")) return;

        const { error } = await sb.from('orders').update({
            franchise_id: null,
            status: 'ì ‘ìˆ˜ëŒ€ê¸°'
        }).eq('id', orderId);

        if(error) alert("í•´ì œ ì‹¤íŒ¨: " + error.message);
        else loadOrders();
    };
    </script>

</body>
</html>