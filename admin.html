<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chameleon Global Admin + Bankda</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Pretendard', sans-serif; background: #f1f5f9; color: #334155; overflow: hidden; }
        
        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 260px; background: #1e293b; color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; }
        .sidebar-header { padding: 25px 20px; font-weight: 800; font-size: 20px; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 10px; color: #818cf8; }
        .nav-menu { list-style: none; padding: 20px 10px; margin: 0; display: flex; flex-direction: column; gap: 5px; }
        .nav-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 15px; color: #cbd5e1; }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: #6366f1; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .nav-label { font-size: 11px; color: #64748b; padding: 0 15px; margin-top: 15px; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; }
        
        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 60px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .page-title { font-size: 18px; font-weight: 700; color: #0f172a; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 30px; }
        
        /* ì„¹ì…˜ ë° ì¹´ë“œ ë ˆì´ì•„ì›ƒ */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .product-layout { display: grid; grid-template-columns: 380px 1fr; gap: 20px; align-items: start; }
        
        /* í¼ ìš”ì†Œ */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 5px; }
        .input-text { padding: 10px 15px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; font-size: 14px; box-sizing: border-box; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        
        /* í…Œì´ë¸” */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-weight: 600; font-size: 13px; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #334155; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }
        
        /* ë²„íŠ¼ */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-sky { background: #0ea5e9; color: white; }
        .btn-sky:hover { background: #0284c7; }
        .btn-vip { background: #d97706; color: white; } 
        .btn-danger { background: #fee2e2; color: #ef4444; }
        .btn-success { background: #22c55e; color: white; } 
        .btn-outline { background: #fff; border: 1px solid #cbd5e1; color: #334155; }
        .btn-sm { padding: 4px 8px; font-size: 11px; }
        .btn-file { background: #fff; color: #334155; border: 1px solid #cbd5e1; padding: 6px 10px; font-size: 12px; border-radius: 4px; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; cursor: pointer; margin-right: 5px; margin-bottom: 3px; max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .btn-file:hover { border-color: #6366f1; color: #6366f1; }
        
        /* ë±ƒì§€ */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .badge.draggable { cursor: grab; }
        .badge-site { font-size: 11px; padding: 3px 6px; border-radius: 4px; margin-right: 4px; font-weight: 800; border: 1px solid #e2e8f0; background: #fff; display: inline-block; min-width: 30px; text-align: center; }
        .badge-site.kr { color: #cf2e2e; border-color: #fecaca; background: #fef2f2; }
        .badge-site.jp { color: #ea580c; border-color: #ffedd5; background: #fff7ed; }
        .badge-site.us { color: #2563eb; border-color: #dbeafe; background: #eff6ff; }

        /* íŒŒì¼ ì—…ë¡œë“œ & í…œí”Œë¦¿ ì¹´ë“œ */
        .file-drop-zone { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; position: relative; background: #f8fafc; color: #64748b; margin-bottom: 10px; }
        .file-drop-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .preview-img { max-width: 100%; height: 150px; object-fit: contain; border-radius: 8px; border: 1px solid #eee; display: none; margin-top: 10px; background: white; }
        .tpl-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .tpl-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; transition: 0.2s; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tpl-thumb { width: 100%; height: 150px; object-fit: contain; background: #f8fafc; border-bottom: 1px solid #f1f5f9; padding: 10px; }
        .tpl-info { padding: 12px; }
        .tpl-del-btn { width: 100%; margin-top: 8px; background: #fee2e2; color: #ef4444; font-size: 12px; padding: 6px; border-radius: 6px; border:none; cursor:pointer; font-weight: 600; }
        
        /* ì˜µì…˜ */
        .addon-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; max-height: 150px; overflow-y: auto; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; }
        .addon-check-item { display: flex; align-items: center; gap: 5px; font-size: 13px; background: white; padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }

        /* ê²°ì œ ë±ƒì§€ */
        .pay-badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-bottom: 4px; }
        .pay-done { background: #fee2e2; color: #ef4444; border: 1px solid #fca5a5; }
        .pay-wait { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.7); z-index: 99999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #6366f1; border-radius: 50%; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .color-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; vertical-align: middle; border: 1px solid rgba(0,0,0,0.1); }
        .staff-select { padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px; width: 100%; margin-bottom: 4px; background: white; cursor: pointer; }

        /* í†µê³„ */
        .stat-card-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 20px; }
        .stat-icon { width: 60px; height: 60px; border-radius: 12px; background: #eff6ff; color: #2563eb; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .stat-info div:first-child { font-size: 14px; color: #64748b; font-weight: 600; margin-bottom: 5px; }
        .stat-info div:last-child { font-size: 24px; font-weight: 800; color: #0f172a; }
        .progress-bar-bg { width: 100%; height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-bar-fill { height: 100%; border-radius: 4px; transition: 0.5s; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-box { background: white; border-radius: 12px; padding: 25px; width: 500px; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 15px; }
        .modal-header { font-size: 18px; font-weight: 800; border-bottom: 1px solid #eee; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .file-list-area { max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; background: #f8fafc; }
        .file-item-row { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px 12px; margin-bottom: 6px; border: 1px solid #eee; border-radius: 6px; font-size: 13px; }
        .file-item-row:last-child { margin-bottom: 0; }
    </style>
</head>
<body>
    <div id="loading"><div class="spinner"></div></div>
    
    <div id="fileManagerModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span>ğŸ“‚ ì£¼ë¬¸ íŒŒì¼ ê´€ë¦¬</span>
                <button class="btn btn-outline btn-sm" onclick="closeFileModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="fileMgrList" class="file-list-area">
                </div>
            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border: 1px dashed #bae6fd;">
                <div style="font-size: 12px; font-weight: bold; color: #0369a1; margin-bottom: 8px;">â• ìƒˆ íŒŒì¼ ì¶”ê°€</div>
                <div style="display: flex; gap: 8px;">
                    <input type="file" id="fileMgrInput" class="input-text" style="padding: 6px;">
                    <button class="btn btn-primary" onclick="uploadFileToOrder()">ì—…ë¡œë“œ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header"><i class="fa-solid fa-earth-americas"></i> Global Admin</div>
        <ul class="nav-menu">
            <div class="nav-label">Business</div>
            <li class="nav-item active" onclick="showSection('sec-vip', this)" style="background: linear-gradient(90deg, #312e81 0%, #1e1b4b 100%); border: 1px solid #4338ca;">
    <i class="fa-solid fa-crown" style="color: #fbbf24;"></i> <span style="font-weight: bold; color: #fff;">VIP ëŒ€ëŸ‰ ì£¼ë¬¸</span>
</li>
<li class="nav-item" onclick="showSection('sec-orders', this)"><i class="fa-solid fa-cart-shopping"></i> í†µí•© ì£¼ë¬¸ ê´€ë¦¬</li>
            <li class="nav-item" onclick="showSection('sec-bankda', this)"><i class="fa-solid fa-won-sign"></i> ğŸ’° ë±…í¬ë‹¤ ì…ê¸ˆë‚´ì—­</li>
            <li class="nav-item" onclick="showSection('sec-stats', this)"><i class="fa-solid fa-chart-line"></i> ë§¤ì¶œ & í†µê³„</li>
            <li class="nav-item" onclick="showSection('sec-tasks', this)"><i class="fa-solid fa-calendar-check"></i> ì˜¤ëŠ˜ í• ì¼ (ë°°ì†¡ê´€ë¦¬)</li>

            <li class="nav-item" onclick="showSection('sec-withdrawals', this)">
                <i class="fa-solid fa-hand-holding-dollar"></i> ì¶œê¸ˆ ìš”ì²­ ê´€ë¦¬
            </li>
            <li class="nav-item" onclick="showSection('sec-partner-apps', this)">
    <i class="fa-solid fa-store"></i> ê°€ë§¹ì  ì‹ ì²­ ê´€ë¦¬ <span id="partnerPendingCount" class="badge" style="background:#ef4444; color:white; font-size:10px; display:none;">N</span>
</li>
            <li class="nav-item" onclick="showSection('sec-accounting', this)">
                <i class="fa-solid fa-calculator"></i> ğŸ“Š ê²½ë¦¬ê³¼ ì „ìš© (ê²°ì‚°)
            </li>
            <div class="nav-label">Product & Stock</div>
            <li class="nav-item" onclick="showSection('sec-products', this)"><i class="fa-solid fa-tags"></i> ìƒí’ˆ & ì˜µì…˜</li>
            
            <div class="nav-label">Management</div>
            <li class="nav-item" onclick="showSection('sec-staff', this)"><i class="fa-solid fa-id-card"></i> ìŠ¤íƒœí”„ ê´€ë¦¬</li>
            <li class="nav-item" onclick="showSection('sec-members', this)"><i class="fa-solid fa-users"></i> íšŒì› ê´€ë¦¬</li>

            <div class="nav-label">Assets</div>
            <li class="nav-item" onclick="showSection('sec-templates', this)"><i class="fa-solid fa-palette"></i> í…œí”Œë¦¿ & ë¡œê³ </li>
            <li class="nav-item" onclick="showSection('sec-fonts', this)"><i class="fa-solid fa-font"></i> í°íŠ¸(ì„œì²´) ê´€ë¦¬</li>
        </ul>
        <div style="margin-top: auto; padding: 20px;">
            <button class="btn btn-danger" style="width: 100%;" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="page-title">í†µí•© ì£¼ë¬¸ ê´€ë¦¬</div>
            <div style="font-size: 14px; color: #64748b;">Global Admin Connected ğŸŸ¢</div>
        </div>

        <div class="content-scroll">
            <div id="sec-vip" class="section active">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
                        <h3 style="margin:0; display:flex; align-items:center; gap:10px; color: #312e81;">
                            <i class="fa-solid fa-crown" style="color:#fbbf24;"></i> VIP íŒŒì¼ ì ‘ìˆ˜ ë‚´ì—­
                        </h3>
                        <div>
                            <button class="btn btn-danger" onclick="deleteSelectedVipOrders()">ì„ íƒ ì‚­ì œ</button>
                            <button class="btn btn-outline" onclick="loadVipOrders()"><i class="fa-solid fa-rotate"></i> ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th width="30"><input type="checkbox" onchange="toggleVipChecks(this)"></th>
                                <th width="120">ì ‘ìˆ˜ì¼ì‹œ</th>
                                <th width="80">ë‹´ë‹¹</th>
                                <th width="100">ê³ ê°ëª…</th>
                                <th width="130">ì—°ë½ì²˜</th>
                                <th>ë©”ëª¨ (ìš”ì²­ì‚¬í•­)</th>
                                <th width="200">ì²¨ë¶€íŒŒì¼ (ë‹¤ìš´ë¡œë“œ)</th>
                                <th width="80">ìƒíƒœ</th>
                                <th width="80">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="vipOrderListBody">
                            <tr><td colspan="8" style="text-align:center; padding:30px;">ë¡œë”© ì¤‘...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="sec-orders" class="section">
                <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px;">
        <div style="display:flex; gap:5px;">
            <button class="btn btn-primary" id="btnFilterNew" onclick="filterOrders('ì ‘ìˆ˜ë¨', this)">ğŸ“Œ ì‹ ê·œ ì ‘ìˆ˜</button>
            <button class="btn btn-outline" id="btnFilterKnife" onclick="filterOrders('ì¹¼ì„ ì‘ì—…', this)">âœ‚ï¸ ì¹¼ì„ /ì œì‘ì‘ì—…</button>
            <button class="btn btn-outline" id="btnFilterDone" onclick="filterOrders('ì™„ë£Œë¨', this)">âœ… ì™„ë£Œ</button>
        </div>
        
        <div style="display:flex; gap:5px; align-items:center; background:#f0fdf4; padding:5px 10px; border-radius:8px; border:1px solid #bbf7d0;">
            <span style="font-size:12px; font-weight:bold; color:#166534;">ğŸ“Š ë§¤ì¶œì •ì‚° ì—‘ì…€:</span>
            <input type="month" id="excelMonth" class="input-text" style="width:130px; height:32px; font-size:12px;">
            <button class="btn btn-success btn-sm" onclick="downloadMonthlyExcel()">
                <i class="fa-solid fa-file-excel"></i> ë‹¤ìš´ë¡œë“œ
            </button>
        </div>

        <div style="display:flex; gap:5px; align-items:center;">
            <div id="action-buttons" style="display:flex; gap:5px; margin-right: 15px; border-right: 1px solid #ddd; padding-right: 15px;"></div>

<div style="display:flex; gap:5px; margin-right:10px;">
    <input type="text" id="orderSearchInput" class="input-text" placeholder="ê³ ê°ëª…/ì—°ë½ì²˜ ê²€ìƒ‰" style="width:150px;" onkeyup="if(event.key=='Enter') loadOrders()">
</div>

<div style="display:flex; align-items:center; gap:5px; margin-right:10px; background:#f0f9ff; padding:5px 10px; border-radius:6px; border:1px solid #bae6fd;">
    <span style="font-size:12px; font-weight:bold; color:#0369a1;">ğŸšš ë°°ì†¡ì¼:</span>
    <input type="date" id="filterDeliveryDate" class="input-text" style="width:120px; height:32px; font-size:12px; padding:0 5px;" onchange="loadOrders()">
    <button class="btn btn-outline btn-sm" onclick="document.getElementById('filterDeliveryDate').value=''; loadOrders();" title="ë‚ ì§œ ì´ˆê¸°í™”">â†º</button>
</div>

<select id="filterSite" class="input-text" style="width:130px; font-weight:bold;" onchange="loadOrders()">
                <option value="all">ğŸŒ ì „ì²´ êµ­ê°€</option>
                <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
                <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option>
                <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
            </select>
            <button class="btn btn-outline" onclick="loadOrders()"><i class="fa-solid fa-rotate"></i></button>
        </div>
    </div>
    <table style="margin:0; font-size:12px;">
        <thead>
            <tr>
                <th style="width:30px;"><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></th>
                <th style="width:40px;">Site</th>
                <th style="width:80px;">ë‚ ì§œ</th>
                <th style="width:150px;">ê³ ê° ì •ë³´</th>
                <th style="">ì£¼ë¬¸ ë‚´ì—­</th>
                
                <th style="width:80px; text-align:right; background:#f8fafc;">ì£¼ë¬¸ì´ì•¡</th>
                <th style="width:70px; text-align:right; color:#ef4444; background:#f8fafc;">í• ì¸ì•¡</th>
                <th style="width:70px; text-align:right; color:#d97706; background:#f8fafc;">ì˜ˆì¹˜ê¸ˆ</th>
                <th style="width:80px; text-align:right; color:#15803d; background:#dcfce7;">ì‹¤ì…ê¸ˆì•¡</th>
                
                <th style="width:160px; background:#f0f9ff;">ğŸ“… ë°°ì†¡/ë‹´ë‹¹</th>
                <th style="width:130px;">íŒŒì¼</th>
                <th style="width:70px;">ìƒíƒœ</th>
            </tr>
        </thead>
        <tbody id="orderListBody"></tbody>
    </table>
</div>
            </div>

            <div id="sec-partner-apps" class="section">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">ğŸª ê°€ë§¹ì  ì‹ ì²­ ë‚´ì—­ (ëŒ€ê¸°ì¤‘)</h3>
            <button class="btn btn-outline btn-sm" onclick="loadPartnerApplications()">
                <i class="fa-solid fa-rotate"></i> ìƒˆë¡œê³ ì¹¨
            </button>
        </div>


        
        <table>
            <thead>
                <tr>
                    <th width="150">ì‹ ì²­ì¼</th>
                    <th>ì‹ ì²­ì (ì´ë©”ì¼)</th>
                    <th>ì—…ì²´ëª… (ìƒí˜¸)</th>
                    <th>ì—°ë½ì²˜</th>
                    <th>í¬ë§ ì§€ì—­</th>
                    <th width="100">ìŠ¹ì¸</th>
                </tr>
            </thead>
            <tbody id="partnerAppListBody">
                <tr><td colspan="6" style="text-align:center; padding:30px;">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="sec-accounting" class="section">
                <div class="card" style="margin-bottom:20px; border-left:5px solid #059669;">
                    <div style="border-bottom:1px solid #e2e8f0; padding-bottom:15px; margin-bottom:15px;">
                        <h3 style="margin:0; display:flex; align-items:center; gap:10px; color:#059669;">
                            <i class="fa-solid fa-file-invoice-dollar"></i> ê²½ë¦¬ê³¼ í†µí•© ê²°ì‚° ê´€ë¦¬
                        </h3>
                    </div>

                    <div style="display:flex; gap:15px; align-items:flex-end; background:#f0fdf4; padding:20px; border-radius:8px;">
                        <div>
                            <label class="form-label">ğŸ“… ì¡°íšŒ ì‹œì‘ì¼</label>
                            <input type="date" id="accStartDate" class="input-text">
                        </div>
                        <div>
                            <label class="form-label">ğŸ“… ì¡°íšŒ ì¢…ë£Œì¼</label>
                            <input type="date" id="accEndDate" class="input-text">
                        </div>
                        <button class="btn btn-primary" style="height:42px; padding:0 25px; font-size:14px;" onclick="loadAccountingData()">
                            <i class="fa-solid fa-magnifying-glass"></i> ë°ì´í„° ì¡°íšŒ
                        </button>
                    </div>
                    <p style="font-size:12px; color:#666; margin-top:10px; margin-bottom:0;">
                        â€» <b>ê²°ì œì™„ë£Œ, ì…ê¸ˆí™•ì¸, ì¹´ë“œê²°ì œì™„ë£Œ</b> ìƒíƒœì¸ ì£¼ë¬¸ë§Œ ë§¤ì¶œë¡œ ì§‘ê³„ë©ë‹ˆë‹¤.
                    </p>
                </div>

                <div class="stat-card-group">
                    <div class="stat-card" style="display:block; padding:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <div class="stat-icon" style="width:40px; height:40px; font-size:18px; background:#dcfce7; color:#15803d;"><i class="fa-solid fa-won-sign"></i></div>
                                <div style="font-size:13px; font-weight:bold; color:#64748b;">ê¸°ê°„ ë‚´ ê²°ì œ ì´ì•¡</div>
                            </div>
                            <button class="btn btn-success btn-sm" onclick="downloadAccSales()" title="ì£¼ë¬¸ë³„ ìƒì„¸ ì—‘ì…€">
                                <i class="fa-solid fa-file-excel"></i> ì—‘ì…€
                            </button>
                        </div>
                        <div id="accTotalSales" style="font-size:24px; font-weight:800; color:#0f172a; margin-top:5px;">0ì›</div>
                    </div>

                    <div class="stat-card" style="display:block; padding:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <div class="stat-icon" style="width:40px; height:40px; font-size:18px; background:#fef3c7; color:#d97706;"><i class="fa-solid fa-hand-holding-dollar"></i></div>
                                <div style="font-size:13px; font-weight:bold; color:#64748b;">ë¯¸ì§€ê¸‰(ì •ì‚°ëŒ€ê¸°) ì´ì•¡</div>
                            </div>
                            <button class="btn btn-success btn-sm" onclick="downloadAccUnpaid()" title="ë¯¸ì§€ê¸‰ ê³„ì¢Œ ì—‘ì…€">
                                <i class="fa-solid fa-file-excel"></i> ì—‘ì…€
                            </button>
                        </div>
                        <div id="accUnpaidTotal" style="font-size:24px; font-weight:800; color:#d97706; margin-top:5px;">0ì›</div>
                    </div>

                    <div class="stat-card" style="display:block; padding:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <div class="stat-icon" style="width:40px; height:40px; font-size:18px; background:#e0e7ff; color:#4338ca;"><i class="fa-solid fa-coins"></i></div>
                                <div style="font-size:13px; font-weight:bold; color:#64748b;">ê³ ê° ì˜ˆì¹˜ê¸ˆ (í˜„ì¬ì”ê³ )</div>
                            </div>
                            <button class="btn btn-success btn-sm" onclick="downloadAccDeposit()" title="ì˜ˆì¹˜ê¸ˆ ë³´ìœ ìë¦¬ìŠ¤íŠ¸">
                                <i class="fa-solid fa-file-excel"></i> ì—‘ì…€
                            </button>
                        </div>
                        <div id="accTotalDeposit" style="font-size:24px; font-weight:800; color:#4338ca; margin-top:5px;">0ì›</div>
                    </div>

                    <div class="stat-card" style="display:block; padding:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <div class="stat-icon" style="width:40px; height:40px; font-size:18px; background:#fee2e2; color:#ef4444;"><i class="fa-solid fa-tags"></i></div>
                                <div style="font-size:13px; font-weight:bold; color:#64748b;">ê¸°ê°„ ë‚´ í• ì¸ ì´ì•¡</div>
                            </div>
                            <button class="btn btn-success btn-sm" onclick="downloadAccDiscount()" title="í• ì¸ ë‚´ì—­ ìƒì„¸">
                                <i class="fa-solid fa-file-excel"></i> ì—‘ì…€
                            </button>
                        </div>
                        <div id="accTotalDiscount" style="font-size:24px; font-weight:800; color:#ef4444; margin-top:5px;">0ì›</div>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div class="card">
                        <h4 style="margin-top:0; color:#1e40af;">ğŸ¢ [6] ê°€ë§¹ì /íŒŒíŠ¸ë„ˆìŠ¤ ì…ê¸ˆìš”ì²­ (ì„¸ê¸ˆê³„ì‚°ì„œ O)</h4>
                        <div style="max-height:400px; overflow-y:auto;">
                            <table style="font-size:12px;">
                                <thead>
                                    <tr>
                                        <th>ì‹ ì²­ì¼</th>
                                        <th>ì—…ì²´ëª…(ìƒí˜¸)</th>
                                        <th style="text-align:right;">ê¸ˆì•¡</th>
                                        <th style="text-align:center;">ì¦ë¹™</th>
                                        <th style="text-align:center;">ìƒíƒœ</th>
                                    </tr>
                                </thead>
                                <tbody id="accPartnerBody">
                                    <tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h4 style="margin-top:0; color:#c2410c;">ğŸ§‘â€ğŸ’» [5] í”„ë¦¬ëœì„œ/ë””ìì´ë„ˆ ì…ê¸ˆìš”ì²­ (ì£¼ë¯¼ë²ˆí˜¸ O)</h4>
                        <div style="max-height:400px; overflow-y:auto;">
                            <table style="font-size:12px;">
                                <thead>
                                    <tr>
                                        <th>ì‹ ì²­ì¼</th>
                                        <th>ì„±ëª…</th>
                                        <th style="text-align:right;">ê¸ˆì•¡</th>
                                        <th style="text-align:center;">ì£¼ë¯¼ë²ˆí˜¸</th>
                                        <th style="text-align:center;">ìƒíƒœ</th>
                                    </tr>
                                </thead>
                                <tbody id="accFreelancerBody">
                                    <tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-bankda" class="section">
                <div class="card" style="margin-bottom:20px; background:#f0fdf4; border:1px solid #bbf7d0;">
                    <h3 style="margin-top:0; border-bottom:1px solid #bbf7d0; padding-bottom:15px; display:flex; align-items:center; gap:10px; color:#15803d;">
                        <i class="fa-solid fa-robot"></i> í˜ì´ì—‘ì…˜(êµ­ë¯¼ì€í–‰) ì…ê¸ˆ ìë™ì—°ë™
                    </h3>
                    <div style="display:flex; gap:15px; align-items:flex-end;">
                        <div>
                            <label class="form-label">ì¡°íšŒ ì‹œì‘ì¼</label>
                            <input type="date" id="bankStartDate" class="input-text">
                        </div>
                        <div>
                            <label class="form-label">ì¡°íšŒ ì¢…ë£Œì¼</label>
                            <input type="date" id="bankEndDate" class="input-text">
                        </div>
                        <button class="btn btn-success" style="height:42px;" onclick="loadBankdaList()">
                            <i class="fa-solid fa-magnifying-glass"></i> DB ì¡°íšŒ
                        </button>
                        
                        <button class="btn btn-primary" style="height:42px; margin-left:auto; background:#15803d; border:none;" onclick="runBankdaScraping()">
                            <i class="fa-solid fa-rotate"></i> êµ­ë¯¼ì€í–‰ ìµœì‹ ë‚´ì—­ ê°€ì ¸ì˜¤ê¸°
                        </button>
                    </div>
                    <p style="font-size:12px; color:#166534; margin-top:10px; margin-bottom:0;">
                        * [ìµœì‹ ë‚´ì—­ ê°€ì ¸ì˜¤ê¸°] ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í˜ì´ì—‘ì…˜ì„ í†µí•´ êµ­ë¯¼ì€í–‰ì˜ ì˜¤ëŠ˜ ì…ê¸ˆ ë‚´ì—­ì„ ì¡°íšŒí•˜ì—¬ DBì— ì €ì¥í•©ë‹ˆë‹¤.
                    </p>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <h4 style="margin:0;">ğŸ¦ ì…ê¸ˆ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ (DB: bank_transactions)</h4>
                        <span class="badge" style="background:#f1f5f9; color:#64748b;">ìë™ë§¤ì¹­ í¬í•¨</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th width="150">ê±°ë˜ì¼ì‹œ</th>
                                <th width="120">ì…ê¸ˆìëª…</th>
                                <th width="120" style="text-align:right;">ì…ê¸ˆì•¡</th>
                                <th width="120">ì€í–‰/ê³„ì¢Œ</th>
                                <th width="100">ë§¤ì¹­ ìƒíƒœ</th>
                                <th>ê´€ë¦¬ (ì£¼ë¬¸ì—°ë™)</th>
                            </tr>
                        </thead>
                        <tbody id="bankListBody">
                            <tr><td colspan="6" style="text-align:center; padding:30px;">ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="sec-stats" class="section">
                <div class="card" style="margin-bottom:20px;">
                    <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:15px; display:flex; align-items:center; gap:10px;">
                        <i class="fa-solid fa-calendar-days" style="color:#6366f1;"></i> ê¸°ê°„ë³„ ë§¤ì¶œ ì¡°íšŒ
                    </h3>
                    <div style="display:flex; gap:10px; align-items:flex-end; background:#f8fafc; padding:20px; border-radius:8px;">
                        <div><label class="form-label">ì‹œì‘ì¼</label><input type="date" id="statStartDate" class="input-text"></div>
                        <div><label class="form-label">ì¢…ë£Œì¼</label><input type="date" id="statEndDate" class="input-text"></div>
                        <button class="btn btn-primary" style="height:42px;" onclick="loadStatsData()"><i class="fa-solid fa-magnifying-glass"></i> ì¡°íšŒí•˜ê¸°</button>
                    </div>
                </div>
                <div class="stat-card-group">
                    <div class="stat-card"><div class="stat-icon"><i class="fa-solid fa-won-sign"></i></div><div class="stat-info"><div>ê¸°ê°„ ë‚´ ì´ ë§¤ì¶œ (ê³„ì‚°ë¨)</div><div id="totalRevenue">0</div></div></div>
                    <div class="stat-card"><div class="stat-icon" style="background:#ecfdf5; color:#059669;"><i class="fa-solid fa-receipt"></i></div><div class="stat-info"><div>ì´ ì£¼ë¬¸ ê±´ìˆ˜</div><div id="totalCount">0ê±´</div></div></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div class="card"><h4 style="margin-top:0;">ğŸ‘¨â€ğŸ’¼ ë‹´ë‹¹ ë§¤ë‹ˆì €ë³„ ì‹¤ì </h4><table style="margin-top:0;"><thead><tr><th>ë§¤ë‹ˆì €</th><th style="text-align:right;">ë§¤ì¶œ ê¸°ì—¬ë„</th></tr></thead><tbody id="statManagerBody"></tbody></table></div>
                    <div class="card"><h4 style="margin-top:0;">ğŸšš ë°°ì†¡ ê¸°ì‚¬ë³„ ì‹¤ì </h4><table style="margin-top:0;"><thead><tr><th>ê¸°ì‚¬ë‹˜</th><th style="text-align:right;">ë§¤ì¶œ ê¸°ì—¬ë„</th></tr></thead><tbody id="statDriverBody"></tbody></table></div>
                </div>
            </div>

            <div id="sec-tasks" class="section">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
            <h3 style="margin:0; display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-truck-fast" style="color:#6366f1;"></i> ë‚ ì§œë³„ ë°°ì†¡ ìŠ¤ì¼€ì¤„
            </h3>
            <div style="display:flex; gap:8px; align-items:center;">
                <select id="filterTaskDriver" class="input-text" style="width:200px; font-weight:bold;" onchange="loadDailyTasks()">
                    <option value="all">ğŸš› ì „ì²´ ê¸°ì‚¬ ë³´ê¸°</option>
                </select>
                
                <input type="date" id="taskDate" class="input-text" style="width:140px;" onchange="loadDailyTasks()">
                <button class="btn btn-primary" onclick="loadDailyTasks()">ì¡°íšŒ</button>
            </div>
        </div>
        <table style="margin-top:0;">
            <thead>
                <tr>
                    <th style="width:90px; white-space:nowrap;">ìƒíƒœ</th>
                    <th style="width:180px;">ê³ ê° ì •ë³´ (ì´ë¦„/ì—°ë½ì²˜)</th>
                    <th>ì£¼ë¬¸ íŒŒì¼</th>
                    <th style="width:180px;">ğŸšš ë°°ì†¡ ê¸°ì‚¬ ë°°ì •</th>
                    <th style="width:160px;">â° ì‹œê°„ / ì™„ë£Œì²´í¬</th>
                </tr>
            </thead>
            <tbody id="taskListBody"></tbody>
        </table>
    </div>
</div>

            <div id="sec-withdrawals" class="section">
                <div class="card">
                    <h3 style="margin-top:0;">ğŸ’¸ ê³ ê° ì¶œê¸ˆ ì‹ ì²­ ëª©ë¡</h3>
                    <button class="btn btn-outline btn-sm" onclick="loadWithdrawals()">ìƒˆë¡œê³ ì¹¨</button>
                    <table>
                        <thead><tr><th>ì‹ ì²­ì¼</th><th>ìœ ì €</th><th>ì¶œê¸ˆì•¡</th><th>ê³„ì¢Œì •ë³´</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="withdrawalListBody"></tbody>
                    </table>
                </div>
            </div>
            <div id="sec-products" class="section">
                <div class="card" style="background:#fff7ed; border:1px solid #ffedd5; margin-bottom:20px;">
                    <h3 style="margin-top:0; color:#c2410c;">ğŸ‘‘ ëŒ€ë¶„ë¥˜(Top Category) ê´€ë¦¬</h3>
                    <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                        <div style="flex:1; min-width:120px;"><label class="form-label">ì½”ë“œ (ì˜ë¬¸)</label><input id="newTopCatCode" class="input-text" placeholder="ì˜ˆ: banner_stand"></div>
                        <div style="flex:1; min-width:120px;"><label class="form-label">ğŸ‡°ğŸ‡· í•œêµ­ëª…</label><input id="newTopCatName" class="input-text" placeholder="ì˜ˆ: ë°°ë„ˆê±°ì¹˜ëŒ€"></div>
                        <div style="flex:1; min-width:120px;"><label class="form-label">ğŸ‡¯ğŸ‡µ ì¼ë³¸ëª…</label><input id="newTopCatNameJP" class="input-text" placeholder="ìë™ë²ˆì—­ë¨"></div>
                        <div style="flex:1; min-width:120px;"><label class="form-label">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ëª…</label><input id="newTopCatNameUS" class="input-text" placeholder="ìë™ë²ˆì—­ë¨"></div>
    </div>

    <div style="margin-bottom:10px;">
        <label class="form-label">ğŸ“ ìƒì„¸ ì„¤ëª… (ê³ ê° ì•ˆë‚´ìš©)</label>
        <textarea id="newTopCatDesc" class="input-text" style="height:60px; margin-bottom:5px;" placeholder="ğŸ‡°ğŸ‡· í•œêµ­ì–´ ì„¤ëª… ì…ë ¥ (ì˜ˆ: ê°€ë³ê³  íŠ¼íŠ¼í•œ ì¢…ì´ ì†Œì¬ì…ë‹ˆë‹¤...)"></textarea>
        <div style="display:flex; gap:5px;">
            <textarea id="newTopCatDescJP" class="input-text" style="height:60px;" placeholder="ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ ì„¤ëª…"></textarea>
            <textarea id="newTopCatDescUS" class="input-text" style="height:60px;" placeholder="ğŸ‡ºğŸ‡¸ ì˜ì–´ ì„¤ëª…"></textarea>
        </div>
    </div>

    <div style="text-align:right;">
        <button class="btn btn-vip" onclick="autoTranslateTopCategoryInputs()" style="height:40px;">
                            <i class="fa-solid fa-language"></i> ëŒ€ë¶„ë¥˜ ë²ˆì—­
                        </button>
                        <button class="btn btn-primary" onclick="addTopCategoryDB()" style="height:40px; background:#f97316;">ì €ì¥</button>
                    </div>
                    <div id="topCategoryListArea" style="margin-top:15px; border-top:1px solid #ffedd5; padding-top:10px;"></div>
                </div>

                <div class="card" style="background:#f0f9ff; border:1px solid #bae6fd; margin-bottom:20px;">
                    <h3 style="margin-top:0; color:#0369a1;">0ï¸âƒ£ ì†Œë¶„ë¥˜(Sub Category) ê´€ë¦¬</h3>
                    <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                        
                        <div style="width:140px;">
                            <label class="form-label">ğŸ“‚ ëŒ€ë¶„ë¥˜ ì„ íƒ</label>
                            <select id="newCatTop" class="input-text" style="background:#fff;">
                                <option value="">(ìƒìœ„ ì—†ìŒ)</option>
                            </select>
                        </div>

                        <div style="flex:1; min-width:120px;"><label class="form-label">í´ë” ì½”ë“œ (ì˜ë¬¸)</label><input id="newCatCode" class="input-text" placeholder="ì˜ˆ: honeycomb"></div>
                        <div style="flex:1; min-width:120px;"><label class="form-label">ğŸ‡°ğŸ‡· í•œêµ­ëª…</label><input id="newCatName" class="input-text" placeholder="ì˜ˆ: í—ˆë‹ˆì½¤"></div>
                        <div style="flex:1; min-width:120px;"><label class="form-label">ğŸ‡¯ğŸ‡µ ì¼ë³¸ëª…</label><input id="newCatNameJP" class="input-text" placeholder="ì˜ˆ: ãƒãƒ‹ã‚«ãƒ "></div>
                        <div style="flex:1; min-width:120px;"><label class="form-label">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ëª…</label><input id="newCatNameUS" class="input-text" placeholder="ì˜ˆ: Honeycomb"></div>
    </div>
    <div style="margin-bottom:10px;">
        <label class="form-label">ğŸ“ ì†Œë¶„ë¥˜ ìƒì„¸ ì„¤ëª… (ì˜µì…˜)</label>
        <textarea id="newCatDesc" class="input-text" style="height:50px; margin-bottom:5px;" placeholder="ğŸ‡°ğŸ‡· í•œêµ­ì–´ ì„¤ëª…"></textarea>
        <div style="display:flex; gap:5px;">
            <textarea id="newCatDescJP" class="input-text" style="height:50px;" placeholder="ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ ì„¤ëª…"></textarea>
            <textarea id="newCatDescUS" class="input-text" style="height:50px;" placeholder="ğŸ‡ºğŸ‡¸ ì˜ì–´ ì„¤ëª…"></textarea>
        </div>
    </div>
    <div style="text-align:right;">
                        <button class="btn btn-vip" onclick="autoTranslateCategoryInputs()" style="height:40px;">
                            <i class="fa-solid fa-language"></i> ì†Œë¶„ë¥˜ ë²ˆì—­
                        </button>
                        
                        <button class="btn btn-primary" onclick="addCategoryDB()" style="height:40px;">ìƒì„±/ìˆ˜ì •</button>
                    </div>
                    <div style="text-align:right; margin-top:5px;">
                        <button class="btn btn-outline btn-sm" onclick="bulkTranslateCategories()">
                            <i class="fa-solid fa-bolt"></i> ì¹´í…Œê³ ë¦¬ ì¼ê´„ ë²ˆì—­ (ì „ì²´)
                        </button>
                    </div>
                    <div id="categoryListArea" style="margin-top:15px; border-top:1px solid #bae6fd; padding-top:10px;"></div>
                </div>

                <div class="product-layout">
                    <div class="card product-form">
                        <h3 style="margin-top:0;">2ï¸âƒ£ ìƒí’ˆ ë“±ë¡ (Product)</h3>
                        <div class="form-group" style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                            <label class="form-label">ğŸŒ íŒë§¤ êµ­ê°€ (Site Code)</label>
                            <select id="newProdSite" class="input-text" style="font-weight:bold; color:#6366f1;">
                                <option value="KR" selected>ğŸ‡°ğŸ‡· í•œêµ­ (Korea)</option>
                                <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸ (Japan)</option>
                                <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ (USA)</option>
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label><select id="newProdCategory" class="input-text"><option value="">ë¡œë”© ì¤‘...</option></select></div>
                        <div class="form-group"><label class="form-label">ìƒí’ˆì½”ë“œ (ê³ ìœ ê°’)</label><input id="newProdCode" class="input-text" placeholder="Wall_1_KR"></div>
                        
                        <div class="form-group" style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <label class="form-label" style="margin:0;">ìƒí’ˆëª… (ë‹¤êµ­ì–´)</label>
                                <button class="btn btn-vip btn-sm" onclick="autoTranslateInputs()">
                                    <i class="fa-solid fa-language"></i> í˜„ì¬ë‚´ìš© ìë™ë²ˆì—­
                                </button>
                            </div>
                            <input id="newProdName" class="input-text" placeholder="ğŸ‡°ğŸ‡· í•œêµ­ì–´ (ê¸°ë³¸)" style="margin-bottom:5px;">
                            <input id="newProdNameJP" class="input-text" placeholder="ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´" style="margin-bottom:5px;">
                            <input id="newProdNameUS" class="input-text" placeholder="ğŸ‡ºğŸ‡¸ ì˜ì–´">
                        </div>

                        <div class="input-row">
                            <div style="flex:1;"><label class="form-label">ê°€ë¡œ(mm)</label><input id="newProdW" type="number" class="input-text"></div>
                            <div style="flex:1;"><label class="form-label">ì„¸ë¡œ(mm)</label><input id="newProdH" type="number" class="input-text"></div>
                        </div>

                        <div class="form-group" style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                            <label class="form-label">ê°€ê²© ì„¤ì • (êµ­ê°€ë³„)</label>
                            <div style="display:flex; gap:5px; margin-bottom:5px;">
                                <input id="newProdPrice" type="number" class="input-text" placeholder="ğŸ‡°ğŸ‡· KRW">
                                <input id="newProdPriceJP" type="number" class="input-text" placeholder="ğŸ‡¯ğŸ‡µ JPY">
                            </div>
                            <input id="newProdPriceUS" type="number" class="input-text" placeholder="ğŸ‡ºğŸ‡¸ USD">
                        </div>

                        <div class="form-group" style="background:#fff7ed; padding:10px; border:1px solid #fdba74; border-radius:6px; margin-top:10px;">
                            <label class="form-label" style="color:#c2410c;">ğŸ“ ì‚¬ì´ì¦ˆ ê³„ì‚° ì˜µì…˜</label>
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:bold;">
                                <input type="checkbox" id="newProdIsCustom" style="width:18px; height:18px;">
                                ì‚¬ìš©ì ì‚¬ì´ì¦ˆ ì…ë ¥ í—ˆìš© (í—¤ë²  ê³„ì‚°)
                            </label>
                            <p style="font-size:11px; color:#666; margin:5px 0 0 0;">
                                â€» ì²´í¬ ì‹œ 'ê°€ê²©'ë€ì— <b>1m x 1m (1ã¡) ë‹¹ ë‹¨ê°€</b>ë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>
                                (ì˜ˆ: ê°€ë¡œ 1m, ì„¸ë¡œ 1mê°€ 5ë§Œì›ì´ë©´ ê°€ê²©ì— 50000 ì…ë ¥)
                            </p>
                        </div>

                        <div class="form-group" style="background:#f0f9ff; padding:10px; border-radius:6px; border:1px solid #bae6fd;">
                            <label class="form-label">ğŸ“ ì œí’ˆ ìƒì„¸ ì„¤ëª… (ê³ ê° ì•ˆë‚´ìš©)</label>
                            <textarea id="newProdDesc" class="input-text" style="height:60px; margin-bottom:5px;" placeholder="ğŸ‡°ğŸ‡· ì œí’ˆ íŠ¹ì§•, ì†Œì¬ ë“± ìƒì„¸ ì„¤ëª…"></textarea>
                            <div style="display:flex; gap:5px;">
                                <textarea id="newProdDescJP" class="input-text" style="height:60px;" placeholder="ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ ì„¤ëª…"></textarea>
                                <textarea id="newProdDescUS" class="input-text" style="height:60px;" placeholder="ğŸ‡ºğŸ‡¸ ì˜ì–´ ì„¤ëª…"></textarea>
                            </div>
                        </div>

                        <div class="form-group"><label class="form-label">ì´ë¯¸ì§€</label><div class="file-drop-zone"><input type="file" id="newProdFile" accept="image/*" onchange="previewProductImage(this)"><span>ì—…ë¡œë“œ</span></div><input id="newProdImg" class="input-text" style="margin-top:5px;" placeholder="URL"><img id="prodPreview" class="preview-img"></div>
                        <div class="form-group"><label class="form-label">ì˜µì…˜ ì—°ê²°</label><div id="addonCheckboxArea" class="addon-checkbox-group"></div></div>
                        <div style="margin-top: 5px; margin-bottom: 15px; text-align: right;">
    <button class="btn btn-sky btn-sm" onclick="bulkApplyAddonsToCategory()" style="width: 100%;">
        <i class="fa-solid fa-layer-group"></i> í˜„ì¬ ì²´í¬ëœ ì˜µì…˜ì„ ì´ ì¹´í…Œê³ ë¦¬ ì „ ì œí’ˆì— ì¼ê´„ì ìš©
    </button>
</div>
                        <button id="btnProductSave" class="btn btn-primary" style="width:100%;" onclick="addProductDB()">ìƒí’ˆ ë“±ë¡í•˜ê¸°</button>
                        <div style="margin-top:10px; display:flex; gap:5px;"><button id="btnProductClone" class="btn btn-vip" style="flex:1; display:none;" onclick="cloneProduct()">ë³µì œ</button><button id="btnCancelEdit" class="btn btn-outline" style="flex:1; display:none;" onclick="resetProductForm()">ì·¨ì†Œ</button></div>
                    </div>

                    <div class="product-grid-area">
                        <div class="card" style="margin-bottom:20px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <h3 style="margin:0;">1ï¸âƒ£ ì˜µì…˜ í†µí•© ê´€ë¦¬ (3ê°œêµ­ ë™ì‹œ)</h3>
                                <button class="btn btn-vip btn-sm" onclick="autoTranslateAddonInputs()">
                                    <i class="fa-solid fa-language"></i> í˜„ì¬ë‚´ìš© ìë™ë²ˆì—­
                                </button>
                            </div>
                            
                            <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                                <div style="width:100px;"><label class="form-label">êµ¬ë¶„</label><select id="newAddonCat" class="input-text"><option value="addon">ì¶”ê°€</option><option value="material">ì¬ì§ˆ</option><option value="finish">ë§ˆê°</option></select></div>
                                <div style="flex:1; min-width:100px;"><label class="form-label">ì½”ë“œ (ì˜ë¬¸)</label><input id="newAddonCode" class="input-text"></div>
                                <div style="flex:1; min-width:100px;"><label class="form-label">ğŸ‡°ğŸ‡· ëª…ì¹­/ê°€ê²©</label><input id="nmKR" class="input-text" placeholder="ì´ë¦„"><input id="prKR" type="number" class="input-text" placeholder="ì›" style="margin-top:2px;"></div>
                                <div style="flex:1; min-width:100px;"><label class="form-label">ğŸ‡¯ğŸ‡µ ëª…ì¹­/ê°€ê²©</label><input id="nmJP" class="input-text" placeholder="åå‰"><input id="prJP" type="number" class="input-text" placeholder="å††" style="margin-top:2px;"></div>
                                <div style="flex:1; min-width:100px;"><label class="form-label">ğŸ‡ºğŸ‡¸ ëª…ì¹­/ê°€ê²©</label><input id="nmUS" class="input-text" placeholder="Name"><input id="prUS" type="number" class="input-text" placeholder="$" style="margin-top:2px;"></div>
                                <button class="btn btn-primary" onclick="addAddonDB()">ì €ì¥</button>
                            </div>
                            <div style="margin-top:10px;">
                                <select onchange="loadSystemDB(this.value)" id="newAddonSite" class="input-text" style="width:150px; font-size:12px; margin-bottom:5px;"><option value="KR">ğŸ‡°ğŸ‡· í•œêµ­ ì˜µì…˜</option><option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸ ì˜µì…˜</option><option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ì˜µì…˜</option></select>
                            </div>
                            <div style="max-height:200px; overflow-y:auto; border-top:1px solid #eee;">
                                <table style="font-size:12px;"><tbody id="addonTableBody"></tbody></table>
                            </div>
                        </div>
                        <div class="card">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <h3>ğŸ“œ ìƒí’ˆ ëª©ë¡</h3>
                                <button id="btnBulkTranslate" class="btn btn-success btn-sm" onclick="bulkTranslateAll()">
                                    <i class="fa-solid fa-bolt"></i> ì „ì²´ ìƒí’ˆ/ì˜µì…˜/ì¹´í…Œê³ ë¦¬ ìë™ ë²ˆì—­
                                </button>
                            </div>
                            <div style="margin-bottom:10px; display:flex; gap:10px; align-items:center;">
                                <span style="font-weight:bold; color:#64748b;">ğŸ” í•„í„°:</span>
                                <select id="filterProdSite" onchange="filterProductList()" class="input-text" style="width:130px;">
                                    <option value="all">ğŸŒ êµ­ê°€ ì „ì²´</option>
                                    <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
                                    <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option>
                                    <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
                                </select>
                                <select id="filterProdCat" onchange="filterProductList()" class="input-text" style="width:150px;">
                                    <option value="all">ğŸ“‚ ì¹´í…Œê³ ë¦¬ ì „ì²´</option>
                                    </select>
                            </div>
                            <table><thead><tr><th width="50">êµ­ê°€</th><th width="60">ì´ë¯¸ì§€</th><th>ì½”ë“œ/ìƒí’ˆëª…</th><th>ì‚¬ì´ì¦ˆ</th><th>ê°€ê²©</th><th width="80">ê´€ë¦¬</th></tr></thead><tbody id="prodTableBody"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-staff" class="section">
                <div class="product-layout">
                    <div class="card tpl-form">
                        <h3 style="margin-top:0;">ğŸ‘¤ ìŠ¤íƒœí”„ ë“±ë¡</h3>
                        <div class="form-group"><label class="form-label">ì´ë¦„</label><input id="staffName" class="input-text" placeholder="ì˜ˆ: í™ê¸¸ë™"></div>
                        <div class="form-group"><label class="form-label">ì—­í• </label><select id="staffRole" class="input-text"><option value="manager">ë‹´ë‹¹ ë§¤ë‹ˆì €</option><option value="driver">ë°°ì†¡ ê¸°ì‚¬</option></select></div>
                        <div class="form-group"><label class="form-label">ìƒ‰ìƒ</label><input id="staffColor" type="color" class="input-text" style="height:40px; padding:2px;" value="#6366f1"></div>
                        <button class="btn btn-primary" style="width:100%;" onclick="addStaffDB()">ë“±ë¡í•˜ê¸°</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-top:0;">ğŸ“‹ ìŠ¤íƒœí”„ ëª©ë¡</h3>
                        <button class="btn btn-outline btn-sm" onclick="loadStaffList()" style="margin-bottom:10px;">ìƒˆë¡œê³ ì¹¨</button>
                        <table><thead><tr><th width="50">ìƒ‰ìƒ</th><th>ì´ë¦„</th><th>ì—­í• </th><th>ê´€ë¦¬</th></tr></thead><tbody id="staffListBody"></tbody></table>
                    </div>
                </div>
            </div>

            <div id="sec-members" class="section">
    <div class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
            <h3>ğŸ‘¥ íšŒì› ëª©ë¡ & ë“±ê¸‰ ê´€ë¦¬</h3>
            <div style="display:flex; gap:5px;">
                <label class="btn btn-success" style="cursor:pointer;" title="ê³ ë„ëª° ì—‘ì…€ ì—…ë¡œë“œ">
                    <i class="fa-solid fa-file-excel"></i> ë§ˆì¼ë¦¬ì§€ ì´ê´€(Excel)
                    <input type="file" id="mileageExcelInput" accept=".xlsx, .xls" style="display:none;" onchange="importMileageExcel(this)">
                </label>
                <input type="text" id="memberSearchInput" class="input-text" placeholder="ì´ë©”ì¼ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰" style="width:200px;" onkeyup="if(event.key=='Enter') loadMembers()">
                <button class="btn btn-primary" onclick="loadMembers()"><i class="fa-solid fa-magnifying-glass"></i> ê²€ìƒ‰</button>
            </div>
        </div>
        <table>
            <thead>
    <tr>
        <th>ê°€ì…ì¼</th>
        <th>ì´ë©”ì¼/ì´ë¦„</th>
        <th>ğŸ’° ì˜ˆì¹˜ê¸ˆ / â“‚ï¸ ë§ˆì¼ë¦¬ì§€</th> <th>ê´€ë¦¬</th> 
        <th>í˜„ì¬ ë“±ê¸‰</th>
        <th>ë“±ê¸‰ ë³€ê²½</th>
    </tr>
</thead>
            <tbody id="memberListBody"></tbody>
        </table>
    </div>
</div>

            <div id="sec-templates" class="section">
                 <div class="product-layout">
                    <div class="card tpl-form">
                        <h3 style="margin-top:0;">ğŸ“¤ í…œí”Œë¦¿ ë“±ë¡</h3>
                        <div class="form-group">
                            <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                            <select id="tplCategory" class="input-text" onchange="toggleFileInputs()">
                                <option value="logo">ğŸ¨ ë¡œê³  (Logo)</option>
                                <option value="transparent-graphic">ğŸ íŒ¨í„´ (Pattern)</option>
                                <option value="vector">ğŸ–¼ ë²¡í„° ë°°ê²½ (Vector)</option>
                                <option value="photo-bg">ğŸ“· ì‚¬ì§„ ë°°ê²½ (Photo)</option>
                                <option value="graphic">ğŸ§¸ ê·¸ë˜í”½/ìŠ¤í‹°ì»¤ (Graphic)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ê²€ìƒ‰ì–´ (íƒœê·¸)</label>
                            <input id="tplTags" class="input-text" placeholder="ì˜ˆ: ì‚¼ì„±, ë¡œê³ , ì—¬ë¦„">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ì—°ê²° ì œí’ˆ (Product Key)</label>
                            <select id="tplProductKey" class="input-text">
                                <option value="custom">ê³µí†µ / ì§€ì •ì•ˆí•¨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" id="lblThumb">1. ì¸ë„¤ì¼ (í•„ìˆ˜)</label>
                            <div class="file-drop-zone">
                                <input type="file" id="fileThumb" accept="image/*">
                                <span>ì´ë¯¸ì§€ ì„ íƒ</span>
                            </div>
                            <img id="previewThumb" class="preview-img">
                        </div>
                        <div class="form-group" id="groupDataFile">
                            <label class="form-label">2. ë²¡í„° ë°ì´í„° (ì„ íƒ)</label>
                            <div class="file-drop-zone">
                                <input type="file" id="fileData" accept=".svg,.json">
                                <span>SVG íŒŒì¼ ì„ íƒ</span>
                            </div>
                            <div id="dataStatus" style="font-size:12px; color:#16a34a; display:none;">âœ… ì›ë³¸ ì¤€ë¹„ë¨!</div>
                        </div>
                        <button class="btn btn-primary" style="width:100%;" onclick="uploadTemplate()">ë“±ë¡í•˜ê¸°</button>
                    </div>

                    <div class="card">
                        <div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <h3 style="margin:0;">ğŸ—‚ï¸ í…œí”Œë¦¿ ê´€ë¦¬</h3>
                                <button class="btn btn-danger" onclick="deleteSelectedTemplates()">
                                    <i class="fa-solid fa-trash-can"></i> ì„ íƒí•­ëª© ì¼ê´„ì‚­ì œ
                                </button>
                            </div>
                            
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <input type="text" id="tplSearchInput" class="input-text" style="flex:2;" placeholder="íƒœê·¸ ë˜ëŠ” ID ê²€ìƒ‰..." onkeyup="if(event.key=='Enter') loadTemplates(true)">
                                
                                <select id="filterTplCat" class="input-text" style="flex:1;" onchange="loadTemplates(true)">
                                    <option value="all">ğŸ“‚ ì¹´í…Œê³ ë¦¬: ì „ì²´</option>
                                    <option value="logo">ğŸ¨ ë¡œê³ </option>
                                    <option value="transparent-graphic">ğŸ íŒ¨í„´</option>
                                    <option value="vector">ğŸ–¼ ë²¡í„° ë°°ê²½</option>
                                    <option value="photo-bg">ğŸ“· ì‚¬ì§„ ë°°ê²½</option>
                                    <option value="graphic">ğŸ§¸ ê·¸ë˜í”½</option>
                                </select>
                                
                                <select id="filterTplProduct" class="input-text" style="flex:1;" onchange="loadTemplates(true)">
                                    <option value="all">ğŸ“¦ ì œí’ˆì—°ê²°: ì „ì²´</option>
                                    <option value="custom">ğŸ”¹ ê³µí†µ í…œí”Œë¦¿</option>
                                    <option value="assigned">ğŸ”¸ ì œí’ˆ ì „ìš©</option>
                                    <optgroup label="--- ê°œë³„ ì œí’ˆ ---"></optgroup>
                                </select>
                                
                                <button class="btn btn-primary" onclick="loadTemplates(true)"><i class="fa-solid fa-magnifying-glass"></i> ê²€ìƒ‰</button>
                            </div>
                            
                            <div style="margin-top:10px;">
                                <label style="cursor:pointer; font-weight:bold; font-size:13px;">
                                    <input type="checkbox" onchange="toggleAllTemplates(this)"> ì „ì²´ ì„ íƒ
                                </label>
                            </div>
                        </div>
                        <div style="display:flex; justify-content:center; align-items:center; gap:15px; margin: 15px 0; padding:10px; background:#f8fafc; border-radius:8px;">
    <button class="btn btn-outline btn-sm" onclick="changeTplPage(-1)">â—€ ì´ì „ í˜ì´ì§€</button>
    <span id="tplPageLabel" style="font-weight:bold; font-size:14px; color:#334155;">Page 1</span>
    <button class="btn btn-outline btn-sm" onclick="changeTplPage(1)">ë‹¤ìŒ í˜ì´ì§€ â–¶</button>
</div>

<div id="tplGrid" class="tpl-card-grid"></div>
                    </div>
                </div>
            </div>

            <div id="sec-fonts" class="section">
                <div class="product-layout">
                    <div class="card tpl-form">
                        <h3 style="margin-top:0;">ğŸ”¤ í°íŠ¸ ë“±ë¡</h3>
                        <div class="form-group"><label class="form-label">êµ­ê°€</label><select id="fontSite" class="input-text"><option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option><option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option><option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option></select></div>
                        <div class="form-group"><label class="form-label">í°íŠ¸ëª…</label><input id="fontName" class="input-text" placeholder="ì˜ˆ: Noto Sans JP"></div>
                        <div class="form-group"><label class="form-label">CSS Family</label><input id="fontFamily" class="input-text" placeholder="ì˜ˆ: NotoSansJP"></div>
                        <div class="form-group"><label class="form-label">íŒŒì¼ (.woff2)</label><div class="file-drop-zone"><input type="file" id="fontFile" accept=".woff2,.ttf"><span>íŒŒì¼ ì„ íƒ</span></div></div>
                        <button class="btn btn-primary" style="width:100%;" onclick="uploadFont()">ë“±ë¡í•˜ê¸°</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-top:0;">í°íŠ¸ ëª©ë¡</h3>
                        <button class="btn btn-outline btn-sm" onclick="loadFonts()" style="margin-bottom:10px;">ìƒˆë¡œê³ ì¹¨</button>
                        <table><thead><tr><th width="60">êµ­ê°€</th><th>í‘œì‹œëª…</th><th>ë¯¸ë¦¬ë³´ê¸°</th><th>ì‚­ì œ</th></tr></thead><tbody id="fontListBody"></tbody></table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="walletModal" class="modal-overlay" style="display:none;">
    <div class="modal-box" style="width: 400px;">
        <div class="modal-header">
            <span>ğŸ’° ì˜ˆì¹˜ê¸ˆ ê´€ë¦¬</span>
            <button class="btn btn-outline btn-sm" onclick="document.getElementById('walletModal').style.display='none'">âœ•</button>
        </div>
        
        <div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:15px; text-align:center;">
            <div id="walletTargetName" style="font-weight:bold; color:#334155;">-</div>
            <div style="font-size:12px; color:#64748b;">í˜„ì¬ ì”ì•¡</div>
            <div id="walletTargetBalance" style="font-size:24px; font-weight:800; color:#6366f1;">0ì›</div>
        </div>

        <input type="hidden" id="walletTargetId">
        <input type="hidden" id="walletMode" value="add">

        <div class="form-group">
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="btn btn-primary" style="flex:1;" onclick="setWalletMode('add')" id="btnWalletAdd">â• ì¶©ì „ (ì…ê¸ˆí™•ì¸)</button>
                <button class="btn btn-outline" style="flex:1;" onclick="setWalletMode('sub')" id="btnWalletSub">â– ì°¨ê° (ì·¨ì†Œ/íšŒìˆ˜)</button>
            </div>
            <label class="form-label">ê¸ˆì•¡</label>
            <input type="number" id="walletAmount" class="input-text" placeholder="ìˆ«ìë§Œ ì…ë ¥">
        </div>

        <div class="form-group">
            <label class="form-label">ì‚¬ìœ  (ê³ ê°ì—ê²Œë„ ë³´ì„)</label>
            <input type="text" id="walletDesc" class="input-text" placeholder="ì˜ˆ: ë¬´í†µì¥ ì…ê¸ˆ í™•ì¸">
        </div>

        <button id="btnWalletSubmit" class="btn btn-vip" style="width:100%; margin-top:10px;" onclick="submitWalletChange()">ì ìš©í•˜ê¸°</button>
    </div>
</div>

<script>
    // [ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜]
    window.openWalletModal = (id, email, balance) => {
        document.getElementById('walletTargetId').value = id;
        document.getElementById('walletTargetName').innerText = email;
        document.getElementById('walletTargetBalance').innerText = balance.toLocaleString() + 'ì›';
        document.getElementById('walletAmount').value = '';
        document.getElementById('walletDesc').value = '';
        setWalletMode('add'); // ê¸°ë³¸ì€ ì¶©ì „ ëª¨ë“œ
        document.getElementById('walletModal').style.display = 'flex';
    };

    // [ì¶©ì „/ì°¨ê° ëª¨ë“œ ì „í™˜] â˜… ìˆ˜ì •ë¨: IDë¡œ ë²„íŠ¼ ì°¾ê¸°
    window.setWalletMode = (mode) => {
        document.getElementById('walletMode').value = mode;
        
        const btnAdd = document.getElementById('btnWalletAdd');
        const btnSub = document.getElementById('btnWalletSub');
        const btnSubmit = document.getElementById('btnWalletSubmit'); // â˜… IDë¡œ ì°¾ìŒ

        if(mode === 'add') {
            btnAdd.className = 'btn btn-primary'; 
            btnSub.className = 'btn btn-outline';
            
            btnSubmit.innerText = "ì¶©ì „í•˜ê¸° (ì§€ê¸‰)";
            btnSubmit.className = "btn btn-primary"; // íŒŒë€ìƒ‰
        } else {
            btnAdd.className = 'btn btn-outline'; 
            btnSub.className = 'btn btn-danger';
            
            btnSubmit.innerText = "ì°¨ê°í•˜ê¸° (íšŒìˆ˜)";
            btnSubmit.className = "btn btn-danger"; // ë¹¨ê°„ìƒ‰
        }
    };

    // [ì‹¤ì œ ì ìš© í•¨ìˆ˜]
    window.submitWalletChange = async () => {
        const id = document.getElementById('walletTargetId').value;
        const mode = document.getElementById('walletMode').value;
        const amt = parseInt(document.getElementById('walletAmount').value);
        const desc = document.getElementById('walletDesc').value;

        if(!amt || amt <= 0) return alert("ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        if(!desc) return alert("ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        const finalAmount = mode === 'add' ? amt : -amt;
        const type = mode === 'add' ? 'admin_deposit' : 'admin_withdraw';

        if(!confirm(`${amt.toLocaleString()}ì›ì„ ${mode==='add'?'ì¶©ì „':'ì°¨ê°'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        // 1. ì”ì•¡ ì—…ë°ì´íŠ¸
        const { data: pf } = await sb.from('profiles').select('deposit').eq('id', id).single();
        const newBalance = (pf?.deposit || 0) + finalAmount;

        const { error } = await sb.from('profiles').update({ deposit: newBalance }).eq('id', id);
        if(error) return alert("ì”ì•¡ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: " + error.message);

        // 2. ë¡œê·¸ ê¸°ë¡
        const { error: logErr } = await sb.from('wallet_logs').insert({
            user_id: id,
            type: type,
            amount: finalAmount,
            description: `[ê´€ë¦¬ì] ${desc}`
        });

        if(logErr) alert("ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨(ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìˆìŒ): " + logErr.message);
        else alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");

        document.getElementById('walletModal').style.display = 'none';
        loadMembers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    };
    
    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        const modal = document.getElementById('walletModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>

    <script type="module">
        import { sb, initConfig } from "./config.js";

    // [ë³´ì•ˆ] ê´€ë¦¬ì ê¶Œí•œ ì²´í¬ í•¨ìˆ˜
    async function checkAdminAccess() {
        const { data: { session } } = await sb.auth.getSession();
        
        // 1. ë¹„ë¡œê·¸ì¸ ìƒíƒœë©´ ì¶”ë°©
        if (!session) {
            alert("ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.replace("index.html"); 
            return false;
        }

        // 2. ë“±ê¸‰ í™•ì¸ (admin ì•„ë‹ˆë©´ ì¶”ë°©)
        const { data: profile, error } = await sb.from('profiles').select('role').eq('id', session.user.id).single();
        
        if (error || !profile || profile.role !== 'admin') {
            alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ì ì „ìš©)");
            await sb.auth.signOut(); 
            window.location.replace("index.html");
            return false;
        }

        // 3. í†µê³¼ (í™”ë©´ ë³´ì´ê¸°)
        document.body.style.visibility = 'visible';
        return true;
    }

        // ==========================================
        // 1. ì „ì—­ ë³€ìˆ˜ ë° ê³µí†µ ìœ í‹¸
        // ==========================================
        let currentOrderStatus = 'ì ‘ìˆ˜ë¨'; 
        let allOrders = [];
        let editingProdId = null;
        let editingAddonId = null;
        let editingTopCatId = null; 
        let editingCategoryId = null;
        let allProducts = [];
        let staffList = []; 

        let currentMgrOrderId = null;
        let currentMgrFiles = [];

        const formatCurrency = (amount, siteCode) => {
            if (!amount) return '0';
            const site = siteCode || 'KR';
            if (site === 'JP') return 'Â¥' + amount.toLocaleString();
            if (site === 'US') return '$' + amount.toLocaleString();
            return amount.toLocaleString() + 'ì›';
        }

        // [ìµœì í™”] íƒ­ì„ í´ë¦­í–ˆì„ ë•Œë§Œ í•´ë‹¹ ë°ì´í„°ë¥¼ ë¡œë”© (Lazy Loading)
        window.showSection = (secId, navEl) => {
            // 1. íƒ­ í™œì„±í™” ì²˜ë¦¬
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(secId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(navEl) navEl.classList.add('active');
            
            // 2. ì„¹ì…˜ë³„ ë°ì´í„° ë¡œë“œ (ì´ë¯¸ ë¡œë”©ëœ ë°ì´í„°ëŠ” ìœ ì§€í•˜ê³ , íƒ­ ëˆ„ë¥¼ë•Œë§Œ ê°±ì‹ )
            // loadOrders ë“± ë¬´ê±°ìš´ í•¨ìˆ˜ëŠ” ì—¬ê¸°ì„œ í˜¸ì¶œí•˜ì§€ ì•Šê³ , ê° ì„¹ì…˜ì˜ 'ìƒˆë¡œê³ ì¹¨' ë²„íŠ¼ì„ ì´ìš©í•˜ê±°ë‚˜ ìµœì´ˆ 1íšŒë§Œ í˜¸ì¶œ
            
            if(secId === 'sec-orders') { /* ì£¼ë¬¸ì€ ìë™ê°±ì‹  ì•ˆí•¨ (ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì‚¬ìš© ê¶Œì¥) */ }
            if(secId === 'sec-bankda') loadBankdaList();
            
            // íšŒì› ëª©ë¡: ê²€ìƒ‰ì–´ ì—†ì„ ë• ë¡œë”© ì œí•œì„ ìœ„í•´ ì—¬ê¸°ì„  í˜¸ì¶œ ìƒëµ (ê²€ìƒ‰ ë²„íŠ¼ìœ¼ë¡œ ë¡œë“œ ìœ ë„)
            if(secId === 'sec-members') {
                const tbody = document.getElementById('memberListBody');
                // ë¹„ì–´ìˆì„ ë•Œë§Œ ì´ˆê¸° ë¡œë”© (50ëª… ì œí•œ)
                if(!tbody.hasChildNodes() || tbody.innerText.includes('ë¡œë”©')) loadMembers(); 
            }
            
            // í…œí”Œë¦¿: ë¹„ì–´ìˆì„ ë•Œë§Œ ì´ˆê¸° ë¡œë”©
            if(secId === 'sec-templates') { 
                const grid = document.getElementById('tplGrid');
                if(!grid.hasChildNodes()) {
                    loadProductKeys(); 
                    loadTemplates(); 
                }
            }
            
            if(secId === 'sec-fonts') loadFonts(); 
            if(secId === 'sec-products') { 
                // ìƒí’ˆ ëª©ë¡ì€ ë¹„ì–´ìˆì„ ë•Œë§Œ ë¡œë“œ
                const body = document.getElementById('prodTableBody');
                if(!body.hasChildNodes()) {
                    loadTopCategoriesList(); loadCategories(); loadSystemDB(); 
                }
            }
            if(secId === 'sec-staff') loadStaffList();
            if(secId === 'sec-withdrawals') loadWithdrawals();
            if(secId === 'sec-partner-apps') loadPartnerApplications();

            if(secId === 'sec-accounting') {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                const today = now.toISOString().split('T')[0];
                document.getElementById('accStartDate').value = firstDay;
                document.getElementById('accEndDate').value = today;
                // ê²°ì‚° ë°ì´í„°ëŠ” ë¬´ê±°ìš°ë¯€ë¡œ 'ì¡°íšŒ' ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ë¡œë”©í•˜ë„ë¡ ë³€ê²½ (ìë™ ë¡œë”© ì œê±°)
            }
        };
        
        window.logout = async () => { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await sb.auth.signOut(); location.href = "index.html"; } };
        window.closeModal = (id) => document.getElementById(id).style.display='none';
        function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

        // [ì‹ ê·œ] ì˜ˆì¹˜ê¸ˆ ëª¨ë‹¬ ì—´ê¸°
window.openWalletModal = (id, email, currentBalance) => {
    document.getElementById('walletTargetId').value = id;
    document.getElementById('walletTargetName').innerText = email;
    document.getElementById('walletTargetBalance').innerText = currentBalance.toLocaleString() + 'ì›';
    document.getElementById('walletAmount').value = '';
    document.getElementById('walletDesc').value = '';
    
    // ê¸°ë³¸ê°’: ì¶©ì „ ëª¨ë“œ
    setWalletMode('add');
    document.getElementById('walletModal').style.display = 'flex';
};

// [ì‹ ê·œ] ëª¨ë“œ ì „í™˜ (ì¶©ì „/ì°¨ê°)
window.setWalletMode = (mode) => {
    document.getElementById('walletMode').value = mode;
    const btnAdd = document.getElementById('btnWalletAdd');
    const btnSub = document.getElementById('btnWalletSub');
    
    if(mode === 'add') {
        btnAdd.className = 'btn btn-primary';
        btnSub.className = 'btn btn-outline';
        document.querySelector('#walletModal .btn-vip').innerText = 'ì¶©ì „í•˜ê¸° (ì§€ê¸‰)';
        document.querySelector('#walletModal .btn-vip').className = 'btn btn-primary';
    } else {
        btnAdd.className = 'btn btn-outline';
        btnSub.className = 'btn btn-danger';
        document.querySelector('#walletModal .btn-primary').innerText = 'ì°¨ê°í•˜ê¸° (íšŒìˆ˜)';
        document.querySelector('#walletModal .btn-primary').className = 'btn btn-danger';
    }
};

// [ì‹ ê·œ] ì˜ˆì¹˜ê¸ˆ ë³€ê²½ ì‹¤í–‰
window.submitWalletChange = async () => {
    const id = document.getElementById('walletTargetId').value;
    const mode = document.getElementById('walletMode').value;
    const amountStr = document.getElementById('walletAmount').value;
    const desc = document.getElementById('walletDesc').value;

    if(!amountStr || parseInt(amountStr) <= 0) return alert("ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    if(!desc) return alert("ê´€ë¦¬ ê¸°ë¡ì„ ìœ„í•´ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    const amount = parseInt(amountStr);
    const finalAmount = (mode === 'add') ? amount : -amount; // ì°¨ê°ì´ë©´ ìŒìˆ˜
    const type = (mode === 'add') ? 'admin_deposit' : 'admin_withdraw';

    if(!confirm(`${Math.abs(amount).toLocaleString()}ì›ì„ ${mode==='add'?'ì¶©ì „':'ì°¨ê°'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
        // 1. í”„ë¡œí•„ ì”ì•¡ ì—…ë°ì´íŠ¸ (RPC í•¨ìˆ˜ê°€ ì—†ìœ¼ë¯€ë¡œ ì¡°íšŒ í›„ ì—…ë°ì´íŠ¸ ë°©ì‹ ì‚¬ìš© - ê°„ë‹¨ êµ¬í˜„)
        // â€» ë” ì•ˆì „í•˜ê²Œ í•˜ë ¤ë©´ Supabase RPC(Database Function)ì„ ë§Œë“¤ì–´ ì“°ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
        
        // í˜„ì¬ ì”ì•¡ ê°€ì ¸ì˜¤ê¸°
        const { data: profile } = await sb.from('profiles').select('deposit').eq('id', id).single();
        const currentDeposit = profile ? (profile.deposit || 0) : 0;
        const newDeposit = currentDeposit + finalAmount;

        // ì”ì•¡ ì—…ë°ì´íŠ¸
        const { error: updateErr } = await sb.from('profiles').update({ deposit: newDeposit }).eq('id', id);
        if(updateErr) throw updateErr;

        // 2. ë¡œê·¸ ê¸°ë¡ (wallet_logs)
        const { error: logErr } = await sb.from('wallet_logs').insert({
            user_id: id,
            type: type,
            amount: finalAmount,
            description: `[ê´€ë¦¬ì] ${desc}`
        });
        
        if(logErr) console.warn("ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:", logErr);

        alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        closeModal('walletModal');
        loadMembers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨

    } catch(e) {
        alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
    }
};

        // ==========================================
        // [ì¶”ê°€] ë±…í¬ë‹¤(Bankda) ê´€ë ¨ í•¨ìˆ˜
        // ==========================================
        window.loadBankdaList = async () => {
            let start = document.getElementById('bankStartDate').value;
            let end = document.getElementById('bankEndDate').value;
            
            if(!start || !end) { 
                const now = new Date(); 
                end = now.toISOString().split('T')[0];
                const weekAgo = new Date(now);
                weekAgo.setDate(now.getDate() - 7);
                start = weekAgo.toISOString().split('T')[0];
                document.getElementById('bankStartDate').value = start;
                document.getElementById('bankEndDate').value = end;
            }

            showLoading(true);
            const tbody = document.getElementById('bankListBody');
            tbody.innerHTML = '';

            try {
                // 1. ì£¼ë¬¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ë§¤ì¹­ìš©)
                const { data: orders } = await sb.from('orders')
                    .select('id, manager_name, total_amount, payment_status, created_at')
                    .gte('created_at', start + 'T00:00:00')
                    .neq('payment_status', 'ê²°ì œì™„ë£Œ');

                // 2. ì…ê¸ˆ ë‚´ì—­ ê°€ì ¸ì˜¤ê¸° (ê°€ì •ëœ í…Œì´ë¸”: bank_transactions)
                const { data: transactions, error } = await sb.from('bank_transactions')
                    .select('*')
                    .gte('transaction_date', start + 'T00:00:00')
                    .lte('transaction_date', end + 'T23:59:59')
                    .order('transaction_date', { ascending: false });

                if (error) {
                    console.error(error);
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px; color:red;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (í…Œì´ë¸” í™•ì¸ í•„ìš”)</td></tr>`;
                    showLoading(false);
                    return;
                }

                if (!transactions || transactions.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:30px; color:#999;">ê¸°ê°„ ë‚´ ì…ê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                    showLoading(false);
                    return;
                }

                transactions.forEach(tx => {
                    // ë§¤ì¹­ ë¡œì§ (ë‹¨ìˆœ ì´ë¦„ ë§¤ì¹­)
                    const matchOrder = orders.find(o => 
                        o.manager_name === tx.depositor && 
                        Math.abs((o.total_amount || 0) - tx.amount) < 100 // ê¸ˆì•¡ ì˜¤ì°¨ë²”ìœ„ 100ì›
                    );

                    let statusBadge = '<span class="badge" style="background:#f1f5f9; color:#94a3b8;">ë¯¸ë§¤ì¹­</span>';
                    let actionBtn = `<button class="btn btn-outline btn-sm" onclick="matchOrderManual('${tx.id}', '${tx.depositor}')">ìˆ˜ë™ ì—°ê²°</button>`;

                    if (matchOrder) {
                        statusBadge = `<span class="badge" style="background:#dcfce7; color:#166534; border:1px solid #bbf7d0;">âœ… ë§¤ì¹­ë¨ (${matchOrder.manager_name})</span>`;
                        actionBtn = `<button class="btn btn-success btn-sm" onclick="confirmBankMatch('${tx.id}', '${matchOrder.id}')">ì…ê¸ˆí™•ì¸ ì²˜ë¦¬</button>`;
                    } else if (tx.match_status === 'matched') {
                        statusBadge = `<span class="badge" style="background:#e0e7ff; color:#3730a3;">ì²˜ë¦¬ì™„ë£Œ</span>`;
                        actionBtn = `-`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td>${new Date(tx.transaction_date).toLocaleString()}</td>
                            <td style="font-weight:bold;">${tx.depositor}</td>
                            <td style="text-align:right; font-weight:bold; color:#0f172a;">${tx.amount.toLocaleString()}ì›</td>
                            <td><span style="font-size:12px; color:#666;">${tx.bank_name || 'ì€í–‰'}</span></td>
                            <td>${statusBadge}</td>
                            <td>${actionBtn}</td>
                        </tr>
                    `;
                });

            } catch(e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">ì˜¤ë¥˜: ${e.message}</td></tr>`;
            } finally {
                showLoading(false);
            }
        };

        window.runBankdaScraping = async () => {
            if(!confirm("ğŸ¦ í˜ì´ì—‘ì…˜(êµ­ë¯¼ì€í–‰) ì…ê¸ˆë‚´ì—­ì„ ì¡°íšŒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ìµœì‹  ë‚´ì—­ì„ DBë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤)")) return;
            
            showLoading(true);
            try {
                // 1. Supabase Edge Function (bank-scraper) í˜¸ì¶œ
                const { data, error } = await sb.functions.invoke('bank-scraper', {
                    method: 'POST',
                    body: {} 
                });

                if (error) throw new Error(error.message);
                if (data && data.error) throw new Error(data.error);

                const count = data.count || 0;
                const msg = data.message || "ì™„ë£Œ";
                alert(`âœ… ${msg} (ì´ ${count}ê±´ í™•ì¸)`);
                
                // 2. í™”ë©´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadBankdaList(); 

            } catch(e) {
                console.error(e);
                alert("ì—°ë™ ì‹¤íŒ¨: " + e.message);
            } finally {
                showLoading(false);
            }
        };

        window.confirmBankMatch = async (txId, orderId) => {
            if(!confirm("ì´ ì…ê¸ˆë‚´ì—­ìœ¼ë¡œ ì£¼ë¬¸ì„ 'ê²°ì œì™„ë£Œ' ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                // 1. ì£¼ë¬¸ ì—…ë°ì´íŠ¸
                const { error: ordErr } = await sb.from('orders').update({
                    payment_status: 'ê²°ì œì™„ë£Œ',
                    payment_method: 'ë¬´í†µì¥ì…ê¸ˆ'
                }).eq('id', orderId);
                if(ordErr) throw ordErr;

                // 2. ë±…í¬ë‹¤ í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€)
                const { error: txErr } = await sb.from('bank_transactions').update({
                    match_status: 'matched',
                    matched_order_id: orderId
                }).eq('id', txId);
                
                alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadBankdaList();
            } catch(e) {
                alert("ì²˜ë¦¬ ì‹¤íŒ¨: " + e.message);
            }
        };
        
        // ==========================================
        // ê¸°ì¡´ í•¨ìˆ˜ë“¤ (ìœ ì§€)
        // ==========================================
        // [ìˆ˜ì •ë¨] ëŒ€ë¶„ë¥˜ ëª©ë¡ ë¡œë“œ ë° ë“œë˜ê·¸ ê¸°ëŠ¥ ì¶”ê°€
window.loadTopCategoriesList = async () => {
    const listArea = document.getElementById('topCategoryListArea');
    if(!listArea) return;
    listArea.innerHTML = '';

    // sort_order ìˆœìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
    const { data } = await sb.from('admin_top_categories').select('*').order('sort_order', { ascending: true });
    
    if(data) {
        data.forEach(cat => {
            const span = document.createElement('span');
            // 'draggable' í´ë˜ìŠ¤ ì¶”ê°€
            span.className = 'badge draggable';
            // ë“œë˜ê·¸ ê°€ëŠ¥ ì†ì„± true
            span.draggable = true;
            span.dataset.id = cat.id;
            
            // ìŠ¤íƒ€ì¼: cursor:grab ì¶”ê°€ë¨
            span.style.cssText = "border:1px solid #fdba74; color:#c2410c; background:#fff7ed; margin-right:5px; margin-bottom:5px; display:inline-block; padding:6px 10px; cursor:grab; user-select:none;";
            
            span.innerHTML = `<b>${cat.name}</b> (${cat.code}) 
                <i class="fa-solid fa-pen" style="font-size:10px; margin-left:5px; color:#aaa; cursor:pointer;" onclick="editTopCategoryLoad(${cat.id})"></i>
                <i class="fa-solid fa-xmark" style="font-size:10px; margin-left:5px; color:#ef4444; cursor:pointer;" onclick="deleteTopCategoryDB(${cat.id})"></i>`;
            
            // [ë“œë˜ê·¸ ì´ë²¤íŠ¸] ì‹œì‘
            span.addEventListener('dragstart', () => span.classList.add('dragging'));
            
            // [ë“œë˜ê·¸ ì´ë²¤íŠ¸] ì¢…ë£Œ (ìˆœì„œ ì €ì¥)
            span.addEventListener('dragend', async () => {
                span.classList.remove('dragging');
                await saveTopCategoryOrder(); // ìˆœì„œ ì €ì¥ í•¨ìˆ˜ í˜¸ì¶œ
            });

            listArea.appendChild(span);
        });

        // [ì»¨í…Œì´ë„ˆ ì´ë²¤íŠ¸] ë“œë˜ê·¸ ì¤‘ ìœ„ì¹˜ ê³„ì‚° (ê¸°ì¡´ getDragAfterElementX í•¨ìˆ˜ ì¬ì‚¬ìš©)
        listArea.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElementX(listArea, e.clientX);
            const draggable = document.querySelector('.badge.dragging');
            if (afterElement == null) {
                listArea.appendChild(draggable);
            } else {
                listArea.insertBefore(draggable, afterElement);
            }
        });
    }
};

// [ì‹ ê·œ] ëŒ€ë¶„ë¥˜ ìˆœì„œ ì €ì¥ í•¨ìˆ˜
async function saveTopCategoryOrder() {
    // topCategoryListArea ì•ˆì— ìˆëŠ” ë°°ì§€ë“¤ì„ ìˆœì„œëŒ€ë¡œ ê°€ì ¸ì˜´
    const badges = document.querySelectorAll('#topCategoryListArea .badge');
    const updates = [];
    
    badges.forEach((b, i) => {
        // i+1ì„ í•˜ì—¬ sort_orderë¥¼ 1, 2, 3... ìˆœìœ¼ë¡œ ì—…ë°ì´íŠ¸
        updates.push(sb.from('admin_top_categories').update({ sort_order: i + 1 }).eq('id', b.dataset.id));
    });
    
    // ë¹„ë™ê¸° ë³‘ë ¬ ì²˜ë¦¬ë¡œ DB ì—…ë°ì´íŠ¸
    await Promise.all(updates);
    // console.log("ëŒ€ë¶„ë¥˜ ìˆœì„œ ì €ì¥ ì™„ë£Œ");
}

        window.addTopCategoryDB = async () => {
    const codeRaw = document.getElementById('newTopCatCode').value;
    const name = document.getElementById('newTopCatName').value;
    const name_jp = document.getElementById('newTopCatNameJP').value;
    const name_us = document.getElementById('newTopCatNameUS').value;
    
    // [ì¶”ê°€] ì„¤ëª… ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const description = document.getElementById('newTopCatDesc').value;
    const description_jp = document.getElementById('newTopCatDescJP').value;
    const description_us = document.getElementById('newTopCatDescUS').value;

            if (!codeRaw || !name) return alert("í•„ìˆ˜í•­ëª© ëˆ„ë½: ì½”ë“œì™€ í•œêµ­ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
            const code = codeRaw.toLowerCase().replace(/\s/g, '_');

            try {
                // ì¤‘ë³µ ì²´í¬ ë° ìˆœì„œ ê³„ì‚°
                const { data: exist } = await sb.from('admin_top_categories').select('id, sort_order').eq('code', code).single();
                let nextOrder = 1;
                
                if (exist) {
                    if (!confirm(`âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ëŒ€ë¶„ë¥˜ ì½”ë“œì…ë‹ˆë‹¤: '${code}'\nìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                    nextOrder = exist.sort_order;
                } else {
                    const { data: maxData } = await sb.from('admin_top_categories').select('sort_order').order('sort_order', { ascending: false }).limit(1);
                    if (maxData && maxData.length > 0) nextOrder = (maxData[0].sort_order || 0) + 1;
                }

                // DB ì €ì¥ (upsert)
        const { error } = await sb.from('admin_top_categories').upsert([{
            code, name, name_jp, name_us, 
            description, description_jp, description_us, // [ì¶”ê°€] ì„¤ëª… ì»¬ëŸ¼ ì €ì¥
            sort_order: nextOrder
        }], { onConflict: 'code' });

        if (error) throw error;
        alert("âœ… ëŒ€ë¶„ë¥˜ ì €ì¥ ì™„ë£Œ");
        
        // ì…ë ¥ì°½ ì´ˆê¸°í™”
        document.getElementById('newTopCatCode').value = '';
        document.getElementById('newTopCatName').value = '';
        document.getElementById('newTopCatNameJP').value = '';
        document.getElementById('newTopCatNameUS').value = '';
        document.getElementById('newTopCatDesc').value = '';     // [ì¶”ê°€] ì´ˆê¸°í™”
        document.getElementById('newTopCatDescJP').value = '';   // [ì¶”ê°€] ì´ˆê¸°í™”
        document.getElementById('newTopCatDescUS').value = '';   // [ì¶”ê°€] ì´ˆê¸°í™”
                
                loadTopCategoriesList(); // ëª©ë¡ ê°±ì‹ 
                loadCategories(); // ì†Œë¶„ë¥˜ ì„ íƒë°•ìŠ¤ë„ ê°±ì‹ 

            } catch (e) {
                alert("ì €ì¥ ì˜¤ë¥˜: " + e.message);
            }
        };

        window.editTopCategoryLoad = async (id) => {
    const { data } = await sb.from('admin_top_categories').select('*').eq('id', id).single();
    if (data) {
        window.editingTopCatId = id; 
        document.getElementById('newTopCatCode').value = data.code;
        document.getElementById('newTopCatName').value = data.name;
        document.getElementById('newTopCatNameJP').value = data.name_jp || '';
        document.getElementById('newTopCatNameUS').value = data.name_us || '';
        
        // [ì¶”ê°€] ì„¤ëª… ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        document.getElementById('newTopCatDesc').value = data.description || '';
        document.getElementById('newTopCatDescJP').value = data.description_jp || '';
        document.getElementById('newTopCatDescUS').value = data.description_us || '';
        
        document.querySelector('#sec-products .card').scrollIntoView({ behavior: 'smooth' });
    }
};

        window.deleteTopCategoryDB = async (id) => {
            if(!confirm("ì´ ëŒ€ë¶„ë¥˜ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì—°ê²°ëœ ì†Œë¶„ë¥˜ê°€ ìˆë‹¤ë©´ ì—°ê²°ì´ ëŠì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)")) return;
            try {
                const { error } = await sb.from('admin_top_categories').delete().eq('id', id);
                if(error) throw error;
                loadTopCategoriesList();
                loadCategories();
            } catch(e) {
                alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
            }
        };

        // ëŒ€ë¶„ë¥˜ ìë™ ë²ˆì—­
        // [3] ìë™ ë²ˆì—­ í•¨ìˆ˜ ì—…ë°ì´íŠ¸ (ì„¤ëª…ê¹Œì§€ ë²ˆì—­)
window.autoTranslateTopCategoryInputs = async () => {
    const krName = document.getElementById('newTopCatName').value;
    const krDesc = document.getElementById('newTopCatDesc').value; // [ì¶”ê°€] ì„¤ëª… ì›ë³¸

    if (!krName) return alert("í•œêµ­ì–´ ëª…ì¹­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    const btn = document.querySelector('button[onclick="autoTranslateTopCategoryInputs()"]');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ë²ˆì—­ ì¤‘...';
    btn.disabled = true;

    const translate = async (text, targetLang) => {
        if(!text) return "";
        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=${targetLang}&dt=t&q=${encodeURI(text)}`;
        const res = await fetch(url);
        const data = await res.json();
        // ê¸´ ë¬¸ì¥(ì—¬ëŸ¬ ì¤„)ì¼ ê²½ìš° í•©ì¹˜ê¸°
        return data[0].map(x => x[0]).join('');
    };

    try {
        // ì´ë¦„ ë²ˆì—­
        document.getElementById('newTopCatNameJP').value = await translate(krName, 'ja');
        document.getElementById('newTopCatNameUS').value = await translate(krName, 'en');

        // [ì¶”ê°€] ì„¤ëª… ë²ˆì—­ (ë‚´ìš©ì´ ìˆì„ ë•Œë§Œ)
        if(krDesc) {
            document.getElementById('newTopCatDescJP').value = await translate(krDesc, 'ja');
            document.getElementById('newTopCatDescUS').value = await translate(krDesc, 'en');
        }

        alert("âœ… ë²ˆì—­ ì™„ë£Œ!");
    } catch(e) {
                console.error(e);
                alert("ë²ˆì—­ ì‹¤íŒ¨");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        // ==========================================
        // [ì‹ ê·œ] ì†Œë¶„ë¥˜ ë‹¨ê±´ ìë™ ë²ˆì—­
        // ==========================================
        window.autoTranslateCategoryInputs = async () => {
    const krName = document.getElementById('newCatName').value;
    const krDesc = document.getElementById('newCatDesc').value; // ì„¤ëª… ì›ë³¸

    if (!krName) return alert("í•œêµ­ì–´ ëª…ì¹­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    const btn = document.querySelector('button[onclick="autoTranslateCategoryInputs()"]');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
    btn.disabled = true;

    const translate = async (text, targetLang) => {
        if(!text) return "";
        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=${targetLang}&dt=t&q=${encodeURI(text)}`;
        const res = await fetch(url);
        const data = await res.json();
        return data[0].map(x => x[0]).join(''); // ì—¬ëŸ¬ ë¬¸ì¥ í•©ì¹˜ê¸°
    };

    try {
        // ì´ë¦„ ë²ˆì—­
        document.getElementById('newCatNameJP').value = await translate(krName, 'ja');
        document.getElementById('newCatNameUS').value = await translate(krName, 'en');

        // [ì¶”ê°€] ì„¤ëª… ë²ˆì—­
        if(krDesc) {
            document.getElementById('newCatDescJP').value = await translate(krDesc, 'ja');
            document.getElementById('newCatDescUS').value = await translate(krDesc, 'en');
        }

        alert("âœ… ë²ˆì—­ ì™„ë£Œ!");
    } catch(e) {
        console.error(e);
        alert("ë²ˆì—­ ì‹¤íŒ¨");
    } finally {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
    }
};
        // [ê¸°ì¡´ ë³€ìˆ˜ë“¤ ì•„ë˜ì— ì¶”ê°€]
let currentTplPage = 1;     // í˜„ì¬ í…œí”Œë¦¿ í˜ì´ì§€
const tplItemsPerPage = 10; // í•œ í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ ê°œìˆ˜ (10ê°œ)

        // ==========================================
        // [ì‹ ê·œ] ì¹´í…Œê³ ë¦¬ ì¼ê´„ ë²ˆì—­ (Bulk) - ëŒ€ë¶„ë¥˜+ì†Œë¶„ë¥˜ ëª¨ë‘ ì²˜ë¦¬
        // ==========================================
        window.bulkTranslateCategories = async () => {
            if (!confirm("ì „ì²´ ì¹´í…Œê³ ë¦¬(ëŒ€ë¶„ë¥˜/ì†Œë¶„ë¥˜) ì¤‘ ë²ˆì—­ì´ ë¹ˆ ê³³ì„ ìë™ìœ¼ë¡œ ì±„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?\nì‹œê°„ì´ ì¡°ê¸ˆ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")) return;
            
            // ë²ˆì—­ í•¨ìˆ˜ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
            const safeTranslate = async (text, targetLang) => {
                if (!text) return "";
                let attempt = 0;
                const maxRetries = 5;
                while (attempt < maxRetries) {
                    try {
                        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=${targetLang}&dt=t&q=${encodeURI(text)}`;
                        const res = await fetch(url);
                        if (!res.ok) throw new Error("API Limit");
                        const data = await res.json();
                        return data[0][0][0];
                    } catch (e) {
                        attempt++;
                        console.warn(`Retry ${attempt}...`);
                        await new Promise(r => setTimeout(r, 20000)); // 20ì´ˆ ëŒ€ê¸°
                    }
                }
                return text;
            };

            const delay = (ms) => new Promise(r => setTimeout(r, ms));

            try {
                let count = 0;

                // 1. ëŒ€ë¶„ë¥˜ ì²˜ë¦¬
                const { data: topCats } = await sb.from('admin_top_categories').select('*');
                const targetTop = topCats.filter(c => c.name && (!c.name_jp || !c.name_us));
                
                for (const c of targetTop) {
                    const updates = {};
                    let needsUpdate = false;
                    if (!c.name_jp) { updates.name_jp = await safeTranslate(c.name, 'ja'); needsUpdate = true; await delay(1000); }
                    if (!c.name_us) { updates.name_us = await safeTranslate(c.name, 'en'); needsUpdate = true; await delay(1000); }
                    if (needsUpdate) { await sb.from('admin_top_categories').update(updates).eq('id', c.id); count++; }
                }

                // 2. ì†Œë¶„ë¥˜ ì²˜ë¦¬
                const { data: cats } = await sb.from('admin_categories').select('*');
                const targetCats = cats.filter(c => c.name && (!c.name_jp || !c.name_us));
                
                for (const c of targetCats) {
                    const updates = {};
                    let needsUpdate = false;
                    if (!c.name_jp) { updates.name_jp = await safeTranslate(c.name, 'ja'); needsUpdate = true; await delay(1000); }
                    if (!c.name_us) { updates.name_us = await safeTranslate(c.name, 'en'); needsUpdate = true; await delay(1000); }
                    if (needsUpdate) { await sb.from('admin_categories').update(updates).eq('id', c.id); count++; }
                }

                alert(`âœ… ì´ ${count}ê°œ ì¹´í…Œê³ ë¦¬(ëŒ€/ì†Œë¶„ë¥˜ í†µí•©) ë²ˆì—­ ì™„ë£Œ!`);
                loadTopCategoriesList();
                loadCategories(); 

            } catch (e) {
                alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            }
        };

        // ==========================================
        // [ì‹ ê·œ] ìë™ ë²ˆì—­ ë° í™˜ìœ¨ ê³„ì‚° í•¨ìˆ˜ (ë‹¨ê±´) - ìƒí’ˆìš©
        // ==========================================
        window.autoTranslateInputs = async () => {
    const krName = document.getElementById('newProdName').value;
    const krPrice = document.getElementById('newProdPrice').value;
    const krDesc = document.getElementById('newProdDesc').value; // ì„¤ëª… ì¶”ê°€
    const wMM = document.getElementById('newProdW').value || 0;
    const hMM = document.getElementById('newProdH').value || 0;

    if (!krName) return alert("í•œêµ­ì–´ ìƒí’ˆëª…ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
    
    const btn = document.querySelector('button[onclick="autoTranslateInputs()"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ë³€í™˜ ì¤‘...';
    btn.disabled = true;

    try {
        const rateJPY = 0.2; 
        const rateUSD = 0.002;

        if(krPrice) {
            document.getElementById('newProdPriceJP').value = Math.round(krPrice * rateJPY);
            document.getElementById('newProdPriceUS').value = (krPrice * rateUSD).toFixed(2);
        }

        const translate = async (text, targetLang) => {
            if(!text) return "";
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=${targetLang}&dt=t&q=${encodeURI(text)}`;
            const res = await fetch(url);
            const data = await res.json();
            return data[0].map(x => x[0]).join('');
        };

        // ì´ë¦„ ë²ˆì—­
        document.getElementById('newProdNameJP').value = await translate(krName, 'ja');
        let usName = await translate(krName, 'en');
        
        // í”¼íŠ¸(ft) ë‹¨ìœ„ ë³€í™˜ ë° ì¶”ê°€
        if (wMM > 0 && hMM > 0) {
            const wFt = (wMM * 0.00328084).toFixed(1);
            const hFt = (hMM * 0.00328084).toFixed(1);
            usName += ` (${wFt} x ${hFt} ft)`;
        }
        document.getElementById('newProdNameUS').value = usName;

        // [ì¶”ê°€] ì„¤ëª… ë²ˆì—­
        if(krDesc) {
            document.getElementById('newProdDescJP').value = await translate(krDesc, 'ja');
            document.getElementById('newProdDescUS').value = await translate(krDesc, 'en');
        }

        alert("âœ… ë³€í™˜ ì™„ë£Œ! (ì„¤ëª… í¬í•¨)");

    } catch (e) {
        console.error(e);
        alert("ë²ˆì—­ ì¤‘ ì˜¤ë¥˜: " + e.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
};

        // ==========================================
        // [ì‹ ê·œ] ìë™ ë²ˆì—­ ë° í™˜ìœ¨ ê³„ì‚° í•¨ìˆ˜ (ë‹¨ê±´) - ì˜µì…˜ìš©
        // ==========================================
        window.autoTranslateAddonInputs = async () => {
            const krName = document.getElementById('nmKR').value;
            const krPrice = document.getElementById('prKR').value;

            if (!krName) return alert("í•œêµ­ì–´ ëª…ì¹­ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
            // ê°€ê²©ì´ 0ì›ì¼ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ë¹ˆê°’ë§Œ ì²´í¬
            if (krPrice === '') return alert("í•œêµ­ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const btn = document.querySelector('button[onclick="autoTranslateAddonInputs()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ë³€í™˜ ì¤‘...';
            btn.disabled = true;

            try {
                const rateJPY = 0.115;
                const rateUSD = 0.001;

                // ê°€ê²© ê³„ì‚°
                document.getElementById('prJP').value = Math.round(krPrice * rateJPY);
                document.getElementById('prUS').value = (krPrice * rateUSD).toFixed(2);

                const translate = async (text, targetLang) => {
                    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=${targetLang}&dt=t&q=${encodeURI(text)}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    return data[0][0][0];
                };

                // ì¼ë³¸ì–´ ë²ˆì—­
                document.getElementById('nmJP').value = await translate(krName, 'ja');

                // ì˜ì–´ ë²ˆì—­ (ì˜µì…˜ì€ ì‚¬ì´ì¦ˆê°€ ì—†ìœ¼ë¯€ë¡œ í”¼íŠ¸ ë³€í™˜ ì—†ìŒ)
                document.getElementById('nmUS').value = await translate(krName, 'en');

                alert("âœ… ì˜µì…˜ ë³€í™˜ ì™„ë£Œ!");

            } catch(e) {
                console.error(e);
                alert("ì˜¤ë¥˜: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // ============================================================
// [ì‹ ê·œ] ê°€ë§¹ì  ì‹ ì²­ ê´€ë¦¬ ê¸°ëŠ¥ (admin.html ìŠ¤í¬ë¦½íŠ¸ ë§¨ ëì— ì¶”ê°€)
// ============================================================

// 1. ì‹ ì²­ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
window.loadPartnerApplications = async () => {
    const tbody = document.getElementById('partnerAppListBody');
    if (!tbody) return; // í•´ë‹¹ ì„¹ì…˜ì´ ì—†ìœ¼ë©´ íŒ¨ìŠ¤
    
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;"><div class="spinner"></div></td></tr>';

    try {
        // ëŒ€ê¸°ì¤‘(pending)ì¸ ì‹ ì²­ì„œë§Œ ê°€ì ¸ì˜¤ê¸°
        const { data: apps, error } = await sb
            .from('partner_applications')
            .select('*')
            .eq('status', 'pending')
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!apps || apps.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#999;">ëŒ€ê¸° ì¤‘ì¸ ê°€ë§¹ì  ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            updateBadge(0);
            return;
        }

        updateBadge(apps.length); // ë±ƒì§€ ì—…ë°ì´íŠ¸

        // ì‹ ì²­ìë“¤ì˜ ì´ë©”ì¼ì„ ì•Œê¸° ìœ„í•´ profiles ì¡°íšŒ
        const userIds = apps.map(a => a.user_id);
        const { data: profiles } = await sb.from('profiles').select('id, email').in('id', userIds);
        const emailMap = {};
        if (profiles) profiles.forEach(p => emailMap[p.id] = p.email);

        tbody.innerHTML = '';
        
        apps.forEach(app => {
            const email = emailMap[app.user_id] || 'ì´ë©”ì¼ ì—†ìŒ';
            
            tbody.innerHTML += `
                <tr>
                    <td>${new Date(app.created_at).toLocaleDateString()} <span style="font-size:11px; color:#888;">${new Date(app.created_at).toLocaleTimeString()}</span></td>
                    <td>
                        <div style="font-weight:bold; color:#334155;">${email}</div>
                        <div style="font-size:11px; color:#94a3b8;">UID: ${app.user_id.substring(0,8)}...</div>
                    </td>
                    <td style="font-weight:bold;">${app.company_name}</td>
                    <td>${app.contact_phone}</td>
                    <td><span class="badge" style="background:#e0e7ff; color:#4338ca;">${app.region}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="approvePartnerApp('${app.id}', '${app.user_id}', '${app.region}', '${app.company_name}')">
                            âœ… ìŠ¹ì¸
                        </button>
                    </td>
                </tr>
            `;
        });

    } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">ë¡œë“œ ì˜¤ë¥˜: ${e.message}</td></tr>`;
    }
};

// 2. [í•µì‹¬] ê°€ë§¹ì  ìŠ¹ì¸ ì²˜ë¦¬ (ì›ìŠ¤í†±)
window.approvePartnerApp = async (appId, userId, region, companyName) => {
    if (!confirm(`[ìŠ¹ì¸ í™•ì¸]\n\nì—…ì²´ëª…: ${companyName}\nì§€ì—­: ${region}\n\nì´ íšŒì›ì„ 'ê°€ë§¹ì (Franchise)' ë“±ê¸‰ìœ¼ë¡œ ìŠ¹ê²©ì‹œí‚¤ê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
        // [1ë‹¨ê³„] í”„ë¡œí•„ í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ë“±ê¸‰ ë³€ê²½ + ì§€ì—­ ì„¤ì •)
        const { error: profileErr } = await sb
            .from('profiles')
            .update({ 
                role: 'franchise',   // ë“±ê¸‰ì„ ê°€ë§¹ì ìœ¼ë¡œ!
                region: region       // ì‹ ì²­í•œ ì§€ì—­ ìë™ ì…ë ¥
            })
            .eq('id', userId);

        if (profileErr) throw profileErr;

        // [2ë‹¨ê³„] ì‹ ì²­ì„œ ìƒíƒœë¥¼ 'approved'ë¡œ ë³€ê²½ (ëª©ë¡ì—ì„œ ì‚¬ë¼ì§€ê²Œ)
        const { error: appErr } = await sb
            .from('partner_applications')
            .update({ status: 'approved' })
            .eq('id', appId);

        if (appErr) throw appErr;

        alert(`ğŸ‰ ìŠ¹ì¸ ì™„ë£Œ!\nì´ì œ '${companyName}'ë‹˜ì€ íŒŒíŠ¸ë„ˆìŠ¤ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        loadPartnerApplications(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨

    } catch (e) {
        alert("ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
    }
};

// ë±ƒì§€ ìˆ«ì í‘œì‹œ í—¬í¼
function updateBadge(count) {
    const badge = document.getElementById('partnerPendingCount');
    if(badge) {
        if(count > 0) {
            badge.style.display = 'inline-block';
            badge.innerText = count;
        } else {
            badge.style.display = 'none';
        }
    }
}

// (ì„ íƒ) í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ í•¨ìˆ˜ë“¤ê³¼ í•¨ê»˜ ì‹¤í–‰ë˜ë„ë¡ ìˆ˜ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ
// ë§Œì•½ ê¸°ì¡´ showSection í•¨ìˆ˜ê°€ ìˆë‹¤ë©´ ê±°ê¸°ì— 'sec-partner-apps' ì¼€ì´ìŠ¤ë¥¼ ì¶”ê°€í•´ì•¼ í•¨.
// í•˜ì§€ë§Œ ì¼ë‹¨ ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€í•´ë“œë¦½ë‹ˆë‹¤.

// ê¸°ì¡´ showSection í•¨ìˆ˜ ë®ì–´ì“°ê¸° (admin.html ì•ˆì— ìˆëŠ” í•¨ìˆ˜)
const originalShowSection = window.showSection;
window.showSection = (secId, navEl) => {
    // ê¸°ì¡´ ê¸°ëŠ¥ ì‹¤í–‰
    document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
    document.getElementById(secId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    if(navEl) navEl.classList.add('active');

    // ê¸°ì¡´ ì„¹ì…˜ë³„ ë¡œë“œ
    if(secId === 'sec-orders') loadOrders();
    if(secId === 'sec-vip') loadVipOrders();
    if(secId === 'sec-bankda') loadBankdaList();
    if(secId === 'sec-stats') loadStatsData();
    if(secId === 'sec-members') loadMembers();
    if(secId === 'sec-templates') { loadTemplates(); loadProductKeys(); }
    if(secId === 'sec-fonts') loadFonts(); 
    if(secId === 'sec-products') { loadTopCategoriesList(); loadCategories(); loadSystemDB(); }
    if(secId === 'sec-staff') loadStaffList();
    if(secId === 'sec-withdrawals') loadWithdrawals();

    // â˜… [ì¶”ê°€ë¨] ê°€ë§¹ì  ì‹ ì²­ íƒ­ í´ë¦­ ì‹œ ë¡œë“œ
    if(secId === 'sec-partner-apps') loadPartnerApplications();
};

        // ==========================================
        // [ìµœì¢… ê°•í™”íŒ] ì°¨ë‹¨ ê°ì§€ ë° ìë™ ì¬ì‹œë„ ê¸°ëŠ¥ í¬í•¨ëœ ì¼ê´„ ë²ˆì—­
        // ==========================================
        window.bulkTranslateAll = async () => {
            if (!confirm("ì „ì²´ ìƒí’ˆê³¼ ì˜µì…˜ì„ ë²ˆì—­í•©ë‹ˆë‹¤.\n\nâ€» êµ¬ê¸€ API ì°¨ë‹¨ ì‹œ ìë™ìœ¼ë¡œ 30ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤.\nì™„ë£Œ ë©”ì‹œì§€ê°€ ëœ° ë•Œê¹Œì§€ ì°½ì„ ë‹«ì§€ ë§ˆì„¸ìš”.")) return;

            const btn = document.getElementById('btnBulkTranslate');
            const originalText = btn.innerHTML;
            btn.disabled = true;

            // í™˜ìœ¨ ì„¤ì • (10ë§Œì› -> 100ë‹¬ëŸ¬)
            const rateJPY = 0.115; 
            const rateUSD = 0.001; 

            // [í•µì‹¬] ì¬ì‹œë„(Retry) ê¸°ëŠ¥ì´ ìˆëŠ” ë²ˆì—­ í•¨ìˆ˜
            const safeTranslate = async (text, targetLang) => {
                if (!text) return "";
                let attempt = 0;
                const maxRetries = 10; // ìµœëŒ€ 10ë²ˆê¹Œì§€ ì¬ì‹œë„

                while (attempt < maxRetries) {
                    try {
                        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=${targetLang}&dt=t&q=${encodeURI(text)}`;
                        const res = await fetch(url);

                        if (!res.ok) throw new Error(`ì°¨ë‹¨ë¨ (${res.status})`);

                        const data = await res.json();
                        return data[0][0][0]; 

                    } catch (e) {
                        attempt++;
                        console.warn(`[ì¬ì‹œë„ ${attempt}/${maxRetries}] êµ¬ê¸€ API ì°¨ë‹¨ ê°ì§€. 30ì´ˆ ëŒ€ê¸°í•©ë‹ˆë‹¤...`);
                        
                        btn.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> API ëŒ€ê¸°ì¤‘... (${attempt}íšŒ ì¬ì‹œë„)`;
                        
                        await new Promise(r => setTimeout(r, 30000));
                    }
                }
                return text; 
            };

            const delay = (ms) => new Promise(res => setTimeout(res, ms));

            try {
                // 1. ìƒí’ˆ (Products)
                const { data: allProds } = await sb.from('admin_products').select('*');
                const targetProds = allProds.filter(p => p.name && (!p.name_jp || !p.name_us || !p.price_jp || !p.price_us));
                
                let pCount = 0;
                for (const p of targetProds) {
                    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ìƒí’ˆ ë²ˆì—­ì¤‘ (${pCount + 1}/${targetProds.length})`;
                    
                    const updates = {};
                    let needsUpdate = false;

                    if (!p.name_jp) {
                        updates.name_jp = await safeTranslate(p.name, 'ja');
                        needsUpdate = true;
                        await delay(1000); 
                    }
                    if (!p.price_jp) {
                        updates.price_jp = Math.round(p.price * rateJPY);
                        needsUpdate = true;
                    }

                    if (!p.name_us) {
                        let enName = await safeTranslate(p.name, 'en');
                        if (p.width_mm > 0 && p.height_mm > 0) {
                            const wFt = (p.width_mm * 0.00328084).toFixed(1);
                            const hFt = (p.height_mm * 0.00328084).toFixed(1);
                            enName += ` (${wFt} x ${hFt} ft)`;
                        }
                        updates.name_us = enName;
                        needsUpdate = true;
                        await delay(1000); 
                    }
                    if (!p.price_us) {
                        updates.price_us = (p.price * rateUSD).toFixed(2);
                        needsUpdate = true;
                    }

                    if (needsUpdate) {
                        await sb.from('admin_products').update(updates).eq('id', p.id);
                        pCount++;
                    }
                }

                // 2. ì˜µì…˜ (Addons)
                const { data: allAddons } = await sb.from('admin_addons').select('*');
                const targetAddons = allAddons.filter(a => (a.name_kr || a.name) && (!a.name_jp || !a.name_us));

                let aCount = 0;
                for (const a of targetAddons) {
                    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ì˜µì…˜ ë²ˆì—­ì¤‘ (${aCount + 1}/${targetAddons.length})`;

                    const updates = {};
                    let needsUpdate = false;
                    const srcName = a.name_kr || a.name;

                    if (!a.name_jp) {
                        updates.name_jp = await safeTranslate(srcName, 'ja');
                        needsUpdate = true;
                        await delay(1000);
                    }
                    if (!a.price_jp) {
                        updates.price_jp = Math.round((a.price_kr || a.price || 0) * rateJPY);
                        needsUpdate = true;
                    }

                    if (!a.name_us) {
                        updates.name_us = await safeTranslate(srcName, 'en');
                        needsUpdate = true;
                        await delay(1000);
                    }
                    if (!a.price_us) {
                        updates.price_us = ((a.price_kr || a.price || 0) * rateUSD).toFixed(2);
                        needsUpdate = true;
                    }

                    if (needsUpdate) {
                        await sb.from('admin_addons').update(updates).eq('id', a.id);
                        aCount++;
                    }
                }

                alert(`âœ… ì‘ì—… ì™„ë£Œ!\nìƒí’ˆ ${pCount}ê°œ, ì˜µì…˜ ${aCount}ê°œê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                loadSystemDB();

            } catch (e) {
                console.error(e);
                alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // 2. ì£¼ë¬¸ ê´€ë¦¬ (Orders)
        // ==========================================
        window.filterOrders = (status, btn) => {
            currentOrderStatus = status;
            document.querySelectorAll('#sec-orders .btn-primary').forEach(b => { b.classList.remove('btn-primary'); b.classList.add('btn-outline'); });
            if(btn) { btn.classList.remove('btn-outline'); btn.classList.add('btn-primary'); }
            updateActionButtons();
            loadOrders();
        };

        function updateActionButtons() {
            const btnGroup = document.getElementById('action-buttons');
            btnGroup.innerHTML = "";
            if (currentOrderStatus === 'ì ‘ìˆ˜ë¨') {
                btnGroup.innerHTML = `<button class="btn btn-primary" onclick="changeStatusSelected('ì¹¼ì„ ì‘ì—…')">ì„ íƒ ì‘ì—…ì‹œì‘</button><button class="btn btn-danger" onclick="deleteOrdersSelected(false)">ì„ íƒ ì‚­ì œ</button>`;
            } else if (currentOrderStatus === 'ì¹¼ì„ ì‘ì—…') {
                btnGroup.innerHTML = `<button class="btn btn-success" onclick="downloadBulkFiles()">ì¼ê´„ ë‹¤ìš´ë¡œë“œ</button><button class="btn btn-vip" onclick="changeStatusSelected('ì™„ë£Œë¨')">ì„ íƒ ì™„ë£Œì²˜ë¦¬</button>`;
            } else if (currentOrderStatus === 'ì™„ë£Œë¨') {
                btnGroup.innerHTML = `<button class="btn btn-outline" onclick="changeStatusSelected('ì¹¼ì„ ì‘ì—…')"><i class="fa-solid fa-rotate-left"></i> ë‹¤ì‹œì¶œë ¥</button><button class="btn btn-danger" onclick="deleteOrdersSelected(true)">ì˜êµ¬ì‚­ì œ</button>`;
            }
        }


    // [ìµœì í™” ì™„ë£Œ] ê²€ìƒ‰ + ë°°ì†¡ì¼ í•„í„° + ë””ìì¸ ê°„ê²© ìˆ˜ì •
    window.loadOrders = async () => {
        const tbody = document.getElementById('orderListBody');
        const searchKeyword = document.getElementById('orderSearchInput').value.trim();
        const siteFilter = document.getElementById('filterSite').value;
        const deliveryDateFilter = document.getElementById('filterDeliveryDate').value; // ë°°ì†¡ì¼ ê°’

        // 1. 'ì™„ë£Œë¨' íƒ­ì¸ë° ê²€ìƒ‰ì–´/ë‚ ì§œê°€ ì—†ìœ¼ë©´ ë¡œë“œ ì°¨ë‹¨ (ì„œë²„ ë³´í˜¸)
        // (ë‹¨, ë°°ì†¡ì¼ì„ ì„ íƒí–ˆë‹¤ë©´ ì™„ë£Œëœ ê²ƒë„ ë³´ì—¬ì¤ë‹ˆë‹¤)
        if (currentOrderStatus === 'ì™„ë£Œë¨' && !searchKeyword && !deliveryDateFilter) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="12" style="text-align:center; padding:50px; color:#64748b;">
                        <i class="fa-solid fa-magnifying-glass fa-2x" style="margin-bottom:10px;"></i><br>
                        <b>ì™„ë£Œëœ ì£¼ë¬¸ì€ ë°ì´í„°ê°€ ë§ì•„ ê²€ìƒ‰ì´ í•„ìš”í•©ë‹ˆë‹¤.</b><br>
                        ê³ ê°ëª…, ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ <b>ìƒë‹¨ì—ì„œ ë°°ì†¡ì¼ì„ ì„ íƒ</b>í•´ì£¼ì„¸ìš”.
                    </td>
                </tr>`;
            updateActionButtons();
            return; 
        }

        showLoading(true);
        updateActionButtons();
        
        await fetchStaffForOrders();
        
        const { data: partners } = await sb.from('partner_applications').select('user_id, company_name').eq('status', 'approved');
        const partnerMap = {}; if(partners) partners.forEach(p => partnerMap[p.user_id] = p.company_name);

        // 2. ì¿¼ë¦¬ êµ¬ì„±
        let query = sb.from('orders')
            .select('id, created_at, manager_name, phone, address, total_amount, status, payment_status, payment_method, site_code, items, files, staff_manager_id, staff_driver_id, depositor_name, delivery_target_date, delivery_time, franchise_id')
            .order('created_at', {ascending:false});

        // 3. ìƒíƒœ í•„í„° (ë°°ì†¡ì¼ ê²€ìƒ‰ ì‹œì—ëŠ” ìƒíƒœ ë¬´ì‹œí•˜ê³  í•´ë‹¹ ë‚ ì§œ ë‹¤ ë³´ì—¬ì¤„ì§€, ìƒíƒœë„ ì§€í‚¬ì§€ ê²°ì •. ì—¬ê¸°ì„  ìƒíƒœ í•„í„° ìœ ì§€)
        if (currentOrderStatus === 'ì ‘ìˆ˜ë¨') {
            query = query.in('status', ['ì ‘ìˆ˜ë¨', 'íŒŒì¼ì²˜ë¦¬ì¤‘', 'ì ‘ìˆ˜ëŒ€ê¸°', 'ì œì‘ì¤€ë¹„']);
        } else if (currentOrderStatus === 'ì¹¼ì„ ì‘ì—…') {
            query = query.eq('status', 'ì¹¼ì„ ì‘ì—…');
        } else if (currentOrderStatus === 'ì™„ë£Œë¨') {
            query = query.in('status', ['ì™„ë£Œë¨', 'ë°œì†¡ì™„ë£Œ', 'ì™„ë£Œ', 'êµ¬ë§¤í™•ì •']);
        }

        // 4. [ì‹ ê·œ] ë°°ì†¡ì¼ í•„í„° ì ìš©
        if (deliveryDateFilter) {
            query = query.eq('delivery_target_date', deliveryDateFilter);
        }

        // 5. ê²€ìƒ‰ì–´ í•„í„°
        if (searchKeyword) {
            query = query.or(`manager_name.ilike.%${searchKeyword}%,phone.ilike.%${searchKeyword}%`);
        }

        // 6. ì‚¬ì´íŠ¸ í•„í„°
        if (siteFilter !== 'all') {
            query = query.eq('site_code', siteFilter);
        }

        // 7. ê°œìˆ˜ ì œí•œ (ê²€ìƒ‰ì–´ë‚˜ ë‚ ì§œ ì„ íƒ ì‹œì—ëŠ” ì œí•œ í•´ì œ)
        if (!searchKeyword && !deliveryDateFilter) {
            query = query.range(0, 49); 
        } else {
            query = query.limit(100); 
        }

        const { data, error } = await query;
        
        tbody.innerHTML = '';
        
        if (error) {
            tbody.innerHTML = `<tr><td colspan="12" style="text-align:center; color:red;">ì—ëŸ¬: ${error.message}</td></tr>`;
            showLoading(false); return;
        }
        
        if (!data || data.length === 0) { 
            tbody.innerHTML = '<tr><td colspan="12" style="text-align:center; padding:30px;">ì¡°ê±´ì— ë§ëŠ” ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; 
            showLoading(false); return; 
        }
        
        allOrders = data; 
        const { data: allProds } = await sb.from('admin_products').select('price, name');
        const prodMap = {}; if(allProds) allProds.forEach(p => prodMap[p.name] = p.price);

        data.forEach(order => {
            const site = order.site_code || 'KR'; 
            const managerSelect = createStaffSelectHTML(order.id, 'manager', order.staff_manager_id);
            const driverSelect = createStaffSelectHTML(order.id, 'driver', order.staff_driver_id);
            
            // ê¸ˆì•¡ ê³„ì‚° ë¡œì§ (ê¸°ì¡´ ë™ì¼)
            let items = [];
            if (order.items) {
                if (Array.isArray(order.items)) items = order.items;
                else if (typeof order.items === 'string') { try { items = JSON.parse(order.items); } catch(e) { items = []; } }
            }
            let rawTotalAmount = 0; 
            items.forEach(item => {
                if (item.isFileDerived) return;
                let unitPrice = item.price || (item.product ? item.product.price : 0) || 0;
                if (unitPrice === 0 && item.product && prodMap[item.product.name]) unitPrice = prodMap[item.product.name];
                rawTotalAmount += (unitPrice * (item.qty || 1));
            });
            if(rawTotalAmount === 0) rawTotalAmount = order.total_amount; 
            const finalPaidAmount = order.total_amount || 0;
            let discountAmt = (rawTotalAmount > finalPaidAmount) ? (rawTotalAmount - finalPaidAmount) : 0;
            let depositUsed = (order.payment_method === 'deposit' || order.payment_method === 'ì˜ˆì¹˜ê¸ˆ') ? finalPaidAmount : 0;
            let realCashPaid = (depositUsed > 0) ? 0 : finalPaidAmount;

            // ì•„ì´í…œ í‘œì‹œ
            let itemsDisplayHtml = '';
            items.forEach(i => {
                let pName = i.productName || (i.product ? i.product.name : i.name) || 'ìƒí’ˆ';
                itemsDisplayHtml += `<div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">- ${pName} (${i.qty})</div>`;
            });

            // í”„ëœì°¨ì´ì¦ˆ ë±ƒì§€
            let franchiseBadge = '';
            if (order.franchise_id) {
                const pName = partnerMap[order.franchise_id] || 'ê°€ë§¹ì /ë³¸ì‚¬';
                franchiseBadge = `<div style="margin-bottom:4px; padding:4px; background:#eff6ff; border:1px solid #bfdbfe; border-radius:4px; font-size:11px; color:#1e40af; text-align:center; font-weight:bold;">${pName} <i class="fa-solid fa-xmark" style="cursor:pointer; color:#ef4444; margin-left:3px;" onclick="cancelFranchiseClaim('${order.id}')"></i></div>`;
            } else {
                franchiseBadge = `<button class="btn btn-outline btn-sm" onclick="claimOrderAdmin('${order.id}')" style="width:100%; margin-bottom:4px; padding:4px; font-size:11px;">ğŸ”’ ë³¸ì‚¬ì ‘ìˆ˜</button>`;
            }

            // [UI ê°œì„ ] íŒŒì¼ ë²„íŠ¼
            let fileCount = (order.files && order.files.length) || 0;
            let fileBtnText = fileCount > 0 ? `ğŸ“‚ íŒŒì¼í™•ì¸ (${fileCount})` : 'íŒŒì¼ ì—†ìŒ';
            let fileButtonStyle = fileCount > 0 
                ? "border:1px solid #2563eb; color:#2563eb; background:#eff6ff; font-weight:bold;" 
                : "color:#ccc; background:#f8fafc;";

            let fileDisplayHtml = `
                <div style="display:flex; flex-direction:column; gap:4px; justify-content:center; height:100%;">
                    <button class="btn btn-sm" onclick="openFileModal('${order.id}')" style="width:100%; ${fileButtonStyle}">
                        ${fileBtnText}
                    </button>
                    <label class="btn btn-sky btn-sm" style="cursor:pointer; width:100%; font-size:11px; opacity:0.8; padding:4px;">
                        <i class="fa-solid fa-plus"></i> ì¶”ê°€
                        <input type="file" style="display:none;" onchange="uploadFileDirect('${order.id}', this)">
                    </label>
                </div>
            `;

            // ê²°ì œ ìƒíƒœ
            let payStatusHtml = '';
            const pm = order.payment_method || '';
            const ps = order.payment_status || '';
            const depositorDisplay = order.depositor_name ? `<div style="font-size:11px; color:#2563eb; font-weight:bold; margin-bottom:2px;">ì…ê¸ˆì: ${order.depositor_name}</div>` : '';

            if (pm.includes('card')) {
                payStatusHtml = `<div style="color:#15803d; font-weight:800; font-size:12px;">ì¹´ë“œê²°ì œ</div>`;
                if (['ê²°ì œì™„ë£Œ','paid','ì¹´ë“œê²°ì œì™„ë£Œ'].includes(ps)) payStatusHtml += `<button class="btn btn-danger btn-sm" style="margin-top:4px; width:100%; font-size:10px; padding:2px;" onclick="cancelTossPayment('${order.id}', '${order.toss_payment_key}')">ì·¨ì†Œ</button>`;
            } else if (pm.includes('bank') || pm.includes('ë¬´í†µì¥')) {
                if (['ê²°ì œì™„ë£Œ','ì…ê¸ˆí™•ì¸'].includes(ps)) payStatusHtml = `${depositorDisplay}<div style="color:#dc2626; font-weight:800; font-size:12px;">ì…ê¸ˆí™•ì¸</div>`;
                else payStatusHtml = `${depositorDisplay}<div style="font-size:11px; color:#d97706; margin-bottom:2px;">ì…ê¸ˆëŒ€ê¸°</div><button class="btn btn-outline btn-sm" style="width:100%; color:#dc2626; border-color:#dc2626; padding:2px;" onclick="confirmDeposit('${order.id}')">í™•ì¸</button>`;
            } else if (pm.includes('deposit')) {
                payStatusHtml = `<div style="color:#6366f1; font-weight:800; font-size:12px;">ì˜ˆì¹˜ê¸ˆ</div>`;
            } else {
                payStatusHtml = `<div style="color:#94a3b8; font-size:12px;">${ps || 'ë¯¸ê²°ì œ'}</div>`;
            }

            const deliveryDateSimple = order.delivery_target_date ? order.delivery_target_date.substring(5).replace(/-/g, '.') : '';

            // [UI ê°œì„ ] ëª¨ë“  tdì— vertical-align: middle ì ìš©í•˜ì—¬ ì¤„ë§ì¶¤
            tbody.innerHTML += `
                <tr>
                    <td style="vertical-align:middle; text-align:center;"><input type="checkbox" class="row-chk" value="${order.id}"></td>
                    <td style="vertical-align:middle; text-align:center;"><span class="badge-site ${site.toLowerCase()}">${site}</span></td>
                    <td style="vertical-align:middle;">
                        <span style="font-size:11px; color:#94a3b8;">${new Date(order.created_at).toLocaleDateString()}</span>
                        ${deliveryDateSimple ? `<div style="margin-top:2px; color:#d97706; font-weight:bold; font-size:13px; display:flex; align-items:center; gap:2px;"><i class="fa-solid fa-truck" style="font-size:10px;"></i> ${deliveryDateSimple}</div>` : ''}
                    </td>
                    <td style="vertical-align:middle;"><b>${order.manager_name}</b><br><span style="font-size:11px; color:#666;">${order.phone}</span></td>
                    <td style="vertical-align:middle; color:#334155; font-size:11px;">${itemsDisplayHtml}</td>
                    <td style="vertical-align:middle; text-align:right; color:#64748b;">${rawTotalAmount.toLocaleString()}</td>
                    <td style="vertical-align:middle; text-align:right; color:#ef4444;">${discountAmt > 0 ? '-' + discountAmt.toLocaleString() : '-'}</td>
                    <td style="vertical-align:middle; text-align:right; color:#d97706;">${depositUsed > 0 ? depositUsed.toLocaleString() : '-'}</td>
                    <td style="vertical-align:middle; text-align:right; font-weight:bold; color:#15803d; background:#f0fdf4;">${realCashPaid.toLocaleString()}</td>
                    
                    <td style="vertical-align:middle;">
                        ${franchiseBadge}
                        <div style="margin-top:2px;">${managerSelect}</div>
                        <div style="margin-top:2px;">${driverSelect}</div>
                    </td>
                    
                    <td style="vertical-align:middle; width:130px;">
                        ${fileDisplayHtml}
                    </td>
                    
                    <td style="vertical-align:middle; text-align:center; width:80px;">
                        ${payStatusHtml}
                    </td>
                </tr>
            `;
        });
        showLoading(false);
    };

// [2] [ì‹ ê·œ] ì›”ë³„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
window.downloadMonthlyExcel = async () => {
    const monthVal = document.getElementById('excelMonth').value; 
    if (!monthVal) return alert("ë‹¤ìš´ë¡œë“œí•  'ì›”'ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

    const [year, month] = monthVal.split('-');
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0, 23, 59, 59);

    if (!confirm(`${monthVal}ì›” ë§¤ì¶œ ë‚´ì—­ì„ ì—‘ì…€ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    showLoading(true);

    try {
        const { data: orders, error } = await sb.from('orders')
            .select('*')
            .gte('created_at', startDate.toISOString())
            .lte('created_at', endDate.toISOString())
            .order('created_at', { ascending: true });

        if (error) throw error;
        if (!orders || orders.length === 0) {
            showLoading(false);
            return alert("í•´ë‹¹ ì›”ì— ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
        }

        const excelData = orders.map(o => {
            let items = [];
            try { items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items; } catch(e){}

            let rawTotal = 0;
            if(items) {
                items.forEach(i => {
                    let price = i.price || (i.product ? i.product.price : 0) || 0;
                    rawTotal += price * (i.qty || 1);
                });
            }
            if(rawTotal === 0) rawTotal = o.total_amount; 

            const finalPay = o.total_amount || 0;
            const discount = (rawTotal > finalPay) ? (rawTotal - finalPay) : 0;
            const isDeposit = (o.payment_method === 'deposit' || o.payment_method === 'ì˜ˆì¹˜ê¸ˆ');

            return {
                "ì£¼ë¬¸ì¼ì": new Date(o.created_at).toLocaleDateString(),
                "ì£¼ë¬¸ë²ˆí˜¸": o.id,
                "êµ­ê°€": o.site_code || 'KR',
                "ì£¼ë¬¸ì": o.manager_name,
                "ì£¼ë¬¸ë‚´ì—­": items ? items.map(i => `${i.productName}(${i.qty})`).join(', ') : '',
                "ê²°ì œìƒíƒœ": o.payment_status,
                "ê²°ì œìˆ˜ë‹¨": o.payment_method,
                "ì£¼ë¬¸ì´ì•¡(ì›ê°€)": rawTotal,
                "í• ì¸ì•¡": discount,
                "ì˜ˆì¹˜ê¸ˆì‚¬ìš©": isDeposit ? finalPay : 0,
                "ì‹¤ì œì…ê¸ˆì•¡": isDeposit ? 0 : finalPay
            };
        });

        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ë§¤ì¶œì¥ë¶€");
        XLSX.writeFile(wb, `ë§¤ì¶œì¥ë¶€_${monthVal}.xlsx`);

    } catch (e) {
        alert("ì—‘ì…€ ì˜¤ë¥˜: " + e.message);
    } finally {
        showLoading(false);
    }
};
        

        window.openFileModal = async (orderId) => {
            currentMgrOrderId = orderId;
            showLoading(true);
            try {
                const { data, error } = await sb.from('orders').select('files').eq('id', orderId).single();
                if (error) throw error;
                currentMgrFiles = data.files || [];
                renderFileMgrList();
                document.getElementById('fileManagerModal').style.display = 'flex';
            } catch(e) {
                alert("íŒŒì¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: " + e.message);
            } finally {
                showLoading(false);
            }
        };

        window.closeFileModal = () => {
            document.getElementById('fileManagerModal').style.display = 'none';
            currentMgrOrderId = null;
            currentMgrFiles = [];
            document.getElementById('fileMgrInput').value = '';
        };

        function renderFileMgrList() {
            const listArea = document.getElementById('fileMgrList');
            listArea.innerHTML = '';
            
            if (currentMgrFiles.length === 0) {
                listArea.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">ë“±ë¡ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            currentMgrFiles.forEach((file, index) => {
                let badge = '';
                if (file.name.includes('ê²¬ì ì„œ')) badge = '<span class="badge" style="background:#f1f5f9; color:#64748b; margin-right:5px;">ê²¬ì ì„œ</span>';
                else if (file.name.includes('ì‘ì—…ì§€ì‹œì„œ')) badge = '<span class="badge" style="background:#fee2e2; color:#ef4444; margin-right:5px;">ì§€ì‹œì„œ</span>';
                else if (file.type === 'admin_added') badge = '<span class="badge" style="background:#dbeafe; color:#2563eb; margin-right:5px;">ì¶”ê°€ë¨</span>';

                listArea.innerHTML += `
                    <div class="file-item-row">
                        <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:flex; align-items:center;">
                            ${badge}
                            <a href="${file.url}" target="_blank" style="text-decoration:none; color:#334155; font-weight:bold;">${file.name}</a>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteFileFromOrder(${index})" style="margin-left:10px;">ì‚­ì œ</button>
                    </div>
                `;
            });
        }

        window.deleteFileFromOrder = async (index) => {
            if (!confirm("ì •ë§ ì´ íŒŒì¼ì„ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            currentMgrFiles.splice(index, 1);
            await updateOrderFilesDB();
        };

        window.uploadFileToOrder = async () => {
            const input = document.getElementById('fileMgrInput');
            if (!input.files || input.files.length === 0) return alert("ì¶”ê°€í•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            
            const file = input.files[0];
            showLoading(true);
            try {
                const parts = file.name.split('.');
                const ext = parts.length > 1 ? parts.pop() : ''; 
                const timestamp = Date.now();
                const randomStr = Math.random().toString(36).substring(2, 10); 
                const safeStorageName = `added_${timestamp}_${randomStr}.${ext}`;

                const path = `orders/${currentMgrOrderId}/${safeStorageName}`;
                
                const { error: uploadErr } = await sb.storage.from('orders').upload(path, file, {
                    upsert: true
                });

                if (uploadErr) throw uploadErr;
                
                const { data: publicUrlData } = sb.storage.from('orders').getPublicUrl(path);
                
                const newFileObj = {
                    name: file.name, 
                    url: publicUrlData.publicUrl, 
                    type: 'admin_added' 
                };
                
                currentMgrFiles.push(newFileObj);
                await updateOrderFilesDB();
                
                input.value = ''; 
            } catch (e) {
                console.error(e);
                alert("íŒŒì¼ ì¶”ê°€ ì‹¤íŒ¨: " + e.message);
                showLoading(false);
            }
        };

        async function updateOrderFilesDB() {
            if (!currentMgrOrderId) return;
            showLoading(true);
            try {
                const { error } = await sb.from('orders').update({ files: currentMgrFiles }).eq('id', currentMgrOrderId);
                if (error) throw error;
                renderFileMgrList(); 
                loadOrders(); 
            } catch(e) {
                alert("DB ì €ì¥ ì˜¤ë¥˜: " + e.message);
            } finally {
                showLoading(false);
            }
        }

        async function fetchStaffForOrders() { const { data } = await sb.from('admin_staff').select('*'); staffList = data || []; }
        function createStaffSelectHTML(orderId, role, selectedId) {
            const roleName = role === 'manager' ? 'ë‹´ë‹¹' : 'ë°°ì†¡';
            const filteredStaff = staffList.filter(s => s.role === role);
            const selectedStaff = staffList.find(s => s.id == selectedId);
            const dotColor = selectedStaff ? selectedStaff.color : '#ccc';
            const bgColor = selectedStaff ? selectedStaff.color + '10' : '#fff'; 
            let options = `<option value="">${roleName} ë¯¸ì§€ì •</option>`;
            filteredStaff.forEach(s => { options += `<option value="${s.id}" ${s.id == selectedId ? 'selected' : ''}>${s.name}</option>`; });
            return `<div style="position:relative;"><span class="color-dot" style="background:${dotColor}; position:absolute; left:8px; top:10px; pointer-events:none;"></span><select class="staff-select" style="padding-left:25px; background:${bgColor}; border-color:${selectedStaff ? dotColor : '#e2e8f0'};" onchange="updateOrderStaff('${orderId}', '${role}', this.value)">${options}</select></div>`;
        }
        window.updateOrderStaff = async (orderId, role, staffId) => { const field = role === 'manager' ? 'staff_manager_id' : 'staff_driver_id'; const val = staffId ? parseInt(staffId) : null; const { error } = await sb.from('orders').update({ [field]: val }).eq('id', orderId); if(error) alert("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: " + error.message); else loadOrders(); };
        window.toggleAll = (source) => { document.querySelectorAll('.row-chk').forEach(el => el.checked = source.checked); };
        window.changeStatusSelected = async (newStatus) => {
            const checks = document.querySelectorAll('.row-chk:checked');
            if (checks.length === 0) return alert("ì„ íƒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");
            if (!confirm(`ì„ íƒí•œ ${checks.length}ê±´ì„ '${newStatus}' ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const ids = Array.from(checks).map(c => c.value);
            const { error } = await sb.from('orders').update({ status: newStatus }).in('id', ids);
            if (error) alert("ì˜¤ë¥˜: " + error.message); else loadOrders();
        };
        window.deleteOrdersSelected = async (isPermanent) => {
            const checks = document.querySelectorAll('.row-chk:checked');
            if (checks.length === 0) return alert("ì‚­ì œí•  ì£¼ë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            if (!confirm(isPermanent ? "ì •ë§ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const ids = Array.from(checks).map(c => c.value);
            const { error } = await sb.from('orders').delete().in('id', ids);
            if (error) alert("ì‹¤íŒ¨: " + error.message); else loadOrders();
        };
        
        window.downloadBulkFiles = async () => {
            const checks = document.querySelectorAll('.row-chk:checked');
            if (checks.length === 0) return alert("ë‹¤ìš´ë¡œë“œí•  ì£¼ë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            
            showLoading(true);
            try {
                const zip = new JSZip();
                let fileCount = 0;
                const fetchPromises = [];

                checks.forEach(chk => {
                    // [ìˆ˜ì •] HTML dataset ëŒ€ì‹  ì „ì—­ ë³€ìˆ˜(allOrders)ì—ì„œ ë°ì´í„° ì°¾ê¸°
                    const orderId = chk.value;
                    const order = allOrders.find(o => o.id == orderId);
                    if (!order) return;

                    const customerName = order.manager_name || 'ê³ ê°ë¯¸ìƒ';
                    const files = order.files || [];
                    
                    let items = [];
                    if (typeof order.items === 'string') {
                         try { items = JSON.parse(order.items); } catch(e) {}
                    } else {
                         items = order.items || [];
                    }

                    if (files.length === 0) return;
                    const clean = (str) => (str || '').replace(/[\\/:*?"<>|]/g, "").trim();
                    let prodItemIndex = 0; 
                    files.forEach(file => {
                        const originalName = file.name || '';
                        const ext = originalName.split('.').pop(); 
                        let newFileName = "";
                        if (originalName.includes("ê²¬ì ì„œ")) {
                            newFileName = `${clean(customerName)}_ê²¬ì ì„œ.${ext}`;
                        } else if (originalName.includes("ì‘ì—…ì§€ì‹œì„œ")) {
                            newFileName = `${clean(customerName)}_ì‘ì—…ì§€ì‹œì„œ.${ext}`;
                        } else {
                            let currentProductName = 'ê¸°íƒ€'; 
                            if (items.length > 0) {
                                const targetItem = items[prodItemIndex] || items[0]; 
                                if (targetItem.product) currentProductName = targetItem.product.name;
                                else currentProductName = targetItem.productName || targetItem.name || 'ì œí’ˆ';
                            }
                            const random3 = String(Math.floor(Math.random() * 900) + 100);
                            newFileName = `${clean(customerName)}_${random3}_${clean(currentProductName)}.${ext}`;
                            prodItemIndex++;
                        }
                        if(zip.file(newFileName)) newFileName = newFileName.replace(`.${ext}`, `_copy.${ext}`);
                        const promise = fetch(file.url).then(res => { if (!res.ok) throw new Error('Network response was not ok'); return res.blob(); }).then(blob => { zip.file(newFileName, blob); fileCount++; }).catch(err => console.error("File loading error:", err));
                        fetchPromises.push(promise);
                    });
                });
                if (fetchPromises.length === 0) { showLoading(false); return alert("ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."); }
                await Promise.all(fetchPromises);
                if (fileCount === 0) { showLoading(false); return alert("íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); }
                const content = await zip.generateAsync({ type: "blob" });
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                saveAs(content, `ì£¼ë¬¸íŒŒì¼ì¼ê´„_${today}.zip`);
            } catch (e) { console.error(e); alert("ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜: " + e.message); } finally { showLoading(false); }
        };
        
        window.confirmPayment = async (id) => { if(!confirm("ì…ê¸ˆì„ í™•ì¸í•˜ê³  'ê²°ì œì™„ë£Œ' ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; const { error } = await sb.from('orders').update({ payment_status: 'ê²°ì œì™„ë£Œ', payment_method: 'ê³„ì¢Œì´ì²´' }).eq('id', id); if(error) alert("ì˜¤ë¥˜: " + error.message); else loadOrders(); };
        // [ì‹ ê·œ] í† ìŠ¤ ê²°ì œ ì·¨ì†Œ í•¨ìˆ˜
    window.cancelTossPayment = async (orderId, paymentKey) => {
        // 1. paymentKey í™•ì¸
        if (!paymentKey || paymentKey === 'null' || paymentKey === 'undefined') {
            return alert("ì·¨ì†Œí•  ìˆ˜ ì—†ëŠ” ì£¼ë¬¸ì…ë‹ˆë‹¤. (DBì— PaymentKeyê°€ ì—†ìŠµë‹ˆë‹¤.)");
        }

        const reason = prompt("ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: ê³ ê° ë³€ì‹¬)");
        if (!reason) return;

        if (!confirm(`ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚¬ìœ : ${reason}`)) return;

        showLoading(true);

        try {
            // 2. ë°©ê¸ˆ ë°°í¬í•œ Supabase Edge Function í˜¸ì¶œ ('cancel-toss-payment')
            const { data, error } = await sb.functions.invoke('cancel-toss-payment', {
                body: { 
                    paymentKey: paymentKey, 
                    cancelReason: reason 
                }
            });

            if (error) throw new Error(error.message);
            
            // í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ í† ìŠ¤ API ì—ëŸ¬ê°€ ë°œìƒí•œ ê²½ìš°
            if (data && data.error) throw new Error(data.error);

            // 3. ì·¨ì†Œ ì„±ê³µ ì‹œ DB ìƒíƒœ ì—…ë°ì´íŠ¸
            const { error: dbError } = await sb.from('orders').update({ 
                payment_status: 'ê²°ì œì·¨ì†Œ',
                status: 'ì·¨ì†Œë¨',
                request_note: `[ì·¨ì†Œì‚¬ìœ ] ${reason} / ` + (document.getElementById('orderMemo')?.value || '')
            }).eq('id', orderId);

            if (dbError) throw dbError;

            alert("âœ… ê²°ì œê°€ ì •ìƒì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadOrders(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨

        } catch (e) {
            console.error(e);
            alert("ì·¨ì†Œ ì‹¤íŒ¨: " + e.message);
        } finally {
            showLoading(false);
        }
    };

        window.loadStatsData = async () => { let start = document.getElementById('statStartDate').value; let end = document.getElementById('statEndDate').value; if(!start || !end) { const now = new Date(); const firstDay = new Date(now.getFullYear(), now.getMonth(), 1); start = firstDay.toISOString().split('T')[0]; end = now.toISOString().split('T')[0]; document.getElementById('statStartDate').value = start; document.getElementById('statEndDate').value = end; } document.getElementById('loading').style.display = 'flex'; const { data: orders, error } = await sb.from('orders').select('*').gte('created_at', start + 'T00:00:00').lte('created_at', end + 'T23:59:59'); if(error) { alert("ë¡œë“œ ì‹¤íŒ¨"); document.getElementById('loading').style.display = 'none'; return; } const { data: allProds } = await sb.from('admin_products').select('price, name'); const prodMap = {}; if(allProds) allProds.forEach(p => prodMap[p.name] = p.price); let totalRevenue = 0; const managerStats = {}; const driverStats = {}; orders.forEach(o => { let amt = o.total_amount || 0; let items = o.items; if (typeof items === 'string') { try { items = JSON.parse(items); } catch(e) { items = []; } } if(amt === 0 && Array.isArray(items)) { items.forEach(i => { let p = 0; if(i.product && i.product.price) p = i.product.price; else if(i.product && prodMap[i.product.name]) p = prodMap[i.product.name]; if(!p) p = i.price || 10000; amt += p * (i.qty || 1); }); } totalRevenue += amt; if(o.staff_manager_id) managerStats[o.staff_manager_id] = (managerStats[o.staff_manager_id] || 0) + amt; if(o.staff_driver_id) driverStats[o.staff_driver_id] = (driverStats[o.staff_driver_id] || 0) + amt; }); document.getElementById('totalRevenue').innerText = totalRevenue.toLocaleString() + "ì›"; document.getElementById('totalCount').innerText = orders.length + "ê±´"; const { data: staff } = await sb.from('admin_staff').select('*'); renderStaffStats('statManagerBody', managerStats, staff || [], totalRevenue); renderStaffStats('statDriverBody', driverStats, staff || [], totalRevenue); document.getElementById('loading').style.display = 'none'; };
        function renderStaffStats(elemId, statsObj, staffList, totalRev) { const tbody = document.getElementById(elemId); tbody.innerHTML = ''; const sortedIds = Object.keys(statsObj).sort((a,b) => statsObj[b] - statsObj[a]); if(sortedIds.length === 0) { tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;">ë°ì´í„° ì—†ìŒ</td></tr>'; return; } sortedIds.forEach(id => { const s = staffList.find(st => st.id == id); if(!s) return; const amt = statsObj[id]; const percent = totalRev > 0 ? Math.round((amt / totalRev) * 100) : 0; tbody.innerHTML += `<tr><td style="padding:12px 0;"><div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;"><div style="width:12px; height:12px; border-radius:50%; background:${s.color};"></div><span style="font-weight:bold;">${s.name}</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${percent}%; background:${s.color};"></div></div></td><td style="text-align:right;"><div>${amt.toLocaleString()}ì›</div><div style="font-size:11px; color:#999;">${percent}%</div></td></tr>`; }); }
        
        window.loadCategories = async () => { 
            const { data: topCats } = await sb.from('admin_top_categories').select('*').order('sort_order');
            const topSelect = document.getElementById('newCatTop');
            if (topSelect && topCats) {
                topSelect.innerHTML = '<option value="">(ìƒìœ„ ì—†ìŒ)</option>';
                topCats.forEach(t => { topSelect.innerHTML += `<option value="${t.code}">${t.name}</option>`; });
            }

            const { data } = await sb.from('admin_categories').select('*').order('sort_order', {ascending:true}); 
            const selectBox = document.getElementById('newProdCategory'); 
            const listArea = document.getElementById('categoryListArea'); 
            selectBox.innerHTML = '<option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>'; 
            listArea.innerHTML = ''; 
            
            if(data) data.forEach(cat => { 
                const option = document.createElement('option'); 
                option.value = cat.code; 
                option.innerText = `${cat.name} (${cat.code})`; 
                selectBox.appendChild(option); 
                
                const span = document.createElement('span'); 
                span.className = 'badge draggable'; 
                span.draggable = true; 
                span.dataset.id = cat.id; 
                span.style.cssText = "border:1px solid #bae6fd; color:#0284c7; margin-right:5px; margin-bottom:5px; display:inline-block; user-select:none; background:white; padding:6px 10px;"; 
                
                const parentName = topCats && cat.top_category_code 
                    ? (topCats.find(t => t.code === cat.top_category_code)?.name || cat.top_category_code) + " > " : "";

                span.innerHTML = `<span style="color:#94a3b8; font-size:11px;">${parentName}</span> <b>${cat.name}</b> (${cat.code}) 
                    <i class="fa-solid fa-pen" style="font-size:10px; margin-left:5px; color:#aaa; cursor:pointer;" onclick="editCategoryLoad(${cat.id})"></i>
                    <i class="fa-solid fa-xmark" style="font-size:10px; margin-left:5px; color:#ef4444; cursor:pointer;" onclick="deleteCategoryDB(${cat.id})"></i>`; 
                span.addEventListener('dragstart', () => span.classList.add('dragging')); 
                span.addEventListener('dragend', async () => { span.classList.remove('dragging'); await saveCategoryOrder(); }); 
                listArea.appendChild(span); 
            }); 
            
            listArea.addEventListener('dragover', e => { 
                e.preventDefault(); 
                const afterElement = getDragAfterElementX(listArea, e.clientX); 
                const draggable = document.querySelector('.badge.dragging'); 
                if (afterElement == null) listArea.appendChild(draggable); 
                else listArea.insertBefore(draggable, afterElement); 
            }); 
        };

        // [ìˆ˜ì •ëœ ì½”ë“œ] ì¹´í…Œê³ ë¦¬ ì¶”ê°€/ìˆ˜ì • í•¨ìˆ˜
        window.addCategoryDB = async () => {
    const topCode = document.getElementById('newCatTop').value || null;
    const codeRaw = document.getElementById('newCatCode').value;
    const name = document.getElementById('newCatName').value;
    const name_jp = document.getElementById('newCatNameJP').value;
    const name_us = document.getElementById('newCatNameUS').value;
    
    // [ì¶”ê°€] ì„¤ëª… ë°ì´í„°
    const description = document.getElementById('newCatDesc').value;
    const description_jp = document.getElementById('newCatDescJP').value;
    const description_us = document.getElementById('newCatDescUS').value;

    if (!codeRaw || !name) return alert("í•„ìˆ˜í•­ëª© ëˆ„ë½: ì½”ë“œì™€ í•œêµ­ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
    const code = codeRaw.toLowerCase().replace(/\s/g, '_');
    const currentFilterCat = document.getElementById('filterProdCat').value;

    try {
        const { data: exist } = await sb.from('admin_categories').select('id, sort_order').eq('code', code).single();
        let nextOrder = 1;
        if (exist) {
            // [ìˆ˜ì •] ë³€ìˆ˜ëª… ì˜¤íƒ€ ìˆ˜ì • (editingCategoryLoad -> editingCategoryId)
            if (!editingCategoryId && !confirm(`âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤. ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`)) return; 
            nextOrder = exist.sort_order;
        } else {
            const { data: maxData } = await sb.from('admin_categories').select('sort_order').order('sort_order', { ascending: false }).limit(1);
            if (maxData && maxData.length > 0) nextOrder = (maxData[0].sort_order || 0) + 1;
        }

        const { error } = await sb.from('admin_categories').upsert([{
            code, name, name_jp, name_us, 
            description, description_jp, description_us, // ì„¤ëª… ì €ì¥
            top_category_code: topCode, sort_order: nextOrder
        }], { onConflict: 'code' });

        if (error) throw error;
        alert("âœ… ì†Œë¶„ë¥˜ ì €ì¥ ì™„ë£Œ");

        // ì…ë ¥ì°½ ì´ˆê¸°í™”
        document.getElementById('newCatCode').value = '';
        document.getElementById('newCatName').value = '';
        document.getElementById('newCatNameJP').value = '';
        document.getElementById('newCatNameUS').value = '';
        document.getElementById('newCatDesc').value = ''; // ì´ˆê¸°í™”
        document.getElementById('newCatDescJP').value = '';
        document.getElementById('newCatDescUS').value = '';
        document.getElementById('newCatTop').value = '';
        
        editingCategoryId = null; // [ì¶”ê°€] ì €ì¥ í›„ ìˆ˜ì • ëª¨ë“œ í•´ì œ

        await loadCategories();
        await loadSystemDB('KR');
        
        const filterSelect = document.getElementById('filterProdCat');
        if (currentFilterCat && filterSelect.querySelector(`option[value="${currentFilterCat}"]`)) {
            filterSelect.value = currentFilterCat;
            await filterProductList();
        }
    } catch (e) {
        alert("ì €ì¥ ì˜¤ë¥˜: " + e.message);
    }
};

        window.editCategoryLoad = async (id) => {
    editingCategoryId = id; // [ì¶”ê°€] ìˆ˜ì • ì¤‘ì¸ ID ì €ì¥
    const {data} = await sb.from('admin_categories').select('*').eq('id',id).single(); 
    if(data) { 
        document.getElementById('newCatTop').value = data.top_category_code || '';
        document.getElementById('newCatCode').value = data.code; 
        document.getElementById('newCatName').value = data.name; 
        document.getElementById('newCatNameJP').value = data.name_jp||''; 
        document.getElementById('newCatNameUS').value = data.name_us||''; 
        
        // [ì¶”ê°€] ì„¤ëª… ë¡œë“œ
        document.getElementById('newCatDesc').value = data.description || '';
        document.getElementById('newCatDescJP').value = data.description_jp || '';
        document.getElementById('newCatDescUS').value = data.description_us || '';

        document.querySelector('#sec-products .card:nth-child(2)').scrollIntoView({behavior:'smooth'}); 
    } 
};

        window.deleteCategoryDB = async (id) => {
            if(!confirm("ì´ ì†Œë¶„ë¥˜ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                const { error } = await sb.from('admin_categories').delete().eq('id', id);
                if(error) throw error;
                loadCategories();
            } catch(e) {
                alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
            }
        };

        async function saveCategoryOrder() { const badges = document.querySelectorAll('#categoryListArea .badge'); const updates=[]; badges.forEach((b,i)=>updates.push(sb.from('admin_categories').update({sort_order:i+1}).eq('id',b.dataset.id))); await Promise.all(updates); }
        function getDragAfterElementX(container, x) { const draggables = [...container.querySelectorAll('.badge:not(.dragging)')]; return draggables.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = x - box.left - box.width / 2; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest; }, { offset: Number.NEGATIVE_INFINITY }).element; }
        
        window.loadSystemDB = async (filterSite = 'KR') => { 
            const catSelect = document.getElementById('filterProdCat');
            const savedCatValue = catSelect ? catSelect.value : 'all';

            const { data: addons } = await sb.from('admin_addons').select('*').order('category'); 
            const addonBody = document.getElementById('addonTableBody'); 
            const chkArea = document.getElementById('addonCheckboxArea'); 
            if(addonBody) addonBody.innerHTML = ''; 
            if(chkArea) chkArea.innerHTML = ''; 
            if(addons) { 
                addons.forEach(item => { 
                    const color = item.category==='material'?'#16a34a':(item.category==='finish'?'#2563eb':'#d97706'); 
                    let dName = item.name_kr || item.name; 
                    let dPrice = item.price_kr || item.price; 
                    if(filterSite === 'JP') { dName = item.name_jp || item.name; dPrice = item.price_jp || 0; } 
                    if(filterSite === 'US') { dName = item.name_us || item.name; dPrice = item.price_us || 0; } 
                    const priceStr = formatCurrency(dPrice, filterSite); 
                    if(addonBody) { addonBody.innerHTML += `<tr style="background:${editingAddonId===item.id?'#f0f9ff':'transparent'}"><td><span style="color:${color};font-weight:bold;">${item.category}</span></td><td><b>${item.code}</b></td><td><div>ğŸ‡°ğŸ‡· ${item.name_kr||item.name} (${item.price_kr||item.price})</div><div style="font-size:11px;color:#888;">ğŸ‡¯ğŸ‡µ ${item.name_jp||'-'} / ğŸ‡ºğŸ‡¸ ${item.name_us||'-'}</div></td><td><button class="btn btn-outline" style="padding:4px;" onclick="editAddonLoad(${item.id})">ìˆ˜ì •</button> <button class="btn btn-danger" style="padding:4px;" onclick="deleteSystemData('admin_addons',${item.id})">x</button></td></tr>`; } 
                    if(chkArea) { chkArea.innerHTML += `<label class="addon-check-item"><span class="badge-site ${filterSite.toLowerCase()}" style="font-size:10px;">${filterSite}</span> ${dName} (${priceStr}) <input type="checkbox" name="prodAddon" value="${item.code}"></label>`; } 
                }); 
            } 
            
            // [ìˆ˜ì •] ì¹´í…Œê³ ë¦¬ ë¡œë“œ ë° ì´ˆê¸°í™”
            const { data: cats } = await sb.from('admin_categories').select('*').order('sort_order');
            if (catSelect && cats) {
                // 'ì „ì²´' ì˜µì…˜ ì œê±° -> 'ì„ íƒí•˜ì„¸ìš”'ë¡œ ë³€ê²½
                catSelect.innerHTML = '<option value="">ğŸ“‚ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                cats.forEach(c => { catSelect.innerHTML += `<option value="${c.code}">${c.name}</option>`; });
                
                // ìˆ˜ì • í›„ ìƒˆë¡œê³ ì¹¨ í–ˆì„ ë•Œ, ì´ì „ì— ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ ìœ ì§€
                if (savedCatValue && savedCatValue !== 'all') {
                    catSelect.value = savedCatValue;
                    // ê°’ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ë¡œë“œ íŠ¸ë¦¬ê±°
                    setTimeout(filterProductList, 100); 
                }
            }

            // [í•µì‹¬] ì´ˆê¸° ìƒí’ˆ ë¡œë”© ì œê±° (ì„œë²„ ë¶€í•˜ ë°©ì§€)
            // ë¹ˆ í™”ë©´ì— ì•ˆë‚´ ë©”ì‹œì§€ë§Œ ë„ì›€
            allProducts = [];
            document.getElementById('prodTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#64748b;">ìœ„ì—ì„œ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ë©´ ìƒí’ˆ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>';
        };

        window.editAddonLoad = async (id) => { const { data } = await sb.from('admin_addons').select('*').eq('id', id).single(); if(!data) return; editingAddonId = id; document.getElementById('newAddonCat').value = data.category; document.getElementById('newAddonCode').value = data.code; document.getElementById('nmKR').value = data.name_kr||data.name; document.getElementById('prKR').value = data.price_kr||data.price; document.getElementById('nmJP').value = data.name_jp||''; document.getElementById('prJP').value = data.price_jp||0; document.getElementById('nmUS').value = data.name_us||''; document.getElementById('prUS').value = data.price_us||0; const btn = document.querySelector('#newAddonCode').parentElement.parentElement.querySelector('.btn-primary'); btn.innerText = "ìˆ˜ì • ì™„ë£Œ"; btn.classList.remove('btn-primary'); btn.classList.add('btn-vip'); };
        window.addAddonDB = async () => { const cat = document.getElementById('newAddonCat').value; const code = document.getElementById('newAddonCode').value; const nKR = document.getElementById('nmKR').value; const pKR = document.getElementById('prKR').value; const nJP = document.getElementById('nmJP').value; const pJP = document.getElementById('prJP').value; const nUS = document.getElementById('nmUS').value; const pUS = document.getElementById('prUS').value; if(!code) return alert("ì½”ë“œ í•„ìˆ˜"); const payload = { category: cat, code: code, name_kr: nKR, price_kr: parseInt(pKR||0), name_jp: nJP, price_jp: parseInt(pJP||0), name_us: nUS, price_us: parseInt(pUS||0), name: nKR, price: parseInt(pKR||0) }; if(editingAddonId) { await sb.from('admin_addons').update(payload).eq('id', editingAddonId); alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); } else { await sb.from('admin_addons').insert([payload]); alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); } editingAddonId = null; document.getElementById('newAddonCode').value = ''; document.getElementById('nmKR').value=''; document.getElementById('prKR').value=''; document.getElementById('nmJP').value=''; document.getElementById('prJP').value=''; document.getElementById('nmUS').value=''; document.getElementById('prUS').value=''; const btn = document.querySelector('#newAddonCode').parentElement.parentElement.querySelector('.btn'); btn.innerText = "ì €ì¥"; btn.classList.remove('btn-vip'); btn.classList.add('btn-primary'); loadSystemDB('KR'); };
        
        // [ìˆ˜ì •ë¨] í•„í„° ë¡œì§ ë³€ê²½: êµ­ê°€ë¥¼ ì„ íƒí•´ë„ ìƒí’ˆì„ ìˆ¨ê¸°ì§€ ì•ŠìŒ (ì–¸ì–´ ë³€ê²½ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©)
// [ìµœì í™”] ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œì—ë§Œ DBì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        let lastFetchedCategory = null; // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ìš©

        window.filterProductList = async () => {
            const catFilter = document.getElementById('filterProdCat').value;
            const tbody = document.getElementById('prodTableBody');

            // 1. ì¹´í…Œê³ ë¦¬ ë¯¸ì„ íƒ ì‹œ ì´ˆê¸°í™”
            if (!catFilter || catFilter === 'all') { 
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#64748b;">ğŸ“‚ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</td></tr>';
                allProducts = [];
                lastFetchedCategory = null;
                return;
            }

            // 2. ì¹´í…Œê³ ë¦¬ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ DB ì¡°íšŒ (ì–¸ì–´ ë³€ê²½ì‹œëŠ” ê¸°ì¡´ ë°ì´í„° í™œìš©í•˜ì—¬ ì†ë„ ìœ ì§€)
            if (catFilter !== lastFetchedCategory) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px;"><div class="spinner"></div> ìƒí’ˆ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</td></tr>';
                
                try {
                    // ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ë§Œ ì½• ì§‘ì–´ì„œ ê°€ì ¸ì˜´ (ë§¤ìš° ê°€ë²¼ì›€)
                    const { data, error } = await sb.from('admin_products')
                        .select('*')
                        .eq('category', catFilter)
                        .order('sort_order', { ascending: true });

                    if (error) throw error;

                    allProducts = data || [];
                    lastFetchedCategory = catFilter;

                } catch (e) {
                    console.error(e);
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}</td></tr>`;
                    return;
                }
            }

            // 3. ë Œë”ë§
            if (allProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#999;">ì´ ì¹´í…Œê³ ë¦¬ì—ëŠ” ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            } else {
                renderProductList(allProducts);
            }
        };

        // [ìˆ˜ì •ë¨] êµ­ê°€ í•„í„°ì— ë”°ë¼ ìƒí’ˆëª…/ê°€ê²© ì–¸ì–´ë¥¼ ë°”ê¿”ì„œ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜
// [ìˆ˜ì •ë¨] êµ­ê°€ í•„í„°ì— ë”°ë¼ ìƒí’ˆëª…/ê°€ê²© ì–¸ì–´ë¥¼ ë°”ê¿”ì„œ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜ (ì´ë¯¸ì§€ ìµœì í™” í¬í•¨)
        window.renderProductList = (products) => { 
            const prodBody = document.getElementById('prodTableBody'); 
            prodBody.innerHTML = ''; 
            
            // 1. í˜„ì¬ ì„ íƒëœ êµ­ê°€ í•„í„° í™•ì¸
            const filterSite = document.getElementById('filterProdSite').value;

            if(!products || products.length === 0) {
                prodBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">ì¡°ê±´ì— ë§ëŠ” ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            products.forEach(item => { 
                // 2. êµ­ê°€ë³„ ë°ì´í„° ë§¤í•‘ ë³€ìˆ˜ ì„ ì–¸ (ì´ ë¶€ë¶„ì´ ëˆ„ë½ë˜ì–´ ì—ëŸ¬ê°€ ë‚¬ìŠµë‹ˆë‹¤)
                let dName = item.name;
                let dPrice = item.price;  // â˜… í•µì‹¬ ë³µêµ¬: dPrice ì •ì˜
                let subInfo = ""; 

                // ì¼ë³¸ í•„í„° ì„ íƒ ì‹œ -> ì¼ë³¸ì–´ ë°ì´í„° í‘œì‹œ
                if (filterSite === 'JP') {
                    dName = item.name_jp || item.name; 
                    dPrice = item.price_jp || 0;
                    subInfo = `<div style="font-size:10px; color:#94a3b8;">(KR: ${item.name})</div>`; 
                } 
                // ë¯¸êµ­ í•„í„° ì„ íƒ ì‹œ -> ì˜ì–´ ë°ì´í„° í‘œì‹œ
                else if (filterSite === 'US') {
                    dName = item.name_us || item.name;
                    dPrice = item.price_us || 0;
                    subInfo = `<div style="font-size:10px; color:#94a3b8;">(KR: ${item.name})</div>`;
                } 
                // ì „ì²´/í•œêµ­ ì„ íƒ ì‹œ -> ë±ƒì§€ í‘œì‹œ
                else {
                    if(item.name_jp) subInfo += `<span style="font-size:10px; margin-right:4px; color:#f59e0b;" title="ì¼ë³¸ì–´ ë²ˆì—­ë¨">ğŸ‡¯ğŸ‡µ</span>`;
                    if(item.name_us) subInfo += `<span style="font-size:10px; color:#3b82f6;" title="ì˜ì–´ ë²ˆì—­ë¨">ğŸ‡ºğŸ‡¸</span>`;
                }

                // 3. í†µí™” ê¸°í˜¸ í¬ë§·íŒ… (dPriceê°€ ì •ì˜ë˜ì–´ ìˆì–´ì•¼ ì‘ë™í•¨)
                const displayPrice = formatCurrency(dPrice, filterSite === 'all' ? 'KR' : filterSite); 
                
                // 4. [ì´ë¯¸ì§€ ìµœì í™”] ì„œë²„ ë¦¬ì‚¬ì´ì§• URL ìƒì„±
                let thumbUrl = item.img_url;
                if (thumbUrl && thumbUrl.includes('supabase.co')) {
                    const separator = thumbUrl.includes('?') ? '&' : '?';
                    thumbUrl += `${separator}width=80&height=80&resize=cover&quality=60&format=webp`;
                }

                // 5. HTML ë Œë”ë§
                const tr = document.createElement('tr'); 
                tr.className = 'draggable-row'; 
                tr.draggable = true; 
                tr.dataset.id = item.id; 
                
                tr.innerHTML = `
                    <td><span class="badge-site ${(item.site_code || 'KR').toLowerCase()}">${item.site_code || 'KR'}</span></td>
                    <td>
                        <img src="${thumbUrl}" 
                             loading="lazy" 
                             decoding="async"
                             style="width:40px; height:40px; object-fit:cover; border-radius:4px; background:#eee; image-rendering:-webkit-optimize-contrast;" 
                             onerror="this.src='https://placehold.co/40?text=NoImg'">
                    </td>
                    <td>
                        <div style="font-size:11px; color:#6366f1; font-weight:bold;">${item.category || '-'}</div>
                        <b>${item.code}</b><br>
                        ${dName}
                        ${subInfo}
                    </td>
                    <td>${item.width_mm}x${item.height_mm}</td>
                    <td style="font-weight:bold;">${displayPrice}</td>
                    <td>
                        <button class="btn btn-outline" style="padding:4px;" onclick="editProductLoad(${item.id})">ìˆ˜ì •</button> 
                        <button class="btn btn-danger" style="padding:4px;" onclick="deleteSystemData('admin_products', ${item.id})">ì‚­ì œ</button>
                    </td>`; 
                    
                addDragListeners(tr); 
                prodBody.appendChild(tr); 
            }); 
        };
        
        window.addProductDB = async () => {
            const site = document.getElementById('newProdSite').value;
            const cat = document.getElementById('newProdCategory').value;
            const code = document.getElementById('newProdCode').value;
            const w = document.getElementById('newProdW').value;
            const h = document.getElementById('newProdH').value;
            const img = document.getElementById('newProdImg').value;
            const name = document.getElementById('newProdName').value;
            const nameJP = document.getElementById('newProdNameJP').value;
            const nameUS = document.getElementById('newProdNameUS').value;
            const price = document.getElementById('newProdPrice').value;
            const priceJP = document.getElementById('newProdPriceJP').value;
            const priceUS = document.getElementById('newProdPriceUS').value;
            const description = document.getElementById('newProdDesc').value;
    const description_jp = document.getElementById('newProdDescJP').value;
    const description_us = document.getElementById('newProdDescUS').value;

            if(!code || !name) return alert("ìƒí’ˆì½”ë“œì™€ í•œêµ­ì–´ ìƒí’ˆëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

            const addons = Array.from(document.querySelectorAll('input[name="prodAddon"]:checked')).map(cb => cb.value).join(',');
            
            // â–¼â–¼â–¼ [ìˆ˜ì • 1] ì²´í¬ë°•ìŠ¤ ê°’ì„ payload ìƒì„± ì „ì— ë³€ìˆ˜ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤ â–¼â–¼â–¼
            const isCustom = document.getElementById('newProdIsCustom') ? document.getElementById('newProdIsCustom').checked : false;

            const payload = { 
                site_code: site,
                currency: 'KRW', 
                category: cat, 
                code, 
                width_mm: parseInt(w||0), 
                height_mm: parseInt(h||0), 
                img_url: img, 
                addons, 
                name, 
                name_jp: nameJP || null, 
                name_us: nameUS || null, 
                price: parseInt(price||0), 
                price_jp: parseInt(priceJP||0), 
                price_us: parseInt(priceUS||0),
                description,          // [ì¶”ê°€ë¨]
                description_jp,
                description_us,
                is_custom_size: isCustom  // â–¼â–¼â–¼ [ìˆ˜ì • 2] ìœ„ì—ì„œ ë§Œë“  ë³€ìˆ˜ë¥¼ ì—¬ê¸°ì— í• ë‹¹
            };

            let res;
            if(editingProdId) res = await sb.from('admin_products').update(payload).eq('id', editingProdId);
            else res = await sb.from('admin_products').insert([payload]);

            if(res.error) alert(res.error.message);
            else { 
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                resetProductForm(); 
                
                // [ìˆ˜ì •] ì „ì²´ UI ë¦¬ì…‹ ëŒ€ì‹ , í˜„ì¬ ë³´ê³  ìˆëŠ” ëª©ë¡ë§Œ ìƒˆë¡œê³ ì¹¨í•˜ë„ë¡ ë³€ê²½
                // ê°•ì œë¡œ DBì—ì„œ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ ìºì‹œ ì´ˆê¸°í™” í›„ ëª©ë¡ ë¡œë“œ
                lastFetchedCategory = null; 
                filterProductList(); 
            }
        };

        window.editProductLoad = async (id) => {
            const { data } = await sb.from('admin_products').select('*').eq('id', id).single();
            if(!data) return;
            editingProdId = id;
            document.getElementById('newProdSite').value = data.site_code;
            document.getElementById('newProdCategory').value = data.category;
            document.getElementById('newProdCode').value = data.code;
            document.getElementById('newProdW').value = data.width_mm;
            document.getElementById('newProdH').value = data.height_mm;
            document.getElementById('newProdImg').value = data.img_url;
            const preview = document.getElementById('prodPreview');
            preview.src = data.img_url; preview.style.display = 'block';
            document.getElementById('newProdName').value = data.name || '';
            document.getElementById('newProdNameJP').value = data.name_jp || '';
            document.getElementById('newProdNameUS').value = data.name_us || '';
            document.getElementById('newProdPrice').value = data.price || 0;
            document.getElementById('newProdPriceJP').value = data.price_jp || 0;
            document.getElementById('newProdPriceUS').value = data.price_us || 0;
            document.getElementById('newProdDesc').value = data.description || '';
    document.getElementById('newProdDescJP').value = data.description_jp || '';
    document.getElementById('newProdDescUS').value = data.description_us || '';
    document.getElementById('newProdIsCustom').checked = data.is_custom_size || false;

            const addons = data.addons ? data.addons.split(',') : [];
            document.querySelectorAll('input[name="prodAddon"]').forEach(c => c.checked = addons.includes(c.value));
            document.getElementById('btnProductSave').innerText = "ìˆ˜ì • ì €ì¥";
            document.getElementById('btnProductClone').style.display = 'inline-block';
            document.getElementById('btnCancelEdit').style.display = 'inline-block';
            document.querySelector('.product-form').scrollIntoView({behavior:'smooth'});
        };
        window.cloneProduct = () => { editingProdId=null; document.getElementById('newProdCode').value += "_copy"; document.getElementById('btnProductSave').innerText="ìƒˆ ìƒí’ˆ ë“±ë¡"; alert("ë³µì œ ëª¨ë“œ"); };
        window.resetProductForm = () => {
            editingProdId = null;
            document.getElementById('newProdCode').value = ''; document.getElementById('newProdW').value = ''; document.getElementById('newProdH').value = ''; document.getElementById('newProdImg').value = ''; document.getElementById('prodPreview').style.display = 'none';
            document.getElementById('newProdName').value = ''; document.getElementById('newProdNameJP').value = ''; document.getElementById('newProdNameUS').value = '';
            document.getElementById('newProdPrice').value = ''; document.getElementById('newProdPriceJP').value = ''; document.getElementById('newProdPriceUS').value = '';
            document.querySelectorAll('input[name="prodAddon"]').forEach(c => c.checked = false);
            document.getElementById('newProdDesc').value = ''; // ì´ˆê¸°í™”
    document.getElementById('newProdDescJP').value = '';
    document.getElementById('newProdDescUS').value = '';
            document.getElementById('btnProductSave').innerText = "ìƒí’ˆ ë“±ë¡"; document.getElementById('btnProductClone').style.display = 'none'; document.getElementById('btnCancelEdit').style.display = 'none';
        };
        window.previewProductImage = async (input) => { if(!input.files[0]) return; const file=input.files[0]; const reader=new FileReader(); reader.onload=(e)=>{document.getElementById('prodPreview').src=e.target.result; document.getElementById('prodPreview').style.display='block';}; reader.readAsDataURL(file); const btn=document.getElementById('btnProductSave'); btn.innerText="ì—…ë¡œë“œì¤‘..."; btn.disabled=true; try { const path=`products/${Date.now()}_${file.name}`; await sb.storage.from('products').upload(path, file); const {data}=sb.storage.from('products').getPublicUrl(path); document.getElementById('newProdImg').value=data.publicUrl; } catch(e){alert("ì—…ë¡œë“œì‹¤íŒ¨");} finally {btn.innerText="ìƒí’ˆ ë“±ë¡"; btn.disabled=false;} };
        window.deleteSystemData = async (t, id) => {
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
    // DBì—ì„œ ì‚­ì œ
    await sb.from(t).delete().eq('id', id);

    // [ìˆ˜ì •] í…Œì´ë¸”ì´ 'ìƒí’ˆ'ì¸ ê²½ìš°ì™€ 'ì˜µì…˜'ì¸ ê²½ìš°ë¥¼ ë‚˜ëˆ ì„œ ì²˜ë¦¬
    if (t === 'admin_products') {
        // ìƒí’ˆ ì‚­ì œ ì‹œ: ì „ì²´ ì´ˆê¸°í™”(loadSystemDB) í•˜ì§€ ë§ê³  í˜„ì¬ ëª©ë¡ë§Œ ê°±ì‹ 
        lastFetchedCategory = null; // ê°•ì œ ì¬ì¡°íšŒ íŠ¸ë¦¬ê±°
        filterProductList();        // í˜„ì¬ ì¹´í…Œê³ ë¦¬ ìœ ì§€í•˜ë©´ì„œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    } else {
        // ì˜µì…˜(addons) ë“± ê·¸ ì™¸ ì‚­ì œ ì‹œ: ê¸°ì¡´ëŒ€ë¡œ ì „ì²´ ë¡œë“œ
        loadSystemDB();
    }
};
        function addDragListeners(row) { row.addEventListener('dragstart',()=>row.classList.add('dragging')); row.addEventListener('dragend',async()=>{row.classList.remove('dragging'); await saveSortOrder();}); const container=document.getElementById('prodTableBody'); container.addEventListener('dragover',e=>{e.preventDefault(); const after=getDragAfterElementY(container,e.clientY); const drag=document.querySelector('.draggable-row.dragging'); if(after==null) container.appendChild(drag); else container.insertBefore(drag,after);}); }
        function getDragAfterElementY(container,y) { return [...container.querySelectorAll('.draggable-row:not(.dragging)')].reduce((closest,child)=>{const box=child.getBoundingClientRect(); const offset=y-box.top-box.height/2; if(offset<0&&offset>closest.offset) return {offset:offset, element:child}; else return closest;},{offset:Number.NEGATIVE_INFINITY}).element; }
        async function saveSortOrder() { const updates=[]; document.querySelectorAll('#prodTableBody tr').forEach((r,i)=>updates.push(sb.from('admin_products').update({sort_order:i+1}).eq('id',r.dataset.id))); await Promise.all(updates); }
        window.loadStaffList = async () => { const {data}=await sb.from('admin_staff').select('*').order('created_at',{ascending:false}); const tbody=document.getElementById('staffListBody'); tbody.innerHTML=''; data?.forEach(s=>{ tbody.innerHTML+=`<tr><td><div class="color-dot" style="background:${s.color}"></div></td><td>${s.name}</td><td>${s.role}</td><td><button class="btn btn-danger btn-sm" onclick="deleteStaffDB(${s.id})">ì‚­ì œ</button></td></tr>`; }); };
        window.addStaffDB = async () => { const name=document.getElementById('staffName').value; const role=document.getElementById('staffRole').value; const color=document.getElementById('staffColor').value; if(!name) return; await sb.from('admin_staff').insert([{name,role,color}]); loadStaffList(); };
        window.deleteStaffDB = async (id) => { if(confirm("ì‚­ì œ?")) await sb.from('admin_staff').delete().eq('id',id); loadStaffList(); };

        window.loadFonts = async () => { 
            const tbody = document.getElementById('fontListBody'); 
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ë¡œë”© ì¤‘...</td></tr>';
            try { 
                const { data, error } = await sb.from('site_fonts').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                tbody.innerHTML = '';
                if (!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ë“±ë¡ëœ í°íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }
                data.forEach(f => {
                    const fontFace = new FontFace(f.font_family, `url(${f.file_url})`);
                    fontFace.load().then(loaded => document.fonts.add(loaded)).catch(e => console.warn(e));
                    let flag = ''; if(f.site_code === 'KR') flag = 'ğŸ‡°ğŸ‡·'; else if(f.site_code === 'JP') flag = 'ğŸ‡¯ğŸ‡µ'; else if(f.site_code === 'US') flag = 'ğŸ‡ºğŸ‡¸';
                    tbody.innerHTML += `<tr><td>${flag} ${f.site_code}</td><td>${f.font_name}<br><span style="font-size:11px; color:#888;">(${f.font_family})</span></td><td style="font-family:'${f.font_family}'; font-size:16px;">ë‹¤ëŒì¥ í—Œ ì³‡ë°”í€´ (Preview)</td><td><button class="btn btn-danger btn-sm" onclick="deleteFontDB(${f.id})">ì‚­ì œ</button></td></tr>`; 
                }); 
            } catch(e) { console.error(e); tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">ë¡œë“œ ì‹¤íŒ¨</td></tr>'; } 
        };

        window.uploadFont = async () => { 
            const site = document.getElementById('fontSite').value; 
            const name = document.getElementById('fontName').value; 
            const fam = document.getElementById('fontFamily').value; 
            const fileInput = document.getElementById('fontFile');
            const file = fileInput.files[0]; 
            if (!name || !fam || !file) return alert("í•„ìˆ˜ ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            const btn = document.querySelector('#sec-fonts .btn-primary');
            const oldText = btn.innerText; btn.innerText = "ì—…ë¡œë“œ ì¤‘..."; btn.disabled = true;
            try { 
                const timestamp = Date.now();
                const safeName = `${timestamp}_${Math.random().toString(36).substring(2,10)}.ttf`;
                const path = `${site}/${safeName}`; 
                const { data: uploadData, error: uploadErr } = await sb.storage.from('fonts').upload(path, file); 
                if(uploadErr) throw new Error(uploadErr.message);
                const { data: urlData } = sb.storage.from('fonts').getPublicUrl(path); 
                const { error: dbErr } = await sb.from('site_fonts').insert([{ site_code: site, font_name: name, font_family: fam, file_url: urlData.publicUrl }]);
                if (dbErr) throw new Error(dbErr.message);
                alert("âœ… í°íŠ¸ ë“±ë¡ ì™„ë£Œ!"); 
                document.getElementById('fontName').value = ''; document.getElementById('fontFamily').value = ''; fileInput.value = '';
                loadFonts(); 
            } catch(e) { alert("ì—ëŸ¬ ë°œìƒ: " + e.message); } finally { btn.innerText = oldText; btn.disabled = false; }
        };

        window.deleteFontDB = async (id) => { if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; try { const { error } = await sb.from('site_fonts').delete().eq('id', id); if(error) throw error; loadFonts(); } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); } };
        // [ìˆ˜ì •] íšŒì› ëª©ë¡ ì¡°íšŒ (ê²€ìƒ‰ ë° í†µê³„ í¬í•¨)
// [ìµœì í™”] íšŒì› ëª©ë¡ ì¡°íšŒ (ìµœê·¼ 50ëª…ë§Œ ë¡œë“œ)
        window.loadMembers = async () => { 
            const keyword = document.getElementById('memberSearchInput') ? document.getElementById('memberSearchInput').value.trim() : '';
            const tbody = document.getElementById('memberListBody'); 
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;"><div class="spinner"></div> ë¡œë”© ì¤‘...</td></tr>';
            
            // [ìµœì í™”] * ëŒ€ì‹  í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì§€ì •í•˜ì—¬ ë°ì´í„° ì „ì†¡ëŸ‰ ê°ì†Œ
// '*'ë¥¼ ì“°ë©´ APIê°€ ì¸ì‹í•˜ëŠ” ëª¨ë“  ì»¬ëŸ¼ì„ ê°€ì ¸ì˜¤ë¯€ë¡œ 400 ì—ëŸ¬ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.
let query = sb.from('profiles')
    .select('*') 
    .order('created_at', {ascending:false});
            
            if(keyword) {
                // ê²€ìƒ‰ì–´ê°€ ìˆì„ ë•ŒëŠ” ì „ì²´ì—ì„œ ê²€ìƒ‰
                query = query.ilike('email', `%${keyword}%`);
            } else {
                // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ìµœê·¼ 50ëª…ë§Œ ê°€ì ¸ì™€ì„œ ì„œë²„ ë³´í˜¸
                query = query.limit(50);
            }

            const {data: members, error} = await query;
            
            if(error) {
                alert("ë¡œë”© ì‹¤íŒ¨: " + error.message);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">ë¡œë“œ ì‹¤íŒ¨</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            
            if(!members || members.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            // [ìˆ˜ì •ë¨] ê¸°ì—¬ì ë“±ê¸‰ ê¸°ëŠ¥ì´ ì¶”ê°€ëœ ë£¨í”„
            members.forEach(m => {
                const r = m.role || 'customer';
                const deposit = m.deposit || 0; 
                const mileage = m.mileage || 0; // ë§ˆì¼ë¦¬ì§€ ì¶”ê°€
                
                // 1. íšŒì› ë“±ê¸‰ (ê¸°ì¡´)
                const roleSelect = `
                    <select onchange="updateMemberRole('${m.id}', this.value)" style="padding:4px; border:1px solid #cbd5e1; border-radius:4px;">
                        <option value="customer" ${r==='customer'?'selected':''}>ì¼ë°˜</option>
                        <option value="gold" ${r==='gold'?'selected':''}>ğŸ¥‡ ê³¨ë“œ</option>
                        <option value="platinum" ${r==='platinum'?'selected':''}>ğŸ’ í”Œë˜í‹°ë„˜</option>
                        <option value="franchise" ${r==='franchise'?'selected':''}>ğŸ¢ ê°€ë§¹ì </option>
                        <option value="admin" ${r==='admin'?'selected':''}>ğŸ›  ê´€ë¦¬ì</option>
                    </select>
                `;

                // 2. [ì‹ ê·œ] ê¸°ì—¬ì ë“±ê¸‰ (Contributor Tier)
                const tier = m.contributor_tier || 'regular';
                const tierSelect = `
                    <div style="margin-top:4px;">
                        <span style="font-size:11px; color:#6366f1; font-weight:bold;">ê¸°ì—¬ë“±ê¸‰:</span>
                        <select onchange="updateContributorTier('${m.id}', this.value)" style="padding:4px; border:1px solid #6366f1; color:#6366f1; border-radius:4px; font-weight:bold;">
                            <option value="regular" ${tier==='regular'?'selected':''}>ğŸ˜ ì¼ë°˜ (x1)</option>
                            <option value="excellent" ${tier==='excellent'?'selected':''}>ğŸ† ìš°ìˆ˜ (x2)</option>
                            <option value="hero" ${tier==='hero'?'selected':''}>ğŸ‘‘ ì˜ì›… (x4)</option>
                        </select>
                    </div>
                `;

                const walletBtn = `
                    <button class="btn btn-outline btn-sm" onclick="openWalletModal('${m.id}', '${m.email}', ${deposit})">
                        <i class="fa-solid fa-coins" style="color:#eab308;"></i> â‚©${deposit.toLocaleString()} ê´€ë¦¬
                    </button>
                `;

                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(m.created_at).toLocaleDateString()}</td>
                        <td>
                            <div style="font-weight:bold;">${m.email}</div>
                            <div style="font-size:12px; color:#888;">${m.full_name || '-'}</div>
                        </td>
                        <td>
                           <div style="font-size:12px;">ì˜ˆì¹˜ê¸ˆ: <b style="color:#6366f1;">${deposit.toLocaleString()}ì›</b></div>
                           <div style="font-size:12px;">ë§ˆì¼ë¦¬ì§€: <b style="color:#059669;">${mileage.toLocaleString()}P</b></div>
                           <div style="font-size:11px; color:#888; margin-top:2px;">(êµ¬ë§¤: ${(m.total_spend || 0).toLocaleString()}ì›)</div>
                        </td>
                        <td>
                            ${walletBtn}
                            <button class="btn btn-outline btn-sm" onclick="editMileageManual('${m.id}', '${m.email}', ${mileage})" style="margin-top:4px;">
                                â“‚ï¸ ê´€ë¦¬
                            </button>
                        </td> 
                        <td><span class="badge" style="background:#f1f5f9;">${r.toUpperCase()}</span></td>
                        <td>
                            ${roleSelect}
                            ${tierSelect}
                        </td>
                    </tr>
                `;
            });
        }; // loadMembers í•¨ìˆ˜ ë

        // [ì‹ ê·œ] ê¸°ì—¬ì ë“±ê¸‰ ë³€ê²½ í•¨ìˆ˜ (admin.html ìŠ¤í¬ë¦½íŠ¸ ë§¨ ì•„ë˜ë‚˜ ì ì ˆí•œ ê³³ì— ì¶”ê°€)
        window.updateContributorTier = async (id, newTier) => {
            if(!confirm("ê¸°ì—¬ì ë“±ê¸‰ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(í•´ë‹¹ íšŒì›ì˜ ì—…ë¡œë“œ ìˆ˜ìµ ë°°ìˆ˜ê°€ ì¦‰ì‹œ ë³€ê²½ë©ë‹ˆë‹¤)")) {
                loadMembers(); // ì·¨ì†Œ ì‹œ UI ì›ë³µ
                return;
            }
            
            const { error } = await sb.from('profiles').update({ contributor_tier: newTier }).eq('id', id);
            
            if(error) alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
            else alert("âœ… ê¸°ì—¬ì ë“±ê¸‰ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        };

// [ìˆ˜ì •] íšŒì› ë“±ê¸‰ ë³€ê²½ í•¨ìˆ˜
window.updateMemberRole = async (id, newRole) => { 
    if(!confirm(`í•´ë‹¹ íšŒì›ì˜ ë“±ê¸‰ì„ '${newRole}'(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { 
        loadMembers(); // ì·¨ì†Œ ì‹œ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¼
        return; 
    } 
    
    const { error } = await sb.from('profiles').update({ role: newRole }).eq('id', id); 
    
    if(error) alert("ë³€ê²½ ì‹¤íŒ¨: " + error.message); 
    else alert("âœ… ë“±ê¸‰ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); 
};
        function initTemplateListeners() { const fThumb = document.getElementById('fileThumb'); if(fThumb) fThumb.addEventListener('change', e=>{const f=e.target.files[0]; const r=new FileReader(); r.onload=ev=>{document.getElementById('previewThumb').src=ev.target.result; document.getElementById('previewThumb').style.display='block';}; r.readAsDataURL(f);}); const fData = document.getElementById('fileData'); if(fData) fData.addEventListener('change', e=>{const f=e.target.files[0]; const r=new FileReader(); r.onload=ev=>{if(f.name.endsWith('.svg')){document.getElementById('dataStatus').style.display='block';}}; r.readAsDataURL(f);}); }
        
        window.toggleFileInputs = () => { 
            const cat = document.getElementById('tplCategory').value;
            const groupData = document.getElementById('groupDataFile');
            const needsVector = ['vector', 'transparent-graphic', 'logo', 'graphic'].includes(cat);
            if (needsVector) { groupData.style.display = 'block'; } else { groupData.style.display = 'none'; }
        };
        
        window.loadProductKeys = async () => {
            const regSelect = document.getElementById('tplProductKey'); 
            const filterSelect = document.getElementById('filterTplProduct'); 
            if(!regSelect || !filterSelect) return;
            regSelect.innerHTML = '<option value="custom">ê³µí†µ / ì§€ì •ì•ˆí•¨</option>';
            filterSelect.innerHTML = `<option value="all">ğŸ“¦ ì œí’ˆì—°ê²°: ì „ì²´ ë³´ê¸°</option><option value="custom">ğŸ”¹ ê³µí†µ í…œí”Œë¦¿ë§Œ ë³´ê¸°</option><option value="assigned">ğŸ”¸ ì œí’ˆ ì „ìš©ë§Œ ë³´ê¸°</option><optgroup label="--- ê°œë³„ ì œí’ˆ ì„ íƒ ---"></optgroup>`;
            const { data: prods } = await sb.from('admin_products').select('code, name').order('name');
            if(prods) { prods.forEach(p => { const optionHtml = `<option value="${p.code}">${p.name} (${p.code})</option>`; regSelect.innerHTML += optionHtml; filterSelect.innerHTML += optionHtml; }); }
        };

        // [ìµœì í™”] í…œí”Œë¦¿ ëª©ë¡ ë¡œë“œ (50ê°œ ì œí•œ + ì´ë¯¸ì§€ ì••ì¶•)
        // [ìˆ˜ì •ë¨] í…œí”Œë¦¿ ëª©ë¡ ë¡œë“œ (í˜ì´ì§• + ì´ë¯¸ì§€ ì´ˆê²½ëŸ‰í™”)
window.loadTemplates = async (isNewSearch = false) => { 
    const grid = document.getElementById('tplGrid'); 
    const catFilter = document.getElementById('filterTplCat').value; 
    const prodFilter = document.getElementById('filterTplProduct').value;
    const searchKeyword = document.getElementById('tplSearchInput').value.trim();

    // ê²€ìƒ‰ì´ë‚˜ í•„í„° ë³€ê²½ ì‹œ 1í˜ì´ì§€ë¡œ ì´ˆê¸°í™”
    if (isNewSearch) {
        currentTplPage = 1;
        document.getElementById('tplPageLabel').innerText = `Page 1`;
    }

    if(!grid) return; 
    grid.innerHTML = '<div style="padding:20px; text-align:center; grid-column:1/-1;"><div class="spinner"></div> ë¡œë”© ì¤‘...</div>'; 
    
    // 1. í˜ì´ì§€ ê³„ì‚° (Range ì„¤ì •)
    const from = (currentTplPage - 1) * tplItemsPerPage;
    const to = from + tplItemsPerPage - 1;

    let query = sb.from('library')
        .select('id, category, thumb_url, tags, product_key', { count: 'exact' }) // ì „ì²´ ê°œìˆ˜ë„ íŒŒì•…
        .order('created_at', {ascending:false})
        .range(from, to); // â˜… 10ê°œë§Œ ê°€ì ¸ì˜¤ê¸°
    
    // í•„í„° ì¡°ê±´ë“¤
    if (catFilter !== 'all') query = query.eq('category', catFilter); 
    
    if (prodFilter === 'custom') query = query.or('product_key.eq.custom,product_key.is.null');
    else if (prodFilter === 'assigned') query = query.neq('product_key', 'custom').not('product_key', 'is', null);
    else if (prodFilter !== 'all') query = query.eq('product_key', prodFilter);

    if (searchKeyword) {
        if (!isNaN(searchKeyword)) query = query.eq('id', searchKeyword);
        else query = query.ilike('tags', `%${searchKeyword}%`);
    }

    const { data, error, count } = await query; 
    
    grid.innerHTML = ''; 
    if (error) { 
        grid.innerHTML = '<div style="padding:20px; color:red; grid-column:1/-1;">ì—ëŸ¬: ' + error.message + '</div>'; 
        return; 
    } 
    
    if (data && data.length > 0) { 
        data.forEach(t => { 
            const tagText = t.tags ? t.tags : '-'; 
            const pKey = (t.product_key && t.product_key !== 'custom') ? t.product_key : 'ê³µí†µ'; 
            const isCustom = pKey === 'ê³µí†µ'; 
            const badgeStyle = isCustom ? "background:#f1f5f9; color:#64748b;" : "background:#eff6ff; color:#2563eb; border:1px solid #bfdbfe;"; 
            
            // â˜… [í•µì‹¬] ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• ê°•ì œ (í•´ìƒë„ ëŒ€í­ ë‚®ì¶¤: 150px, í’ˆì§ˆ 40)
            let thumbUrl = t.thumb_url;
            if (thumbUrl && thumbUrl.includes('supabase.co')) {
                const sep = thumbUrl.includes('?') ? '&' : '?';
                // width=150: ì¸ë„¤ì¼ìš©ìœ¼ë¡œ ì•„ì£¼ ì‘ê²Œ
                // quality=40: ìš©ëŸ‰ ëŒ€í­ ê°ì†Œ
                thumbUrl += `${sep}width=150&height=150&resize=cover&quality=40&format=webp`;
            }

            grid.innerHTML += `
            <div class="tpl-card">
                <div style="position:absolute; top:10px; right:10px; z-index:10;">
                    <input type="checkbox" class="tpl-chk" value="${t.id}" style="width:18px; height:18px; cursor:pointer;">
                </div>
                <img src="${thumbUrl}" class="tpl-thumb" loading="lazy" style="cursor:pointer;" onclick="window.open('${t.thumb_url}')">
                <div class="tpl-info">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <span class="badge" style="background:#f1f5f9;">${t.category}</span>
                        <span style="font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; ${badgeStyle}">${pKey}</span>
                    </div>
                    <div style="font-size:12px; font-weight:bold; color:#334155; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${tagText}">${tagText}</div>
                    <button class="tpl-del-btn" onclick="deleteTemplate(${t.id})">ì‚­ì œ</button>
                </div>
            </div>`; 
        }); 
        
        // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸ (ì˜ˆ: Page 1 / Total 50)
        const totalPages = Math.ceil((count || 0) / tplItemsPerPage);
        document.getElementById('tplPageLabel').innerHTML = `Page ${currentTplPage} <span style="color:#94a3b8; font-weight:normal;">/ ${totalPages || 1}</span>`;

    } else { 
        grid.innerHTML = '<div style="padding:40px; color:#999; text-align:center; width:100%; grid-column:1/-1;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; 
    } 
};

// [ì‹ ê·œ] í˜ì´ì§€ ë³€ê²½ í•¨ìˆ˜
window.changeTplPage = (step) => {
    const newPage = currentTplPage + step;
    if (newPage < 1) return alert("ì²« ë²ˆì§¸ í˜ì´ì§€ì…ë‹ˆë‹¤.");
    
    // ë‹¤ìŒ í˜ì´ì§€ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ê±´ loadTemplates ì•ˆì—ì„œ ì²˜ë¦¬ë˜ì§€ë§Œ,
    // ê°„ë‹¨íˆ UIì—ì„œ ë§‰ê¸° ìœ„í•´ ì¼ë‹¨ ì´ë™ì‹œí‚´ (ë°ì´í„° ì—†ìœ¼ë©´ 'ë°ì´í„° ì—†ìŒ' ëœ¸)
    currentTplPage = newPage;
    document.getElementById('tplPageLabel').innerText = `Page ${currentTplPage}...`;
    loadTemplates(false); // false = í˜ì´ì§€ ì´ë™ì´ë¯€ë¡œ ì´ˆê¸°í™” ì•ˆ í•¨
};

        // [ì‹ ê·œ] í…œí”Œë¦¿ ì „ì²´ ì„ íƒ/í•´ì œ
        window.toggleAllTemplates = (source) => {
            document.querySelectorAll('.tpl-chk').forEach(chk => chk.checked = source.checked);
        };

        // [ì‹ ê·œ] ì„ íƒëœ í…œí”Œë¦¿ ì¼ê´„ ì‚­ì œ
        window.deleteSelectedTemplates = async () => {
            const checks = document.querySelectorAll('.tpl-chk:checked');
            if (checks.length === 0) return alert("ì‚­ì œí•  í…œí”Œë¦¿ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            
            if (!confirm(`ì„ íƒí•œ ${checks.length}ê°œì˜ ì´ë¯¸ì§€ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)`)) return;

            const ids = Array.from(checks).map(c => c.value);
            const btn = document.querySelector('button[onclick="deleteSelectedTemplates()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ì‚­ì œ ì¤‘...';
            btn.disabled = true;

            try {
                // Supabaseì—ì„œ ì¼ê´„ ì‚­ì œ
                const { error } = await sb.from('library').delete().in('id', ids);
                if (error) throw error;
                
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadTemplates(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (e) {
                alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
        
        window.uploadTemplate = async () => { 
            const cat = document.getElementById('tplCategory').value; const tags = document.getElementById('tplTags').value; const prodKey = document.getElementById('tplProductKey').value; 
            const thumbFile = document.getElementById('fileThumb').files[0]; const dataFile = document.getElementById('fileData').files[0]; 
            if (!thumbFile) return alert("ì¸ë„¤ì¼ ì´ë¯¸ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."); 
            const btn = document.querySelector('#sec-templates .btn-primary'); const originalText = btn.innerText; btn.innerText = "ì—…ë¡œë“œ ì¤‘..."; btn.disabled = true; 
            try { 
                const timestamp = Date.now(); const thumbPath = `thumbs/${timestamp}_${thumbFile.name}`; 
                const { error: thumbErr } = await sb.storage.from('design').upload(thumbPath, thumbFile); if(thumbErr) throw thumbErr; 
                const { data: thumbUrlData } = sb.storage.from('design').getPublicUrl(thumbPath); const thumbUrl = thumbUrlData.publicUrl; 
                let dataUrl = thumbUrl; 
                if ((cat === 'transparent-graphic' || cat === 'vector') && dataFile) { const dataPath = `assets/${timestamp}_${dataFile.name}`; const { error: dataErr } = await sb.storage.from('design').upload(dataPath, dataFile); if(dataErr) throw dataErr; const { data: dataUrlData } = sb.storage.from('design').getPublicUrl(dataPath); dataUrl = dataUrlData.publicUrl; } 
                const { error: dbErr } = await sb.from('library').insert({ category: cat, tags: tags || 'ê´€ë¦¬ìë“±ë¡', thumb_url: thumbUrl, data_url: dataUrl, width: 1000, height: 1000, product_key: prodKey }); if (dbErr) throw dbErr; 
                alert("âœ… í…œí”Œë¦¿ ë“±ë¡ ì„±ê³µ!"); document.getElementById('tplTags').value = ''; document.getElementById('fileThumb').value = ''; document.getElementById('fileData').value = ''; document.getElementById('previewThumb').style.display = 'none'; document.getElementById('dataStatus').style.display = 'none'; loadTemplates(); 
            } catch(e) { alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message); } finally { btn.innerText = originalText; btn.disabled = false; } 
        };
        window.deleteTemplate = async (id) => { if(confirm("ì‚­ì œ?")) await sb.from('library').delete().eq('id',id); loadTemplates(); };

        function getDeliveryTimeOptions(selectedTime) { let html = '<option value="">ì‹œê°„ ë¯¸ì •</option>'; for (let i = 8; i <= 24; i += 2) { let timeStr = (i < 10 ? '0' + i : i) + ":00"; let isSelected = selectedTime === timeStr ? 'selected' : ''; html += `<option value="${timeStr}" ${isSelected}>${timeStr}</option>`; } return html; }

        window.loadDailyTasks = async () => {
            const dateInput = document.getElementById('taskDate'); if (!dateInput.value) { const today = new Date().toISOString().split('T')[0]; dateInput.value = today; }
            const targetDate = dateInput.value; const driverFilterId = document.getElementById('filterTaskDriver').value;
            showLoading(true); const tbody = document.getElementById('taskListBody'); tbody.innerHTML = '';
            if (staffList.length === 0) await fetchStaffForOrders();
            const filterSelect = document.getElementById('filterTaskDriver'); if(filterSelect.options.length === 1) { staffList.filter(s => s.role === 'driver').forEach(s => { filterSelect.innerHTML += `<option value="${s.id}">${s.name} ê¸°ì‚¬ë‹˜</option>`; }); }
            let { data: orders, error } = await sb.from('orders').select('*').eq('delivery_target_date', targetDate);
            if (error) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px;">ë¡œë“œ ì—ëŸ¬: ${error.message}</td></tr>`; showLoading(false); return; }
            if (!orders || orders.length === 0) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:#999;">${targetDate} ë°°ì†¡ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; showLoading(false); return; }
            if(driverFilterId !== 'all') { orders = orders.filter(o => o.staff_driver_id == driverFilterId); }
            if(orders.length === 0) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:#999;">í•´ë‹¹ ê¸°ì‚¬ë‹˜ì˜ ë°°ì†¡ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; showLoading(false); return; }
            orders.sort((a, b) => { const driverA = staffList.find(s=>s.id == a.staff_driver_id)?.name || 'zzz'; const driverB = staffList.find(s=>s.id == b.staff_driver_id)?.name || 'zzz'; if (driverA !== driverB) return driverA.localeCompare(driverB); const timeA = a.delivery_time || "99:99"; const timeB = b.delivery_time || "99:99"; return timeA.localeCompare(timeB); });
            orders.forEach(o => { const isDone = (o.status === 'ë°°ì†¡ì™„ë£Œ'); const dotColor = isDone ? '#22c55e' : '#cbd5e1'; const dotShadow = isDone ? '0 0 5px #4ade80' : 'none'; const statusBadge = isDone ? `<span class="badge" style="background:#dcfce7; color:#15803d; border:1px solid #bbf7d0; white-space:nowrap;">ë°°ì†¡ì™„ë£Œ</span>` : `<span class="badge" style="background:#f1f5f9; color:#64748b; white-space:nowrap;">${o.status}</span>`; const rowStyle = isDone ? 'background-color: #f0fdf4;' : ''; const textStyle = isDone ? 'opacity: 0.6;' : ''; let fileLinks = ''; if(o.files && Array.isArray(o.files)) { o.files.forEach(f => { fileLinks += `<a href="${f.url}" target="_blank" class="btn-file" style="margin-right:4px;">ğŸ“„ ${f.name}</a>`; }); } else { fileLinks = '<span style="color:#ccc;">íŒŒì¼ ì—†ìŒ</span>'; } let driverOpts = `<option value="">ë¯¸ì§€ì •</option>`; staffList.filter(s => s.role === 'driver').forEach(s => { const selected = o.staff_driver_id == s.id ? 'selected' : ''; driverOpts += `<option value="${s.id}" ${selected}>${s.name}</option>`; }); const timeOpts = getDeliveryTimeOptions(o.delivery_time); const tr = document.createElement('tr'); tr.style.cssText = rowStyle; tr.innerHTML = `<td style="text-align:center;">${statusBadge}</td><td style="${textStyle}"><div style="font-weight:bold; font-size:15px;">${o.manager_name}</div><div style="font-size:13px; color:#6366f1;">${o.phone}</div><div style="font-size:12px; color:#666; margin-top:2px;">${o.address}</div></td><td style="${textStyle}"><div style="display:flex; flex-wrap:wrap;">${fileLinks}</div></td><td><select class="input-text" onchange="updateTaskDB('${o.id}', 'staff_driver_id', this.value)" style="width:100%; ${isDone ? 'background:transparent; border:none; font-weight:bold; appearance:none;' : ''}" ${isDone?'disabled':''}>${driverOpts}</select></td><td><div style="display:flex; align-items:center; gap:8px;"><select class="input-text" onchange="updateTaskDB('${o.id}', 'delivery_time', this.value)" style="flex:1; font-weight:bold; color:#0f172a; ${isDone ? 'background:transparent; border:none; appearance:none;' : ''}" ${isDone?'disabled':''}>${timeOpts}</select><div title="${isDone ? 'ë°°ì†¡ ì™„ë£Œë¨' : 'ë°°ì†¡ ì¤‘'}" style="width:18px; height:18px; border-radius:50%; background:${dotColor}; box-shadow:${dotShadow}; flex-shrink:0; cursor:default; border:2px solid white; outline:1px solid ${isDone?'#22c55e':'#cbd5e1'};"></div></div></td>`; tbody.appendChild(tr); }); showLoading(false);
        };
        window.updateTaskDB = async (orderId, field, value) => { const valToSave = value === "" ? null : value; const { error } = await sb.from('orders').update({ [field]: valToSave }).eq('id', orderId); if (error) { alert("ì €ì¥ ì‹¤íŒ¨: " + error.message); } };
        window.addEventListener('DOMContentLoaded', async () => { 
            // 1. í™”ë©´ ê¹œë¹¡ì„ ë°©ì§€ë¥¼ ìœ„í•´ ì¼ë‹¨ ìˆ¨ê¹€
            document.body.style.visibility = 'hidden';
            
            await initConfig(); 
            
            // 2. ë³´ì•ˆ ì²´í¬ ì‹¤í–‰ (í†µê³¼ ëª»í•˜ë©´ ì—¬ê¸°ì„œ ë©ˆì¶”ê³  ì«“ê²¨ë‚¨)
            const isAdmin = await checkAdminAccess();
            if (!isAdmin) return;

            // 3. í†µê³¼ëœ ê²½ìš°ì—ë§Œ ë°ì´í„° ë¡œë“œ ì‹œì‘
            loadVipOrders(); // ì´ˆê¸° í™”ë©´ì¸ VIP ëª©ë¡ ë¡œë“œ
            initTemplateListeners();
            loadCategories(); 
            loadFonts(); 
        });

        // [ì‹ ê·œ] ì¶œê¸ˆ ëª©ë¡ ë¡œë“œ
        // [ìˆ˜ì •ë¨] ì¶œê¸ˆ ëª©ë¡ ë¡œë“œ (ì˜¤ë¥˜ ë°©ì§€ ë²„ì „)
        // [ìˆ˜ì •ëœ admin.htmlìš© ì¶œê¸ˆ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜]
// [ìˆ˜ì •ëœ admin.htmlìš© ì¶œê¸ˆ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜]
window.loadWithdrawals = async () => {
    const tbody = document.getElementById('withdrawalListBody');
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">ë¡œë”© ì¤‘...</td></tr>';
    
    try {
        const { data: requests, error } = await sb.from('withdrawal_requests')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!requests || requests.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">ì¶œê¸ˆ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        const userIds = [...new Set(requests.map(r => r.user_id))];
        const { data: users } = await sb.from('profiles').select('id, email, full_name').in('id', userIds);
        const userMap = {};
        if (users) users.forEach(u => userMap[u.id] = u);

        tbody.innerHTML = '';
        requests.forEach(r => {
            const user = userMap[r.user_id];
            const displayUser = user ? 
                `<div style="font-weight:bold;">${user.full_name || 'ì´ë¦„ë¯¸ìƒ'}</div><div style="font-size:11px; color:#888;">${user.email}</div>` 
                : `<span style="font-size:11px; color:#999;">ì‚­ì œëœ íšŒì›<br>(${r.user_id.substring(0,8)}...)</span>`;
            
            // ì„¸ê¸ˆê³„ì‚°ì„œ ë§í¬
            const taxLink = r.tax_invoice_url 
                ? `<a href="${r.tax_invoice_url}" target="_blank" class="btn btn-outline btn-sm" style="margin-top:2px;">ğŸ“„ ì„¸ê¸ˆê³„ì‚°ì„œ</a>` 
                : '<span style="color:#aaa; font-size:11px;">(ì¦ë¹™ ë¯¸ì²¨ë¶€)</span>';

            const statusBadge = r.status === 'pending' 
                ? '<span class="badge" style="background:#fff7ed; color:#c2410c; border:1px solid #ffedd5;">ëŒ€ê¸°ì¤‘</span>'
                : '<span class="badge" style="background:#dcfce7; color:#15803d; border:1px solid #bbf7d0;">ì™„ë£Œë¨</span>';
            
            const actionBtn = r.status === 'pending'
                ? `<button class="btn btn-primary btn-sm" onclick="approveWithdrawal(${r.id})">ì…ê¸ˆí™•ì¸ ì²˜ë¦¬</button>`
                : `<span style="color:#cbd5e1; font-size:12px;">ì²˜ë¦¬ì™„ë£Œ</span>`;

            // [ìˆ˜ì •] ê³„ì¢Œë²ˆí˜¸(account_number) ì¶”ê°€ ë° nullê°’ ì²˜ë¦¬ ê°•í™”
            const detailInfo = `
                <div style="font-weight:bold; font-size:13px; color:#1e293b;">
                    ${r.bank_name || 'ì€í–‰ë¯¸ì •'} <span style="color:#2563eb;">${r.account_number || '(ê³„ì¢Œì •ë³´ ì—†ìŒ)'}</span>
                </div>
                <div style="font-size:12px; color:#334155; margin-top:2px;">
                    ì˜ˆê¸ˆì£¼: <b>${r.account_holder || '-'}</b>
                </div>
                <div style="margin-top:4px; padding-top:4px; border-top:1px dashed #e2e8f0;">
                    <div style="font-size:11px; color:#64748b;">ğŸ“ ${r.contact_phone || '<span style="color:#ccc">ì—°ë½ì²˜ ì—†ìŒ</span>'}</div>
                    <div style="font-size:11px; color:#64748b; letter-spacing:0.5px;">ğŸ†” ${r.rrn || '<span style="color:#ccc">ì£¼ë¯¼ë²ˆí˜¸ ì—†ìŒ</span>'}</div>
                </div>
                <div style="margin-top:4px;">${taxLink}</div>
            `;

            tbody.innerHTML += `
                <tr>
                    <td>${new Date(r.created_at).toLocaleString()}</td>
                    <td>${displayUser}</td>
                    <td style="font-weight:bold; color:#d97706;">${r.amount.toLocaleString()}ì›</td>
                    <td style="text-align:left;">${detailInfo}</td>
                    <td style="text-align:center;">${statusBadge}</td>
                    <td style="text-align:center;">${actionBtn}</td>
                </tr>
            `;
        });

    } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${e.message}</td></tr>`;
    }
};
// [ì‹ ê·œ] ê´€ë¦¬ì ì¶œê¸ˆ ìŠ¹ì¸ (ì…ê¸ˆí™•ì¸ ì²˜ë¦¬) í•¨ìˆ˜
window.approveWithdrawal = async (requestId) => {
    if(!confirm("í•´ë‹¹ ê±´ì„ 'ì…ê¸ˆì™„ë£Œ' ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {
        // 1. ìƒíƒœ ì—…ë°ì´íŠ¸ (pending -> approved)
        const { error } = await sb.from('withdrawal_requests')
            .update({ 
                status: 'approved',
                processed_at: new Date().toISOString()
            })
            .eq('id', requestId);

        if(error) throw error;

        alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadWithdrawals(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨

    } catch(e) {
        alert("ì²˜ë¦¬ ì‹¤íŒ¨: " + e.message);
    }
};

// [ì‹ ê·œ] ë³¸ì‚¬ ì§ì ‘ ì ‘ìˆ˜ í•¨ìˆ˜ (íŒŒíŠ¸ë„ˆìŠ¤ í™”ë©´ì—ì„œ ì ê¸ˆ ì²˜ë¦¬ë¨)
    window.claimOrderAdmin = async (orderId) => {
        if(!confirm("ì´ ì£¼ë¬¸ì„ ë³¸ì‚¬(HQ)ì—ì„œ ì§ì ‘ ì œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\níŒŒíŠ¸ë„ˆìŠ¤ ë¦¬ìŠ¤íŠ¸ì—ì„œëŠ” 'ë³¸ì‚¬ ì œì‘ì¤‘'ìœ¼ë¡œ í‘œì‹œë˜ë©° ì„ íƒì´ ë¶ˆê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.")) return;

        try {
            const { data: { user } } = await sb.auth.getUser();
            if(!user) return alert("ê´€ë¦¬ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            // ë³¸ì‚¬ ê´€ë¦¬ì IDë¡œ ì—…ë°ì´íŠ¸ -> íŒŒíŠ¸ë„ˆìŠ¤ í™”ë©´ì—ì„œ 'Lock' ë¨
            const { error } = await sb.from('orders').update({
                franchise_id: user.id, 
                status: 'ì œì‘ì¤€ë¹„'      
            }).eq('id', orderId);

            if(error) throw error;

            alert("âœ… ë³¸ì‚¬ ì œì‘ê±´ìœ¼ë¡œ ì§€ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadOrders(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } catch(e) {
            alert("ì²˜ë¦¬ ì‹¤íŒ¨: " + e.message);
        }
    };

    // [ì‹ ê·œ] ì ‘ìˆ˜ ì·¨ì†Œ í•¨ìˆ˜ (ì´ˆê¸°í™”)
    window.cancelFranchiseClaim = async (orderId) => {
        if(!confirm("í˜„ì¬ ë‹´ë‹¹ì(íŒŒíŠ¸ë„ˆ/ë³¸ì‚¬) ì§€ì •ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në‹¤ì‹œ 'ëŒ€ê¸°ì¤‘' ìƒíƒœê°€ ë˜ì–´ íŒŒíŠ¸ë„ˆë“¤ì´ ë³¼ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.")) return;

        const { error } = await sb.from('orders').update({
            franchise_id: null,
            status: 'ì ‘ìˆ˜ëŒ€ê¸°'
        }).eq('id', orderId);

        if(error) alert("í•´ì œ ì‹¤íŒ¨: " + error.message);
        else loadOrders();
    };

    // [ì‹ ê·œ] ë¦¬ìŠ¤íŠ¸ì—ì„œ ë°”ë¡œ íŒŒì¼ ì—…ë¡œë“œ
    // [ì‹ ê·œ] ë¦¬ìŠ¤íŠ¸ì—ì„œ ë°”ë¡œ íŒŒì¼ ì—…ë¡œë“œ
    window.uploadFileDirect = async (orderId, input) => {
        if (!input.files || input.files.length === 0) return;
        const file = input.files[0];
        showLoading(true);

        try {
            const { data: order } = await sb.from('orders').select('files').eq('id', orderId).single();
            const currentFiles = order.files || [];

            const parts = file.name.split('.');
            const ext = parts.length > 1 ? parts.pop() : ''; 
            const timestamp = Date.now();
            const randomStr = Math.random().toString(36).substring(2, 8); 
            const safeName = `added_${timestamp}_${randomStr}.${ext}`;
            const path = `orders/${orderId}/${safeName}`;

            const { error: upErr } = await sb.storage.from('orders').upload(path, file);
            if (upErr) throw upErr;

            const { data: urlData } = sb.storage.from('orders').getPublicUrl(path);

            currentFiles.push({
                name: file.name,
                url: urlData.publicUrl,
                type: 'admin_added'
            });

            const { error: dbErr } = await sb.from('orders').update({ files: currentFiles }).eq('id', orderId);
            if (dbErr) throw dbErr;

            alert("íŒŒì¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadOrders();

        } catch (e) {
            console.error(e);
            alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message);
        } finally {
            showLoading(false);
        }
    };

    // [íŒŒì¼ ì‚­ì œ í•¨ìˆ˜]
    window.deleteFileDirect = async (orderId, fileIndex) => {
        if (!confirm("âš ï¸ ì •ë§ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» ì‚­ì œëœ íŒŒì¼ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;

        showLoading(true);
        try {
            const { data: order } = await sb.from('orders').select('files').eq('id', orderId).single();
            let files = order.files || [];
            
            // ë°°ì—´ì—ì„œ í•´ë‹¹ ì¸ë±ìŠ¤ ì œê±°
            files.splice(fileIndex, 1);

            const { error } = await sb.from('orders').update({ files: files }).eq('id', orderId);
            if (error) throw error;

            loadOrders(); // í™”ë©´ ê°±ì‹ 
        } catch (e) {
            alert("ì‚­ì œ ì˜¤ë¥˜: " + e.message);
        } finally {
            showLoading(false);
        }
    };

    // [ì‹ ê·œ] ë¬´í†µì¥ ì…ê¸ˆ í™•ì¸ ì²˜ë¦¬
    window.confirmDeposit = async (orderId) => {
        if (!confirm("ì…ê¸ˆ í™•ì¸ ì²˜ë¦¬ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ìƒíƒœê°€ 'ì…ê¸ˆí™•ì¸'ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤)")) return;
        
        showLoading(true);
        try {
            const { error } = await sb.from('orders').update({ 
                payment_status: 'ì…ê¸ˆí™•ì¸', 
                payment_method: 'ë¬´í†µì¥ì…ê¸ˆ'
            }).eq('id', orderId);

            if (error) throw error;
            loadOrders();
        } catch (e) {
            alert("ì²˜ë¦¬ ì‹¤íŒ¨: " + e.message);
        } finally {
            showLoading(false);
        }
    };

    // [ì‹ ê·œ] ê²½ë¦¬ê³¼ ë°ì´í„° í†µí•© ì¡°íšŒ
    // [ì „ì—­ ë³€ìˆ˜] ê²½ë¦¬ê³¼ ì—‘ì…€ìš© ë°ì´í„° ìºì‹±
    let cachedAccOrders = [];      // ë§¤ì¶œ/í• ì¸ìš©
    let cachedAccWithdrawals = []; // ë¯¸ì§€ê¸‰ìš©
    let cachedAccProfiles = [];    // ì˜ˆì¹˜ê¸ˆìš©

    // 1. [ì¡°íšŒ] ê²½ë¦¬ê³¼ ë°ì´í„° í†µí•© ì¡°íšŒ
    window.loadAccountingData = async () => {
        const start = document.getElementById('accStartDate').value;
        const end = document.getElementById('accEndDate').value;
        
        if(!start || !end) return alert("ë‚ ì§œ ë²”ìœ„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        showLoading(true);

        try {
            // --- (A) ì˜ˆì¹˜ê¸ˆ ì´ì•¡ ì¡°íšŒ ---
            const { data: profiles } = await sb.from('profiles').select('id, email, full_name, deposit, role');
            cachedAccProfiles = profiles || [];
            const totalDeposit = cachedAccProfiles.reduce((acc, cur) => acc + (cur.deposit || 0), 0);
            document.getElementById('accTotalDeposit').innerText = totalDeposit.toLocaleString() + "ì›";

            // --- (B) ê¸°ê°„ ë‚´ [ê²°ì œì™„ë£Œ] ì£¼ë¬¸ ì¡°íšŒ ---
            const { data: orders, error } = await sb.from('orders')
    .select('id, total_amount, items, payment_method, created_at, manager_name, discount_amount') 
    .gte('created_at', start + 'T00:00:00')
    .lte('created_at', end + 'T23:59:59')
                .in('payment_status', ['ê²°ì œì™„ë£Œ', 'ì…ê¸ˆí™•ì¸', 'ì¹´ë“œê²°ì œì™„ë£Œ', 'ì…ê¸ˆí™•ì¸ë¨', 'paid']);

            if (error) throw error;
            cachedAccOrders = orders || [];

            let totalSales = 0;
            let totalDiscount = 0;

            // ìƒí’ˆ ì›ê°€í‘œ (í• ì¸ì•¡ ê³„ì‚°ìš©)
            const { data: prods } = await sb.from('admin_products').select('name, price');
            const prodMap = {}; if(prods) prods.forEach(p => prodMap[p.name] = p.price);

            cachedAccOrders.forEach(o => {
                totalSales += (o.total_amount || 0);

                // í• ì¸ì•¡ ê³„ì‚° (ì›ê°€í•©ê³„ - ì‹¤ê²°ì œì•¡)
                let items = [];
                try { items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items; } catch(e){}
                
                let rawTotal = 0;
                if(items) {
                    items.forEach(i => {
                        let price = i.price || (i.product ? i.product.price : 0) || 0;
                        if (price === 0 && prodMap[i.productName]) price = prodMap[i.productName] || 0;
                        rawTotal += price * (i.qty || 1);
                    });
                }
                if (rawTotal > o.total_amount) {
                    o.discount_amount = (rawTotal - o.total_amount); // ì—‘ì…€ìš© ì €ì¥
                    o.discount_rate = ((o.discount_amount / rawTotal) * 100).toFixed(1);
                    totalDiscount += o.discount_amount;
                } else {
                    o.discount_amount = 0;
                    o.discount_rate = 0;
                }
            });

            document.getElementById('accTotalSales').innerText = totalSales.toLocaleString() + "ì›";
            document.getElementById('accTotalDiscount').innerText = totalDiscount.toLocaleString() + "ì›";

            // --- (C) ì •ì‚°(ì¶œê¸ˆ) ë‚´ì—­ ì¡°íšŒ ---
            const { data: withdraws } = await sb.from('withdrawal_requests')
                .select('*')
                .gte('created_at', start + 'T00:00:00')
                .lte('created_at', end + 'T23:59:59')
                .order('created_at', {ascending: false});

            cachedAccWithdrawals = withdraws || [];

            let partnerHtml = '';
            let freeHtml = '';
            let unpaidTotal = 0;

            // ì‚¬ìš©ì ì •ë³´ ë§¤í•‘
            const uids = [...new Set(cachedAccWithdrawals.map(w => w.user_id))];
            const userMap = {};
            if(uids.length > 0) {
                const { data: users } = await sb.from('profiles').select('id, full_name, role, email').in('id', uids);
                if(users) users.forEach(u => userMap[u.id] = u);
            }

            cachedAccWithdrawals.forEach(w => {
                const u = userMap[w.user_id] || { full_name: 'ë¯¸ìƒ', role: 'customer' };
                w.userName = u.full_name; // ì—‘ì…€ìš© ì €ì¥
                w.userRole = u.role;

                // ë¯¸ì§€ê¸‰ê¸ˆ í•©ì‚° (status='pending')
                if (w.status === 'pending') unpaidTotal += w.amount;

                // ìƒíƒœ ë±ƒì§€
                const statusBadge = w.status === 'pending' 
                    ? `<span style="color:#d97706; font-weight:bold;">ëŒ€ê¸°</span>` 
                    : `<span style="color:#15803d;">ì™„ë£Œ</span>`;

                // [ì¤‘ìš”] 5ë²ˆ(í”„ë¦¬ëœì„œ)ì€ ì£¼ë¯¼ë²ˆí˜¸ ì¹¸ì´ í•„ìš”í•˜ë¯€ë¡œ êµ¬ë¶„
                // ì£¼ë¯¼ë²ˆí˜¸ëŠ” DB ì»¬ëŸ¼ì´ ë³„ë„ë¡œ ì—†ìœ¼ë©´ ì¼ë‹¨ ë¹„ì›Œë‘ê±°ë‚˜ user_metadata ë“±ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨ (í˜„ì¬ëŠ” '-')
                const rowPartner = `
                    <tr>
                        <td>${new Date(w.created_at).toLocaleDateString()}</td>
                        <td>${u.full_name}</td>
                        <td style="text-align:right;">${w.amount.toLocaleString()}</td>
                        <td style="text-align:center;">${w.tax_invoice_url ? '<a href="'+w.tax_invoice_url+'" target="_blank">ğŸ“„ë³´ê¸°</a>' : '-'}</td>
                        <td style="text-align:center;">${statusBadge}</td>
                    </tr>
                `;

                const rowFree = `
                    <tr>
                        <td>${new Date(w.created_at).toLocaleDateString()}</td>
                        <td>${u.full_name}</td>
                        <td style="text-align:right;">${w.amount.toLocaleString()}</td>
                        <td style="text-align:center;">-</td> <td style="text-align:center;">${statusBadge}</td>
                    </tr>
                `;

                // ì—­í• ë³„ ë¶„ë¥˜ (6ë²ˆ: ê°€ë§¹ì  / 5ë²ˆ: ê·¸ì™¸ í”„ë¦¬ëœì„œ)
                if (u.role === 'franchise') partnerHtml += rowPartner;
                else freeHtml += rowFree;
            });
            
            document.getElementById('accPartnerBody').innerHTML = partnerHtml || '<tr><td colspan="5" style="text-align:center;">ë‚´ì—­ ì—†ìŒ</td></tr>';
            document.getElementById('accFreelancerBody').innerHTML = freeHtml || '<tr><td colspan="5" style="text-align:center;">ë‚´ì—­ ì—†ìŒ</td></tr>';
            document.getElementById('accUnpaidTotal').innerText = unpaidTotal.toLocaleString() + "ì›";

        } catch (e) {
            console.error(e);
            alert("ì¡°íšŒ ì‹¤íŒ¨: " + e.message);
        } finally {
            showLoading(false);
        }
    };
    // ==========================================
    // [VIP] ê´€ë¦¬ì ê¸°ëŠ¥
    // ==========================================
    // ==========================================
    // [VIP] ê´€ë¦¬ì ê¸°ëŠ¥ (ì—…ë°ì´íŠ¸ë¨)
    // ==========================================
    window.loadVipOrders = async () => {
        const tbody = document.getElementById('vipOrderListBody');
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;"><div class="spinner"></div></td></tr>';

        try {
            // [ìµœì í™”] * ëŒ€ì‹  í•„ìš”í•œ ì»¬ëŸ¼ ëª…ì‹œ + ìµœì‹  50ê°œ ì œí•œ
// [ìˆ˜ì • ì™„ë£Œ] DBì— ì‹¤ì œë¡œ ìˆëŠ” ì»¬ëŸ¼ë§Œ ìš”ì²­í•˜ë„ë¡ ë³€ê²½
const { data, error } = await sb.from('vip_orders')
    .select('id, created_at, status, customer_name, customer_phone, memo, files, preferred_manager')
    .order('created_at', { ascending: false })
    .limit(50);
            if (error) throw error;

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:30px; color:#999;">ì ‘ìˆ˜ëœ VIP ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            data.forEach(item => {
                const statusBadge = item.status === 'í™•ì¸ë¨' 
                    ? `<span class="badge" style="background:#dcfce7; color:#15803d;">í™•ì¸ì™„ë£Œ</span>` 
                    : `<span class="badge" style="background:#fee2e2; color:#ef4444;">ëŒ€ê¸°ì¤‘</span>`;
                
                // íŒŒì¼ ëª©ë¡ ìƒì„±
                let filesHtml = '';
                if (item.files && Array.isArray(item.files)) {
                    item.files.forEach(f => {
                        filesHtml += `<a href="${f.url}" target="_blank" class="btn btn-outline btn-sm" style="display:inline-block; margin:2px; text-decoration:none; font-size:11px;">ğŸ’¾ ${f.name}</a><br>`;
                    });
                } else if (item.file_url) {
                    // êµ¬ë²„ì „ ë°ì´í„° í˜¸í™˜ (í…Œì´ë¸” ë¦¬ì…‹í–ˆìœ¼ë¯€ë¡œ í•„ìš”ì—†ì„ ìˆ˜ ìˆì§€ë§Œ ì•ˆì „ì¥ì¹˜)
                    filesHtml = `<a href="${item.file_url}" target="_blank" class="btn btn-outline btn-sm">ğŸ’¾ ${item.file_name || 'íŒŒì¼'}</a>`;
                } else {
                    filesHtml = '<span style="color:#ccc;">íŒŒì¼ ì—†ìŒ</span>';
                }

                // ë§¤ë‹ˆì € ë±ƒì§€ ìƒ‰ìƒ
                let mgrColor = '#64748b';
                const mgrName = item.preferred_manager || 'ë¯¸ì§€ì •';
                if(mgrName === 'ì€ë¯¸') mgrColor = '#db2777';
                if(mgrName === 'ì„±í¬') mgrColor = '#7c3aed';
                if(mgrName === 'ì§€ìˆ™') mgrColor = '#059669';

                tbody.innerHTML += `
                    <tr style="${item.status !== 'í™•ì¸ë¨' ? 'background:#fff7ed;' : ''}">
                        <td><input type="checkbox" class="vip-chk" value="${item.id}"></td>
                        <td>${new Date(item.created_at).toLocaleString()}</td>
                        <td><span class="badge" style="background:${mgrColor}10; color:${mgrColor}; border:1px solid ${mgrColor}30;">${mgrName}</span></td>
                        <td style="font-weight:bold;">${item.customer_name}</td>
                        <td>${item.customer_phone}</td>
                        <td style="font-size:13px; color:#475569;">${item.memo || '-'}</td>
                        <td>${filesHtml}</td>
                        <td style="text-align:center;">${statusBadge}</td>
                        <td style="text-align:center;">
                            <button class="btn btn-primary btn-sm" onclick="toggleVipStatus(${item.id}, '${item.status}')">
                                ${item.status === 'í™•ì¸ë¨' ? 'ì·¨ì†Œ' : 'í™•ì¸'}
                            </button>
                        </td>
                    </tr>
                `;
            });
        } catch (e) {
            console.error(e);
            tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">ì˜¤ë¥˜: ${e.message}</td></tr>`;
        }
    };

    window.toggleVipStatus = async (id, currentStatus) => {
        const newStatus = currentStatus === 'í™•ì¸ë¨' ? 'ëŒ€ê¸°ì¤‘' : 'í™•ì¸ë¨';
        try {
            const { error } = await sb.from('vip_orders').update({ status: newStatus }).eq('id', id);
            if (error) throw error;
            loadVipOrders();
        } catch(e) {
            alert("ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: " + e.message);
        }
    };

    // 2. [ì—‘ì…€ 1] ê¸°ê°„ ë‚´ ê²°ì œ ì´ì•¡ (ì£¼ë¬¸ì¼, ê³ ê°ëª…, ê²°ì œê¸ˆì•¡, ë°°ì†¡ë°©ë²•)
    window.downloadAccSales = () => {
        if (!cachedAccOrders.length) return alert("ì¡°íšŒëœ ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
        
        const data = cachedAccOrders.map(o => ({
            "ì£¼ë¬¸ì¼ì": new Date(o.created_at).toLocaleDateString(),
            "ì£¼ë¬¸ë²ˆí˜¸": o.id,
            "ê³ ê°ëª…": o.manager_name,
            "ê²°ì œê¸ˆì•¡": o.total_amount,
            "ë°°ì†¡ë°©ë²•": o.staff_driver_id ? "ê¸°ì‚¬ ë°°ì •" : (o.address.includes("ì§ì ‘") ? "ë°©ë¬¸ìˆ˜ë ¹" : "íƒë°°/í™”ë¬¼"),
            "ë°°ì†¡ì§€": o.address
        }));

        // í•©ê³„ í–‰ ì¶”ê°€
        const total = cachedAccOrders.reduce((sum, o) => sum + (o.total_amount||0), 0);
        data.push({ "ì£¼ë¬¸ì¼ì": "ì´ê³„", "ê²°ì œê¸ˆì•¡": total });

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "ê²°ì œì´ì•¡");
        XLSX.writeFile(wb, `ë§¤ì¶œìƒì„¸_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    // 3. [ì—‘ì…€ 2] ë¯¸ì§€ê¸‰ ì •ì‚°ëŒ€ê¸° (ê³„ì¢Œë²ˆí˜¸, ê¸ˆì•¡, ìš”ì²­ì)
    window.downloadAccUnpaid = () => {
        const unpaidList = cachedAccWithdrawals.filter(w => w.status === 'pending');
        if (!unpaidList.length) return alert("ë¯¸ì§€ê¸‰(ëŒ€ê¸°ì¤‘)ì¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");

        const data = unpaidList.map(w => ({
            "ìš”ì²­ì¼ì": new Date(w.created_at).toLocaleDateString(),
            "ìš”ì²­ì(ìƒí˜¸/ì´ë¦„)": w.userName || w.user_id,
            "êµ¬ë¶„": w.userRole === 'franchise' ? 'ê°€ë§¹ì ' : 'í”„ë¦¬ëœì„œ',
            "ì§€ê¸‰ìš”ì²­ê¸ˆì•¡": w.amount,
            "ì…ê¸ˆì€í–‰": w.bank_name || '-', 
            "ê³„ì¢Œë²ˆí˜¸": w.account_number || '-' // â€» DB ì»¬ëŸ¼ëª… í™•ì¸ í•„ìš”
        }));

        // í•©ê³„
        const total = unpaidList.reduce((sum, w) => sum + (w.amount||0), 0);
        data.push({ "ìš”ì²­ì¼ì": "ì´ ë¯¸ì§€ê¸‰ì•¡", "ì§€ê¸‰ìš”ì²­ê¸ˆì•¡": total });

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "ë¯¸ì§€ê¸‰ë‚´ì—­");
        XLSX.writeFile(wb, `ë¯¸ì§€ê¸‰ì •ì‚°_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    // 4. [ì—‘ì…€ 3] ê³ ê° ì˜ˆì¹˜ê¸ˆ (ê³ ê° ë¦¬ìŠ¤íŠ¸, ì”ì•¡)
    window.downloadAccDeposit = () => {
        const depositUsers = cachedAccProfiles.filter(p => p.deposit > 0);
        if (!depositUsers.length) return alert("ì˜ˆì¹˜ê¸ˆì„ ë³´ìœ í•œ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.");

        const data = depositUsers.map(p => ({
            "ê³ ê°ëª…": p.full_name,
            "ì´ë©”ì¼": p.email,
            "ë³´ìœ  ì˜ˆì¹˜ê¸ˆ": p.deposit,
            "íšŒì›ë“±ê¸‰": p.role
        }));

        const total = depositUsers.reduce((sum, p) => sum + (p.deposit||0), 0);
        data.push({ "ê³ ê°ëª…": "ì´ ì˜ˆì¹˜ê¸ˆ í•©ê³„", "ë³´ìœ  ì˜ˆì¹˜ê¸ˆ": total });

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "ì˜ˆì¹˜ê¸ˆí˜„í™©");
        XLSX.writeFile(wb, `ì˜ˆì¹˜ê¸ˆí˜„í™©_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    // 5. [ì—‘ì…€ 4] ê¸°ê°„ ë‚´ í• ì¸ ì´ì•¡ (ì£¼ë¬¸ëª…, ì£¼ë¬¸ì, ê¸ˆì•¡, í• ì¸ì•¡, í• ì¸ìœ¨)
    window.downloadAccDiscount = () => {
        const discountList = cachedAccOrders.filter(o => o.discount_amount > 0);
        if (!discountList.length) return alert("í• ì¸ì´ ì ìš©ëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");

        const data = discountList.map(o => {
            let itemName = "ìƒí’ˆ ì •ë³´ ì—†ìŒ";
            try { 
                const items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items; 
                if(items && items.length > 0) itemName = items[0].productName || items[0].name;
                if(items.length > 1) itemName += ` ì™¸ ${items.length-1}ê±´`;
            } catch(e){}

            return {
                "ì£¼ë¬¸ì¼ì": new Date(o.created_at).toLocaleDateString(),
                "ì£¼ë¬¸ë²ˆí˜¸": o.id,
                "ì£¼ë¬¸ëª…": itemName,
                "ì£¼ë¬¸ì": o.manager_name,
                "ì‹¤ê²°ì œê¸ˆì•¡": o.total_amount,
                "í• ì¸ê¸ˆì•¡": o.discount_amount,
                "í• ì¸ìœ¨": o.discount_rate + "%"
            };
        });

        const totalDisc = discountList.reduce((sum, o) => sum + o.discount_amount, 0);
        data.push({ "ì£¼ë¬¸ì¼ì": "ì´ í• ì¸ì•¡", "í• ì¸ê¸ˆì•¡": totalDisc });

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "í• ì¸ë‚´ì—­");
        XLSX.writeFile(wb, `í• ì¸ë‚´ì—­_${new Date().toISOString().slice(0,10)}.xlsx`);
    };
    // [VIP] ì „ì²´ ì„ íƒ í† ê¸€
    window.toggleVipChecks = (source) => {
        document.querySelectorAll('.vip-chk').forEach(chk => chk.checked = source.checked);
    };

    // [VIP] ì„ íƒ ì‚­ì œ
    window.deleteSelectedVipOrders = async () => {
        const checks = document.querySelectorAll('.vip-chk:checked');
        if (checks.length === 0) return alert("ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        if (!confirm(`ì„ íƒí•œ ${checks.length}ê±´ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        const ids = Array.from(checks).map(c => c.value);
        try {
            const { error } = await sb.from('vip_orders').delete().in('id', ids);
            if (error) throw error;
            alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadVipOrders();
        } catch (e) {
            alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
        }
    };

    // ==========================================
    // [ì‹ ê·œ] ë§ˆì¼ë¦¬ì§€ ì‹œìŠ¤í…œ (ì—‘ì…€ ì´ê´€ & ìˆ˜ë™ ê´€ë¦¬)
    // ==========================================

    // 1. ê³ ë„ëª° ì—‘ì…€ íŒŒì¼ ì½ì–´ì„œ ë§ˆì¼ë¦¬ì§€ ì—…ë°ì´íŠ¸ (ì´ë©”ì¼ ê¸°ì¤€ ë§¤ì¹­)
    window.importMileageExcel = async (input) => {
        if (!input.files || input.files.length === 0) return;
        const file = input.files[0];

        if (!confirm(`'${file.name}' íŒŒì¼ì—ì„œ ì´ë©”ì¼ê³¼ ë§ˆì¼ë¦¬ì§€ë¥¼ ì½ì–´ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n[ì£¼ì˜] ì—‘ì…€ì— 'ì´ë©”ì¼', 'ë§ˆì¼ë¦¬ì§€' ì»¬ëŸ¼ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.`)) {
            input.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (jsonData.length === 0) throw new Error("ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

                showLoading(true);
                let successCount = 0;
                let failCount = 0;

                // ë³‘ë ¬ ì²˜ë¦¬ ëŒ€ì‹  ìˆœì°¨ ì²˜ë¦¬ë¡œ ì•ˆì •ì„± í™•ë³´ (ë˜ëŠ” Promise.all ì‚¬ìš©)
                for (const row of jsonData) {
                    // ì»¬ëŸ¼ëª… ìœ ì—°ì„± í™•ë³´ (ì´ë©”ì¼/email, ë§ˆì¼ë¦¬ì§€/mileage/ì ë¦½ê¸ˆ)
                    const email = row['ì´ë©”ì¼'] || row['email'] || row['Email'];
                    const mileageVal = row['ë§ˆì¼ë¦¬ì§€'] || row['mileage'] || row['ì ë¦½ê¸ˆ'];

                    if (email && mileageVal !== undefined) {
                        const amount = parseInt(mileageVal);
                        if (!isNaN(amount)) {
                            // ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸
                            // profiles í…Œì´ë¸”ì— mileage ì»¬ëŸ¼ì´ ìˆì–´ì•¼ í•¨
                            const { error } = await sb.from('profiles')
                                .update({ mileage: amount })
                                .eq('email', email);
                            
                            if (!error) successCount++;
                            else failCount++;
                        }
                    }
                }

                alert(`âœ… ì²˜ë¦¬ ì™„ë£Œ!\nì„±ê³µ: ${successCount}ëª…\nì‹¤íŒ¨(ë¯¸ê°€ì…/ì˜¤ë¥˜): ${failCount}ëª…`);
                loadMembers();

            } catch (err) {
                alert("ì—‘ì…€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: " + err.message);
                console.error(err);
            } finally {
                showLoading(false);
                input.value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    };

    // 2. ë§ˆì¼ë¦¬ì§€ ìˆ˜ë™ ìˆ˜ì • (ê´€ë¦¬ììš©)
    window.editMileageManual = async (userId, email, currentMileage) => {
        const newAmountStr = prompt(`[${email}]ë‹˜ì˜ í˜„ì¬ ë§ˆì¼ë¦¬ì§€: ${currentMileage}P\n\në³€ê²½í•  ìµœì¢… ë§ˆì¼ë¦¬ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`, currentMileage);
        if (newAmountStr === null) return;
        
        const newAmount = parseInt(newAmountStr);
        if (isNaN(newAmount)) return alert("ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        const { error } = await sb.from('profiles').update({ mileage: newAmount }).eq('id', userId);
        if (error) alert("ìˆ˜ì • ì‹¤íŒ¨: " + error.message);
        else {
            alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadMembers();
        }
    };
    // [ìˆ˜ë™ ë§¤ì¹­ í•¨ìˆ˜] ì…ê¸ˆë‚´ì—­ ë¦¬ìŠ¤íŠ¸ì—ì„œ 'ìˆ˜ë™ ì—°ê²°' ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
window.matchOrderManual = async (txId, depositorName) => {
    // 1. ì—°ê²°í•  ì£¼ë¬¸ ID ì…ë ¥ ë°›ê¸°
    const orderId = prompt(`[${depositorName}]ë‹˜ì˜ ì…ê¸ˆ ë‚´ì—­ì…ë‹ˆë‹¤.\nì—°ê²°í•  'ì£¼ë¬¸ë²ˆí˜¸(ìˆ«ì)'ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
    if (!orderId) return;

    try {
        // 2. ì£¼ë¬¸ ì •ë³´ í™•ì¸
        const { data: order, error: findErr } = await sb.from('orders').select('*').eq('id', orderId).single();
        
        if (findErr || !order) {
            alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì£¼ë¬¸ë²ˆí˜¸ì…ë‹ˆë‹¤.");
            return;
        }

        if (confirm(`ì£¼ë¬¸ì: ${order.manager_name}\nê¸ˆì•¡: ${order.total_amount.toLocaleString()}ì›\n\nì´ ì£¼ë¬¸ê³¼ ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            // 3. ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê²°ì œì™„ë£Œ)
            await sb.from('orders').update({
                payment_status: 'ê²°ì œì™„ë£Œ',
                payment_method: 'ë¬´í†µì¥ì…ê¸ˆ(ìˆ˜ë™)',
                status: 'ì œì‘ì¤€ë¹„'
            }).eq('id', orderId);

            // 4. ì…ê¸ˆ ë‚´ì—­ ì—…ë°ì´íŠ¸ (ë§¤ì¹­ë¨)
            await sb.from('bank_transactions').update({
                match_status: 'matched',
                matched_order_id: orderId
            }).eq('id', txId);

            alert("âœ… ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
            
            // í™”ë©´ ìƒˆë¡œê³ ì¹¨
            loadBankdaList(); 
            loadOrders(); 
        }
    } catch (e) {
        alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
    }
};
// [ì‹ ê·œ ê¸°ëŠ¥] ì¹´í…Œê³ ë¦¬ë³„ ì˜µì…˜ ì¼ê´„ ì ìš© í•¨ìˆ˜
window.bulkApplyAddonsToCategory = async () => {
    // 1. í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ í™•ì¸
    const targetCat = document.getElementById('newProdCategory').value;
    if (!targetCat) {
        return alert("ì¼ê´„ ì ìš©í•  'ì¹´í…Œê³ ë¦¬'ë¥¼ ìƒí’ˆ ë“±ë¡ í¼ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.");
    }

    // 2. í˜„ì¬ ì²´í¬ëœ ì˜µì…˜ê°’ë“¤ ê°€ì ¸ì˜¤ê¸°
    const checkedBoxes = document.querySelectorAll('input[name="prodAddon"]:checked');
    const addonCodes = Array.from(checkedBoxes).map(cb => cb.value).join(',');

    // 3. ì‚¬ìš©ì í™•ì¸ (ì•ˆì „ì¥ì¹˜)
    let msg = `[ì¹´í…Œê³ ë¦¬: ${targetCat}]\n\n`;
    if (addonCodes) {
        msg += `ì„ íƒëœ ì˜µì…˜(${checkedBoxes.length}ê°œ)ì„ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  ìƒí’ˆì— ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
    } else {
        msg += `âš ï¸ ì„ íƒëœ ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.\nì •ë§ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  ìƒí’ˆì—ì„œ ì˜µì…˜ì„ 'ì´ˆê¸°í™”(ì œê±°)' í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
    }

    if (!confirm(msg)) return;

    showLoading(true);

    try {
        // 4. DB ì¼ê´„ ì—…ë°ì´íŠ¸
        const { error } = await sb.from('admin_products')
            .update({ addons: addonCodes })
            .eq('category', targetCat);

        if (error) throw error;

        alert("âœ… ì¼ê´„ ì ìš© ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        
        // í˜„ì¬ ë³´ê³  ìˆëŠ” ë¦¬ìŠ¤íŠ¸ê°€ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ë¼ë©´ ìƒˆë¡œê³ ì¹¨
        if (document.getElementById('filterProdCat').value === targetCat) {
            filterProductList();
        }

    } catch (e) {
        console.error(e);
        alert("ì¼ê´„ ì ìš© ì‹¤íŒ¨: " + e.message);
    } finally {
        showLoading(false);
    }
};
    </script>
    
</body>
</html>