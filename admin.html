<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chameleon Global Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Pretendard', sans-serif; background: #f1f5f9; color: #334155; overflow: hidden; }
        
        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 260px; background: #1e293b; color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; }
        .sidebar-header { padding: 25px 20px; font-weight: 800; font-size: 20px; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 10px; color: #818cf8; }
        .nav-menu { list-style: none; padding: 20px 10px; margin: 0; display: flex; flex-direction: column; gap: 5px; }
        .nav-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 15px; color: #cbd5e1; }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: #6366f1; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .nav-label { font-size: 11px; color: #64748b; padding: 0 15px; margin-top: 15px; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; }
        
        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 60px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .page-title { font-size: 18px; font-weight: 700; color: #0f172a; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 30px; }
        
        /* ì„¹ì…˜ ë° ì¹´ë“œ ë ˆì´ì•„ì›ƒ */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .product-layout { display: grid; grid-template-columns: 380px 1fr; gap: 20px; align-items: start; }
        
        /* í¼ ìš”ì†Œ */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 5px; }
        .input-text { padding: 10px 15px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; font-size: 14px; box-sizing: border-box; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        
        /* í…Œì´ë¸” */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-weight: 600; font-size: 13px; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #334155; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }
        
        /* ë²„íŠ¼ */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-vip { background: #d97706; color: white; } 
        .btn-danger { background: #fee2e2; color: #ef4444; }
        .btn-success { background: #22c55e; color: white; } 
        .btn-outline { background: #fff; border: 1px solid #cbd5e1; color: #334155; }
        .btn-sm { padding: 4px 8px; font-size: 11px; }
        .btn-file { background: #fff; color: #334155; border: 1px solid #cbd5e1; padding: 6px 10px; font-size: 12px; border-radius: 4px; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; cursor: pointer; margin-right: 5px; margin-bottom: 3px; max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .btn-file:hover { border-color: #6366f1; color: #6366f1; }
        
        /* ë±ƒì§€ */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .badge.draggable { cursor: grab; }
        .badge-site { font-size: 11px; padding: 3px 6px; border-radius: 4px; margin-right: 4px; font-weight: 800; border: 1px solid #e2e8f0; background: #fff; display: inline-block; min-width: 30px; text-align: center; }
        .badge-site.kr { color: #cf2e2e; border-color: #fecaca; background: #fef2f2; }
        .badge-site.jp { color: #ea580c; border-color: #ffedd5; background: #fff7ed; }
        .badge-site.us { color: #2563eb; border-color: #dbeafe; background: #eff6ff; }

        /* íŒŒì¼ ì—…ë¡œë“œ & í…œí”Œë¦¿ ì¹´ë“œ */
        .file-drop-zone { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; position: relative; background: #f8fafc; color: #64748b; margin-bottom: 10px; }
        .file-drop-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .preview-img { max-width: 100%; height: 150px; object-fit: contain; border-radius: 8px; border: 1px solid #eee; display: none; margin-top: 10px; background: white; }
        .tpl-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .tpl-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; transition: 0.2s; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tpl-thumb { width: 100%; height: 150px; object-fit: contain; background: #f8fafc; border-bottom: 1px solid #f1f5f9; padding: 10px; }
        .tpl-info { padding: 12px; }
        .tpl-del-btn { width: 100%; margin-top: 8px; background: #fee2e2; color: #ef4444; font-size: 12px; padding: 6px; border-radius: 6px; border:none; cursor:pointer; font-weight: 600; }
        
        /* ì˜µì…˜ */
        .addon-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; max-height: 150px; overflow-y: auto; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; }
        .addon-check-item { display: flex; align-items: center; gap: 5px; font-size: 13px; background: white; padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }

        /* ê²°ì œ ë±ƒì§€ */
        .pay-badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-bottom: 4px; }
        .pay-done { background: #fee2e2; color: #ef4444; border: 1px solid #fca5a5; }
        .pay-wait { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.7); z-index: 99999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #6366f1; border-radius: 50%; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .color-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; vertical-align: middle; border: 1px solid rgba(0,0,0,0.1); }
        .staff-select { padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px; width: 100%; margin-bottom: 4px; background: white; cursor: pointer; }

        /* í†µê³„ */
        .stat-card-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 20px; }
        .stat-icon { width: 60px; height: 60px; border-radius: 12px; background: #eff6ff; color: #2563eb; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .stat-info div:first-child { font-size: 14px; color: #64748b; font-weight: 600; margin-bottom: 5px; }
        .stat-info div:last-child { font-size: 24px; font-weight: 800; color: #0f172a; }
        .progress-bar-bg { width: 100%; height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-bar-fill { height: 100%; border-radius: 4px; transition: 0.5s; }
    </style>
</head>
<body>
    <div id="loading"><div class="spinner"></div></div>
    <input type="file" id="replaceFileInput" style="display:none;" onchange="handleFileReplace(this)">
    <input type="file" id="manualOrderSheetInput" style="display:none;" accept="application/pdf" onchange="uploadManualOrderSheet(this)">

    <div class="sidebar">
        <div class="sidebar-header"><i class="fa-solid fa-earth-americas"></i> Global Admin</div>
        <ul class="nav-menu">
            <div class="nav-label">Business</div>
            <li class="nav-item active" onclick="showSection('sec-orders', this)"><i class="fa-solid fa-cart-shopping"></i> í†µí•© ì£¼ë¬¸ ê´€ë¦¬</li>
            <li class="nav-item" onclick="showSection('sec-stats', this)"><i class="fa-solid fa-chart-line"></i> ë§¤ì¶œ & í†µê³„</li>
            <li class="nav-item" onclick="showSection('sec-tasks', this)"><i class="fa-solid fa-calendar-check"></i> ì˜¤ëŠ˜ í• ì¼ (ë°°ì†¡ê´€ë¦¬)</li>
            <div class="nav-label">Product & Stock</div>
            <li class="nav-item" onclick="showSection('sec-products', this)"><i class="fa-solid fa-tags"></i> ìƒí’ˆ & ì˜µì…˜</li>
            
            <div class="nav-label">Management</div>
            <li class="nav-item" onclick="showSection('sec-staff', this)"><i class="fa-solid fa-id-card"></i> ìŠ¤íƒœí”„ ê´€ë¦¬</li>
            <li class="nav-item" onclick="showSection('sec-members', this)"><i class="fa-solid fa-users"></i> íšŒì› ê´€ë¦¬</li>

            <div class="nav-label">Assets</div>
            <li class="nav-item" onclick="showSection('sec-templates', this)"><i class="fa-solid fa-palette"></i> í…œí”Œë¦¿ & ë¡œê³ </li>
            <li class="nav-item" onclick="showSection('sec-fonts', this)"><i class="fa-solid fa-font"></i> í°íŠ¸(ì„œì²´) ê´€ë¦¬</li>
        </ul>
        <div style="margin-top: auto; padding: 20px;">
            <button class="btn btn-danger" style="width: 100%;" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="page-title">í†µí•© ì£¼ë¬¸ ê´€ë¦¬</div>
            <div style="font-size: 14px; color: #64748b;">Global Admin Connected ğŸŸ¢</div>
        </div>

        <div class="content-scroll">
            
            <div id="sec-orders" class="section active">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px;">
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-primary" id="btnFilterNew" onclick="filterOrders('ì ‘ìˆ˜ë¨', this)">ğŸ“Œ ì‹ ê·œ ì ‘ìˆ˜</button>
                            <button class="btn btn-outline" id="btnFilterKnife" onclick="filterOrders('ì¹¼ì„ ì‘ì—…', this)">âœ‚ï¸ ì¹¼ì„ /ì œì‘ì‘ì—…</button>
                            <button class="btn btn-outline" id="btnFilterDone" onclick="filterOrders('ì™„ë£Œë¨', this)">âœ… ì™„ë£Œ</button>
                        </div>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <div id="action-buttons" style="display:flex; gap:5px; margin-right: 15px; border-right: 1px solid #ddd; padding-right: 15px;"></div>
                            <select id="filterSite" class="input-text" style="width:130px; font-weight:bold;" onchange="loadOrders()">
                                <option value="all">ğŸŒ ì „ì²´ êµ­ê°€</option>
                                <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
                                <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option>
                                <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
                            </select>
                            <button class="btn btn-outline" onclick="loadOrders()"><i class="fa-solid fa-rotate"></i></button>
                        </div>
                    </div>
                    <table style="margin:0;">
                        <thead>
                            <tr>
                                <th style="width:40px;"><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></th>
                                <th style="width:50px;">Site</th>
                                <th style="width:90px;">ë‚ ì§œ</th>
                                <th style="width:110px;">ê³ ê°/ì—°ë½ì²˜</th>
                                <th style="width:220px;">ì£¼ë¬¸ ë‚´ì—­ (ìƒí’ˆ/ì˜µì…˜/ìˆ˜ëŸ‰)</th>
                                <th style="width:90px; text-align:right;">ê¸ˆì•¡</th>
                                <th style="width:180px; min-width: 160px; background:#f0f9ff;">ğŸ“… ë°°ì†¡ì¼ / ë‹´ë‹¹ì</th>
                                <th style="">ì£¼ë¬¸ íŒŒì¼</th>
                                <th style="width:100px;">ê²°ì œ ì •ë³´</th>
                            </tr>
                        </thead>
                        <tbody id="orderListBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="sec-stats" class="section">
                <div class="card" style="margin-bottom:20px;">
                    <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:15px; display:flex; align-items:center; gap:10px;">
                        <i class="fa-solid fa-calendar-days" style="color:#6366f1;"></i> ê¸°ê°„ë³„ ë§¤ì¶œ ì¡°íšŒ
                    </h3>
                    <div style="display:flex; gap:10px; align-items:flex-end; background:#f8fafc; padding:20px; border-radius:8px;">
                        <div><label class="form-label">ì‹œì‘ì¼</label><input type="date" id="statStartDate" class="input-text"></div>
                        <div><label class="form-label">ì¢…ë£Œì¼</label><input type="date" id="statEndDate" class="input-text"></div>
                        <button class="btn btn-primary" style="height:42px;" onclick="loadStatsData()"><i class="fa-solid fa-magnifying-glass"></i> ì¡°íšŒí•˜ê¸°</button>
                    </div>
                </div>
                <div class="stat-card-group">
                    <div class="stat-card"><div class="stat-icon"><i class="fa-solid fa-won-sign"></i></div><div class="stat-info"><div>ê¸°ê°„ ë‚´ ì´ ë§¤ì¶œ (ê³„ì‚°ë¨)</div><div id="totalRevenue">0</div></div></div>
                    <div class="stat-card"><div class="stat-icon" style="background:#ecfdf5; color:#059669;"><i class="fa-solid fa-receipt"></i></div><div class="stat-info"><div>ì´ ì£¼ë¬¸ ê±´ìˆ˜</div><div id="totalCount">0ê±´</div></div></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div class="card"><h4 style="margin-top:0;">ğŸ‘¨â€ğŸ’¼ ë‹´ë‹¹ ë§¤ë‹ˆì €ë³„ ì‹¤ì </h4><table style="margin-top:0;"><thead><tr><th>ë§¤ë‹ˆì €</th><th style="text-align:right;">ë§¤ì¶œ ê¸°ì—¬ë„</th></tr></thead><tbody id="statManagerBody"></tbody></table></div>
                    <div class="card"><h4 style="margin-top:0;">ğŸšš ë°°ì†¡ ê¸°ì‚¬ë³„ ì‹¤ì </h4><table style="margin-top:0;"><thead><tr><th>ê¸°ì‚¬ë‹˜</th><th style="text-align:right;">ë§¤ì¶œ ê¸°ì—¬ë„</th></tr></thead><tbody id="statDriverBody"></tbody></table></div>
                </div>
            </div>

            <div id="sec-tasks" class="section">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
                        <h3 style="margin:0; display:flex; align-items:center; gap:10px;">
                            <i class="fa-solid fa-truck-fast" style="color:#6366f1;"></i> ë‚ ì§œë³„ ë°°ì†¡ ìŠ¤ì¼€ì¤„
                        </h3>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <select id="filterTaskDriver" class="input-text" style="width:200px; font-weight:bold;" onchange="loadDailyTasks()">
                                <option value="all">ğŸš› ì „ì²´ ê¸°ì‚¬ ë³´ê¸°</option>
                            </select>
                            
                            <input type="date" id="taskDate" class="input-text" style="width:140px;" onchange="loadDailyTasks()">
                            <button class="btn btn-primary" onclick="loadDailyTasks()">ì¡°íšŒ</button>
                        </div>
                    </div>

                    <table style="margin-top:0;">
                        <thead>
                            <tr>
                                <th style="width:90px; white-space:nowrap;">ìƒíƒœ</th>
                                <th style="width:180px;">ê³ ê° ì •ë³´ (ì´ë¦„/ì—°ë½ì²˜)</th>
                                <th>ì£¼ë¬¸ íŒŒì¼</th>
                                <th style="width:180px;">ğŸšš ë°°ì†¡ ê¸°ì‚¬ ë°°ì •</th>
                                <th style="width:160px;">â° ì‹œê°„ / ì™„ë£Œì²´í¬</th>
                            </tr>
                        </thead>
                        <tbody id="taskListBody">
                        </tbody>
                    </table>
                    <div style="margin-top:15px; background:#f0f9ff; padding:15px; border-radius:8px; font-size:13px; color:#334155;">
                        ğŸ’¡ <b>ì‚¬ìš© íŒ:</b> 'í†µí•© ì£¼ë¬¸ ê´€ë¦¬' ë¦¬ìŠ¤íŠ¸ì—ì„œë„ ë‚ ì§œë¥¼ ì§€ì •í•  ìˆ˜ ìˆë„ë¡ í•˜ë©´ í¸í•©ë‹ˆë‹¤. 
                        í˜„ì¬ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— <code>delivery_target_date</code>(ë°°ì†¡ì¼)ê°€ ì„¤ì •ëœ ì£¼ë¬¸ë§Œ ì´ê³³ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
                    </div>
                </div>
            </div>

            <div id="sec-products" class="section">
                 <div class="card" style="background:#f0f9ff; border:1px solid #bae6fd; margin-bottom:20px;">
                    <h3 style="margin-top:0; color:#0369a1;">0ï¸âƒ£ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ (í†µí•©)</h3>
                    <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                        <div style="flex:1; min-width:120px;"><label class="form-label">í´ë” ì½”ë“œ (ì˜ë¬¸)</label><input id="newCatCode" class="input-text" placeholder="ì˜ˆ: honeycomb"></div>
                        <div style="flex:1; min-width:120px;"><label class="form-label">ğŸ‡°ğŸ‡· í•œêµ­ëª…</label><input id="newCatName" class="input-text" placeholder="ì˜ˆ: í—ˆë‹ˆì½¤"></div>
                        <div style="flex:1; min-width:120px;"><label class="form-label">ğŸ‡¯ğŸ‡µ ì¼ë³¸ëª…</label><input id="newCatNameJP" class="input-text" placeholder="ì˜ˆ: ãƒãƒ‹ã‚«ãƒ "></div>
                        <div style="flex:1; min-width:120px;"><label class="form-label">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ëª…</label><input id="newCatNameUS" class="input-text" placeholder="ì˜ˆ: Honeycomb"></div>
                        <button class="btn btn-primary" onclick="addCategoryDB()">ìƒì„±/ìˆ˜ì •</button>
                    </div>
                    <div id="categoryListArea" style="margin-top:15px; border-top:1px solid #bae6fd; padding-top:10px;"></div>
                </div>

                <div class="product-layout">
                    <div class="card product-form">
                        <h3 style="margin-top:0;">2ï¸âƒ£ ìƒí’ˆ ë“±ë¡ (Product)</h3>
                        <div class="form-group" style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                            <label class="form-label">ğŸŒ íŒë§¤ êµ­ê°€ (Site Code)</label>
                            <select id="newProdSite" class="input-text" style="font-weight:bold; color:#6366f1;">
                                <option value="KR" selected>ğŸ‡°ğŸ‡· í•œêµ­ (Korea)</option>
                                <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸ (Japan)</option>
                                <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ (USA)</option>
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label><select id="newProdCategory" class="input-text"><option value="">ë¡œë”© ì¤‘...</option></select></div>
                        <div class="form-group"><label class="form-label">ìƒí’ˆì½”ë“œ (ê³ ìœ ê°’)</label><input id="newProdCode" class="input-text" placeholder="Wall_1_KR"></div>
                        <div class="form-group"><label class="form-label">ìƒí’ˆëª… (í•´ë‹¹ ì–¸ì–´)</label><input id="newProdName" class="input-text" placeholder="ê°€ë²½ 1ì¹¸"></div>
                        <div class="input-row"><div style="flex:1;"><label class="form-label">ê°€ë¡œ(mm)</label><input id="newProdW" type="number" class="input-text"></div><div style="flex:1;"><label class="form-label">ì„¸ë¡œ(mm)</label><input id="newProdH" type="number" class="input-text"></div></div>
                        <div class="form-group"><label class="form-label">ê°€ê²© (ìˆ«ì)</label><input id="newProdPrice" type="number" class="input-text" placeholder="ì˜ˆ: 150000"></div>
                        <div class="form-group"><label class="form-label">ì´ë¯¸ì§€</label><div class="file-drop-zone"><input type="file" id="newProdFile" accept="image/*" onchange="previewProductImage(this)"><span>ì—…ë¡œë“œ</span></div><input id="newProdImg" class="input-text" style="margin-top:5px;" placeholder="URL"><img id="prodPreview" class="preview-img"></div>
                        <div class="form-group"><label class="form-label">ì˜µì…˜ ì—°ê²°</label><div id="addonCheckboxArea" class="addon-checkbox-group"></div></div>
                        <button id="btnProductSave" class="btn btn-primary" style="width:100%;" onclick="addProductDB()">ìƒí’ˆ ë“±ë¡í•˜ê¸°</button>
                        <div style="margin-top:10px; display:flex; gap:5px;"><button id="btnProductClone" class="btn btn-vip" style="flex:1; display:none;" onclick="cloneProduct()">ë³µì œ</button><button id="btnCancelEdit" class="btn btn-outline" style="flex:1; display:none;" onclick="resetProductForm()">ì·¨ì†Œ</button></div>
                    </div>

                    <div class="product-grid-area">
                        <div class="card" style="margin-bottom:20px;">
                            <h3>1ï¸âƒ£ ì˜µì…˜ í†µí•© ê´€ë¦¬ (3ê°œêµ­ ë™ì‹œ)</h3>
                            <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                                <div style="width:100px;"><label class="form-label">êµ¬ë¶„</label><select id="newAddonCat" class="input-text"><option value="addon">ì¶”ê°€</option><option value="material">ì¬ì§ˆ</option><option value="finish">ë§ˆê°</option></select></div>
                                <div style="flex:1; min-width:100px;"><label class="form-label">ì½”ë“œ (ì˜ë¬¸)</label><input id="newAddonCode" class="input-text"></div>
                                <div style="flex:1; min-width:100px;"><label class="form-label">ğŸ‡°ğŸ‡· ëª…ì¹­/ê°€ê²©</label><input id="nmKR" class="input-text" placeholder="ì´ë¦„"><input id="prKR" type="number" class="input-text" placeholder="ì›" style="margin-top:2px;"></div>
                                <div style="flex:1; min-width:100px;"><label class="form-label">ğŸ‡¯ğŸ‡µ ëª…ì¹­/ê°€ê²©</label><input id="nmJP" class="input-text" placeholder="åå‰"><input id="prJP" type="number" class="input-text" placeholder="å††" style="margin-top:2px;"></div>
                                <div style="flex:1; min-width:100px;"><label class="form-label">ğŸ‡ºğŸ‡¸ ëª…ì¹­/ê°€ê²©</label><input id="nmUS" class="input-text" placeholder="Name"><input id="prUS" type="number" class="input-text" placeholder="$" style="margin-top:2px;"></div>
                                <button class="btn btn-primary" onclick="addAddonDB()">ì €ì¥</button>
                            </div>
                            <div style="margin-top:10px;">
                                <select onchange="loadSystemDB(this.value)" id="newAddonSite" class="input-text" style="width:150px; font-size:12px; margin-bottom:5px;"><option value="KR">ğŸ‡°ğŸ‡· í•œêµ­ ì˜µì…˜</option><option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸ ì˜µì…˜</option><option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ì˜µì…˜</option></select>
                            </div>
                            <div style="max-height:200px; overflow-y:auto; border-top:1px solid #eee;">
                                <table style="font-size:12px;"><tbody id="addonTableBody"></tbody></table>
                            </div>
                        </div>
                        <div class="card">
                            <h3>ğŸ“œ ìƒí’ˆ ëª©ë¡</h3>
                            <div style="margin-bottom:10px;">í•„í„°: <select onchange="filterProductList(this.value)" class="input-text" style="width:150px; display:inline-block;"><option value="all">ì „ì²´ ë³´ê¸°</option><option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option><option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option><option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option></select></div>
                            <table><thead><tr><th width="50">êµ­ê°€</th><th width="60">ì´ë¯¸ì§€</th><th>ì½”ë“œ/ìƒí’ˆëª…</th><th>ì‚¬ì´ì¦ˆ</th><th>ê°€ê²©</th><th width="80">ê´€ë¦¬</th></tr></thead><tbody id="prodTableBody"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-staff" class="section">
                <div class="product-layout">
                    <div class="card tpl-form">
                        <h3 style="margin-top:0;">ğŸ‘¤ ìŠ¤íƒœí”„ ë“±ë¡</h3>
                        <div class="form-group"><label class="form-label">ì´ë¦„</label><input id="staffName" class="input-text" placeholder="ì˜ˆ: í™ê¸¸ë™"></div>
                        <div class="form-group"><label class="form-label">ì—­í• </label><select id="staffRole" class="input-text"><option value="manager">ë‹´ë‹¹ ë§¤ë‹ˆì €</option><option value="driver">ë°°ì†¡ ê¸°ì‚¬</option></select></div>
                        <div class="form-group"><label class="form-label">ìƒ‰ìƒ</label><input id="staffColor" type="color" class="input-text" style="height:40px; padding:2px;" value="#6366f1"></div>
                        <button class="btn btn-primary" style="width:100%;" onclick="addStaffDB()">ë“±ë¡í•˜ê¸°</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-top:0;">ğŸ“‹ ìŠ¤íƒœí”„ ëª©ë¡</h3>
                        <button class="btn btn-outline btn-sm" onclick="loadStaffList()" style="margin-bottom:10px;">ìƒˆë¡œê³ ì¹¨</button>
                        <table><thead><tr><th width="50">ìƒ‰ìƒ</th><th>ì´ë¦„</th><th>ì—­í• </th><th>ê´€ë¦¬</th></tr></thead><tbody id="staffListBody"></tbody></table>
                    </div>
                </div>
            </div>

            <div id="sec-members" class="section">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><h3>ğŸ‘¥ íšŒì› ëª©ë¡</h3><button class="btn btn-primary" onclick="loadMembers()">ìƒˆë¡œê³ ì¹¨</button></div>
                    <table><thead><tr><th>ê°€ì…ì¼</th><th>ì´ë©”ì¼</th><th>í˜„ì¬ ë“±ê¸‰</th><th>ë“±ê¸‰ ë³€ê²½</th></tr></thead><tbody id="memberListBody"></tbody></table>
                </div>
            </div>

            <div id="sec-templates" class="section">
                 <div class="product-layout">
                    <div class="card tpl-form">
                        <h3 style="margin-top:0;">ğŸ“¤ í…œí”Œë¦¿ ë“±ë¡</h3>
                        
                        <div class="form-group">
                            <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                            <select id="tplCategory" class="input-text" onchange="toggleFileInputs()">
                                <option value="logo">ğŸ¨ ë¡œê³  (Logo)</option>
                                <option value="transparent-graphic">ğŸ íŒ¨í„´ (Pattern)</option>
                                <option value="vector">ğŸ–¼ ë²¡í„° ë°°ê²½ (Vector)</option>
                                <option value="photo-bg">ğŸ“· ì‚¬ì§„ ë°°ê²½ (Photo)</option>
                                <option value="graphic">ğŸ§¸ ê·¸ë˜í”½/ìŠ¤í‹°ì»¤ (Graphic)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ê²€ìƒ‰ì–´ (íƒœê·¸)</label>
                            <input id="tplTags" class="input-text" placeholder="ì˜ˆ: ì‚¼ì„±, ë¡œê³ , ì—¬ë¦„">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ì—°ê²° ì œí’ˆ (Product Key)</label>
                            <select id="tplProductKey" class="input-text">
                                <option value="custom">ê³µí†µ / ì§€ì •ì•ˆí•¨</option>
                                </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" id="lblThumb">1. ì¸ë„¤ì¼ (í•„ìˆ˜)</label>
                            <div class="file-drop-zone">
                                <input type="file" id="fileThumb" accept="image/*">
                                <span>ì´ë¯¸ì§€ ì„ íƒ</span>
                            </div>
                            <img id="previewThumb" class="preview-img">
                        </div>

                        <div class="form-group" id="groupDataFile">
                            <label class="form-label">2. ë²¡í„° ë°ì´í„° (ì„ íƒ)</label>
                            <div class="file-drop-zone">
                                <input type="file" id="fileData" accept=".svg,.json">
                                <span>SVG íŒŒì¼ ì„ íƒ</span>
                            </div>
                            <div id="dataStatus" style="font-size:12px; color:#16a34a; display:none;">âœ… ì›ë³¸ ì¤€ë¹„ë¨!</div>
                        </div>

                        <button class="btn btn-primary" style="width:100%;" onclick="uploadTemplate()">ë“±ë¡í•˜ê¸°</button>
                    </div>

                    <div class="card">
                        <div style="margin-bottom:15px;">
                            <div style="display:flex; gap:10px; margin-bottom: 10px;">
                                <select id="filterTplCat" class="input-text" style="flex:1;" onchange="loadTemplates()">
                                    <option value="all">ğŸ“‚ ì¹´í…Œê³ ë¦¬: ì „ì²´</option>
                                    <option value="logo">ğŸ¨ ë¡œê³ </option>
                                    <option value="transparent-graphic">ğŸ íŒ¨í„´</option>
                                    <option value="vector">ğŸ–¼ ë²¡í„° ë°°ê²½</option>
                                    <option value="photo-bg">ğŸ“· ì‚¬ì§„ ë°°ê²½</option>
                                    <option value="graphic">ğŸ§¸ ê·¸ë˜í”½</option>
                                </select>
                                
                                <select id="filterTplProduct" class="input-text" style="flex:1;" onchange="loadTemplates()">
                                    <option value="all">ğŸ“¦ ì œí’ˆì—°ê²°: ì „ì²´ ë³´ê¸°</option>
                                    <option value="custom">ğŸ”¹ ê³µí†µ í…œí”Œë¦¿ë§Œ ë³´ê¸°</option>
                                    <option value="assigned">ğŸ”¸ ì œí’ˆ ì „ìš©ë§Œ ë³´ê¸°</option>
                                    <optgroup label="--- ê°œë³„ ì œí’ˆ ì„ íƒ ---"></optgroup>
                                </select>
                            </div>
                            <button class="btn btn-primary" style="width:100%;" onclick="loadTemplates()">ìƒˆë¡œê³ ì¹¨ / ê²€ìƒ‰ ì ìš©</button>
                        </div>
                        <div id="tplGrid" class="tpl-card-grid"></div>
                    </div>
                </div>
            </div>

            <div id="sec-fonts" class="section">
                <div class="product-layout">
                    <div class="card tpl-form">
                        <h3 style="margin-top:0;">ğŸ”¤ í°íŠ¸ ë“±ë¡</h3>
                        <div class="form-group"><label class="form-label">êµ­ê°€</label><select id="fontSite" class="input-text"><option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option><option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option><option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option></select></div>
                        <div class="form-group"><label class="form-label">í°íŠ¸ëª…</label><input id="fontName" class="input-text" placeholder="ì˜ˆ: Noto Sans JP"></div>
                        <div class="form-group"><label class="form-label">CSS Family</label><input id="fontFamily" class="input-text" placeholder="ì˜ˆ: NotoSansJP"></div>
                        <div class="form-group"><label class="form-label">íŒŒì¼ (.woff2)</label><div class="file-drop-zone"><input type="file" id="fontFile" accept=".woff2,.ttf"><span>íŒŒì¼ ì„ íƒ</span></div></div>
                        <button class="btn btn-primary" style="width:100%;" onclick="uploadFont()">ë“±ë¡í•˜ê¸°</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-top:0;">í°íŠ¸ ëª©ë¡</h3>
                        <button class="btn btn-outline btn-sm" onclick="loadFonts()" style="margin-bottom:10px;">ìƒˆë¡œê³ ì¹¨</button>
                        <table><thead><tr><th width="60">êµ­ê°€</th><th>í‘œì‹œëª…</th><th>ë¯¸ë¦¬ë³´ê¸°</th><th>ì‚­ì œ</th></tr></thead><tbody id="fontListBody"></tbody></table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { sb, initConfig } from "./config.js";

        // ==========================================
        // 1. ì „ì—­ ë³€ìˆ˜ ë° ê³µí†µ ìœ í‹¸
        // ==========================================
        let currentOrderStatus = 'ì ‘ìˆ˜ë¨'; 
        let allOrders = [];
        let editingProdId = null;
        let editingAddonId = null;
        let allProducts = [];
        let staffList = []; 

        const formatCurrency = (amount, siteCode) => {
            if (!amount) return '0';
            const site = siteCode || 'KR';
            if (site === 'JP') return 'Â¥' + amount.toLocaleString();
            if (site === 'US') return '$' + amount.toLocaleString();
            return amount.toLocaleString() + 'ì›';
        }

        window.showSection = (secId, navEl) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(secId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(navEl) navEl.classList.add('active');
            
            if(secId === 'sec-orders') loadOrders();
            if(secId === 'sec-stats') loadStatsData();
            if(secId === 'sec-members') loadMembers();
            if(secId === 'sec-templates') { loadTemplates(); loadProductKeys(); } // [ìˆ˜ì •] í…œí”Œë¦¿ ì„¹ì…˜ ì§„ì… ì‹œ ì œí’ˆ í‚¤ ë¡œë“œ
            if(secId === 'sec-fonts') loadFonts(); 
            if(secId === 'sec-products') { loadCategories(); loadSystemDB(); }
            if(secId === 'sec-staff') loadStaffList(); 
        };

        window.logout = async () => { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await sb.auth.signOut(); location.href = "index.html"; } };
        window.closeModal = (id) => document.getElementById(id).style.display='none';
        function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

        // ==========================================
        // 2. ì£¼ë¬¸ ê´€ë¦¬ (Orders)
        // ==========================================
        window.filterOrders = (status, btn) => {
            currentOrderStatus = status;
            document.querySelectorAll('#sec-orders .btn-primary').forEach(b => { b.classList.remove('btn-primary'); b.classList.add('btn-outline'); });
            if(btn) { btn.classList.remove('btn-outline'); btn.classList.add('btn-primary'); }
            updateActionButtons();
            loadOrders();
        };

        function updateActionButtons() {
            const btnGroup = document.getElementById('action-buttons');
            btnGroup.innerHTML = "";
            if (currentOrderStatus === 'ì ‘ìˆ˜ë¨') {
                btnGroup.innerHTML = `<button class="btn btn-primary" onclick="changeStatusSelected('ì¹¼ì„ ì‘ì—…')">ì„ íƒ ì‘ì—…ì‹œì‘</button><button class="btn btn-danger" onclick="deleteOrdersSelected(false)">ì„ íƒ ì‚­ì œ</button>`;
            } else if (currentOrderStatus === 'ì¹¼ì„ ì‘ì—…') {
                btnGroup.innerHTML = `<button class="btn btn-success" onclick="downloadBulkFiles()">ì¼ê´„ ë‹¤ìš´ë¡œë“œ</button><button class="btn btn-vip" onclick="changeStatusSelected('ì™„ë£Œë¨')">ì„ íƒ ì™„ë£Œì²˜ë¦¬</button>`;
            } else if (currentOrderStatus === 'ì™„ë£Œë¨') {
                btnGroup.innerHTML = `<button class="btn btn-outline" onclick="changeStatusSelected('ì¹¼ì„ ì‘ì—…')"><i class="fa-solid fa-rotate-left"></i> ë‹¤ì‹œì¶œë ¥</button><button class="btn btn-danger" onclick="deleteOrdersSelected(true)">ì˜êµ¬ì‚­ì œ</button>`;
            }
        }

        window.loadOrders = async () => {
            showLoading(true);
            updateActionButtons(); 
            
            const siteFilter = document.getElementById('filterSite').value;
            await fetchStaffForOrders();

            let query = sb.from('orders').select('*').order('created_at', {ascending:false});
            
            if (currentOrderStatus === 'ì ‘ìˆ˜ë¨') query = query.in('status', ['ì ‘ìˆ˜ë¨', 'íŒŒì¼ì²˜ë¦¬ì¤‘', 'ì ‘ìˆ˜ëŒ€ê¸°']);
            else if (currentOrderStatus === 'ì¹¼ì„ ì‘ì—…') query = query.eq('status', 'ì¹¼ì„ ì‘ì—…');
            else if (currentOrderStatus === 'ì™„ë£Œë¨') query = query.in('status', ['ì™„ë£Œë¨', 'ë°œì†¡ì™„ë£Œ', 'ì™„ë£Œ']);

            const { data, error } = await query;
            const tbody = document.getElementById('orderListBody');
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:30px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; 
                showLoading(false); return; 
            }
            
            const filteredData = siteFilter === 'all' ? data : data.filter(o => (o.site_code || 'KR') === siteFilter);
            allOrders = filteredData; 

            // ê°€ê²© ì •ë³´ ë§µí•‘
            const { data: allProds } = await sb.from('admin_products').select('price, name');
            const prodMap = {}; if(allProds) allProds.forEach(p => prodMap[p.name] = p.price);

            filteredData.forEach(order => {
                const site = order.site_code || 'KR'; 
                const managerSelect = createStaffSelectHTML(order.id, 'manager', order.staff_manager_id);
                const driverSelect = createStaffSelectHTML(order.id, 'driver', order.staff_driver_id);
                const filesJson = order.files ? JSON.stringify(order.files).replace(/"/g, '&quot;') : '[]';
                
                let items = [];
                if (order.items) {
                    if (Array.isArray(order.items)) items = order.items;
                    else if (typeof order.items === 'string') { try { items = JSON.parse(order.items); } catch(e) { items = []; } }
                }
                
                if (items.length === 0 && order.files && Array.isArray(order.files)) {
                    order.files.forEach(f => {
                        if (f.name.indexOf('ì‘ì—…ì§€ì‹œì„œ') === -1 && f.name.indexOf('ê²¬ì ì„œ') === -1) {
                            let simpleName = f.name.substring(0, f.name.lastIndexOf('.')) || f.name;
                            items.push({ productName: simpleName, qty: 1, isFileDerived: true });
                        }
                    });
                }
                const itemsJson = JSON.stringify(items).replace(/"/g, '&quot;');

                let finalPrice = order.total_amount || 0;
                if (finalPrice === 0 && items.length > 0) {
                    items.forEach(item => {
                        if (item.isFileDerived) return;
                        let unitPrice = 0;
                        if (item.product && item.product.price) unitPrice = item.product.price;
                        else if (item.product && prodMap[item.product.name]) unitPrice = prodMap[item.product.name];
                        if (!unitPrice) unitPrice = item.price || 0;
                        finalPrice += unitPrice * (item.qty || 1);
                    });
                }
                const priceStr = formatCurrency(finalPrice, site);

                let itemsDisplayHtml = '';
                if (items.length > 0) {
                    items.forEach(i => {
                        let pName = i.productName || (i.product ? i.product.name : i.name) || 'ìƒí’ˆ';
                        let qty = i.qty || 1;
                        let icon = i.isFileDerived ? '<i class="fa-regular fa-file-lines" style="color:#94a3b8; margin-right:4px;"></i>' : '- ';
                        itemsDisplayHtml += `<div style="margin-bottom:4px; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${icon}${pName} <b style="color:#6366f1;">(${qty}ê°œ)</b></div>`;
                    });
                    if(order.request_note) {
                        itemsDisplayHtml += `<div style="font-size:11px; color:#ef4444; margin-top:4px; background:#fff1f2; padding:3px 6px; border-radius:4px; display:inline-block;">ğŸ“¢ ${order.request_note}</div>`;
                    }
                } else {
                    itemsDisplayHtml = '<span style="color:#ccc; font-size:12px;">ë‚´ì—­ ì—†ìŒ</span>';
                }

                let fileBtns = ''; 
                if(order.files && Array.isArray(order.files)) {
                    order.files.forEach(f => { fileBtns += `<a href="${f.url}" target="_blank" class="btn-file" title="${f.name}"><i class="fa-solid fa-file"></i> ${f.name}</a>`; });
                } else { fileBtns = '<span style="color:#ccc; font-size:12px;">íŒŒì¼ ì—†ìŒ</span>'; }

                let payMethod = order.payment_method || '-';
                let payBadge = `<span class="pay-badge pay-wait">ë¯¸ê²°ì œ</span>`;
                const isPaid = (order.payment_status === 'paid' || order.payment_status === 'ê²°ì œì™„ë£Œ' || order.payment_status === 'ì¹´ë“œê²°ì œì™„ë£Œ' || order.payment_status === 'ì…ê¸ˆí™•ì¸ë¨');
                
                if (isPaid) payBadge = `<span class="pay-badge pay-done">ê²°ì œì™„ë£Œ</span>`; 
                else if (order.payment_status === 'ì…ê¸ˆëŒ€ê¸°') payBadge = `<span class="pay-badge" style="background:#fff7ed; color:#c2410c; border:1px solid #ffedd5;">ì…ê¸ˆëŒ€ê¸°</span>`;
                else if (order.payment_status === 'ê²°ì œì¤‘ë‹¨') payBadge = `<span class="pay-badge" style="background:#f1f5f9; color:#64748b;">ê²°ì œì¤‘ë‹¨</span>`;

                tbody.innerHTML += `
                    <tr>
                        <td><input type="checkbox" class="row-chk" value="${order.id}" data-manager="${order.manager_name}" data-files="${filesJson}" data-items="${itemsJson}"></td>
                        <td><span class="badge-site ${site.toLowerCase()}">${site}</span></td>
                        <td>${new Date(order.created_at).toLocaleDateString()}<br><small style="color:#888;">${new Date(order.created_at).toLocaleTimeString()}</small></td>
                        <td><b>${order.manager_name}</b><br><span style="font-size:12px; color:#666;">${order.phone}</span></td>
                        <td style="color:#334155; max-width:220px;">${itemsDisplayHtml}</td>
                        <td style="text-align:right; font-weight:bold; color:#0f172a;">${priceStr}</td>
                        <td style="background:#f9faff; min-width: 170px;">
                            <div style="margin-bottom:6px;">
                                <input type="date" class="input-text" 
                                    style="padding:5px; font-size:12px; width:100%; border:1px solid #cbd5e1; box-sizing:border-box;" 
                                    value="${order.delivery_target_date || ''}" 
                                    onchange="updateTaskDB('${order.id}', 'delivery_target_date', this.value)"
                                    title="ë°°ì†¡ ì˜ˆì •ì¼ ì§€ì •">
                            </div>
                            <div style="margin-bottom:4px;">${managerSelect}</div>
                            <div>${driverSelect}</div>
                        </td>
                        <td>
                            <div style="margin-bottom:5px; padding-bottom:5px; border-bottom:1px dashed #ddd;">
                                <button class="btn btn-vip btn-sm" onclick="triggerManualSheet('${order.id}')" style="width:100%;">
                                    <i class="fa-solid fa-file-pdf"></i> ì‘ì—…ì§€ì‹œì„œ êµì²´
                                </button>
                            </div>
                            <div style="display:flex; align-items:flex-start; gap:5px; flex-wrap:wrap;">
                                <button class="btn btn-outline btn-sm" onclick="triggerFileReplace('${order.id}')" title="ë°ì´í„°êµì²´" style="padding: 6px 8px; height: 30px; color:#2563eb; border-color:#bfdbfe; background:#eff6ff;"><i class="fa-solid fa-rotate"></i></button>
                                ${fileBtns}
                            </div>
                        </td>
                        <td>
                            <div style="font-size:12px; margin-bottom:3px; font-weight:bold;">${payMethod}</div>
                            ${payBadge}
                            ${(!isPaid) ? `<button class="btn btn-outline" style="font-size:10px; padding:2px 5px; margin-top:3px;" onclick="confirmPayment('${order.id}')">ì…ê¸ˆí™•ì¸</button>` : ''}
                        </td>
                    </tr>
                `;
            });
            showLoading(false);
        };

        async function fetchStaffForOrders() { const { data } = await sb.from('admin_staff').select('*'); staffList = data || []; }
        function createStaffSelectHTML(orderId, role, selectedId) {
            const roleName = role === 'manager' ? 'ë‹´ë‹¹' : 'ë°°ì†¡';
            const filteredStaff = staffList.filter(s => s.role === role);
            const selectedStaff = staffList.find(s => s.id == selectedId);
            const dotColor = selectedStaff ? selectedStaff.color : '#ccc';
            const bgColor = selectedStaff ? selectedStaff.color + '10' : '#fff'; 
            let options = `<option value="">${roleName} ë¯¸ì§€ì •</option>`;
            filteredStaff.forEach(s => { options += `<option value="${s.id}" ${s.id == selectedId ? 'selected' : ''}>${s.name}</option>`; });
            return `<div style="position:relative;"><span class="color-dot" style="background:${dotColor}; position:absolute; left:8px; top:10px; pointer-events:none;"></span><select class="staff-select" style="padding-left:25px; background:${bgColor}; border-color:${selectedStaff ? dotColor : '#e2e8f0'};" onchange="updateOrderStaff('${orderId}', '${role}', this.value)">${options}</select></div>`;
        }
        window.updateOrderStaff = async (orderId, role, staffId) => { const field = role === 'manager' ? 'staff_manager_id' : 'staff_driver_id'; const val = staffId ? parseInt(staffId) : null; const { error } = await sb.from('orders').update({ [field]: val }).eq('id', orderId); if(error) alert("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: " + error.message); else loadOrders(); };
        window.toggleAll = (source) => { document.querySelectorAll('.row-chk').forEach(el => el.checked = source.checked); };
        window.changeStatusSelected = async (newStatus) => {
            const checks = document.querySelectorAll('.row-chk:checked');
            if (checks.length === 0) return alert("ì„ íƒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");
            if (!confirm(`ì„ íƒí•œ ${checks.length}ê±´ì„ '${newStatus}' ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const ids = Array.from(checks).map(c => c.value);
            const { error } = await sb.from('orders').update({ status: newStatus }).in('id', ids);
            if (error) alert("ì˜¤ë¥˜: " + error.message); else loadOrders();
        };
        window.deleteOrdersSelected = async (isPermanent) => {
            const checks = document.querySelectorAll('.row-chk:checked');
            if (checks.length === 0) return alert("ì‚­ì œí•  ì£¼ë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            if (!confirm(isPermanent ? "ì •ë§ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const ids = Array.from(checks).map(c => c.value);
            const { error } = await sb.from('orders').delete().in('id', ids);
            if (error) alert("ì‹¤íŒ¨: " + error.message); else loadOrders();
        };
        
        // [ì¼ê´„ ë‹¤ìš´ë¡œë“œ]
        window.downloadBulkFiles = async () => {
            const checks = document.querySelectorAll('.row-chk:checked');
            if (checks.length === 0) return alert("ë‹¤ìš´ë¡œë“œí•  ì£¼ë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            showLoading(true);
            try {
                const zip = new JSZip();
                let fileCount = 0;
                const fetchPromises = [];
                checks.forEach(chk => {
                    const customerName = chk.dataset.manager || 'ê³ ê°ë¯¸ìƒ';
                    const files = JSON.parse(chk.dataset.files || '[]');
                    const items = JSON.parse(chk.dataset.items || '[]');
                    if (files.length === 0) return;
                    const clean = (str) => (str || '').replace(/[\\/:*?"<>|]/g, "").trim();
                    let prodItemIndex = 0; 
                    files.forEach(file => {
                        const originalName = file.name || '';
                        const ext = originalName.split('.').pop(); 
                        let newFileName = "";
                        if (originalName.includes("ê²¬ì ì„œ")) {
                            newFileName = `${clean(customerName)}_ê²¬ì ì„œ.${ext}`;
                        } else if (originalName.includes("ì‘ì—…ì§€ì‹œì„œ")) {
                            newFileName = `${clean(customerName)}_ì‘ì—…ì§€ì‹œì„œ.${ext}`;
                        } else {
                            let currentProductName = 'ê¸°íƒ€'; 
                            if (items.length > 0) {
                                const targetItem = items[prodItemIndex] || items[0]; 
                                if (targetItem.product) currentProductName = targetItem.product.name;
                                else currentProductName = targetItem.productName || targetItem.name || 'ì œí’ˆ';
                            }
                            const random3 = String(Math.floor(Math.random() * 900) + 100);
                            newFileName = `${clean(customerName)}_${random3}_${clean(currentProductName)}.${ext}`;
                            prodItemIndex++;
                        }
                        if(zip.file(newFileName)) newFileName = newFileName.replace(`.${ext}`, `_copy.${ext}`);
                        const promise = fetch(file.url).then(res => { if (!res.ok) throw new Error('Network response was not ok'); return res.blob(); }).then(blob => { zip.file(newFileName, blob); fileCount++; }).catch(err => console.error("File loading error:", err));
                        fetchPromises.push(promise);
                    });
                });
                if (fetchPromises.length === 0) { showLoading(false); return alert("ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."); }
                await Promise.all(fetchPromises);
                if (fileCount === 0) { showLoading(false); return alert("íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); }
                const content = await zip.generateAsync({ type: "blob" });
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                saveAs(content, `ì£¼ë¬¸íŒŒì¼ì¼ê´„_${today}.zip`);
            } catch (e) { console.error(e); alert("ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜: " + e.message); } finally { showLoading(false); }
        };
        
        window.confirmPayment = async (id) => { if(!confirm("ì…ê¸ˆì„ í™•ì¸í•˜ê³  'ê²°ì œì™„ë£Œ' ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; const { error } = await sb.from('orders').update({ payment_status: 'ê²°ì œì™„ë£Œ', payment_method: 'ê³„ì¢Œì´ì²´' }).eq('id', id); if(error) alert("ì˜¤ë¥˜: " + error.message); else loadOrders(); };

        // [íŒŒì¼ êµì²´] (ë°ì´í„° íŒŒì¼ë§Œ)
        let targetReplaceOrderId = null;
        window.triggerFileReplace = (id) => { targetReplaceOrderId = id; document.getElementById('replaceFileInput').click(); }
        window.handleFileReplace = async (input) => {
            if (!input.files || input.files.length === 0) return;
            if (!targetReplaceOrderId) return;
            const file = input.files[0];
            const confirmMsg = `ê¸°ì¡´ ë°ì´í„° íŒŒì¼ì„ ì‚­ì œí•˜ê³ \n'${file.name}' íŒŒì¼ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê²¬ì ì„œì™€ ì‘ì—…ì§€ì‹œì„œëŠ” ìœ ì§€ë©ë‹ˆë‹¤)`;
            if (!confirm(confirmMsg)) { input.value = ''; return; }
            showLoading(true);
            try {
                const { data: orderData, error: fetchErr } = await sb.from('orders').select('files').eq('id', targetReplaceOrderId).single();
                if (fetchErr) throw fetchErr;
                const existingFiles = orderData.files || [];
                const keptFiles = existingFiles.filter(f => (f.name && f.name.includes('ê²¬ì ì„œ')) || (f.name && f.name.includes('ì‘ì—…ì§€ì‹œì„œ')));
                const timestamp = Date.now();
                const path = `orders/${targetReplaceOrderId}/replaced_${timestamp}_${file.name}`;
                const { error: uploadErr } = await sb.storage.from('orders').upload(path, file);
                if (uploadErr) throw uploadErr;
                const { data: publicUrlData } = sb.storage.from('orders').getPublicUrl(path);
                const newFileObj = { name: file.name, url: publicUrlData.publicUrl, type: 'replaced_file' };
                const finalFilesArray = [...keptFiles, newFileObj];
                const { error: dbErr } = await sb.from('orders').update({ files: finalFilesArray }).eq('id', targetReplaceOrderId);
                if (dbErr) throw dbErr;
                alert("íŒŒì¼ì´ ì•ˆì „í•˜ê²Œ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤."); loadOrders(); 
            } catch (e) { console.error(e); alert("íŒŒì¼ êµì²´ ì‹¤íŒ¨: " + e.message); } finally { input.value = ''; targetReplaceOrderId = null; showLoading(false); }
        };

        // â˜… [ì¶”ê°€] ì‘ì—…ì§€ì‹œì„œ ìˆ˜ë™ êµì²´
        let targetManualSheetId = null;
        window.triggerManualSheet = (id) => { targetManualSheetId = id; document.getElementById('manualOrderSheetInput').click(); }
        window.uploadManualOrderSheet = async (input) => {
            if (!input.files || input.files.length === 0) return;
            if (!targetManualSheetId) return;
            const file = input.files[0];
            if (!confirm("ì„ íƒí•œ PDF íŒŒì¼ë¡œ ì‘ì—…ì§€ì‹œì„œë¥¼ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { input.value = ''; return; }
            showLoading(true);
            try {
                // 1. ê¸°ì¡´ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const { data: orderData, error: fetchErr } = await sb.from('orders').select('files').eq('id', targetManualSheetId).single();
                if (fetchErr) throw fetchErr;
                const existingFiles = orderData.files || [];
                
                // 2. ê¸°ì¡´ ì‘ì—…ì§€ì‹œì„œ ì œê±°
                const keptFiles = existingFiles.filter(f => !f.name.includes('ì‘ì—…ì§€ì‹œì„œ'));
                
                // 3. ìƒˆ ì§€ì‹œì„œ ì—…ë¡œë“œ
                const timestamp = Date.now();
                const path = `orders/${targetManualSheetId}/manual_sheet_${timestamp}.pdf`;
                const { error: uploadErr } = await sb.storage.from('orders').upload(path, file);
                if (uploadErr) throw uploadErr;
                const { data: publicUrlData } = sb.storage.from('orders').getPublicUrl(path);
                
                // 4. ìƒˆ íŒŒì¼ ê°ì²´ ì¶”ê°€ (ì´ë¦„ì„ 'ì‘ì—…ì§€ì‹œì„œ.pdf'ë¡œ ê³ ì •)
                const newSheetObj = { name: 'ì‘ì—…ì§€ì‹œì„œ(ìˆ˜ì •).pdf', url: publicUrlData.publicUrl, type: 'order_sheet' };
                const finalFilesArray = [newSheetObj, ...keptFiles]; // ì§€ì‹œì„œë¥¼ ë§¨ ì•ì— ë°°ì¹˜

                // 5. DB ì—…ë°ì´íŠ¸
                const { error: dbErr } = await sb.from('orders').update({ files: finalFilesArray }).eq('id', targetManualSheetId);
                if (dbErr) throw dbErr;
                alert("ì‘ì—…ì§€ì‹œì„œê°€ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤."); loadOrders(); 
            } catch(e) { console.error(e); alert("êµì²´ ì‹¤íŒ¨: " + e.message); } finally { input.value = ''; targetManualSheetId = null; showLoading(false); }
        }

        // (ì´í•˜ í†µê³„, ìƒí’ˆ ê´€ë¦¬ ë¡œì§ ê¸°ì¡´ ìœ ì§€ - ë¶„ëŸ‰ìƒ ìƒëµëœ ë¶€ë¶„ ì—†ì´ ëª¨ë‘ í¬í•¨ë¨)
        window.loadStatsData = async () => { /* ê¸°ì¡´ ìœ ì§€ */ let start = document.getElementById('statStartDate').value; let end = document.getElementById('statEndDate').value; if(!start || !end) { const now = new Date(); const firstDay = new Date(now.getFullYear(), now.getMonth(), 1); start = firstDay.toISOString().split('T')[0]; end = now.toISOString().split('T')[0]; document.getElementById('statStartDate').value = start; document.getElementById('statEndDate').value = end; } document.getElementById('loading').style.display = 'flex'; const { data: orders, error } = await sb.from('orders').select('*').gte('created_at', start + 'T00:00:00').lte('created_at', end + 'T23:59:59'); if(error) { alert("ë¡œë“œ ì‹¤íŒ¨"); document.getElementById('loading').style.display = 'none'; return; } const { data: allProds } = await sb.from('admin_products').select('price, name'); const prodMap = {}; if(allProds) allProds.forEach(p => prodMap[p.name] = p.price); let totalRevenue = 0; const managerStats = {}; const driverStats = {}; orders.forEach(o => { let amt = o.total_amount || 0; let items = o.items; if (typeof items === 'string') { try { items = JSON.parse(items); } catch(e) { items = []; } } if(amt === 0 && Array.isArray(items)) { items.forEach(i => { let p = 0; if(i.product && i.product.price) p = i.product.price; else if(i.product && prodMap[i.product.name]) p = prodMap[i.product.name]; if(!p) p = i.price || 10000; amt += p * (i.qty || 1); }); } totalRevenue += amt; if(o.staff_manager_id) managerStats[o.staff_manager_id] = (managerStats[o.staff_manager_id] || 0) + amt; if(o.staff_driver_id) driverStats[o.staff_driver_id] = (driverStats[o.staff_driver_id] || 0) + amt; }); document.getElementById('totalRevenue').innerText = totalRevenue.toLocaleString() + "ì›"; document.getElementById('totalCount').innerText = orders.length + "ê±´"; const { data: staff } = await sb.from('admin_staff').select('*'); renderStaffStats('statManagerBody', managerStats, staff || [], totalRevenue); renderStaffStats('statDriverBody', driverStats, staff || [], totalRevenue); document.getElementById('loading').style.display = 'none'; };
        function renderStaffStats(elemId, statsObj, staffList, totalRev) { const tbody = document.getElementById(elemId); tbody.innerHTML = ''; const sortedIds = Object.keys(statsObj).sort((a,b) => statsObj[b] - statsObj[a]); if(sortedIds.length === 0) { tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;">ë°ì´í„° ì—†ìŒ</td></tr>'; return; } sortedIds.forEach(id => { const s = staffList.find(st => st.id == id); if(!s) return; const amt = statsObj[id]; const percent = totalRev > 0 ? Math.round((amt / totalRev) * 100) : 0; tbody.innerHTML += `<tr><td style="padding:12px 0;"><div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;"><div style="width:12px; height:12px; border-radius:50%; background:${s.color};"></div><span style="font-weight:bold;">${s.name}</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${percent}%; background:${s.color};"></div></div></td><td style="text-align:right;"><div>${amt.toLocaleString()}ì›</div><div style="font-size:11px; color:#999;">${percent}%</div></td></tr>`; }); }
        window.loadCategories = async () => { const { data } = await sb.from('admin_categories').select('*').order('sort_order', {ascending:true}); const selectBox = document.getElementById('newProdCategory'); const listArea = document.getElementById('categoryListArea'); selectBox.innerHTML = '<option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>'; listArea.innerHTML = ''; if(data) data.forEach(cat => { const option = document.createElement('option'); option.value = cat.code; option.innerText = `${cat.name} (${cat.code})`; selectBox.appendChild(option); const span = document.createElement('span'); span.className = 'badge draggable'; span.draggable = true; span.dataset.id = cat.id; span.style.cssText = "border:1px solid #bae6fd; color:#0284c7; margin-right:5px; margin-bottom:5px; display:inline-block; user-select:none;"; span.innerHTML = `<b>${cat.name}</b> (${cat.code}) <i class="fa-solid fa-pen" style="font-size:10px; margin-left:5px; color:#aaa;"></i>`; span.onclick = () => window.editCategoryLoad(cat.id); span.addEventListener('dragstart', () => span.classList.add('dragging')); span.addEventListener('dragend', async () => { span.classList.remove('dragging'); await saveCategoryOrder(); }); listArea.appendChild(span); }); listArea.addEventListener('dragover', e => { e.preventDefault(); const afterElement = getDragAfterElementX(listArea, e.clientX); const draggable = document.querySelector('.badge.dragging'); if (afterElement == null) listArea.appendChild(draggable); else listArea.insertBefore(draggable, afterElement); }); };
        window.addCategoryDB = async () => { const code=document.getElementById('newCatCode').value; const name=document.getElementById('newCatName').value; const name_jp=document.getElementById('newCatNameJP').value; const name_us=document.getElementById('newCatNameUS').value; if(!code || !name) return alert("í•„ìˆ˜í•­ëª© ëˆ„ë½"); const {error} = await sb.from('admin_categories').upsert([{code:code.toLowerCase().replace(/\s/g,'_'), name, name_jp, name_us}], {onConflict:'code'}); if(error) alert(error.message); else { alert("ì €ì¥ë¨"); loadCategories(); } };
        window.editCategoryLoad = async (id) => { const {data} = await sb.from('admin_categories').select('*').eq('id',id).single(); if(data) { document.getElementById('newCatCode').value=data.code; document.getElementById('newCatName').value=data.name; document.getElementById('newCatNameJP').value=data.name_jp||''; document.getElementById('newCatNameUS').value=data.name_us||''; document.querySelector('.card').scrollIntoView({behavior:'smooth'}); } };
        async function saveCategoryOrder() { const badges = document.querySelectorAll('#categoryListArea .badge'); const updates=[]; badges.forEach((b,i)=>updates.push(sb.from('admin_categories').update({sort_order:i+1}).eq('id',b.dataset.id))); await Promise.all(updates); }
        function getDragAfterElementX(container, x) { const draggables = [...container.querySelectorAll('.badge:not(.dragging)')]; return draggables.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = x - box.left - box.width / 2; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest; }, { offset: Number.NEGATIVE_INFINITY }).element; }
        window.loadSystemDB = async (filterSite = 'KR') => { const { data: addons } = await sb.from('admin_addons').select('*').order('category'); const addonBody = document.getElementById('addonTableBody'); const chkArea = document.getElementById('addonCheckboxArea'); if(addonBody) addonBody.innerHTML = ''; if(chkArea) chkArea.innerHTML = ''; if(addons) { addons.forEach(item => { const color = item.category==='material'?'#16a34a':(item.category==='finish'?'#2563eb':'#d97706'); let dName = item.name_kr || item.name; let dPrice = item.price_kr || item.price; if(filterSite === 'JP') { dName = item.name_jp || item.name; dPrice = item.price_jp || 0; } if(filterSite === 'US') { dName = item.name_us || item.name; dPrice = item.price_us || 0; } const priceStr = formatCurrency(dPrice, filterSite); if(addonBody) { addonBody.innerHTML += `<tr style="background:${editingAddonId===item.id?'#f0f9ff':'transparent'}"><td><span style="color:${color};font-weight:bold;">${item.category}</span></td><td><b>${item.code}</b></td><td><div>ğŸ‡°ğŸ‡· ${item.name_kr||item.name} (${item.price_kr||item.price})</div><div style="font-size:11px;color:#888;">ğŸ‡¯ğŸ‡µ ${item.name_jp||'-'} / ğŸ‡ºğŸ‡¸ ${item.name_us||'-'}</div></td><td><button class="btn btn-outline" style="padding:4px;" onclick="editAddonLoad(${item.id})">ìˆ˜ì •</button> <button class="btn btn-danger" style="padding:4px;" onclick="deleteSystemData('admin_addons',${item.id})">x</button></td></tr>`; } if(chkArea) { chkArea.innerHTML += `<label class="addon-check-item"><span class="badge-site ${filterSite.toLowerCase()}" style="font-size:10px;">${filterSite}</span> ${dName} (${priceStr}) <input type="checkbox" name="prodAddon" value="${item.code}"></label>`; } }); } const { data: prods } = await sb.from('admin_products').select('*').order('sort_order').order('id'); allProducts = prods || []; renderProductList(allProducts); };
        window.editAddonLoad = async (id) => { const { data } = await sb.from('admin_addons').select('*').eq('id', id).single(); if(!data) return; editingAddonId = id; document.getElementById('newAddonCat').value = data.category; document.getElementById('newAddonCode').value = data.code; document.getElementById('nmKR').value = data.name_kr||data.name; document.getElementById('prKR').value = data.price_kr||data.price; document.getElementById('nmJP').value = data.name_jp||''; document.getElementById('prJP').value = data.price_jp||0; document.getElementById('nmUS').value = data.name_us||''; document.getElementById('prUS').value = data.price_us||0; const btn = document.querySelector('#newAddonCode').parentElement.parentElement.querySelector('.btn-primary'); btn.innerText = "ìˆ˜ì • ì™„ë£Œ"; btn.classList.remove('btn-primary'); btn.classList.add('btn-vip'); };
        window.addAddonDB = async () => { const cat = document.getElementById('newAddonCat').value; const code = document.getElementById('newAddonCode').value; const nKR = document.getElementById('nmKR').value; const pKR = document.getElementById('prKR').value; const nJP = document.getElementById('nmJP').value; const pJP = document.getElementById('prJP').value; const nUS = document.getElementById('nmUS').value; const pUS = document.getElementById('prUS').value; if(!code) return alert("ì½”ë“œ í•„ìˆ˜"); const payload = { category: cat, code: code, name_kr: nKR, price_kr: parseInt(pKR||0), name_jp: nJP, price_jp: parseInt(pJP||0), name_us: nUS, price_us: parseInt(pUS||0), name: nKR, price: parseInt(pKR||0) }; if(editingAddonId) { await sb.from('admin_addons').update(payload).eq('id', editingAddonId); alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); } else { await sb.from('admin_addons').insert([payload]); alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); } editingAddonId = null; document.getElementById('newAddonCode').value = ''; document.getElementById('nmKR').value=''; document.getElementById('prKR').value=''; document.getElementById('nmJP').value=''; document.getElementById('prJP').value=''; document.getElementById('nmUS').value=''; document.getElementById('prUS').value=''; const btn = document.querySelector('#newAddonCode').parentElement.parentElement.querySelector('.btn'); btn.innerText = "ì €ì¥"; btn.classList.remove('btn-vip'); btn.classList.add('btn-primary'); loadSystemDB('KR'); };
        window.renderProductList = (products) => { const prodBody = document.getElementById('prodTableBody'); prodBody.innerHTML = ''; if(!products) return; products.forEach(item => { const site = item.site_code || 'KR'; const displayPrice = formatCurrency(item.price, site); const tr = document.createElement('tr'); tr.className = 'draggable-row'; tr.draggable = true; tr.dataset.id = item.id; tr.innerHTML = `<td><span class="badge-site ${site.toLowerCase()}">${site}</span></td><td><img src="${item.img_url}" style="width:40px; height:40px; object-fit:cover; border-radius:4px;"></td><td><b style="color:#6366f1;">${item.code}</b><br>${item.name}</td><td>${item.width_mm}x${item.height_mm}</td><td>${displayPrice}</td><td><button class="btn btn-outline" style="padding:4px;" onclick="editProductLoad(${item.id})">ìˆ˜ì •</button> <button class="btn btn-danger" style="padding:4px;" onclick="deleteSystemData('admin_products', ${item.id})">ì‚­ì œ</button></td>`; addDragListeners(tr); prodBody.appendChild(tr); }); };
        window.addProductDB = async () => { const site = document.getElementById('newProdSite').value; const cat = document.getElementById('newProdCategory').value; const code = document.getElementById('newProdCode').value; const name = document.getElementById('newProdName').value; const w = document.getElementById('newProdW').value; const h = document.getElementById('newProdH').value; const price = document.getElementById('newProdPrice').value; const img = document.getElementById('newProdImg').value; if(!code || !name) return alert("í•„ìˆ˜í•­ëª©"); let currency = 'KRW'; if(site==='JP') currency='JPY'; if(site==='US') currency='USD'; const addons = Array.from(document.querySelectorAll('input[name="prodAddon"]:checked')).map(cb => cb.value).join(','); const payload = { site_code:site, currency, category:cat, code, name, width_mm:parseInt(w||0), height_mm:parseInt(h||0), price:parseInt(price||0), img_url:img, addons }; let res; if(editingProdId) res=await sb.from('admin_products').update(payload).eq('id',editingProdId); else res=await sb.from('admin_products').insert([payload]); if(res.error) alert(res.error.message); else { alert("ì €ì¥ë¨"); resetProductForm(); loadSystemDB(site); } };
        window.editProductLoad = async (id) => { const { data } = await sb.from('admin_products').select('*').eq('id', id).single(); if(!data) return; editingProdId = id; document.getElementById('newProdSite').value = data.site_code; document.getElementById('newProdCategory').value = data.category; document.getElementById('newProdCode').value = data.code; document.getElementById('newProdName').value = data.name; document.getElementById('newProdW').value = data.width_mm; document.getElementById('newProdH').value = data.height_mm; document.getElementById('newProdPrice').value = data.price; document.getElementById('newProdImg').value = data.img_url; document.getElementById('prodPreview').src = data.img_url; document.getElementById('prodPreview').style.display='block'; const addons = data.addons ? data.addons.split(',') : []; document.querySelectorAll('input[name="prodAddon"]').forEach(c => c.checked = addons.includes(c.value)); document.getElementById('btnProductSave').innerText = "ìˆ˜ì • ì €ì¥"; document.getElementById('btnProductClone').style.display='inline-block'; document.getElementById('btnCancelEdit').style.display='inline-block'; document.querySelector('.product-form').scrollIntoView({behavior:'smooth'}); };
        window.cloneProduct = () => { editingProdId=null; document.getElementById('newProdCode').value += "_copy"; document.getElementById('btnProductSave').innerText="ìƒˆ ìƒí’ˆ ë“±ë¡"; alert("ë³µì œ ëª¨ë“œ"); };
        window.resetProductForm = () => { editingProdId=null; document.getElementById('newProdCode').value=''; document.getElementById('newProdName').value=''; document.getElementById('newProdPrice').value=''; document.getElementById('newProdImg').value=''; document.getElementById('prodPreview').style.display='none'; document.getElementById('btnProductSave').innerText="ìƒí’ˆ ë“±ë¡"; document.getElementById('btnProductClone').style.display='none'; document.getElementById('btnCancelEdit').style.display='none'; };
        window.previewProductImage = async (input) => { if(!input.files[0]) return; const file=input.files[0]; const reader=new FileReader(); reader.onload=(e)=>{document.getElementById('prodPreview').src=e.target.result; document.getElementById('prodPreview').style.display='block';}; reader.readAsDataURL(file); const btn=document.getElementById('btnProductSave'); btn.innerText="ì—…ë¡œë“œì¤‘..."; btn.disabled=true; try { const path=`products/${Date.now()}_${file.name}`; await sb.storage.from('products').upload(path, file); const {data}=sb.storage.from('products').getPublicUrl(path); document.getElementById('newProdImg').value=data.publicUrl; } catch(e){alert("ì—…ë¡œë“œì‹¤íŒ¨");} finally {btn.innerText="ìƒí’ˆ ë“±ë¡"; btn.disabled=false;} };
        window.deleteSystemData = async (t, id) => { if(confirm("ì‚­ì œ?")) { await sb.from(t).delete().eq('id',id); loadSystemDB(); }};
        function addDragListeners(row) { row.addEventListener('dragstart',()=>row.classList.add('dragging')); row.addEventListener('dragend',async()=>{row.classList.remove('dragging'); await saveSortOrder();}); const container=document.getElementById('prodTableBody'); container.addEventListener('dragover',e=>{e.preventDefault(); const after=getDragAfterElementY(container,e.clientY); const drag=document.querySelector('.draggable-row.dragging'); if(after==null) container.appendChild(drag); else container.insertBefore(drag,after);}); }
        function getDragAfterElementY(container,y) { return [...container.querySelectorAll('.draggable-row:not(.dragging)')].reduce((closest,child)=>{const box=child.getBoundingClientRect(); const offset=y-box.top-box.height/2; if(offset<0&&offset>closest.offset) return {offset:offset, element:child}; else return closest;},{offset:Number.NEGATIVE_INFINITY}).element; }
        async function saveSortOrder() { const updates=[]; document.querySelectorAll('#prodTableBody tr').forEach((r,i)=>updates.push(sb.from('admin_products').update({sort_order:i+1}).eq('id',r.dataset.id))); await Promise.all(updates); }
        window.loadStaffList = async () => { const {data}=await sb.from('admin_staff').select('*').order('created_at',{ascending:false}); const tbody=document.getElementById('staffListBody'); tbody.innerHTML=''; data?.forEach(s=>{ tbody.innerHTML+=`<tr><td><div class="color-dot" style="background:${s.color}"></div></td><td>${s.name}</td><td>${s.role}</td><td><button class="btn btn-danger btn-sm" onclick="deleteStaffDB(${s.id})">ì‚­ì œ</button></td></tr>`; }); };
        window.addStaffDB = async () => { const name=document.getElementById('staffName').value; const role=document.getElementById('staffRole').value; const color=document.getElementById('staffColor').value; if(!name) return; await sb.from('admin_staff').insert([{name,role,color}]); loadStaffList(); };
        window.deleteStaffDB = async (id) => { if(confirm("ì‚­ì œ?")) await sb.from('admin_staff').delete().eq('id',id); loadStaffList(); };
        window.loadFonts = async () => { const tbody=document.getElementById('fontListBody'); tbody.innerHTML=''; try { const {data}=await sb.from('site_fonts').select('*'); data?.forEach(f=>{ tbody.innerHTML+=`<tr><td>${f.site_code}</td><td>${f.font_name}</td><td style="font-family:'${f.font_family}'">ê°€ë‚˜ë‹¤ ABC</td><td><button class="btn btn-danger btn-sm" onclick="deleteFontDB(${f.id})">ì‚­ì œ</button></td></tr>`; }); } catch(e){} };
        window.uploadFont = async () => { const site=document.getElementById('fontSite').value; const name=document.getElementById('fontName').value; const fam=document.getElementById('fontFamily').value; const file=document.getElementById('fontFile').files[0]; if(!name||!file) return alert("í•„ìˆ˜ì…ë ¥"); try { const path=`fonts/${site}/${Date.now()}_${file.name}`; await sb.storage.from('fonts').upload(path,file); const {data}=sb.storage.from('fonts').getPublicUrl(path); await sb.from('site_fonts').insert([{site_code:site, font_name:name, font_family:fam, file_url:data.publicUrl}]); alert("ì™„ë£Œ"); loadFonts(); } catch(e){alert("ì‹¤íŒ¨");} };
        window.deleteFontDB = async (id) => { if(confirm("ì‚­ì œ?")) await sb.from('site_fonts').delete().eq('id',id); loadFonts(); };
        window.loadMembers = async () => { const {data}=await sb.from('profiles').select('*').order('created_at',{ascending:false}); const tbody=document.getElementById('memberListBody'); tbody.innerHTML=''; data?.forEach(m=>{ const r = m.role || 'customer'; const select = `<select onchange="updateMemberRole('${m.id}', this.value)" style="padding:4px; border:1px solid #ddd; border-radius:4px;"><option value="customer" ${r==='customer'?'selected':''}>ì¼ë°˜íšŒì›</option><option value="vip" ${r==='vip'?'selected':''}>ğŸ‘‘ VIP</option><option value="admin" ${r==='admin'?'selected':''}>ğŸ›  ê´€ë¦¬ì</option></select>`; tbody.innerHTML+=`<tr><td>${new Date(m.created_at).toLocaleDateString()}</td><td>${m.email}</td><td>${r}</td><td>${select}</td></tr>`; }); };
        window.updateMemberRole = async (id, newRole) => { if(!confirm("ë“±ê¸‰ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { loadMembers(); return; } const { error } = await sb.from('profiles').update({ role: newRole }).eq('id', id); if(error) alert("ì‹¤íŒ¨: " + error.message); else alert("ë³€ê²½ ì™„ë£Œ"); };
        function initTemplateListeners() { const fThumb = document.getElementById('fileThumb'); if(fThumb) fThumb.addEventListener('change', e=>{const f=e.target.files[0]; const r=new FileReader(); r.onload=ev=>{document.getElementById('previewThumb').src=ev.target.result; document.getElementById('previewThumb').style.display='block';}; r.readAsDataURL(f);}); const fData = document.getElementById('fileData'); if(fData) fData.addEventListener('change', e=>{const f=e.target.files[0]; const r=new FileReader(); r.onload=ev=>{if(f.name.endsWith('.svg')){document.getElementById('dataStatus').style.display='block';}}; r.readAsDataURL(f);}); }
        
        // [ìˆ˜ì •ë¨] ì¹´í…Œê³ ë¦¬ì— ë”°ë¼ SVG íŒŒì¼ ì—…ë¡œë“œì°½ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
        window.toggleFileInputs = () => { 
            const cat = document.getElementById('tplCategory').value;
            const groupData = document.getElementById('groupDataFile');
            
            // SVG íŒŒì¼ ì—…ë¡œë“œê°€ í•„ìš”í•œ ì¹´í…Œê³ ë¦¬ ëª©ë¡
            // vector: ë²¡í„° ë°°ê²½
            // transparent-graphic: íŒ¨í„´
            // logo: ë¡œê³ 
            // graphic: ê·¸ë˜í”½/ìŠ¤í‹°ì»¤ (í•„ìš”ì‹œ í¬í•¨)
            const needsVector = ['vector', 'transparent-graphic', 'logo', 'graphic'].includes(cat);

            if (needsVector) {
                groupData.style.display = 'block';
            } else {
                groupData.style.display = 'none'; // ì‚¬ì§„ ë°°ê²½ ë“±ì€ ìˆ¨ê¹€
            }
        };
        
        // [ì¶”ê°€] ì œí’ˆ í‚¤ ëª©ë¡ ë¡œë“œ (ë“±ë¡ í¼ & ê²€ìƒ‰ í•„í„° ë‘˜ ë‹¤ ì±„ì›€)
        window.loadProductKeys = async () => {
            const regSelect = document.getElementById('tplProductKey'); // ë“±ë¡ìš©
            const filterSelect = document.getElementById('filterTplProduct'); // ê²€ìƒ‰ í•„í„°ìš©
            
            if(!regSelect || !filterSelect) return;

            // ì´ˆê¸°í™”
            regSelect.innerHTML = '<option value="custom">ê³µí†µ / ì§€ì •ì•ˆí•¨</option>';
            // í•„í„°ëŠ” ê¸°ë³¸ ì˜µì…˜ ìœ ì§€í•˜ê³  ë’¤ì— ì¶”ê°€
            filterSelect.innerHTML = `
                <option value="all">ğŸ“¦ ì œí’ˆì—°ê²°: ì „ì²´ ë³´ê¸°</option>
                <option value="custom">ğŸ”¹ ê³µí†µ í…œí”Œë¦¿ë§Œ ë³´ê¸°</option>
                <option value="assigned">ğŸ”¸ ì œí’ˆ ì „ìš©ë§Œ ë³´ê¸°</option>
                <optgroup label="--- ê°œë³„ ì œí’ˆ ì„ íƒ ---"></optgroup>
            `;
            
            const { data: prods } = await sb.from('admin_products').select('code, name').order('name');
            if(prods) {
                prods.forEach(p => {
                    const optionHtml = `<option value="${p.code}">${p.name} (${p.code})</option>`;
                    regSelect.innerHTML += optionHtml;
                    filterSelect.innerHTML += optionHtml;
                });
            }
        };

        // [ìˆ˜ì •] í…œí”Œë¦¿ ë¡œë“œ (ì¹´í…Œê³ ë¦¬ + ì œí’ˆ í•„í„° ë™ì‹œ ì ìš©)
        window.loadTemplates = async () => { 
            const grid = document.getElementById('tplGrid'); 
            const catFilter = document.getElementById('filterTplCat').value; 
            const prodFilter = document.getElementById('filterTplProduct').value;

            if(!grid) return; 
            grid.innerHTML = '<div style="padding:20px; text-align:center;">ë¡œë”© ì¤‘...</div>'; 
            
            let query = sb.from('library')
                .select('id, category, thumb_url, tags, product_key')
                .order('id', {ascending:false})
                .limit(100); // ê°¯ìˆ˜ ëŠ˜ë¦¼

            // 1. ì¹´í…Œê³ ë¦¬ í•„í„°
            if (catFilter !== 'all') { 
                query = query.eq('category', catFilter); 
            } 

            // 2. ì œí’ˆ í‚¤ í•„í„°
            if (prodFilter === 'custom') {
                // ê³µí†µë§Œ (null ì´ê±°ë‚˜ 'custom')
                query = query.or('product_key.eq.custom,product_key.is.null');
            } else if (prodFilter === 'assigned') {
                // ì–´ë”˜ê°€ í• ë‹¹ëœ ê²ƒë§Œ (customì´ ì•„ë‹ˆê³  nullë„ ì•„ë‹Œ ê²ƒ)
                query = query.neq('product_key', 'custom').not('product_key', 'is', null);
            } else if (prodFilter !== 'all') {
                // íŠ¹ì • ì œí’ˆ ì½”ë“œ ì„ íƒ ì‹œ
                query = query.eq('product_key', prodFilter);
            }
            
            const { data, error } = await query; 
            
            grid.innerHTML = ''; 
            if (error) { 
                console.error(error); 
                grid.innerHTML = '<div style="padding:20px; color:red;">ì—ëŸ¬: ' + error.message + '</div>'; 
                return; 
            } 
            
            if (data && data.length > 0) { 
                data.forEach(t => { 
                    const tagText = t.tags ? t.tags : '-'; 
                    // ë±ƒì§€ í‘œì‹œ ë¡œì§
                    const pKey = (t.product_key && t.product_key !== 'custom') ? t.product_key : 'ê³µí†µ';
                    const isCustom = pKey === 'ê³µí†µ';
                    const badgeStyle = isCustom 
                        ? "background:#f1f5f9; color:#64748b;" 
                        : "background:#eff6ff; color:#2563eb; border:1px solid #bfdbfe;";

                    grid.innerHTML += `
                        <div class="tpl-card">
                            <img src="${t.thumb_url}" class="tpl-thumb" loading="lazy">
                            <div class="tpl-info">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                    <span class="tpl-badge" style="font-size:10px;">${t.category}</span>
                                    <span style="font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; ${badgeStyle}">${pKey}</span>
                                </div>
                                <div style="font-size:12px; font-weight:bold; color:#334155; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${tagText}</div>
                                <button class="tpl-del-btn" onclick="deleteTemplate(${t.id})">ì‚­ì œ</button>
                            </div>
                        </div>`; 
                }); 
            } else { 
                grid.innerHTML = '<div style="padding:40px; color:#999; text-align:center; width:100%;">ì¡°ê±´ì— ë§ëŠ” í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; 
            } 
        };
        
        // [ìˆ˜ì •] í…œí”Œë¦¿ ì—…ë¡œë“œ: product_key ì¶”ê°€ ì €ì¥
        window.uploadTemplate = async () => { 
            const cat = document.getElementById('tplCategory').value; 
            const tags = document.getElementById('tplTags').value; 
            const prodKey = document.getElementById('tplProductKey').value; // [ì¶”ê°€]
            const thumbFile = document.getElementById('fileThumb').files[0]; 
            const dataFile = document.getElementById('fileData').files[0]; 
            
            if (!thumbFile) return alert("ì¸ë„¤ì¼ ì´ë¯¸ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."); 
            const btn = document.querySelector('#sec-templates .btn-primary'); 
            const originalText = btn.innerText; 
            btn.innerText = "ì—…ë¡œë“œ ì¤‘..."; 
            btn.disabled = true; 
            
            try { 
                const timestamp = Date.now(); 
                const thumbPath = `thumbs/${timestamp}_${thumbFile.name}`; 
                const { error: thumbErr } = await sb.storage.from('design').upload(thumbPath, thumbFile); 
                if(thumbErr) throw thumbErr; 
                
                const { data: thumbUrlData } = sb.storage.from('design').getPublicUrl(thumbPath); 
                const thumbUrl = thumbUrlData.publicUrl; 
                let dataUrl = thumbUrl; 
                
                if ((cat === 'transparent-graphic' || cat === 'vector') && dataFile) { 
                    const dataPath = `assets/${timestamp}_${dataFile.name}`; 
                    const { error: dataErr } = await sb.storage.from('design').upload(dataPath, dataFile); 
                    if(dataErr) throw dataErr; 
                    const { data: dataUrlData } = sb.storage.from('design').getPublicUrl(dataPath); 
                    dataUrl = dataUrlData.publicUrl; 
                } 
                
                // product_key ì €ì¥
                const { error: dbErr } = await sb.from('library').insert({ 
                    category: cat, 
                    tags: tags || 'ê´€ë¦¬ìë“±ë¡', 
                    thumb_url: thumbUrl, 
                    data_url: dataUrl, 
                    width: 1000, 
                    height: 1000, 
                    product_key: prodKey // [ìˆ˜ì •]
                }); 
                
                if (dbErr) throw dbErr; 
                alert("âœ… í…œí”Œë¦¿ ë“±ë¡ ì„±ê³µ!"); 
                document.getElementById('tplTags').value = ''; 
                document.getElementById('fileThumb').value = ''; 
                document.getElementById('fileData').value = ''; 
                document.getElementById('previewThumb').style.display = 'none'; 
                document.getElementById('dataStatus').style.display = 'none'; 
                loadTemplates(); 
            } catch(e) { 
                alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message); 
                console.error(e); 
            } finally { 
                btn.innerText = originalText; 
                btn.disabled = false; 
            } 
        };
        
        window.deleteTemplate = async (id) => { if(confirm("ì‚­ì œ?")) await sb.from('library').delete().eq('id',id); loadTemplates(); };

        // ... (ë‚˜ë¨¸ì§€ ë¡œì§ ë™ì¼)

        // ==========================================
        // â˜… [ì‹ ê·œê¸°ëŠ¥] ì˜¤ëŠ˜ í• ì¼ (ë°°ì†¡ ê´€ë¦¬) ë¡œì§
        // ==========================================
        
        // 1. ë°°ì†¡ ì‹œê°„ ì˜µì…˜ ìƒì„± í•¨ìˆ˜ (08:00 ~ 24:00, 2ì‹œê°„ ê°„ê²©)
        function getDeliveryTimeOptions(selectedTime) {
            let html = '<option value="">ì‹œê°„ ë¯¸ì •</option>';
            for (let i = 8; i <= 24; i += 2) {
                // 24ì‹œëŠ” 00ì‹œ í˜¹ì€ 24ì‹œë¡œ í‘œê¸° (ì—¬ê¸°ì„  24:00)
                let timeStr = (i < 10 ? '0' + i : i) + ":00";
                let isSelected = selectedTime === timeStr ? 'selected' : '';
                html += `<option value="${timeStr}" ${isSelected}>${timeStr}</option>`;
            }
            return html;
        }

        // 2. ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ë©”ì¸ í•¨ìˆ˜
        window.loadDailyTasks = async () => {
            const dateInput = document.getElementById('taskDate');
            if (!dateInput.value) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
            }
            const targetDate = dateInput.value;
            const driverFilterId = document.getElementById('filterTaskDriver').value;

            showLoading(true);
            const tbody = document.getElementById('taskListBody');
            tbody.innerHTML = '';

            // 1. ìŠ¤íƒœí”„ ëª©ë¡ í™•ë³´ ë° í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
            if (staffList.length === 0) await fetchStaffForOrders();
            
            // í•„í„° ë“œë¡­ë‹¤ìš´ ê°±ì‹  (í•œ ë²ˆë§Œ ìˆ˜í–‰í•˜ê±°ë‚˜ ë§¤ë²ˆ ê°±ì‹ )
            const filterSelect = document.getElementById('filterTaskDriver');
            if(filterSelect.options.length === 1) { // 'ì „ì²´ë³´ê¸°'ë§Œ ìˆì„ ë•Œ ì±„ì›€
                staffList.filter(s => s.role === 'driver').forEach(s => {
                    filterSelect.innerHTML += `<option value="${s.id}">${s.name} ê¸°ì‚¬ë‹˜</option>`;
                });
            }

            // 2. í•´ë‹¹ ë‚ ì§œ ë°°ì†¡ ê±´ ì¡°íšŒ
            let { data: orders, error } = await sb.from('orders')
                .select('*')
                .eq('delivery_target_date', targetDate);

            if (error) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px;">ë¡œë“œ ì—ëŸ¬: ${error.message}</td></tr>`;
                showLoading(false);
                return;
            }

            if (!orders || orders.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:#999;">${targetDate} ë°°ì†¡ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                showLoading(false);
                return;
            }

            // 3. [ê¸°ëŠ¥] ê¸°ì‚¬ë³„ í•„í„°ë§
            if(driverFilterId !== 'all') {
                orders = orders.filter(o => o.staff_driver_id == driverFilterId);
            }
            if(orders.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:#999;">í•´ë‹¹ ê¸°ì‚¬ë‹˜ì˜ ë°°ì†¡ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                showLoading(false);
                return;
            }

            // 4. [ê¸°ëŠ¥] ì •ë ¬ (ê¸°ì‚¬ ì´ë¦„ìˆœ -> ì‹œê°„ìˆœ)
            orders.sort((a, b) => {
                // ê¸°ì‚¬ ì´ë¦„ ì°¾ê¸°
                const driverA = staffList.find(s=>s.id == a.staff_driver_id)?.name || 'zzz'; // ë¯¸ì§€ì •ì€ ë’¤ë¡œ
                const driverB = staffList.find(s=>s.id == b.staff_driver_id)?.name || 'zzz';
                
                if (driverA !== driverB) return driverA.localeCompare(driverB);
                
                // ê°™ì€ ê¸°ì‚¬ë©´ ì‹œê°„ìˆœ
                const timeA = a.delivery_time || "99:99";
                const timeB = b.delivery_time || "99:99";
                return timeA.localeCompare(timeB);
            });

            // 5. ë Œë”ë§
            orders.forEach(o => {
                const isDone = (o.status === 'ë°°ì†¡ì™„ë£Œ');
                
                // ì™„ë£Œ í‘œì‹œ (ì´ˆë¡ ë²„íŠ¼)
                const dotColor = isDone ? '#22c55e' : '#cbd5e1'; // ì´ˆë¡ vs íšŒìƒ‰
                const dotShadow = isDone ? '0 0 5px #4ade80' : 'none';
                
                // ìƒíƒœ ë±ƒì§€ (ì¤„ë°”ê¿ˆ ë°©ì§€)
                const statusBadge = isDone 
                    ? `<span class="badge" style="background:#dcfce7; color:#15803d; border:1px solid #bbf7d0; white-space:nowrap;">ë°°ì†¡ì™„ë£Œ</span>`
                    : `<span class="badge" style="background:#f1f5f9; color:#64748b; white-space:nowrap;">${o.status}</span>`;
                
                // ì™„ë£Œëœ ì¤„ ìŠ¤íƒ€ì¼
                const rowStyle = isDone ? 'background-color: #f0fdf4;' : '';
                const textStyle = isDone ? 'opacity: 0.6;' : '';

                // íŒŒì¼ ë§í¬
                let fileLinks = '';
                if(o.files && Array.isArray(o.files)) {
                    o.files.forEach(f => {
                         fileLinks += `<a href="${f.url}" target="_blank" class="btn-file" style="margin-right:4px;">ğŸ“„ ${f.name}</a>`;
                    });
                } else { fileLinks = '<span style="color:#ccc;">íŒŒì¼ ì—†ìŒ</span>'; }

                // ê¸°ì‚¬ ì„ íƒ
                let driverOpts = `<option value="">ë¯¸ì§€ì •</option>`;
                staffList.filter(s => s.role === 'driver').forEach(s => {
                    const selected = o.staff_driver_id == s.id ? 'selected' : '';
                    driverOpts += `<option value="${s.id}" ${selected}>${s.name}</option>`;
                });
                
                // ì‹œê°„ ì„ íƒ
                const timeOpts = getDeliveryTimeOptions(o.delivery_time);

                const tr = document.createElement('tr');
                tr.style.cssText = rowStyle;
                
                tr.innerHTML = `
                    <td style="text-align:center;">${statusBadge}</td>
                    <td style="${textStyle}">
                        <div style="font-weight:bold; font-size:15px;">${o.manager_name}</div>
                        <div style="font-size:13px; color:#6366f1;">${o.phone}</div>
                        <div style="font-size:12px; color:#666; margin-top:2px;">${o.address}</div>
                    </td>
                    <td style="${textStyle}"><div style="display:flex; flex-wrap:wrap;">${fileLinks}</div></td>
                    <td>
                        <select class="input-text" onchange="updateTaskDB('${o.id}', 'staff_driver_id', this.value)" style="width:100%; ${isDone ? 'background:transparent; border:none; font-weight:bold; appearance:none;' : ''}" ${isDone?'disabled':''}>
                            ${driverOpts}
                        </select>
                    </td>
                    <td>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <select class="input-text" onchange="updateTaskDB('${o.id}', 'delivery_time', this.value)" style="flex:1; font-weight:bold; color:#0f172a; ${isDone ? 'background:transparent; border:none; appearance:none;' : ''}" ${isDone?'disabled':''}>
                                ${timeOpts}
                            </select>
                            
                            <div title="${isDone ? 'ë°°ì†¡ ì™„ë£Œë¨' : 'ë°°ì†¡ ì¤‘'}" 
                                 style="width:18px; height:18px; border-radius:50%; background:${dotColor}; box-shadow:${dotShadow}; flex-shrink:0; cursor:default; border:2px solid white; outline:1px solid ${isDone?'#22c55e':'#cbd5e1'};">
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            showLoading(false);
        };

        // 3. ë°ì´í„° ì €ì¥(ì—…ë°ì´íŠ¸) í•¨ìˆ˜
        window.updateTaskDB = async (orderId, field, value) => {
            // valueê°€ ë¹ˆ ë¬¸ìì—´ì´ë©´ nullë¡œ ì²˜ë¦¬í•  ìˆ˜ë„ ìˆìŒ
            const valToSave = value === "" ? null : value;
            
            const { error } = await sb.from('orders').update({ [field]: valToSave }).eq('id', orderId);
            if (error) {
                alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
            } else {
                // ì„±ê³µ ì‹œ ë³„ë„ ì•Œë¦¼ ì—†ì´ ì¡°ìš©íˆ ì €ì¥ (UXìƒ ë¶€ë“œëŸ¬ì›€)
                // í•„ìš”í•˜ë‹¤ë©´ console.log("Saved");
            }
        };
        window.addEventListener('DOMContentLoaded', async () => { await initConfig(); loadOrders(); initTemplateListeners(); loadCategories(); loadFonts(); });
    </script>
    
</body>
</html>