<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chameleon Global Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Pretendard', sans-serif; background: #f1f5f9; color: #334155; overflow: hidden; }
        .sidebar { width: 260px; background: #1e293b; color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; }
        .sidebar-header { padding: 25px 20px; font-weight: 800; font-size: 20px; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 10px; color: #818cf8; }
        .nav-menu { list-style: none; padding: 20px 10px; margin: 0; display: flex; flex-direction: column; gap: 5px; }
        .nav-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 15px; color: #cbd5e1; }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: #6366f1; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .nav-label { font-size: 11px; color: #64748b; padding: 0 15px; margin-top: 15px; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; }
        
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 60px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .page-title { font-size: 18px; font-weight: 700; color: #0f172a; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 30px; }
        
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 20px; }
        
        /* ê³µí†µ í¼ ìŠ¤íƒ€ì¼ */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 5px; }
        .input-text { padding: 10px 15px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; font-size: 14px; box-sizing: border-box; }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-weight: 600; font-size: 13px; border-bottom: 1px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #334155; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-vip { background: #d97706; color: white; }
        .btn-danger { background: #fee2e2; color: #ef4444; }
        .btn-success { background: #22c55e; color: white; } /* ì„±ê³µ ì´ˆë¡ìƒ‰ */
        .btn-outline { background: #fff; border: 1px solid #cbd5e1; color: #334155; }
        .btn-file { background: #fff; color: #334155; border: 1px solid #cbd5e1; padding: 6px 10px; font-size: 12px; border-radius: 4px; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; cursor: pointer; margin-right: 5px; margin-bottom: 3px; }
        .btn-file:hover { border-color: #6366f1; color: #6366f1; }
        
        /* ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .badge.admin { background: #dbeafe; color: #1e40af; }
        .badge.customer { background: #f1f5f9; color: #475569; }
        
        /* êµ­ê°€ ë±ƒì§€ */
        .badge-site { font-size: 11px; padding: 3px 6px; border-radius: 4px; margin-right: 4px; font-weight: 800; border: 1px solid #e2e8f0; background: #fff; display: inline-block; min-width: 30px; text-align: center; }
        .badge-site.kr { color: #cf2e2e; border-color: #fecaca; background: #fef2f2; }
        .badge-site.jp { color: #ea580c; border-color: #ffedd5; background: #fff7ed; }
        .badge-site.us { color: #2563eb; border-color: #dbeafe; background: #eff6ff; }
        .badge-site.my { color: #d97706; border-color: #fef3c7; background: #fffbeb; }
        .badge-site.sg { color: #059669; border-color: #d1fae5; background: #ecfdf5; }

        /* íŒŒì¼ ì—…ë¡œë“œ ë“œë¡­ì¡´ */
        .file-drop-zone { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; position: relative; background: #f8fafc; color: #64748b; margin-bottom: 10px; }
        .file-drop-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .preview-img { max-width: 100%; height: 150px; object-fit: contain; border-radius: 8px; border: 1px solid #eee; display: none; margin-top: 10px; background: white; }

        /* í…œí”Œë¦¿ ê·¸ë¦¬ë“œ */
        .tpl-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .tpl-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; transition: 0.2s; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tpl-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: #6366f1; }
        .tpl-thumb { width: 100%; height: 150px; object-fit: contain; background: #f8fafc; border-bottom: 1px solid #f1f5f9; padding: 10px; }
        .tpl-info { padding: 12px; }
        .tpl-badge { font-size: 11px; background: #e0e7ff; color: #4338ca; padding: 3px 8px; border-radius: 4px; display: inline-block; margin-bottom: 6px; font-weight: bold; }
        .tpl-del-btn { width: 100%; margin-top: 8px; background: #fee2e2; color: #ef4444; font-size: 12px; padding: 6px; border-radius: 6px; border:none; cursor:pointer; font-weight: 600; }
        
        /* ë ˆì´ì•„ì›ƒ í—¬í¼ */
        .tpl-layout { display: flex; gap: 30px; align-items: flex-start; height: 100%; }
        .tpl-form { width: 320px; flex-shrink: 0; position: sticky; top: 0; background: #fff; padding: 0; }
        .tpl-grid-area { flex: 1; min-width: 0; }
        .product-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; align-items: start; }
        .addon-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; max-height: 150px; overflow-y: auto; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; }
        .addon-check-item { display: flex; align-items: center; gap: 5px; font-size: 13px; background: white; padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        .addon-check-item:hover { border-color: #6366f1; color: #6366f1; }
        .draggable-row { cursor: move; }
        .draggable-row.dragging { opacity: 0.5; background: #e2e8f0; }

        /* [ì¶”ê°€] ê²°ì œ ìƒíƒœ ë±ƒì§€ */
        .pay-badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; margin-bottom: 4px; }
        .pay-done { background: #dcfce7; color: #166534; }
        .pay-wait { background: #fee2e2; color: #991b1b; }
        
        /* [ì¶”ê°€] ë¡œë”© ì¸ë””ì¼€ì´í„° */
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.7); z-index: 99999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #6366f1; border-radius: 50%; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading"><div class="spinner"></div></div>

    <div class="sidebar">
        <div class="sidebar-header"><i class="fa-solid fa-earth-americas"></i> Global Admin</div>
        <ul class="nav-menu">
            <div class="nav-label">Business</div>
            <li class="nav-item active" onclick="showSection('sec-orders', this)">
                <i class="fa-solid fa-cart-shopping"></i> í†µí•© ì£¼ë¬¸ ê´€ë¦¬
            </li>
            <div class="nav-label">Product & Stock</div>
            <li class="nav-item" onclick="showSection('sec-products', this)">
                <i class="fa-solid fa-tags"></i> ìƒí’ˆ & ì˜µì…˜
            </li>
            <div class="nav-label">Assets</div>
            <li class="nav-item" onclick="showSection('sec-templates', this)">
                <i class="fa-solid fa-palette"></i> í…œí”Œë¦¿ & ë¡œê³ 
            </li>
             <li class="nav-item" onclick="showSection('sec-members', this)">
                <i class="fa-solid fa-users"></i> íšŒì› ê´€ë¦¬
            </li>
        </ul>
        <div style="margin-top: auto; padding: 20px;">
            <button class="btn btn-danger" style="width: 100%;" onclick="logout()">
                <i class="fa-solid fa-right-from-bracket"></i> ë¡œê·¸ì•„ì›ƒ
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="page-title">í†µí•© ì£¼ë¬¸ ê´€ë¦¬</div>
            <div style="font-size: 14px; color: #64748b;">Global Admin Connected ğŸŸ¢</div>
        </div>

        <div class="content-scroll">
            
            <div id="sec-orders" class="section active">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px;">
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-primary" id="btnFilterNew" onclick="filterOrders('ì ‘ìˆ˜ë¨', this)">
                                ğŸ“Œ ì‹ ê·œ ì ‘ìˆ˜ <span id="cnt-new" class="badge admin" style="background:#fff; color:#333; margin-left:5px;">0</span>
                            </button>
                            <button class="btn btn-outline" id="btnFilterKnife" onclick="filterOrders('ì¹¼ì„ ì‘ì—…', this)">
                                âœ‚ï¸ ì¹¼ì„ /ì œì‘ì‘ì—… <span id="cnt-work" class="badge admin" style="background:#f1f5f9; color:#333; margin-left:5px;">0</span>
                            </button>
                            <button class="btn btn-outline" id="btnFilterDone" onclick="filterOrders('ì™„ë£Œë¨', this)">
                                âœ… ì™„ë£Œ
                            </button>
                        </div>
                        
                        <div style="display:flex; gap:5px; align-items:center;">
                            <div id="action-buttons" style="display:flex; gap:5px; margin-right: 15px; border-right: 1px solid #ddd; padding-right: 15px;">
                                </div>

                            <select id="filterSite" class="input-text" style="width:130px; font-weight:bold;" onchange="loadOrders()">
                                <option value="all">ğŸŒ ì „ì²´ êµ­ê°€</option>
                                <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
                                <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option>
                                <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
                            </select>
                            <button class="btn btn-outline" onclick="loadOrders()"><i class="fa-solid fa-rotate"></i></button>
                        </div>
                    </div>

                    <table style="margin:0;">
                        <thead>
                            <tr>
                                <th style="width:40px;"><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></th>
                                <th style="width:80px;">Site</th>
                                <th style="width:100px;">ë‚ ì§œ</th>
                                <th style="width:120px;">ê³ ê°/ì—°ë½ì²˜</th>
                                <th>ì£¼ë¬¸ ë‚´ì—­ (ìƒí’ˆ/ì˜µì…˜/ìˆ˜ëŸ‰)</th>
                                <th>ì£¼ë¬¸ íŒŒì¼</th>
                                <th style="width:140px;">ê²°ì œ ì •ë³´</th>
                            </tr>
                        </thead>
                        <tbody id="orderListBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="sec-members" class="section">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <h3>ğŸ‘¥ íšŒì› ëª©ë¡ ë° ë“±ê¸‰ ê´€ë¦¬</h3>
                        <button class="btn btn-primary" onclick="loadMembers()"><i class="fa-solid fa-rotate"></i> ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <table>
                        <thead>
                            <tr><th>ê°€ì…ì¼</th><th>ì´ë©”ì¼</th><th>í˜„ì¬ ë“±ê¸‰</th><th>ë“±ê¸‰ ë³€ê²½</th></tr>
                        </thead>
                        <tbody id="memberListBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="sec-templates" class="section">
                 <div class="tpl-layout">
                    <div class="card tpl-form">
                        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“¤ í…œí”Œë¦¿ ë“±ë¡</h3>
                        <div class="form-group">
                            <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                            <select id="tplCategory" class="input-text" onchange="toggleFileInputs()">
                                <option value="transparent-graphic">ë¡œê³  (íˆ¬ëª…/SVG)</option>
                                <option value="vector">ë²¡í„° ë°°ê²½ (ì¼ëŸ¬ìŠ¤íŠ¸)</option>
                                <option value="photo-bg">ì‚¬ì§„ ë°°ê²½ (ì´ë¯¸ì§€)</option>
                                <option value="graphic">ê·¸ë˜í”½ ê°ì²´ (ì•„ì´ì½˜ ë“±)</option>
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label">ê²€ìƒ‰ì–´</label><input id="tplTags" class="input-text" placeholder="ì˜ˆ: ì‚¼ì„±, ë¡œê³ "></div>
                        <div class="form-group">
                            <label class="form-label" id="lblThumb">1. ì¸ë„¤ì¼ (í•„ìˆ˜)</label>
                            <div class="file-drop-zone"><input type="file" id="fileThumb" accept="image/*"><span>ì´ë¯¸ì§€ ì„ íƒ</span></div>
                            <img id="previewThumb" class="preview-img">
                        </div>
                        <div class="form-group" id="groupDataFile">
                            <label class="form-label">2. ë²¡í„° ë°ì´í„° (SVG)</label>
                            <div class="file-drop-zone"><input type="file" id="fileData" accept=".svg,.json"><span>SVG íŒŒì¼ ì„ íƒ</span></div>
                            <div id="dataStatus" style="font-size:12px; color:#16a34a; font-weight:bold; display:none;">âœ… ì›ë³¸ ì¤€ë¹„ë¨!</div>
                        </div>
                        <button class="btn btn-primary" style="width:100%;" onclick="uploadTemplate()">ë“±ë¡í•˜ê¸°</button>
                    </div>
                    <div class="tpl-grid-area">
                        <div class="card" style="margin-bottom:20px; padding:15px; display:flex; justify-content:space-between;">
                            <div style="display:flex; gap:10px; align-items:center;">
                                <span>í•„í„°:</span>
                                <select id="filterTplCat" class="input-text" style="width:150px;" onchange="loadTemplates()">
                                    <option value="all">ì „ì²´ ë³´ê¸°</option>
                                    <option value="transparent-graphic">ë¡œê³ </option>
                                    <option value="vector">ë°°ê²½</option>
                                    <option value="photo-bg">ì‚¬ì§„</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="loadTemplates()">ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                        <div id="tplGrid" class="tpl-card-grid"></div>
                    </div>
                </div>
            </div>

            <div id="sec-products" class="section">
                 <div class="card" style="background:#f0f9ff; border:1px solid #bae6fd; margin-bottom:20px;">
                    <h3 style="margin-top:0; color:#0369a1;">0ï¸âƒ£ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ (í´ë” ìë™ ìƒì„±)</h3>
                    <div style="display:flex; gap:10px; align-items:flex-end;">
                        <div style="flex:1;">
                            <label class="form-label">ì¹´í…Œê³ ë¦¬ ëª… (í•œê¸€)</label>
                            <input id="newCatName" class="input-text" placeholder="ì˜ˆ: í—ˆë‹ˆì½¤ë³´ë“œ">
                        </div>
                        <div style="flex:1;">
                            <label class="form-label">í´ë” ì½”ë“œ (ì˜ë¬¸)</label>
                            <input id="newCatCode" class="input-text" placeholder="ì˜ˆ: honeycomb">
                        </div>
                        <button class="btn btn-primary" onclick="addCategoryDB()">ì¹´í…Œê³ ë¦¬ ìƒì„±</button>
                    </div>
                    <div style="margin-top:15px; border-top:1px solid #bae6fd; padding-top:10px;">
                        <span style="font-size:12px; font-weight:bold; color:#0369a1;">í˜„ì¬ ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬:</span>
                        <div id="categoryListArea" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:5px;"></div>
                    </div>
                </div>

                <div class="product-layout">
                    <div class="card product-form">
                        <h3 style="margin-top:0;">2ï¸âƒ£ ìƒí’ˆ ë“±ë¡ (Product)</h3>
                        <div class="form-group" style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                            <label class="form-label">ğŸŒ íŒë§¤ êµ­ê°€ (Site Code)</label>
                            <select id="newProdSite" class="input-text" style="font-weight:bold; color:#6366f1;">
                                <option value="KR" selected>ğŸ‡°ğŸ‡· í•œêµ­ (Korea)</option>
                                <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸ (Japan)</option>
                                <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ (USA)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
                            <select id="newProdCategory" class="input-text"><option value="">ë¡œë”© ì¤‘...</option></select>
                        </div>
                        <div class="form-group"><label class="form-label">ìƒí’ˆì½”ë“œ (ê³ ìœ ê°’)</label><input id="newProdCode" class="input-text" placeholder="Wall_1_KR"></div>
                        <div class="form-group"><label class="form-label">ìƒí’ˆëª… (í•´ë‹¹ ì–¸ì–´)</label><input id="newProdName" class="input-text" placeholder="ê°€ë²½ 1ì¹¸"></div>
                        <div style="display:flex; gap:10px;">
                            <div class="form-group" style="flex:1;"><label class="form-label">ê°€ë¡œ(mm)</label><input id="newProdW" type="number" class="input-text"></div>
                            <div class="form-group" style="flex:1;"><label class="form-label">ì„¸ë¡œ(mm)</label><input id="newProdH" type="number" class="input-text"></div>
                        </div>
                        <div class="form-group"><label class="form-label">ê°€ê²© (í•´ë‹¹ í†µí™”)</label><input id="newProdPrice" type="number" class="input-text" placeholder="ì˜ˆ: 150000"></div>
                        <div class="form-group">
                            <label class="form-label">ìƒí’ˆ ì´ë¯¸ì§€</label>
                            <div class="file-drop-zone" style="padding:10px;"><input type="file" id="newProdFile" accept="image/*" onchange="previewProductImage(this)"><span>í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</span></div>
                            <input id="newProdImg" class="input-text" placeholder="URL ìë™ ì…ë ¥ë¨" style="margin-top:5px;">
                            <img id="prodPreview" class="preview-img">
                        </div>
                        <div class="form-group"><label class="form-label">ì˜µì…˜ ì—°ê²°</label><div id="addonCheckboxArea" class="addon-checkbox-group"></div></div>
                        <button id="btnProductSave" class="btn btn-primary" style="width:100%;" onclick="addProductDB()">ìƒí’ˆ ë“±ë¡í•˜ê¸°</button>
                        <div style="margin-top:10px; display:flex; gap:5px;">
                            <button id="btnProductClone" class="btn btn-vip" style="flex:1; display:none;" onclick="cloneProduct()">ğŸ“‹ ë³µì œí•˜ê¸°</button>
                            <button id="btnCancelEdit" class="btn btn-outline" style="flex:1; display:none;" onclick="resetProductForm()">ì·¨ì†Œ</button>
                        </div>
                    </div>

                    <div class="product-grid-area">
                        <div class="card" style="margin-bottom:20px;">
                            <h3>1ï¸âƒ£ ì˜µì…˜ ë“±ë¡ (ê³µí†µ ì‚¬ìš©)</h3>
                            <div style="display:flex; gap:10px; align-items:flex-end;">
                                <div style="width:120px;">
                                    <label class="form-label">ì¢…ë¥˜</label>
                                    <select id="newAddonCat" class="input-text">
                                        <option value="material">1. ì¬ì§ˆ/ë‘ê»˜</option>
                                        <option value="finish">2. ë§ˆê°ë°©ì‹</option> <option value="addon" selected>3. ì¶”ê°€ìƒí’ˆ</option>
                                    </select>
                                </div>
                                <div style="flex:1;"><label class="form-label">ì½”ë“œ</label><input id="newAddonCode" class="input-text"></div>
                                <div style="flex:1;"><label class="form-label">ëª…ì¹­</label><input id="newAddonName" class="input-text"></div>
                                <div style="width:100px;"><label class="form-label">ê°€ê²©</label><input id="newAddonPrice" type="number" class="input-text" placeholder="0"></div>
                                <button class="btn btn-primary" onclick="addAddonDB()">ì €ì¥</button>
                            </div>
                            <div style="margin-top:10px; max-height:150px; overflow-y:auto; border-top:1px solid #eee;"><table style="font-size:12px;"><tbody id="addonTableBody"></tbody></table></div>
                        </div>

                        <div class="card">
                            <h3>ğŸ“œ ìƒí’ˆ ëª©ë¡ (êµ­ê°€ë³„ í•„í„°ë§)</h3>
                            <div style="margin-bottom:10px;">
                                í•„í„°: <select onchange="filterProductList(this.value)" class="input-text" style="width:150px; display:inline-block;">
                                    <option value="all">ì „ì²´ ë³´ê¸°</option>
                                    <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
                                    <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option>
                                    <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
                                </select>
                            </div>
                            <table>
                                <thead><tr><th width="50">êµ­ê°€</th><th width="60">ì´ë¯¸ì§€</th><th>ì½”ë“œ/ìƒí’ˆëª…</th><th>ì‚¬ì´ì¦ˆ</th><th>ê°€ê²©</th><th width="120">ê´€ë¦¬</th></tr></thead>
                                <tbody id="prodTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { sb, initConfig } from "./config.js";

        // ì „ì—­ ë³€ìˆ˜
        let currentOrderStatus = 'ì ‘ìˆ˜ë¨'; // ì ‘ìˆ˜ë¨, ì¹¼ì„ ì‘ì—…, ì™„ë£Œë¨
        let allOrders = [];
        let editingProdId = null;
        let allProducts = [];

        window.showSection = (secId, navEl) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(secId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(navEl) navEl.classList.add('active');
            
            if(secId === 'sec-orders') loadOrders();
            if(secId === 'sec-members') loadMembers();
            if(secId === 'sec-templates') loadTemplates();
            if(secId === 'sec-products') { loadCategories(); loadSystemDB(); }
        };

        window.logout = async () => { if(confirm("ë¡œê·¸ì•„ì›ƒ?")) { await sb.auth.signOut(); location.href = "index.html"; } };
        window.closeModal = (id) => document.getElementById(id).style.display='none';
        function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

        // ============================================
        // 1. ì£¼ë¬¸ ê´€ë¦¬ (í•µì‹¬ ê¸°ëŠ¥)
        // ============================================
        window.filterOrders = (status, btn) => {
            currentOrderStatus = status; // íƒ­ ë³€ê²½
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼
            document.querySelectorAll('#sec-orders .btn-primary').forEach(b => { b.classList.remove('btn-primary'); b.classList.add('btn-outline'); });
            if(btn) { btn.classList.remove('btn-outline'); btn.classList.add('btn-primary'); }
            
            // ìƒíƒœì— ë”°ë¥¸ ì•¡ì…˜ ë²„íŠ¼ UI ì—…ë°ì´íŠ¸
            updateActionButtons();
            
            loadOrders();
        };

        function updateActionButtons() {
            const btnGroup = document.getElementById('action-buttons');
            btnGroup.innerHTML = ""; // ì´ˆê¸°í™”

            // (1) ì‹ ê·œ ì ‘ìˆ˜ (ì²´í¬ë°•ìŠ¤ -> ì‘ì—…ì‹œì‘, ì‚­ì œ)
            if (currentOrderStatus === 'ì ‘ìˆ˜ë¨') {
                btnGroup.innerHTML = `
                    <button class="btn btn-primary" onclick="changeStatusSelected('ì¹¼ì„ ì‘ì—…')">
                        <i class="fa-solid fa-play"></i> ì„ íƒ ì‘ì—…ì‹œì‘
                    </button>
                    <button class="btn btn-danger" onclick="deleteOrdersSelected(false)">
                        <i class="fa-solid fa-trash"></i> ì„ íƒ ì‚­ì œ
                    </button>
                `;
            } 
            // (2) ì¹¼ì„  ì‘ì—…ë°© (ì¼ê´„ë‹¤ìš´ë¡œë“œ, ì™„ë£Œì²˜ë¦¬)
            else if (currentOrderStatus === 'ì¹¼ì„ ì‘ì—…') {
                btnGroup.innerHTML = `
                    <button class="btn btn-success" style="background:#0ea5e9; color:white;" onclick="downloadBulkFiles()">
                        <i class="fa-solid fa-folder-open"></i> ì„ íƒ ì¼ê´„ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button class="btn btn-vip" onclick="changeStatusSelected('ì™„ë£Œë¨')">
                        <i class="fa-solid fa-check"></i> ì„ íƒ ì™„ë£Œì²˜ë¦¬
                    </button>
                `;
            } 
            // (3) ì™„ë£Œ (ì˜êµ¬ì‚­ì œ)
            else if (currentOrderStatus === 'ì™„ë£Œë¨') {
                btnGroup.innerHTML = `
                    <button class="btn btn-danger" onclick="deleteOrdersSelected(true)">
                        <i class="fa-solid fa-ban"></i> ì„ íƒ ì˜êµ¬ì‚­ì œ
                    </button>
                `;
            }
        }

        window.loadOrders = async () => {
            showLoading(true);
            const siteFilter = document.getElementById('filterSite').value;
            
            // í•„í„°ë§ ì¿¼ë¦¬
            let query = sb.from('orders').select('*').order('created_at', {ascending:false});
            
            // ìƒíƒœ í•„í„°ë§ (ë‹¤ì¤‘ ìƒíƒœ ì²˜ë¦¬)
            if (currentOrderStatus === 'ì ‘ìˆ˜ë¨') {
                query = query.in('status', ['ì ‘ìˆ˜ë¨', 'íŒŒì¼ì²˜ë¦¬ì¤‘']); // ì‹ ê·œ
            } else if (currentOrderStatus === 'ì¹¼ì„ ì‘ì—…') {
                query = query.eq('status', 'ì¹¼ì„ ì‘ì—…'); // ì œì‘ì¤‘
            } else if (currentOrderStatus === 'ì™„ë£Œë¨') {
                query = query.in('status', ['ì™„ë£Œë¨', 'ë°œì†¡ì™„ë£Œ', 'ì™„ë£Œ']); // ì™„ë£Œ
            }

            const { data, error } = await query;
            
            // ë±ƒì§€ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ (ì „ì²´ ë°ì´í„°ë¥¼ ë”°ë¡œ ê°€ì ¸ì˜¤ì§„ ì•Šê³  í˜„ì¬ í™”ë©´ ê¸°ì¤€ìœ¼ë¡œë§Œ í‘œì‹œí•˜ê±°ë‚˜ ë³„ë„ ì¿¼ë¦¬ í•„ìš”)
            // ì—¬ê¸°ì„  ê°„ë‹¨íˆ íŒ¨ìŠ¤ í˜¹ì€ ì¶”í›„ êµ¬í˜„

            const tbody = document.getElementById('orderListBody');
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; 
                showLoading(false);
                return; 
            }
            
            const filteredData = siteFilter === 'all' ? data : data.filter(o => (o.site_code || 'KR') === siteFilter);
            allOrders = filteredData; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ì²´í¬ë°•ìŠ¤ìš©)

            filteredData.forEach(order => {
                const site = order.site_code || 'KR'; 
                const siteBadge = `<span class="badge-site ${site.toLowerCase()}">${site}</span>`;
                
                // íŒŒì¼ ë²„íŠ¼ ìƒì„±
                let fileBtns = ''; 
                if(order.files) {
                    order.files.forEach(f => { 
                        fileBtns += `<a href="${f.url}" target="_blank" class="btn-file" title="${f.name}">
                            <i class="fa-solid fa-file"></i> ${f.name}
                        </a>`; 
                    });
                } else {
                    fileBtns = '<span style="color:#ccc; font-size:12px;">íŒŒì¼ ì—†ìŒ</span>';
                }

                // ê²°ì œ ë±ƒì§€
                let payBadge = `<span class="pay-badge pay-wait">ë¯¸ê²°ì œ</span>`;
                if (order.payment_status === 'paid' || order.payment_status === 'ê²°ì œì™„ë£Œ') {
                    payBadge = `<span class="pay-badge pay-done">ê²°ì œì™„ë£Œ</span>`;
                }

                // ì²´í¬ë°•ìŠ¤ìš© ë°ì´í„°
                const filesJson = order.files ? JSON.stringify(order.files).replace(/"/g, '&quot;') : '[]';

                tbody.innerHTML += `
                    <tr>
                        <td><input type="checkbox" class="row-chk" value="${order.id}" data-manager="${order.manager_name}" data-files="${filesJson}"></td>
                        <td>${siteBadge}</td>
                        <td>${new Date(order.created_at).toLocaleDateString()}<br><small style="color:#888;">${new Date(order.created_at).toLocaleTimeString()}</small></td>
                        <td>
                            <b>${order.manager_name}</b><br>
                            <span style="font-size:12px; color:#666;">${order.phone}</span>
                        </td>
                        <td>
                            ${(order.items || []).map(i => `<div>- ${i.product ? i.product.name : 'ìƒí’ˆ'} (${i.qty}ê°œ)</div>`).join('')}
                            <div style="font-size:12px; color:#888; margin-top:5px; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${order.request_note || ''}</div>
                        </td>
                        <td>${fileBtns}</td>
                        <td>
                            <div style="font-size:12px; margin-bottom:3px;">${order.payment_method || 'ê³„ì¢Œì´ì²´'}</div>
                            ${payBadge}
                            ${(order.payment_status !== 'paid') ? `<button class="btn btn-outline" style="font-size:10px; padding:2px 5px; margin-top:3px;" onclick="confirmPayment('${order.id}')">ì…ê¸ˆí™•ì¸</button>` : ''}
                        </td>
                    </tr>
                `;
            });
            showLoading(false);
        };

        // ì²´í¬ë°•ìŠ¤ ì „ì²´ ì„ íƒ
        window.toggleAll = (source) => {
            document.querySelectorAll('.row-chk').forEach(el => el.checked = source.checked);
        };

        // [ê¸°ëŠ¥ 1, 4] ìƒíƒœ ë³€ê²½ ë° ì‚­ì œ
        window.changeStatusSelected = async (newStatus) => {
            const checks = document.querySelectorAll('.row-chk:checked');
            if (checks.length === 0) return alert("ì„ íƒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");
            if (!confirm(`ì„ íƒí•œ ${checks.length}ê±´ì„ '${newStatus}' ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const ids = Array.from(checks).map(c => c.value);
            const { error } = await sb.from('orders').update({ status: newStatus }).in('id', ids);
            if (error) alert("ì˜¤ë¥˜: " + error.message);
            else loadOrders();
        };

        window.deleteOrdersSelected = async (isPermanent) => {
            const checks = document.querySelectorAll('.row-chk:checked');
            if (checks.length === 0) return alert("ì‚­ì œí•  ì£¼ë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            
            const msg = isPermanent ? "ì •ë§ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)" : "ì£¼ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
            if (!confirm(msg)) return;

            const ids = Array.from(checks).map(c => c.value);
            const { error } = await sb.from('orders').delete().in('id', ids);
            if (error) alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
            else loadOrders();
        };

        // [ê¸°ëŠ¥ 3] ì¼ê´„ ë‹¤ìš´ë¡œë“œ (íŒŒì¼ëª…ì— ê³ ê°ëª… í¬í•¨)
        window.downloadBulkFiles = async () => {
            const checks = document.querySelectorAll('.row-chk:checked');
            if (checks.length === 0) return alert("ë‹¤ìš´ë¡œë“œí•  ì£¼ë¬¸ì„ ì„ íƒí•˜ì„¸ìš”.");

            try {
                // í¬ë¡¬/ì—£ì§€ ì „ìš© í´ë” ì„ íƒ API
                const dirHandle = await window.showDirectoryPicker();
                showLoading(true);

                let count = 0;
                for (const chk of checks) {
                    const manager = chk.dataset.manager || 'ê³ ê°';
                    const files = JSON.parse(chk.dataset.files || '[]');
                    
                    for (const file of files) {
                        // [ê¸°ëŠ¥ 2] íŒŒì¼ëª…ì— ê³ ê°ëª… ê°•ì œ í¬í•¨ (ì˜ˆ: í™ê¸¸ë™_ê²¬ì ì„œ.pdf)
                        // íŠ¹ìˆ˜ë¬¸ì ì œê±° í›„ íŒŒì¼ëª… ì¡°í•©
                        const safeManager = manager.replace(/[\/\\]/g, '_');
                        const safeFileName = file.name.replace(/[\/\\]/g, '_');
                        const saveName = `${safeManager}_${safeFileName}`;

                        try {
                            const response = await fetch(file.url);
                            const blob = await response.blob();
                            
                            // íŒŒì¼ ìƒì„± ë° ì“°ê¸°
                            const fileHandle = await dirHandle.getFileHandle(saveName, { create: true });
                            const writable = await fileHandle.createWritable();
                            await writable.write(blob);
                            await writable.close();
                            count++;
                        } catch (e) {
                            console.error("ê°œë³„ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨", e);
                        }
                    }
                }
                alert(`${count}ê°œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!`);
            } catch (e) {
                if(e.name !== 'AbortError') alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” í´ë” ì €ì¥ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (í¬ë¡¬/ì—£ì§€ ì‚¬ìš© ê¶Œì¥)");
            } finally {
                showLoading(false);
            }
        };

        // [ê¸°ëŠ¥ 5] ì…ê¸ˆ í™•ì¸ ì²˜ë¦¬
        window.confirmPayment = async (id) => {
            if(!confirm("ì…ê¸ˆ í™•ì¸ ì²˜ë¦¬ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê²°ì œì™„ë£Œë¡œ ë³€ê²½)")) return;
            const { error } = await sb.from('orders').update({ payment_status: 'paid' }).eq('id', id);
            if(error) alert("ì˜¤ë¥˜ ë°œìƒ");
            else loadOrders();
        };


        // ============================================
        // 2. ê¸°íƒ€ ê´€ë¦¬ (íšŒì›, í…œí”Œë¦¿, ìƒí’ˆ - ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
        // ============================================
        window.addEventListener('DOMContentLoaded', async () => {
            await initConfig();
            loadOrders(); 
            initTemplateListeners(); 
            loadCategories(); 
        });

        // (ì´í•˜ ê¸°ì¡´ ì¹´í…Œê³ ë¦¬, ìƒí’ˆ, í…œí”Œë¦¿ ë¡œì§ ë™ì¼ ìœ ì§€)
        window.loadCategories = async () => {
            const { data } = await sb.from('admin_categories').select('*').order('id');
            const selectBox = document.getElementById('newProdCategory');
            const listArea = document.getElementById('categoryListArea');
            selectBox.innerHTML = '<option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            listArea.innerHTML = '';
            if (data) {
                data.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.code; option.innerText = cat.name;
                    selectBox.appendChild(option);
                    listArea.innerHTML += `<span class="badge" style="border:1px solid #bae6fd; color:#0284c7; margin-right:5px; margin-bottom:5px; display:inline-block;"><b>${cat.name}</b> (${cat.code}) <i class="fa-solid fa-xmark" style="cursor:pointer; color:red; margin-left:5px;" onclick="deleteCategory(${cat.id})"></i></span>`;
                });
            }
        };
        window.addCategoryDB = async () => {
             const name = document.getElementById('newCatName').value; const code = document.getElementById('newCatCode').value;
             if (!name || !code) return alert("ì…ë ¥ í™•ì¸");
             const { error } = await sb.from('admin_categories').insert([{ name, code: code.toLowerCase().replace(/\s/g, '_') }]);
             if(error) alert("ì¹´í…Œê³ ë¦¬ ìƒì„± ì‹¤íŒ¨: " + error.message);
             else { alert("ì¹´í…Œê³ ë¦¬ ìƒì„± ì™„ë£Œ"); loadCategories(); }
        };
        window.deleteCategory = async (id) => { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await sb.from('admin_categories').delete().eq('id', id); loadCategories(); } };

        // íšŒì› ê´€ë¦¬
        window.loadMembers = async () => {
            const tbody = document.getElementById('memberListBody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ë¡œë”©ì¤‘...</td></tr>';
            const { data, error } = await sb.from('profiles').select('*').order('created_at', {ascending:false});
            tbody.innerHTML = '';
            if(!data || data.length === 0) return tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">íšŒì› ì—†ìŒ</td></tr>';
            const badgeMap = { 'customer': 'badge customer', 'vip': 'badge vip', 'franchise': 'badge franchise', 'admin': 'badge admin' };
            data.forEach(m => {
                const r = m.role || 'customer';
                const selectBox = `<select onchange="updateMemberRole('${m.id}', this.value)" style="padding:6px; border:1px solid #cbd5e1; border-radius:4px; font-size:13px; cursor:pointer;"><option value="customer" ${r==='customer'?'selected':''}>ì¼ë°˜íšŒì›</option><option value="vip" ${r==='vip'?'selected':''}>ğŸ‘‘ VIP</option><option value="franchise" ${r==='franchise'?'selected':''}>ğŸ¢ ê°€ë§¹ì </option><option value="admin" ${r==='admin'?'selected':''}>ğŸ›  ê´€ë¦¬ì</option></select>`;
                tbody.innerHTML += `<tr><td>${new Date(m.created_at).toLocaleDateString()}</td><td>${m.email}</td><td><span class="${badgeMap[r] || 'badge'}">${r.toUpperCase()}</span></td><td>${selectBox}</td></tr>`;
            });
        };
        window.updateMemberRole = async (id, newRole) => {
            if(!confirm(`ë“±ê¸‰ì„ [${newRole}]ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { loadMembers(); return; }
            const { error } = await sb.from('profiles').update({role: newRole}).eq('id', id);
            if(error) alert("ì‹¤íŒ¨: " + error.message); else { alert("ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); loadMembers(); }
        };

        // í…œí”Œë¦¿ ë° ìƒí’ˆ ê´€ë¦¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        let tplThumbData = null; let tplPayload = null; 
        function initTemplateListeners() {
            document.getElementById('fileThumb').addEventListener('change', (e) => { const file = e.target.files[0]; if(!file) return; const r = new FileReader(); r.onload=(ev)=>{ tplThumbData=ev.target.result; document.getElementById('previewThumb').src=tplThumbData; document.getElementById('previewThumb').style.display='block'; }; r.readAsDataURL(file); });
            document.getElementById('fileData').addEventListener('change', (e) => { const file = e.target.files[0]; if(!file) return; const r = new FileReader(); r.onload=(ev)=>{ if(file.name.endsWith('.svg')) { tplPayload = ev.target.result; document.getElementById('dataStatus').style.display='block'; } }; r.readAsDataURL(file); });
        }
        window.toggleFileInputs = () => { const cat = document.getElementById('tplCategory').value; const groupData = document.getElementById('groupDataFile'); const lblThumb = document.getElementById('lblThumb'); if(cat === 'transparent-graphic') { groupData.style.display = 'block'; lblThumb.innerText = "1. ë¯¸ë¦¬ë³´ê¸°ìš© ì´ë¯¸ì§€ (ì„ íƒì‚¬í•­)"; } else { groupData.style.display = 'none'; lblThumb.innerText = "1. í…œí”Œë¦¿ ì´ë¯¸ì§€ (í•„ìˆ˜)"; } };
        window.loadTemplates = async () => {
            const grid = document.getElementById('tplGrid'); const cat = document.getElementById('filterTplCat').value; grid.innerHTML = 'ë¡œë”© ì¤‘...';
            let query = sb.from('library').select('id, category, thumb_url, tags').order('created_at', {ascending:false});
            if(cat !== 'all') query = query.eq('category', cat);
            const {data, error} = await query;
            grid.innerHTML = '';
            if(data) { data.forEach(item => { grid.innerHTML += `<div class="tpl-card"><img src="${item.thumb_url}" class="tpl-thumb"><div class="tpl-info"><span class="tpl-badge">${item.category}</span><div style="font-size:12px; font-weight:bold;">${item.tags||'-'}</div><button class="tpl-del-btn" onclick="deleteTemplate(${item.id})">ì‚­ì œ</button></div></div>`; }); }
        };
        window.uploadTemplate = async () => {
             const btn = document.querySelector('.tpl-form button.btn-primary'); const originalText = btn.innerText;
             const cat = document.getElementById('tplCategory').value; const tags = document.getElementById('tplTags').value; const thumbFile = document.getElementById('fileThumb').files[0]; const dataFile = document.getElementById('fileData').files[0];
             if (!thumbFile) return alert("ì¸ë„¤ì¼ ì´ë¯¸ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
             try {
                btn.innerText = "ì—…ë¡œë“œ ì¤‘..."; btn.disabled = true;
                const timestamp = Date.now(); let thumbUrl = ''; let dataUrl = '';
                const thumbPath = `thumbs/${timestamp}_thumb_${Math.floor(Math.random()*1000)}`;
                const { data: tData, error: tErr } = await sb.storage.from('design').upload(thumbPath, thumbFile);
                if (tErr) throw tErr;
                const { data: tUrlData } = sb.storage.from('design').getPublicUrl(thumbPath); thumbUrl = tUrlData.publicUrl;
                if (cat === 'transparent-graphic' || cat === 'vector') {
                    if (dataFile) { dataUrl = await new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => resolve(e.target.result); reader.onerror = reject; reader.readAsDataURL(dataFile); }); } else { dataUrl = thumbUrl; }
                } else {
                    if (dataFile) { const dataPath = `assets/${timestamp}_data_${Math.floor(Math.random()*1000)}`; const { error: dErr } = await sb.storage.from('design').upload(dataPath, dataFile); if (dErr) throw dErr; const { data: dUrlData } = sb.storage.from('design').getPublicUrl(dataPath); dataUrl = dUrlData.publicUrl; } else { dataUrl = thumbUrl; }
                }
                const { error: dbErr } = await sb.from('library').insert({ category: cat, tags: tags || 'ê´€ë¦¬ìë“±ë¡', thumb_url: thumbUrl, data_url: dataUrl, width: 1000, height: 1000, product_key: 'admin_upload', created_at: new Date().toISOString() });
                if (dbErr) throw dbErr; alert("âœ… í…œí”Œë¦¿ ë“±ë¡ ì„±ê³µ!"); loadTemplates();
             } catch (e) { alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message); } finally { btn.innerText = originalText; btn.disabled = false; }
        };
        window.deleteTemplate = async (id) => { if(confirm("ì‚­ì œ?")) { await sb.from('library').delete().eq('id',id); loadTemplates(); }};

        window.loadSystemDB = async () => {
            const { data: addons } = await sb.from('admin_addons').select('*').order('category');
            const addonBody = document.getElementById('addonTableBody');
            const chkArea = document.getElementById('addonCheckboxArea');
            addonBody.innerHTML = ''; chkArea.innerHTML = '';
            if(addons) {
                addons.forEach(item => {
                    const color = item.category==='material'?'#16a34a':(item.category==='finish'?'#2563eb':'#d97706');
                    addonBody.innerHTML += `<tr><td><span style="color:${color}">${item.category}</span></td><td><b>${item.code}</b></td><td>${item.name}</td><td>${item.price}</td><td><button class="btn btn-danger btn-sm" onclick="deleteSystemData('admin_addons',${item.id})">x</button></td></tr>`;
                    chkArea.innerHTML += `<label class="addon-check-item"><span style="color:${color}">â—</span> <input type="checkbox" name="prodAddon" value="${item.code}"> ${item.name}</label>`;
                });
            }
            const { data: prods } = await sb.from('admin_products').select('*').order('sort_order').order('id');
            allProducts = prods || [];
            renderProductList(allProducts);
        };

        window.renderProductList = (products) => {
            const prodBody = document.getElementById('prodTableBody');
            prodBody.innerHTML = '';
            if (!products) return;
            products.forEach((item, idx) => {
                const site = item.site_code || 'KR';
                const tr = document.createElement('tr');
                tr.className = 'draggable-row';
                tr.draggable = true;
                tr.dataset.id = item.id;
                tr.innerHTML = `
                    <td><span class="badge-site ${site.toLowerCase()}">${site}</span></td>
                    <td><img src="${item.img_url}" style="width:40px; height:40px; object-fit:cover; border-radius:4px;"></td>
                    <td><b style="color:#6366f1;">${item.code}</b><br>${item.name}</td>
                    <td>${item.width_mm}x${item.height_mm}</td>
                    <td>${item.price.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-outline" style="padding:4px 8px; font-size:11px;" onclick="editProductLoad(${item.id})">ìˆ˜ì •</button>
                        <button class="btn btn-danger" style="padding:4px 8px; font-size:11px;" onclick="deleteSystemData('admin_products', ${item.id})">ì‚­ì œ</button>
                    </td>
                `;
                addDragListeners(tr);
                prodBody.appendChild(tr);
            });
        };
        window.filterProductList = (site) => {
            if (site === 'all') renderProductList(allProducts);
            else renderProductList(allProducts.filter(p => (p.site_code||'KR') === site));
        };
        window.addProductDB = async () => {
            const site = document.getElementById('newProdSite').value;
            const category = document.getElementById('newProdCategory').value;
            const code = document.getElementById('newProdCode').value;
            const name = document.getElementById('newProdName').value;
            const w = document.getElementById('newProdW').value;
            const h = document.getElementById('newProdH').value;
            const price = document.getElementById('newProdPrice').value;
            const img = document.getElementById('newProdImg').value;
            if(!code || !name) return alert("í•„ìˆ˜ í•­ëª©(ì½”ë“œ, ìƒí’ˆëª…)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            const selectedAddons = Array.from(document.querySelectorAll('input[name="prodAddon"]:checked')).map(cb => cb.value);
            const payload = { site_code: site, category, code, name, width_mm: parseInt(w||0), height_mm: parseInt(h||0), price: parseInt(price||0), img_url: img, addons: selectedAddons.join(',') };
            let result;
            if(editingProdId) { result = await sb.from('admin_products').update(payload).eq('id', editingProdId); } 
            else { result = await sb.from('admin_products').insert([payload]); }
            if (result.error) { alert("âŒ ì €ì¥ ì‹¤íŒ¨: " + result.error.message); return; }
            alert("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!"); resetProductForm(); loadSystemDB();
        };
        window.editProductLoad = async (id) => {
            const { data } = await sb.from('admin_products').select('*').eq('id', id).single();
            if(!data) return;
            editingProdId = id;
            document.getElementById('newProdSite').value = data.site_code || 'KR';
            document.getElementById('newProdCategory').value = data.category;
            document.getElementById('newProdCode').value = data.code;
            document.getElementById('newProdName').value = data.name;
            document.getElementById('newProdW').value = data.width_mm;
            document.getElementById('newProdH').value = data.height_mm;
            document.getElementById('newProdPrice').value = data.price;
            document.getElementById('newProdImg').value = data.img_url;
            document.getElementById('prodPreview').src = data.img_url; document.getElementById('prodPreview').style.display = 'block';
            const addons = data.addons ? data.addons.split(',') : [];
            document.querySelectorAll('input[name="prodAddon"]').forEach(c => c.checked = addons.includes(c.value));
            const btn = document.getElementById('btnProductSave');
            btn.innerText = "ìˆ˜ì •ì‚¬í•­ ì €ì¥"; btn.classList.remove('btn-primary'); btn.classList.add('btn-vip');
            document.getElementById('btnProductClone').style.display = 'inline-block';
            document.getElementById('btnCancelEdit').style.display = 'inline-block';
            document.querySelector('.product-form').scrollIntoView({behavior:'smooth'});
        };
        window.cloneProduct = () => { editingProdId = null; document.getElementById('newProdCode').value += "_copy_" + Math.floor(Math.random()*1000); document.getElementById('btnProductSave').innerText = "ìƒˆ ìƒí’ˆìœ¼ë¡œ ë“±ë¡í•˜ê¸°"; document.getElementById('btnProductClone').style.display = 'none'; alert("ğŸ“‹ ë³µì œë¨. ì½”ë“œë¥¼ í™•ì¸ í›„ ë“±ë¡í•˜ì„¸ìš”."); };
        window.resetProductForm = () => { editingProdId = null; document.getElementById('newProdCode').value=''; document.getElementById('newProdName').value=''; document.getElementById('newProdW').value=''; document.getElementById('newProdH').value=''; document.getElementById('newProdPrice').value=''; document.getElementById('newProdImg').value=''; document.getElementById('newProdFile').value=''; document.getElementById('prodPreview').style.display='none'; document.querySelectorAll('input[name="prodAddon"]').forEach(c=>c.checked=false); const btn = document.getElementById('btnProductSave'); btn.innerText="ìƒí’ˆ ë“±ë¡í•˜ê¸°"; btn.classList.remove('btn-vip'); btn.classList.add('btn-primary'); document.getElementById('btnProductClone').style.display='none'; document.getElementById('btnCancelEdit').style.display='none'; };
        window.previewProductImage = async (input) => {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const btn = document.getElementById('btnProductSave'); const originalText = btn.innerText;
            const reader = new FileReader(); reader.onload=(e)=>{ document.getElementById('prodPreview').src=e.target.result; document.getElementById('prodPreview').style.display='block'; }; reader.readAsDataURL(file);
            try {
                btn.innerText = "ì—…ë¡œë“œ ì¤‘..."; btn.disabled = true;
                const fileName = `prod_${Date.now()}_${Math.floor(Math.random()*1000)}`;
                const { data, error } = await sb.storage.from('products').upload(fileName, file);
                if (error) throw error;
                const { data: urlData } = sb.storage.from('products').getPublicUrl(fileName);
                document.getElementById('newProdImg').value = urlData.publicUrl; alert("ì—…ë¡œë“œ ì™„ë£Œ");
            } catch (e) { alert("ì‹¤íŒ¨: " + e.message); } finally { btn.innerText = originalText; btn.disabled = false; }
        };
        window.deleteSystemData = async (t, id) => { if(confirm("ì‚­ì œ?")) { await sb.from(t).delete().eq('id', id); loadSystemDB(); } };
        window.addAddonDB = async () => { const c=document.getElementById('newAddonCode').value; const n=document.getElementById('newAddonName').value; const p=document.getElementById('newAddonPrice').value; const cat=document.getElementById('newAddonCat').value; if(!c||!n) return alert("ì…ë ¥ í™•ì¸"); await sb.from('admin_addons').insert([{code:c, name:n, price:parseInt(p||0), category:cat}]); loadSystemDB(); };
        function addDragListeners(row) { row.addEventListener('dragstart',()=>row.classList.add('dragging')); row.addEventListener('dragend',async()=>{row.classList.remove('dragging'); await saveSortOrder();}); const container=document.getElementById('prodTableBody'); container.addEventListener('dragover',(e)=>{e.preventDefault(); const afterElement=getDragAfterElement(container,e.clientY); const draggable=document.querySelector('.dragging'); if(afterElement==null) container.appendChild(draggable); else container.insertBefore(draggable,afterElement);}); }
        function getDragAfterElement(container,y) { const draggableElements=[...container.querySelectorAll('.draggable-row:not(.dragging)')]; return draggableElements.reduce((closest,child)=>{const box=child.getBoundingClientRect(); const offset=y-box.top-box.height/2; if(offset<0&&offset>closest.offset) return {offset:offset, element:child}; else return closest;},{offset:Number.NEGATIVE_INFINITY}).element; }
        async function saveSortOrder() { const rows=document.querySelectorAll('#prodTableBody tr'); const updates=[]; rows.forEach((row,index)=>{updates.push(sb.from('admin_products').update({sort_order:index+1}).eq('id',row.dataset.id));}); await Promise.all(updates); console.log("ìˆœì„œ ì €ì¥ë¨"); }
    </script>
</body>
</html>