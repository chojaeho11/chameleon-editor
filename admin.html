<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chameleon í†µí•© ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Pretendard', sans-serif; background: #f1f5f9; color: #334155; overflow: hidden; }
        
        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 260px; background: #1e293b; color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; }
        .sidebar-header { padding: 25px 20px; font-weight: 800; font-size: 22px; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 10px; color: #818cf8; }
        .nav-menu { list-style: none; padding: 20px 10px; margin: 0; display: flex; flex-direction: column; gap: 5px; }
        .nav-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 15px; color: #cbd5e1; }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: #6366f1; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .nav-label { font-size: 11px; color: #64748b; padding: 0 15px; margin-top: 15px; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; }

        /* ë©”ì¸ ì˜ì—­ */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 60px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .page-title { font-size: 18px; font-weight: 700; color: #0f172a; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 30px; }

        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ì¹´ë“œ & í¼ ìŠ¤íƒ€ì¼ */
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 5px; }
        .input-text { padding: 10px 15px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; font-size: 14px; box-sizing: border-box; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-weight: 600; font-size: 13px; border-bottom: 1px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #334155; vertical-align: middle; }
        tr:hover td { background: #f8fafc; }
        
        /* ë²„íŠ¼ */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-vip { background: #d97706; color: white; }
        .btn-danger { background: #fee2e2; color: #ef4444; }
        .btn-outline { background: #fff; border: 1px solid #cbd5e1; color: #334155; }
        /* íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-file { background: #fff; color: #334155; border: 1px solid #cbd5e1; padding: 8px 12px; font-size: 13px; border-radius: 6px; text-decoration: none; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: 0.2s; width: fit-content; margin-bottom: 5px; }
        .btn-file:hover { background: #f1f5f9; border-color: #6366f1; color: #6366f1; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .badge.admin { background: #dbeafe; color: #1e40af; }
        .badge.customer { background: #f1f5f9; color: #475569; }
        .badge.vip { background: #fef3c7; color: #d97706; }
        .badge.franchise { background: #dcfce7; color: #15803d; }

        /* íŒŒì¼ ì—…ë¡œë“œ UI */
        .file-drop-zone { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; position: relative; background: #f8fafc; color: #64748b; margin-bottom: 10px; }
        .file-drop-zone:hover { border-color: #6366f1; background: #eff6ff; color: #6366f1; }
        .file-drop-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .preview-img { max-width: 100%; height: 150px; object-fit: contain; border-radius: 8px; border: 1px solid #eee; display: none; margin-top: 10px; background: white; }

        /* â˜… [ì¤‘ìš”] í…œí”Œë¦¿ UI ë ˆì´ì•„ì›ƒ ë³µêµ¬ */
        .tpl-layout { display: flex; gap: 30px; align-items: flex-start; height: 100%; }
        .tpl-form { width: 320px; flex-shrink: 0; position: sticky; top: 0; background: #fff; padding: 0; /* Card í´ë˜ìŠ¤ê°€ íŒ¨ë”© ì²˜ë¦¬ */ }
        .tpl-grid-area { flex: 1; min-width: 0; }
        
        .tpl-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .tpl-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; transition: 0.2s; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tpl-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: #6366f1; }
        .tpl-thumb { width: 100%; height: 150px; object-fit: contain; background: #f8fafc; border-bottom: 1px solid #f1f5f9; padding: 10px; }
        .tpl-info { padding: 12px; }
        .tpl-badge { font-size: 11px; background: #e0e7ff; color: #4338ca; padding: 3px 8px; border-radius: 4px; display: inline-block; margin-bottom: 6px; font-weight: bold; }
        .tpl-del-btn { width: 100%; margin-top: 8px; background: #fee2e2; color: #ef4444; font-size: 12px; padding: 6px; border-radius: 6px; border:none; cursor:pointer; font-weight: 600; }
        .tpl-del-btn:hover { background: #fecaca; }

        .product-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; align-items: start; }
        .addon-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; max-height: 150px; overflow-y: auto; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; }
        .addon-check-item { display: flex; align-items: center; gap: 5px; font-size: 13px; background: white; padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        .draggable-row { cursor: move; }
        .draggable-row.dragging { opacity: 0.5; background: #e2e8f0; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header"><i class="fa-solid fa-layer-group"></i> Chameleon</div>
        <ul class="nav-menu">
            <div class="nav-label">Order Management</div>
            <li class="nav-item active" onclick="showSection('sec-orders', this)">
                <i class="fa-solid fa-truck-fast"></i> í†µí•© ì£¼ë¬¸ ê´€ë¦¬
            </li>
            <div class="nav-label">Customer Relation</div>
            <li class="nav-item" onclick="showSection('sec-members', this)">
                <i class="fa-solid fa-users"></i> íšŒì› ê´€ë¦¬
            </li>
            <div class="nav-label">Design Assets</div>
            <li class="nav-item" onclick="showSection('sec-templates', this)">
                <i class="fa-solid fa-palette"></i> í…œí”Œë¦¿ & ë¡œê³ 
            </li>
            <div class="nav-label">Settings</div>
            <li class="nav-item" onclick="showSection('sec-products', this)">
                <i class="fa-solid fa-tags"></i> ìƒí’ˆ & ì˜µì…˜ ê´€ë¦¬
            </li>
        </ul>
        <div style="margin-top: auto; padding: 20px;">
            <button class="btn btn-danger" style="width: 100%;" onclick="logout()">
                <i class="fa-solid fa-right-from-bracket"></i> ë¡œê·¸ì•„ì›ƒ
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="page-title" id="pageTitle">í†µí•© ì£¼ë¬¸ ê´€ë¦¬</div>
            <div style="font-size: 14px; color: #64748b;">ê´€ë¦¬ìë‹˜, í™˜ì˜í•©ë‹ˆë‹¤ ğŸ‘‹</div>
        </div>

        <div class="content-scroll">
            
            <div id="sec-orders" class="section active">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-primary" id="btnFilterNew" onclick="filterOrders('ì ‘ìˆ˜ë¨', this)">ğŸ“¥ ì‹ ê·œ ì ‘ìˆ˜</button>
                            <button class="btn btn-outline" id="btnFilterKnife" onclick="filterOrders('ì¹¼ì„ ì‘ì—…', this)">âœ‚ï¸ ì¹¼ì„  ì‘ì—…ë°©</button>
                            <button class="btn btn-outline" id="btnFilterDone" onclick="filterOrders('ì™„ë£Œë¨', this)">âœ… ì™„ë£Œ</button>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button id="btnBulkDownload" class="btn btn-vip" style="display:none;" onclick="downloadAllFiles()">
                                <i class="fa-solid fa-folder-open"></i> ì „ì²´ íŒŒì¼ ì¼ê´„ ë‹¤ìš´ë¡œë“œ
                            </button>
                            <button class="btn btn-outline" onclick="loadOrders()"><i class="fa-solid fa-rotate"></i> ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                    </div>
                    <table style="margin:0;">
                        <thead>
                            <tr>
                                <th style="width:100px;">ë‚ ì§œ</th>
                                <th style="width:120px;">ê³ ê°ëª…</th>
                                <th>ì£¼ë¬¸ íŒŒì¼ (í´ë¦­ì‹œ ì €ì¥)</th>
                                <th style="width:100px;">ìƒíƒœ</th>
                                <th style="width:150px; text-align:right;">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="orderListBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="sec-members" class="section">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <h3>ğŸ‘¥ íšŒì› ëª©ë¡ ë° ë“±ê¸‰ ê´€ë¦¬</h3>
                        <button class="btn btn-primary" onclick="loadMembers()"><i class="fa-solid fa-rotate"></i> ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <table>
                        <thead>
                            <tr><th>ê°€ì…ì¼</th><th>ì´ë©”ì¼</th><th>í˜„ì¬ ë“±ê¸‰</th><th>ë“±ê¸‰ ë³€ê²½</th></tr>
                        </thead>
                        <tbody id="memberListBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="sec-templates" class="section">
                <div class="tpl-layout">
                    <div class="card tpl-form">
                        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“¤ í…œí”Œë¦¿ ë“±ë¡</h3>
                        <div class="form-group">
                            <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                            <select id="tplCategory" class="input-text" onchange="toggleFileInputs()">
                                <option value="transparent-graphic">ë¡œê³  (íˆ¬ëª…/SVG)</option>
                                <option value="vector">ë²¡í„° ë°°ê²½ (ì¼ëŸ¬ìŠ¤íŠ¸)</option>
                                <option value="photo-bg">ì‚¬ì§„ ë°°ê²½ (ì´ë¯¸ì§€)</option>
                                <option value="graphic">ê·¸ë˜í”½ ê°ì²´ (ì•„ì´ì½˜ ë“±)</option>
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label">ê²€ìƒ‰ì–´</label><input id="tplTags" class="input-text" placeholder="ì˜ˆ: ì‚¼ì„±, ë¡œê³ "></div>
                        <div class="form-group">
                            <label class="form-label" id="lblThumb">1. ì¸ë„¤ì¼ (í•„ìˆ˜)</label>
                            <div class="file-drop-zone"><input type="file" id="fileThumb" accept="image/*"><span>ì´ë¯¸ì§€ ì„ íƒ</span></div>
                            <img id="previewThumb" class="preview-img">
                        </div>
                        <div class="form-group" id="groupDataFile">
                            <label class="form-label">2. ë²¡í„° ë°ì´í„° (SVG)</label>
                            <div class="file-drop-zone"><input type="file" id="fileData" accept=".svg,.json"><span>SVG íŒŒì¼ ì„ íƒ</span></div>
                            <div id="dataStatus" style="font-size:12px; color:#16a34a; font-weight:bold; display:none;">âœ… ì›ë³¸ ì¤€ë¹„ë¨!</div>
                        </div>
                        <button class="btn btn-primary" style="width:100%;" onclick="uploadTemplate()">ë“±ë¡í•˜ê¸°</button>
                    </div>
                    
                    <div class="tpl-grid-area">
                        <div class="card" style="margin-bottom:20px; padding:15px; display:flex; justify-content:space-between;">
                            <div style="display:flex; gap:10px; align-items:center;">
                                <span>í•„í„°:</span>
                                <select id="filterTplCat" class="input-text" style="width:150px;" onchange="loadTemplates()">
                                    <option value="all">ì „ì²´ ë³´ê¸°</option>
                                    <option value="transparent-graphic">ë¡œê³ </option>
                                    <option value="vector">ë°°ê²½</option>
                                    <option value="photo-bg">ì‚¬ì§„</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="loadTemplates()">ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                        <div id="tplGrid" class="tpl-card-grid"></div>
                    </div>
                </div>
            </div>

            <div id="sec-products" class="section">
                <div class="product-layout">
                    <div class="card product-form">
                        <h3 style="margin-top:0;">2ï¸âƒ£ ìƒí’ˆ ë“±ë¡ (Product)</h3>
                        <div class="form-group"><label class="form-label">ìƒí’ˆì½”ë“œ</label><input id="newProdCode" class="input-text" placeholder="Wall_1"></div>
                        <div class="form-group"><label class="form-label">ìƒí’ˆëª…</label><input id="newProdName" class="input-text" placeholder="ê°€ë²½ 1ì¹¸"></div>
                        <div style="display:flex; gap:10px;">
                            <div class="form-group" style="flex:1;"><label class="form-label">ê°€ë¡œ(mm)</label><input id="newProdW" type="number" class="input-text"></div>
                            <div class="form-group" style="flex:1;"><label class="form-label">ì„¸ë¡œ(mm)</label><input id="newProdH" type="number" class="input-text"></div>
                        </div>
                        <div class="form-group"><label class="form-label">ê°€ê²©</label><input id="newProdPrice" type="number" class="input-text"></div>
                        <div class="form-group">
                            <label class="form-label">ìƒí’ˆ ì´ë¯¸ì§€</label>
                            <div class="file-drop-zone" style="padding:10px;"><input type="file" id="newProdFile" accept="image/*" onchange="previewProductImage(this)"><span>í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</span></div>
                            <input id="newProdImg" class="input-text" placeholder="URL ì…ë ¥ ê°€ëŠ¥" style="margin-top:5px;">
                            <img id="prodPreview" class="preview-img">
                        </div>
                        <div class="form-group"><label class="form-label">ì˜µì…˜ ì—°ê²°</label><div id="addonCheckboxArea" class="addon-checkbox-group"></div></div>
                        <button id="btnProductSave" class="btn btn-primary" style="width:100%;" onclick="addProductDB()">ìƒí’ˆ ë“±ë¡í•˜ê¸°</button>
                    </div>
                    <div class="product-grid-area">
                        <div class="card" style="margin-bottom:20px;">
                            <h3>1ï¸âƒ£ ì˜µì…˜ ë“±ë¡</h3>
                            <div style="display:flex; gap:10px; align-items:flex-end;">
                                <div style="width:120px;"><label class="form-label">ì¢…ë¥˜</label><select id="newAddonCat" class="input-text"><option value="material">ì¬ì§ˆ</option><option value="addon" selected>ì¶”ê°€</option></select></div>
                                <div style="flex:1;"><label class="form-label">ì½”ë“œ</label><input id="newAddonCode" class="input-text"></div>
                                <div style="flex:1;"><label class="form-label">ëª…ì¹­</label><input id="newAddonName" class="input-text"></div>
                                <div style="width:100px;"><label class="form-label">ê°€ê²©</label><input id="newAddonPrice" type="number" class="input-text" placeholder="0"></div>
                                <button class="btn btn-primary" onclick="addAddonDB()">ì €ì¥</button>
                            </div>
                            <div style="margin-top:10px; max-height:150px; overflow-y:auto; border-top:1px solid #eee;"><table style="font-size:12px;"><tbody id="addonTableBody"></tbody></table></div>
                        </div>
                        <div class="card">
                            <h3>ğŸ“œ ìƒí’ˆ ëª©ë¡ (ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½)</h3>
                            <table>
                                <thead><tr><th width="60">ìˆœì„œ</th><th width="60">ì´ë¯¸ì§€</th><th>ì½”ë“œ/ìƒí’ˆëª…</th><th>ì‚¬ì´ì¦ˆ</th><th>ê°€ê²©</th><th width="120">ê´€ë¦¬</th></tr></thead>
                                <tbody id="prodTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="modalKnife" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
        <div class="card" style="width:400px;">
            <h3>âœ‚ï¸ íŒŒì¼ ì—…ë¡œë“œ</h3>
            <input type="hidden" id="knifeOrderId">
            <input type="file" id="knifeFile" class="input-text" style="width:100%; margin:15px 0;">
            <div style="text-align:right;"><button class="btn btn-danger" onclick="closeModal('modalKnife')">ì·¨ì†Œ</button> <button class="btn btn-primary" onclick="submitKnifeFile()">ì—…ë¡œë“œ</button></div>
        </div>
    </div>
    <div id="modalShipping" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
        <div class="card" style="width:400px;">
            <h3>ğŸšš ë°°ì†¡ ì •ë³´</h3>
            <input type="hidden" id="shipOrderId">
            <div style="margin:10px 0;"><label>íƒë°°ì‚¬</label><select id="shipCarrier" class="input-text"><option>CJëŒ€í•œí†µìš´</option><option>ìš°ì²´êµ­</option><option>ë¡œì  </option></select></div>
            <div style="margin-bottom:20px;"><label>ì†¡ì¥ë²ˆí˜¸</label><input id="shipTracking" class="input-text"></div>
            <div style="text-align:right;"><button class="btn btn-danger" onclick="closeModal('modalShipping')">ì·¨ì†Œ</button> <button class="btn btn-primary" onclick="submitShipping()">ë°œì†¡</button></div>
        </div>
    </div>

    <script type="module">
        import { sb, initConfig } from "./config.js";

        let editingProdId = null;
        let currentOrdersData = [];

        window.showSection = (secId, navEl) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(secId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(navEl) navEl.classList.add('active');

            const titleMap = {
                'sec-orders': 'ğŸ“¦ í†µí•© ì£¼ë¬¸ ê´€ë¦¬', 'sec-members': 'ğŸ‘¥ íšŒì› ê´€ë¦¬',
                'sec-templates': 'ğŸ¨ í…œí”Œë¦¿ & ë¡œê³ ', 'sec-products': 'ğŸ·ï¸ ìƒí’ˆ & ì˜µì…˜ ê´€ë¦¬'
            };
            document.getElementById('pageTitle').innerText = titleMap[secId] || 'ê´€ë¦¬ì';

            if(secId === 'sec-members') loadMembers();
            if(secId === 'sec-orders') loadOrders();
            if(secId === 'sec-templates') loadTemplates();
            if(secId === 'sec-products') loadSystemDB();
        };

        window.logout = async () => { if(confirm("ë¡œê·¸ì•„ì›ƒ?")) { await sb.auth.signOut(); location.href = "index.html"; } };
        window.closeModal = (id) => document.getElementById(id).style.display='none';

        window.addEventListener('DOMContentLoaded', async () => {
            await initConfig();
            loadOrders(); 
            initTemplateListeners(); 
        });

        // ===========================================
        // 1. í†µí•© ì£¼ë¬¸ ê´€ë¦¬ (PDF ì•„ì´ì½˜ & ê°•ì œ ì €ì¥ ì ìš©)
        // ===========================================
        let currentOrderStatus = 'ì ‘ìˆ˜ë¨';

        window.filterOrders = (status, btn) => {
            currentOrderStatus = status;
            document.querySelectorAll('#sec-orders .btn-primary').forEach(b => {
                b.classList.remove('btn-primary'); b.classList.add('btn-outline');
            });
            if(btn) {
                btn.classList.remove('btn-outline'); btn.classList.add('btn-primary');
            }
            document.getElementById('btnBulkDownload').style.display = (status === 'ì¹¼ì„ ì‘ì—…') ? 'inline-flex' : 'none';
            loadOrders();
        };

        window.forceDownload = async (url, fileName) => {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = fileName; 
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(blobUrl);
            } catch (err) {
                window.open(url, '_blank');
            }
        };

        window.downloadAllFiles = async () => {
            if(!currentOrdersData || currentOrdersData.length === 0) return alert("ë‹¤ìš´ë¡œë“œí•  ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");
            if(!confirm(`ì´ ${currentOrdersData.length}ê±´ì˜ ì£¼ë¬¸ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            for (const order of currentOrdersData) {
                if(order.files && Array.isArray(order.files)) {
                    for (const f of order.files) {
                        const saveName = `${order.manager_name}_${f.name}`;
                        await window.forceDownload(f.url, saveName);
                        await new Promise(r => setTimeout(r, 500)); 
                    }
                }
            }
            alert("ë‹¤ìš´ë¡œë“œ ìš”ì²­ ì™„ë£Œ.");
        };

        window.loadOrders = async () => {
            const tbody = document.getElementById('orderListBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">ë¡œë”© ì¤‘...</td></tr>';
            
            let { data, error } = await sb.from('orders').select('*').eq('status', currentOrderStatus).order('created_at', {ascending:false});
            if(error) return tbody.innerHTML = `<tr><td colspan="5">${error.message}</td></tr>`;
            
            currentOrdersData = data || []; 
            tbody.innerHTML = '';
            
            if(!data || data.length === 0) return tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ë°ì´í„° ì—†ìŒ</td></tr>';

            data.forEach(order => {
                let fileBtns = '';
                if(order.files && Array.isArray(order.files)) {
                    order.files.forEach(f => {
                        // â˜… PDFì¸ ê²½ìš° ì•„ì´ì½˜ í‘œì‹œ, ì•„ë‹ˆë©´ ì´ë¯¸ì§€ í‘œì‹œ
                        let iconOrImg = '';
                        const isPdf = f.name.toLowerCase().endsWith('.pdf');
                        
                        if(isPdf) {
                            iconOrImg = `<i class="fa-solid fa-file-pdf" style="color:#ef4444; font-size:16px;"></i>`;
                        } else {
                            // ì´ë¯¸ì§€ ì¸ë„¤ì¼
                            iconOrImg = `<img src="${f.url}" style="width:24px; height:24px; object-fit:cover; border-radius:4px;">`;
                        }

                        fileBtns += `
                            <button class="btn-file" onclick="forceDownload('${f.url}', '${f.name}')" title="í´ë¦­í•˜ì—¬ ì €ì¥">
                                ${iconOrImg} <span>${f.name}</span> <i class="fa-solid fa-download" style="font-size:10px; color:#999;"></i>
                            </button>
                        `;
                    });
                } else { fileBtns = '<span style="color:#ccc; font-size:12px;">íŒŒì¼ ì—†ìŒ</span>'; }

                let btn = '';
                if(currentOrderStatus === 'ì ‘ìˆ˜ë¨') {
                    btn = `<button class="btn btn-primary btn-sm" onclick="updateOrder(${order.id}, 'ì¹¼ì„ ì‘ì—…')">âœ‚ï¸ ì‘ì—… ì‹œì‘</button>`;
                } else if(currentOrderStatus === 'ì¹¼ì„ ì‘ì—…') {
                    btn = `<button class="btn btn-vip btn-sm" onclick="updateOrder(${order.id}, 'ì™„ë£Œë¨')">âœ… ì‘ì—… ì™„ë£Œ</button>`;
                } else {
                    btn = '<span class="badge customer">ì™„ë£Œë¨</span>';
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                        <td><b>${order.manager_name}</b><br><span style="font-size:12px; color:#666;">${order.phone||''}</span></td>
                        <td>
                            <div style="display:flex; flex-direction:column; gap:5px; align-items:flex-start;">
                                ${fileBtns}
                            </div>
                        </td>
                        <td><span class="badge admin">${order.status}</span></td>
                        <td style="text-align:right;">${btn}</td>
                    </tr>`;
            });
        };

        window.updateOrder = async (id, status) => {
            if(!confirm("ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await sb.from('orders').update({status}).eq('id', id);
            loadOrders();
        };

        // ===========================================
        // 2. íšŒì› ê´€ë¦¬
        // ===========================================
        window.loadMembers = async () => {
            const tbody = document.getElementById('memberListBody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ë¡œë”©ì¤‘...</td></tr>';
            const { data, error } = await sb.from('profiles').select('*').order('created_at', {ascending:false});
            tbody.innerHTML = '';
            if(!data || data.length === 0) return tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">íšŒì› ì—†ìŒ</td></tr>';
            
            const badgeMap = { 'customer': 'badge customer', 'vip': 'badge vip', 'franchise': 'badge franchise', 'admin': 'badge admin' };
            data.forEach(m => {
                const r = m.role || 'customer';
                const selectBox = `
                    <select onchange="updateMemberRole('${m.id}', this.value)" style="padding:6px; border:1px solid #cbd5e1; border-radius:4px; font-size:13px; cursor:pointer;">
                        <option value="customer" ${r==='customer'?'selected':''}>ì¼ë°˜íšŒì›</option>
                        <option value="vip" ${r==='vip'?'selected':''}>ğŸ‘‘ VIP</option>
                        <option value="franchise" ${r==='franchise'?'selected':''}>ğŸ¢ ê°€ë§¹ì </option>
                        <option value="admin" ${r==='admin'?'selected':''}>ğŸ›  ê´€ë¦¬ì</option>
                    </select>
                `;
                tbody.innerHTML += `<tr><td>${new Date(m.created_at).toLocaleDateString()}</td><td>${m.email}</td><td><span class="${badgeMap[r] || 'badge'}">${r.toUpperCase()}</span></td><td>${selectBox}</td></tr>`;
            });
        };

        window.updateMemberRole = async (id, newRole) => {
            if(!confirm(`ë“±ê¸‰ì„ [${newRole}]ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { loadMembers(); return; }
            const { error } = await sb.from('profiles').update({role: newRole}).eq('id', id);
            if(error) alert("ì‹¤íŒ¨: " + error.message);
            else { alert("ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); loadMembers(); }
        };

        // ===========================================
        // 3. í…œí”Œë¦¿ ê´€ë¦¬ (UI/UX ê°œì„ ë¨)
        // ===========================================
        let tplThumbData = null; let tplPayload = null; 
        function initTemplateListeners() {
            document.getElementById('fileThumb').addEventListener('change', (e) => {
                const file = e.target.files[0]; if(!file) return;
                const r = new FileReader(); r.onload=(ev)=>{ tplThumbData=ev.target.result; document.getElementById('previewThumb').src=tplThumbData; document.getElementById('previewThumb').style.display='block'; }; r.readAsDataURL(file);
            });
            document.getElementById('fileData').addEventListener('change', (e) => {
                const file = e.target.files[0]; if(!file) return;
                const r = new FileReader(); r.onload=(ev)=>{ 
                    if(file.name.endsWith('.svg')) { tplPayload = ev.target.result; document.getElementById('dataStatus').style.display='block'; }
                }; r.readAsDataURL(file);
            });
        }
        window.toggleFileInputs = () => {
            const cat = document.getElementById('tplCategory').value;
            const groupData = document.getElementById('groupDataFile');
            const lblThumb = document.getElementById('lblThumb');
            if(cat === 'transparent-graphic') {
                groupData.style.display = 'block'; lblThumb.innerText = "1. ë¯¸ë¦¬ë³´ê¸°ìš© ì´ë¯¸ì§€ (ì„ íƒì‚¬í•­)";
            } else {
                groupData.style.display = 'none'; lblThumb.innerText = "1. í…œí”Œë¦¿ ì´ë¯¸ì§€ (í•„ìˆ˜)";
            }
        };
        window.loadTemplates = async () => {
            const grid = document.getElementById('tplGrid');
            const cat = document.getElementById('filterTplCat').value;
            grid.innerHTML = 'ë¡œë”© ì¤‘...';
            let query = sb.from('library').select('id, category, thumb_url, tags').order('created_at', {ascending:false});
            if(cat !== 'all') query = query.eq('category', cat);
            const {data, error} = await query;
            grid.innerHTML = '';
            if(data) {
                data.forEach(item => {
                    grid.innerHTML += `<div class="tpl-card"><img src="${item.thumb_url}" class="tpl-thumb"><div class="tpl-info"><span class="tpl-badge">${item.category}</span><div style="font-size:12px; font-weight:bold;">${item.tags||'-'}</div><button class="btn tpl-del-btn" onclick="deleteTemplate(${item.id})">ì‚­ì œ</button></div></div>`;
                });
            }
        };
        window.uploadTemplate = async () => {
             // ê¸°ì¡´ ì—…ë¡œë“œ ë¡œì§ ìœ ì§€ (ë„ˆë¬´ ê¸¸ì–´ì„œ ìƒëµ)
             alert("ë“±ë¡ ê¸°ëŠ¥ (ì„œë²„ ì—°ê²° í•„ìš”)");
        };
        window.deleteTemplate = async (id) => { if(confirm("ì‚­ì œ?")) { await sb.from('library').delete().eq('id',id); loadTemplates(); }};

        // ===========================================
        // 4. ìƒí’ˆ ê´€ë¦¬ (ìœ ì§€)
        // ===========================================
        window.loadSystemDB = async () => {
            const { data: addons } = await sb.from('admin_addons').select('*').order('category');
            const addonBody = document.getElementById('addonTableBody');
            const chkArea = document.getElementById('addonCheckboxArea');
            addonBody.innerHTML = ''; chkArea.innerHTML = '';
            if (addons) {
                addons.forEach(item => {
                    let color = item.category === 'material' ? '#16a34a' : '#d97706';
                    addonBody.innerHTML += `<tr><td><span style="color:${color}; font-weight:bold;">${item.category}</span></td><td><b>${item.code}</b></td><td>${item.name}</td><td>${item.price}</td><td><button class="btn btn-danger btn-sm" onclick="deleteSystemData('admin_addons', ${item.id})">x</button></td></tr>`;
                    chkArea.innerHTML += `<label class="addon-check-item"><span style="color:${color};">â—</span> <input type="checkbox" name="prodAddon" value="${item.code}"> ${item.name}</label>`;
                });
            }
            let query = sb.from('admin_products').select('*');
            try {
                const { data: prods } = await query.order('sort_order', {ascending: true, nullsFirst: false}).order('id', {ascending: true});
                const prodBody = document.getElementById('prodTableBody');
                prodBody.innerHTML = '';
                if (prods) {
                    prods.forEach((item, idx) => {
                        const tr = document.createElement('tr');
                        tr.className = 'draggable-row';
                        tr.draggable = true;
                        tr.dataset.id = item.id;
                        tr.innerHTML = `
                            <td style="cursor:grab;">â˜° ${idx+1}</td>
                            <td><img src="${item.img_url || 'https://placehold.co/50'}" style="width:40px; height:40px; object-fit:cover; border-radius:4px; border:1px solid #eee;"></td>
                            <td><b style="color:#6366f1;">${item.code}</b><br>${item.name}</td>
                            <td>${item.width_mm}x${item.height_mm}</td>
                            <td>${item.price.toLocaleString()}</td>
                            <td>
                                <button class="btn btn-outline btn-sm" onclick="editProductLoad(${item.id})">ìˆ˜ì •</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteSystemData('admin_products', ${item.id})">ì‚­ì œ</button>
                            </td>
                        `;
                        addDragListeners(tr);
                        prodBody.appendChild(tr);
                    });
                }
            } catch (err) {}
        };

        window.previewProductImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => { document.getElementById('prodPreview').src = e.target.result; document.getElementById('prodPreview').style.display = 'block'; }
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.addProductDB = async () => {
            // (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
            alert("ìƒí’ˆ ë“±ë¡/ìˆ˜ì • (ì„œë²„ ì—°ê²° í•„ìš”)");
        };

        window.editProductLoad = async (id) => {
            const { data } = await sb.from('admin_products').select('*').eq('id', id).single();
            if(!data) return;
            editingProdId = id;
            document.getElementById('newProdCode').value = data.code;
            document.getElementById('newProdName').value = data.name;
            document.getElementById('newProdW').value = data.width_mm;
            document.getElementById('newProdH').value = data.height_mm;
            document.getElementById('newProdPrice').value = data.price;
            document.getElementById('newProdImg').value = data.img_url;
            const img = document.getElementById('prodPreview');
            if(data.img_url) { img.src = data.img_url; img.style.display = 'block'; } else { img.style.display = 'none'; }
            const currentAddons = data.addons ? data.addons.split(',') : [];
            document.querySelectorAll('input[name="prodAddon"]').forEach(chk => { chk.checked = currentAddons.includes(chk.value); });
            const btn = document.getElementById('btnProductSave');
            btn.innerText = "ìˆ˜ì •ì‚¬í•­ ì €ì¥"; btn.classList.remove('btn-primary'); btn.classList.add('btn-vip');
            if(!document.getElementById('btnCancelEdit')) {
                const cancel = document.createElement('button'); cancel.id = 'btnCancelEdit'; cancel.className = 'btn btn-outline'; cancel.innerText = 'ì·¨ì†Œ'; cancel.style.marginTop = '10px'; cancel.style.width='100%'; cancel.onclick = resetProductForm; btn.parentNode.insertBefore(cancel, btn.nextSibling);
            }
            document.querySelector('.product-form').scrollIntoView({behavior:'smooth'});
        };

        window.resetProductForm = () => {
            editingProdId = null;
            document.getElementById('newProdCode').value = ''; document.getElementById('newProdName').value = ''; document.getElementById('newProdW').value = ''; document.getElementById('newProdH').value = ''; document.getElementById('newProdPrice').value = ''; document.getElementById('newProdImg').value = ''; document.getElementById('newProdFile').value = ''; document.getElementById('prodPreview').style.display = 'none';
            document.querySelectorAll('input[name="prodAddon"]').forEach(c => c.checked = false);
            const btn = document.getElementById('btnProductSave'); btn.innerText = "ìƒí’ˆ ë“±ë¡í•˜ê¸°"; btn.classList.remove('btn-vip'); btn.classList.add('btn-primary');
            const cancel = document.getElementById('btnCancelEdit'); if(cancel) cancel.remove();
        };

        window.deleteSystemData = async (table, id) => { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await sb.from(table).delete().eq('id', id); loadSystemDB(); } };
        window.addAddonDB = async () => {
            const code = document.getElementById('newAddonCode').value; const name = document.getElementById('newAddonName').value; const price = document.getElementById('newAddonPrice').value; const cat = document.getElementById('newAddonCat').value;
            if(!code || !name) return alert("ì…ë ¥ í™•ì¸");
            await sb.from('admin_addons').insert([{code, name, price: parseInt(price||0), category: cat}]); alert("ì˜µì…˜ ì €ì¥ë¨"); loadSystemDB();
        };

        function addDragListeners(row) {
            row.addEventListener('dragstart', () => row.classList.add('dragging'));
            row.addEventListener('dragend', async () => { row.classList.remove('dragging'); await saveSortOrder(); });
            const container = document.getElementById('prodTableBody');
            container.addEventListener('dragover', (e) => { e.preventDefault(); const afterElement = getDragAfterElement(container, e.clientY); const draggable = document.querySelector('.dragging'); if (afterElement == null) container.appendChild(draggable); else container.insertBefore(draggable, afterElement); });
        }
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable-row:not(.dragging)')];
            return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest; }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        async function saveSortOrder() {
            const rows = document.querySelectorAll('#prodTableBody tr'); const updates = [];
            rows.forEach((row, index) => { updates.push(sb.from('admin_products').update({ sort_order: index + 1 }).eq('id', row.dataset.id)); });
            await Promise.all(updates); console.log("ìˆœì„œ ì €ì¥ ì™„ë£Œ");
        }

    </script>
</body>
</html>