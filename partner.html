<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partners Marketplace</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="site-config.js"></script>
    <style>
        *{box-sizing:border-box;margin:0;padding:0;}
        body{background:#f1f5f9;font-family:'Pretendard',sans-serif;color:#1e293b;display:flex;min-height:100vh;}

        /* ===== 사이드바 ===== */
        .sidebar{width:260px;background:#0f172a;color:#cbd5e1;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;transition:transform 0.3s;}
        .sidebar-brand{padding:24px 20px;border-bottom:1px solid #1e293b;display:flex;align-items:center;gap:10px;cursor:pointer;}
        .sidebar-brand i{font-size:22px;color:#818cf8;}
        .sidebar-brand span{font-size:17px;font-weight:800;color:#fff;}
        .sidebar-user{padding:20px;border-bottom:1px solid #1e293b;}
        .sidebar-user .user-name{font-size:15px;font-weight:700;color:#e2e8f0;margin-bottom:2px;}
        .sidebar-user .user-email{font-size:12px;color:#64748b;}
        .sidebar-nav{flex:1;padding:12px 0;overflow-y:auto;}
        .nav-item{display:flex;align-items:center;gap:12px;padding:12px 20px;cursor:pointer;font-size:14px;font-weight:600;color:#94a3b8;transition:all 0.15s;border-left:3px solid transparent;}
        .nav-item:hover{background:#1e293b;color:#e2e8f0;}
        .nav-item.active{background:#1e293b;color:#818cf8;border-left-color:#818cf8;}
        .nav-item i{width:20px;text-align:center;font-size:16px;}
        .nav-item .badge{margin-left:auto;background:#ef4444;color:#fff;font-size:10px;font-weight:800;padding:2px 7px;border-radius:10px;min-width:18px;text-align:center;}
        .sidebar-footer{padding:16px 20px;border-top:1px solid #1e293b;}
        .sidebar-footer button{width:100%;padding:10px;background:transparent;border:1px solid #334155;color:#94a3b8;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:0.15s;}
        .sidebar-footer button:hover{background:#1e293b;color:#e2e8f0;}

        /* ===== 메인 콘텐츠 ===== */
        .main{flex:1;margin-left:260px;min-height:100vh;}
        .topbar{background:#fff;border-bottom:1px solid #e2e8f0;padding:0 32px;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
        .topbar h1{font-size:20px;font-weight:800;color:#0f172a;}
        .topbar-right{display:flex;align-items:center;gap:12px;}
        .topbar-right button{padding:8px 16px;border:1px solid #e2e8f0;background:#fff;border-radius:8px;font-size:13px;font-weight:600;color:#475569;cursor:pointer;transition:0.15s;}
        .topbar-right button:hover{background:#f8fafc;border-color:#cbd5e1;}
        .content{padding:28px 32px 60px;}
        .page-section{display:none;}
        .page-section.active{display:block;}

        /* ===== 카드 & 컴포넌트 ===== */
        .card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,0.04);}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid #f1f5f9;}
        .card-header h3{font-size:17px;font-weight:800;color:#0f172a;}

        /* 상품 그리드 (PC 4열) */
        .prod-grid{display:grid;grid-template-columns:repeat(4, 1fr);gap:20px;}
        .prod-card{background:#fff;border:1px solid #e2e8f0;border-radius:14px;overflow:hidden;transition:all 0.2s;}
        .prod-card:hover{box-shadow:0 12px 28px rgba(0,0,0,0.08);transform:translateY(-3px);}
        .prod-card .thumb{aspect-ratio:1/1;overflow:hidden;background:#f8fafc;position:relative;}
        .prod-card .thumb img{width:100%;height:100%;object-fit:cover;transition:transform 0.3s;}
        .prod-card:hover .thumb img{transform:scale(1.05);}
        .prod-card .thumb .status-tag{position:absolute;top:10px;left:10px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;}
        .tag-pending{background:#fef3c7;color:#92400e;}
        .tag-approved{background:#dcfce7;color:#166534;}
        .tag-rejected{background:#fee2e2;color:#b91c1c;}
        .prod-card .body{padding:16px;}
        .prod-card .body h4{font-size:14px;font-weight:700;margin-bottom:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#1e293b;}
        .prod-card .body .price{font-size:18px;font-weight:900;color:#6366f1;margin-bottom:8px;}
        .prod-card .body .meta{font-size:12px;color:#94a3b8;display:flex;gap:10px;}
        .prod-card .reject-msg{padding:8px 16px;background:#fef2f2;font-size:12px;color:#b91c1c;line-height:1.4;border-top:1px solid #fee2e2;}
        .prod-card .foot{display:flex;border-top:1px solid #f1f5f9;}
        .prod-card .foot button{flex:1;padding:11px;border:none;background:transparent;font-size:13px;font-weight:700;cursor:pointer;transition:0.15s;color:#64748b;}
        .prod-card .foot button:hover{background:#f8fafc;color:#6366f1;}
        .prod-card .foot button+button{border-left:1px solid #f1f5f9;}

        /* 등록 폼 (2컬럼) */
        .register-layout{display:grid;grid-template-columns:320px 1fr;gap:24px;align-items:start;}
        .form-group{margin-bottom:20px;}
        .form-group label{display:block;font-size:13px;font-weight:700;color:#475569;margin-bottom:7px;}
        .form-group label .required{color:#ef4444;margin-left:2px;}
        .form-input{width:100%;padding:11px 14px;border:1px solid #d1d5db;border-radius:10px;font-size:14px;font-family:inherit;background:#fff;transition:border-color 0.15s;}
        .form-input:focus{outline:none;border-color:#818cf8;box-shadow:0 0 0 3px rgba(129,140,248,0.15);}
        .form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
        .form-row-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}

        /* 이미지 업로드 */
        .img-upload{width:100%;aspect-ratio:1/1;border:2px dashed #d1d5db;border-radius:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;color:#94a3b8;transition:all 0.2s;background:#fafbfc;position:relative;overflow:hidden;}
        .img-upload:hover{border-color:#818cf8;color:#818cf8;background:#f5f3ff;}
        .img-upload img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
        .img-upload i{font-size:36px;margin-bottom:10px;}
        .img-upload span{font-size:13px;font-weight:600;}

        /* Quill 에디터 */
        .quill-wrap{border:1px solid #d1d5db;border-radius:12px;overflow:hidden;margin-bottom:10px;}
        .quill-wrap .ql-toolbar{background:#f8fafc;border:none;border-bottom:1px solid #e2e8f0;}
        .quill-wrap .ql-container{border:none;min-height:500px;font-family:'Pretendard',sans-serif;}
        .quill-wrap .ql-editor{padding:20px;font-size:14px;line-height:1.8;min-height:500px;}
        .quill-wrap .ql-editor p{margin-bottom:4px !important;}
        .lang-tabs{display:flex;gap:4px;margin-bottom:8px;}
        .lang-tab{padding:7px 18px;border:1px solid #d1d5db;border-radius:8px 8px 0 0;background:#f1f5f9;cursor:pointer;font-size:13px;font-weight:700;color:#64748b;transition:0.15s;}
        .lang-tab.active{background:#fff;border-bottom-color:#fff;color:#818cf8;}
        .lang-tab:hover{color:#818cf8;}

        /* 버튼 */
        .btn{padding:10px 20px;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.15s;display:inline-flex;align-items:center;gap:7px;}
        .btn-primary{background:#6366f1;color:#fff;}.btn-primary:hover{background:#4f46e5;box-shadow:0 4px 12px rgba(99,102,241,0.3);}
        .btn-success{background:#16a34a;color:#fff;}.btn-success:hover{background:#15803d;}
        .btn-outline{background:#fff;border:1px solid #d1d5db;color:#475569;}.btn-outline:hover{background:#f8fafc;}
        .btn-translate{background:#eff6ff;color:#1d4ed8;font-size:12px;padding:7px 14px;border-radius:8px;}.btn-translate:hover{background:#dbeafe;}
        .btn-lg{padding:14px 32px;font-size:16px;border-radius:12px;}

        /* 정산 요약 */
        .stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:24px;}
        .stat-box{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:24px;text-align:center;}
        .stat-box .stat-label{font-size:13px;color:#64748b;margin-bottom:10px;font-weight:600;}
        .stat-box .stat-value{font-size:32px;font-weight:900;}
        .stat-box.green .stat-value{color:#16a34a;}
        .stat-box.yellow .stat-value{color:#d97706;}
        .stat-box.purple .stat-value{color:#6366f1;}

        /* 테이블 */
        .data-table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border-radius:12px;overflow:hidden;border:1px solid #e2e8f0;}
        .data-table th{background:#f8fafc;padding:14px 16px;text-align:left;font-size:13px;color:#64748b;font-weight:700;border-bottom:1px solid #e2e8f0;}
        .data-table td{padding:14px 16px;border-bottom:1px solid #f8fafc;font-size:14px;color:#334155;}
        .data-table tr:last-child td{border-bottom:none;}
        .data-table tr:hover td{background:#f8fafc;}

        /* 안내 가이드 */
        .guide-card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:28px;margin-bottom:20px;}
        .guide-card h3{font-size:17px;font-weight:800;margin-bottom:14px;display:flex;align-items:center;gap:10px;}
        .guide-card h3 i{font-size:20px;}
        .guide-card li{font-size:14px;color:#475569;line-height:1.8;margin-bottom:4px;}
        .guide-card ol{padding-left:20px;}
        .guide-card ul{padding-left:20px;}
        .guide-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;}

        /* 안내 주의 박스 */
        .notice-box{border-radius:12px;padding:18px 20px;margin-bottom:16px;font-size:14px;line-height:1.6;}
        .notice-green{background:#f0fdf4;border:1px solid #bbf7d0;color:#166534;}
        .notice-orange{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;}

        /* 주문 카드 */
        .order-card{background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:20px;margin-bottom:14px;transition:0.15s;}
        .order-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.06);}
        .order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
        .order-body{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:10px;}
        .order-field label{font-size:11px;color:#94a3b8;font-weight:600;margin-bottom:2px;display:block;}
        .order-field .val{font-size:14px;font-weight:600;color:#1e293b;}

        /* 빈 상태 */
        .empty-state{text-align:center;padding:80px 20px;color:#94a3b8;}
        .empty-state i{font-size:48px;margin-bottom:16px;display:block;opacity:0.5;}
        .empty-state p{font-size:15px;margin-bottom:16px;}

        /* 뱃지 */
        .badge-sm{display:inline-block;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:700;}

        /* 모달 */
        .modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,0.6);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
        .modal-box{background:#fff;width:500px;max-width:92%;border-radius:20px;padding:32px;box-shadow:0 25px 50px rgba(0,0,0,0.15);}

        /* 모바일 토글 */
        .mobile-toggle{display:none;position:fixed;top:14px;left:14px;z-index:200;background:#0f172a;color:#fff;border:none;border-radius:10px;padding:10px 12px;font-size:18px;cursor:pointer;}

        /* 반응형 */
        @media(max-width:1024px){
            .prod-grid{grid-template-columns:repeat(3,1fr);}
            .register-layout{grid-template-columns:250px 1fr;}
            .guide-grid{grid-template-columns:1fr;}
        }
        @media(max-width:768px){
            .sidebar{transform:translateX(-100%);}
            .sidebar.open{transform:translateX(0);}
            .mobile-toggle{display:block;}
            .main{margin-left:0;}
            .topbar{padding:0 16px;}
            .content{padding:20px 16px;}
            .prod-grid{grid-template-columns:repeat(2,1fr);gap:12px;}
            .register-layout{grid-template-columns:1fr;}
            .stat-grid{grid-template-columns:1fr;}
            .order-body{grid-template-columns:1fr;}
            .form-row-3{grid-template-columns:1fr;}
        }
    </style>
</head>
<body>

<!-- 모바일 토글 -->
<button class="mobile-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')"><i class="fa-solid fa-bars"></i></button>

<!-- ===== 사이드바 ===== -->
<aside class="sidebar">
    <div class="sidebar-brand" onclick="location.href='index.html'">
        <i class="fa-solid fa-house"></i>
        <span>Home</span>
    </div>
    <div class="sidebar-user">
        <div class="user-name" id="userName">로딩 중...</div>
        <div class="user-email" id="userEmail"></div>
    </div>
    <nav class="sidebar-nav">
        <div class="nav-item active" onclick="switchTab('products', this)">
            <i class="fa-solid fa-box-open"></i> <span data-i18n="pt_tab_products">내 상품</span>
            <span class="badge" id="productCount" style="display:none;">0</span>
        </div>
        <div class="nav-item" onclick="switchTab('register', this)">
            <i class="fa-solid fa-plus-circle"></i> <span data-i18n="pt_tab_register">상품 등록</span>
        </div>
        <div class="nav-item" onclick="switchTab('orders', this)">
            <i class="fa-solid fa-clipboard-list"></i> <span data-i18n="pt_tab_orders">주문 관리</span>
        </div>
        <div class="nav-item" onclick="switchTab('settlement', this)">
            <i class="fa-solid fa-sack-dollar"></i> <span data-i18n="pt_tab_settlement">정산</span>
        </div>
        <div class="nav-item" onclick="switchTab('guide', this)">
            <i class="fa-solid fa-info-circle"></i> <span data-i18n="pt_tab_guide">안내</span>
        </div>
    </nav>
    <div class="sidebar-footer">
        <button onclick="location.href='index.html'"><i class="fa-solid fa-house"></i> <span data-i18n="pt_btn_home">홈으로 돌아가기</span></button>
    </div>
</aside>

<!-- ===== 메인 ===== -->
<div class="main">
    <div class="topbar">
        <h1 id="pageTitle" data-i18n="pt_tab_products">내 상품</h1>
        <div class="topbar-right">
            <button onclick="switchTab('register')" style="background:#6366f1;color:#fff;border-color:#6366f1;"><i class="fa-solid fa-plus"></i> <span data-i18n="pt_tab_register">상품 등록</span></button>
            <button onclick="logout()" style="color:#ef4444;border-color:#fca5a5;"><i class="fa-solid fa-right-from-bracket"></i> <span data-i18n="pt_btn_logout">로그아웃</span></button>
        </div>
    </div>
    <div class="content">

        <!-- ========== 내 상품 ========== -->
        <div id="page-products" class="page-section active">
            <div id="myProductGrid" class="prod-grid">
                <div style="grid-column:1/-1;text-align:center;padding:80px;color:#94a3b8;"><i class="fa-solid fa-spinner fa-spin fa-2x"></i></div>
            </div>
        </div>

        <!-- ========== 상품 등록 ========== -->
        <div id="page-register" class="page-section">
            <div class="register-layout">
                <!-- 좌측: 이미지 -->
                <div>
                    <div class="card" style="padding:20px;">
                        <label style="font-size:13px;font-weight:700;color:#475569;margin-bottom:10px;display:block;" data-i18n="pt_product_image">상품 이미지 <span style="color:#ef4444;">*</span></label>
                        <div class="img-upload" id="imgUploadBox" onclick="document.getElementById('regImageFile').click()">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                            <span data-i18n="pt_click_upload">클릭하여 업로드</span>
                        </div>
                        <input type="file" id="regImageFile" accept="image/*" style="display:none;" onchange="previewImage(this)">
                        <p style="font-size:11px;color:#94a3b8;margin-top:10px;text-align:center;" data-i18n="pt_image_hint">정사각형(1:1) 권장 / 최대 5MB</p>
                    </div>
                </div>

                <!-- 우측: 폼 -->
                <div>
                    <div class="card">
                        <!-- 카테고리 -->
                        <div class="form-group">
                            <label data-i18n="pt_category">카테고리 <span class="required">*</span></label>
                            <select id="regCategory" class="form-input"><option value="">...</option></select>
                        </div>

                        <!-- 상품명 -->
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:7px;">
                            <label style="font-size:13px;font-weight:700;color:#475569;margin:0;" data-i18n="pt_label_name">상품명 <span style="color:#ef4444;">*</span></label>
                            <button class="btn-translate" onclick="translateNames()"><i class="fa-solid fa-language"></i> <span data-i18n="pt_btn_translate">일괄 번역</span></button>
                        </div>
                        <div class="form-row-3" style="margin-bottom:20px;">
                            <input type="text" id="regNameKR" class="form-input" placeholder="한국어 상품명 *" data-i18n-placeholder="pt_product_name_kr">
                            <input type="text" id="regNameJP" class="form-input" placeholder="日本語商品名" data-i18n-placeholder="pt_product_name_jp">
                            <input type="text" id="regNameEN" class="form-input" placeholder="English Name" data-i18n-placeholder="pt_product_name_en">
                        </div>

                        <!-- 가격 -->
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:7px;">
                            <label style="font-size:13px;font-weight:700;color:#475569;margin:0;" data-i18n="pt_label_price">가격 <span style="color:#ef4444;">*</span></label>
                            <span style="font-size:11px;color:#818cf8;font-weight:600;" id="priceRateInfo"></span>
                        </div>
                        <div class="form-row-3" style="margin-bottom:20px;">
                            <input type="number" id="regPriceKRW" class="form-input" placeholder="원 (KRW)" data-i18n-placeholder="pt_price_krw" oninput="autoConvertPrice('KRW')">
                            <input type="number" id="regPriceJPY" class="form-input" placeholder="¥ (JPY)" data-i18n-placeholder="pt_price_jpy" oninput="autoConvertPrice('JPY')">
                            <input type="number" id="regPriceUSD" class="form-input" placeholder="$ (USD)" data-i18n-placeholder="pt_price_usd" step="0.01" oninput="autoConvertPrice('USD')">
                        </div>

                        <!-- 재고 / 배송 -->
                        <div class="form-row-2" style="margin-bottom:20px;">
                            <div class="form-group" style="margin:0;">
                                <label data-i18n="pt_label_stock">재고 수량 <span class="required">*</span></label>
                                <input type="number" id="regStock" class="form-input" value="100" min="0">
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label data-i18n="pt_shipping_info">배송 안내</label>
                                <input type="text" id="regShipping" class="form-input" placeholder="예: 주문 후 3~5일 내 출고" data-i18n-placeholder="pt_shipping_placeholder">
                            </div>
                        </div>
                    </div>

                    <!-- 상세설명 -->
                    <div class="card">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                            <label style="font-size:13px;font-weight:700;color:#475569;margin:0;" data-i18n="pt_label_desc">상품 상세설명</label>
                            <button class="btn-translate" onclick="translateDescs()"><i class="fa-solid fa-language"></i> <span data-i18n="pt_btn_translate">일괄 번역</span></button>
                        </div>
                        <div class="lang-tabs">
                            <div class="lang-tab active" onclick="switchDescLang('KR')" data-i18n="pt_description_kr">한국어 *</div>
                            <div class="lang-tab" onclick="switchDescLang('JP')" data-i18n="pt_description_jp">日本語</div>
                            <div class="lang-tab" onclick="switchDescLang('EN')" data-i18n="pt_description_en">English</div>
                        </div>
                        <div id="descEditorKR" class="quill-wrap"></div>
                        <div id="descEditorJP" class="quill-wrap" style="display:none;"></div>
                        <div id="descEditorEN" class="quill-wrap" style="display:none;"></div>

                        <div style="text-align:center;margin-top:28px;">
                            <button class="btn btn-primary btn-lg" onclick="submitProduct()" style="min-width:260px;" id="btnRegisterSubmit">
                                <i class="fa-solid fa-paper-plane"></i> <span data-i18n="pt_register_submit">등록 신청</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== 주문 관리 ========== -->
        <div id="page-orders" class="page-section">
            <div id="partnerOrderList">
                <div class="empty-state"><i class="fa-solid fa-spinner fa-spin"></i></div>
            </div>
        </div>

        <!-- ========== 정산 ========== -->
        <div id="page-settlement" class="page-section">
            <div class="stat-grid">
                <div class="stat-box green"><div class="stat-label" data-i18n="pt_eligible_amount">출금 가능</div><div class="stat-value" id="settleEligible">0</div></div>
                <div class="stat-box yellow"><div class="stat-label" data-i18n="pt_waiting_amount">대기중 (15일)</div><div class="stat-value" id="settleWaiting">0</div></div>
                <div class="stat-box purple"><div class="stat-label" data-i18n="pt_requested_amount">출금 신청됨</div><div class="stat-value" id="settleRequested">0</div></div>
            </div>
            <div class="notice-green notice-box" data-i18n="pt_commission_notice_full">
                <strong>국내 판매:</strong> 카드결제 3.4% + 판매수수료 6.6% = 총 10% 공제 후 지급 &nbsp;|&nbsp; 고객 수령확인 후 15일 경과 시 출금 가능
            </div>
            <div class="notice-orange notice-box" data-i18n="pt_overseas_notice">
                <strong>해외 판매:</strong> 통관수수료 + 해외배송 비용 20% 추가 공제 (국내 10% + 해외 20% = 총 30%)
            </div>
            <div style="text-align:right;margin-bottom:20px;">
                <button class="btn btn-primary" onclick="requestWithdrawal()">
                    <i class="fa-solid fa-money-bill-transfer"></i> <span data-i18n="pt_btn_withdraw">출금 요청</span>
                </button>
            </div>
            <table class="data-table">
                <thead><tr><th data-i18n="pt_th_date">날짜</th><th data-i18n="pt_th_product_code">상품코드</th><th style="text-align:right;" data-i18n="pt_th_order_amount">주문금액</th><th style="text-align:right;" data-i18n="pt_th_commission">수수료</th><th style="text-align:right;" data-i18n="pt_th_settlement">정산금액</th><th style="text-align:center;" data-i18n="pt_th_status">상태</th></tr></thead>
                <tbody id="settlementBody"></tbody>
            </table>
        </div>

        <!-- ========== 안내 ========== -->
        <div id="page-guide" class="page-section">
            <div class="guide-grid">
                <div class="guide-card">
                    <h3><i class="fa-solid fa-coins" style="color:#f59e0b;"></i> <span data-i18n="pt_guide_fee_title">수수료 안내</span></h3>
                    <ul>
                        <li data-i18n="pt_guide_fee_1">카드결제 3.4% + 판매수수료 6.6% = <strong>총 10%</strong></li>
                        <li data-i18n="pt_guide_fee_overseas">해외 판매: 국내 10% + 통관/해외배송 20% = <strong>총 30%</strong></li>
                        <li data-i18n="pt_guide_fee_3">주문금액에서 공제 후 지급됩니다.</li>
                    </ul>
                </div>
                <div class="guide-card">
                    <h3><i class="fa-solid fa-globe" style="color:#3b82f6;"></i> <span data-i18n="pt_guide_global_title">해외 판매 가격 기준</span></h3>
                    <ul>
                        <li data-i18n="pt_guide_global_kr"><strong>한국 파트너:</strong> 1,000원 → 200¥ / $2</li>
                        <li data-i18n="pt_guide_global_jp"><strong>일본 파트너:</strong> 100¥ → 2,000원 / $2</li>
                        <li data-i18n="pt_guide_global_us"><strong>미국 파트너:</strong> $1 → 2,000원 / 200¥</li>
                        <li data-i18n="pt_guide_global_margin">해외 판매 시 약 <strong>2배 마진</strong>으로 수익 극대화!</li>
                    </ul>
                </div>
                <div class="guide-card">
                    <h3><i class="fa-solid fa-calendar-check" style="color:#6366f1;"></i> <span data-i18n="pt_guide_settle_title">정산 및 입금일</span></h3>
                    <ul>
                        <li data-i18n="pt_guide_settle_1">고객 수령확인 후 <strong>15일 후</strong> 출금 가능</li>
                        <li data-i18n="pt_guide_settle_2">출금 시 <strong>세금계산서</strong> 첨부 필수</li>
                        <li data-i18n="pt_guide_settle_3">관리자 확인 후 <strong>5영업일 이내</strong> 입금</li>
                    </ul>
                </div>
                <div class="guide-card">
                    <h3><i class="fa-solid fa-truck-fast" style="color:#10b981;"></i> <span data-i18n="pt_guide_flow_title">판매 흐름</span></h3>
                    <ol>
                        <li data-i18n="pt_guide_flow_1">상품 등록 신청 (파트너)</li>
                        <li data-i18n="pt_guide_flow_2">관리자 승인 → 쇼핑몰 노출</li>
                        <li data-i18n="pt_guide_flow_3">고객 주문 → 주문관리에서 확인</li>
                        <li data-i18n="pt_guide_flow_4">배송 출발 처리</li>
                        <li data-i18n="pt_guide_flow_5">고객 수령확인 → 15일 대기</li>
                        <li data-i18n="pt_guide_flow_6">출금 요청 + 세금계산서 → 입금</li>
                    </ol>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- 출금 모달 -->
<div id="withdrawModal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="font-size:18px;font-weight:800;margin-bottom:20px;" data-i18n="pt_withdraw_title">출금 요청</h3>
        <div class="form-group"><label data-i18n="pt_wd_amount">출금 금액</label><input type="text" id="wdAmount" class="form-input" readonly style="background:#f1f5f9;font-weight:800;font-size:18px;"></div>
        <div class="form-group"><label data-i18n="pt_wd_bank">계좌 정보 (은행명 + 계좌번호) <span class="required">*</span></label><input type="text" id="wdBankInfo" class="form-input" placeholder="예: 국민은행 123-456-789012" data-i18n-placeholder="pt_wd_bank_ph"></div>
        <div class="form-group"><label data-i18n="pt_wd_holder">예금주 <span class="required">*</span></label><input type="text" id="wdHolder" class="form-input" placeholder="홍길동" data-i18n-placeholder="pt_wd_holder_ph"></div>
        <div class="form-group"><label data-i18n="pt_wd_tax_invoice">세금계산서 첨부 <span class="required">*</span></label><input type="file" id="wdTaxFile" accept=".pdf,.jpg,.png" class="form-input"></div>
        <div style="display:flex;gap:12px;margin-top:24px;">
            <button class="btn btn-outline" onclick="document.getElementById('withdrawModal').style.display='none'" style="flex:1;" data-i18n="pt_btn_cancel">취소</button>
            <button class="btn btn-primary" onclick="submitWithdrawal()" style="flex:1;" id="wdSubmitBtn" data-i18n="pt_wd_submit">신청하기</button>
        </div>
    </div>
</div>

<script type="module">
    import { sb, initConfig, currentUser } from './config.js?v=121';

    function fmtMoney(krw) {
        const cfg = window.SITE_CONFIG || {};
        const country = cfg.COUNTRY || 'KR';
        const rate = (cfg.CURRENCY_RATE && cfg.CURRENCY_RATE[country]) || 1;
        const converted = (krw || 0) * rate;
        if (country === 'JP') return '¥' + Math.floor(converted).toLocaleString();
        if (country === 'US') return '$' + converted.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
        return converted.toLocaleString() + '원';
    }

    let myUser = null;
    let myProfile = null;
    let currentWithdrawable = 0;
    let quillKR, quillJP, quillEN;
    const SITE_COUNTRY = () => (window.SITE_CONFIG?.COUNTRY || 'KR');

    // 번역 함수 초기화
    window.t = window.t || function(key, fallback) {
        return (window.translations && window.translations[key]) || fallback || key;
    };

    const pageTitles = {
        products: () => window.t('pt_tab_products', '내 상품'),
        register: () => window.t('pt_tab_register', '상품 등록'),
        orders: () => window.t('pt_tab_orders', '주문 관리'),
        settlement: () => window.t('pt_tab_settlement', '정산'),
        guide: () => window.t('pt_tab_guide', '안내')
    };

    const QUILL_TOOLBAR = [
        [{'header':[1,2,3,false]}],
        ['bold','italic','underline','strike'],
        [{'color':[]},{'background':[]}],
        [{'size':['small',false,'large','huge']}],
        [{'align':[]}],
        ['image','video','link'],
        [{'list':'ordered'},{'list':'bullet'}],
        ['clean']
    ];

    window.onload = async () => {
        await initConfig();
        await loadPartnerTranslations();
        initQuillEditors();
        initPriceInfo();
        await checkAuth();
    };

    // 번역 파일 로딩 + data-i18n 적용
    async function loadPartnerTranslations() {
        const c = SITE_COUNTRY();
        let lang = 'kr';
        if (c === 'JP') lang = 'ja';
        else if (c === 'US') lang = 'en';
        if (lang === 'kr') return; // 한국어는 기본값

        try {
            const res = await fetch(`long/${lang}_121.json?t=${Date.now()}`);
            if (!res.ok) return;
            const data = await res.json();
            window.translations = data;
            window.t = function(key, fallback) {
                return (window.translations && window.translations[key]) || fallback || key;
            };
            // data-i18n 적용
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (data[key]) el.innerHTML = data[key];
            });
            // placeholder 적용
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (data[key]) el.setAttribute('placeholder', data[key]);
            });
        } catch(e) { console.warn('Translation load failed:', e); }
    }

    function initQuillEditors() {
        quillKR = new Quill('#descEditorKR', { theme:'snow', modules:{toolbar:QUILL_TOOLBAR}, placeholder:'상품 상세설명을 입력하세요...' });
        quillJP = new Quill('#descEditorJP', { theme:'snow', modules:{toolbar:QUILL_TOOLBAR}, placeholder:'商品の詳細説明を入力してください...' });
        quillEN = new Quill('#descEditorEN', { theme:'snow', modules:{toolbar:QUILL_TOOLBAR}, placeholder:'Enter product description...' });

        [quillKR, quillJP, quillEN].forEach(q => {
            q.getModule('toolbar').addHandler('image', () => {
                const input = document.createElement('input');
                input.type = 'file'; input.accept = 'image/*';
                input.onchange = async () => {
                    const file = input.files[0]; if (!file) return;
                    const path = `products/desc_${Date.now()}_${Math.random().toString(36).slice(2,8)}.${file.name.split('.').pop()}`;
                    const { error } = await sb.storage.from('products').upload(path, file, {upsert:true});
                    if (error) return alert('업로드 실패: ' + error.message);
                    const { data } = sb.storage.from('products').getPublicUrl(path);
                    const range = q.getSelection(true);
                    q.insertEmbed(range.index, 'image', data.publicUrl);
                };
                input.click();
            });
            q.getModule('toolbar').addHandler('video', () => {
                let url = prompt('YouTube URL을 입력하세요:');
                if (!url) return;
                url = url.replace('watch?v=','embed/').replace('youtu.be/','www.youtube.com/embed/');
                const range = q.getSelection(true);
                q.insertEmbed(range.index, 'video', url);
            });
        });
    }

    function initPriceInfo() {
        const c = SITE_COUNTRY();
        const info = document.getElementById('priceRateInfo');
        if (c === 'JP') info.textContent = window.t('pt_rate_jp', '基準: 100¥ = 2,000원 = $2');
        else if (c === 'US') info.textContent = window.t('pt_rate_us', 'Rate: $1 = ₩2,000 = ¥200');
        else info.textContent = '기준: 1,000원 = ¥200 = $2';
    }

    // 가격 자동환산
    window.autoConvertPrice = function(from) {
        const krwEl = document.getElementById('regPriceKRW');
        const jpyEl = document.getElementById('regPriceJPY');
        const usdEl = document.getElementById('regPriceUSD');
        const c = SITE_COUNTRY();

        if (from === 'KRW') {
            const v = parseFloat(krwEl.value) || 0;
            if (c === 'KR') { jpyEl.value = Math.round(v * 0.2); usdEl.value = (v * 0.002).toFixed(2); }
            else if (c === 'JP') { jpyEl.value = Math.round(v * 0.1); usdEl.value = (v * 0.001).toFixed(2); }
            else { jpyEl.value = Math.round(v * 0.1); usdEl.value = (v * 0.0005).toFixed(2); }
        } else if (from === 'JPY') {
            const v = parseFloat(jpyEl.value) || 0;
            if (c === 'JP') { krwEl.value = Math.round(v * 20); usdEl.value = (v * 0.02).toFixed(2); }
            else if (c === 'KR') { krwEl.value = Math.round(v * 5); usdEl.value = (v * 0.01).toFixed(2); }
            else { krwEl.value = Math.round(v * 10); usdEl.value = (v * 0.01).toFixed(2); }
        } else {
            const v = parseFloat(usdEl.value) || 0;
            if (c === 'US') { krwEl.value = Math.round(v * 2000); jpyEl.value = Math.round(v * 200); }
            else if (c === 'KR') { krwEl.value = Math.round(v * 500); jpyEl.value = Math.round(v * 100); }
            else { krwEl.value = Math.round(v * 1000); jpyEl.value = Math.round(v * 100); }
        }
    };

    // 상품명 번역
    window.translateNames = async function() {
        const kr = document.getElementById('regNameKR').value.trim();
        if (!kr) return alert(window.t('pt_err_name_first', '한국어 상품명을 먼저 입력하세요.'));
        const btn = document.querySelector('.btn-translate');
        btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 번역중...';
        try {
            const [jp, en] = await Promise.all([translateText(kr, 'ko', 'ja'), translateText(kr, 'ko', 'en')]);
            if (jp) document.getElementById('regNameJP').value = jp;
            if (en) document.getElementById('regNameEN').value = en;
        } catch(e) { console.warn(e); alert(window.t('pt_translate_fail', '번역 실패. 수동으로 입력해주세요.')); }
        btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-language"></i> ' + window.t('pt_btn_translate', '일괄 번역');
    };

    // 상세설명 번역 (HTML 구조 보존)
    window.translateDescs = async function() {
        const krHtml = quillKR.root.innerHTML;
        const krText = quillKR.getText().trim();
        if (!krText) return alert(window.t('pt_err_desc_first', '한국어 설명을 먼저 입력하세요.'));
        const btns = document.querySelectorAll('.btn-translate');
        const btn = btns[1]; btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 번역중...';
        try {
            const [jpHtml, enHtml] = await Promise.all([
                translateHtml(krHtml, 'ko', 'ja'),
                translateHtml(krHtml, 'ko', 'en')
            ]);
            if (jpHtml) { quillJP.root.innerHTML = jpHtml; }
            if (enHtml) { quillEN.root.innerHTML = enHtml; }
        } catch(e) { console.warn(e); alert(window.t('pt_translate_fail', '번역 실패. 수동으로 입력해주세요.')); }
        btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-language"></i> ' + window.t('pt_btn_translate', '일괄 번역');
    };

    // HTML 구조 보존 번역
    async function translateHtml(html, from, to) {
        const parts = html.split(/(<[^>]+>)/g);
        const textParts = [];
        const textIndices = [];
        parts.forEach((p, i) => {
            if (!p.startsWith('<') && p.trim()) {
                textParts.push(p.trim());
                textIndices.push(i);
            }
        });
        if (textParts.length === 0) return html;
        const separator = ' ||| ';
        const joined = textParts.join(separator);
        const chunks = [];
        if (joined.length <= 500) {
            chunks.push(joined);
        } else {
            let current = '';
            textParts.forEach((t, i) => {
                const add = i === 0 ? t : separator + t;
                if ((current + add).length > 500 && current) { chunks.push(current); current = t; }
                else { current += add; }
            });
            if (current) chunks.push(current);
        }
        const translatedChunks = await Promise.all(chunks.map(c => translateText(c, from, to)));
        const translatedJoined = translatedChunks.filter(Boolean).join(separator);
        const translatedParts = translatedJoined.split(/\s*\|\|\|\s*/);
        translatedParts.forEach((t, i) => { if (i < textIndices.length) parts[textIndices[i]] = t; });
        return parts.join('');
    }

    async function translateText(text, from, to) {
        try {
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text.substring(0,500))}&langpair=${from}|${to}`);
            const data = await res.json();
            return data?.responseData?.translatedText || null;
        } catch(e) { return null; }
    }

    // 설명 탭 전환
    window.switchDescLang = function(lang) {
        document.querySelectorAll('.lang-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.quill-wrap').forEach(w => w.style.display = 'none');
        event.target.classList.add('active');
        document.getElementById('descEditor' + lang).style.display = 'block';
    };

    async function checkAuth() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) { alert(window.t ? window.t('msg_login_required') : '로그인이 필요합니다.'); location.href = 'index.html'; return; }
        myUser = user;
        const { data: profile } = await sb.from('profiles').select('*').eq('id', user.id).single();
        let role = (profile?.role || '').toLowerCase();
        if (role === 'partners') role = 'partner';
        const adminEmails = ['korea900@daum.net', 'korea900as@gmail.com'];
        if (adminEmails.includes((user.email||'').toLowerCase())) role = 'partner';
        const allowed = ['admin','franchise','partner','platinum'];
        if (!allowed.includes(role)) { alert(window.t ? window.t('pt_no_access') : '접근 권한이 없습니다.'); location.href = 'index.html'; return; }
        myProfile = profile;
        document.getElementById('userName').innerText = profile?.company_name || user.email.split('@')[0];
        document.getElementById('userEmail').innerText = user.email;
        loadMyProducts(); loadCategories(); loadPartnerOrders(); loadSettlement();
    }

    window.switchTab = function(tabId, navEl) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.sidebar-nav .nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('page-' + tabId).classList.add('active');
        if (navEl) navEl.classList.add('active');
        else {
            const items = document.querySelectorAll('.sidebar-nav .nav-item');
            const map = ['products','register','orders','settlement','guide'];
            const idx = map.indexOf(tabId);
            if (idx >= 0 && items[idx]) items[idx].classList.add('active');
        }
        const titleFn = pageTitles[tabId];
        document.getElementById('pageTitle').textContent = titleFn ? titleFn() : tabId;
        if (tabId === 'products') loadMyProducts();
        if (tabId === 'orders') loadPartnerOrders();
        if (tabId === 'settlement') loadSettlement();
        // 모바일에서 사이드바 닫기
        document.querySelector('.sidebar').classList.remove('open');
    };

    // ===== 탭1: 내 상품 =====
    async function loadMyProducts() {
        const grid = document.getElementById('myProductGrid');
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:80px;color:#94a3b8;"><i class="fa-solid fa-spinner fa-spin fa-2x"></i></div>';
        const { data, error } = await sb.from('admin_products').select('*').eq('partner_id', myUser.id).order('created_at', {ascending:false});
        grid.innerHTML = '';
        if (error || !data || data.length === 0) {
            grid.innerHTML = `<div style="grid-column:1/-1;" class="empty-state">
                <i class="fa-solid fa-box-open"></i>
                <p>${window.t('pt_no_products', '등록된 상품이 없습니다.')}</p>
                <button class="btn btn-primary" onclick="switchTab('register')"><i class="fa-solid fa-plus"></i> ${window.t('pt_first_register', '첫 상품 등록하기')}</button>
            </div>`;
            return;
        }
        const badge = document.getElementById('productCount');
        badge.textContent = data.length; badge.style.display = 'inline';

        data.forEach(p => {
            const tagClass = p.partner_status==='approved'?'tag-approved':p.partner_status==='rejected'?'tag-rejected':'tag-pending';
            const tagText = p.partner_status==='approved'?window.t('pt_product_approved','판매중'):p.partner_status==='rejected'?window.t('pt_product_rejected','반려'):window.t('pt_product_pending','심사중');
            const card = document.createElement('div'); card.className = 'prod-card';
            card.innerHTML = `
                <div class="thumb">
                    <img src="${p.img_url||''}" alt="${p.name}" onerror="this.style.background='#f1f5f9';">
                    <div class="status-tag ${tagClass}">${tagText}</div>
                </div>
                <div class="body">
                    <h4 title="${p.name}">${p.name}</h4>
                    <div class="price">${fmtMoney(p.price)}</div>
                    <div class="meta"><span>${window.t('pt_stock','재고')} ${p.stock_quantity||0}</span><span>${p.category||''}</span></div>
                </div>
                ${p.reject_reason ? `<div class="reject-msg"><strong>${window.t('pt_reject_reason','반려사유')}:</strong> ${p.reject_reason}</div>` : ''}
                <div class="foot">
                    <button onclick="editProduct('${p.code}')"><i class="fa-solid fa-pen"></i> ${window.t('pt_btn_edit','수정')}</button>
                    <button onclick="deleteProduct('${p.code}')" style="color:#ef4444;"><i class="fa-solid fa-trash"></i> ${window.t('pt_btn_delete','삭제')}</button>
                </div>`;
            grid.appendChild(card);
        });
    }

    window.editProduct = function(code) {
        alert(window.t('pt_edit_coming_soon', '수정 기능은 준비 중입니다. 삭제 후 재등록해 주세요.'));
    };

    window.deleteProduct = async function(code) {
        if (!confirm(window.t('pt_confirm_delete', '이 상품을 삭제하시겠습니까?'))) return;
        await sb.from('admin_products').delete().eq('code', code).eq('partner_id', myUser.id);
        loadMyProducts();
    };

    // ===== 탭2: 상품 등록 =====
    async function loadCategories() {
        const { data: topCats } = await sb.from('admin_top_categories').select('code, name').order('sort_order');
        const wholesaleTop = topCats?.find(t => t.code === 'wholesale');
        const sel = document.getElementById('regCategory');
        sel.innerHTML = `<option value="">-- ${window.t('pt_select_category', '카테고리 선택')} --</option>`;
        if (wholesaleTop) {
            const { data: subCats } = await sb.from('admin_categories').select('code, name').eq('top_category_code', wholesaleTop.code).order('sort_order');
            if (subCats) subCats.forEach(c => { const o = document.createElement('option'); o.value = c.code; o.textContent = c.name; sel.appendChild(o); });
        }
        if (sel.options.length <= 1) {
            const { data: allCats } = await sb.from('admin_categories').select('code, name').order('sort_order');
            if (allCats) allCats.forEach(c => { const o = document.createElement('option'); o.value = c.code; o.textContent = c.name; sel.appendChild(o); });
        }
    }

    window.previewImage = function(input) {
        if (!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = e => { document.getElementById('imgUploadBox').innerHTML = `<img src="${e.target.result}">`; };
        reader.readAsDataURL(input.files[0]);
    };

    window.submitProduct = async function() {
        const category = document.getElementById('regCategory').value;
        const nameKR = document.getElementById('regNameKR').value.trim();
        const priceKRW = parseInt(document.getElementById('regPriceKRW').value);
        const stock = parseInt(document.getElementById('regStock').value) || 0;
        const fileInput = document.getElementById('regImageFile');
        if (!category) return alert(window.t('pt_err_category', '카테고리를 선택하세요.'));
        if (!nameKR) return alert(window.t('pt_err_name', '상품명을 입력하세요.'));
        if (!priceKRW || priceKRW <= 0) return alert(window.t('pt_err_price', '가격을 입력하세요.'));
        if (!fileInput.files[0]) return alert(window.t('pt_err_image', '상품 이미지를 선택하세요.'));

        const btn = document.querySelector('#page-register .btn-lg');
        btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 처리중...';
        try {
            const file = fileInput.files[0];
            const ext = file.name.split('.').pop();
            const code = `PP_${myUser.id.substring(0,6)}_${Date.now()}`;
            const path = `products/${code}.${ext}`;
            const { error: upErr } = await sb.storage.from('products').upload(path, file, {upsert:true});
            if (upErr) throw upErr;
            const { data: urlData } = sb.storage.from('products').getPublicUrl(path);
            const { error: dbErr } = await sb.from('admin_products').insert({
                code, name: nameKR,
                name_jp: document.getElementById('regNameJP').value.trim() || null,
                name_us: document.getElementById('regNameEN').value.trim() || null,
                price: priceKRW,
                price_jp: parseInt(document.getElementById('regPriceJPY').value) || null,
                price_us: parseFloat(document.getElementById('regPriceUSD').value) || null,
                category, img_url: urlData.publicUrl,
                description: quillKR.root.innerHTML !== '<p><br></p>' ? quillKR.root.innerHTML : null,
                description_jp: quillJP.root.innerHTML !== '<p><br></p>' ? quillJP.root.innerHTML : null,
                description_us: quillEN.root.innerHTML !== '<p><br></p>' ? quillEN.root.innerHTML : null,
                partner_id: myUser.id, partner_status: 'pending',
                partner_shipping_info: document.getElementById('regShipping').value.trim() || null,
                stock_quantity: stock, is_general_product: true,
                addons: '', site_code: 'all', width_mm: 0, height_mm: 0, is_custom_size: false
            });
            if (dbErr) throw dbErr;
            alert(window.t('pt_register_success', '상품이 등록 신청되었습니다. 관리자 승인 후 판매가 시작됩니다.'));
            document.getElementById('regCategory').selectedIndex = 0;
            ['regNameKR','regNameJP','regNameEN','regPriceKRW','regPriceJPY','regPriceUSD','regShipping'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('regStock').value = '100';
            quillKR.setText(''); quillJP.setText(''); quillEN.setText('');
            document.getElementById('imgUploadBox').innerHTML = `<i class="fa-solid fa-cloud-arrow-up"></i><span>${window.t('pt_click_upload','클릭하여 업로드')}</span>`;
            document.getElementById('regImageFile').value = '';
            switchTab('products');
        } catch(e) { console.error(e); alert('오류: ' + e.message); }
        finally { btn.disabled = false; btn.innerHTML = `<i class="fa-solid fa-paper-plane"></i> ${window.t('pt_register_submit','등록 신청')}`; }
    };

    // ===== 탭3: 주문 관리 =====
    async function loadPartnerOrders() {
        const container = document.getElementById('partnerOrderList');
        container.innerHTML = '<div class="empty-state"><i class="fa-solid fa-spinner fa-spin"></i></div>';
        const { data: settlements } = await sb.from('partner_settlements').select('order_id, item_code, item_amount, settlement_status').eq('partner_id', myUser.id).order('created_at', {ascending:false});
        if (!settlements || settlements.length === 0) {
            container.innerHTML = `<div class="empty-state"><i class="fa-solid fa-clipboard-list"></i><p>${window.t('pt_no_orders','주문 내역이 없습니다.')}</p></div>`;
            return;
        }
        const orderIds = [...new Set(settlements.map(s => s.order_id))];
        const { data: orders } = await sb.from('orders').select('id, created_at, manager_name, phone, address, status').in('id', orderIds).order('created_at', {ascending:false});
        container.innerHTML = '';
        if (!orders || orders.length === 0) { container.innerHTML = '<div class="empty-state"><i class="fa-solid fa-inbox"></i><p>주문 없음</p></div>'; return; }
        orders.forEach(o => {
            const myS = settlements.filter(s => s.order_id === o.id);
            const amt = myS.reduce((s,i) => s + i.item_amount, 0);
            const statusColors = {'구매확정':'background:#dcfce7;color:#166534;','배송중':'background:#dbeafe;color:#1e40af;','접수됨':'background:#fef3c7;color:#92400e;','결제완료':'background:#fef3c7;color:#92400e;'};
            const sc = statusColors[o.status] || 'background:#f1f5f9;color:#64748b;';
            const canShip = ['접수됨','제작준비','임시작성','결제완료'].includes(o.status);
            const card = document.createElement('div'); card.className = 'order-card';
            card.innerHTML = `
                <div class="order-header">
                    <span style="font-size:13px;color:#94a3b8;">${new Date(o.created_at).toLocaleDateString()}</span>
                    <span class="badge-sm" style="${sc}">${o.status}</span>
                </div>
                <div class="order-body">
                    <div class="order-field"><label>${window.t('pt_recipient','수령인')}</label><div class="val">${o.manager_name||'-'}</div></div>
                    <div class="order-field"><label>${window.t('pt_contact','연락처')}</label><div class="val">${o.phone||'-'}</div></div>
                    <div class="order-field"><label>${window.t('pt_order_amount','주문금액')}</label><div class="val" style="color:#6366f1;font-weight:800;">${fmtMoney(amt)}</div></div>
                </div>
                <div style="font-size:13px;color:#64748b;margin-bottom:10px;"><i class="fa-solid fa-location-dot"></i> ${o.address||'-'}</div>
                ${canShip ? `<button class="btn btn-success" onclick="shipOrder('${o.id}')"><i class="fa-solid fa-truck"></i> ${window.t('pt_ship_now','배송 출발')}</button>` : ''}
            `;
            container.appendChild(card);
        });
    }

    window.shipOrder = async function(id) {
        if (!confirm(window.t('pt_confirm_ship', '배송 출발 처리하시겠습니까?'))) return;
        const { error } = await sb.from('orders').update({status:'배송중'}).eq('id', id);
        if (error) alert('Error: '+error.message); else { alert(window.t('pt_ship_success','배송 출발 처리됨')); loadPartnerOrders(); }
    };

    // ===== 탭4: 정산 =====
    async function loadSettlement() {
        const tbody = document.getElementById('settlementBody');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#94a3b8;">...</td></tr>';
        const { data } = await sb.from('partner_settlements').select('*').eq('partner_id', myUser.id).order('created_at', {ascending:false});
        let eligible=0, waiting=0, requested=0; let html='';
        if (!data || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:40px;color:#94a3b8;">${window.t('pt_no_settlement','정산 내역 없음')}</td></tr>`;
        } else {
            data.forEach(s => {
                const now = new Date(); let st='', sc='#94a3b8';
                if (s.settlement_status==='requested'||s.settlement_status==='withdrawn') { requested+=s.net_amount; st=window.t('pt_status_requested','출금신청됨'); sc='#6366f1'; }
                else if (s.settlement_status==='waiting' && s.withdrawal_eligible_at) {
                    const ed = new Date(s.withdrawal_eligible_at);
                    if (now >= ed) { eligible+=s.net_amount; st=window.t('pt_withdrawable','출금가능'); sc='#16a34a'; }
                    else { waiting+=s.net_amount; st=`D-${Math.ceil((ed-now)/(864e5))}`; sc='#d97706'; }
                } else { waiting+=s.net_amount; st=window.t('pt_status_pending_confirm','수령확인 대기'); }
                html += `<tr><td>${new Date(s.created_at).toLocaleDateString()}</td><td>${s.item_code}</td><td style="text-align:right;">${fmtMoney(s.item_amount)}</td><td style="text-align:right;color:#ef4444;">-${fmtMoney(s.commission_amount)}</td><td style="text-align:right;font-weight:700;color:#16a34a;">${fmtMoney(s.net_amount)}</td><td style="text-align:center;"><span style="color:${sc};font-weight:700;font-size:13px;">${st}</span></td></tr>`;
            });
            tbody.innerHTML = html;
        }
        document.getElementById('settleEligible').innerText = fmtMoney(eligible);
        document.getElementById('settleWaiting').innerText = fmtMoney(waiting);
        document.getElementById('settleRequested').innerText = fmtMoney(requested);
        currentWithdrawable = eligible;
    }

    window.requestWithdrawal = function() {
        if (currentWithdrawable <= 0) return alert(window.t('pt_no_eligible', '출금 가능 금액이 없습니다.'));
        document.getElementById('wdAmount').value = fmtMoney(currentWithdrawable);
        document.getElementById('withdrawModal').style.display = 'flex';
    };

    window.submitWithdrawal = async function() {
        const bankInfo = document.getElementById('wdBankInfo').value.trim();
        const holder = document.getElementById('wdHolder').value.trim();
        const fileInput = document.getElementById('wdTaxFile');
        if (!bankInfo) return alert(window.t('pt_err_bank', '계좌 정보를 입력하세요.'));
        if (!holder) return alert(window.t('pt_err_holder', '예금주를 입력하세요.'));
        if (!fileInput.files[0]) return alert(window.t('pt_err_tax', '세금계산서를 첨부하세요.'));
        const btn = document.getElementById('wdSubmitBtn');
        btn.disabled = true; btn.innerText = '...';
        try {
            const file = fileInput.files[0]; const ext = file.name.split('.').pop();
            const path = `tax_invoices/${myUser.id}_${Date.now()}.${ext}`;
            const { error: upErr } = await sb.storage.from('orders').upload(path, file);
            if (upErr) throw upErr;
            const { data: urlData } = sb.storage.from('orders').getPublicUrl(path);
            const { error: dbErr } = await sb.from('withdrawal_requests').insert({ user_id:myUser.id, amount:currentWithdrawable, bank_name:bankInfo, account_holder:holder, status:'pending', tax_invoice_url:urlData.publicUrl });
            if (dbErr) throw dbErr;
            await sb.from('partner_settlements').update({settlement_status:'requested'}).eq('partner_id',myUser.id).eq('settlement_status','waiting').lte('withdrawal_eligible_at',new Date().toISOString());
            alert(window.t('pt_wd_success', '출금 요청이 접수되었습니다.')); document.getElementById('withdrawModal').style.display='none'; loadSettlement();
        } catch(e) { alert('Error: '+e.message); }
        finally { btn.disabled=false; btn.innerText=window.t('pt_wd_submit','신청하기'); }
    };

    window.logout = async function() { await sb.auth.signOut(); location.href='index.html'; };
</script>
</body>
</html>
