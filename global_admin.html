<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chameleon Global Admin</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <link rel="stylesheet" href="global_admin.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<link rel="icon" href="data:;base64,iVBORw0KGgo">

<style>
.sidebar { display: flex; flex-direction: column; height: 100vh; }
.sidebar .nav-menu { flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: 10px; }
.sidebar .nav-menu::-webkit-scrollbar { width: 4px; }
.sidebar .nav-menu::-webkit-scrollbar-thumb { background: #4338ca; border-radius: 4px; }
</style>
</head>
<body>
<script src="toast.js?v=123"></script>

    <div id="loading"><div class="spinner"></div></div>
    
    <!-- 수동주문 모달 -->
    <div id="manualOrderModal" class="modal-overlay" style="display:none;">
        <div class="modal-box" style="width:520px; max-height:90vh; overflow-y:auto;">
            <div class="modal-header">
                <span>✏️ 수동주문 등록</span>
                <button class="btn btn-outline btn-sm" onclick="document.getElementById('manualOrderModal').style.display='none'"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div style="display:flex; flex-direction:column; gap:12px; padding:5px 0;">
                <!-- 주문출처 -->
                <div>
                    <label style="font-size:13px; font-weight:700; color:#334155; margin-bottom:4px; display:block;">📦 주문출처</label>
                    <select id="moSource" class="input-text" style="width:100%; padding:10px;">
                        <option value="STORE">🟢 스마트스토어</option>
                        <option value="GODO">🟣 고도몰</option>
                    </select>
                </div>
                <!-- 고객명 + 연락처 -->
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label style="font-size:13px; font-weight:700; color:#334155; margin-bottom:4px; display:block;">👤 고객명</label>
                        <input id="moName" class="input-text" type="text" placeholder="고객명" style="width:100%; padding:10px;">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:13px; font-weight:700; color:#334155; margin-bottom:4px; display:block;">📞 연락처</label>
                        <input id="moPhone" class="input-text" type="text" placeholder="010-0000-0000" style="width:100%; padding:10px;">
                    </div>
                </div>
                <!-- 주소 -->
                <div>
                    <label style="font-size:13px; font-weight:700; color:#334155; margin-bottom:4px; display:block;">📍 주소</label>
                    <input id="moAddress" class="input-text" type="text" placeholder="배송 주소" style="width:100%; padding:10px;">
                </div>
                <!-- 주문내역 -->
                <div>
                    <label style="font-size:13px; font-weight:700; color:#334155; margin-bottom:4px; display:block;">📋 주문내역</label>
                    <textarea id="moItems" class="input-text" rows="4" placeholder="상품명, 사이즈, 수량 등 자유롭게 입력&#10;예) 코팩스 현수막 1000x2000mm (2장)" style="width:100%; padding:10px; resize:vertical; font-family:inherit;"></textarea>
                </div>
                <!-- 주문총액 + 배송희망일 -->
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label style="font-size:13px; font-weight:700; color:#334155; margin-bottom:4px; display:block;">💰 주문총액 (원)</label>
                        <input id="moAmount" class="input-text" type="number" placeholder="0" style="width:100%; padding:10px;">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:13px; font-weight:700; color:#334155; margin-bottom:4px; display:block;">📅 배송희망일</label>
                        <input id="moDelivery" class="input-text" type="date" style="width:100%; padding:10px;">
                    </div>
                </div>
                <!-- 요청사항 -->
                <div>
                    <label style="font-size:13px; font-weight:700; color:#334155; margin-bottom:4px; display:block;">📝 요청사항</label>
                    <textarea id="moNote" class="input-text" rows="2" placeholder="요청사항 (선택)" style="width:100%; padding:10px; resize:vertical; font-family:inherit;"></textarea>
                </div>
                <!-- 파일첨부 -->
                <div>
                    <label style="font-size:13px; font-weight:700; color:#334155; margin-bottom:4px; display:block;">📎 파일첨부</label>
                    <input id="moFiles" type="file" multiple class="input-text" style="width:100%; padding:8px;">
                </div>
            </div>
            <button class="btn btn-primary" style="width:100%; margin-top:15px; padding:14px; font-size:16px; font-weight:700;" onclick="submitManualOrder()">📦 주문 등록</button>
        </div>
    </div>

    <div id="fileManagerModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span>📂 주문 파일 관리</span>
                <button class="btn btn-outline btn-sm" onclick="closeFileModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="fileMgrList" class="file-list-area"></div>
            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border: 1px dashed #bae6fd;">
                <div style="font-size: 12px; font-weight: bold; color: #0369a1; margin-bottom: 8px;">➕ 새 파일 추가</div>
                <div style="display: flex; gap: 8px;">
                    <input type="file" id="fileMgrInput" class="input-text" style="padding: 6px;">
                    <button class="btn btn-primary" onclick="uploadFileToOrder()">업로드</button>
                </div>
            </div>
        </div>
    </div>

    <div id="walletModal" class="modal-overlay" style="display:none;">
        <div class="modal-box" style="width: 400px;">
            <div class="modal-header">
                <span>💰 예치금 관리</span>
                <button class="btn btn-outline btn-sm" onclick="document.getElementById('walletModal').style.display='none'">✕</button>
            </div>
            <div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:15px; text-align:center;">
                <div id="walletTargetName" style="font-weight:bold; color:#334155;">-</div>
                <div style="font-size:12px; color:#64748b;">현재 잔액</div>
                <div id="walletTargetBalance" style="font-size:24px; font-weight:800; color:#6366f1;">0원</div>
            </div>
            <input type="hidden" id="walletTargetId">
            <input type="hidden" id="walletMode" value="add">
            <div class="form-group">
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <button class="btn btn-primary" style="flex:1;" onclick="setWalletMode('add')" id="btnWalletAdd">➕ 충전 (입금확인)</button>
                    <button class="btn btn-outline" style="flex:1;" onclick="setWalletMode('sub')" id="btnWalletSub">➖ 차감 (취소/회수)</button>
                </div>
                <label class="form-label">금액</label>
                <input type="number" id="walletAmount" class="input-text" placeholder="숫자만 입력">
            </div>
            <div class="form-group">
                <label class="form-label">사유 (고객에게도 보임)</label>
                <input type="text" id="walletDesc" class="input-text" placeholder="예: 무통장 입금 확인">
            </div>
            <button id="btnWalletSubmit" class="btn btn-vip" style="width:100%; margin-top:10px;" onclick="submitWalletChange()">적용하기</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header"><i class="fa-solid fa-earth-americas"></i> Global Admin</div>
        <ul class="nav-menu">
            <div class="nav-label">Business</div>
            <div class="nav-label">AI Chatbot</div>
            <li class="nav-item" onclick="showSection('sec-live-chat', this)"><i class="fa-solid fa-headset"></i> 💬 실시간 상담</li>
            <li class="nav-item" onclick="showSection('sec-chatbot', this)"><i class="fa-solid fa-robot"></i> 🦎 AI 챗봇 학습</li>

            <li class="nav-item active" onclick="showSection('sec-vip', this)" style="background: linear-gradient(90deg, #312e81 0%, #1e1b4b 100%); border: 1px solid #4338ca;">
                <i class="fa-solid fa-crown" style="color: #fbbf24;"></i> <span style="font-weight: bold; color: #fff;">VIP 대량 주문</span>
            </li>
            <li class="nav-item" onclick="showSection('sec-orders', this)"><i class="fa-solid fa-cart-shopping"></i> 통합 주문 관리</li>
            <li class="nav-item" onclick="showSection('sec-bankda', this)"><i class="fa-solid fa-won-sign"></i> 💰 뱅크다 입금내역</li>
            <li class="nav-item" onclick="showSection('sec-stats', this)"><i class="fa-solid fa-chart-line"></i> 매출 & 통계</li>
            <li class="nav-item" onclick="showSection('sec-tasks', this)"><i class="fa-solid fa-calendar-check"></i> 오늘 할일 (배송관리)</li>
            <li class="nav-item" onclick="showSection('sec-withdrawals', this)"><i class="fa-solid fa-hand-holding-dollar"></i> 출금 요청 관리</li>
            <li class="nav-item" onclick="showSection('sec-partner-apps', this)">
                <i class="fa-solid fa-store"></i> 파트너스 신청 관리 <span id="partnerPendingCount" class="badge" style="background:#ef4444; color:white; font-size:10px; display:none;">N</span>
            </li>
            <li class="nav-item" onclick="showSection('sec-partner-products', this)">
                <i class="fa-solid fa-box-check" style="color:#6366f1;"></i> 파트너 상품 심사 <span id="partnerProductPendingCount" class="badge" style="background:#f59e0b; color:white; font-size:10px; display:none;">0</span>
            </li>
            <li class="nav-item" onclick="showSection('sec-accounting', this)"><i class="fa-solid fa-calculator"></i> 📊 경리과 전용 (결산)</li>

            <div class="nav-label">Marketing</div>
            <li class="nav-item" onclick="location.href='marketing_bot.html'" style="color:#a78bfa;"><i class="fa-solid fa-robot" style="color:#a78bfa;"></i> 🤖 마케팅 봇</li>

            <div class="nav-label">Product & Stock</div>
            <li class="nav-item" onclick="showSection('sec-products', this); if(window.pfLoadFooter) pfLoadFooter('kr');"><i class="fa-solid fa-tags"></i> 상품 & 옵션</li>

            <div class="nav-label">Management</div>
            <li class="nav-item" onclick="showSection('sec-staff', this)"><i class="fa-solid fa-id-card"></i> 스태프 관리</li>
            <li class="nav-item" onclick="showSection('sec-members', this)"><i class="fa-solid fa-users"></i> 회원 관리</li>

            <div class="nav-label">Assets</div>
            <li class="nav-item" onclick="showSection('sec-templates', this)"><i class="fa-solid fa-palette"></i> 템플릿 & 로고</li>
            <li class="nav-item" onclick="showSection('sec-fonts', this)"><i class="fa-solid fa-font"></i> 폰트(서체) 관리</li>
        </ul>
        <div style="margin-top: auto; padding: 20px;">
            <button class="btn btn-danger" style="width: 100%;" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> 로그아웃</button>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="page-title">통합 주문 관리</div>
            <div style="font-size: 14px; color: #64748b;">Global Admin Connected 🟢</div>
        </div>

        <div class="content-scroll">
            
            <div id="sec-vip" class="section active">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
                        <h3 style="margin:0; display:flex; align-items:center; gap:10px; color: #312e81;">
                            <i class="fa-solid fa-crown" style="color:#fbbf24;"></i> VIP 파일 접수 내역
                        </h3>
                        <div>
                            <button class="btn btn-danger" onclick="deleteSelectedVipOrders()">선택 삭제</button>
                            <button class="btn btn-outline" onclick="loadVipOrders()"><i class="fa-solid fa-rotate"></i> 새로고침</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th width="30"><input type="checkbox" onchange="toggleVipChecks(this)"></th>
                                <th width="120">접수일시</th>
                                <th width="80">담당</th>
                                <th width="100">고객명</th>
                                <th width="130">연락처</th>
                                <th>메모 (요청사항)</th>
                                <th width="200">첨부파일 (다운로드)</th>
                                <th width="80">상태</th>
                                <th width="80">관리</th>
                            </tr>
                        </thead>
                        <tbody id="vipOrderListBody">
                            <tr><td colspan="8" style="text-align:center; padding:30px;">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="sec-orders" class="section">
                <div class="card">
                    <div style="display:flex; flex-direction:column; gap:15px; margin-bottom:20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="display:flex; gap:5px;">
                                <button class="btn btn-primary" id="btnFilterNew" onclick="filterOrders('접수됨', this)">📌 신규 접수</button>
                                <button class="btn btn-outline" id="btnFilterKnife" onclick="filterOrders('칼선작업', this)">✂️ 칼선/제작작업</button>
                                <button class="btn btn-outline" id="btnFilterDone" onclick="filterOrders('완료됨', this)">✅ 완료 (배송/수령)</button>
                            </div>
                            <div style="display:flex; gap:5px; align-items:center; background:#f0fdf4; padding:5px 10px; border-radius:8px; border:1px solid #bbf7d0;">
                                <span style="font-weight:bold;">매출정산 엑셀: </span>
<input type="month" id="excelMonth" class="input-text" style="width:130px; display:inline-block;" value="2026-01">
<button class="btn btn-success" onclick="downloadMonthlyExcel()">📊 다운로드</button>
                                </button>
                            </div>
                        </div>

                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; background:#f8fafc; padding:15px; border-radius:8px;">
                            <input type="text" id="orderSearchInput" class="input-text" placeholder="고객명/연락처 검색" style="width:180px;" onkeyup="if(event.key=='Enter') { resetPage(); loadOrders(); }">
                            <div style="display:flex; align-items:center; gap:5px; background:#fff; padding:5px 10px; border:1px solid #cbd5e1; border-radius:6px;">
                                <span style="font-size:12px; font-weight:bold; color:#334155;">📅 주문일:</span>
                                <input type="date" id="filterOrderDate" class="input-text" style="width:130px; height:32px; border:none;" onchange="resetPage(); loadOrders()">
                                <i class="fa-solid fa-xmark" style="cursor:pointer; color:#999;" onclick="document.getElementById('filterOrderDate').value=''; resetPage(); loadOrders();" title="초기화"></i>
                            </div>
                            <div style="display:flex; align-items:center; gap:5px; background:#f0f9ff; padding:5px 10px; border:1px solid #bae6fd; border-radius:6px;">
                                <span style="font-size:12px; font-weight:bold; color:#0369a1;">🚚 배송일:</span>
                                <input type="date" id="filterDeliveryDate" class="input-text" style="width:130px; height:32px; border:none; background:transparent;" onchange="resetPage(); loadOrders()">
                                <i class="fa-solid fa-xmark" style="cursor:pointer; color:#999;" onclick="document.getElementById('filterDeliveryDate').value=''; resetPage(); loadOrders();" title="초기화"></i>
                            </div>
                            <select id="filterSite" class="input-text" style="width:130px; font-weight:bold;" onchange="resetPage(); loadOrders()">
                                <option value="all">🌏 전체 국가</option>
                                <option value="KR">🇰🇷 한국</option>
                                <option value="JP">🇯🇵 일본</option>
                                <option value="US">🇺🇸 미국</option>
                                <option value="STORE">🟢 스마트스토어</option>
                                <option value="GODO">🟣 고도몰</option>
                            </select>
                            <button class="btn btn-primary" onclick="resetPage(); loadOrders()"><i class="fa-solid fa-magnifying-glass"></i> 조회</button>
                            <button class="btn btn-vip" onclick="openManualOrderModal()" style="font-weight:700;">✏️ 수동주문</button>
                            <div id="action-buttons" style="margin-left:auto; display:flex; gap:5px;"></div>
                        </div>
                        <div id="orderSummaryBar" style="display:flex; gap:20px; align-items:center; background:#eff6ff; border:1px solid #bfdbfe; color:#1e3a8a; padding:10px 15px; border-radius:6px; font-size:14px;">
                            <div>📦 검색된 주문: <b id="sumCount">0</b></div>
                            <div style="width:1px; height:15px; background:#bfdbfe;"></div>
                            <div>💰 총 매출(검색기준): <b id="sumRevenue" style="font-size:16px; color:#2563eb;">0원</b></div>
                            <div style="margin-left:auto; font-size:12px; color:#64748b;">* 페이지네이션과 관계없이 검색된 전체 합계입니다.</div>
                        </div>
                    </div>
                    <table style="margin:0; font-size:12px;">
                        <thead>
    <tr>
        <th style="width:30px;"><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></th>
        <th style="width:40px;">Site</th>
        <th style="width:60px;">날짜</th>
        <th style="width:110px;">고객 정보</th>
        <th style="width: 60px; text-align: center;">주문번호</th>
        <th style="">주문 내역</th> <th style="width:90px; text-align:center; background:#fff7ed;">입찰</th> 
        <th style="width:80px; text-align:right; background:#f8fafc;">주문총액</th>
        <th style="width:70px; text-align:right; color:#ef4444; background:#f8fafc;">할인액</th>
        <th style="width:70px; text-align:right; color:#d97706; background:#f8fafc;">예치금</th>
        <th style="width:80px; text-align:right; color:#15803d; background:#dcfce7;">실입금액</th>
        <th style="width:80px; background:#f0f9ff;">매니저/배송</th> <th style="width:50px; text-align:center;">파일</th> <th style="width:100px;">상태/결제</th>
    </tr>
</thead>
                        </thead>
                        <tbody id="orderListBody"></tbody>
                    </table>
                    <div style="display:flex; justify-content:center; align-items:center; gap:15px; margin-top:20px;">
                        <button class="btn btn-outline btn-sm" onclick="changePage(-1)">◀ 이전</button>
                        <span id="pageLabel" style="font-weight:bold; color:#334155;">Page 1</span>
                        <button class="btn btn-outline btn-sm" onclick="changePage(1)">다음 ▶</button>
                    </div>
                </div>
            </div>

            <div id="sec-bankda" class="section">
                <div class="card" style="margin-bottom:20px; background:#f0fdf4; border:1px solid #bbf7d0;">
                    <h3 style="margin-top:0; border-bottom:1px solid #bbf7d0; padding-bottom:15px; display:flex; align-items:center; gap:10px; color:#15803d;">
                        <i class="fa-solid fa-robot"></i> 페이엑션(국민은행) 입금 자동연동
                    </h3>
                    <div style="display:flex; gap:15px; align-items:flex-end;">
                        <div><label class="form-label">조회 시작일</label><input type="date" id="bankStartDate" class="input-text"></div>
                        <div><label class="form-label">조회 종료일</label><input type="date" id="bankEndDate" class="input-text"></div>
                        <button class="btn btn-success" style="height:42px;" onclick="loadBankdaList()"><i class="fa-solid fa-magnifying-glass"></i> DB 조회</button>
                        <button class="btn btn-primary" style="height:42px; margin-left:auto; background:#15803d; border:none;" onclick="runBankdaScraping()"><i class="fa-solid fa-rotate"></i> 국민은행 최신내역 가져오기</button>
                    </div>
                    <p style="font-size:12px; color:#166534; margin-top:10px; margin-bottom:0;">* [최신내역 가져오기] 버튼을 누르면 페이엑션을 통해 국민은행의 오늘 입금 내역을 조회하여 DB에 저장합니다.</p>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <h4 style="margin:0;">🏦 입금 내역 리스트 (DB: bank_transactions)</h4>
                        <span class="badge" style="background:#f1f5f9; color:#64748b;">자동매칭 포함</span>
                    </div>
                    <table>
                        <thead><tr><th width="150">거래일시</th><th width="120">입금자명</th><th width="120" style="text-align:right;">입금액</th><th width="120">은행/계좌</th><th width="100">매칭 상태</th><th>관리 (주문연동)</th></tr></thead>
                        <tbody id="bankListBody"><tr><td colspan="6" style="text-align:center; padding:30px;">조회 버튼을 눌러주세요.</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="sec-stats" class="section">
                <div class="card" style="margin-bottom:20px;">
                     <h3 style="margin-top:0; margin-bottom:15px; color:#1e293b;"><i class="fa-solid fa-chart-simple"></i> 실시간 매출 대시보드</h3>
                     
                     <div style="background:#1e1b4b; color:white; padding:20px; border-radius:12px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-size:14px; color:#a5b4fc; margin-bottom:5px;">📅 2024년 올해 누적 매출</div>
                            <div id="yearTotalRevenue" style="font-size:28px; font-weight:800;">0원</div>
                        </div>
                        <div style="font-size:40px; opacity:0.2;"><i class="fa-solid fa-sack-dollar"></i></div>
                     </div>

                     <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:15px;">
                            <h4 style="margin:0 0 10px 0; color:#475569;">📊 최근 7일 매출 (일별)</h4>
                            <div style="height:250px;"><canvas id="chartDaily"></canvas></div>
                        </div>
                        <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:15px;">
                            <h4 style="margin:0 0 10px 0; color:#475569;">📅 월별 매출 추이</h4>
                            <div style="height:250px;"><canvas id="chartMonthly"></canvas></div>
                        </div>
                     </div>
                </div>

                <div class="card" style="margin-bottom:20px;">
                    <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:15px; display:flex; align-items:center; gap:10px;">
                        <i class="fa-solid fa-calendar-days" style="color:#6366f1;"></i> 기간별 상세 검색
                    </h3>
                    <div style="display:flex; gap:10px; align-items:flex-end; background:#f8fafc; padding:20px; border-radius:8px;">
                        <div><label class="form-label">시작일</label><input type="date" id="statStartDate" class="input-text"></div>
                        <div><label class="form-label">종료일</label><input type="date" id="statEndDate" class="input-text"></div>
                        <button class="btn btn-primary" style="height:42px;" onclick="loadStatsData()"><i class="fa-solid fa-magnifying-glass"></i> 조회하기</button>
                    </div>
                </div>
                <div class="stat-card-group">
                    <div class="stat-card"><div class="stat-icon"><i class="fa-solid fa-won-sign"></i></div><div class="stat-info"><div>기간 내 총 매출 (검색결과)</div><div id="totalRevenue">0</div></div></div>
                    <div class="stat-card"><div class="stat-icon" style="background:#ecfdf5; color:#059669;"><i class="fa-solid fa-receipt"></i></div><div class="stat-info"><div>총 주문 건수</div><div id="totalCount">0건</div></div></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div class="card"><h4 style="margin-top:0;">👨‍💼 담당 매니저별 실적</h4><table style="margin-top:0;"><thead><tr><th>매니저</th><th style="text-align:right;">매출 기여도</th></tr></thead><tbody id="statManagerBody"></tbody></table></div>
                    <div class="card"><h4 style="margin-top:0;">🚚 배송 기사별 실적</h4><table style="margin-top:0;"><thead><tr><th>기사님</th><th style="text-align:right;">매출 기여도</th></tr></thead><tbody id="statDriverBody"></tbody></table></div>
                </div>
            </div>

            <div id="sec-tasks" class="section">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
                        <h3 style="margin:0; display:flex; align-items:center; gap:10px;"><i class="fa-solid fa-truck-fast" style="color:#6366f1;"></i> 날짜별 배송 스케줄</h3>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <select id="filterTaskDriver" class="input-text" style="width:200px; font-weight:bold;" onchange="loadDailyTasks()">
                                <option value="all">🚛 전체 기사 보기</option>
                            </select>
                            <input type="date" id="taskDate" class="input-text" style="width:140px;" onchange="loadDailyTasks()">
                            <button class="btn btn-primary" onclick="loadDailyTasks()">조회</button>
                        </div>
                    </div>
                    <table style="margin-top:0;">
                        <thead><tr><th style="width:90px; white-space:nowrap;">상태</th><th style="width:180px;">고객 정보 (이름/연락처)</th><th>주문 파일</th><th style="width:180px;">🚚 배송 기사 배정</th><th style="width:160px;">⏰ 시간 / 완료체크</th></tr></thead>
                        <tbody id="taskListBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="sec-withdrawals" class="section">
    <div class="card">
        <h3 style="margin-top:0;">💸 고객 출금 신청 목록</h3>
        <button class="btn btn-outline btn-sm" onclick="loadWithdrawals()">
            <i class="fa-solid fa-rotate"></i> 새로고침
        </button>
        <table>
            <thead>
                <tr>
                    <th width="90">신청일</th>
                    <th width="150">유저 (ID)</th>
                    <th>최근 업로드 (3건)</th>
                    <th style="text-align:right;">출금액</th>
                    <th width="160">기여 등급 / 메모(사유)</th>
                    <th>계좌정보 (은행/번호/예금주)</th> 
                    <th style="text-align:center;">상태</th>
                    <th style="text-align:center;">관리</th>
                </tr>
            </thead>
            <tbody id="withdrawalListBody"></tbody>
        </table>
    </div>
</div>
            <div id="sec-partner-apps" class="section">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;">
                        <h3 style="margin:0;">🏪 파트너스 신청 내역 관리</h3>
                        <div style="display:flex; gap:10px;">
                            <select id="filterPartnerStatus" class="input-text" style="width:120px; font-weight:bold;" onchange="loadPartnerApplications()">
                                <option value="all">📂 전체 보기</option>
                                <option value="pending" selected>⏳ 대기중</option>
                                <option value="approved">✅ 승인됨</option>
                                <option value="rejected">❌ 거절됨</option>
                            </select>
                            <button class="btn btn-outline btn-sm" onclick="loadPartnerApplications()">
                                <i class="fa-solid fa-rotate"></i> 새로고침
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th width="120">신청일</th>
                                <th>신청자 (이메일)</th>
                                <th>업체명 (상호)</th>
                                <th>연락처</th>
                                <th>희망 지역</th>
                                <th>주력 품목</th>
                                <th width="100">상태</th>
                                <th width="140">관리</th>
                            </tr>
                        </thead>
                        <tbody id="partnerAppListBody"><tr><td colspan="8" style="text-align:center; padding:30px;">로딩 중...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- 파트너 상품 심사 섹션 -->
            <div id="sec-partner-products" class="section">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;">
                        <h3 style="margin:0;">📦 파트너 상품 심사</h3>
                        <div style="display:flex; gap:10px;">
                            <select id="filterPartnerProdStatus" class="input-text" style="width:120px; font-weight:bold;" onchange="loadPartnerProducts()">
                                <option value="pending" selected>⏳ 심사 대기</option>
                                <option value="approved">✅ 승인됨</option>
                                <option value="rejected">❌ 반려됨</option>
                                <option value="all">📂 전체</option>
                            </select>
                            <button class="btn btn-outline btn-sm" onclick="loadPartnerProducts()">
                                <i class="fa-solid fa-rotate"></i> 새로고침
                            </button>
                        </div>
                    </div>
                    <div id="partnerProductList" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:16px;">
                        <div style="grid-column:1/-1; text-align:center; padding:40px; color:#94a3b8;">로딩 중...</div>
                    </div>
                </div>
                <!-- 반려 사유 모달 -->
                <div id="rejectReasonModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:none;align-items:center;justify-content:center;backdrop-filter:blur(2px);">
                    <div style="background:#fff;width:480px;max-width:90%;border-radius:16px;padding:30px;box-shadow:0 20px 25px rgba(0,0,0,0.15);">
                        <h3 style="margin:0 0 6px;font-size:18px;color:#b91c1c;"><i class="fa-solid fa-triangle-exclamation"></i> 상품 반려</h3>
                        <p style="margin:0 0 16px;font-size:13px;color:#64748b;" id="rejectProductName"></p>
                        <div style="margin-bottom:16px;">
                            <label style="font-size:13px;font-weight:700;color:#334155;display:block;margin-bottom:6px;">반려 사유 *</label>
                            <textarea id="rejectReasonText" class="input-text" style="width:100%;height:120px;resize:vertical;font-size:14px;padding:12px;" placeholder="파트너에게 전달될 반려 사유를 입력하세요...&#10;예: 이미지 해상도가 낮습니다. 최소 800x800px 이상의 이미지를 등록해 주세요."></textarea>
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button class="btn btn-outline" onclick="document.getElementById('rejectReasonModal').style.display='none'" style="flex:1;padding:10px;">취소</button>
                            <button class="btn btn-danger" onclick="confirmRejectProduct()" style="flex:1;padding:10px;background:#ef4444;color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer;">반려 확정</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-accounting" class="section">
                <div class="card" style="margin-bottom:20px; border-left:5px solid #059669;">
                    <div style="border-bottom:1px solid #e2e8f0; padding-bottom:15px; margin-bottom:15px;">
                        <h3 style="margin:0; display:flex; align-items:center; gap:10px; color:#059669;">
                            <i class="fa-solid fa-file-invoice-dollar"></i> 경리과 통합 결산 관리
                        </h3>
                    </div>
                    <div style="display:flex; gap:15px; align-items:flex-end; background:#f0fdf4; padding:20px; border-radius:8px;">
                        <div><label class="form-label">📅 조회 시작일</label><input type="date" id="accStartDate" class="input-text"></div>
                        <div><label class="form-label">📅 조회 종료일</label><input type="date" id="accEndDate" class="input-text"></div>
                        <button class="btn btn-primary" style="height:42px; padding:0 25px; font-size:14px;" onclick="loadAccountingData()"><i class="fa-solid fa-magnifying-glass"></i> 데이터 조회</button>
                    </div>
                    <p style="font-size:12px; color:#666; margin-top:10px; margin-bottom:0;">※ <b>결제완료, 입금확인, 카드결제완료</b> 상태인 주문만 매출로 집계됩니다.</p>
                </div>
                <div class="stat-card-group">
                    <div class="stat-card" style="display:block; padding:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                            <div style="display:flex; align-items:center; gap:8px;"><div class="stat-icon" style="width:40px; height:40px; font-size:18px; background:#dcfce7; color:#15803d;"><i class="fa-solid fa-won-sign"></i></div><div style="font-size:13px; font-weight:bold; color:#64748b;">기간 내 결제 총액</div></div>
                            <button class="btn btn-success btn-sm" onclick="downloadAccSales()" title="주문별 상세 엑셀"><i class="fa-solid fa-file-excel"></i> 엑셀</button>
                        </div>
                        <div id="accTotalSales" style="font-size:24px; font-weight:800; color:#0f172a; margin-top:5px;">0원</div>
                    </div>
                    <div class="stat-card" style="display:block; padding:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                            <div style="display:flex; align-items:center; gap:8px;"><div class="stat-icon" style="width:40px; height:40px; font-size:18px; background:#fef3c7; color:#d97706;"><i class="fa-solid fa-hand-holding-dollar"></i></div><div style="font-size:13px; font-weight:bold; color:#64748b;">미지급(정산대기) 총액</div></div>
                            <button class="btn btn-success btn-sm" onclick="downloadAccUnpaid()" title="미지급 계좌 엑셀"><i class="fa-solid fa-file-excel"></i> 엑셀</button>
                        </div>
                        <div id="accUnpaidTotal" style="font-size:24px; font-weight:800; color:#d97706; margin-top:5px;">0원</div>
                    </div>
                    <div class="stat-card" style="display:block; padding:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                            <div style="display:flex; align-items:center; gap:8px;"><div class="stat-icon" style="width:40px; height:40px; font-size:18px; background:#e0e7ff; color:#4338ca;"><i class="fa-solid fa-coins"></i></div><div style="font-size:13px; font-weight:bold; color:#64748b;">고객 예치금 (현재잔고)</div></div>
                            <button class="btn btn-success btn-sm" onclick="downloadAccDeposit()" title="예치금 보유자리스트"><i class="fa-solid fa-file-excel"></i> 엑셀</button>
                        </div>
                        <div id="accTotalDeposit" style="font-size:24px; font-weight:800; color:#4338ca; margin-top:5px;">0원</div>
                    </div>
                    <div class="stat-card" style="display:block; padding:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                            <div style="display:flex; align-items:center; gap:8px;"><div class="stat-icon" style="width:40px; height:40px; font-size:18px; background:#fee2e2; color:#ef4444;"><i class="fa-solid fa-tags"></i></div><div style="font-size:13px; font-weight:bold; color:#64748b;">기간 내 할인 총액</div></div>
                            <button class="btn btn-success btn-sm" onclick="downloadAccDiscount()" title="할인 내역 상세"><i class="fa-solid fa-file-excel"></i> 엑셀</button>
                        </div>
                        <div id="accTotalDiscount" style="font-size:24px; font-weight:800; color:#ef4444; margin-top:5px;">0원</div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div class="card">
                        <h4 style="margin-top:0; color:#1e40af;">🏢 [6] 가맹점/파트너스 입금요청 (세금계산서 O)</h4>
                        <div style="max-height:400px; overflow-y:auto;">
                            <table style="font-size:12px;">
                                <thead><tr><th>신청일</th><th>업체명(상호)</th><th style="text-align:right;">금액</th><th style="text-align:center;">증빙</th><th style="text-align:center;">상태</th></tr></thead>
                                <tbody id="accPartnerBody"><tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">조회 버튼을 눌러주세요.</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card">
                        <h4 style="margin-top:0; color:#c2410c;">🧑‍💻 [5] 프리랜서/디자이너 입금요청 (주민번호 O)</h4>
                        <div style="max-height:400px; overflow-y:auto;">
                            <table style="font-size:12px;">
                                <thead><tr><th>신청일</th><th>성명</th><th style="text-align:right;">금액</th><th style="text-align:center;">주민번호</th><th style="text-align:center;">상태</th></tr></thead>
                                <tbody id="accFreelancerBody"><tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">조회 버튼을 눌러주세요.</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-products" class="section">
    
    <div class="card" style="background:#fff7ed; border:1px solid #ffedd5; margin-bottom:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:#c2410c;">👑 대분류(Top Category) 관리</h3>
            <span style="font-size:12px; color:#c2410c;">* 드래그하여 순서 변경 가능</span>
        </div>
        
        <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; margin-bottom:15px;">
            <div style="flex:1; min-width:150px;">
                <label class="form-label">코드 (영문)</label>
                <input id="newTopCatCode" class="input-text" placeholder="예: banner_stand">
            </div>
            <div style="flex:1; min-width:150px;">
                <label class="form-label">🇰🇷 한국명</label>
                <input id="newTopCatName" class="input-text" placeholder="예: 배너거치대">
            </div>
            <div style="flex:1; min-width:150px;">
                <label class="form-label">🇯🇵 일본명</label>
                <input id="newTopCatNameJP" class="input-text">
            </div>
            <div style="flex:1; min-width:150px;">
                <label class="form-label">🇺🇸 미국명</label>
                <input id="newTopCatNameUS" class="input-text">
            </div>
            <div style="flex:1; min-width:150px;">
                <label class="form-label">🇨🇳 중국명</label>
                <input id="newTopCatNameCN" class="input-text">
            </div>
            <div style="flex:1; min-width:150px;">
                <label class="form-label">🇸🇦 아랍명</label>
                <input id="newTopCatNameAR" class="input-text">
            </div>
            <div style="flex:1; min-width:150px;">
                <label class="form-label">🇪🇸 스페인명</label>
                <input id="newTopCatNameES" class="input-text">
            </div>
            <div style="flex:1; min-width:150px;">
                <label class="form-label">🇩🇪 독일명</label>
                <input id="newTopCatNameDE" class="input-text">
            </div>
            <div style="flex:1; min-width:150px;">
                <label class="form-label">🇫🇷 프랑스명</label>
                <input id="newTopCatNameFR" class="input-text">
            </div>
            <div style="display:flex; align-items:center; padding-bottom:10px;">
    <label style="cursor:pointer; display:flex; align-items:center; gap:5px; font-weight:bold; color:#ef4444;">
        <input type="checkbox" id="newTopCatExcluded" style="width:18px; height:18px;">
        🚫 적립/할인 제외
    </label>
</div>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-outline" onclick="resetTopCategoryForm()" title="입력 초기화"><i class="fa-solid fa-rotate-left"></i></button>
                <button class="btn btn-vip" onclick="autoTranslateTopCategoryInputs()"><i class="fa-solid fa-language"></i></button>
                <button id="btnTopCatSave" class="btn btn-primary" onclick="addTopCategoryDB()" style="background:#f97316;">저장</button>
            </div>
        </div>

        <div id="topCategoryListArea" style="display:flex; flex-wrap:wrap; gap:8px; padding-top:15px; border-top:1px solid #ffedd5;"></div>
    </div>

    <div class="card" style="background:#f0f9ff; border:1px solid #bae6fd; margin-bottom:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:#0369a1;">0️⃣ 소분류(Sub Category) 관리</h3>
            <div style="display:flex; gap:10px; align-items:center;">
                <select id="filterCategoryTop" class="input-text" style="width:200px; font-weight:bold; color:#0369a1;" onchange="loadCategories()">
                    <option value="all">📂 전체 대분류 보기</option>
                </select>
            </div>
        </div>

        <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; margin-bottom:10px;">
            <div style="width:160px;">
                <label class="form-label">📂 대분류 선택</label>
                <select id="newCatTop" class="input-text" style="background:#fff;"><option value="">(상위 없음)</option></select>
            </div>
            <div style="flex:1; min-width:140px;">
                <label class="form-label">폴더 코드 (영문)</label>
                <input id="newCatCode" class="input-text" placeholder="예: honeycomb">
            </div>
            <div style="flex:1; min-width:140px;">
                <label class="form-label">🇰🇷 한국명</label>
                <input id="newCatName" class="input-text" placeholder="예: 허니콤">
            </div>
            <div style="flex:1; min-width:140px;">
                <label class="form-label">🇯🇵 일본명</label>
                <input id="newCatNameJP" class="input-text">
            </div>
            <div style="flex:1; min-width:140px;">
                <label class="form-label">🇺🇸 미국명</label>
                <input id="newCatNameUS" class="input-text">
            </div>
            <div style="flex:1; min-width:140px;">
                <label class="form-label">🇨🇳 중국명</label>
                <input id="newCatNameCN" class="input-text">
            </div>
            <div style="flex:1; min-width:140px;">
                <label class="form-label">🇸🇦 아랍명</label>
                <input id="newCatNameAR" class="input-text">
            </div>
            <div style="flex:1; min-width:140px;">
                <label class="form-label">🇪🇸 스페인명</label>
                <input id="newCatNameES" class="input-text">
            </div>
            <div style="flex:1; min-width:140px;">
                <label class="form-label">🇩🇪 독일명</label>
                <input id="newCatNameDE" class="input-text">
            </div>
            <div style="flex:1; min-width:140px;">
                <label class="form-label">🇫🇷 프랑스명</label>
                <input id="newCatNameFR" class="input-text">
            </div>
        </div>

        <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; margin-bottom:15px;">
            <div style="flex:2;">
                <label class="form-label">설명 (Description)</label>
                <div style="display:flex; gap:5px; flex-wrap:wrap;">
                    <input id="newCatDesc" class="input-text" placeholder="🇰🇷 설명 (선택)" style="flex:1; min-width:120px;">
                    <input id="newCatDescJP" class="input-text" placeholder="🇯🇵 설명" style="flex:1; min-width:120px;">
                    <input id="newCatDescUS" class="input-text" placeholder="🇺🇸 설명" style="flex:1; min-width:120px;">
                    <input id="newCatDescCN" class="input-text" placeholder="🇨🇳 설명" style="flex:1; min-width:120px;">
                    <input id="newCatDescAR" class="input-text" placeholder="🇸🇦 설명" style="flex:1; min-width:120px;">
                    <input id="newCatDescES" class="input-text" placeholder="🇪🇸 설명" style="flex:1; min-width:120px;">
                    <input id="newCatDescDE" class="input-text" placeholder="🇩🇪 설명" style="flex:1; min-width:120px;">
                    <input id="newCatDescFR" class="input-text" placeholder="🇫🇷 설명" style="flex:1; min-width:120px;">
                </div>
            </div>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-outline" onclick="resetCategoryForm()" title="입력 초기화"><i class="fa-solid fa-rotate-left"></i></button>
                <button class="btn btn-vip" onclick="autoTranslateCategoryInputs()"><i class="fa-solid fa-language"></i> 자동번역</button>
                <button id="btnCatSave" class="btn btn-primary" onclick="addCategoryDB()">저장</button>
            </div>
        </div>

        <div id="categoryListArea" style="display:flex; flex-wrap:wrap; gap:8px; padding-top:15px; border-top:1px solid #bae6fd;"></div>
    </div>

    <!-- ====== AI 상품 수집기 (경쟁사 크롤링) ====== -->
    <div class="card" style="background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); border: 2px solid #6366f1; margin-bottom: 20px; color: #fff;">
        <h3 style="margin-top:0; color:#c4b5fd; display:flex; align-items:center; gap:10px;">
            <i class="fa-solid fa-robot"></i> AI 상품 수집기 (경쟁사 크롤링)
            <span style="font-size:11px; background:#6366f1; padding:3px 10px; border-radius:20px;">BETA</span>
        </h3>

        <!-- 모드 탭 -->
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <button id="tabCrawlSingle" onclick="switchCrawlMode('single')" style="flex:1; padding:8px; border-radius:8px; border:2px solid #6366f1; background:#6366f1; color:#fff; font-weight:bold; cursor:pointer; font-size:13px;">
                <i class="fa-solid fa-link"></i> 단건 수집
            </button>
            <button id="tabCrawlBatch" onclick="switchCrawlMode('batch')" style="flex:1; padding:8px; border-radius:8px; border:2px solid #4338ca; background:transparent; color:#a5b4fc; font-weight:bold; cursor:pointer; font-size:13px;">
                <i class="fa-solid fa-list"></i> 일괄 수집
            </button>
        </div>

        <!-- ============ 단건 수집 모드 ============ -->
        <div id="crawlSingleMode">
            <!-- Step 1: URL 입력 -->
            <div id="crawlStep1" style="margin-bottom:15px;">
                <label style="font-size:13px; color:#a5b4fc; font-weight:bold;">STEP 1. 경쟁사 제품 URL 입력</label>
                <div style="display:flex; gap:8px; margin-top:8px;">
                    <input id="crawlUrl" class="input-text" placeholder="https://example.com/product/12345" style="flex:1; background:#1e1b4b; border:1px solid #4338ca; color:#fff;">
                    <button id="btnCrawlStart" class="btn btn-vip" onclick="startProductCrawl()" style="white-space:nowrap; min-width:120px;">
                        <i class="fa-solid fa-magnifying-glass"></i> 수집 시작
                    </button>
                </div>
                <div id="crawlStatus" style="font-size:12px; color:#a5b4fc; margin-top:5px;"></div>
            </div>

            <!-- Step 2: 수집 결과 미리보기 -->
            <div id="crawlStep2" style="display:none; background:rgba(255,255,255,0.05); border-radius:12px; padding:15px; margin-bottom:15px;">
                <label style="font-size:13px; color:#a5b4fc; font-weight:bold;">STEP 2. 수집 결과 확인 & 편집</label>
                <div style="display:flex; gap:15px; margin-top:10px; flex-wrap:wrap;">
                    <div style="width:200px; flex-shrink:0;">
                        <img id="crawlPreviewImg" style="width:200px; height:200px; object-fit:cover; border-radius:12px; border:2px solid #4338ca;" src="">
                        <div style="display:flex; gap:4px; margin-top:8px; flex-wrap:wrap;">
                            <button class="btn btn-sm" onclick="reimagineProduct('variation')" style="flex:1; background:#7c3aed; color:#fff; border:none; font-size:11px; padding:6px 4px; border-radius:6px; cursor:pointer;">
                                <i class="fa-solid fa-shuffle"></i> 변형
                            </button>
                            <button class="btn btn-sm" onclick="reimagineProduct('bg_change')" style="flex:1; background:#0891b2; color:#fff; border:none; font-size:11px; padding:6px 4px; border-radius:6px; cursor:pointer;">
                                <i class="fa-solid fa-image"></i> 배경교체
                            </button>
                            <button class="btn btn-sm" onclick="reimagineProduct('reimagine')" style="flex:1; background:#2563eb; color:#fff; border:none; font-size:11px; padding:6px 4px; border-radius:6px; cursor:pointer;">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> 재생성
                            </button>
                        </div>
                        <div id="reimagineStatus" style="font-size:11px; color:#a5b4fc; margin-top:5px;"></div>
                        <div id="crawlExtraImages" style="display:flex; flex-wrap:wrap; gap:4px; margin-top:8px;"></div>
                    </div>
                    <div style="flex:1; min-width:250px; display:flex; flex-direction:column; gap:8px;">
                        <input id="crawlName" class="input-text" placeholder="상품명" style="background:#1e1b4b; border:1px solid #4338ca; color:#fff;">
                        <div style="display:flex; gap:8px;">
                            <input id="crawlPrice" type="number" class="input-text" placeholder="가격(KRW)" style="flex:1; background:#1e1b4b; border:1px solid #4338ca; color:#fff;">
                            <input id="crawlCurrency" class="input-text" value="KRW" style="width:80px; background:#1e1b4b; border:1px solid #4338ca; color:#fff;" readonly>
                        </div>
                        <input id="crawlCategory" class="input-text" placeholder="추천 카테고리" style="background:#1e1b4b; border:1px solid #4338ca; color:#fff;">
                        <textarea id="crawlDesc" class="input-text" rows="2" placeholder="간단 설명" style="background:#1e1b4b; border:1px solid #4338ca; color:#fff; resize:vertical;"></textarea>
                        <div id="crawlSpecs" style="font-size:11px; color:#94a3b8;"></div>
                    </div>
                </div>
            </div>

            <!-- Step 3: 최종 액션 -->
            <div id="crawlStep3" style="display:none;">
                <label style="font-size:13px; color:#a5b4fc; font-weight:bold;">STEP 3. 상세페이지 생성 & 등록</label>
                <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
                    <button class="btn" onclick="generateCrawledDetail()" style="flex:1; min-width:200px; background:#059669; color:#fff; border:none; font-weight:bold; padding:10px; border-radius:8px; cursor:pointer;">
                        <i class="fa-solid fa-file-code"></i> AI 상세페이지 자동 생성 (6개 언어)
                    </button>
                    <button class="btn" onclick="applyCrawledToForm()" style="flex:1; min-width:200px; background:#f97316; color:#fff; border:none; font-weight:bold; padding:10px; border-radius:8px; cursor:pointer;">
                        <i class="fa-solid fa-arrow-down"></i> 아래 등록폼에 적용하기
                    </button>
                </div>
                <div id="detailGenStatus" style="font-size:12px; color:#a5b4fc; margin-top:5px;"></div>
            </div>
        </div>

        <!-- ============ 일괄 수집 모드 ============ -->
        <div id="crawlBatchMode" style="display:none;">
            <div style="margin-bottom:12px;">
                <label style="font-size:13px; color:#a5b4fc; font-weight:bold;">URL 목록 (한 줄에 하나씩)</label>
                <textarea id="batchUrls" class="input-text" rows="6" placeholder="https://example.com/product/1&#10;https://example.com/product/2&#10;https://example.com/product/3" style="margin-top:8px; background:#1e1b4b; border:1px solid #4338ca; color:#fff; resize:vertical; font-size:13px; line-height:1.6;"></textarea>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
                <div style="flex:1; min-width:200px;">
                    <label style="font-size:12px; color:#a5b4fc;">대분류</label>
                    <select id="batchTopCategory" class="input-text" onchange="loadBatchSubCategories()" style="background:#1e1b4b; border:1px solid #4338ca; color:#fff; margin-top:4px;">
                        <option value="">로딩 중...</option>
                    </select>
                </div>
                <div style="flex:1; min-width:200px;">
                    <label style="font-size:12px; color:#a5b4fc;">소분류</label>
                    <select id="batchSubCategory" class="input-text" style="background:#1e1b4b; border:1px solid #4338ca; color:#fff; margin-top:4px;">
                        <option value="">대분류를 먼저 선택</option>
                    </select>
                </div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; align-items:center;">
                <label style="display:flex; align-items:center; gap:6px; font-size:13px; color:#a5b4fc; cursor:pointer;">
                    <input type="checkbox" id="batchBgChange" checked style="accent-color:#6366f1;">
                    대표이미지 배경 교체 (AI)
                </label>
                <label style="display:flex; align-items:center; gap:6px; font-size:13px; color:#a5b4fc; cursor:pointer;">
                    <input type="checkbox" id="batchGenDetail" checked style="accent-color:#6366f1;">
                    상세페이지 자동 생성
                </label>
                <label style="display:flex; align-items:center; gap:6px; font-size:13px; color:#a5b4fc; cursor:pointer;">
                    <input type="checkbox" id="batchIsGeneral" checked style="accent-color:#6366f1;">
                    일반상품 (에디터 불필요)
                </label>
            </div>

            <button id="btnBatchStart" class="btn btn-vip" onclick="batchCrawlProducts()" style="width:100%; padding:12px; font-size:15px; font-weight:bold;">
                <i class="fa-solid fa-rocket"></i> 일괄 수집 & 자동 등록 시작
            </button>

            <!-- 진행 상황 -->
            <div id="batchProgress" style="display:none; margin-top:12px; background:rgba(255,255,255,0.05); border-radius:12px; padding:15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span style="font-size:13px; color:#a5b4fc; font-weight:bold;">진행 상황</span>
                    <span id="batchCount" style="font-size:13px; color:#fbbf24; font-weight:bold;">0 / 0</span>
                </div>
                <div style="background:#1e1b4b; border-radius:8px; height:8px; overflow:hidden;">
                    <div id="batchBar" style="background:linear-gradient(90deg, #6366f1, #a855f7); height:100%; width:0%; transition:width 0.3s;"></div>
                </div>
                <div id="batchLog" style="margin-top:10px; max-height:200px; overflow-y:auto; font-size:12px; color:#94a3b8; line-height:1.8;"></div>
            </div>
        </div>
    </div>
    <!-- ====== /AI 상품 수집기 ====== -->

    <div class="product-layout">
        <div class="card product-form">
            <h3 style="margin-top:0;">2️⃣ 상품 등록 (Product)</h3>
            
            <div class="form-group" style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                <label class="form-label">🌐 판매 국가</label>
                <select id="newProdSite" class="input-text" style="font-weight:bold; color:#6366f1;">
                    <option value="KR" selected>🇰🇷 한국</option>
                    <option value="JP">🇯🇵 일본</option>
                    <option value="US">🇺🇸 미국</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">카테고리</label><select id="newProdCategory" class="input-text"><option value="">로딩 중...</option></select></div>
            <div class="form-group"><label class="form-label">상품코드</label><input id="newProdCode" class="input-text" placeholder="고유 코드 입력"></div>
            
            <div class="form-group" style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <label class="form-label" style="margin:0;">상품명 & 가격 (다국어)</label>
                    <button class="btn btn-vip btn-sm" onclick="autoTranslateInputs()">자동번역</button>
                </div>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input id="newProdName" class="input-text" placeholder="🇰🇷 상품명" style="flex:2;">
                    <input id="newProdPrice" type="number" class="input-text" placeholder="₩ 가격" style="flex:1;">
                </div>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input id="newProdNameJP" class="input-text" placeholder="🇯🇵 일본어" style="flex:2;">
                    <input id="newProdPriceJP" type="number" class="input-text" placeholder="¥ 엔화" style="flex:1;">
                </div>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input id="newProdNameUS" class="input-text" placeholder="🇺🇸 영어" style="flex:2;">
                    <input id="newProdPriceUS" type="number" class="input-text" placeholder="$ 달러" style="flex:1;">
                </div>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input id="newProdNameCN" class="input-text" placeholder="🇨🇳 중국어" style="flex:2;">
                    <input id="newProdPriceCN" type="number" class="input-text" placeholder="¥ 위안" style="flex:1;">
                </div>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input id="newProdNameAR" class="input-text" placeholder="🇸🇦 아랍어" style="flex:2;">
                    <input id="newProdPriceAR" type="number" class="input-text" placeholder="﷼ 리알" style="flex:1;">
                </div>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input id="newProdNameES" class="input-text" placeholder="🇪🇸 스페인어" style="flex:2;">
                    <input id="newProdPriceES" type="number" class="input-text" placeholder="€ 유로" style="flex:1;">
                </div>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input id="newProdNameDE" class="input-text" placeholder="🇩🇪 독일어" style="flex:2;">
                    <input id="newProdPriceDE" type="number" class="input-text" placeholder="€ 유로" style="flex:1;">
                </div>
                <div style="display:flex; gap:5px;">
                    <input id="newProdNameFR" class="input-text" placeholder="🇫🇷 프랑스어" style="flex:2;">
                    <input id="newProdPriceFR" type="number" class="input-text" placeholder="€ 유로" style="flex:1;">
                </div>
            </div>

            <div class="input-row">
                <div style="flex:1;"><label class="form-label">가로(mm)</label><input id="newProdW" type="number" class="input-text"></div>
                <div style="flex:1;"><label class="form-label">세로(mm)</label><input id="newProdH" type="number" class="input-text"></div>
            </div>

            <div class="form-group">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:bold;">
                    <input type="checkbox" id="newProdIsCustom" style="width:18px; height:18px;"> 사이즈 입력 허용 (헤베 계산)
                </label>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:bold; margin-top:5px; color:#059669;">
    <input type="checkbox" id="newProdIsGeneral" style="width:18px; height:18px;"> 체크금지
    <button id="btnEmergencyReset" class="btn btn-danger btn-sm" onclick="resetAllGeneralProducts()" style="background:#ef4444; border-color:#dc2626; margin-left: 10px;">
    🚫 '일반상품' 설정 전체 해제 (복구)
</button>
</label>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:bold; margin-top:5px; color:#ef4444;">
                    <input type="checkbox" id="newProdIsHotDeal" style="width:18px; height:18px;"> 🔥 핫딜 상품
                </label>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:bold; margin-top:5px; color:#4f46e5;">
                    <input type="checkbox" id="newProdIsBizDeal" style="width:18px; height:18px;"> 💼 업자용 핫딜
                </label>
            </div>

            <div class="form-group" style="margin-top: 25px; padding: 18px; background: #f8fafc; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);">
    <label class="form-label" style="font-weight: 800; color: #1e1b4b; display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
        <i class="fa-solid fa-file-circle-plus" style="color: #6366f1;"></i> 럭셔리 상세페이지 편집
    </label>
    <button type="button" class="btn btn-vip" style="width: 100%; height: 50px; font-size: 15px; font-weight: 800; background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%); border: none; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);" onclick="window.openDetailPageEditor()">
        <i class="fa-solid fa-wand-magic-sparkles"></i> 상세페이지 제작
    </button>
    <button type="button" class="btn" style="width:100%; height:50px; margin-top:8px; font-size:15px; font-weight:800; background:linear-gradient(135deg,#f59e0b,#d97706); color:#fff; border:none; border-radius:12px; box-shadow:0 4px 12px rgba(245,158,11,0.3); cursor:pointer;" onclick="window.openDetailWizard()">
        <i class="fa-solid fa-hat-wizard"></i> AI 상세페이지 마법사
    </button>
    <input type="hidden" id="newProdDetailKR">
    <input type="hidden" id="newProdDetailJP">
    <input type="hidden" id="newProdDetailUS">
    <input type="hidden" id="newProdDetailCN">
    <input type="hidden" id="newProdDetailAR">
    <input type="hidden" id="newProdDetailES">
    <input type="hidden" id="newProdDetailDE">
    <input type="hidden" id="newProdDetailFR">
</div>

<div id="detailEditorModal" class="modal-overlay" style="z-index: 40000; display: none;">
    <div class="modal-box" style="width: 1100px; max-width: 98%; height: 92vh; display: flex; flex-direction: column; padding: 0; background: #fff; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">
        <div style="background: #1e1b4b; color: #fff; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; flex-shrink:0;">
            <h3 style="margin:0; font-size: 20px; font-weight: 900;"><i class="fa-solid fa-pen-to-square"></i> 상세페이지 마스터 에디터</h3>
            <div style="display: flex; gap: 12px;">
                <button type="button" class="btn" onclick="window.saveDetailAndClose()" style="background: #10b981; color:#fff; border: none; padding: 10px 25px; font-weight:800;">작업 완료 후 닫기</button>
                <button type="button" class="btn" onclick="document.getElementById('detailEditorModal').style.display='none'" style="background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.3);">취소</button>
            </div>
        </div>

        <div style="background: #f1f5f9; padding: 12px 30px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: flex-end; gap: 5px; flex-shrink:0;">
            <button type="button" id="tabKR" class="pop-editor-tab active" onclick="window.switchPopupLang('KR')">🇰🇷 한국어</button>
            <button type="button" id="tabJP" class="pop-editor-tab" onclick="window.switchPopupLang('JP')">🇯🇵 日本語</button>
            <button type="button" id="tabUS" class="pop-editor-tab" onclick="window.switchPopupLang('US')">🇺🇸 English</button>
            <button type="button" id="tabCN" class="pop-editor-tab" onclick="window.switchPopupLang('CN')">🇨🇳 中文</button>
            <button type="button" id="tabAR" class="pop-editor-tab" onclick="window.switchPopupLang('AR')">🇸🇦 العربية</button>
            <button type="button" id="tabES" class="pop-editor-tab" onclick="window.switchPopupLang('ES')">🇪🇸 Español</button>
            <button type="button" id="tabDE" class="pop-editor-tab" onclick="window.switchPopupLang('DE')">🇩🇪 Deutsch</button>
            <button type="button" id="tabFR" class="pop-editor-tab" onclick="window.switchPopupLang('FR')">🇫🇷 Français</button>
            <button type="button" class="btn btn-vip btn-sm" onclick="window.autoTranslatePopupDetail()" style="margin-left: auto; height: 34px; margin-bottom: 5px; font-size: 12px;">
                <i class="fa-solid fa-language"></i> KR 본문으로 전체 자동번역
            </button>
        </div>

        <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column; position: relative;">
            <div id="popup-quill-editor" style="height: 100%; font-size: 16px; border: none;"></div>
        </div>
    </div>
</div>

<style>
    .pop-editor-tab {
        padding: 12px 24px; border-radius: 12px 12px 0 0; border: 1px solid #e2e8f0; border-bottom: none;
        background: #cbd5e1; font-size: 14px; font-weight: 800; color: #475569; cursor: pointer; transition: 0.2s;
    }
    .pop-editor-tab.active { background: #fff; color: #6366f1; border-top: 4px solid #6366f1; height: 45px; }
    #popup-quill-editor .ql-toolbar { border: none !important; background: #fff; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #e2e8f0 !important; }
    #popup-quill-editor .ql-container { border: none !important; flex: 1; overflow-y: auto; }
    #popup-quill-editor .ql-editor { padding: 40px; min-height: 100%; max-width: 900px; margin: 0 auto; background: #fff; }
</style>

<!-- ★ AI 상세페이지 마법사 모달 -->
<div id="wizardModal" class="modal-overlay" style="z-index:41000; display:none;">
<div class="modal-box" style="width:1100px; max-width:98%; height:94vh; display:flex; flex-direction:column; padding:0; background:#fff; border-radius:24px; box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);">

<!-- Header -->
<div style="background:linear-gradient(135deg,#f59e0b,#d97706); color:#fff; padding:18px 28px; display:flex; justify-content:space-between; align-items:center; flex-shrink:0; border-radius:24px 24px 0 0;">
    <h3 style="margin:0; font-size:20px; font-weight:900;"><i class="fa-solid fa-hat-wizard"></i> AI 상세페이지 마법사</h3>
    <div style="display:flex; gap:8px;">
        <button type="button" class="btn" onclick="window.wizReset && window.wizReset()" style="background:rgba(255,255,255,0.15); color:#fff; border:1px solid rgba(255,255,255,0.3); padding:8px 16px; font-weight:700; border-radius:8px; font-size:13px;"><i class="fa-solid fa-rotate-right"></i> 초기화</button>
        <button type="button" class="btn" onclick="document.getElementById('wizardModal').style.display='none'" style="background:rgba(255,255,255,0.2); color:#fff; border:1px solid rgba(255,255,255,0.4); padding:8px 20px; font-weight:700; border-radius:8px;">닫기</button>
    </div>
</div>

<!-- Body (scrollable) -->
<div style="flex:1; overflow-y:auto; padding:24px 28px;">

    <!-- 1. 이미지 업로드 -->
    <div style="margin-bottom:24px;">
        <label style="font-size:16px; font-weight:800; color:#1e1b4b; display:flex; align-items:center; gap:8px; margin-bottom:12px;">
            <i class="fa-solid fa-images" style="color:#f59e0b;"></i> 사진 업로드 (여러 장)
        </label>
        <div id="wizImgZone" style="border:2px dashed #d1d5db; border-radius:12px; padding:24px; text-align:center; cursor:pointer; background:#fafafa; transition:0.2s;"
             ondragover="event.preventDefault(); this.style.borderColor='#f59e0b'; this.style.background='#fffbeb';"
             ondragleave="this.style.borderColor='#d1d5db'; this.style.background='#fafafa';"
             ondrop="event.preventDefault(); this.style.borderColor='#d1d5db'; this.style.background='#fafafa'; window.wizAddImages(event.dataTransfer.files);"
             onclick="document.getElementById('wizFileInput').click();">
            <i class="fa-solid fa-cloud-arrow-up" style="font-size:32px; color:#9ca3af; margin-bottom:8px;"></i>
            <div style="color:#6b7280; font-size:14px;">클릭 또는 드래그하여 사진을 올려주세요</div>
            <div style="color:#9ca3af; font-size:12px; margin-top:4px;">JPG, PNG, WebP (최대 20장)</div>
        </div>
        <input type="file" id="wizFileInput" accept="image/*" multiple style="display:none;" onchange="window.wizAddImages(this.files); this.value='';">

        <div id="wizImgGrid" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:12px;"></div>
        <div style="color:#9ca3af; font-size:12px; margin-top:6px;"><i class="fa-solid fa-hand-pointer"></i> 클릭하면 썸네일로 지정됩니다 (녹색 테두리)</div>
    </div>

    <!-- 2. 상품 정보 -->
    <div style="margin-bottom:24px; background:#f8fafc; padding:20px; border-radius:12px; border:1px solid #e2e8f0;">
        <label style="font-size:16px; font-weight:800; color:#1e1b4b; display:flex; align-items:center; gap:8px; margin-bottom:14px;">
            <i class="fa-solid fa-pen" style="color:#6366f1;"></i> 상품 정보
        </label>
        <div style="display:flex; gap:12px; margin-bottom:12px;">
            <div style="flex:1;">
                <label style="font-size:13px; font-weight:600; color:#475569; margin-bottom:4px; display:block;">상품명 (한국어)</label>
                <input id="wizTitle" class="input-text" placeholder="예: 프리미엄 허니콤보드 A1" style="width:100%; padding:10px 14px; font-size:14px;">
            </div>
            <div style="flex:1;">
                <label style="font-size:13px; font-weight:600; color:#475569; margin-bottom:4px; display:block;">카테고리</label>
                <select id="wizCategory" class="input-text" style="width:100%; padding:10px 14px; font-size:14px;"><option value="">로딩 중...</option></select>
            </div>
        </div>
        <div style="display:flex; gap:12px; margin-bottom:12px;">
            <div style="flex:1;">
                <label style="font-size:13px; font-weight:600; color:#475569; margin-bottom:4px; display:block;">가격 (원, KRW)</label>
                <input id="wizPrice" type="number" class="input-text" placeholder="예: 50000" style="width:100%; padding:10px 14px; font-size:14px;">
            </div>
            <div style="flex:1;">
                <label style="font-size:13px; font-weight:600; color:#475569; margin-bottom:4px; display:block;">레퍼런스 / 참고 내용</label>
                <input id="wizRef" class="input-text" placeholder="제품 특징, 소재, 용도 등" style="width:100%; padding:10px 14px; font-size:14px;">
            </div>
        </div>
    </div>

    <!-- 3. 기존 상품 적용 옵션 -->
    <div style="margin-bottom:24px; background:#fefce8; padding:16px 20px; border-radius:12px; border:1px solid #fde68a;">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:700; color:#854d0e; font-size:14px;">
            <input type="checkbox" id="wizExistingCheck" onchange="document.getElementById('wizExistingWrap').style.display=this.checked?'block':'none';">
            기존 등록된 상품에 적용하기
        </label>
        <div id="wizExistingWrap" style="display:none; margin-top:12px;">
            <input id="wizExistingSearch" class="input-text" placeholder="상품명 또는 코드로 검색..." style="width:100%; padding:10px 14px; font-size:14px; margin-bottom:8px;" oninput="window.wizFilterProducts && window.wizFilterProducts(this.value)">
            <select id="wizExistingSelect" class="input-text" size="6" style="width:100%; padding:6px; font-size:14px;" onchange="window.wizOnSelectExisting && window.wizOnSelectExisting(this)">
                <option value="">검색 결과가 여기에 표시됩니다...</option>
            </select>
            <div id="wizExistingInfo" style="display:none; margin-top:8px; padding:10px; background:#fff; border-radius:8px; border:1px solid #e2e8f0; font-size:13px; color:#475569;"></div>
            <!-- 기존 상품 바로 블로그+쇼츠 버튼 -->
            <div id="wizDirectPipeline" style="display:none; margin-top:12px; padding:16px; background:linear-gradient(135deg,#0f172a,#1e1b4b); border-radius:12px; text-align:center;">
                <p style="color:#a5b4fc; font-size:12px; margin-bottom:8px;">이미 상세페이지가 있는 상품 → 바로 블로그 + 쇼츠 실행</p>
                <button id="wizDirectPipeBtn" type="button" onclick="window.wizRunDirectPipeline()" style="padding:14px 36px; font-size:15px; font-weight:900; background:linear-gradient(135deg,#10b981,#059669); color:#fff; border:none; border-radius:12px; cursor:pointer; box-shadow:0 4px 14px rgba(16,185,129,0.4);">
                    <i class="fa-solid fa-bolt"></i> 블로그 + 쇼츠만 바로 실행
                </button>
            </div>
        </div>
    </div>

    <!-- 4. 생성 버튼 -->
    <div style="text-align:center; margin-bottom:24px;">
        <button id="wizGenerateBtn" type="button" onclick="window.wizGenerate()" style="padding:16px 48px; font-size:17px; font-weight:900; background:linear-gradient(135deg,#6366f1,#4338ca); color:#fff; border:none; border-radius:14px; cursor:pointer; box-shadow:0 6px 20px rgba(99,102,241,0.4); transition:0.2s;">
            <i class="fa-solid fa-robot"></i> AI 상세페이지 생성
        </button>
        <div id="wizStatus" style="margin-top:10px; font-size:13px; color:#6b7280;"></div>
    </div>

    <!-- 5. 미리보기 영역 -->
    <div id="wizPreviewSection" style="display:none; margin-bottom:20px;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
            <h4 style="margin:0; font-size:16px; font-weight:800; color:#1e1b4b;"><i class="fa-solid fa-eye"></i> 생성 결과 미리보기</h4>
        </div>
        <div id="wizLangTabs" style="display:flex; gap:4px; margin-bottom:12px; flex-wrap:wrap;">
            <button type="button" class="wiz-lang-tab active" onclick="window.wizPreviewLang('kr')">🇰🇷 한국어</button>
            <button type="button" class="wiz-lang-tab" onclick="window.wizPreviewLang('jp')">🇯🇵 日本語</button>
            <button type="button" class="wiz-lang-tab" onclick="window.wizPreviewLang('us')">🇺🇸 English</button>
            <button type="button" class="wiz-lang-tab" onclick="window.wizPreviewLang('cn')">🇨🇳 中文</button>
            <button type="button" class="wiz-lang-tab" onclick="window.wizPreviewLang('ar')">🇸🇦 العربية</button>
            <button type="button" class="wiz-lang-tab" onclick="window.wizPreviewLang('es')">🇪🇸 Español</button>
            <button type="button" class="wiz-lang-tab" onclick="window.wizPreviewLang('de')">🇩🇪 Deutsch</button>
            <button type="button" class="wiz-lang-tab" onclick="window.wizPreviewLang('fr')">🇫🇷 Français</button>
        </div>
        <div id="wizPreview" style="border:1px solid #e2e8f0; border-radius:12px; padding:30px; background:#fff; min-height:300px; max-height:600px; overflow-y:auto; line-height:1.8; font-size:15px;"></div>

        <div style="display:flex; gap:10px; margin-top:16px; justify-content:center;">
            <button type="button" onclick="window.wizApplyToForm()" style="padding:12px 32px; font-size:15px; font-weight:800; background:#10b981; color:#fff; border:none; border-radius:10px; cursor:pointer;">
                <i class="fa-solid fa-clipboard-check"></i> 새 상품 폼에 적용
            </button>
            <button type="button" onclick="window.wizApplyToExisting()" id="wizApplyExistingBtn" style="display:none; padding:12px 32px; font-size:15px; font-weight:800; background:#f59e0b; color:#fff; border:none; border-radius:10px; cursor:pointer;">
                <i class="fa-solid fa-database"></i> 기존 상품에 저장
            </button>
            <button type="button" onclick="window.wizOpenInEditor()" style="padding:12px 32px; font-size:15px; font-weight:800; background:#6366f1; color:#fff; border:none; border-radius:10px; cursor:pointer;">
                <i class="fa-solid fa-pen-to-square"></i> 에디터에서 수정
            </button>
        </div>

        <!-- 원클릭 자동 파이프라인 버튼 -->
        <div style="text-align:center; margin-top:20px; padding:20px; background:linear-gradient(135deg,#0f172a,#1e1b4b); border-radius:14px;">
            <p style="color:#a5b4fc; font-size:13px; margin-bottom:10px;">상세페이지 저장 + 8개국 블로그 + 일본어 쇼츠 자동 제작</p>
            <button id="wizPipelineBtn" type="button" onclick="window.wizRunPipeline()" style="padding:16px 48px; font-size:17px; font-weight:900; background:linear-gradient(135deg,#f59e0b,#dc2626); color:#fff; border:none; border-radius:14px; cursor:pointer; box-shadow:0 6px 20px rgba(245,158,11,0.4); transition:0.2s;">
                <i class="fa-solid fa-rocket"></i> 원클릭 자동 파이프라인
            </button>
        </div>
    </div>

    <!-- 6. 파이프라인 진행 상태 -->
    <div id="wizPipelineSection" style="display:none; margin-bottom:20px;">
        <h4 style="margin:0 0 14px; font-size:16px; font-weight:800; color:#1e1b4b;">
            <i class="fa-solid fa-gears"></i> 자동 파이프라인 진행 상태
        </h4>
        <div id="wizPipelineSteps" style="display:flex; flex-direction:column; gap:6px; font-size:13px;">
            <div id="wp-save" class="wp-step"><i class="fa-solid fa-circle-notch"></i> 상품 저장</div>
            <div id="wp-blog-kr" class="wp-step"><i class="fa-solid fa-circle-notch"></i> 블로그 (한국어)</div>
            <div id="wp-blog-ja" class="wp-step"><i class="fa-solid fa-circle-notch"></i> 블로그 (日本語)</div>
            <div id="wp-blog-en" class="wp-step"><i class="fa-solid fa-circle-notch"></i> 블로그 (English)</div>
            <div id="wp-blog-cn" class="wp-step"><i class="fa-solid fa-circle-notch"></i> 블로그 (中文)</div>
            <div id="wp-blog-ar" class="wp-step"><i class="fa-solid fa-circle-notch"></i> 블로그 (العربية)</div>
            <div id="wp-blog-es" class="wp-step"><i class="fa-solid fa-circle-notch"></i> 블로그 (Español)</div>
            <div id="wp-blog-de" class="wp-step"><i class="fa-solid fa-circle-notch"></i> 블로그 (Deutsch)</div>
            <div id="wp-blog-fr" class="wp-step"><i class="fa-solid fa-circle-notch"></i> 블로그 (Français)</div>
            <div id="wp-shorts-ai" class="wp-step"><i class="fa-solid fa-circle-notch"></i> 쇼츠 AI 콘텐츠</div>
            <div id="wp-shorts-tts" class="wp-step"><i class="fa-solid fa-circle-notch"></i> 쇼츠 TTS 음성</div>
            <div id="wp-shorts-render" class="wp-step"><i class="fa-solid fa-circle-notch"></i> 쇼츠 영상 렌더링</div>
            <div id="wp-shorts-upload" class="wp-step"><i class="fa-solid fa-circle-notch"></i> 쇼츠 YouTube 업로드</div>
        </div>
        <div id="wizPipelineResult" style="margin-top:14px; padding:14px; background:#f1f5f9; border-radius:10px; font-size:13px; display:none;"></div>
    </div>

</div>
</div>
</div>

<!-- 쇼츠 렌더링용 숨김 캔버스 -->
<canvas id="wizShortsCanvas" width="1080" height="1920" style="position:fixed;left:-9999px;top:0;width:1080px;height:1920px;"></canvas>

<style>
.wiz-lang-tab { padding:8px 16px; border-radius:8px; border:1px solid #e2e8f0; background:#f1f5f9; font-size:13px; font-weight:700; color:#475569; cursor:pointer; transition:0.15s; }
.wiz-lang-tab.active { background:#6366f1; color:#fff; border-color:#6366f1; }
.wiz-img-card { position:relative; width:120px; height:120px; border-radius:10px; overflow:hidden; border:3px solid #e2e8f0; cursor:pointer; transition:0.2s; flex-shrink:0; }
.wiz-img-card.thumb { border-color:#10b981; box-shadow:0 0 0 3px rgba(16,185,129,0.3); }
.wiz-img-card img { width:100%; height:100%; object-fit:cover; }
.wiz-img-card .wiz-thumb-badge { position:absolute; top:4px; left:4px; background:#10b981; color:#fff; font-size:10px; font-weight:800; padding:2px 6px; border-radius:4px; }
.wiz-img-card .wiz-remove-btn { position:absolute; top:4px; right:4px; background:rgba(0,0,0,0.6); color:#fff; width:22px; height:22px; border-radius:50%; border:none; font-size:12px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.wp-step { padding:8px 14px; background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0; color:#64748b; display:flex; align-items:center; gap:8px; }
.wp-step.active { background:#eff6ff; border-color:#3b82f6; color:#1d4ed8; font-weight:700; }
.wp-step.active i { animation: spin 1s linear infinite; }
.wp-step.done { background:#f0fdf4; border-color:#22c55e; color:#15803d; }
.wp-step.done i::before { content:"\f058"; }
.wp-step.error { background:#fef2f2; border-color:#ef4444; color:#dc2626; }
.wp-step.error i::before { content:"\f06a"; }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>

            <div class="form-group">
                <label class="form-label">이미지</label>
                <div class="file-drop-zone"><input type="file" id="newProdFile" accept="image/*" onchange="previewProductImage(this)"><span>이미지 업로드</span></div>
                <input id="newProdImg" class="input-text" style="margin-top:5px;" placeholder="URL 직접입력 가능">

                <img id="prodPreview" class="preview-img">
            </div>

            <!-- 칼선 / 목업 업로드 -->
            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label class="form-label">✂️ 칼선 파일</label>
                    <div style="display:flex; gap:5px;">
                        <input type="file" id="newProdCutlineFile" style="display:none;" accept=".pdf,.ai,.eps,.svg,image/*" onchange="window.previewCutlineFile(this)">
                        <button class="btn btn-outline btn-sm" onclick="document.getElementById('newProdCutlineFile').click()" style="flex:1;">파일 찾기</button>
                        <button class="btn btn-outline btn-sm" id="btnCutlineClear" onclick="window.clearCutline()" style="display:none; color:#ef4444;">✕</button>
                    </div>
                    <input id="newProdCutlineUrl" class="input-text" style="margin-top:5px; font-size:11px;" placeholder="칼선 URL">
                    <div id="cutlineStatus" style="font-size:11px; color:#16a34a; margin-top:3px;"></div>
                </div>
                <div style="flex:1;">
                    <label class="form-label">🖼 목업 이미지</label>
                    <div style="display:flex; gap:5px;">
                        <input type="file" id="newProdMockupFile" style="display:none;" accept="image/*" onchange="window.previewMockupFile(this)">
                        <button class="btn btn-outline btn-sm" onclick="document.getElementById('newProdMockupFile').click()" style="flex:1;">파일 찾기</button>
                        <button class="btn btn-outline btn-sm" id="btnMockupClear" onclick="window.clearMockup()" style="display:none; color:#ef4444;">✕</button>
                    </div>
                    <input id="newProdMockupUrl" class="input-text" style="margin-top:5px; font-size:11px;" placeholder="목업 URL">
                    <img id="mockupPreview" style="max-width:100%; max-height:80px; margin-top:5px; border-radius:6px; display:none;">
                </div>
            </div>

            <div class="form-group">
    <label class="form-label" style="display:flex; justify-content:space-between; align-items:center;">
        옵션 연결 (카테고리별 선택)
        <button type="button" class="btn btn-outline btn-sm" onclick="addCategorySelectRow()" style="font-size: 11px; padding: 4px 8px; border-style: dashed;">
            <i class="fa-solid fa-plus"></i> 카테고리 추가
        </button>
    </label>
    
    <div id="dynamicCategoryContainer" style="display: flex; flex-direction: column; gap: 15px; margin-top: 10px;"></div>

    <button class="btn btn-sky btn-sm" onclick="bulkApplyAddonsToCategory()" style="width:100%; margin-top:15px; font-weight:bold;">
        <i class="fa-solid fa-layer-group"></i> 현재 체크된 옵션 구성으로 카테고리 전체 적용
    </button>
</div>

            <button id="btnProductSave" class="btn btn-primary" style="width:100%;" onclick="addProductDB()">상품 등록하기</button>
            <div style="margin-top:10px; display:flex; gap:5px;">
                <button id="btnCancelEdit" class="btn btn-outline" style="flex:1; display:none;" onclick="resetProductForm()">취소</button>
                <button id="btnCloneProduct" class="btn btn-vip" style="flex:1; display:none;" onclick="cloneProductMode()">
                    <i class="fa-regular fa-copy"></i> 복제하여 등록
                </button>
            </div>
            <button id="btnBatchFillDetail" class="btn" onclick="batchFillDetailPages()" style="width:100%; margin-top:10px; background:#059669; color:#fff; border:none; font-weight:bold; padding:10px; border-radius:8px; cursor:pointer;">
                <i class="fa-solid fa-file-lines"></i> 상세페이지 일괄 생성 (빈 상품)
            </button>
        </div> <div class="product-grid-area" style="flex: 1.5; display: flex; flex-direction: column; gap: 20px;">
            
            <div class="card" style="margin-bottom:0; border-left: 5px solid #6366f1;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0; color:#1e1b4b;"><i class="fa-solid fa-layer-group"></i> 1️⃣ 옵션 & 카테고리 마스터</h3>
        <div style="display:flex; gap:5px;">
            <button class="btn btn-outline btn-sm" onclick="openAddonCatManager()">➕ 새 분류 추가</button>
            <button class="btn btn-vip btn-sm" onclick="autoTranslateAddonInputs()"><i class="fa-solid fa-language"></i> 전체 자동번역</button>
        </div>
    </div>

    <div style="background:#f0f9ff; border:1px dashed #bae6fd; border-radius:8px; padding:10px; margin-bottom:20px;">
        <div style="font-size:12px; font-weight:bold; color:#0369a1; margin-bottom:8px;">📂 카테고리 순서 관리 (드래그하여 변경)</div>
        <div id="addonCategoryListArea" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
    </div>

    <div style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:20px;">
                    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                        <div style="width:200px;">
    <label class="form-label">📂 카테고리 선택</label>
    <div style="display:flex; gap:5px;">
        <select id="newAddonCatCode" class="input-text" style="font-weight:bold; flex:1;"></select>
        <button class="btn btn-outline btn-sm" onclick="editCurrentAddonCategory()" title="선택한 분류 번역/수정" style="padding: 0 8px; color:#6366f1; border-color:#6366f1;">
            <i class="fa-solid fa-pen"></i>
        </button>
        <button class="btn btn-outline btn-sm" onclick="openAddonCatManager()" title="새 분류 추가" style="padding: 0 8px;">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>
</div>
                        <div style="width:120px;">
                            <label class="form-label">고유 코드</label>
                            <input id="newAddonCode" class="input-text" placeholder="예: matte_finish">
                        </div>
                        <div style="flex:1; min-width:200px;">
                            <label class="form-label">🖼 이미지 업로드</label>
                            <div style="display:flex; gap:5px;">
                                <input type="file" id="newAddonFile" style="display:none;" onchange="previewAddonImage(this)">
                                <button class="btn btn-outline btn-sm" onclick="document.getElementById('newAddonFile').click()">파일 찾기</button>
                                <input type="text" id="newAddonImgUrl" class="input-text" placeholder="이미지 주소" style="flex:1; font-size:11px;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="display:flex; gap:10px; margin-top:12px;">
                        <div style="flex:1;"><label class="form-label">🇰🇷 명칭/가격</label><input id="nmKR" class="input-text"><input id="prKR" type="number" class="input-text" style="margin-top:2px;" placeholder="0"></div>
                        <div style="flex:1;"><label class="form-label">🇯🇵 명칭/가격</label><input id="nmJP" class="input-text"><input id="prJP" type="number" class="input-text" style="margin-top:2px;" placeholder="0"></div>
                        <div style="flex:1;"><label class="form-label">🇺🇸 명칭/가격</label><input id="nmUS" class="input-text"><input id="prUS" type="number" class="input-text" style="margin-top:2px;" placeholder="0"></div>
                        <div style="flex:1;"><label class="form-label">🇨🇳 명칭/가격</label><input id="nmCN" class="input-text"><input id="prCN" type="number" class="input-text" style="margin-top:2px;" placeholder="0"></div>
                        <div style="flex:1;"><label class="form-label">🇸🇦 명칭/가격</label><input id="nmAR" class="input-text"><input id="prAR" type="number" class="input-text" style="margin-top:2px;" placeholder="0"></div>
                        <div style="flex:1;"><label class="form-label">🇪🇸 명칭/가격</label><input id="nmES" class="input-text"><input id="prES" type="number" class="input-text" style="margin-top:2px;" placeholder="0"></div>
                        <div style="flex:1;"><label class="form-label">🇩🇪 명칭/가격</label><input id="nmDE" class="input-text"><input id="prDE" type="number" class="input-text" style="margin-top:2px;" placeholder="0"></div>
                        <div style="flex:1;"><label class="form-label">🇫🇷 명칭/가격</label><input id="nmFR" class="input-text"><input id="prFR" type="number" class="input-text" style="margin-top:2px;" placeholder="0"></div>

<div style="display:flex; flex-direction:column; justify-content:center; height:70px; margin-left:10px;">
    <label style="cursor:pointer; display:flex; align-items:center; gap:5px; font-weight:bold; color:#e11d48; font-size:12px;">
        <input type="checkbox" id="newAddonIsSwatch" style="width:18px; height:18px;">
        <span>🎨 스와치 모드</span>
    </label>
    <div style="font-size:10px; color:#999; margin-top:2px;">(이미지만 표시)</div>
</div>
<div style="display:flex; align-items:flex-end;">
    <button class="btn btn-primary" onclick="addAddonDB()" style="height:70px; width:100px; font-weight:800;">옵션 저장</button>
</div>
                    </div>
                </div>

                <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px; background:#fff; padding:10px; border-radius:8px; border:1px solid #eee;">
                    <select id="filterAddonCategory" onchange="loadSystemDB()" class="input-text" style="width:160px;"></select>
                    <select id="newAddonSite" onchange="loadSystemDB(this.value)" class="input-text" style="width:100px;">
                        <option value="KR">🇰🇷 한국</option>
                        <option value="JP">🇯🇵 일본</option>
                        <option value="US">🇺🇸 미국</option>
                    </select>
                    <input type="text" id="addonSearchInput" class="input-text" placeholder="옵션명 또는 코드로 실시간 검색..." style="flex:1;" onkeyup="loadSystemDB()">
                </div>

                <div id="addonListArea" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; max-height: 500px; overflow-y: auto; padding: 5px;"></div>
            </div> <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3>📜 상품 목록</h3>
                    <div style="display:flex; gap:5px;">
                        <button id="btnCurrencyUpdate" class="btn btn-vip btn-sm" onclick="updateAllCurrency()" style="background:#4f46e5; border-color:#4338ca;">
                            💵 환율 일괄 적용 (일본 미국 2배 가격)
                        </button>
                        <button class="btn btn-success btn-sm" onclick="bulkTranslateAll()">일괄 번역</button>
                        <button class="btn btn-vip btn-sm" onclick="openCommonInfoModal()" style="background:#7c3aed; border-color:#6d28d9; margin-left:5px;">
    📢 상품 공통정보(상단) 관리
</button>
</button>
                    </div>
                </div>
                
                <div style="margin-bottom:10px; display:flex; gap:10px; align-items:center;">
                    <span style="font-weight:bold; color:#64748b;">🔍 필터:</span>
                    <select id="filterProdSite" onchange="filterProductList()" class="input-text" style="width:130px;"><option value="all">🌏 전체</option><option value="KR">🇰🇷</option><option value="JP">🇯🇵</option><option value="US">🇺🇸</option></select>
                    <select id="filterProdCat" onchange="filterProductList()" class="input-text" style="width:150px;"><option value="all">📂 전체</option></select>
                    <input type="text" id="prodSearchInput" class="input-text" placeholder="상품명/코드 검색" style="width:150px;" onkeyup="filterProductList()">
                </div>
                <table>
                    <thead><tr><th width="50">국가</th><th width="60">이미지</th><th>코드/상품명</th><th>사이즈</th><th>가격</th><th width="80">관리</th></tr></thead>
                    <tbody id="prodTableBody"></tbody>
                </table>
            </div> </div> </div>

            <!-- 상품 공통 하단 안내문 -->
            <div class="card" style="background:#f0fdf4; border:1px solid #bbf7d0; margin-top:20px;">
                <h3 style="margin:0 0 12px; color:#166534;">📋 상품 공통 하단 안내문</h3>
                <p style="font-size:12px; color:#555; margin:0 0 12px;">모든 상품 페이지 하단에 공통으로 표시되는 유의사항, 배송안내 등을 작성합니다. (국가별)</p>
                <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
                    <button class="btn btn-sm" onclick="pfLoadFooter('kr')" style="background:#e0e7ff; border:1px solid #a5b4fc;">🇰🇷 한국</button>
                    <button class="btn btn-sm" onclick="pfLoadFooter('ja')" style="background:#fef3c7; border:1px solid #fcd34d;">🇯🇵 일본</button>
                    <button class="btn btn-sm" onclick="pfLoadFooter('en')" style="background:#dbeafe; border:1px solid #93c5fd;">🇺🇸 영어</button>
                    <button class="btn btn-sm" onclick="pfLoadFooter('zh')" style="background:#fce7f3; border:1px solid #f9a8d4;">🇨🇳 중국</button>
                    <button class="btn btn-sm" onclick="pfLoadFooter('ar')" style="background:#f5f5f4; border:1px solid #d6d3d1;">🇸🇦 아랍</button>
                    <button class="btn btn-sm" onclick="pfLoadFooter('es')" style="background:#fef9c3; border:1px solid #fde047;">🇪🇸 스페인</button>
                    <button class="btn btn-sm" onclick="pfLoadFooter('fr')" style="background:#ede9fe; border:1px solid #c4b5fd;">🇫🇷 프랑스</button>
                    <button class="btn btn-sm" onclick="pfLoadFooter('de')" style="background:#fef2f2; border:1px solid #fecaca;">🇩🇪 독일</button>
                </div>
                <div style="margin-bottom:8px; font-weight:bold; color:#166534;">현재 편집: <span id="pfCurrentLang">kr</span></div>
                <textarea id="pfFooterContent" style="width:100%; min-height:200px; border:1px solid #86efac; border-radius:8px; padding:12px; font-size:13px; line-height:1.8; font-family:inherit; resize:vertical;" placeholder="유의사항, 배송안내, 교환/반품 안내 등을 입력하세요.&#10;&#10;HTML 태그 사용 가능 (예: <b>굵게</b>, <br> 줄바꿈)"></textarea>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button class="btn btn-primary" onclick="pfSaveFooter()" style="flex:1;">💾 저장</button>
                    <button class="btn btn-secondary" onclick="pfPreviewFooter()" style="flex:1;">👁 미리보기</button>
                </div>
                <div id="pfPreviewArea" style="display:none; margin-top:12px; padding:16px; background:#fff; border:1px solid #e5e7eb; border-radius:8px; font-size:13px; line-height:1.8;"></div>
            </div>

            </div>


            <div id="sec-staff" class="section">
                <div class="product-layout">
                    <div class="card tpl-form">
                        <h3 style="margin-top:0;">👤 스태프 등록</h3>
                        <div class="form-group"><label class="form-label">이름</label><input id="staffName" class="input-text"></div>
                        <div class="form-group"><label class="form-label">역할</label><select id="staffRole" class="input-text"><option value="manager">담당 매니저</option><option value="driver">배송 기사</option></select></div>
                        <div class="form-group"><label class="form-label">색상</label><input id="staffColor" type="color" class="input-text" style="height:40px;" value="#6366f1"></div>
                        <button class="btn btn-primary" style="width:100%;" onclick="addStaffDB()">등록하기</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-top:0;">📋 스태프 목록</h3>
                        <button class="btn btn-outline btn-sm" onclick="loadStaffList()" style="margin-bottom:10px;">새로고침</button>
                        <table><thead><tr><th width="50">색상</th><th>이름</th><th>역할</th><th>관리</th></tr></thead><tbody id="staffListBody"></tbody></table>
                    </div>
                </div>
            </div>

            <div id="sec-members" class="section">
    <div class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
            <h3>👥 회원 목록 <span id="totalMemberCount" style="font-size:14px; color:#6366f1; background:#e0e7ff; padding:2px 8px; border-radius:12px; vertical-align:middle; margin-left:5px;">0명</span></h3>
            
            <div style="display:flex; gap:8px; align-items:center;">
                <label class="btn btn-success btn-sm" style="cursor:pointer;" title="고도몰 엑셀 업로드">
                    <i class="fa-solid fa-file-excel"></i> 마일리지 이관
                    <input type="file" id="mileageExcelInput" accept=".xlsx, .xls" style="display:none;" onchange="importMileageExcel(this)">
                </label>

                <select id="memberSort" class="input-text" style="width:140px; font-size:12px;" onchange="loadMembers()">
                    <option value="newest">📅 가입일순 (최신)</option>
                    <option value="deposit_desc">💰 예치금 많은순</option>
                    <option value="deposit_asc">💰 예치금 적은순</option>
                    <option value="mileage_desc">Ⓜ️ 마일리지 많은순</option>
                    <option value="mileage_asc">Ⓜ️ 마일리지 적은순</option>
                    <option value="spend_desc">💳 구매금액 많은순</option>
                </select>

                <select id="memberFilterRole" class="input-text" style="width:110px; font-size:12px; font-weight:bold;" onchange="loadMembers()">
                    <option value="all">👑 전체 등급</option>
                    <option value="customer">😐 일반</option>
                    <option value="gold">🥇 골드</option>
                    <option value="platinum">💎 파트너스</option>
                    <option value="subscriber">⭐ 구독자</option>
                    <option value="franchise">🏢 가맹점</option>
                    <option value="admin">🛠 관리자</option>
                </select>

                <input type="text" id="memberSearchInput" class="input-text" placeholder="이름 또는 이메일 검색" style="width:180px;" onkeyup="if(event.key=='Enter') loadMembers()">
                <button class="btn btn-primary" onclick="loadMembers()"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div>
        </div>

        <table style="width:100%; border-collapse:collapse; font-size:12px; table-layout:fixed; min-width:1000px;">
    <colgroup>
        <col style="width: 9%;">   <col style="width: 18%;">  <col style="width: 14%;">  <col style="width: 10%;">  <col style="width: 25%;">  <col style="width: 8%;">   <col style="width: 16%;">  </colgroup>
    <thead>
        <tr style="background:#f8fafc; color:#475569; border-bottom:1px solid #e2e8f0; height:45px; text-transform:uppercase; font-size:11px; letter-spacing:0.5px;">
            <th style="padding:0 15px; text-align:center;">가입일</th>
            <th style="padding:0 15px;">고객 정보 (이름/이메일)</th>
            <th style="padding:0 15px; text-align:right;">💰 예치금 / Ⓜ️ 마일리지</th>
            <th style="padding:0 15px; text-align:center;">자산 관리</th> 
            <th style="padding:0 15px;">📝 관리자 메모 (특이사항)</th>
            <th style="padding:0 15px; text-align:center;">등급</th>
            <th style="padding:0 15px;">등급 변경</th>
        </tr>
    </thead>
    <tbody id="memberListBody"></tbody>
</table>

        <div style="display:flex; justify-content:center; align-items:center; gap:15px; margin-top:20px; padding-top:15px; border-top:1px solid #f1f5f9;">
            <button class="btn btn-outline btn-sm" onclick="changeMemberPage(-1)">◀ 이전</button>
            <span id="memberPageLabel" style="font-size:13px; font-weight:bold; color:#334155;">Page 1</span>
            <button class="btn btn-outline btn-sm" onclick="changeMemberPage(1)">다음 ▶</button>
        </div>
    </div> </div> <div id="sec-templates" class="section">
    <div class="product-layout">
        <div class="card tpl-form">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">📤 템플릿 등록</h3>
                <button class="btn btn-outline btn-sm" onclick="resetTemplateForm()">초기화</button>
            </div>

            <div class="form-group">
                <label class="form-label">카테고리</label>
                <select id="tplCategory" class="input-text" onchange="toggleFileInputs()">
                    <option value="logo">🎨 로고 (Logo)</option>
                    <option value="transparent-graphic">🏁 패턴 (Pattern)</option>
                    <option value="vector">🖼 벡터 배경 (Vector)</option>
                    <option value="photo-bg">📷 사진 배경 (Photo)</option>
                    <option value="graphic">🧸 그래픽/스티커 (Graphic)</option>
                    <option value="audio">🎵 음원 (Audio/BGM)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">검색어 (태그)</label>
                <input id="tplTags" class="input-text" placeholder="예: 삼성, 로고, 여름">
            </div>
            <div class="form-group">
                <label class="form-label">연결 제품 (Product Key)</label>
                <select id="tplProductKey" class="input-text">
                    <option value="custom">공통 / 지정안함</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" id="lblThumb">1. 썸네일 (이미지)</label>
                <div class="file-drop-zone">
                    <input type="file" id="fileThumb" accept="image/*" onchange="previewTemplateImage(this)">
                    <span>이미지 선택</span>
                </div>
                <img id="previewThumb" class="preview-img" style="display:none; margin-top:5px; max-height:150px; border:1px solid #eee;">
            </div>
            <div class="form-group" id="groupDataFile">
                <label class="form-label" id="lblData">2. 벡터 데이터 (SVG/JSON)</label>
                <div class="file-drop-zone">
                    <input type="file" id="fileData" accept=".svg,.json">
                    <span>파일 선택</span>
                </div>
            </div>
            <button class="btn btn-primary" style="width:100%;" onclick="uploadTemplate()">등록하기</button>
        </div>

        <div class="card">
            <div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0;">🗂️ 템플릿 라이브러리</h3>
                    <button class="btn btn-danger" onclick="deleteSelectedTemplates()">
                        <i class="fa-solid fa-trash-can"></i> 선택 삭제
                    </button>
                </div>
                
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <input type="text" id="tplSearchInput" class="input-text" style="flex:2;" placeholder="태그 검색..." onkeyup="if(event.key=='Enter') loadTemplates(true)">
                    
                    <select id="filterTplCat" class="input-text" style="flex:1;" onchange="loadTemplates(true)">
                        <option value="all">📂 카테고리 전체</option>
                        <option value="logo">🎨 로고</option>
                        <option value="transparent-graphic">🏁 패턴</option>
                        <option value="vector">🖼 벡터 배경</option>
                        <option value="photo-bg">📷 사진 배경</option>
                        <option value="graphic">🧸 그래픽</option>
                        <option value="audio">🎵 음원</option>
                    </select>
                    
                    <select id="filterTplProduct" class="input-text" style="flex:1;" onchange="loadTemplates(true)">
                        <option value="all">📦 제품연결 전체</option>
                    </select>
                    
                    <button class="btn btn-primary" onclick="loadTemplates(true)">검색</button>
                </div>
                
                <div style="margin-top:10px;">
                    <label style="cursor:pointer; font-weight:bold; font-size:13px;">
                        <input type="checkbox" onchange="toggleAllTemplates(this)"> 전체 선택
                    </label>
                </div>
            </div>

            <div style="display:flex; justify-content:center; align-items:center; gap:8px; margin: 15px 0; padding:10px; background:#f8fafc; border-radius:8px;">
                <button class="btn btn-outline btn-sm" onclick="goTplPage('first')" title="맨앞">◀◀</button>
                <button class="btn btn-outline btn-sm" onclick="changeTplPage(-1)">◀ 이전</button>
                <span id="tplPageLabel" style="font-weight:bold; font-size:14px; color:#334155;">Page 1</span>
                <button class="btn btn-outline btn-sm" onclick="changeTplPage(1)">다음 ▶</button>
                <button class="btn btn-outline btn-sm" onclick="goTplPage('last')" title="맨뒤">▶▶</button>
            </div>

            <div id="tplGrid" class="tpl-card-grid"></div>
        </div>
    </div>
</div>

            <div id="sec-fonts" class="section">
    <div class="product-layout">
        <div class="card tpl-form">
            <h3 style="margin-top:0;">🔤 폰트 등록</h3>
            <div class="form-group">
                <label class="form-label">국가</label>
                <select id="fontSite" class="input-text">
                    <option value="KR">🇰🇷 한국 (KR)</option>
                    <option value="JA">🇯🇵 일본 (JA)</option>
                    <option value="EN">🇺🇸 미국 (EN)</option>
                    <option value="ZH">🇨🇳 중국 (ZH)</option>
                    <option value="AR">🇸🇦 아랍 (AR)</option>
                    <option value="ES">🇪🇸 스페인 (ES)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">폰트명 (표시용)</label>
                <input id="fontName" class="input-text" placeholder="예: 나눔고딕">
            </div>
            <div class="form-group">
                <label class="form-label">CSS Family Name</label>
                <input id="fontFamily" class="input-text" placeholder="예: NanumGothic">
                <p style="font-size:11px; color:#666; margin-top:3px;">* 영문, 공백없이 입력하세요.</p>
            </div>
            <div class="form-group">
                <label class="form-label">폰트 파일 (.woff2 / .ttf)</label>
                <div class="file-drop-zone">
                    <input type="file" id="fontFile" accept=".woff2,.ttf,.otf">
                    <span>파일 선택</span>
                </div>
            </div>
            <button class="btn btn-primary" style="width:100%;" onclick="uploadFont()">등록하기</button>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">폰트 목록</h3>
                <button class="btn btn-outline btn-sm" onclick="loadFonts()">새로고침</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th width="60">국가</th>
                        <th>폰트 정보</th>
                        <th>미리보기</th>
                        <th width="60">삭제</th>
                    </tr>
                </thead>
                <tbody id="fontListBody"></tbody>
            </table>
        </div>
    </div>
</div>


<!-- ===== AI 챗봇 학습 관리 섹션 ===== -->
<div id="sec-chatbot" class="section">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid #6366f1; padding-bottom:15px;">
            <h3 style="margin:0; color:#4338ca;">🦎 AI 챗봇 학습 관리</h3>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-outline btn-sm" onclick="cbShowTab('logs')" id="cbTabLogs">📋 상담 로그</button>
                <button class="btn btn-primary btn-sm" onclick="cbShowTab('knowledge')" id="cbTabKnowledge">📚 학습 데이터</button>
                <button class="btn btn-outline btn-sm" onclick="cbShowTab('settings')" id="cbTabSettings">⚙️ 설정</button>
            </div>
        </div>
        <div id="cbPanelLogs" style="display:none;">
            <div id="cbDailyReport" style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:15px;"></div>
            <div id="cbUrgentBox" style="display:none; background:#fef2f2; border:2px solid #fca5a5; border-radius:10px; padding:15px; margin-bottom:15px;">
                <h4 style="margin:0 0 10px; color:#dc2626;">🚨 AI가 곤란했던 질문들</h4>
                <div id="cbUrgentList"></div>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
                <input type="date" id="cbLogDate" class="input-text" style="width:150px;">
                <select id="cbLogFilter" class="input-text" style="width:150px;">
                    <option value="all">전체</option>
                    <option value="unresolved">❌ 미해결</option>
                    <option value="needs_training">📝 학습필요</option>
                </select>
                <button class="btn btn-primary btn-sm" onclick="cbLoadLogs()">조회</button>
                <span id="cbLogCount" style="font-size:12px; color:#64748b; align-self:center;"></span>
            </div>
            <div id="cbLogList" style="max-height:600px; overflow-y:auto;"></div>
        </div>
        <div id="cbPanelKnowledge" style="display:block;">
            <div style="background:#f0fdf4; border:1px dashed #86efac; border-radius:10px; padding:15px; margin-bottom:15px;">
                <h4 style="margin:0 0 10px; color:#16a34a;">➕ 새 학습 데이터 추가</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div><label style="font-size:12px; font-weight:700;">카테고리</label>
                        <select id="cbNewCat" class="input-text"><option>배송</option><option>결제</option><option>가격</option><option>상품</option><option>사업자</option><option>에디터</option><option>취소/환불</option><option>글로벌</option><option>서비스</option><option>기타</option></select></div>
                    <div><label style="font-size:12px; font-weight:700;">언어</label>
                        <select id="cbNewLang" class="input-text"><option value="ko">🇰🇷 한국어</option><option value="ja">🇯🇵 日本語</option><option value="en">🇺🇸 English</option></select></div>
                </div>
                <div style="margin-top:10px;"><label style="font-size:12px; font-weight:700;">고객 질문</label>
                    <input id="cbNewQ" class="input-text" placeholder="예: 배송 며칠 걸려요?" style="width:100%;"></div>
                <div style="margin-top:10px;"><label style="font-size:12px; font-weight:700;">답변</label>
                    <textarea id="cbNewA" class="input-text" rows="3" placeholder="예: 수도권 1~2일, 지방 2~3일" style="width:100%; resize:vertical;"></textarea></div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div style="flex:1;"><label style="font-size:12px; font-weight:700;">키워드</label><input id="cbNewKw" class="input-text" placeholder="배송,택배" style="width:100%;"></div>
                    <div style="width:80px;"><label style="font-size:12px; font-weight:700;">우선순위</label><input id="cbNewPri" class="input-text" type="number" value="5" style="width:100%;"></div>
                </div>
                <button class="btn btn-primary" style="width:100%; margin-top:12px;" onclick="cbAddKnowledge()">💾 저장</button>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:8px;">
                <h4 style="margin:0;">📚 등록된 학습 데이터 <span id="cbKnCount" style="font-size:12px; color:#64748b; font-weight:400;"></span></h4>
                <div style="display:flex; gap:8px; align-items:center;">
                    <input type="text" id="cbKnSearch" class="input-text" placeholder="🔍 검색 (질문/답변/키워드)" style="width:220px; font-size:12px;" oninput="cbFilterLocal()" onkeydown="if(event.key==='Enter')cbLoadKnowledge()">
                    <select id="cbKnFilter" class="input-text" style="width:100px;" onchange="cbLoadKnowledge()"><option value="all">전체</option><option value="ko">🇰🇷</option><option value="ja">🇯🇵</option><option value="en">🇺🇸</option></select>
                    <button class="btn btn-outline btn-sm" onclick="cbLoadKnowledge()">새로고침</button>
                </div>
            </div>
            <div id="cbKnList" style="max-height:600px; overflow-y:auto;"></div>
            <!-- 수정 모달 -->
            <div id="cbEditModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:10000; display:none; align-items:center; justify-content:center;">
                <div style="background:#fff; border-radius:12px; padding:24px; width:560px; max-width:90vw; max-height:80vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h3 style="margin:0; color:#334155;">✏️ 학습 데이터 수정</h3>
                        <button onclick="cbCloseEdit()" style="background:none; border:none; font-size:20px; cursor:pointer; color:#94a3b8;">✕</button>
                    </div>
                    <input type="hidden" id="cbEditId">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div><label style="font-size:12px; font-weight:600; color:#64748b;">카테고리</label>
                            <select id="cbEditCat" class="input-text" style="width:100%;"><option>배송</option><option>결제</option><option>가격</option><option>상품</option><option>사업자</option><option>에디터</option><option>취소/환불</option><option>글로벌</option><option>서비스</option><option>상담사례</option><option>기타</option></select></div>
                        <div><label style="font-size:12px; font-weight:600; color:#64748b;">언어</label>
                            <select id="cbEditLang" class="input-text" style="width:100%;"><option value="ko">🇰🇷 한국어</option><option value="ja">🇯🇵 日本語</option><option value="en">🇺🇸 English</option></select></div>
                    </div>
                    <div style="margin-top:10px;"><label style="font-size:12px; font-weight:600; color:#64748b;">질문</label>
                        <input id="cbEditQ" class="input-text" style="width:100%;"></div>
                    <div style="margin-top:10px;"><label style="font-size:12px; font-weight:600; color:#64748b;">답변</label>
                        <textarea id="cbEditA" class="input-text" rows="5" style="width:100%; resize:vertical;"></textarea></div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <div style="flex:1;"><label style="font-size:12px; font-weight:600; color:#64748b;">키워드</label>
                            <input id="cbEditKw" class="input-text" placeholder="쉼표 구분" style="width:100%;"></div>
                        <div style="width:80px;"><label style="font-size:12px; font-weight:600; color:#64748b;">우선순위</label>
                            <input id="cbEditPri" class="input-text" type="number" style="width:100%;"></div>
                    </div>
                    <div style="display:flex; gap:8px; margin-top:16px;">
                        <button class="btn btn-primary" style="flex:1;" onclick="cbSaveEdit()">💾 저장</button>
                        <button class="btn btn-outline" style="flex:1;" onclick="cbCloseEdit()">취소</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="cbPanelSettings" style="display:none;">
            <div style="background:#fefce8; border:1px solid #fde047; border-radius:10px; padding:15px;">
                <h4 style="margin:0 0 15px; color:#a16207;">⚙️ 챗봇 설정</h4>
                <label style="font-size:12px; font-weight:700;">추가 업무 지시</label>
                <textarea id="cbCustomPrompt" class="input-text" rows="6" style="width:100%; resize:vertical;" placeholder="예: 현재 설날 이벤트 10% 할인 중"></textarea>
                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="cbSaveSettings()">💾 설정 저장</button>
            </div>
            <div class="card" style="margin-top:15px;"><h4 style="margin:0 0 10px;">📊 통계</h4><div id="cbStats" style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px;"></div></div>
        </div>
    </div>
</div>

<!-- ===== 실시간 상담 섹션 ===== -->
<div id="sec-live-chat" class="section" style="margin:-80px -30px -30px -30px; padding:0;">
    <div style="display:grid; grid-template-columns:400px 1fr; gap:0; height:100vh; overflow:hidden;">
        <!-- 좌측 사이드바 (다크 테마) -->
        <div style="background:#1e1b2e; color:#e2e8f0; display:flex; flex-direction:column; overflow:hidden;">
            <!-- 헤더 -->
            <div style="padding:18px 20px 14px; border-bottom:1px solid rgba(255,255,255,0.08);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
                    <h3 style="margin:0; color:#fff; font-size:18px; font-weight:800; letter-spacing:-0.3px;">💬 상담 대기열</h3>
                    <button onclick="lcLoadRooms()" style="background:rgba(255,255,255,0.08); border:none; color:#94a3b8; padding:6px 12px; border-radius:8px; font-size:12px; cursor:pointer; transition:background 0.2s;" onmouseenter="this.style.background='rgba(255,255,255,0.15)'" onmouseleave="this.style.background='rgba(255,255,255,0.08)'">새로고침</button>
                </div>
                <!-- 매니저 선택 -->
                <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px; padding:8px 12px; background:rgba(99,102,241,0.15); border-radius:10px; border:1px solid rgba(99,102,241,0.25);">
                    <span style="font-size:13px; font-weight:700; color:#a5b4fc; white-space:nowrap;">👤 내 이름:</span>
                    <select id="lcMyManagerName" onchange="lcSaveMyName()" style="flex:1; font-size:13px; padding:5px 10px; border:1px solid rgba(99,102,241,0.3); border-radius:8px; background:#2d2a42; font-weight:700; color:#c7d2fe; outline:none;">
                        <option value="">선택하세요</option>
                    </select>
                </div>
                <!-- 알림 버튼 -->
                <div id="lcNotifyPanel" style="display:flex; gap:8px; margin-bottom:12px;">
                    <button id="lcNotifyAllBtn" onclick="lcToggleNotifyAll()" style="flex:1; display:flex; align-items:center; justify-content:center; gap:8px; padding:10px 6px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); background:rgba(255,255,255,0.04); cursor:pointer; transition:all .2s;" title="일반 유입 알림">
                        <svg id="lcMegaAll" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transition:all .2s;"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                        <div style="text-align:left;">
                            <div style="font-size:12px; font-weight:700; color:#cbd5e1;">일반 유입</div>
                            <div id="lcNotifyAllStatus" style="font-size:11px; color:#64748b;">OFF</div>
                        </div>
                    </button>
                    <button id="lcNotifyMgrBtn" onclick="lcToggleNotifyMgr()" style="flex:1; display:flex; align-items:center; justify-content:center; gap:8px; padding:10px 6px; border-radius:10px; border:2px solid rgba(255,255,255,0.08); background:rgba(255,255,255,0.04); cursor:pointer; transition:all .2s;" title="내 담당 고객 알림">
                        <svg id="lcMegaMgr" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transition:all .2s;"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/><circle cx="18" cy="4" r="3" fill="#6366f1" stroke="none"/></svg>
                        <div style="text-align:left;">
                            <div style="font-size:12px; font-weight:700; color:#cbd5e1;">내 담당</div>
                            <div id="lcNotifyMgrStatus" style="font-size:11px; color:#64748b;">OFF</div>
                        </div>
                    </button>
                </div>
                <!-- 필터 탭 -->
                <div style="display:flex; gap:4px; flex-wrap:wrap;">
                    <button class="btn btn-primary btn-sm" onclick="lcFilterRooms('all')" id="lcFilterAll" style="font-size:12px; flex:1; padding:7px 4px; border-radius:8px; position:relative;">전체<span id="lcAllBadge" style="display:none;position:absolute;top:-6px;right:-4px;background:#ef4444;color:#fff;font-size:9px;font-weight:700;min-width:16px;height:16px;border-radius:8px;align-items:center;justify-content:center;padding:0 3px;animation:lcBadgePulse 1.5s ease infinite;box-shadow:0 0 6px rgba(239,68,68,0.5);"></span></button>
                    <button class="btn btn-outline btn-sm" onclick="lcFilterRooms('waiting')" id="lcFilterWait" style="font-size:12px; flex:1; padding:7px 4px; border-radius:8px; color:#cbd5e1; border-color:rgba(255,255,255,0.12); position:relative;">대기<span id="lcWaitBadge" style="display:none;position:absolute;top:-6px;right:-4px;background:#ef4444;color:#fff;font-size:9px;font-weight:700;min-width:16px;height:16px;border-radius:8px;align-items:center;justify-content:center;padding:0 3px;animation:lcBadgePulse 1.5s ease infinite;box-shadow:0 0 6px rgba(239,68,68,0.5);"></span></button>
                    <button class="btn btn-outline btn-sm" onclick="lcFilterRooms('active')" id="lcFilterActive" style="font-size:12px; flex:1; padding:7px 4px; border-radius:8px; color:#cbd5e1; border-color:rgba(255,255,255,0.12);">상담</button>
                    <button class="btn btn-outline btn-sm" onclick="lcFilterRooms('closed')" id="lcFilterClosed" style="font-size:12px; flex:1; padding:7px 4px; border-radius:8px; color:#cbd5e1; border-color:rgba(255,255,255,0.12);">종료</button>
                    <button class="btn btn-outline btn-sm" onclick="lcFilterRooms('ai_chatting')" id="lcFilterAiChat" style="font-size:12px; flex:1; padding:7px 4px; border-radius:8px; color:#cbd5e1; border-color:rgba(255,255,255,0.12);">AI</button>
                    <button class="btn btn-outline btn-sm" onclick="lcFilterRooms('chatbot')" id="lcFilterBot" style="font-size:12px; flex:1; padding:7px 4px; border-radius:8px; color:#cbd5e1; border-color:rgba(255,255,255,0.12);">로그</button>
                </div>
                <!-- 검색 -->
                <div style="margin-top:10px; position:relative;">
                    <div style="display:flex; gap:4px;">
                        <div style="flex:1; position:relative;">
                            <i class="fa-solid fa-magnifying-glass" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#64748b; font-size:12px;"></i>
                            <input id="lcSearchInput" type="text" placeholder="고객명 또는 대화내용 검색..." oninput="lcSearchDebounce()" onkeydown="if(event.key==='Enter')lcDoSearch()" style="width:100%; padding:8px 10px 8px 30px; font-size:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.12); background:#2d2a42; color:#e2e8f0; outline:none;">
                        </div>
                        <button onclick="lcDoSearch()" style="background:#6366f1; border:none; color:#fff; padding:6px 8px; border-radius:6px; cursor:pointer; font-size:11px; white-space:nowrap; flex-shrink:0;">🔍</button>
                    </div>
                    <div id="lcSearchMode" style="display:flex; gap:6px; margin-top:6px;">
                        <label style="font-size:11px; color:#94a3b8; cursor:pointer; display:flex; align-items:center; gap:3px;">
                            <input type="radio" name="lcSearchType" value="customer" checked style="accent-color:#6366f1;"> 고객명
                        </label>
                        <label style="font-size:11px; color:#94a3b8; cursor:pointer; display:flex; align-items:center; gap:3px;">
                            <input type="radio" name="lcSearchType" value="message" style="accent-color:#6366f1;"> 대화내용
                        </label>
                        <label style="font-size:11px; color:#94a3b8; cursor:pointer; display:flex; align-items:center; gap:3px;">
                            <input type="radio" name="lcSearchType" value="both" style="accent-color:#6366f1;"> 전체
                        </label>
                        <span id="lcSearchClear" onclick="lcClearSearch()" style="display:none; margin-left:auto; font-size:11px; color:#f87171; cursor:pointer; text-decoration:underline;">초기화</span>
                    </div>
                </div>
            </div>
            <!-- 상담방 목록 -->
            <div id="lcRoomList" style="flex:1; overflow-y:auto; padding:8px 10px;"></div>
            <!-- 상담사 관리 -->
            <div style="border-top:1px solid rgba(255,255,255,0.08); padding:12px 16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span style="font-size:13px; font-weight:700; color:#94a3b8;">👥 등록된 상담사</span>
                    <button onclick="lcShowAddManager()" style="background:rgba(255,255,255,0.08); border:none; color:#a5b4fc; padding:3px 10px; border-radius:6px; font-size:11px; cursor:pointer;">+ 추가</button>
                </div>
                <div id="lcManagerList" style="font-size:13px;"></div>
                <div id="lcAddManagerForm" style="display:none; background:rgba(34,197,94,0.08); border:1px solid rgba(34,197,94,0.2); border-radius:8px; padding:10px; margin-top:6px;">
                    <input id="lcNewMgrName" class="input-text" placeholder="이름" style="width:100%; font-size:13px; margin-bottom:5px; background:#2d2a42; color:#e2e8f0; border-color:rgba(255,255,255,0.15);">
                    <input id="lcNewMgrPhone" class="input-text" placeholder="전화번호" style="width:100%; font-size:13px; margin-bottom:5px; background:#2d2a42; color:#e2e8f0; border-color:rgba(255,255,255,0.15);">
                    <input id="lcNewMgrRole" class="input-text" placeholder="역할 (예: 주간/야간)" style="width:100%; font-size:13px; margin-bottom:5px; background:#2d2a42; color:#e2e8f0; border-color:rgba(255,255,255,0.15);">
                    <div style="display:flex; gap:4px;">
                        <button class="btn btn-primary btn-sm" onclick="lcAddManager()" style="flex:1; font-size:12px;">저장</button>
                        <button class="btn btn-outline btn-sm" onclick="document.getElementById('lcAddManagerForm').style.display='none'" style="font-size:12px; color:#94a3b8; border-color:rgba(255,255,255,0.15);">취소</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 우측 채팅 영역 -->
        <div style="display:flex; flex-direction:column; background:#fff; overflow:hidden;">
            <!-- 채팅 헤더 -->
            <div style="background:#fff; padding:16px 24px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div id="lcChatTitle" style="font-weight:800; color:#1e293b; font-size:17px;">상담방을 선택하세요</div>
                    <div style="display:flex; align-items:center; gap:8px; margin-top:4px;">
                        <span id="lcChatManagerBadge" style="display:none; background:#6366f1; color:#fff; font-size:13px; font-weight:700; padding:3px 14px; border-radius:14px;">담당: -</span>
                        <span id="lcChatStatusBadge" style="display:none; font-size:12px; color:#64748b;"></span>
                    </div>
                </div>
                <div style="display:flex; gap:6px; position:relative;">
                    <button id="lcChangeMgrBtn" class="btn btn-outline btn-sm" onclick="lcShowChangeManager()" style="font-size:12px; display:none; padding:6px 12px;">🔄 담당 변경</button>
                    <div id="lcChangeMgrDropdown" style="display:none; position:absolute; top:100%; right:0; background:#fff; border:1px solid #e2e8f0; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.15); z-index:100; min-width:200px; padding:8px; margin-top:4px;"></div>
                    <button id="lcInterveneBtn" class="btn btn-primary btn-sm" onclick="lcIntervene()" style="font-size:12px; display:none; background:#f59e0b; border-color:#f59e0b; padding:6px 12px;">🖐️ 끼어들기</button>
                    <button id="lcMemoBtn" class="btn btn-outline btn-sm" onclick="lcToggleMemo()" style="font-size:12px; padding:6px 12px;">📝 메모</button>
                    <button class="btn btn-outline btn-sm" onclick="lcSaveToKnowledge()" style="font-size:12px; padding:6px 12px;">📚 학습저장</button>
                    <button class="btn btn-outline btn-sm" onclick="lcCloseRoom()" style="font-size:12px; color:#ef4444; border-color:#ef4444; padding:6px 12px;">종료</button>
                </div>
            </div>
            <div id="lcAiSummary" style="display:none; background:#ede9fe; padding:10px 24px; font-size:13px; color:#6366f1; border-bottom:1px solid #c4b5fd;"><b>🤖 AI 요약:</b> <span id="lcAiSummaryText"></span></div>
            <!-- 메모 패널 -->
            <div id="lcMemoPanel" style="display:none; background:#fffbeb; border-bottom:2px solid #fcd34d; padding:14px 24px;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                    <span style="font-size:13px; font-weight:700; color:#92400e;">📝 관리자 메모</span>
                    <div style="display:flex; gap:6px;">
                        <button onclick="lcSaveMemo()" style="font-size:12px; background:#f59e0b; color:#fff; border:none; padding:5px 14px; border-radius:6px; cursor:pointer; font-weight:700;">저장</button>
                        <button onclick="lcToggleMemo()" style="font-size:12px; background:#f1f5f9; color:#64748b; border:1px solid #e2e8f0; padding:5px 10px; border-radius:6px; cursor:pointer;">닫기</button>
                    </div>
                </div>
                <textarea id="lcMemoText" placeholder="이 상담방에 대한 메모를 입력하세요..." style="width:100%; height:80px; border:1px solid #fcd34d; border-radius:8px; padding:10px 12px; font-size:13px; resize:vertical; font-family:inherit; background:#fff; line-height:1.5;"></textarea>
                <div id="lcMemoInfo" style="font-size:11px; color:#a1a1aa; margin-top:4px;"></div>
            </div>
            <!-- 메시지 영역 -->
            <div id="lcChatMessages" style="flex:1; overflow-y:auto; padding:24px; background:#f8f9fb;">
                <div style="text-align:center; color:#94a3b8; padding:80px 20px;"><i class="fa-solid fa-headset" style="font-size:56px; display:block; margin-bottom:20px; opacity:0.5;"></i><span style="font-size:15px;">왼쪽에서 상담방을 선택하세요</span></div>
            </div>
            <!-- 이미지 미리보기 -->
            <div id="lcFilePreview" style="display:none; padding:12px 24px; border-top:1px solid #e2e8f0; background:#f8fafc;">
                <div style="display:flex; align-items:flex-start; gap:12px;">
                    <img id="lcFilePreviewImg" style="max-width:200px; max-height:200px; border-radius:10px; border:2px solid #e2e8f0; object-fit:contain;">
                    <div style="flex:1; display:flex; flex-direction:column; gap:6px;">
                        <span id="lcFilePreviewName" style="font-size:12px; color:#64748b; word-break:break-all;"></span>
                        <div style="display:flex; gap:8px; margin-top:4px;">
                            <button onclick="lcConfirmFile()" style="background:#6366f1; color:#fff; border:none; padding:8px 20px; border-radius:8px; font-weight:700; font-size:13px; cursor:pointer;">전송</button>
                            <button onclick="lcCancelFile()" style="background:#f1f5f9; color:#64748b; border:1px solid #e2e8f0; padding:8px 20px; border-radius:8px; font-weight:700; font-size:13px; cursor:pointer;">취소</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 내부대화 모드 경고 바 -->
            <div id="lcInternalBar" style="display:none; padding:6px 24px; background:#fef3c7; border-top:1px solid #fcd34d; text-align:center; font-size:12px; font-weight:700; color:#92400e;">🔒 내부대화 모드 - 이 메시지는 고객에게 보이지 않습니다</div>
            <!-- 입력 영역 -->
            <div style="padding:14px 24px; border-top:1px solid #e2e8f0; background:#fff; display:flex; gap:10px; align-items:center; position:relative;">
                <div id="lcQuickReplyBox" style="display:none; position:absolute; bottom:100%; left:0; right:0; max-height:300px; overflow-y:auto; background:#fff; border:1px solid #c7d2fe; border-bottom:none; border-radius:12px 12px 0 0; box-shadow:0 -6px 30px rgba(99,102,241,0.15); z-index:100;"></div>
                <label style="cursor:pointer; color:#6366f1; font-size:22px;"><i class="fa-solid fa-paperclip"></i><input type="file" id="lcFileInput" style="display:none;" multiple></label>
                <button id="lcModeToggle" onclick="lcToggleMode()" style="background:#e0e7ff; color:#4338ca; border:1px solid #c7d2fe; border-radius:8px; padding:6px 10px; font-size:12px; font-weight:700; cursor:pointer; white-space:nowrap; transition:all 0.2s;" title="고객응대 / 내부대화 전환">💬 고객응대</button>
                <textarea id="lcMsgInput" class="input-text" placeholder="메시지 입력... (Shift+Enter 줄바꿈)" rows="1" style="flex:1; font-size:17px; padding:12px 16px; border-radius:12px; resize:none; min-height:44px; max-height:120px; overflow-y:auto; line-height:1.4; font-family:inherit;" onkeydown="if(event.key==='Enter'&&!event.shiftKey&&!event.isComposing){event.preventDefault();lcSendMsg();lcHideQuick();}" oninput="lcSearchQuick(this.value);this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px';"></textarea>
                <button class="btn btn-primary" onclick="lcSendMsg();lcHideQuick();" style="padding:10px 24px; font-size:15px; border-radius:12px;">전송</button>
            </div>
            <!-- 번역 도구 -->
            <div style="border-top:1px solid #e2e8f0; background:#fefce8; padding:12px 24px;">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                    <span style="font-size:13px; font-weight:700; color:#854d0e;"><i class="fa-solid fa-language"></i> 번역 도구</span>
                    <select id="lcTransFrom" style="font-size:12px; padding:4px 8px; border:1px solid #d4d4d8; border-radius:6px;">
                        <option value="kr">한국어</option>
                        <option value="ja">日本語</option>
                        <option value="en">English</option>
                    </select>
                    <span style="font-size:13px; color:#a1a1aa;">→</span>
                    <select id="lcTransTo" style="font-size:12px; padding:4px 8px; border:1px solid #d4d4d8; border-radius:6px;">
                        <option value="ja">日本語</option>
                        <option value="en">English</option>
                        <option value="kr">한국어</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="lcTranslate()" id="lcTransBtn" style="font-size:12px; padding:5px 16px; background:#ca8a04; border-color:#ca8a04;">번역</button>
                </div>
                <textarea id="lcTransInput" placeholder="번역할 텍스트 입력..." style="width:100%; height:44px; border:1px solid #d4d4d8; border-radius:8px; padding:8px 12px; font-size:13px; resize:vertical; font-family:inherit;"></textarea>
                <div id="lcTransResult" style="display:none; margin-top:8px; background:#fff; border:1px solid #86efac; border-radius:8px; padding:10px 14px; font-size:13px; line-height:1.5; position:relative;">
                    <div id="lcTransText" style="padding-right:70px; white-space:pre-wrap;"></div>
                    <div style="position:absolute; top:8px; right:8px; display:flex; gap:4px;">
                        <button onclick="lcCopyTrans()" style="font-size:11px; background:#6366f1; color:#fff; border:none; padding:4px 10px; border-radius:6px; cursor:pointer;" title="복사">📋 복사</button>
                        <button onclick="lcUseTrans()" style="font-size:11px; background:#22c55e; color:#fff; border:none; padding:4px 10px; border-radius:6px; cursor:pointer;" title="입력창에 넣기">↗ 사용</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


    <script type="module" src="global_admin.js"></script>
<div id="bidAdminModal" class="modal-overlay" style="display:none;">
        <div class="modal-box" style="width: 700px; max-width: 95%;">
            <div class="modal-header" style="background:#f8fafc; border-bottom:1px solid #e2e8f0; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
                <span>📢 파트너스 입찰 현황</span>
                <button class="btn btn-outline btn-sm" onclick="document.getElementById('bidAdminModal').style.display='none'">✕</button>
            </div>
            
            <div style="padding:20px;">
                <div style="display:flex; gap:20px; margin-bottom:20px; background:#fff; padding:15px; border:1px solid #cbd5e1; border-radius:8px;">
                    <div>
                        <div style="font-size:12px; color:#64748b;">주문번호</div>
                        <div id="bidModalOrderId" style="font-weight:bold; color:#334155;">-</div>
                    </div>
                    <div style="flex:1;">
                        <div style="font-size:12px; color:#64748b;">주문자</div>
                        <div id="bidModalCustomer" style="font-weight:bold; color:#334155;">-</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:12px; color:#64748b;">현재 상태</div>
                        <div id="bidModalStatus" class="badge" style="background:#f1f5f9; color:#64748b;">-</div>
                    </div>
                </div>

                <h4 style="margin:0 0 10px 0; color:#475569;">📋 도착한 견적 리스트</h4>
                <div style="max-height:400px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:8px;">
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <thead style="background:#f8fafc; position:sticky; top:0;">
                            <tr>
                                <th style="padding:10px; text-align:left; border-bottom:1px solid #e2e8f0;">파트너 (업체명)</th>
                                <th style="padding:10px; text-align:right; border-bottom:1px solid #e2e8f0;">제안 금액</th>
                                <th style="padding:10px; text-align:left; border-bottom:1px solid #e2e8f0;">메시지</th>
                                <th style="padding:10px; text-align:center; border-bottom:1px solid #e2e8f0;">연락처</th>
                                <th style="padding:10px; text-align:center; border-bottom:1px solid #e2e8f0;">상태</th>
                            </tr>
                        </thead>
                        <tbody id="bidAdminListBody">
                            <tr><td colspan="5" style="text-align:center; padding:30px;">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="global_admin.js"></script>

<div id="addonCatModal" class="modal-overlay" style="display:none; z-index:50000;">
    <div class="modal-box" style="width:500px;">
        <div class="modal-header">
            <span>📂 옵션 분류(카테고리) 관리</span>
            <button class="btn btn-outline btn-sm" onclick="document.getElementById('addonCatModal').style.display='none'">✕</button>
        </div>
        
        <div style="background:#f0f9ff; padding:15px; border-radius:8px; border:1px solid #bae6fd; margin-bottom:15px;">
            <div style="margin-bottom:10px;">
                <label class="form-label">고유 코드 (영문)</label>
                <input id="modalCatCode" class="input-text" placeholder="예: frame_color (수정불가)" style="background:#fff;">
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:5px;">
                <label class="form-label" style="margin:0;">분류 명칭 (다국어)</label>
                <button class="btn btn-vip btn-sm" onclick="autoTranslateAddonCatModal()">
                    <i class="fa-solid fa-language"></i> 자동번역
                </button>
            </div>
            
            <div style="display:flex; flex-direction:column; gap:8px;">
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="width:30px;">🇰🇷</span>
                    <input id="modalCatNameKR" class="input-text" placeholder="한국어 명칭 (예: 프레임 색상)">
                </div>
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="width:30px;">🇯🇵</span>
                    <input id="modalCatNameJP" class="input-text" placeholder="일본어 명칭">
                </div>
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="width:30px;">🇺🇸</span>
                    <input id="modalCatNameUS" class="input-text" placeholder="영어 명칭">
                </div>
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="width:30px;">🇨🇳</span>
                    <input id="modalCatNameCN" class="input-text" placeholder="중국어 명칭">
                </div>
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="width:30px;">🇸🇦</span>
                    <input id="modalCatNameAR" class="input-text" placeholder="아랍어 명칭">
                </div>
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="width:30px;">🇪🇸</span>
                    <input id="modalCatNameES" class="input-text" placeholder="스페인어 명칭">
                </div>
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="width:30px;">🇩🇪</span>
                    <input id="modalCatNameDE" class="input-text" placeholder="독일어 명칭">
                </div>
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="width:30px;">🇫🇷</span>
                    <input id="modalCatNameFR" class="input-text" placeholder="프랑스어 명칭">
                </div>
            </div>
        </div>

        <button class="btn btn-primary" style="width:100%; height:45px; font-size:16px;" onclick="saveAddonCategoryFromModal()">저장하기</button>
        
    </div>
</div>
<div id="bulkHtmlModal" class="modal-overlay" style="display:none; z-index:9999;">
    <div class="modal-box" style="width: 800px; max-width: 95%;">
        <div class="modal-header" style="background:#db2777; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:bold; font-size:16px;">📝 상세페이지(HTML) 일괄 채우기</span>
            <button class="btn btn-sm" onclick="document.getElementById('bulkHtmlModal').style.display='none'" style="border:none; background:transparent; color:white; font-size:20px; cursor:pointer;">✕</button>
        </div>
        <div style="padding:20px; max-height: 70vh; overflow-y:auto;">
            <div style="background:#fff1f2; color:#be123c; padding:10px; border-radius:6px; margin-bottom:15px; font-size:13px;">
                ⚠️ <b>주의:</b> 현재 상세페이지 내용이 <b>"비어있는 상품"</b>에만 적용됩니다.<br>
                기존에 내용이 있는 상품은 덮어씌워지지 않습니다.
            </div>

            <label class="form-label" style="font-weight:bold; margin-bottom:5px; display:block;">🇰🇷 한국어 (KR) HTML 내용</label>
            <textarea id="bulkHtmlKR" class="input-text" style="width:100%; height:100px; font-family:monospace; margin-bottom:10px;" placeholder="<p><img src='...'></p>"></textarea>

            <label class="form-label" style="font-weight:bold; margin-bottom:5px; display:block;">🇯🇵 일본어 (JP) HTML 내용</label>
            <textarea id="bulkHtmlJP" class="input-text" style="width:100%; height:100px; font-family:monospace; margin-bottom:10px;" placeholder="번역된 HTML 입력..."></textarea>

            <label class="form-label" style="font-weight:bold; margin-bottom:5px; display:block;">🇺🇸 영어 (US) HTML 내용</label>
            <textarea id="bulkHtmlUS" class="input-text" style="width:100%; height:100px; font-family:monospace;" placeholder="번역된 HTML 입력..."></textarea>
        </div>
        <div style="padding:15px; border-top:1px solid #eee; text-align:right; background:#f9fafb; border-radius:0 0 8px 8px;">
            <button class="btn btn-outline" onclick="document.getElementById('bulkHtmlModal').style.display='none'" style="margin-right:5px;">취소</button>
            <button class="btn btn-primary" onclick="runBulkHtmlUpdate()" style="background:#db2777; border-color:#be185d;">🚀 일괄 적용하기</button>
        </div>
    </div>
</div>

<div id="commonInfoModal" class="modal-overlay" style="display:none; z-index:50000;">
    <div class="modal-box" style="width: 1000px; max-width: 95%; height: 90vh; display:flex; flex-direction:column;">
        <div class="modal-header" style="background: linear-gradient(135deg, #7c3aed, #6d28d9); color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:bold; font-size:18px;"><i class="fa-solid fa-bullhorn"></i> 상품 공통정보 관리 (상단 노출)</span>
            <button onclick="document.getElementById('commonInfoModal').style.display='none'" style="border:none; background:transparent; color:white; font-size:24px; cursor:pointer;">✕</button>
        </div>
        
        <div style="background:#f3f4f6; padding:15px 20px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:10px;">
                <label style="font-weight:bold; color:#374151;">적용 대상:</label>
                <select id="commonInfoCategory" class="input-text" style="width:200px; font-weight:bold;" onchange="loadCommonInfoContent(this.value)">
                    <option value="all">🌍 전체 상품 공통</option>
                </select>
            </div>
            <button id="btnRestoreCommon" class="btn btn-outline btn-sm" disabled onclick="restoreCommonInfo()">
                <i class="fa-solid fa-clock-rotate-left"></i> 백업 불러오기
            </button>
        </div>

        <div style="flex:1; overflow-y:auto; padding:20px; background:#fff;">
            <div style="margin-bottom:20px;">
                <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                    <span style="font-size:20px;">🇰🇷</span><span style="font-weight:bold; color:#1e293b;">한국어 (Default)</span>
                </div>
                <textarea id="commonHtmlKR" class="input-text" style="width:100%; height:150px; font-family:monospace; line-height:1.5; resize:vertical;" placeholder="HTML 태그 입력..."></textarea>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px;">
                <div>
                    <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                        <span style="font-size:20px;">🇯🇵</span><span style="font-weight:bold; color:#1e293b;">일본어 (JP)</span>
                    </div>
                    <textarea id="commonHtmlJP" class="input-text" style="width:100%; height:120px; font-family:monospace; resize:vertical;" placeholder="일본어 HTML..."></textarea>
                </div>
                <div>
                    <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                        <span style="font-size:20px;">🇺🇸</span><span style="font-weight:bold; color:#1e293b;">영어 (US)</span>
                    </div>
                    <textarea id="commonHtmlUS" class="input-text" style="width:100%; height:120px; font-family:monospace; resize:vertical;" placeholder="영어 HTML..."></textarea>
                </div>
                <div>
                    <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                        <span style="font-size:20px;">🇨🇳</span><span style="font-weight:bold; color:#1e293b;">중국어 (CN)</span>
                    </div>
                    <textarea id="commonHtmlCN" class="input-text" style="width:100%; height:120px; font-family:monospace; resize:vertical;" placeholder="중국어 HTML..."></textarea>
                </div>
                <div>
                    <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                        <span style="font-size:20px;">🇸🇦</span><span style="font-weight:bold; color:#1e293b;">아랍어 (AR)</span>
                    </div>
                    <textarea id="commonHtmlAR" class="input-text" style="width:100%; height:120px; font-family:monospace; resize:vertical;" placeholder="아랍어 HTML..."></textarea>
                </div>
                <div>
                    <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                        <span style="font-size:20px;">🇪🇸</span><span style="font-weight:bold; color:#1e293b;">스페인어 (ES)</span>
                    </div>
                    <textarea id="commonHtmlES" class="input-text" style="width:100%; height:120px; font-family:monospace; resize:vertical;" placeholder="스페인어 HTML..."></textarea>
                </div>
                <div>
                    <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                        <span style="font-size:20px;">🇩🇪</span><span style="font-weight:bold; color:#1e293b;">독일어 (DE)</span>
                    </div>
                    <textarea id="commonHtmlDE" class="input-text" style="width:100%; height:120px; font-family:monospace; resize:vertical;" placeholder="독일어 HTML..."></textarea>
                </div>
                <div>
                    <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                        <span style="font-size:20px;">🇫🇷</span><span style="font-weight:bold; color:#1e293b;">프랑스어 (FR)</span>
                    </div>
                    <textarea id="commonHtmlFR" class="input-text" style="width:100%; height:120px; font-family:monospace; resize:vertical;" placeholder="프랑스어 HTML..."></textarea>
                </div>
            </div>
            <div style="margin-top:20px; background:#fff7ed; border:1px solid #fed7aa; padding:15px; border-radius:8px; font-size:13px; color:#c2410c;">
                <b>💡 팁:</b> 카테고리를 지정하면 해당 카테고리 상품에는 '전체 공통' 대신 '카테고리 공통' 정보가 나옵니다.
            </div>
        </div>

        <div style="padding:15px 20px; border-top:1px solid #e5e7eb; text-align:right; background:#f9fafb; border-radius:0 0 12px 12px;">
            <button class="btn btn-outline" onclick="document.getElementById('commonInfoModal').style.display='none'" style="margin-right:10px;">닫기</button>
            <button class="btn btn-primary" onclick="saveCommonInfo()" style="background:#7c3aed; border-color:#6d28d9; padding:12px 30px; font-size:15px;">
                <i class="fa-solid fa-floppy-disk"></i> 저장 및 적용
            </button>
        </div>
    </div>
</div>

<script>
// 1. 모달 열기 및 데이터 불러오기
async function openCommonInfoModal() {
    const dbClient = window.sb || window._supabase;
    if (!dbClient) { showToast("DB 연결 실패", "error"); return; }

    document.getElementById('commonInfoModal').style.display = 'flex';
    document.getElementById('commonHtmlContent').value = "로딩 중...";

    // 'top' 섹션의 저장된 HTML 가져오기
    const { data, error } = await dbClient
        .from('common_info')
        .select('content')
        .eq('section', 'top')
        .single();

    if (error && error.code !== 'PGRST116') { // 데이터가 없으면 에러 아님
        console.error(error);
        showToast("불러오기 실패: " + error.message, "error");
    }

    document.getElementById('commonHtmlContent').value = data ? data.content : '';
}

// 2. 데이터 저장하기
async function saveCommonInfo() {
    const html = document.getElementById('commonHtmlContent').value;
    const dbClient = window.sb || window._supabase;

    if(!confirm("이 내용을 저장하시겠습니까?\n모든 상품 상세페이지 상단에 즉시 적용됩니다.")) return;

    // 'upsert'는 있으면 수정, 없으면 새로 만드는 명령어입니다.
    const { error } = await dbClient
        .from('common_info')
        .upsert({ section: 'top', content: html });

    if (error) {
        showToast("저장 실패: " + error.message, "error");
    } else {
        showToast("저장되었습니다!\n이제 쇼핑몰 상세페이지에 들어가면 상단에 이 내용이 뜹니다.", "success");
        document.getElementById('commonInfoModal').style.display = 'none';
    }
}
</script>

<script>
// ═══ AI 챗봇 학습 관리 ═══
(function() {
    function getSb() { return window.sb; }
    window.cbShowTab = function(tab) {
        document.getElementById('cbPanelLogs').style.display = (tab === 'logs') ? 'block' : 'none';
        document.getElementById('cbPanelKnowledge').style.display = (tab === 'knowledge') ? 'block' : 'none';
        document.getElementById('cbPanelSettings').style.display = (tab === 'settings') ? 'block' : 'none';
        document.getElementById('cbTabLogs').className = 'btn btn-' + (tab === 'logs' ? 'primary' : 'outline') + ' btn-sm';
        document.getElementById('cbTabKnowledge').className = 'btn btn-' + (tab === 'knowledge' ? 'primary' : 'outline') + ' btn-sm';
        document.getElementById('cbTabSettings').className = 'btn btn-' + (tab === 'settings' ? 'primary' : 'outline') + ' btn-sm';
        if (tab === 'logs') cbLoadLogs();
        if (tab === 'knowledge') cbLoadKnowledge();
        if (tab === 'settings') cbLoadSettings();
    };
    var cbKnAllData = []; // 로컬 캐시 (검색용)
    window.cbLoadKnowledge = async function() {
        var sb = getSb(); if (!sb) return;
        var lang = document.getElementById('cbKnFilter').value;
        var search = (document.getElementById('cbKnSearch') ? document.getElementById('cbKnSearch').value.trim() : '');
        var q = sb.from('chatbot_knowledge').select('*').eq('is_active', true).order('priority', {ascending: false}).limit(200);
        if (lang !== 'all') q = q.eq('language', lang);
        if (search) q = q.or('question.ilike.%' + search + '%,answer.ilike.%' + search + '%,keywords.ilike.%' + search + '%,category.ilike.%' + search + '%');
        var res = await q;
        cbKnAllData = res.data || [];
        cbRenderKnowledge(cbKnAllData);
    };
    window.cbFilterLocal = function() {
        var search = (document.getElementById('cbKnSearch') ? document.getElementById('cbKnSearch').value.trim().toLowerCase() : '');
        if (!search) { cbRenderKnowledge(cbKnAllData); return; }
        var filtered = cbKnAllData.filter(function(k) {
            return (k.question||'').toLowerCase().indexOf(search) >= 0
                || (k.answer||'').toLowerCase().indexOf(search) >= 0
                || (k.keywords||'').toLowerCase().indexOf(search) >= 0
                || (k.category||'').toLowerCase().indexOf(search) >= 0;
        });
        cbRenderKnowledge(filtered);
    };
    function cbRenderKnowledge(data) {
        var list = document.getElementById('cbKnList');
        var countEl = document.getElementById('cbKnCount');
        if (countEl) countEl.textContent = '(' + data.length + '건)';
        if (!data || data.length === 0) { list.innerHTML = '<p style="color:#94a3b8; text-align:center; padding:30px;">데이터 없음</p>'; return; }
        var html = '<table style="width:100%; font-size:12px; border-collapse:collapse;"><thead><tr style="background:#f8fafc; position:sticky; top:0; z-index:1;"><th style="padding:8px 6px; text-align:left;">카테고리</th><th style="padding:8px 6px; text-align:left;">질문</th><th style="padding:8px 6px; text-align:left;">답변</th><th style="padding:8px 6px; text-align:left;">키워드</th><th style="padding:8px 6px; text-align:center; width:50px;">순위</th><th style="padding:8px 6px; text-align:center; width:100px;">관리</th></tr></thead><tbody>';
        data.forEach(function(k) {
            html += '<tr style="border-bottom:1px solid #f1f5f9; transition:background 0.1s;" onmouseenter="this.style.background=\'#f8fafc\'" onmouseleave="this.style.background=\'#fff\'">';
            html += '<td style="padding:6px;"><span style="background:#e0e7ff; padding:2px 6px; border-radius:6px; font-size:11px;">' + (k.category||'일반') + '</span></td>';
            html += '<td style="padding:6px; max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="' + (k.question||'').replace(/"/g,'&quot;') + '">' + (k.question||'').substring(0,35) + '</td>';
            html += '<td style="padding:6px; max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="' + (k.answer||'').replace(/"/g,'&quot;') + '">' + (k.answer||'').substring(0,45) + '</td>';
            html += '<td style="padding:6px; font-size:10px; color:#64748b; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">' + (k.keywords||'-') + '</td>';
            html += '<td style="padding:6px; text-align:center; color:#6366f1; font-weight:600;">' + (k.priority||0) + '</td>';
            html += '<td style="padding:6px; text-align:center; white-space:nowrap;"><button class="btn btn-outline btn-sm" style="font-size:11px; padding:2px 8px; margin-right:3px;" onclick="cbOpenEdit(' + k.id + ')">✏️</button><button class="btn btn-outline btn-sm" style="color:#ef4444; font-size:11px; padding:2px 8px;" onclick="cbDeleteKn(' + k.id + ')">🗑</button></td></tr>';
        });
        list.innerHTML = html + '</tbody></table>';
    }
    window.cbAddKnowledge = async function() {
        var sb = getSb(); if (!sb) return;
        var q = document.getElementById('cbNewQ').value.trim(), a = document.getElementById('cbNewA').value.trim();
        if (!q || !a) { showToast('질문과 답변을 입력하세요', 'warn'); return; }
        await sb.from('chatbot_knowledge').insert({ category: document.getElementById('cbNewCat').value, question: q, answer: a, keywords: document.getElementById('cbNewKw').value.trim(), language: document.getElementById('cbNewLang').value, priority: parseInt(document.getElementById('cbNewPri').value) || 5 });
        document.getElementById('cbNewQ').value = ''; document.getElementById('cbNewA').value = ''; document.getElementById('cbNewKw').value = '';
        showToast('저장! AI에 즉시 반영됩니다.', 'success'); cbLoadKnowledge(); if(window.lcLoadQuickReplies) lcLoadQuickReplies();
    };
    window.cbDeleteKn = async function(id) { if (!confirm('삭제?')) return; await getSb().from('chatbot_knowledge').update({is_active:false}).eq('id',id); cbLoadKnowledge(); if(window.lcLoadQuickReplies) lcLoadQuickReplies(); };
    window.cbOpenEdit = function(id) {
        var item = cbKnAllData.find(function(k){ return k.id === id; });
        if (!item) { showToast('데이터를 찾을 수 없습니다.', 'warn'); return; }
        document.getElementById('cbEditId').value = id;
        document.getElementById('cbEditCat').value = item.category || '기타';
        document.getElementById('cbEditLang').value = item.language || 'ko';
        document.getElementById('cbEditQ').value = item.question || '';
        document.getElementById('cbEditA').value = item.answer || '';
        document.getElementById('cbEditKw').value = item.keywords || '';
        document.getElementById('cbEditPri').value = item.priority || 5;
        var modal = document.getElementById('cbEditModal');
        modal.style.display = 'flex';
    };
    window.cbCloseEdit = function() {
        document.getElementById('cbEditModal').style.display = 'none';
    };
    window.cbSaveEdit = async function() {
        var sb = getSb(); if (!sb) return;
        var id = parseInt(document.getElementById('cbEditId').value);
        if (!id) return;
        var q = document.getElementById('cbEditQ').value.trim();
        var a = document.getElementById('cbEditA').value.trim();
        if (!q || !a) { showToast('질문과 답변을 입력하세요.', 'warn'); return; }
        var upd = {
            category: document.getElementById('cbEditCat').value,
            language: document.getElementById('cbEditLang').value,
            question: q,
            answer: a,
            keywords: document.getElementById('cbEditKw').value.trim(),
            priority: parseInt(document.getElementById('cbEditPri').value) || 5
        };
        var res = await sb.from('chatbot_knowledge').update(upd).eq('id', id);
        if (res.error) { showToast('저장 실패: ' + res.error.message, 'error'); return; }
        showToast('수정 완료!', 'success');
        cbCloseEdit();
        cbLoadKnowledge();
        if (window.lcLoadQuickReplies) lcLoadQuickReplies();
    };
    window.cbLoadLogs = async function() {
        var sb = getSb(); if (!sb) return;
        var filter = document.getElementById('cbLogFilter').value, today = new Date().toISOString().split('T')[0];
        try {
            var [ta, tu, tt, tk] = await Promise.all([
                sb.from('chatbot_logs').select('id',{count:'exact',head:true}).gte('created_at',today+'T00:00:00'),
                sb.from('chatbot_logs').select('id',{count:'exact',head:true}).gte('created_at',today+'T00:00:00').eq('is_resolved',false),
                sb.from('chatbot_logs').select('id',{count:'exact',head:true}).eq('needs_training',true).eq('is_resolved',false),
                sb.from('chatbot_knowledge').select('id',{count:'exact',head:true}).eq('is_active',true)
            ]);
            document.getElementById('cbDailyReport').innerHTML = '<div style="background:#ede9fe;padding:12px;border-radius:10px;text-align:center;"><div style="font-size:22px;font-weight:900;color:#6366f1;">'+(ta.count||0)+'</div><div style="font-size:11px;color:#64748b;">오늘 상담</div></div><div style="background:#fef2f2;padding:12px;border-radius:10px;text-align:center;"><div style="font-size:22px;font-weight:900;color:#ef4444;">'+(tu.count||0)+'</div><div style="font-size:11px;">미해결</div></div><div style="background:#fefce8;padding:12px;border-radius:10px;text-align:center;"><div style="font-size:22px;font-weight:900;color:#f59e0b;">'+(tt.count||0)+'</div><div style="font-size:11px;">🚨 학습필요</div></div><div style="background:#d1fae5;padding:12px;border-radius:10px;text-align:center;"><div style="font-size:22px;font-weight:900;color:#059669;">'+(tk.count||0)+'</div><div style="font-size:11px;">학습데이터</div></div>';
        } catch(e){}
        var urgR = await sb.from('chatbot_logs').select('id, user_message, bot_reply').eq('needs_training',true).eq('is_resolved',false).order('created_at',{ascending:false}).limit(10);
        var ub = document.getElementById('cbUrgentBox'), ul = document.getElementById('cbUrgentList');
        if (urgR.data && urgR.data.length > 0) { ub.style.display='block'; var h=''; urgR.data.forEach(function(l){ h+='<div style="background:#fff;border:1px solid #fca5a5;border-radius:8px;padding:8px;margin-bottom:4px;font-size:12px;"><b style="color:#dc2626;">❓</b> '+l.user_message+'<br><span style="color:#94a3b8;">AI: '+((l.bot_reply||'').substring(0,80))+'</span><br><button class="btn btn-primary btn-sm" style="font-size:10px;margin-top:4px;background:#dc2626;" onclick="cbTrainFromLog('+l.id+',\''+l.user_message.replace(/'/g,"\\'").replace(/\n/g," ")+'\')">📚 답변등록</button> <button class="btn btn-outline btn-sm" style="font-size:10px;" onclick="cbResolveLog('+l.id+')">✅ 문제없음</button></div>'; }); ul.innerHTML=h; } else { ub.style.display='none'; }
        var q2 = sb.from('chatbot_logs').select('id, created_at, needs_training, is_resolved, user_message, bot_reply').order('created_at',{ascending:false}).limit(30);
        if (filter==='unresolved') q2=q2.eq('is_resolved',false); if (filter==='needs_training') q2=q2.eq('needs_training',true);
        var dv = document.getElementById('cbLogDate').value; if(dv) q2=q2.gte('created_at',dv+'T00:00:00').lte('created_at',dv+'T23:59:59');
        var r = await q2; var list = document.getElementById('cbLogList'); document.getElementById('cbLogCount').textContent='총 '+(r.data?r.data.length:0)+'건';
        if(!r.data||r.data.length===0){list.innerHTML='<p style="text-align:center;color:#94a3b8;">기록 없음</p>';return;}
        var h=''; r.data.forEach(function(l){ var t=new Date(l.created_at).toLocaleString('ko-KR'); h+='<div style="border:1px solid '+(l.needs_training?'#fca5a5':'#e2e8f0')+';border-radius:8px;padding:10px;margin-bottom:6px;background:'+(l.needs_training?'#fffbeb':'#fff')+';font-size:12px;"><div style="display:flex;justify-content:space-between;"><span style="color:#94a3b8;font-size:11px;">'+t+'</span><span style="background:'+(l.is_resolved?'#10b981':'#ef4444')+';color:#fff;padding:1px 6px;border-radius:6px;font-size:10px;">'+(l.is_resolved?'해결':'미해결')+'</span></div><div style="background:#f0f9ff;padding:6px 10px;border-radius:6px;margin:6px 0;"><b style="color:#0284c7;">고객:</b> '+l.user_message+'</div><div style="background:#f8fafc;padding:6px 10px;border-radius:6px;"><b style="color:#6366f1;">AI:</b> '+((l.bot_reply||'').substring(0,150))+'</div><div style="margin-top:6px;display:flex;gap:4px;">'+(l.is_resolved?'':'<button class="btn btn-outline btn-sm" style="font-size:10px;" onclick="cbResolveLog('+l.id+')">✅</button>')+'<button class="btn btn-outline btn-sm" style="font-size:10px;color:#f59e0b;" onclick="cbTrainFromLog('+l.id+',\''+l.user_message.replace(/'/g,"\\'").replace(/\n/g," ")+'\')">📚 학습</button></div></div>'; });
        list.innerHTML=h;
    };
    window.cbResolveLog = async function(id) { await getSb().from('chatbot_logs').update({is_resolved:true}).eq('id',id); cbLoadLogs(); };
    window.cbTrainFromLog = function(id, q) { cbShowTab('knowledge'); document.getElementById('cbNewQ').value=q; document.getElementById('cbNewA').focus(); getSb().from('chatbot_logs').update({needs_training:true}).eq('id',id).then(function(){}); };
    window.cbLoadSettings = async function() {
        var sb = getSb(); var r = await sb.from('chatbot_knowledge').select('answer').eq('category','_system_prompt').eq('is_active',true).maybeSingle();
        if(r.data) document.getElementById('cbCustomPrompt').value=r.data.answer;
        var [ta, tk] = await Promise.all([sb.from('chatbot_logs').select('id',{count:'exact',head:true}), sb.from('chatbot_knowledge').select('id',{count:'exact',head:true}).eq('is_active',true)]);
        document.getElementById('cbStats').innerHTML='<div style="background:#ede9fe;padding:15px;border-radius:10px;text-align:center;"><div style="font-size:24px;font-weight:900;color:#6366f1;">'+(ta.count||0)+'</div><div style="font-size:11px;">총 상담</div></div><div style="background:#d1fae5;padding:15px;border-radius:10px;text-align:center;"><div style="font-size:24px;font-weight:900;color:#059669;">'+(tk.count||0)+'</div><div style="font-size:11px;">학습 데이터</div></div>';
    };
    window.cbSaveSettings = async function() {
        var sb=getSb(); await sb.from('chatbot_knowledge').update({is_active:false}).eq('category','_system_prompt');
        var p=document.getElementById('cbCustomPrompt').value.trim();
        if(p) await sb.from('chatbot_knowledge').insert({category:'_system_prompt',question:'시스템설정',answer:p,language:'ko',priority:100});
        showToast('설정 저장!', 'success');
    };
})();

// ═══ 실시간 상담 관리 ═══
(function() {
    var currentRoom=null, currentFilter='waiting', subscription=null, globalRoomSub=null;
    function getSb(){return window.sb;}

    // ══════════════════════════════════════════════
    // ★ 강화된 알림 시스템 v4 — 항상 알림 + 반복 알람 + 배지 + 강한 사운드
    // ══════════════════════════════════════════════
    var notifyAll = false;  // TTS/데스크톱 알림 (일반 유입)
    var notifyMgr = false;  // TTS/데스크톱 알림 (내 담당)
    var myManagerName = '';  // 접속한 매니저 이름
    try { notifyAll = localStorage.getItem('lcNotifyAll') === 'on'; } catch(e) {}
    try { notifyMgr = localStorage.getItem('lcNotifyMgr') === 'on'; } catch(e) {}
    try { myManagerName = localStorage.getItem('lcMyManager') || ''; } catch(e) {}
    var _audioCtx = null;
    var _msgSubChannel = null;
    var _unreadCount = 0;         // 미확인 메시지 수
    var _repeatAlarmTimer = null; // 반복 알람 타이머
    var _lastAlarmTime = 0;       // 마지막 알람 시간 (중복 방지)
    var _unreadPollTimer = null;  // 20초 폴링 타이머
    var _lastUnreadTotal = 0;     // 이전 폴링의 미확인 수 (새 알림 판단용)

    // 내 매니저 이름 저장/로드
    window.lcSaveMyName = function() {
        var sel = document.getElementById('lcMyManagerName');
        if (!sel) return;
        myManagerName = sel.value;
        localStorage.setItem('lcMyManager', myManagerName);
        updateNotifyUI();
        lcLoadRooms(); // 이름 변경 시 목록 새로고침 (필터 적용)
    };
    // 매니저 목록 로드 → select 채우기
    async function loadManagerOptions() {
        var sb = getSb(); if (!sb) { setTimeout(loadManagerOptions, 2000); return; }
        var r = await sb.from('chatbot_knowledge').select('question,answer').eq('category','_managers').eq('is_active',true);
        var sel = document.getElementById('lcMyManagerName');
        if (!sel || !r.data) return;
        var saved = myManagerName;
        sel.innerHTML = '<option value="">전체 보기</option><option value="__HQ__"' + (saved === '__HQ__' ? ' selected' : '') + '>본사상담</option>';
        r.data.forEach(function(m) {
            try { var info = JSON.parse(m.answer); } catch(e) { var info = { name: m.question }; }
            var name = info.name || m.question;
            var opt = document.createElement('option');
            opt.value = name; opt.textContent = name + (info.role ? ' (' + info.role + ')' : '');
            if (name === saved) opt.selected = true;
            sel.appendChild(opt);
        });
    }
    setTimeout(loadManagerOptions, 1500);

    // ── 내 알림인지 판단 (TTS/데스크톱 전용 필터) ──
    function isMyNotification(assignedMgr) {
        if (!assignedMgr) return notifyAll;
        if (myManagerName && assignedMgr === myManagerName) return (notifyMgr || notifyAll);
        return false;
    }
    // ── 사운드+토스트는 항상 울릴지 판단 ──
    function shouldAlwaysAlert(assignedMgr) {
        // 미배정 → 항상 알림 (누군가 응답해야)
        if (!assignedMgr) return true;
        // 내 담당 → 항상 알림
        if (myManagerName && assignedMgr === myManagerName) return true;
        // 매니저 미선택 → 전체 알림
        if (!myManagerName) return true;
        return false;
    }

    // ── 강화된 알림음: 고객 메시지 (카카오톡 스타일 3연타) ──
    function playKakaoSound() {
        try {
            if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            var ctx = _audioCtx;
            if (ctx.state === 'suspended') ctx.resume();
            // 3회 반복 (0ms, 500ms, 1000ms)
            [0, 0.5, 1.0].forEach(function(rep) {
                [784, 988, 1175].forEach(function(freq, i) {
                    var osc = ctx.createOscillator();
                    var gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.type = 'sine'; osc.frequency.value = freq;
                    var t = ctx.currentTime + rep + i * 0.12;
                    gain.gain.setValueAtTime(1.0, t);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
                    osc.start(t); osc.stop(t + 0.2);
                });
            });
        } catch(e) {}
    }

    // ── 강화된 알림음: 새 상담 / 긴급 (경보 스타일 5연타) ──
    function playNewChatSound() {
        try {
            if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            var ctx = _audioCtx;
            if (ctx.state === 'suspended') ctx.resume();
            // 5회 반복 경보음
            [0, 0.35, 0.7, 1.05, 1.4].forEach(function(delay) {
                [660, 880, 1100].forEach(function(freq, i) {
                    var osc = ctx.createOscillator();
                    var gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.type = 'triangle'; osc.frequency.value = freq;
                    var t = ctx.currentTime + delay + i * 0.08;
                    gain.gain.setValueAtTime(1.0, t);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
                    osc.start(t); osc.stop(t + 0.15);
                });
            });
        } catch(e) {}
    }

    // ── 반복 경보음 (미응답 시 30초마다) ──
    function playRepeatAlarm() {
        try {
            if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            var ctx = _audioCtx;
            if (ctx.state === 'suspended') ctx.resume();
            // 낮은 톤 경고음 2회
            [0, 0.6].forEach(function(delay) {
                [440, 554, 660, 554, 440].forEach(function(freq, i) {
                    var osc = ctx.createOscillator();
                    var gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.type = 'square'; osc.frequency.value = freq;
                    var t = ctx.currentTime + delay + i * 0.1;
                    gain.gain.setValueAtTime(0.8, t);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.12);
                    osc.start(t); osc.stop(t + 0.12);
                });
            });
        } catch(e) {}
    }

    // TTS — MAX 볼륨 + 항상 담당자 이름 포함
    function speakTTS(text) {
        try {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            var u = new SpeechSynthesisUtterance(text);
            u.lang = 'ko-KR'; u.rate = 1.0; u.volume = 1.0;
            window.speechSynthesis.speak(u);
        } catch(e) {}
    }

    // 브라우저 데스크톱 알림
    function showDesktopNotify(title, body) {
        if (!('Notification' in window) || Notification.permission !== 'granted') return;
        try {
            var n = new Notification(title, {
                body: body,
                icon: 'https://qinvtnhiidtmrzosyvys.supabase.co/storage/v1/object/public/design/logo_icon.png',
                tag: 'chameleon-chat-' + Date.now(),
                requireInteraction: true
            });
            n.onclick = function() { window.focus(); n.close(); if (window.showSection) window.showSection('sec-live-chat'); };
            setTimeout(function() { n.close(); }, 15000);
        } catch(e) {}
    }

    // 인앱 토스트 배너 (스택 지원, 더 오래 표시)
    var _toastCount = 0;
    function showChatToast(title, body, isUrgent) {
        _toastCount++;
        var idx = _toastCount;
        var div = document.createElement('div');
        div.className = 'lc-toast-item';
        div.style.cssText = 'position:fixed;top:' + (16 + ((document.querySelectorAll('.lc-toast-item').length) * 80)) + 'px;right:16px;z-index:99999;min-width:340px;max-width:440px;background:' + (isUrgent ? 'linear-gradient(135deg,#dc2626,#ef4444)' : 'linear-gradient(135deg,#6366f1,#8b5cf6)') + ';color:#fff;border-radius:14px;padding:14px 18px;box-shadow:0 8px 30px rgba(0,0,0,0.35);animation:lcSlideIn .3s ease;cursor:pointer;';
        div.innerHTML = '<div style="display:flex;align-items:center;gap:10px;">'
            + '<div style="width:44px;height:44px;background:rgba(255,255,255,0.25);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;' + (isUrgent ? 'animation:lcPulse 0.5s ease infinite;' : '') + '">' + (isUrgent ? '🚨' : '💬') + '</div>'
            + '<div style="flex:1;"><div style="font-weight:700;font-size:15px;">' + title + '</div><div style="font-size:13px;opacity:0.9;margin-top:2px;">' + body + '</div></div>'
            + '<div onclick="event.stopPropagation();this.parentElement.parentElement.remove();" style="cursor:pointer;opacity:0.7;font-size:18px;padding:4px 8px;">✕</div>'
            + '</div>';
        div.onclick = function() { div.remove(); if (window.showSection) window.showSection('sec-live-chat'); };
        document.body.appendChild(div);
        if (!document.getElementById('lcToastCSS')) {
            var st = document.createElement('style'); st.id = 'lcToastCSS';
            st.textContent = '@keyframes lcSlideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes lcSlideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}@keyframes lcPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}@keyframes lcBadgePulse{0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(239,68,68,0.7)}50%{transform:scale(1.1);box-shadow:0 0 0 8px rgba(239,68,68,0)}}';
            document.head.appendChild(st);
        }
        // 긴급이면 10초, 일반이면 8초 후 자동 닫힘
        setTimeout(function() {
            if (div.parentElement) {
                div.style.animation = 'lcSlideOut .3s ease forwards';
                setTimeout(function() { if (div.parentElement) div.remove(); }, 300);
            }
        }, isUrgent ? 10000 : 8000);
    }

    // 타이틀 깜빡임 + 미확인 카운트 표시
    var _titleFlash = null;
    var _origTitle = '';
    function flashTitle(msg) {
        if (_titleFlash) return;
        _origTitle = document.title.replace(/^\(\d+\)\s*/, '').replace(/^🔴\s*/, '');
        var on = false;
        _titleFlash = setInterval(function() {
            var prefix = _unreadCount > 0 ? '(' + _unreadCount + ') ' : '';
            document.title = on ? prefix + _origTitle : '🔴 ' + msg;
            on = !on;
        }, 800);
        window.addEventListener('focus', function restore() {
            clearInterval(_titleFlash); _titleFlash = null;
            _updateTitleBadge();
            window.removeEventListener('focus', restore);
        });
    }
    function _updateTitleBadge() {
        var base = (_origTitle || document.title).replace(/^\(\d+\)\s*/, '').replace(/^🔴\s*/, '');
        document.title = _unreadCount > 0 ? '(' + _unreadCount + ') ' + base : base;
    }

    // ── 사이드바 미확인 배지 ──
    function updateUnreadBadge(delta) {
        if (delta > 0) _unreadCount += delta;
        // 사이드바 채팅 메뉴에 배지 추가
        var menuItems = document.querySelectorAll('.menu-item, .sidebar a, [onclick*="sec-live-chat"]');
        menuItems.forEach(function(el) {
            if (el.textContent.indexOf('채팅') >= 0 || el.textContent.indexOf('상담') >= 0 ||
                (el.getAttribute('onclick') || '').indexOf('sec-live-chat') >= 0) {
                var badge = el.querySelector('.lc-unread-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'lc-unread-badge';
                    badge.style.cssText = 'background:#ef4444;color:#fff;font-size:11px;font-weight:700;min-width:20px;height:20px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;margin-left:6px;padding:0 5px;animation:lcBadgePulse 1.5s ease infinite;';
                    el.style.position = 'relative';
                    el.appendChild(badge);
                }
                if (_unreadCount > 0) {
                    badge.textContent = _unreadCount > 99 ? '99+' : _unreadCount;
                    badge.style.display = 'inline-flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        });
        _updateTitleBadge();
    }
    function clearUnreadBadge() {
        _unreadCount = 0;
        _lastUnreadTotal = 0;
        updateUnreadBadge(0);
        stopRepeatAlarm();
        // 대기 탭 배지도 즉시 갱신
        checkUnreadAndNotify();
    }

    // ── 반복 알람 (미응답 시 30초마다 재알림) ──
    function startRepeatAlarm() {
        if (_repeatAlarmTimer) return;
        _repeatAlarmTimer = setInterval(function() {
            // 채팅 섹션을 보고 있으면 알람 중지
            var chatSec = document.getElementById('sec-live-chat');
            if (chatSec && chatSec.classList.contains('active') && !document.hidden) {
                stopRepeatAlarm();
                return;
            }
            playRepeatAlarm();
            // 타이틀도 다시 깜빡이기
            if (!_titleFlash) flashTitle('미확인 메시지 ' + _unreadCount + '건');
        }, 30000);
    }
    function stopRepeatAlarm() {
        if (_repeatAlarmTimer) { clearInterval(_repeatAlarmTimer); _repeatAlarmTimer = null; }
    }

    // ── 채팅 섹션 진입 시 배지 클리어 (MutationObserver 방식) ──
    (function() {
        var chatSec = document.getElementById('sec-live-chat');
        if (chatSec) {
            var obs = new MutationObserver(function() {
                if (chatSec.classList.contains('active')) clearUnreadBadge();
            });
            obs.observe(chatSec, { attributes: true, attributeFilter: ['class'] });
        } else {
            // DOM 아직 준비 안됨 → 대기
            setTimeout(function() {
                var cs = document.getElementById('sec-live-chat');
                if (cs) {
                    var obs2 = new MutationObserver(function() {
                        if (cs.classList.contains('active')) clearUnreadBadge();
                    });
                    obs2.observe(cs, { attributes: true, attributeFilter: ['class'] });
                }
            }, 3000);
        }
    })();
    // 포커스 복귀 시에도 체크
    window.addEventListener('focus', function() {
        var chatSec = document.getElementById('sec-live-chat');
        if (chatSec && chatSec.classList.contains('active')) {
            clearUnreadBadge();
        }
    });

    // ── 20초 폴링: 미확인 메시지 수 체크 + 대기 배지 + 알림 ──
    async function checkUnreadAndNotify() {
        var sb = getSb(); if (!sb) return;
        try {
            // 48시간 기준 시간
            var cutoff = new Date(Date.now() - 48 * 60 * 60 * 1000).toISOString();

            // 1) 대기(waiting) 상태 방의 수 → 대기 탭 배지 (48시간 이내)
            var waitRes = await sb.from('chat_rooms').select('id', {count:'exact'}).eq('status','waiting').gte('created_at', cutoff);
            var waitCount = (waitRes.count || 0);

            // 2) 미확인 고객 메시지 (48시간 이내만)
            var unreadRes = await sb.from('chat_messages').select('id', {count:'exact'}).eq('is_read', false).eq('sender_type', 'customer').gte('created_at', cutoff);
            var totalUnread = (unreadRes.count || 0);

            // 매니저 필터 적용한 미확인 수 (대기+내담당 방만)
            var filterMgr = myManagerName || '';
            var myUnread = totalUnread; // 기본은 전체
            if (filterMgr && filterMgr !== '' && filterMgr !== '__HQ__') {
                var myRooms = await sb.from('chat_rooms').select('id').or('assigned_manager.eq.' + filterMgr + ',status.eq.waiting,status.eq.ai_chatting').gte('created_at', cutoff);
                if (myRooms.data && myRooms.data.length > 0) {
                    var roomIds = myRooms.data.map(function(r) { return r.id; });
                    var myUnreadRes = await sb.from('chat_messages').select('id', {count:'exact'}).eq('is_read', false).eq('sender_type', 'customer').gte('created_at', cutoff).in('room_id', roomIds);
                    myUnread = (myUnreadRes.count || 0);
                } else {
                    myUnread = 0;
                }
            }

            // 대기 탭 배지 = 대기(waiting) 방 수
            var waitBadge = document.getElementById('lcWaitBadge');
            if (waitBadge) {
                if (waitCount > 0) {
                    waitBadge.textContent = waitCount > 99 ? '99+' : waitCount;
                    waitBadge.style.display = 'flex';
                } else {
                    waitBadge.style.display = 'none';
                }
            }
            // 전체 탭 배지 = 미확인 메시지 수
            var allBadge = document.getElementById('lcAllBadge');
            if (allBadge) {
                if (myUnread > 0) {
                    allBadge.textContent = myUnread > 99 ? '99+' : myUnread;
                    allBadge.style.display = 'flex';
                } else {
                    allBadge.style.display = 'none';
                }
            }

            // 사이드바 배지도 업데이트
            _unreadCount = myUnread;
            updateUnreadBadge(0);

            // 채팅 섹션 활성화 상태 확인
            var chatSec = document.getElementById('sec-live-chat');
            var isChatActive = chatSec && chatSec.classList.contains('active') && !document.hidden;

            // ★ 채팅 섹션 보고 있으면 방 목록도 자동 갱신 (20초마다)
            if (isChatActive && window.lcLoadRooms) {
                window.lcLoadRooms();
            }

            // 새 미확인 발생 시 또는 계속 미확인이 있으면 알림
            if (myUnread > 0) {
                if (!isChatActive) {
                    // 새 미확인 증가 시 강한 알림
                    if (myUnread > _lastUnreadTotal) {
                        playKakaoSound();
                        showChatToast('📬 미확인 메시지 ' + myUnread + '건', '확인하지 않은 고객 메시지가 있습니다', true);
                    } else {
                        // 계속 미확인 → 부드러운 반복 알림
                        playRepeatAlarm();
                    }
                    flashTitle('미확인 메시지 ' + myUnread + '건');
                }
            } else {
                // 미확인 없음 → 타이틀 원복
                if (_titleFlash) { clearInterval(_titleFlash); _titleFlash = null; }
                _updateTitleBadge();
            }
            _lastUnreadTotal = myUnread;
        } catch(e) {
            console.warn('⚠️ [폴링] checkUnreadAndNotify 에러:', e);
        }
    }
    // 20초 간격 폴링 시작
    function startUnreadPolling() {
        if (_unreadPollTimer) return;
        checkUnreadAndNotify(); // 즉시 1회
        _unreadPollTimer = setInterval(checkUnreadAndNotify, 20000);
    }
    setTimeout(startUnreadPolling, 3000); // 페이지 로드 3초 후 시작

    // ── 통합 알림 발송 v4 — 사운드+토스트는 항상, TTS/데스크톱은 필터 ──
    function sendNotification(title, body, ttsText, assignedMgr, isUrgent) {
        console.log('🔔 [sendNotification] 호출:', title, '| mgr:', assignedMgr, '| urgent:', isUrgent);
        var now = Date.now();
        // 1초 내 중복 알림 방지
        if (now - _lastAlarmTime < 1000) {
            console.log('🔇 [sendNotification] 1초 내 중복 → 스킵');
            return;
        }
        _lastAlarmTime = now;

        // ★ 사운드+토스트는 항상 (관련 고객이면)
        var alert = shouldAlwaysAlert(assignedMgr);
        console.log('🔔 [sendNotification] shouldAlwaysAlert:', alert, '| myName:', myManagerName);
        if (alert) {
            try { if (isUrgent) { playNewChatSound(); } else { playKakaoSound(); } } catch(e) { console.error('사운드 에러:', e); }
            try { showChatToast(title, body, isUrgent); } catch(e) { console.error('토스트 에러:', e); }
            try { flashTitle(title); } catch(e) { console.error('타이틀 에러:', e); }
            try { updateUnreadBadge(1); } catch(e) { console.error('배지 에러:', e); }
            try { startRepeatAlarm(); } catch(e) { console.error('반복알람 에러:', e); }
        }

        // TTS + 데스크톱 알림 = 토글 ON일 때만
        if ((notifyAll || notifyMgr) && isMyNotification(assignedMgr)) {
            if (ttsText) speakTTS(ttsText);
            showDesktopNotify(title, body);
        }
    }

    // ── 알림 토글 ──
    function ensureNotifyPermission(callback) {
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(function(perm) { callback(perm === 'granted'); });
        } else { callback(true); }
    }

    window.lcToggleNotifyAll = function() {
        if (!myManagerName) { showToast('먼저 "내 이름"을 선택하세요!', 'warn'); return; }
        if (!notifyAll) {
            ensureNotifyPermission(function() {
                notifyAll = true; localStorage.setItem('lcNotifyAll', 'on');
                updateNotifyUI(); startMessageWatch(); playKakaoSound();
                showToast(myManagerName + '님, 일반 유입 알림 ON — 미배정 + 내 담당 고객 알림', 'success');
            });
        } else {
            notifyAll = false; localStorage.setItem('lcNotifyAll', 'off');
            updateNotifyUI();
        }
    };

    window.lcToggleNotifyMgr = function() {
        if (!myManagerName) { showToast('먼저 "내 이름"을 선택하세요!', 'warn'); return; }
        if (!notifyMgr) {
            ensureNotifyPermission(function() {
                notifyMgr = true; localStorage.setItem('lcNotifyMgr', 'on');
                updateNotifyUI(); startMessageWatch(); playKakaoSound();
                showToast(myManagerName + '님, 내 담당 고객 알림 ON', 'success');
            });
        } else {
            notifyMgr = false; localStorage.setItem('lcNotifyMgr', 'off');
            updateNotifyUI();
        }
    };

    function updateNotifyUI() {
        var myName = myManagerName || '미선택';
        // 전체 알림 버튼
        var allBtn = document.getElementById('lcNotifyAllBtn');
        var megaAll = document.getElementById('lcMegaAll');
        var allSt = document.getElementById('lcNotifyAllStatus');
        if (allBtn) {
            if (notifyAll) {
                allBtn.style.border = '2px solid #22c55e'; allBtn.style.background = '#f0fdf4';
                if (megaAll) { megaAll.setAttribute('stroke', '#22c55e'); megaAll.setAttribute('fill', '#dcfce7'); megaAll.style.opacity = '1'; }
                if (allSt) { allSt.textContent = 'ON'; allSt.style.color = '#22c55e'; allSt.style.fontWeight = '700'; }
            } else {
                allBtn.style.border = '2px solid #e2e8f0'; allBtn.style.background = '#fff';
                if (megaAll) { megaAll.setAttribute('stroke', '#cbd5e1'); megaAll.setAttribute('fill', 'none'); megaAll.style.opacity = '0.4'; }
                if (allSt) { allSt.textContent = 'OFF'; allSt.style.color = '#94a3b8'; allSt.style.fontWeight = '400'; }
            }
        }
        // 매니저 지정 버튼
        var mgrBtn = document.getElementById('lcNotifyMgrBtn');
        var megaMgr = document.getElementById('lcMegaMgr');
        var mgrSt = document.getElementById('lcNotifyMgrStatus');
        if (mgrBtn) {
            if (notifyMgr) {
                mgrBtn.style.border = '2px solid #6366f1'; mgrBtn.style.background = '#eef2ff';
                if (megaMgr) { megaMgr.setAttribute('stroke', '#6366f1'); megaMgr.setAttribute('fill', '#e0e7ff'); megaMgr.style.opacity = '1'; }
                if (mgrSt) { mgrSt.textContent = 'ON'; mgrSt.style.color = '#6366f1'; mgrSt.style.fontWeight = '700'; }
            } else {
                mgrBtn.style.border = '2px solid #e2e8f0'; mgrBtn.style.background = '#fff';
                if (megaMgr) { megaMgr.setAttribute('stroke', '#cbd5e1'); megaMgr.setAttribute('fill', 'none'); megaMgr.style.opacity = '0.4'; }
                if (mgrSt) { mgrSt.textContent = 'OFF'; mgrSt.style.color = '#94a3b8'; mgrSt.style.fontWeight = '400'; }
            }
        }
    }
    setTimeout(updateNotifyUI, 200);

    // ── 전역 구독: chat_rooms (새 방 / 상태 변경) ──
    function startGlobalRoomWatch() {
        var sb = getSb();
        if (!sb) { console.log('⏳ [알림] sb 미준비(room), 2초 후 재시도'); setTimeout(startGlobalRoomWatch, 2000); return; }
        if (globalRoomSub) { globalRoomSub.unsubscribe(); }
        console.log('✅ [알림] startGlobalRoomWatch 구독 시작');
        globalRoomSub = sb.channel('global-room-watch')
            .on('postgres_changes', {event:'INSERT', schema:'public', table:'chat_rooms'}, function(p) {
                var rm = p.new;
                console.log('📨 [알림] chat_rooms INSERT:', rm.customer_name, rm.status);
                if (rm.status === 'waiting' || rm.status === 'ai_chatting') {
                    var name = rm.customer_name || '고객';
                    var mgr = rm.assigned_manager;
                    var tts = mgr
                        ? mgr + ' 매니저님, ' + name + ' 고객님의 상담요청입니다'
                        : myManagerName
                            ? myManagerName + ' 매니저님, 새로운 고객 ' + name + '님이 입장했습니다'
                            : '새로운 고객 ' + name + '님이 채팅에 입장했습니다';
                    sendNotification(
                        '새 상담 요청',
                        name + '님이 상담을 요청했습니다' + (mgr ? ' (담당: ' + mgr + ')' : ''),
                        tts, mgr, true
                    );
                    lcLoadRooms();
                }
            })
            .on('postgres_changes', {event:'UPDATE', schema:'public', table:'chat_rooms'}, function(p) {
                var rm = p.new; var old = p.old;
                if (rm.assigned_manager && rm.assigned_manager !== (old && old.assigned_manager)) {
                    sendNotification(
                        '상담 배정',
                        rm.assigned_manager + ' 매니저님에게 상담이 배정되었습니다',
                        rm.assigned_manager + ' 매니저님, 새 상담이 배정되었습니다',
                        rm.assigned_manager, true
                    );
                }
                lcLoadRooms();
            })
            .subscribe(function(status) {
                console.log('📡 [알림] global-room-watch 상태:', status);
            });
    }
    setTimeout(startGlobalRoomWatch, 1500);

    // ── 전역 구독: chat_messages (모든 고객 메시지 알림) ──
    function startMessageWatch() {
        if (_msgSubChannel) return;
        var sb = getSb();
        if (!sb) { console.log('⏳ [알림] sb 미준비, 2초 후 재시도'); setTimeout(startMessageWatch, 2000); return; }
        console.log('✅ [알림] startMessageWatch 구독 시작');
        _msgSubChannel = sb.channel('global-msg-watch')
            .on('postgres_changes', {event:'INSERT', schema:'public', table:'chat_messages'}, async function(p) {
                var msg = p.new;
                console.log('📨 [알림] chat_messages INSERT 수신:', msg.sender_type, msg.message ? msg.message.substring(0,20) : '(파일)');
                if (msg.sender_type !== 'customer') return;
                // 채팅 섹션이 활성화되어 있고, 해당 방을 보고 있고, 탭이 포커스된 경우만 스킵
                var chatSec = document.getElementById('sec-live-chat');
                var isChatActive = chatSec && chatSec.classList.contains('active') && !document.hidden;
                if (isChatActive && currentRoom && currentRoom.id === msg.room_id) {
                    console.log('🔇 [알림] 현재 보고 있는 방 → 스킵');
                    return;
                }
                // 방 정보
                var roomInfo = null;
                try {
                    var rr = await sb.from('chat_rooms').select('customer_name,assigned_manager,status').eq('id', msg.room_id).single();
                    if (rr.data) roomInfo = rr.data;
                } catch(e) { console.warn('⚠️ [알림] 방 정보 조회 실패:', e); }
                var name = (roomInfo && roomInfo.customer_name) || '고객';
                var mgr = roomInfo && roomInfo.assigned_manager;
                console.log('🔔 [알림] 알림 발송:', name, '담당:', mgr, 'shouldAlert:', shouldAlwaysAlert(mgr));
                var txt = msg.message || '(파일)';
                if (txt.length > 30) txt = txt.substring(0, 30) + '...';
                var tts = mgr
                    ? mgr + ' 매니저님, ' + name + ' 고객님 메시지입니다'
                    : myManagerName
                        ? myManagerName + ' 매니저님, ' + name + ' 고객님 메시지입니다'
                        : name + ' 고객님 메시지입니다';
                sendNotification(
                    '💬 ' + name + (mgr ? ' → ' + mgr : ''),
                    txt, tts, mgr, false
                );
            })
            .subscribe(function(status) {
                console.log('📡 [알림] global-msg-watch 상태:', status);
            });
    }
    function stopMessageWatch() {
        if (_msgSubChannel) { _msgSubChannel.unsubscribe(); _msgSubChannel = null; }
    }
    // ★ 항상 메시지 감시 시작 (알림 설정과 무관)
    setTimeout(startMessageWatch, 2000);
    // ★ 브라우저 알림 권한 항상 요청
    if ('Notification' in window && Notification.permission === 'default') {
        setTimeout(function() { Notification.requestPermission(); }, 3000);
    }
    // 고객 이름으로 언어 감지
    function detectRoomLang(room) {
        if (!room) return 'kr';
        var cn = (room.customer_name || '').toLowerCase();
        if (cn.includes('ウェブ') || cn.includes('顧客') || /[\u3040-\u30FF]/.test(cn)) return 'ja';
        if (cn.includes('web') || cn.includes('customer') || /^[a-zA-Z\s]+$/.test(cn)) return 'en';
        return 'kr';
    }
    // 다국어 시스템 메시지
    function sysMsg(key, mgrName) {
        var lang = detectRoomLang(currentRoom);
        var msgs = {
            connected: { kr: '✅ '+(mgrName||'매니저')+' 매니저가 접속했습니다!', ja: '✅ '+(mgrName||'マネージャー')+' マネージャーが接続しました！', en: '✅ '+(mgrName||'Manager')+' has connected!' },
            joined: { kr: '✅ '+(mgrName||'매니저')+' 매니저가 대화에 참여했습니다!', ja: '✅ '+(mgrName||'マネージャー')+' マネージャーが会話に参加しました！', en: '✅ '+(mgrName||'Manager')+' has joined the conversation!' },
            closed: { kr: '상담이 종료되었습니다. 감사합니다! 😊', ja: 'ご相談は終了しました。ありがとうございました！😊', en: 'This consultation has ended. Thank you! 😊' }
        };
        return (msgs[key] && msgs[key][lang]) || msgs[key]['kr'];
    }
    window.lcLoadRooms = async function() {
        var sb=getSb(); if(!sb) return;
        var q = sb.from('chat_rooms').select('*').order('created_at',{ascending:false}).limit(50);
        if (currentFilter === 'ai_chatting') {
            q = q.eq('status', 'ai_chatting');
        } else if (currentFilter !== 'all' && currentFilter !== 'chatbot') {
            q = q.eq('status', currentFilter);
        }
        var r = await q;
        // 매니저 이름 필터 적용
        var filterMgr = myManagerName || '';
        if (filterMgr && filterMgr !== '' && r.data) {
            if (filterMgr === '__HQ__') {
                // 본사상담: assigned_manager가 비어있거나 '본사' 포함
                r.data = r.data.filter(function(rm) {
                    return !rm.assigned_manager || rm.assigned_manager === '' || rm.assigned_manager.indexOf('본사') >= 0;
                });
            } else {
                // 특정 매니저: 자신이 담당하거나 미배정(대기)인 것만
                r.data = r.data.filter(function(rm) {
                    return rm.assigned_manager === filterMgr || rm.status === 'waiting' || rm.status === 'ai_chatting';
                });
            }
        }
        var list=document.getElementById('lcRoomList');
        if(!r.data||r.data.length===0){list.innerHTML='<div style="text-align:center;color:#64748b;padding:30px;font-size:14px;">상담방 없음</div>';return;}
        // 각 방의 미확인 메시지 수 + 마지막 메시지 조회
        var roomIds = r.data.map(function(rm) { return rm.id; });
        var unreadMap = {};
        var lastMsgMap = {};
        try {
            // 미확인 수 (방별)
            var uRes = await sb.from('chat_messages').select('room_id').eq('is_read', false).eq('sender_type', 'customer').in('room_id', roomIds);
            if (uRes.data) uRes.data.forEach(function(u) { unreadMap[u.room_id] = (unreadMap[u.room_id] || 0) + 1; });
            // 마지막 메시지 (방별)
            var lRes = await sb.from('chat_messages').select('room_id,message,sender_type,created_at').in('room_id', roomIds).neq('sender_type','admin_memo').order('created_at', {ascending: false}).limit(roomIds.length * 2);
            if (lRes.data) lRes.data.forEach(function(m) { if (!lastMsgMap[m.room_id]) lastMsgMap[m.room_id] = m; });
        } catch(e) { console.warn('방 목록 추가정보 로드 실패:', e); }
        var h=''; r.data.forEach(function(rm){
            var t=new Date(rm.created_at).toLocaleString('ko-KR',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
            var si=rm.status==='waiting'?'⏳':rm.status==='active'?'💬':rm.status==='ai_chatting'?'🤖':'✅';
            var isActive=currentRoom&&currentRoom.id===rm.id;
            var bg=isActive?'rgba(99,102,241,0.2)':'rgba(255,255,255,0.03)';
            var bdL=rm.status==='waiting'?'#f87171':rm.status==='active'?'#4ade80':rm.status==='ai_chatting'?'#fbbf24':'#475569';
            var unread = unreadMap[rm.id] || 0;
            h+='<div onclick="lcSelectRoom(\''+rm.id+'\')" style="background:'+bg+';border-left:3px solid '+bdL+';border-radius:10px;padding:12px 14px;margin-bottom:6px;cursor:pointer;transition:background 0.15s;" onmouseenter="if(!'+isActive+')this.style.background=\'rgba(255,255,255,0.08)\'" onmouseleave="if(!'+isActive+')this.style.background=\'rgba(255,255,255,0.03)\'">';
            h+='<div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:700;font-size:14px;color:#f1f5f9;">'+si+' '+(rm.customer_name||'고객')+'</span><span style="display:flex;align-items:center;gap:6px;">';
            if (unread > 0) h+='<span style="background:#ef4444;color:#fff;font-size:10px;font-weight:700;min-width:18px;height:18px;border-radius:9px;display:inline-flex;align-items:center;justify-content:center;padding:0 5px;animation:lcBadgePulse 1.5s ease infinite;">'+(unread>99?'99+':unread)+'</span>';
            h+='<span style="font-size:11px;color:#64748b;">'+t+'</span></span></div>';
            // 마지막 메시지 미리보기
            var lastMsg = lastMsgMap[rm.id];
            if (lastMsg) {
                var preview = (lastMsg.message || '(파일)');
                if (preview.length > 30) preview = preview.substring(0,30) + '...';
                var senderIcon = lastMsg.sender_type==='customer'?'👤':lastMsg.sender_type==='manager'?'💬':lastMsg.sender_type==='internal'?'🔒':'🤖';
                h+='<div style="font-size:11px;color:#94a3b8;margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+senderIcon+' '+preview+'</div>';
            }
            h+='<div style="font-size:12px;margin-top:5px;display:flex;align-items:center;gap:6px;"><span style="background:'+(rm.status==='ai_chatting'?'rgba(251,191,36,0.15)':'rgba(99,102,241,0.15)')+';color:'+(rm.status==='ai_chatting'?'#fbbf24':'#a5b4fc')+';padding:2px 10px;border-radius:10px;font-weight:600;font-size:11px;">'+(rm.status==='ai_chatting'?'🤖 AI':'👤 '+(rm.assigned_manager||'미배정'))+'</span><span style="color:#64748b;font-size:11px;">'+(rm.source==='chatbot'?'AI→상담':'직접')+'</span></div>';
            if(rm.ai_summary) h+='<div style="font-size:11px;color:#64748b;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:4px;">🤖 '+rm.ai_summary.substring(0,50)+'</div>';
            h+='</div>';
        }); list.innerHTML=h;
    };

    // ══════════════════════════════════════
    // ★ 검색 기능 (고객명 / 대화내용 / 전체)
    // ══════════════════════════════════════
    var _lcSearchTimer = null;
    var _lcSearching = false;
    window.lcSearchDebounce = function() {
        clearTimeout(_lcSearchTimer);
        var val = (document.getElementById('lcSearchInput').value || '').trim();
        if (!val) { lcClearSearch(); return; }
        _lcSearchTimer = setTimeout(lcDoSearch, 400);
    };
    window.lcDoSearch = async function() {
        var q = (document.getElementById('lcSearchInput').value || '').trim();
        if (!q || _lcSearching) return;
        var sb = getSb(); if (!sb) return;
        var type = 'customer';
        document.querySelectorAll('input[name="lcSearchType"]').forEach(function(r) { if (r.checked) type = r.value; });
        _lcSearching = true;
        var list = document.getElementById('lcRoomList');
        list.innerHTML = '<div style="text-align:center;color:#a5b4fc;padding:30px;"><i class="fa-solid fa-spinner fa-spin"></i> 검색 중...</div>';
        document.getElementById('lcSearchClear').style.display = 'inline';
        try {
            var rooms = [];
            if (type === 'customer' || type === 'both') {
                // 고객명 검색 — chat_rooms에서 customer_name ILIKE
                var rr = await sb.from('chat_rooms').select('*').ilike('customer_name', '%' + q + '%').order('created_at', {ascending: false}).limit(50);
                if (rr.data) rooms = rooms.concat(rr.data);
            }
            if (type === 'message' || type === 'both') {
                // 대화내용 검색 — chat_messages에서 message ILIKE → room_id 수집 → rooms 조회
                var mr = await sb.from('chat_messages').select('room_id, message, sender_name, created_at').ilike('message', '%' + q + '%').order('created_at', {ascending: false}).limit(100);
                if (mr.data && mr.data.length > 0) {
                    // 중복 제거 + room_id 별 매칭 메시지 저장
                    var roomIds = [];
                    var matchedMsgs = {};
                    mr.data.forEach(function(m) {
                        if (roomIds.indexOf(m.room_id) < 0) roomIds.push(m.room_id);
                        if (!matchedMsgs[m.room_id]) matchedMsgs[m.room_id] = m;
                    });
                    // 이미 rooms에 있는 id 제외
                    var existIds = rooms.map(function(r) { return r.id; });
                    var newIds = roomIds.filter(function(id) { return existIds.indexOf(id) < 0; });
                    if (newIds.length > 0) {
                        var rr2 = await sb.from('chat_rooms').select('*').in('id', newIds.slice(0, 50));
                        if (rr2.data) {
                            rr2.data.forEach(function(rm) { rm._matchedMsg = matchedMsgs[rm.id]; });
                            rooms = rooms.concat(rr2.data);
                        }
                    }
                    // 기존 rooms에도 매칭 메시지 추가
                    rooms.forEach(function(rm) { if (!rm._matchedMsg && matchedMsgs[rm.id]) rm._matchedMsg = matchedMsgs[rm.id]; });
                }
            }
            // 중복 제거
            var seen = {};
            rooms = rooms.filter(function(rm) { if (seen[rm.id]) return false; seen[rm.id] = true; return true; });
            // 정렬 (최신순)
            rooms.sort(function(a, b) { return new Date(b.created_at) - new Date(a.created_at); });

            if (rooms.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:30px;font-size:13px;"><i class="fa-solid fa-search" style="font-size:24px;display:block;margin-bottom:10px;opacity:0.4;"></i>"' + q + '" 검색 결과 없음</div>';
            } else {
                var h = '<div style="padding:4px 6px 8px;font-size:11px;color:#a5b4fc;font-weight:600;">' + rooms.length + '개 결과 — "' + q + '"</div>';
                rooms.forEach(function(rm) {
                    var t = new Date(rm.created_at).toLocaleString('ko-KR',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
                    var si = rm.status==='waiting'?'⏳':rm.status==='active'?'💬':rm.status==='ai_chatting'?'🤖':'✅';
                    var isActive = currentRoom && currentRoom.id === rm.id;
                    var bg = isActive ? 'rgba(99,102,241,0.2)' : 'rgba(255,255,255,0.03)';
                    var bdL = rm.status==='waiting'?'#f87171':rm.status==='active'?'#4ade80':rm.status==='ai_chatting'?'#fbbf24':'#475569';
                    // 고객명 하이라이트
                    var custName = rm.customer_name || '고객';
                    var qLow = q.toLowerCase();
                    var nameIdx = custName.toLowerCase().indexOf(qLow);
                    var dispName = custName;
                    if (nameIdx >= 0) {
                        dispName = custName.substring(0, nameIdx) + '<span style="background:#fbbf24;color:#1e1b2e;border-radius:2px;padding:0 1px;">' + custName.substring(nameIdx, nameIdx + q.length) + '</span>' + custName.substring(nameIdx + q.length);
                    }
                    h += '<div onclick="lcSelectRoom(\'' + rm.id + '\')" style="background:' + bg + ';border-left:3px solid ' + bdL + ';border-radius:10px;padding:12px 14px;margin-bottom:6px;cursor:pointer;transition:background 0.15s;" onmouseenter="this.style.background=\'rgba(255,255,255,0.08)\'" onmouseleave="this.style.background=\'' + bg + '\'">';
                    h += '<div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:700;font-size:14px;color:#f1f5f9;">' + si + ' ' + dispName + '</span><span style="font-size:11px;color:#64748b;">' + t + '</span></div>';
                    h += '<div style="font-size:12px;margin-top:5px;display:flex;align-items:center;gap:6px;"><span style="background:' + (rm.status==='ai_chatting'?'rgba(251,191,36,0.15)':'rgba(99,102,241,0.15)') + ';color:' + (rm.status==='ai_chatting'?'#fbbf24':'#a5b4fc') + ';padding:2px 10px;border-radius:10px;font-weight:600;font-size:11px;">' + (rm.status==='ai_chatting'?'🤖 AI':'👤 ' + (rm.assigned_manager||'미배정')) + '</span></div>';
                    // 매칭된 대화내용 미리보기
                    if (rm._matchedMsg) {
                        var mtext = rm._matchedMsg.message || '';
                        var mIdx = mtext.toLowerCase().indexOf(qLow);
                        var preview = mtext;
                        if (mIdx >= 0) {
                            var start = Math.max(0, mIdx - 15);
                            var end = Math.min(mtext.length, mIdx + q.length + 30);
                            preview = (start > 0 ? '...' : '') + mtext.substring(start, mIdx) + '<span style="background:#fbbf24;color:#1e1b2e;border-radius:2px;padding:0 1px;">' + mtext.substring(mIdx, mIdx + q.length) + '</span>' + mtext.substring(mIdx + q.length, end) + (end < mtext.length ? '...' : '');
                        } else if (preview.length > 50) {
                            preview = preview.substring(0, 50) + '...';
                        }
                        h += '<div style="font-size:11px;color:#94a3b8;margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">💬 ' + (rm._matchedMsg.sender_name || '') + ': ' + preview + '</div>';
                    }
                    h += '</div>';
                });
                list.innerHTML = h;
            }
        } catch(e) {
            console.error('검색 에러:', e);
            list.innerHTML = '<div style="text-align:center;color:#f87171;padding:20px;font-size:13px;">검색 오류: ' + (e.message||'') + '</div>';
        }
        _lcSearching = false;
    };
    window.lcClearSearch = function() {
        document.getElementById('lcSearchInput').value = '';
        document.getElementById('lcSearchClear').style.display = 'none';
        _lcSearching = false;
        lcLoadRooms();
    };

    window.lcFilterRooms = function(f) {
        currentFilter=f;
        ['All','Wait','Active','Closed','AiChat','Bot'].forEach(function(k) {
            var el = document.getElementById('lcFilter'+k);
            if (el) el.className = 'btn btn-outline btn-sm';
        });
        var activeId = {all:'All',waiting:'Wait',active:'Active',closed:'Closed',ai_chatting:'AiChat',chatbot:'Bot'}[f];
        var el = document.getElementById('lcFilter'+(activeId||'All'));
        if (el) el.className = 'btn btn-primary btn-sm';
        if (f === 'chatbot') { lcLoadChatbotLogs(); return; }
        lcLoadRooms();
    };
    // AI 챗봇 상담 로그 표시
    window.lcLoadChatbotLogs = async function() {
        var sb=getSb(); if(!sb) return;
        var r=await sb.from('chatbot_logs').select('*').order('created_at',{ascending:false}).limit(30);
        var list=document.getElementById('lcRoomList');
        if(!r.data||r.data.length===0){list.innerHTML='<div style="text-align:center;color:#94a3b8;padding:20px;font-size:13px;">AI 상담 기록 없음</div>';return;}
        var h='';
        r.data.forEach(function(log){
            var t=new Date(log.created_at).toLocaleString('ko-KR',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
            var nt=log.needs_training?'#fca5a5':'#e2e8f0';
            h+='<div onclick="lcShowBotLog('+log.id+')" style="background:#fff;border:1px solid '+nt+';border-radius:10px;padding:10px;margin-bottom:6px;cursor:pointer;">';
            h+='<div style="display:flex;justify-content:space-between;"><span style="font-weight:700;font-size:13px;">🤖 AI 상담</span><span style="font-size:10px;color:#94a3b8;">'+t+'</span></div>';
            h+='<div style="font-size:11px;color:#334155;margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">❓ '+log.user_message.substring(0,40)+'</div>';
            h+='<div style="font-size:11px;color:#94a3b8;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">💬 '+(log.bot_reply||'').substring(0,40)+'</div>';
            if(log.needs_training) h+='<span style="background:#fef2f2;color:#dc2626;font-size:10px;padding:1px 6px;border-radius:4px;">학습필요</span>';
            h+='</div>';
        });
        list.innerHTML=h;
    };
    // AI 상담 로그 상세 보기
    window.lcShowBotLog = async function(logId) {
        var sb=getSb(); if(!sb) return;
        var r=await sb.from('chatbot_logs').select('*').eq('id',logId).single();
        if(!r.data) return;
        var log=r.data;
        var area=document.getElementById('lcChatMessages');
        document.getElementById('lcChatTitle').textContent='🤖 AI 상담 기록';
        document.getElementById('lcChatSub').textContent=new Date(log.created_at).toLocaleString('ko-KR')+' | '+log.language;
        document.getElementById('lcAiSummary').style.display='none';
        var h='';
        h+='<div style="display:flex;flex-direction:column;align-items:flex-start;margin-bottom:8px;"><span style="font-size:10px;color:#94a3b8;">고객</span><div style="background:#f1f5f9;color:#334155;padding:8px 14px;border-radius:14px;max-width:300px;font-size:13px;">'+log.user_message+'</div></div>';
        h+='<div style="display:flex;flex-direction:column;align-items:flex-end;margin-bottom:8px;"><span style="font-size:10px;color:#94a3b8;">AI</span><div style="background:#6366f1;color:#fff;padding:8px 14px;border-radius:14px;max-width:300px;font-size:13px;line-height:1.5;">'+(log.bot_reply||'')+'</div></div>';
        if(log.needs_training) h+='<div style="text-align:center;padding:10px;"><span style="background:#fef2f2;color:#dc2626;padding:4px 12px;border-radius:8px;font-size:12px;">⚠️ 학습이 필요한 응답</span></div>';
        area.innerHTML=h;
    };
    window.lcSelectRoom = async function(roomId) {
        var sb=getSb(); if(subscription){subscription.unsubscribe();subscription=null;}
        clearUnreadBadge();
        var rr=await sb.from('chat_rooms').select('*').eq('id',roomId).single();
        if(rr.error) return; currentRoom=rr.data;
        var isAiChat = currentRoom.status==='ai_chatting';
        document.getElementById('lcChatTitle').textContent=(isAiChat?'🤖 ':'👤 ')+(currentRoom.customer_name||'고객')+' 님'+(isAiChat?' AI 상담':' 상담');
        // 담당자 배지 업데이트
        var mgrBadge=document.getElementById('lcChatManagerBadge');
        var statusBadge=document.getElementById('lcChatStatusBadge');
        if(mgrBadge){mgrBadge.style.display='inline-block';mgrBadge.textContent='담당: '+(isAiChat?'AI 봇':currentRoom.assigned_manager||'미배정');mgrBadge.style.background=isAiChat?'#f59e0b':currentRoom.assigned_manager?'#6366f1':'#94a3b8';}
        if(statusBadge){statusBadge.style.display='inline';statusBadge.textContent=currentRoom.status==='waiting'?'⏳ 대기':currentRoom.status==='active'?'💬 상담중':isAiChat?'🤖 AI 상담중':'✅ 종료';}
        // 끼어들기 버튼 표시/숨김
        var interveneBtn=document.getElementById('lcInterveneBtn');
        if(interveneBtn) interveneBtn.style.display=isAiChat?'inline-block':'none';
        // 담당 변경 버튼 표시 (상담중일 때만)
        var changeMgrBtn=document.getElementById('lcChangeMgrBtn');
        if(changeMgrBtn) changeMgrBtn.style.display=(currentRoom.status==='active'||currentRoom.status==='waiting')?'inline-block':'none';
        if(currentRoom.ai_summary){document.getElementById('lcAiSummary').style.display='block';document.getElementById('lcAiSummaryText').textContent=currentRoom.ai_summary;}else{document.getElementById('lcAiSummary').style.display='none';}
        // 메모 패널 숨기고 메모 인디케이터 로드
        var memoPanel=document.getElementById('lcMemoPanel'); if(memoPanel) memoPanel.style.display='none';
        lcLoadMemo();
        if(currentRoom.status==='waiting'){
            await sb.from('chat_rooms').update({status:'active',updated_at:new Date().toISOString()}).eq('id',roomId);
            currentRoom.status='active';
            await sb.from('chat_messages').insert({room_id:roomId,sender_type:'system',message:sysMsg('connected', currentRoom.assigned_manager)});
        }
        var mr=await sb.from('chat_messages').select('*').eq('room_id',roomId).order('created_at',{ascending:true}).limit(100);
        var area=document.getElementById('lcChatMessages');
        if(!mr.data||mr.data.length===0){area.innerHTML='<div style="text-align:center;color:#94a3b8;padding:30px;">메시지 없음</div>';}
        else{var h='';mr.data.forEach(function(m){if(m.sender_type==='admin_memo') return; h+=renderMsg(m);});area.innerHTML=h;area.scrollTop=area.scrollHeight;}
        sb.from('chat_messages').update({is_read:true}).eq('room_id',roomId).eq('sender_type','customer').eq('is_read',false).then(function(){});
        subscription=sb.channel('admin-'+roomId).on('postgres_changes',{event:'INSERT',schema:'public',table:'chat_messages',filter:'room_id=eq.'+roomId},async function(p){
            var m=p.new;
            if(m.sender_type==='admin_memo') return; // 메모는 채팅에 표시하지 않음
            // ★ 모든 메시지 타입 표시 (customer, manager, system, chatbot)
            // 내가 이 PC에서 방금 보낸 매니저 메시지는 이미 로컬 표시됨 → 중복 스킵
            if ((m.sender_type === 'manager' || m.sender_type === 'internal') && m.sender_name === myManagerName && (Date.now() - _lastSentAt) < 5000) {
                // 내가 방금 보낸 메시지 → 이미 로컬에 표시됨
            } else {
                // Realtime payload에 file_url이 누락될 수 있으므로 DB에서 전체 데이터 재조회
                if(m.id){
                    var fresh=await sb.from('chat_messages').select('*').eq('id',m.id).single();
                    if(fresh.data) m=fresh.data;
                }
                area.insertAdjacentHTML('beforeend',renderMsg(m));
                area.scrollTop=area.scrollHeight;
            }
            if(m.sender_type==='customer') {
                sb.from('chat_messages').update({is_read:true}).eq('id',m.id).then(function(){});
                // ★ 항상 알림음 재생 (현재 방 메시지)
                playKakaoSound();
                if(document.hidden) flashTitle('💬 새 메시지');
            }
        }).subscribe();
        lcLoadRooms();
    };
    function renderMsg(m){
        var t=new Date(m.created_at).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
        if(m.sender_type==='system') return '<div style="text-align:center;padding:8px;font-size:14px;color:#94a3b8;"><span style="background:#f1f5f9;padding:4px 14px;border-radius:20px;">'+m.message+'</span></div>';
        var isInternal=m.sender_type==='internal';
        var isMgr=m.sender_type==='manager'||isInternal;var isBot=m.sender_type==='chatbot';var al=isMgr?'flex-end':'flex-start';
        var bg=isInternal?'#fef3c7':m.sender_type==='manager'?'#6366f1':isBot?'#e8f5e9':'#fff';
        var cl=isInternal?'#92400e':m.sender_type==='manager'?'#fff':'#1e293b';
        var bdRadius=isMgr?'18px 18px 4px 18px':'18px 18px 18px 4px';
        var shadow=isMgr?'none':'0 1px 3px rgba(0,0,0,0.06)';
        var name=isInternal?'🔒 '+(m.sender_name||'매니저')+' (내부메모)':m.sender_type==='manager'?(m.sender_name||'매니저'):isBot?'🤖 AI 봇':(m.sender_name||'고객');
        var nameColor=isInternal?'#b45309':m.sender_type==='manager'?'#6366f1':isBot?'#059669':'#f59e0b';
        var h='<div style="display:flex;flex-direction:column;align-items:'+al+';margin-bottom:14px;">';
        h+='<span style="font-size:13px;color:'+nameColor+';font-weight:700;margin-bottom:4px;">'+(isInternal?'':m.sender_type==='manager'?'💬 ':isBot?'':'👤 ')+name+' · '+t+'</span>';
        if(m.file_url){if(m.file_type&&m.file_type.startsWith('image/')){h+='<img src="'+m.file_url+'" style="max-width:300px;border-radius:14px;cursor:pointer;margin:4px 0;box-shadow:0 2px 8px rgba(0,0,0,0.1);'+(isInternal?'border:2px dashed #fcd34d;':'')+'" onclick="window.open(this.src)">';}else{h+='<a href="'+m.file_url+'" target="_blank" style="background:'+(isInternal?'#fef3c7':'#dbeafe')+';padding:10px 16px;border-radius:14px;color:'+(isInternal?'#92400e':'#2563eb')+';text-decoration:none;font-size:16px;display:inline-block;margin:4px 0;">📎 '+(m.file_name||'파일')+'</a>';}}
        if(m.message){var linkColor=isInternal?'#b45309':m.sender_type==='manager'?'#c7d2fe':'#2563eb';var mt=m.message.replace(/\n/g,'<br>').replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" style="color:'+linkColor+';text-decoration:underline;">$1</a>');h+='<div style="background:'+bg+';color:'+cl+';padding:12px 18px;border-radius:'+bdRadius+';max-width:420px;font-size:16px;line-height:1.6;word-break:break-all;box-shadow:'+shadow+';'+(isInternal?'border:1px dashed #fcd34d;':'')+'">'+mt+'</div>';if(!isMgr&&m.message){var eid='trm_'+Math.random().toString(36).substr(2,8);h+='<div style="margin-top:3px;"><button onclick="lcTranslateMsg(this,\''+eid+'\')" data-msg="'+m.message.replace(/"/g,'&quot;').replace(/'/g,'&#39;')+'" style="font-size:11px;background:none;border:1px solid #e2e8f0;color:#64748b;padding:2px 8px;border-radius:6px;cursor:pointer;" title="한국어로 번역"><i class="fa-solid fa-language"></i> 번역</button><span id="'+eid+'" style="font-size:12px;color:#6366f1;margin-left:4px;"></span></div>';}}
        return h+'</div>';
    }
    var _lastSentAt = 0; // 내가 보낸 메시지 중복 방지용
    var _lcInternalMode = false; // 내부대화 모드
    window.lcToggleMode = function() {
        _lcInternalMode = !_lcInternalMode;
        var btn = document.getElementById('lcModeToggle');
        var bar = document.getElementById('lcInternalBar');
        var inp = document.getElementById('lcMsgInput');
        if (_lcInternalMode) {
            btn.innerHTML = '🔒 내부대화';
            btn.style.background = '#fef3c7'; btn.style.color = '#92400e'; btn.style.borderColor = '#fcd34d';
            if (bar) bar.style.display = 'block';
            if (inp) { inp.style.background = '#fffbeb'; inp.style.borderColor = '#fcd34d'; inp.placeholder = '내부 메모 입력... (고객에게 보이지 않음)'; }
        } else {
            btn.innerHTML = '💬 고객응대';
            btn.style.background = '#e0e7ff'; btn.style.color = '#4338ca'; btn.style.borderColor = '#c7d2fe';
            if (bar) bar.style.display = 'none';
            if (inp) { inp.style.background = ''; inp.style.borderColor = ''; inp.placeholder = '메시지 입력... (Shift+Enter 줄바꿈)'; }
        }
    };
    window.lcSendMsg = async function(){
        if(!currentRoom) return; var sb=getSb();var inp=document.getElementById('lcMsgInput');var txt=inp.value.trim();if(!txt) return;inp.value='';inp.style.height='auto';
        lcHideQuick();
        _lastSentAt = Date.now();
        var sType=_lcInternalMode?'internal':'manager';
        var m={room_id:currentRoom.id,sender_type:sType,sender_name:currentRoom.assigned_manager||'매니저',message:txt,created_at:new Date().toISOString()};
        var area=document.getElementById('lcChatMessages');area.insertAdjacentHTML('beforeend',renderMsg(m));area.scrollTop=area.scrollHeight;
        await sb.from('chat_messages').insert({room_id:currentRoom.id,sender_type:sType,sender_name:currentRoom.assigned_manager||'매니저',message:txt});
    };

    // ── Quick Reply (자동 추천 답변) ──
    var lcQuickCache = [];
    window.lcLoadQuickReplies = async function() {
        var sb = getSb(); if (!sb) return;
        var res = await sb.from('chatbot_knowledge')
            .select('category, question, answer, keywords, priority')
            .eq('is_active', true)
            .neq('category', '_managers')
            .order('priority', { ascending: false });
        lcQuickCache = (res.data || []);
    };
    window.lcSearchQuick = function(val) {
        var box = document.getElementById('lcQuickReplyBox');
        if (!box) return;
        var txt = (val || '').trim().toLowerCase();
        if (txt.length < 2 || lcQuickCache.length === 0) { box.style.display = 'none'; return; }
        var matches = [];
        for (var i = 0; i < lcQuickCache.length; i++) {
            var k = lcQuickCache[i];
            var kwList = (k.keywords || '').toLowerCase().split(',').map(function(s){ return s.trim(); });
            var hit = false;
            for (var j = 0; j < kwList.length; j++) { if (kwList[j] && txt.indexOf(kwList[j]) >= 0) { hit = true; break; } }
            if (!hit) { for (var j = 0; j < kwList.length; j++) { if (kwList[j] && kwList[j].indexOf(txt) >= 0) { hit = true; break; } } }
            if (!hit && k.question && k.question.toLowerCase().indexOf(txt) >= 0) hit = true;
            if (!hit && k.category && k.category.toLowerCase().indexOf(txt) >= 0) hit = true;
            if (hit) matches.push(k);
            if (matches.length >= 5) break;
        }
        if (matches.length === 0) { box.style.display = 'none'; return; }
        var html = '';
        matches.forEach(function(m, idx) {
            var ans = (m.answer || '').length > 120 ? m.answer.substring(0, 120) + '...' : (m.answer || '');
            html += '<div onclick="lcPickQuick(' + idx + ')" data-answer="' + (m.answer || '').replace(/"/g, '&quot;') + '" style="padding:10px 14px; cursor:pointer; border-bottom:1px solid #f1f5f9; transition:background 0.15s;' + (idx === 0 ? 'border-radius:10px 10px 0 0;' : '') + '" onmouseenter="this.style.background=\'#eef2ff\'" onmouseleave="this.style.background=\'#fff\'">'
                + '<div style="display:flex; align-items:center; gap:6px; margin-bottom:3px;">'
                + '<span style="background:#e0e7ff; color:#4338ca; font-size:10px; padding:1px 6px; border-radius:4px; font-weight:600;">' + (m.category || '기타') + '</span>'
                + '<span style="font-size:11px; color:#64748b; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Q: ' + (m.question || '').substring(0, 60) + '</span>'
                + '</div>'
                + '<div style="font-size:12px; color:#334155; line-height:1.4;">→ ' + ans + '</div>'
                + '</div>';
        });
        box.innerHTML = html;
        box.style.display = 'block';
        box._matches = matches;
    };
    window.lcPickQuick = function(idx) {
        var box = document.getElementById('lcQuickReplyBox');
        if (!box || !box._matches || !box._matches[idx]) return;
        var inp = document.getElementById('lcMsgInput');
        inp.value = box._matches[idx].answer || '';
        inp.focus();
        lcHideQuick();
    };
    window.lcHideQuick = function() {
        var box = document.getElementById('lcQuickReplyBox');
        if (box) box.style.display = 'none';
    };
    document.addEventListener('keydown', function(e) { if (e.key === 'Escape') lcHideQuick(); });
    // 채팅 섹션 진입 시 캐시 로드
    lcLoadQuickReplies();
    // ── 파일 미리보기 + 업로드 ──
    var _pendingFiles = []; // 미리보기 대기 중인 파일들
    document.addEventListener('change',function(e){
        if(e.target.id!=='lcFileInput'||!currentRoom) return;
        var fs=e.target.files;
        for(var i=0;i<fs.length;i++){ _showFilePreview(fs[i]); }
        e.target.value='';
    });
    function _showFilePreview(file) {
        var preview = document.getElementById('lcFilePreview');
        var img = document.getElementById('lcFilePreviewImg');
        var name = document.getElementById('lcFilePreviewName');
        if (!preview) return;
        _pendingFiles.push(file);
        if (file.type.startsWith('image/')) {
            var reader = new FileReader();
            reader.onload = function(e) { img.src = e.target.result; img.style.display = 'block'; };
            reader.readAsDataURL(file);
        } else {
            img.src = ''; img.style.display = 'none';
        }
        name.textContent = file.name + ' (' + (file.size / 1024).toFixed(1) + 'KB)';
        preview.style.display = 'block';
    }
    window.lcConfirmFile = function() {
        var preview = document.getElementById('lcFilePreview');
        if (preview) preview.style.display = 'none';
        _pendingFiles.forEach(function(f) { lcUpFile(f); });
        _pendingFiles = [];
    };
    window.lcCancelFile = function() {
        var preview = document.getElementById('lcFilePreview');
        if (preview) preview.style.display = 'none';
        _pendingFiles = [];
    };
    async function lcUpFile(f){var sb=getSb();_lastSentAt=Date.now();var sType=_lcInternalMode?'internal':'manager';var ext=f.name.split('.').pop().toLowerCase();var safe=Date.now()+'-'+Math.random().toString(36).substr(2,6)+'.'+ext;var p='room-'+currentRoom.id+'/'+safe;var u=await sb.storage.from('chat-files').upload(p,f);if(u.error){showToast('업로드 실패','error');return;}var url=sb.storage.from('chat-files').getPublicUrl(p).data.publicUrl;var m={room_id:currentRoom.id,sender_type:sType,sender_name:currentRoom.assigned_manager||'매니저',file_url:url,file_name:f.name,file_type:f.type,message:'',created_at:new Date().toISOString()};var area=document.getElementById('lcChatMessages');area.insertAdjacentHTML('beforeend',renderMsg(m));area.scrollTop=area.scrollHeight;await sb.from('chat_messages').insert({room_id:currentRoom.id,sender_type:sType,sender_name:currentRoom.assigned_manager||'매니저',file_url:url,file_name:f.name,file_type:f.type,message:''});}
    window.lcCloseRoom = async function(){
        if(!currentRoom||!confirm('상담 종료?')) return;var sb=getSb();
        await sb.from('chat_rooms').update({status:'closed',closed_at:new Date().toISOString()}).eq('id',currentRoom.id);
        await sb.from('chat_messages').insert({room_id:currentRoom.id,sender_type:'system',message:sysMsg('closed')});
        currentRoom=null;if(subscription){subscription.unsubscribe();subscription=null;}
        document.getElementById('lcChatTitle').textContent='상담방을 선택하세요';
        var mb=document.getElementById('lcChatManagerBadge');if(mb)mb.style.display='none';
        var sb2=document.getElementById('lcChatStatusBadge');if(sb2)sb2.style.display='none';
        var cb=document.getElementById('lcChangeMgrBtn');if(cb)cb.style.display='none';
        document.getElementById('lcChatMessages').innerHTML='<div style="text-align:center;color:#94a3b8;padding:60px;">상담 종료</div>';lcLoadRooms();
    };
    // ── 매니저 끼어들기 (AI 상담 → 매니저 상담으로 전환) ──
    window.lcIntervene = async function(){
        if(!currentRoom || currentRoom.status!=='ai_chatting') return;
        var mgrName=prompt('끼어들기 - 매니저 이름을 입력하세요:');
        if(!mgrName||!mgrName.trim()) return;
        mgrName=mgrName.trim();
        var sb=getSb();
        // 상태를 active로 변경, 매니저 배정
        await sb.from('chat_rooms').update({status:'active',assigned_manager:mgrName,updated_at:new Date().toISOString()}).eq('id',currentRoom.id);
        currentRoom.status='active';
        currentRoom.assigned_manager=mgrName;
        // 시스템 메시지 전송 (고객 화면에도 실시간 표시됨)
        await sb.from('chat_messages').insert({room_id:currentRoom.id,sender_type:'system',message:sysMsg('joined', mgrName)});
        // UI 업데이트
        document.getElementById('lcChatTitle').textContent='👤 '+(currentRoom.customer_name||'고객')+' 님 상담';
        var mgrBadge=document.getElementById('lcChatManagerBadge');
        if(mgrBadge){mgrBadge.textContent='담당: '+mgrName;mgrBadge.style.background='#6366f1';mgrBadge.style.display='inline-block';}
        var statusBadge=document.getElementById('lcChatStatusBadge');
        if(statusBadge){statusBadge.textContent='💬 상담중';statusBadge.style.display='inline';}
        var interveneBtn=document.getElementById('lcInterveneBtn');
        if(interveneBtn) interveneBtn.style.display='none';
        var changeMgrBtn=document.getElementById('lcChangeMgrBtn');
        if(changeMgrBtn) changeMgrBtn.style.display='inline-block';
        // 실시간 구독 시작 (매니저 메시지 수신)
        var area=document.getElementById('lcChatMessages');
        subscription=sb.channel('admin-'+currentRoom.id).on('postgres_changes',{event:'INSERT',schema:'public',table:'chat_messages',filter:'room_id=eq.'+currentRoom.id},async function(p){
            var m=p.new;
            if(m.sender_type==='customer'||m.sender_type==='system'){
                if(m.id){var fresh=await sb.from('chat_messages').select('*').eq('id',m.id).single();if(fresh.data) m=fresh.data;}
                area.insertAdjacentHTML('beforeend',renderMsg(m));area.scrollTop=area.scrollHeight;
                if(m.sender_type==='customer') sb.from('chat_messages').update({is_read:true}).eq('id',m.id).then(function(){});
            }
        }).subscribe();
        lcLoadRooms();
    };
    window.lcSaveToKnowledge = async function(){
        if(!currentRoom) return;var sb=getSb();
        var mr=await sb.from('chat_messages').select('sender_type,message').eq('room_id',currentRoom.id).order('created_at').limit(50);
        if(!mr.data||mr.data.length===0) { showToast('메시지 없음', 'warn'); return; }
        var cq=mr.data.filter(function(m){return m.sender_type==='customer'&&m.message;}).map(function(m){return m.message;});
        var ma=mr.data.filter(function(m){return m.sender_type==='manager'&&m.message;}).map(function(m){return m.message;});
        if(!cq.length||!ma.length) { showToast('질문과 답변 필요', 'warn'); return; }
        await sb.from('chatbot_knowledge').insert({category:'상담사례',question:cq.join(' / ').substring(0,500),answer:ma.join(' ').substring(0,1000),language:'ko',priority:3,is_active:true});
        showToast('AI 학습 데이터로 저장!', 'success');
    };

    // ── 관리자 메모 기능 ──
    var _memoMsgId = null; // 현재 방 메모의 chat_messages.id (수정시 사용)
    window.lcToggleMemo = function() {
        var panel = document.getElementById('lcMemoPanel');
        if (!panel) return;
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            lcLoadMemo();
        } else {
            panel.style.display = 'none';
        }
    };
    window.lcLoadMemo = async function() {
        if (!currentRoom) return;
        var sb = getSb();
        var ta = document.getElementById('lcMemoText');
        var info = document.getElementById('lcMemoInfo');
        var btn = document.getElementById('lcMemoBtn');
        ta.value = ''; _memoMsgId = null;
        if (info) info.textContent = '';
        var res = await sb.from('chat_messages').select('*')
            .eq('room_id', currentRoom.id)
            .eq('sender_type', 'admin_memo')
            .order('created_at', { ascending: false })
            .limit(1);
        if (res.data && res.data.length > 0) {
            var memo = res.data[0];
            ta.value = memo.message || '';
            _memoMsgId = memo.id;
            if (info) info.textContent = '마지막 수정: ' + new Date(memo.created_at).toLocaleString('ko-KR') + ' · ' + (memo.sender_name || '');
            if (btn) btn.innerHTML = '📝 메모 <span style="background:#f59e0b;color:#fff;border-radius:50%;width:8px;height:8px;display:inline-block;vertical-align:middle;margin-left:2px;"></span>';
        } else {
            if (btn) btn.innerHTML = '📝 메모';
        }
    };
    window.lcSaveMemo = async function() {
        if (!currentRoom) return;
        var sb = getSb();
        var ta = document.getElementById('lcMemoText');
        var txt = (ta.value || '').trim();
        var mgrName = currentRoom.assigned_manager || '매니저';
        if (!txt) {
            // 텍스트가 비어있으면 기존 메모 삭제
            if (_memoMsgId) {
                await sb.from('chat_messages').delete().eq('id', _memoMsgId);
                _memoMsgId = null;
            }
            var btn = document.getElementById('lcMemoBtn');
            if (btn) btn.innerHTML = '📝 메모';
            showToast('메모 삭제됨', 'success');
            return;
        }
        if (_memoMsgId) {
            // 기존 메모 업데이트
            await sb.from('chat_messages').update({ message: txt, sender_name: mgrName, created_at: new Date().toISOString() }).eq('id', _memoMsgId);
        } else {
            // 새 메모 생성
            var ins = await sb.from('chat_messages').insert({ room_id: currentRoom.id, sender_type: 'admin_memo', sender_name: mgrName, message: txt }).select();
            if (ins.data && ins.data.length > 0) _memoMsgId = ins.data[0].id;
        }
        var btn = document.getElementById('lcMemoBtn');
        if (btn) btn.innerHTML = '📝 메모 <span style="background:#f59e0b;color:#fff;border-radius:50%;width:8px;height:8px;display:inline-block;vertical-align:middle;margin-left:2px;"></span>';
        var info = document.getElementById('lcMemoInfo');
        if (info) info.textContent = '마지막 수정: ' + new Date().toLocaleString('ko-KR') + ' · ' + mgrName;
        showToast('메모 저장됨', 'success');
    };

    // ── [기능3] 드래그앤드롭 + 클립보드 붙여넣기 ──
    (function setupDragDrop() {
        var chatArea = document.getElementById('lcChatMessages');
        if (!chatArea) { setTimeout(setupDragDrop, 500); return; }
        // 드래그 오버 시 시각적 표시
        chatArea.addEventListener('dragover', function(e) {
            e.preventDefault(); e.stopPropagation();
            chatArea.style.background = '#f0f4ff';
            chatArea.style.outline = '3px dashed #6366f1';
        });
        chatArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            chatArea.style.background = '#fff';
            chatArea.style.outline = 'none';
        });
        // 파일 드롭
        chatArea.addEventListener('drop', function(e) {
            e.preventDefault(); e.stopPropagation();
            chatArea.style.background = '#fff';
            chatArea.style.outline = 'none';
            if (!currentRoom) { showToast('상담방을 먼저 선택하세요', 'warn'); return; }
            var files = e.dataTransfer.files;
            if (files && files.length > 0) {
                for (var i = 0; i < files.length; i++) { lcUpFile(files[i]); }
            }
        });
        // 클립보드 붙여넣기 (Ctrl+V)
        var msgInput = document.getElementById('lcMsgInput');
        if (msgInput) {
            msgInput.addEventListener('paste', function(e) {
                var items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (var i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        if (!currentRoom) { showToast('상담방을 먼저 선택하세요', 'warn'); return; }
                        var blob = items[i].getAsFile();
                        if (blob) {
                            var fname = 'clipboard_' + Date.now() + '.png';
                            var file = new File([blob], fname, { type: blob.type });
                            _showFilePreview(file);
                        }
                        return;
                    }
                }
            });
        }
    })();

    // ── [기능4] 매니저 변경 기능 ──
    window.lcShowChangeManager = async function() {
        var dd = document.getElementById('lcChangeMgrDropdown');
        if (!dd) return;
        // 토글
        if (dd.style.display === 'block') { dd.style.display = 'none'; return; }
        dd.innerHTML = '<div style="text-align:center; padding:10px; color:#94a3b8; font-size:12px;">로딩중...</div>';
        dd.style.display = 'block';
        var sb = getSb(); if (!sb) return;
        var r = await sb.from('chatbot_knowledge').select('*').eq('category', '_managers').eq('is_active', true).order('priority', {ascending: false});
        if (!r.data || r.data.length === 0) {
            dd.innerHTML = '<div style="padding:10px; color:#94a3b8; font-size:12px; text-align:center;">등록된 매니저 없음</div>';
            return;
        }
        var h = '<div style="font-size:11px; color:#64748b; padding:4px 8px; font-weight:700; border-bottom:1px solid #f1f5f9;">담당 매니저 선택</div>';
        r.data.forEach(function(m) {
            try { var info = JSON.parse(m.answer); } catch(e) { var info = {name: m.question, role: ''}; }
            var isActive = currentRoom && currentRoom.assigned_manager === info.name;
            h += '<div onclick="lcChangeManager(\'' + info.name.replace(/'/g, "\\'") + '\')" style="padding:8px 12px; cursor:pointer; border-radius:6px; margin:2px 0; display:flex; justify-content:space-between; align-items:center; background:' + (isActive ? '#ede9fe' : '#fff') + ';" onmouseover="this.style.background=\'#f1f5f9\'" onmouseout="this.style.background=\'' + (isActive ? '#ede9fe' : '#fff') + '\'">';
            h += '<div><span style="font-weight:700; font-size:13px;">' + info.name + '</span>';
            if (info.role) h += ' <span style="font-size:10px; color:#6366f1; background:#e0e7ff; padding:1px 6px; border-radius:4px;">' + info.role + '</span>';
            h += '</div>';
            if (isActive) h += '<span style="color:#6366f1; font-size:12px;">✓ 현재</span>';
            h += '</div>';
        });
        dd.innerHTML = h;
        // 바깥 클릭 시 닫기
        setTimeout(function() {
            document.addEventListener('click', function closeDD(e) {
                if (!dd.contains(e.target) && e.target.id !== 'lcChangeMgrBtn') {
                    dd.style.display = 'none';
                    document.removeEventListener('click', closeDD);
                }
            });
        }, 100);
    };
    window.lcChangeManager = async function(newMgrName) {
        if (!currentRoom || !newMgrName) return;
        var sb = getSb();
        var oldMgr = currentRoom.assigned_manager || '미배정';
        // DB 업데이트
        await sb.from('chat_rooms').update({
            assigned_manager: newMgrName,
            updated_at: new Date().toISOString()
        }).eq('id', currentRoom.id);
        // 시스템 메시지
        var lang = detectRoomLang(currentRoom);
        var msgs = {
            kr: '🔄 담당 매니저가 ' + oldMgr + '에서 ' + newMgrName + '(으)로 변경되었습니다.',
            ja: '🔄 担当マネージャーが ' + oldMgr + ' から ' + newMgrName + ' に変更されました。',
            en: '🔄 Your manager has been changed from ' + oldMgr + ' to ' + newMgrName + '.'
        };
        await sb.from('chat_messages').insert({
            room_id: currentRoom.id,
            sender_type: 'system',
            message: msgs[lang] || msgs['kr']
        });
        // 로컬 상태 업데이트
        currentRoom.assigned_manager = newMgrName;
        // UI 업데이트
        var mgrBadge = document.getElementById('lcChatManagerBadge');
        if (mgrBadge) { mgrBadge.textContent = '담당: ' + newMgrName; mgrBadge.style.background = '#6366f1'; }
        // 드롭다운 닫기
        document.getElementById('lcChangeMgrDropdown').style.display = 'none';
        // 채팅 새로고침
        var mr = await sb.from('chat_messages').select('*').eq('room_id', currentRoom.id).order('created_at', {ascending: true}).limit(100);
        var area = document.getElementById('lcChatMessages');
        if (mr.data) { var h=''; mr.data.forEach(function(m){ h+=renderMsg(m); }); area.innerHTML=h; area.scrollTop=area.scrollHeight; }
        lcLoadRooms();
    };
})();

// ═══ 번역 기능 ═══
(function(){
    var SUPA_URL = 'https://qinvtnhiidtmrzosyvys.supabase.co';

    async function callTranslate(text, from, to) {
        var sb = window.sb;
        if (!sb) throw new Error('Supabase not ready');
        var res = await sb.functions.invoke('translate', { body: { text: text, from: from, to: to } });
        if (res.error) throw res.error;
        if (res.data && res.data.error) throw new Error(res.data.error);
        return (res.data && res.data.translated) || '';
    }

    // 개별 메시지 번역 (한국어로)
    window.lcTranslateMsg = async function(btn, spanId) {
        var msg = btn.getAttribute('data-msg');
        if (!msg) return;
        var span = document.getElementById(spanId);
        if (!span) return;
        btn.disabled = true; btn.textContent = '번역중...';
        try {
            var result = await callTranslate(msg, 'auto', 'kr');
            span.textContent = result;
            span.style.display = 'inline';
            btn.textContent = '✅ 완료';
        } catch(e) {
            span.textContent = '번역 실패';
            btn.textContent = '재시도';
            btn.disabled = false;
            console.error('Translation error:', e);
        }
    };

    // 번역 도구 (하단)
    window.lcTranslate = async function() {
        var inp = document.getElementById('lcTransInput');
        var text = inp.value.trim();
        if (!text) { showToast('번역할 텍스트를 입력하세요', 'warn'); return; }
        var from = document.getElementById('lcTransFrom').value;
        var to = document.getElementById('lcTransTo').value;
        if (from === to) { showToast('원본 언어와 번역 언어가 같습니다', 'warn'); return; }
        var btn = document.getElementById('lcTransBtn');
        btn.disabled = true; btn.textContent = '번역중...';
        try {
            var result = await callTranslate(text, from, to);
            document.getElementById('lcTransText').textContent = result;
            document.getElementById('lcTransResult').style.display = 'block';
        } catch(e) {
            showToast('번역 실패: ' + (e.message || e), 'error');
            console.error('Translation error:', e);
        } finally {
            btn.disabled = false; btn.textContent = '번역';
        }
    };

    // 복사
    window.lcCopyTrans = function() {
        var text = document.getElementById('lcTransText').textContent;
        navigator.clipboard.writeText(text).then(function() {
            var btn = event.target.closest('button');
            btn.textContent = '✅ 복사됨';
            setTimeout(function() { btn.textContent = '📋 복사'; }, 1500);
        });
    };

    // 입력창에 넣기
    window.lcUseTrans = function() {
        var text = document.getElementById('lcTransText').textContent;
        document.getElementById('lcMsgInput').value = text;
        document.getElementById('lcMsgInput').focus();
    };
})();

// ═══ 상담사 관리 ═══
window.lcShowAddManager = function() { document.getElementById('lcAddManagerForm').style.display = 'block'; };
window.lcLoadManagers = async function() {
    var sb = window.sb; if (!sb) return;
    var r = await sb.from('chatbot_knowledge').select('*').eq('category', '_managers').eq('is_active', true).order('priority', {ascending: false});
    var list = document.getElementById('lcManagerList');
    if (!r.data || r.data.length === 0) { list.innerHTML = '<div style="color:#94a3b8;font-size:11px;text-align:center;padding:8px;">상담사 없음 (+ 추가 버튼으로 등록)</div>'; return; }
    var h = '';
    r.data.forEach(function(m) {
        try { var info = JSON.parse(m.answer); } catch(e) { var info = {name: m.question, phone: '', role: ''}; }
        h += '<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 8px;background:#f8fafc;border-radius:6px;margin-bottom:3px;">';
        h += '<div><span style="font-weight:700;">' + info.name + '</span> <span style="color:#6366f1;font-size:11px;">' + (info.phone||'') + '</span>';
        if (info.role) h += ' <span style="background:#e0e7ff;padding:1px 6px;border-radius:4px;font-size:10px;">' + info.role + '</span>';
        h += '</div><button class="btn btn-outline btn-sm" style="font-size:10px;color:#ef4444;padding:1px 5px;" onclick="lcDeleteManager(' + m.id + ')">삭제</button></div>';
    });
    list.innerHTML = h;
};
window.lcAddManager = async function() {
    var sb = window.sb; if (!sb) return;
    var name = document.getElementById('lcNewMgrName').value.trim();
    var phone = document.getElementById('lcNewMgrPhone').value.trim();
    var role = document.getElementById('lcNewMgrRole').value.trim();
    if (!name) { showToast('이름 입력', 'warn'); return; }
    await sb.from('chatbot_knowledge').insert({category:'_managers',question:name,answer:JSON.stringify({name:name,phone:phone,role:role}),keywords:phone,language:'ko',priority:5,is_active:true});
    document.getElementById('lcNewMgrName').value='';document.getElementById('lcNewMgrPhone').value='';document.getElementById('lcNewMgrRole').value='';
    document.getElementById('lcAddManagerForm').style.display='none';
    lcLoadManagers(); showToast('상담사 등록!', 'success');
};
window.lcDeleteManager = async function(id) { if(!confirm('삭제?'))return; await window.sb.from('chatbot_knowledge').update({is_active:false}).eq('id',id); lcLoadManagers(); };

// ── 상품 공통 하단 안내문 (Product Footer) ──
var _pfCurrentLang = 'kr';
window.pfLoadFooter = async function(lang) {
    _pfCurrentLang = lang || 'kr';
    document.getElementById('pfCurrentLang').textContent = _pfCurrentLang.toUpperCase();
    var _sb = window.sb; if (!_sb) return;
    var r = await _sb.from('chatbot_knowledge').select('answer').eq('category','_product_footer').eq('language', _pfCurrentLang).eq('is_active',true).maybeSingle();
    document.getElementById('pfFooterContent').value = (r && r.data) ? r.data.answer : '';
    document.getElementById('pfPreviewArea').style.display = 'none';
};
window.pfSaveFooter = async function() {
    var _sb = window.sb; if (!_sb) return;
    var content = document.getElementById('pfFooterContent').value.trim();
    // 기존 항목 비활성화
    await _sb.from('chatbot_knowledge').update({is_active:false}).eq('category','_product_footer').eq('language', _pfCurrentLang);
    // 새로 저장
    if (content) {
        await _sb.from('chatbot_knowledge').insert({
            category: '_product_footer',
            question: 'product_footer_' + _pfCurrentLang,
            answer: content,
            keywords: '',
            language: _pfCurrentLang,
            priority: 0,
            is_active: true
        });
    }
    showToast(_pfCurrentLang.toUpperCase() + ' 안내문 저장 완료!', 'success');
};
window.pfPreviewFooter = function() {
    var area = document.getElementById('pfPreviewArea');
    var content = document.getElementById('pfFooterContent').value;
    area.innerHTML = content.replace(/\n/g, '<br>');
    area.style.display = area.style.display === 'none' ? 'block' : 'none';
};

</script>

</body>
</html>