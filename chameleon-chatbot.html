<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ… AI ìƒë‹´ë´‡</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
<style>
/* ========================================
   ì¹´ë©œë ˆì˜¨ AI ìƒë‹´ë´‡ - ì±—ë´‡ ìœ„ì ¯ ìŠ¤íƒ€ì¼
   ======================================== */
:root {
    --bot-primary: #6366f1;
    --bot-primary-dark: #4338ca;
    --bot-accent: #f59e0b;
    --bot-bg: #f8fafc;
    --bot-card: #ffffff;
    --bot-text: #1e293b;
    --bot-text-sub: #64748b;
    --bot-border: #e2e8f0;
    --bot-radius: 16px;
    --bot-shadow: 0 20px 60px rgba(99, 102, 241, 0.15);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Pretendard', -apple-system, sans-serif;
    background: #f1f5f9;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
}

/* ë°ëª¨ ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ */
.demo-container {
    text-align: center;
    padding: 40px;
}
.demo-container h1 {
    font-size: 24px;
    color: var(--bot-text);
    margin-bottom: 8px;
}
.demo-container p {
    color: var(--bot-text-sub);
    font-size: 14px;
    margin-bottom: 30px;
}

/* ===== í”Œë¡œíŒ… ë²„íŠ¼ ===== */
#chameleon-bot-trigger {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--bot-primary) 0%, var(--bot-primary-dark) 100%);
    border: none;
    cursor: pointer;
    box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99998;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    animation: bot-pulse 2s infinite;
}
#chameleon-bot-trigger:hover {
    transform: scale(1.1);
    box-shadow: 0 12px 40px rgba(99, 102, 241, 0.5);
}
#chameleon-bot-trigger i {
    font-size: 26px;
    color: #fff;
    transition: transform 0.3s;
}
#chameleon-bot-trigger.open i { transform: rotate(90deg); }

@keyframes bot-pulse {
    0%, 100% { box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4); }
    50% { box-shadow: 0 8px 32px rgba(99, 102, 241, 0.6), 0 0 0 8px rgba(99, 102, 241, 0.1); }
}

/* ===== ì±—ë´‡ ìœˆë„ìš° ===== */
#chameleon-bot-window {
    position: fixed;
    bottom: 100px;
    right: 24px;
    width: 400px;
    max-width: calc(100vw - 32px);
    height: 640px;
    max-height: calc(100vh - 140px);
    background: var(--bot-bg);
    border-radius: var(--bot-radius);
    box-shadow: var(--bot-shadow);
    display: none;
    flex-direction: column;
    overflow: hidden;
    z-index: 99999;
    border: 1px solid var(--bot-border);
    animation: bot-slide-up 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
}
#chameleon-bot-window.visible { display: flex; }

@keyframes bot-slide-up {
    from { opacity: 0; transform: translateY(20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

/* í—¤ë” */
.bot-header {
    background: linear-gradient(135deg, var(--bot-primary) 0%, var(--bot-primary-dark) 100%);
    padding: 18px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}
.bot-avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
}
.bot-header-info h3 {
    color: #fff;
    font-size: 15px;
    font-weight: 800;
}
.bot-header-info span {
    color: rgba(255,255,255,0.8);
    font-size: 12px;
}
.bot-header-close {
    margin-left: auto;
    background: rgba(255,255,255,0.15);
    border: none;
    color: #fff;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}
.bot-header-close:hover { background: rgba(255,255,255,0.3); }

/* ë©”ì‹œì§€ ì˜ì—­ */
.bot-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    scroll-behavior: smooth;
}
.bot-messages::-webkit-scrollbar { width: 4px; }
.bot-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

/* ë©”ì‹œì§€ ë²„ë¸” */
.msg-row {
    display: flex;
    gap: 8px;
    max-width: 88%;
    animation: msg-in 0.3s ease-out;
}
.msg-row.bot { align-self: flex-start; }
.msg-row.user { align-self: flex-end; flex-direction: row-reverse; }

@keyframes msg-in {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

.msg-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: var(--bot-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    color: #fff;
    flex-shrink: 0;
    margin-top: 2px;
}
.msg-row.user .msg-avatar { display: none; }

.msg-bubble {
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 13.5px;
    line-height: 1.65;
    color: var(--bot-text);
    word-break: keep-all;
}
.msg-row.bot .msg-bubble {
    background: var(--bot-card);
    border: 1px solid var(--bot-border);
    border-top-left-radius: 4px;
}
.msg-row.user .msg-bubble {
    background: var(--bot-primary);
    color: #fff;
    border-top-right-radius: 4px;
}

/* íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° */
.typing-indicator {
    display: flex;
    gap: 4px;
    padding: 14px 18px;
}
.typing-indicator span {
    width: 7px;
    height: 7px;
    background: #94a3b8;
    border-radius: 50%;
    animation: typing-bounce 1.4s infinite;
}
.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
@keyframes typing-bounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-6px); opacity: 1; }
}

/* ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ */
.quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 10px;
}
.quick-btn {
    padding: 7px 14px;
    border: 1px solid var(--bot-primary);
    border-radius: 20px;
    background: #f5f3ff;
    color: var(--bot-primary);
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
}
.quick-btn:hover {
    background: var(--bot-primary);
    color: #fff;
    transform: translateY(-1px);
}

/* ìƒí’ˆ ì¹´ë“œ */
.product-card {
    background: var(--bot-card);
    border: 1px solid var(--bot-border);
    border-radius: 12px;
    padding: 14px;
    margin-top: 8px;
}
.product-card .pc-name {
    font-weight: 800;
    font-size: 14px;
    color: var(--bot-text);
}
.product-card .pc-price {
    font-size: 18px;
    font-weight: 900;
    color: var(--bot-primary);
    margin-top: 4px;
}
.product-card .pc-meta {
    font-size: 12px;
    color: var(--bot-text-sub);
    margin-top: 4px;
}

/* ê²¬ì  ê²°ê³¼ ì¹´ë“œ */
.estimate-card {
    background: linear-gradient(135deg, #ede9fe 0%, #e0e7ff 100%);
    border: 2px solid var(--bot-primary);
    border-radius: 14px;
    padding: 18px;
    margin-top: 10px;
}
.estimate-card h4 {
    font-size: 13px;
    color: var(--bot-primary-dark);
    margin-bottom: 10px;
}
.estimate-card .est-row {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    padding: 4px 0;
    color: #475569;
}
.estimate-card .est-total {
    border-top: 2px solid var(--bot-primary);
    margin-top: 10px;
    padding-top: 10px;
    font-size: 20px;
    font-weight: 900;
    color: var(--bot-primary-dark);
    text-align: right;
}

/* ì£¼ë¬¸ ìƒíƒœ ì¹´ë“œ */
.order-card {
    background: var(--bot-card);
    border: 1px solid var(--bot-border);
    border-radius: 12px;
    padding: 14px;
    margin-top: 8px;
}
.order-card .oc-status {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 800;
}
.status-ì ‘ìˆ˜ë¨ { background: #dbeafe; color: #2563eb; }
.status-ì œì‘ì¤‘ { background: #fef3c7; color: #d97706; }
.status-ë°°ì†¡ì¤‘ { background: #d1fae5; color: #059669; }
.status-ì™„ë£Œ { background: #f1f5f9; color: #64748b; }

/* ì…ë ¥ ì˜ì—­ */
.bot-input-area {
    padding: 12px 16px;
    background: var(--bot-card);
    border-top: 1px solid var(--bot-border);
    display: flex;
    gap: 8px;
    align-items: center;
    flex-shrink: 0;
}
.bot-input-area input {
    flex: 1;
    border: 1px solid var(--bot-border);
    border-radius: 12px;
    padding: 11px 16px;
    font-size: 14px;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
    background: var(--bot-bg);
}
.bot-input-area input:focus { border-color: var(--bot-primary); }
.bot-input-area input::placeholder { color: #94a3b8; }

.bot-send-btn {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: var(--bot-primary);
    border: none;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
}
.bot-send-btn:hover { background: var(--bot-primary-dark); transform: scale(1.05); }
.bot-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* ëª¨ë°”ì¼ */
@media (max-width: 480px) {
    #chameleon-bot-window {
        bottom: 0;
        right: 0;
        width: 100vw;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
    }
    #chameleon-bot-trigger { bottom: 16px; right: 16px; width: 56px; height: 56px; }
}
</style>
</head>
<body>

<div class="demo-container">
    <h1>ğŸ¦ ì¹´ë©œë ˆì˜¨ AI ìƒë‹´ë´‡</h1>
    <p>ì˜¤ë¥¸ìª½ í•˜ë‹¨ì˜ ì±„íŒ… ë²„íŠ¼ì„ ëˆŒëŸ¬ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”</p>
    <p style="font-size:12px; color:#94a3b8; margin-top:10px;">
        â€» ì´ íŒŒì¼ì€ ë…ë¦½ ë°ëª¨ì…ë‹ˆë‹¤. ì‹¤ì œ ì ìš© ì‹œ index.htmlì— ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚½ì…í•˜ì„¸ìš”.
    </p>
</div>

<!-- ===== ì±—ë´‡ íŠ¸ë¦¬ê±° ë²„íŠ¼ ===== -->
<button id="chameleon-bot-trigger" onclick="toggleBot()">
    <i class="fa-solid fa-comments"></i>
</button>

<!-- ===== ì±—ë´‡ ìœˆë„ìš° ===== -->
<div id="chameleon-bot-window">
    <div class="bot-header">
        <div class="bot-avatar">ğŸ¦</div>
        <div class="bot-header-info">
            <h3>ì¹´ë©œë ˆì˜¨ AI ìƒë‹´</h3>
            <span><i class="fa-solid fa-circle" style="color:#4ade80; font-size:8px;"></i> 24ì‹œê°„ ìë™ì‘ë‹µ</span>
        </div>
        <button class="bot-header-close" onclick="toggleBot()">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>

    <div class="bot-messages" id="botMessages"></div>

    <div class="bot-input-area">
        <input type="text" id="botInput" placeholder="ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•˜ì„¸ìš”..." 
               onkeydown="if(event.key==='Enter')sendMessage()">
        <button class="bot-send-btn" onclick="sendMessage()">
            <i class="fa-solid fa-paper-plane"></i>
        </button>
    </div>
</div>

<script>
// ============================================================
// ì¹´ë©œë ˆì˜¨ AI ìƒë‹´ë´‡ ì—”ì§„
// ============================================================

// â–¼â–¼â–¼ [ì„¤ì •] Supabase ì—°ê²° ì •ë³´ (ì‹¤ì œ í”„ë¡œì íŠ¸ ê°’ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”) â–¼â–¼â–¼
const SUPABASE_URL = 'YOUR_SUPABASE_URL';      // ì˜ˆ: https://xxxxx.supabase.co
const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';  // ê³µê°œ anon í‚¤
// â–²â–²â–² ì„¤ì • ë â–²â–²â–²

let sb = null;
try {
    if (typeof supabase !== 'undefined' && SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
        sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    }
} catch(e) { console.warn('Supabase ë¯¸ì—°ê²° - ë°ëª¨ ëª¨ë“œë¡œ ì‘ë™í•©ë‹ˆë‹¤.'); }

// ============================================================
// [1] ê°€ê²© ê³„ì‚° ì—”ì§„ (order.jsì˜ ë¡œì§ì„ ê·¸ëŒ€ë¡œ ì´ì‹)
// ============================================================
const PRICING = {
    SQM_PRICE: 50000,      // ã¡ë‹¹ ê°€ê²© (ì›)
    MIN_PRICE: 60000,       // ìµœì†Œ ê°€ê²© (ì›)
    MM_TO_PX: 3.7795,       // mm â†’ px ë³€í™˜ ë¹„ìœ¨

    // ë©´ì  ê¸°ë°˜ ê°€ê²© ê³„ì‚° (íšŒë² ê³„ì‚°ê¸°)
    calcByArea(widthMm, heightMm) {
        const area_m2 = (widthMm / 1000) * (heightMm / 1000);
        let price = Math.round((area_m2 * this.SQM_PRICE) / 100) * 100;
        if (price < this.MIN_PRICE) price = this.MIN_PRICE;
        return { area_m2, price };
    },

    // ë“±ê¸‰ë³„ í• ì¸ìœ¨
    getDiscountRate(role) {
        if (role === 'franchise') return 0.10;
        if (['platinum', 'partner', 'partners'].includes(role)) return 0.05;
        if (role === 'gold') return 0.03;
        return 0;
    },

    // í˜„ì¬ êµ­ê°€ ê°ì§€ (ë„ë©”ì¸ + URL íŒŒë¼ë¯¸í„°)
    detectCountry() {
        const hostname = window.location.hostname;
        if (hostname.includes('cafe0101.com')) return 'JP';
        if (hostname.includes('cafe3355.com')) return 'US';
        const params = new URLSearchParams(window.location.search);
        const langParam = (params.get('lang') || '').toUpperCase();
        if (langParam === 'JA' || langParam === 'JP') return 'JP';
        if (langParam === 'EN' || langParam === 'US') return 'US';
        return 'KR';
    },

    formatPrice(num) {
        const amount = num || 0;
        const country = this.detectCountry();

        const rates = { 'KR': 1, 'JP': 0.2, 'US': 0.002 };
        const rate = rates[country] || 1;
        const converted = amount * rate;

        if (country === 'JP') return 'Â¥' + Math.floor(converted).toLocaleString();
        if (country === 'US') return '$' + Math.round(converted).toLocaleString();
        return converted.toLocaleString() + 'ì›';
    },

    // ì œí’ˆ ë°ì´í„°ì—ì„œ í˜„ì§€í™”ëœ ì´ë¦„/ê°€ê²© ê°€ì ¸ì˜¤ê¸°
    getLocalized(product) {
        const country = this.detectCountry();
        let name = product.name || '';
        let price = Number(product.price) || 0;

        if (country === 'JP') {
            name = product.name_jp || name;
            price = Number(product.price_jp) || price;
        } else if (country === 'US') {
            name = product.name_us || name;
            price = Number(product.price_us) || price;
        }

        return { name, price, formattedPrice: this.formatPriceByCountry(price, country) };
    },

    formatPriceByCountry(price, country) {
        if (country === 'JP') return 'Â¥' + Math.floor(price).toLocaleString();
        if (country === 'US') return '$' + Math.round(price).toLocaleString();
        return price.toLocaleString() + 'ì›';
    }
};

// ============================================================
// [2] FAQ ì§€ì‹ë² ì´ìŠ¤ (ì±„ë„í†¡ ìƒë‹´ ë‚´ìš© ê¸°ë°˜ìœ¼ë¡œ í™•ì¥í•˜ì„¸ìš”)
// ============================================================
const FAQ_DB = [
    {
        keywords: ['ë°°ì†¡', 'ë°°ë‹¬', 'íƒë°°', 'ì–¸ì œ ë„ì°©', 'ë©°ì¹ ', 'ë°°ì†¡ê¸°ê°„'],
        answer: `ë°°ì†¡ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤ ğŸ“¦\n\nâ€¢ <b>ìˆ˜ë„ê¶Œ</b>: ì œì‘ì™„ë£Œ í›„ 1~2ì¼ (ë¬´ë£Œë°°ì†¡)\nâ€¢ <b>ì§€ë°©</b>: ì œì‘ì™„ë£Œ í›„ 2~3ì¼\nâ€¢ <b>ì œì‘ê¸°ê°„</b>: ì£¼ë¬¸ í›„ ë³´í†µ 2~3 ì˜ì—…ì¼\nâ€¢ <b>ê¸‰í–‰ ì œì‘</b>: ë‹´ë‹¹ ë§¤ë‹ˆì €ì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”\n\nâ° ì˜¤ì „ ì£¼ë¬¸ ì‹œ ë‹¹ì¼ ì ‘ìˆ˜ ê°€ëŠ¥í•©ë‹ˆë‹¤!`
    },
    {
        keywords: ['ê²°ì œ', 'ì¹´ë“œ', 'ë¬´í†µì¥', 'ì…ê¸ˆ', 'ê³„ì¢Œ', 'ê²°ì œë°©ë²•', 'í† ìŠ¤'],
        answer: `ê²°ì œ ë°©ë²• ì•ˆë‚´ì…ë‹ˆë‹¤ ğŸ’³\n\nâ€¢ <b>ì¹´ë“œê²°ì œ</b>: í† ìŠ¤í˜ì´ë¨¼ì¸  (ëª¨ë“  ì¹´ë“œ)\nâ€¢ <b>ë¬´í†µì¥ì…ê¸ˆ</b>: ì£¼ë¬¸ í›„ ì•ˆë‚´ ê³„ì¢Œë¡œ ì…ê¸ˆ\nâ€¢ <b>ì˜ˆì¹˜ê¸ˆ</b>: ì¶©ì „ í›„ ì°¨ê° ê²°ì œ\nâ€¢ <b>ë§ˆì¼ë¦¬ì§€</b>: êµ¬ë§¤ê¸ˆì•¡ì˜ ìµœëŒ€ 5%ê¹Œì§€ ì‚¬ìš© ê°€ëŠ¥\n\nì‚¬ì—…ì ê³ ê°ì€ ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤!`
    },
    {
        keywords: ['ì‚¬ì—…ì', 'í• ì¸', 'ë“±ê¸‰', 'VIP', 'ë„ë§¤', 'ëŒ€ëŸ‰', 'B2B', 'í”„ëœì°¨ì´ì¦ˆ'],
        answer: `ì‚¬ì—…ì ê³ ê° íŠ¹ë³„ í˜œíƒ ğŸ¢\n\nâ€¢ <b>ì‚¬ì—…ìë“±ë¡ì¦</b>ì„ ë§¤ë‹ˆì €ì—ê²Œ ë³´ë‚´ì£¼ì‹œë©´ ë“±ê¸‰ ì—…ê·¸ë ˆì´ë“œ!\nâ€¢ <b>Gold ë“±ê¸‰</b>: 3% í• ì¸\nâ€¢ <b>Platinum/Partner</b>: 5% í• ì¸\nâ€¢ <b>Franchise</b>: 10% í• ì¸ + ë¬´ë£Œë°°ì†¡\n\në¬¸ì˜ì‹œê°„: ì˜¤ì „ 9ì‹œ ~ ì˜¤í›„ 6ì‹œ\nğŸ‘©â€ğŸ’¼ ì§€ìˆ™ ë§¤ë‹ˆì €: 010-3455-1946\nğŸ‘©â€ğŸ’¼ ì€ë¯¸ ë§¤ë‹ˆì €: 010-7793-5393\nğŸ‘©â€ğŸ’¼ ì„±í¬ ë§¤ë‹ˆì €: 010-3490-3328`
    },
    {
        keywords: ['ë””ìì¸', 'ì—ë””í„°', 'ë¬´ë£Œ', 'í¸ì§‘', 'ì§ì ‘', 'ë§Œë“¤ê¸°'],
        answer: `ë¬´ë£Œ ë””ìì¸ ì—ë””í„° ì•ˆë‚´ ğŸ¨\n\nì¹´ë©œë ˆì˜¨í”„ë¦°íŒ…ì€ <b>ë¬´ë£Œ ì˜¨ë¼ì¸ ì—ë””í„°</b>ë¥¼ ì œê³µí•©ë‹ˆë‹¤!\n\nâ€¢ ìƒí’ˆ ì„ íƒ â†’ ì—ë””í„°ì—ì„œ ì§ì ‘ ë””ìì¸\nâ€¢ ë‹¤ì–‘í•œ <b>ë¬´ë£Œ í…œí”Œë¦¿</b> ì œê³µ\nâ€¢ í…ìŠ¤íŠ¸, ì´ë¯¸ì§€, ë²¡í„° í¸ì§‘ ê°€ëŠ¥\nâ€¢ ì™„ì„± í›„ ë°”ë¡œ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸°\n\në””ìì¸ì´ ì–´ë ¤ìš°ì‹œë©´ íŒŒì¼ë§Œ ë³´ë‚´ì£¼ì…”ë„ ë§¤ë‹ˆì €ê°€ ë„ì™€ë“œë¦½ë‹ˆë‹¤!`
    },
    {
        keywords: ['í—ˆë‹ˆì½¤', 'ë³´ë“œ', 'í—ˆë‹ˆì½¤ë³´ë“œ', 'ì¹œí™˜ê²½'],
        answer: `í—ˆë‹ˆì½¤ë³´ë“œ ì•ˆë‚´ ğŸ¯\n\nâ€¢ ë²Œì§‘ êµ¬ì¡°ì˜ <b>ì¹œí™˜ê²½ ì¢…ì´ ì†Œì¬</b>\nâ€¢ ê°€ë³ê³  íŠ¼íŠ¼í•´ì„œ ì „ì‹œ/íŒì—…ìŠ¤í† ì–´ì— ìµœì \nâ€¢ ì¬í™œìš© ê°€ëŠ¥í•œ ì¹œí™˜ê²½ ì¸ì‡„ë¬¼\nâ€¢ ë‹¤ì–‘í•œ ì‚¬ì´ì¦ˆ ë§ì¶¤ ì œì‘ ê°€ëŠ¥\n\nì •í™•í•œ ê°€ê²©ì€ ì‚¬ì´ì¦ˆë¥¼ ì•Œë ¤ì£¼ì‹œë©´ ë°”ë¡œ ê²¬ì  ë“œë¦¬ê² ìŠµë‹ˆë‹¤!`
    },
    {
        keywords: ['íŒ¨ë¸Œë¦­', 'ì²œ', 'ì›ë‹¨', 'í˜„ìˆ˜ë§‰', 'ë°°ë„ˆ'],
        answer: `íŒ¨ë¸Œë¦­(ì²œ) ì¸ì‡„ ì•ˆë‚´ ğŸ§µ\n\nâ€¢ <b>ê³ í•´ìƒë„ ë””ì§€í„¸ ì¸ì‡„</b>\nâ€¢ ë°±ì›”, í˜„ìˆ˜ë§‰, ë°°ë„ˆ ë“± ë‹¤ì–‘í•œ ìš©ë„\nâ€¢ ì‹¤ë‚´/ì‹¤ì™¸ ê²¸ìš© ì†Œì¬ ì„ íƒ ê°€ëŠ¥\nâ€¢ ë§ˆê°ì²˜ë¦¬ (ì—´ì¬ë‹¨, ë´‰ì œ ë“±) ì˜µì…˜ ì œê³µ\n\nì‚¬ì´ì¦ˆì™€ ìš©ë„ë¥¼ ì•Œë ¤ì£¼ì‹œë©´ ì •í™•í•œ ê²¬ì ì„ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤.`
    },
    {
        keywords: ['ë“±ì‹ ëŒ€', 'ìŠ¤íƒ ë“œ', 'í¬í† ì¡´', 'í¬í† ', 'ì¸ë¬¼'],
        answer: `ë“±ì‹ ëŒ€ / í¬í† ì¡´ ì•ˆë‚´ ğŸ“¸\n\nâ€¢ ì‹¤ë¬¼ í¬ê¸° ë“±ì‹ ëŒ€ ì œì‘ ê°€ëŠ¥\nâ€¢ íŒì—…ìŠ¤í† ì–´, ì´ë²¤íŠ¸ìš© í¬í† ì¡´\nâ€¢ ì–‘ë©´/ë‹¨ë©´ ì„ íƒ ê°€ëŠ¥\nâ€¢ ì§€ì§€ëŒ€ í¬í•¨\n\në¬´ë£Œ ì—ë””í„°ì—ì„œ ì§ì ‘ ë””ìì¸í•˜ì‹œê±°ë‚˜, ì´ë¯¸ì§€ë¥¼ ë³´ë‚´ì£¼ì‹œë©´ ì œì‘í•´ ë“œë¦½ë‹ˆë‹¤!`
    },
    {
        keywords: ['íŒì—…', 'ì „ì‹œ', 'ë¶€ìŠ¤', 'í–‰ì‚¬', 'ì´ë²¤íŠ¸'],
        answer: `íŒì—…ìŠ¤í† ì–´ / ì „ì‹œ ì„œë¹„ìŠ¤ ğŸª\n\nì¹´ë©œë ˆì˜¨í”„ë¦°íŒ…ì€ <b>ì „ì‹œÂ·íŒì—…ìŠ¤í† ì–´ ì „ë¬¸</b>ì…ë‹ˆë‹¤!\n\nâ€¢ ë°±ì›”(ë°°ê²½ë²½), ë“±ì‹ ëŒ€, í˜„ìˆ˜ë§‰\nâ€¢ ì¢…ì´ë§¤ëŒ€, í—ˆë‹ˆì½¤ë³´ë“œ\nâ€¢ í¬í† ì¡´, ë°°ë„ˆ ë“± ì›ìŠ¤í†± ì œì‘\nâ€¢ ëŒ€ëŸ‰ ì£¼ë¬¸ ì‹œ VIP ì „ë‹´ ë§¤ë‹ˆì € ë°°ì •\n\ní–‰ì‚¬ ê·œëª¨ì™€ í•„ìš”í•œ í’ˆëª©ì„ ì•Œë ¤ì£¼ì‹œë©´ íŒ¨í‚¤ì§€ ê²¬ì ì„ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤!`
    },
    {
        keywords: ['íŒŒì¼', 'ì…ê³ ', 'í˜•ì‹', 'pdf', 'ai', 'ì¼ëŸ¬ìŠ¤íŠ¸', 'í¬í† ìƒµ', 'í•´ìƒë„'],
        answer: `íŒŒì¼ ì…ê³  ì•ˆë‚´ ğŸ“„\n\nâ€¢ <b>ê¶Œì¥ í˜•ì‹</b>: PDF, AI, PSD\nâ€¢ <b>í•´ìƒë„</b>: 150~300 DPI ê¶Œì¥\nâ€¢ í…ìŠ¤íŠ¸ëŠ” ì•„ì›ƒë¼ì¸(ìœ¤ê³½ì„ ) ì²˜ë¦¬ í•„ìš”\nâ€¢ ì¬ë‹¨ì„ Â·ì—¬ë°± í¬í•¨ ì‹œ ë” ì •í™•í•œ ì œì‘ ê°€ëŠ¥\n\níŒŒì¼ì´ ì—†ìœ¼ì‹œë©´ ë¬´ë£Œ ì—ë””í„°ë¡œ ì§ì ‘ ë§Œë“œì‹¤ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤!`
    },
    {
        keywords: ['ë§ˆì¼ë¦¬ì§€', 'ì ë¦½', 'í¬ì¸íŠ¸', 'ë¦¬ì›Œë“œ'],
        answer: `ë§ˆì¼ë¦¬ì§€ ì•ˆë‚´ ğŸ’°\n\nâ€¢ êµ¬ë§¤ ì‹œ ë§ˆì¼ë¦¬ì§€ê°€ ìë™ ì ë¦½ë©ë‹ˆë‹¤\nâ€¢ ê²°ì œ ì‹œ <b>êµ¬ë§¤ê¸ˆì•¡ì˜ ìµœëŒ€ 5%</b>ê¹Œì§€ ì‚¬ìš© ê°€ëŠ¥\nâ€¢ ë§ˆì¼ë¦¬ì§€ëŠ” ë¡œê·¸ì¸ í›„ ë§ˆì´í˜ì´ì§€ì—ì„œ í™•ì¸\nâ€¢ ì¼ë¶€ ì œì™¸ ìƒí’ˆì—ëŠ” ì‚¬ìš© ë¶ˆê°€`
    },
    {
        keywords: ['ì·¨ì†Œ', 'í™˜ë¶ˆ', 'êµí™˜', 'ë°˜í’ˆ'],
        answer: `ì·¨ì†Œ/í™˜ë¶ˆ ì•ˆë‚´ ğŸ”„\n\nâ€¢ <b>ì œì‘ ì „</b>: ì „ì•¡ í™˜ë¶ˆ ê°€ëŠ¥\nâ€¢ <b>ì œì‘ ì¤‘/í›„</b>: ë§ì¶¤ ì œì‘ íŠ¹ì„±ìƒ êµí™˜Â·í™˜ë¶ˆ ì–´ë ¤ì›€\nâ€¢ <b>ë¶ˆëŸ‰ ì‹œ</b>: 100% ì¬ì œì‘ ë˜ëŠ” í™˜ë¶ˆ\n\nì£¼ë¬¸ ì·¨ì†ŒëŠ” ë‹´ë‹¹ ë§¤ë‹ˆì €ì—ê²Œ ë¹ ë¥´ê²Œ ì—°ë½í•´ì£¼ì„¸ìš”!`
    },
    {
        keywords: ['ì˜ì—…ì‹œê°„', 'ìš´ì˜ì‹œê°„', 'ì–¸ì œ', 'ì „í™”', 'ì—°ë½ì²˜', 'ìƒë‹´ì‹œê°„'],
        answer: `ì˜ì—… ì•ˆë‚´ ğŸ•\n\nâ€¢ <b>ìƒë‹´ì‹œê°„</b>: ì˜¤ì „ 9ì‹œ ~ ì˜¤í›„ 6ì‹œ (í‰ì¼)\nâ€¢ <b>AI ìƒë‹´ë´‡</b>: 24ì‹œê°„ ìš´ì˜ ì¤‘\n\nğŸ“ ì „í™” ë¬¸ì˜:\nğŸ‘©â€ğŸ’¼ ì§€ìˆ™ ë§¤ë‹ˆì €: 010-3455-1946\nğŸ‘©â€ğŸ’¼ ì€ë¯¸ ë§¤ë‹ˆì €: 010-7793-5393\nğŸ‘©â€ğŸ’¼ ì„±í¬ ë§¤ë‹ˆì €: 010-3490-3328`
    }
];

// ============================================================
// [3] ìƒíƒœ ê´€ë¦¬
// ============================================================
let botState = {
    mode: 'idle',           // idle | awaiting_size | awaiting_order_id | awaiting_product_search
    pendingProduct: null,    // ê²¬ì  ì¤‘ì¸ ìƒí’ˆ ì •ë³´
    conversationHistory: []  // ëŒ€í™” ê¸°ë¡
};

// ============================================================
// [4] UI í•¨ìˆ˜
// ============================================================
function toggleBot() {
    const win = document.getElementById('chameleon-bot-window');
    const trigger = document.getElementById('chameleon-bot-trigger');
    const isVisible = win.classList.contains('visible');

    if (isVisible) {
        win.classList.remove('visible');
        trigger.classList.remove('open');
        trigger.querySelector('i').className = 'fa-solid fa-comments';
    } else {
        win.classList.add('visible');
        trigger.classList.add('open');
        trigger.querySelector('i').className = 'fa-solid fa-xmark';

        if (document.getElementById('botMessages').children.length === 0) {
            showWelcome();
        }
    }
}

function addMessage(content, sender = 'bot', isHtml = true) {
    const container = document.getElementById('botMessages');
    const row = document.createElement('div');
    row.className = `msg-row ${sender}`;

    let avatarHtml = sender === 'bot' ? '<div class="msg-avatar">ğŸ¦</div>' : '';
    
    row.innerHTML = `
        ${avatarHtml}
        <div class="msg-bubble">${isHtml ? content : escapeHtml(content)}</div>
    `;
    container.appendChild(row);
    container.scrollTop = container.scrollHeight;
}

function showTyping() {
    const container = document.getElementById('botMessages');
    const row = document.createElement('div');
    row.className = 'msg-row bot';
    row.id = 'typingRow';
    row.innerHTML = `
        <div class="msg-avatar">ğŸ¦</div>
        <div class="msg-bubble">
            <div class="typing-indicator">
                <span></span><span></span><span></span>
            </div>
        </div>
    `;
    container.appendChild(row);
    container.scrollTop = container.scrollHeight;
}

function removeTyping() {
    const el = document.getElementById('typingRow');
    if (el) el.remove();
}

function addQuickActions(actions) {
    const container = document.getElementById('botMessages');
    const lastMsg = container.lastElementChild;
    if (!lastMsg) return;
    
    const bubble = lastMsg.querySelector('.msg-bubble');
    if (!bubble) return;

    const div = document.createElement('div');
    div.className = 'quick-actions';
    actions.forEach(action => {
        const btn = document.createElement('button');
        btn.className = 'quick-btn';
        btn.textContent = action.label;
        btn.onclick = () => {
            // í€µ ì•¡ì…˜ ì˜ì—­ ì œê±° (í•œ ë²ˆë§Œ ì‚¬ìš©)
            document.querySelectorAll('.quick-actions').forEach(el => el.remove());
            handleUserInput(action.value || action.label);
        };
        div.appendChild(btn);
    });
    bubble.appendChild(div);
}

function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ============================================================
// [5] í™˜ì˜ ë©”ì‹œì§€
// ============================================================
function showWelcome() {
    addMessage(`ì•ˆë…•í•˜ì„¸ìš”! ğŸ¦ <b>ì¹´ë©œë ˆì˜¨í”„ë¦°íŒ…</b> AI ìƒë‹´ë´‡ì…ë‹ˆë‹¤.\n\nì¹œí™˜ê²½ ì „ì‹œÂ·íŒì—…ìŠ¤í† ì–´ ì¸ì‡„ ì „ë¬¸ ì‡¼í•‘ëª°ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?`);
    
    setTimeout(() => {
        addQuickActions([
            { label: 'ğŸ’° ê°€ê²©/ê²¬ì  ë¬¸ì˜', value: 'ê²¬ì ' },
            { label: 'ğŸ” ìƒí’ˆ ê²€ìƒ‰', value: 'ìƒí’ˆê²€ìƒ‰' },
            { label: 'ğŸ“¦ ì£¼ë¬¸ ì¡°íšŒ', value: 'ì£¼ë¬¸ì¡°íšŒ' },
            { label: 'â“ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸', value: 'FAQ' }
        ]);
    }, 100);
}

// ============================================================
// [6] ë©”ì‹œì§€ ì „ì†¡ ë° ì²˜ë¦¬ ë©”ì¸ í•¸ë“¤ëŸ¬
// ============================================================
function sendMessage() {
    const input = document.getElementById('botInput');
    const text = input.value.trim();
    if (!text) return;

    input.value = '';
    addMessage(text, 'user', false);
    
    showTyping();
    
    // íƒ€ì´í•‘ íš¨ê³¼ í›„ ì‘ë‹µ
    setTimeout(() => {
        removeTyping();
        handleUserInput(text);
    }, 600 + Math.random() * 600);
}

async function handleUserInput(text) {
    const lower = text.toLowerCase();

    // â”€â”€ [A] ìƒíƒœ ê¸°ë°˜ ë¶„ê¸° â”€â”€
    if (botState.mode === 'awaiting_size') {
        return handleSizeInput(text);
    }
    if (botState.mode === 'awaiting_order_id') {
        return handleOrderIdInput(text);
    }
    if (botState.mode === 'awaiting_product_search') {
        return handleProductSearch(text);
    }

    // â”€â”€ [B] ì˜ë„ ë¶„ì„ â”€â”€
    
    // 1) ê²¬ì /ê°€ê²© ë¬¸ì˜
    if (/ê²¬ì |ê°€ê²©|ì–¼ë§ˆ|ë¹„ìš©|ê³„ì‚°|ë‹¨ê°€|ê¸ˆì•¡/.test(lower)) {
        return startEstimate();
    }

    // 2) ì£¼ë¬¸ ì¡°íšŒ
    if (/ì£¼ë¬¸.*ì¡°íšŒ|ì£¼ë¬¸.*í™•ì¸|ë°°ì†¡.*ì¡°íšŒ|ë°°ì†¡.*í™•ì¸|ë‚´.*ì£¼ë¬¸|ì£¼ë¬¸.*ìƒíƒœ|ì£¼ë¬¸ì¡°íšŒ/.test(lower)) {
        return startOrderLookup();
    }

    // 3) ìƒí’ˆ ê²€ìƒ‰
    if (/ìƒí’ˆ.*ê²€ìƒ‰|ìƒí’ˆ.*ì°¾|ë­.*ìˆ|ìƒí’ˆê²€ìƒ‰|ì¹´í…Œê³ ë¦¬|ì¢…ë¥˜/.test(lower)) {
        return startProductSearch();
    }

    // 4) FAQ
    if (/faq|ìì£¼|ì§ˆë¬¸/.test(lower)) {
        return showFaqMenu();
    }

    // 5) FAQ í‚¤ì›Œë“œ ë§¤ì¹­
    const faqMatch = matchFAQ(lower);
    if (faqMatch) {
        addMessage(faqMatch);
        addReturnToMenu();
        return;
    }

    // 6) ì¸ì‚¬
    if (/ì•ˆë…•|í•˜ì´|hello|hi|ë°˜ê°€/.test(lower)) {
        addMessage('ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?');
        addQuickActions([
            { label: 'ğŸ’° ê°€ê²©/ê²¬ì  ë¬¸ì˜', value: 'ê²¬ì ' },
            { label: 'ğŸ” ìƒí’ˆ ê²€ìƒ‰', value: 'ìƒí’ˆê²€ìƒ‰' },
            { label: 'ğŸ“¦ ì£¼ë¬¸ ì¡°íšŒ', value: 'ì£¼ë¬¸ì¡°íšŒ' },
            { label: 'â“ FAQ', value: 'FAQ' }
        ]);
        return;
    }

    // 7) ë§¤ë‹ˆì € ì—°ê²° ìš”ì²­
    if (/ìƒë‹´ì›|ë§¤ë‹ˆì €|ì§ì›|ì‚¬ëŒ|ì „í™”|ì—°ê²°/.test(lower)) {
        addMessage(`ë§¤ë‹ˆì € ì—°ê²° ì•ˆë‚´ ğŸ“\n\ní˜„ì¬ AI ìƒë‹´ë´‡ì´ ì‘ëŒ€ ì¤‘ì…ë‹ˆë‹¤.\në§¤ë‹ˆì € ìƒë‹´ì„ ì›í•˜ì‹œë©´ ì•„ë˜ ë²ˆí˜¸ë¡œ ì—°ë½í•´ì£¼ì„¸ìš”!\n\nğŸ‘©â€ğŸ’¼ ì§€ìˆ™ ë§¤ë‹ˆì €: <b>010-3455-1946</b>\nğŸ‘©â€ğŸ’¼ ì€ë¯¸ ë§¤ë‹ˆì €: <b>010-7793-5393</b>\nğŸ‘©â€ğŸ’¼ ì„±í¬ ë§¤ë‹ˆì €: <b>010-3490-3328</b>\n\nâ° ìƒë‹´ì‹œê°„: ì˜¤ì „ 9ì‹œ ~ ì˜¤í›„ 6ì‹œ`);
        addReturnToMenu();
        return;
    }

    // 8) ì‚¬ì´ì¦ˆ ì…ë ¥ íŒ¨í„´ ê°ì§€ (ë°”ë¡œ ê²¬ì ìœ¼ë¡œ)
    const sizeMatch = text.match(/(\d+)\s*[xXÃ—*]\s*(\d+)/);
    if (sizeMatch) {
        botState.mode = 'awaiting_size';
        return handleSizeInput(text);
    }

    // 9) ê¸°ë³¸ ì‘ë‹µ
    addMessage(`ì£„ì†¡í•©ë‹ˆë‹¤, ì •í™•íˆ ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš” ğŸ˜…\nì•„ë˜ ë©”ë‰´ì—ì„œ ì„ íƒí•´ ì£¼ì‹œê±°ë‚˜ ë” êµ¬ì²´ì ìœ¼ë¡œ ë¬¼ì–´ë´ ì£¼ì„¸ìš”!`);
    addQuickActions([
        { label: 'ğŸ’° ê²¬ì  ë¬¸ì˜', value: 'ê²¬ì ' },
        { label: 'ğŸ” ìƒí’ˆ ê²€ìƒ‰', value: 'ìƒí’ˆê²€ìƒ‰' },
        { label: 'ğŸ“¦ ì£¼ë¬¸ ì¡°íšŒ', value: 'ì£¼ë¬¸ì¡°íšŒ' },
        { label: 'â“ FAQ', value: 'FAQ' },
        { label: 'ğŸ“ ë§¤ë‹ˆì € ì—°ê²°', value: 'ë§¤ë‹ˆì € ì—°ê²°' }
    ]);
}

// ============================================================
// [7] ê²¬ì  ê³„ì‚° í”Œë¡œìš°
// ============================================================
function startEstimate() {
    botState.mode = 'awaiting_size';
    addMessage(`ğŸ“ <b>ìë™ ê²¬ì  ì•ˆë‚´</b>\n\nì›í•˜ì‹œëŠ” ì¸ì‡„ë¬¼ì˜ ì‚¬ì´ì¦ˆë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\n<b>ì…ë ¥ ì˜ˆì‹œ:</b>\nâ€¢ <code>1000 x 2000</code> (ê°€ë¡œ x ì„¸ë¡œ, mm)\nâ€¢ <code>500x700</code>\nâ€¢ <code>ê°€ë¡œ 1500 ì„¸ë¡œ 1000</code>\n\nğŸ’¡ ì‚¬ì´ì¦ˆë¥¼ ëª¨ë¥´ì‹œë©´ ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì‹œë©´ ê³ ì •ê°€ë¥¼ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤.`);
}

function handleSizeInput(text) {
    // ì‚¬ì´ì¦ˆ íŒŒì‹± ì‹œë„
    let w = null, h = null;
    
    // íŒ¨í„´1: 1000x2000, 1000 x 2000, 1000*2000, 1000Ã—2000
    const p1 = text.match(/(\d+)\s*[xXÃ—*]\s*(\d+)/);
    if (p1) { w = parseInt(p1[1]); h = parseInt(p1[2]); }
    
    // íŒ¨í„´2: ê°€ë¡œ 1000 ì„¸ë¡œ 2000
    if (!w) {
        const p2 = text.match(/ê°€ë¡œ\s*(\d+).*ì„¸ë¡œ\s*(\d+)/);
        if (p2) { w = parseInt(p2[1]); h = parseInt(p2[2]); }
    }

    // íŒ¨í„´3: ìˆ«ìë§Œ 2ê°œ
    if (!w) {
        const nums = text.match(/\d+/g);
        if (nums && nums.length >= 2) {
            w = parseInt(nums[0]); h = parseInt(nums[1]);
        }
    }

    if (!w || !h || w < 10 || h < 10) {
        // ìƒí’ˆëª…ìœ¼ë¡œ ê°„ì£¼
        botState.mode = 'idle';
        return searchProductByName(text);
    }

    // ë©´ì  ê³„ì‚°
    const { area_m2, price } = PRICING.calcByArea(w, h);
    
    botState.mode = 'idle';

    let estimateHtml = `
        <div class="estimate-card">
            <h4>ğŸ“‹ ìë™ ê²¬ì  ê²°ê³¼</h4>
            <div class="est-row"><span>ì‚¬ì´ì¦ˆ</span><b>${w} Ã— ${h} mm</b></div>
            <div class="est-row"><span>ë©´ì </span><b>${area_m2.toFixed(3)} mÂ²</b></div>
            <div class="est-row"><span>ë‹¨ê°€</span><b>ã¡ë‹¹ ${PRICING.formatPrice(PRICING.SQM_PRICE)}</b></div>
            ${price === PRICING.MIN_PRICE ? `<div class="est-row" style="color:#f59e0b;"><span>ìµœì†Œì£¼ë¬¸ê¸ˆì•¡ ì ìš©</span><b>${PRICING.formatPrice(PRICING.MIN_PRICE)}</b></div>` : ''}
            <div class="est-total">${PRICING.formatPrice(price)}</div>
        </div>
    `;

    addMessage(`ê²¬ì ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨\n${estimateHtml}\n\n<small>ğŸ’¡ ìœ„ ê¸ˆì•¡ì€ ê¸°ë³¸ ì¸ì‡„ë¹„ì´ë©°, ì˜µì…˜(ë§ˆê°ì²˜ë¦¬ ë“±)ì— ë”°ë¼ ì¶”ê°€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì‚¬ì—…ì ê³ ê°ì€ ë“±ê¸‰ë³„ ì¶”ê°€ í• ì¸ì´ ì ìš©ë©ë‹ˆë‹¤.</small>`);
    
    addQuickActions([
        { label: 'ğŸ“ ë‹¤ë¥¸ ì‚¬ì´ì¦ˆ ê²¬ì ', value: 'ê²¬ì ' },
        { label: 'ğŸ›’ ë°”ë¡œ ì£¼ë¬¸í•˜ê¸°', value: 'ì£¼ë¬¸í•˜ê³  ì‹¶ì–´' },
        { label: 'ğŸ“ ë§¤ë‹ˆì € ë¬¸ì˜', value: 'ë§¤ë‹ˆì € ì—°ê²°' },
        { label: 'ğŸ  ì²˜ìŒìœ¼ë¡œ', value: 'ì•ˆë…•' }
    ]);
}

// ============================================================
// [8] ìƒí’ˆ ê²€ìƒ‰ (Supabase ì—°ë™)
// ============================================================
function startProductSearch() {
    botState.mode = 'awaiting_product_search';
    addMessage(`ğŸ” <b>ìƒí’ˆ ê²€ìƒ‰</b>\n\nì°¾ìœ¼ì‹œëŠ” ìƒí’ˆëª… ë˜ëŠ” í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\nì˜ˆ: í—ˆë‹ˆì½¤ë³´ë“œ, ë“±ì‹ ëŒ€, ë°°ë„ˆ, í¼ë³´ë“œ, ë°±ì›” ë“±`);
}

async function handleProductSearch(text) {
    botState.mode = 'idle';
    
    if (!sb) {
        return searchProductByName(text);
    }
    
    try {
        const keyword = text.trim();
        const { data, error } = await sb.from('admin_products')
            .select('code, name, name_jp, name_us, price, price_jp, price_us, width_mm, height_mm, img_url, is_custom_size, is_general_product, category')
            .or(`name.ilike.%${keyword}%,code.ilike.%${keyword}%,name_jp.ilike.%${keyword}%,name_us.ilike.%${keyword}%`)
            .order('sort_order', { ascending: true })
            .limit(5);

        if (error) throw error;

        if (!data || data.length === 0) {
            addMessage(`"<b>${escapeHtml(keyword)}</b>"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤ ğŸ˜¥\n\në‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ë‹¤ì‹œ ê²€ìƒ‰í•´ ë³´ì‹œê² ì–´ìš”?`);
            addQuickActions([
                { label: 'ğŸ” ë‹¤ì‹œ ê²€ìƒ‰', value: 'ìƒí’ˆê²€ìƒ‰' },
                { label: 'ğŸ“ ë§¤ë‹ˆì € ë¬¸ì˜', value: 'ë§¤ë‹ˆì € ì—°ê²°' },
                { label: 'ğŸ  ì²˜ìŒìœ¼ë¡œ', value: 'ì•ˆë…•' }
            ]);
            return;
        }

        let resultHtml = `"<b>${escapeHtml(keyword)}</b>" ê²€ìƒ‰ ê²°ê³¼ (${data.length}ê±´)\n\n`;
        
        data.forEach(p => {
            const localized = PRICING.getLocalized(p);
            const priceText = p.is_custom_size
                ? (PRICING.detectCountry() === 'JP' ? 'ã‚µã‚¤ã‚ºåˆ¥è‡ªå‹•è¨ˆç®—' : PRICING.detectCountry() === 'US' ? 'Auto-calculated by size' : 'ì‚¬ì´ì¦ˆë³„ ìë™ ê³„ì‚°')
                : localized.formattedPrice;
            const sizeText = (p.width_mm && p.height_mm)
                ? `${p.width_mm} Ã— ${p.height_mm} mm`
                : (PRICING.detectCountry() === 'JP' ? 'ã‚«ã‚¹ã‚¿ãƒ ã‚µã‚¤ã‚º' : PRICING.detectCountry() === 'US' ? 'Custom size' : 'ë§ì¶¤ ì‚¬ì´ì¦ˆ');

            resultHtml += `
                <div class="product-card">
                    <div class="pc-name">${localized.name}</div>
                    <div class="pc-price">${priceText}</div>
                    <div class="pc-meta">ğŸ“ ${sizeText} ${p.is_custom_size ? '| ğŸ“ ' + (PRICING.detectCountry() === 'JP' ? 'é¢ç©è‡ªå‹•è¨ˆç®—' : PRICING.detectCountry() === 'US' ? 'Area calculation' : 'ë©´ì  ìë™ ê³„ì‚°') : ''}</div>
                </div>
            `;
        });

        addMessage(resultHtml);
        addQuickActions([
            { label: 'ğŸ“ ê²¬ì  ê³„ì‚°', value: 'ê²¬ì ' },
            { label: 'ğŸ” ë‹¤ì‹œ ê²€ìƒ‰', value: 'ìƒí’ˆê²€ìƒ‰' },
            { label: 'ğŸ  ì²˜ìŒìœ¼ë¡œ', value: 'ì•ˆë…•' }
        ]);

    } catch (e) {
        console.error('ìƒí’ˆ ê²€ìƒ‰ ì˜¤ë¥˜:', e);
        searchProductByName(text);
    }
}

function searchProductByName(text) {
    // Supabase ë¯¸ì—°ê²° ì‹œ ë¡œì»¬ FAQ ê¸°ë°˜ ì‘ë‹µ
    const lower = text.toLowerCase();
    const faqMatch = matchFAQ(lower);
    if (faqMatch) {
        addMessage(faqMatch);
        addReturnToMenu();
        return;
    }
    
    addMessage(`"<b>${escapeHtml(text)}</b>"ì— ëŒ€í•œ ì •ë³´ë¥¼ ì°¾ê³  ìˆì–´ìš”.\n\nDB ì—°ê²° ì‹œ ì‹¤ì‹œê°„ ìƒí’ˆ ê²€ìƒ‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. í˜„ì¬ëŠ” ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ ê¸°ë°˜ìœ¼ë¡œ ì‘ë‹µ ì¤‘ì…ë‹ˆë‹¤.\n\nì•„ë˜ ë©”ë‰´ë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”!`);
    addQuickActions([
        { label: 'ğŸ’° ê²¬ì  ë¬¸ì˜', value: 'ê²¬ì ' },
        { label: 'â“ FAQ', value: 'FAQ' },
        { label: 'ğŸ“ ë§¤ë‹ˆì € ì—°ê²°', value: 'ë§¤ë‹ˆì € ì—°ê²°' }
    ]);
}

// ============================================================
// [9] ì£¼ë¬¸ ì¡°íšŒ (Supabase ì—°ë™)
// ============================================================
function startOrderLookup() {
    botState.mode = 'awaiting_order_id';
    addMessage(`ğŸ“¦ <b>ì£¼ë¬¸ ì¡°íšŒ</b>\n\nì£¼ë¬¸ë²ˆí˜¸ ë˜ëŠ” ì£¼ë¬¸ ì‹œ ì…ë ¥í•˜ì‹  <b>ì´ë¦„</b>ì„ ì•Œë ¤ì£¼ì„¸ìš”.\n\nì˜ˆ: <code>12345</code> ë˜ëŠ” <code>í™ê¸¸ë™</code>`);
}

async function handleOrderIdInput(text) {
    botState.mode = 'idle';
    const keyword = text.trim();

    if (!sb) {
        addMessage(`ì£¼ë¬¸ ì¡°íšŒë¥¼ ìœ„í•´ì„œëŠ” Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\ní˜„ì¬ ë°ëª¨ ëª¨ë“œì—ì„œëŠ” ì¡°íšŒê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ë§¤ë‹ˆì €ì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”!`);
        addReturnToMenu();
        return;
    }

    try {
        let query;
        if (/^\d+$/.test(keyword)) {
            query = sb.from('orders').select('*').eq('id', parseInt(keyword));
        } else {
            query = sb.from('orders').select('*').ilike('customer_name', `%${keyword}%`).order('created_at', { ascending: false }).limit(3);
        }

        const { data, error } = await query;
        if (error) throw error;

        if (!data || data.length === 0) {
            addMessage(`"<b>${escapeHtml(keyword)}</b>"ë¡œ ì¡°íšŒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤ ğŸ˜¥\n\nì£¼ë¬¸ë²ˆí˜¸ë‚˜ ì´ë¦„ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.`);
            addQuickActions([
                { label: 'ğŸ” ë‹¤ì‹œ ì¡°íšŒ', value: 'ì£¼ë¬¸ì¡°íšŒ' },
                { label: 'ğŸ“ ë§¤ë‹ˆì € ë¬¸ì˜', value: 'ë§¤ë‹ˆì € ì—°ê²°' }
            ]);
            return;
        }

        let resultHtml = `ì£¼ë¬¸ ì¡°íšŒ ê²°ê³¼ì…ë‹ˆë‹¤ ğŸ“‹\n\n`;
        
        data.forEach(order => {
            const statusClass = `status-${order.status || 'ì ‘ìˆ˜ë¨'}`;
            const date = new Date(order.created_at).toLocaleDateString('ko-KR');
            
            resultHtml += `
                <div class="order-card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <b>ì£¼ë¬¸ë²ˆí˜¸ #${order.id}</b>
                        <span class="oc-status ${statusClass}">${order.status || 'ì ‘ìˆ˜ë¨'}</span>
                    </div>
                    <div style="font-size:12px; color:#64748b;">
                        ğŸ“… ${date}<br>
                        ğŸ’° ${PRICING.formatPrice(order.total_amount)}<br>
                        ğŸ’³ ${order.payment_method || '-'} | ${order.payment_status || '-'}
                    </div>
                </div>
            `;
        });

        addMessage(resultHtml);
        addReturnToMenu();

    } catch (e) {
        console.error('ì£¼ë¬¸ ì¡°íšŒ ì˜¤ë¥˜:', e);
        addMessage(`ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë§¤ë‹ˆì €ì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.\n\nğŸ“ 010-3455-1946`);
        addReturnToMenu();
    }
}

// ============================================================
// [10] FAQ ë©”ë‰´
// ============================================================
function showFaqMenu() {
    addMessage(`â“ <b>ìì£¼ ë¬»ëŠ” ì§ˆë¬¸</b>\n\nê¶ê¸ˆí•œ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”!`);
    addQuickActions([
        { label: 'ğŸšš ë°°ì†¡ ì•ˆë‚´', value: 'ë°°ì†¡' },
        { label: 'ğŸ’³ ê²°ì œ ë°©ë²•', value: 'ê²°ì œ' },
        { label: 'ğŸ¢ ì‚¬ì—…ì í˜œíƒ', value: 'ì‚¬ì—…ì í• ì¸' },
        { label: 'ğŸ¨ ì—ë””í„° ì‚¬ìš©', value: 'ë¬´ë£Œ ì—ë””í„°' },
        { label: 'ğŸ“„ íŒŒì¼ í˜•ì‹', value: 'íŒŒì¼ í˜•ì‹' },
        { label: 'ğŸ”„ ì·¨ì†Œ/í™˜ë¶ˆ', value: 'ì·¨ì†Œ í™˜ë¶ˆ' },
        { label: 'ğŸ’° ë§ˆì¼ë¦¬ì§€', value: 'ë§ˆì¼ë¦¬ì§€' },
        { label: 'ğŸ• ì˜ì—…ì‹œê°„', value: 'ì˜ì—…ì‹œê°„' }
    ]);
}

function matchFAQ(text) {
    for (const faq of FAQ_DB) {
        if (faq.keywords.some(k => text.includes(k))) {
            return faq.answer;
        }
    }
    return null;
}

function addReturnToMenu() {
    setTimeout(() => {
        addQuickActions([
            { label: 'ğŸ  ì²˜ìŒìœ¼ë¡œ', value: 'ì•ˆë…•' },
            { label: 'ğŸ“ ê²¬ì  ë¬¸ì˜', value: 'ê²¬ì ' },
            { label: 'ğŸ“ ë§¤ë‹ˆì € ì—°ê²°', value: 'ë§¤ë‹ˆì € ì—°ê²°' }
        ]);
    }, 100);
}

// ============================================================
// [11] ì´ˆê¸°í™”
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸ¦ ì¹´ë©œë ˆì˜¨ AI ìƒë‹´ë´‡ ë¡œë“œ ì™„ë£Œ');
});
</script>

</body>
</html>
