<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¹´ë©œë ˆì˜¨ ì£¼ë¬¸ ê´€ë¦¬ì</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <!-- ZIP íŒŒì¼ ìƒì„±ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        body { font-family: 'Pretendard', sans-serif; background: #f1f5f9; padding: 20px; margin: 0; color: #1e293b; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h2 { margin: 0; color: #334155; }
        
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #cbd5e1; padding-bottom: 10px; }
        .tab-btn { 
            padding: 10px 20px; border: none; background: none; cursor: pointer; 
            font-size: 15px; font-weight: 600; color: #64748b; border-radius: 8px; transition: 0.2s;
        }
        .tab-btn:hover { background: #e2e8f0; }
        .tab-btn.active { background: #6366f1; color: white; }

        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; position: relative; }
        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 15px; }
        
        .user-info { font-size: 18px; font-weight: 700; color: #0f172a; }
        .user-phone { font-size: 14px; color: #64748b; font-weight: 400; margin-left: 5px; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; background: #dbeafe; color: #1d4ed8; }
        
        .info-grid { display: grid; grid-template-columns: 100px 1fr; gap: 8px; font-size: 14px; margin-bottom: 20px; }
        .label { color: #64748b; font-weight: 600; }
        .value { color: #334155; }
        
        .file-box { background: #f8fafc; border-radius: 8px; padding: 15px; border: 1px solid #e2e8f0; margin-bottom: 15px; }
        .file-title { font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        
        .file-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .file-link { 
            display: inline-flex; align-items: center; gap: 5px;
            padding: 8px 12px; background: white; border: 1px solid #cbd5e1; 
            border-radius: 6px; text-decoration: none; color: #334155; font-size: 13px; transition: 0.2s; 
        }
        .file-link:hover { border-color: #6366f1; color: #6366f1; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .action-bar { display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #f1f5f9; padding-top: 15px; }
        .btn { padding: 10px 18px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid transparent; display: inline-flex; align-items: center; gap: 6px; }
        
        .btn-outline { background: white; border-color: #cbd5e1; color: #475569; }
        .btn-outline:hover { background: #f8fafc; border-color: #94a3b8; }
        
        .btn-primary { background: #6366f1; color: white; }
        .btn-primary:hover { background: #4f46e5; }
        
        /* ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (íŒŒë€ìƒ‰ ê°•ì¡°) */
        .btn-download { background: #0ea5e9; color: white; }
        .btn-download:hover { background: #0284c7; }

        .btn-danger { background: #fee2e2; color: #ef4444; border-color: #fca5a5; }
        .btn-danger:hover { background: #fecaca; }

        .empty-state { text-align: center; padding: 60px 0; color: #94a3b8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>ğŸ“¦ ì£¼ë¬¸ ê´€ë¦¬ì</h2>
            <button class="btn btn-primary" onclick="loadOrders()">ğŸ”„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <!-- í´ë” íƒ­ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="filterOrders('ì ‘ìˆ˜ë¨', this)">ğŸ“¥ ì ‘ìˆ˜ëœ ì£¼ë¬¸</button>
            <button class="tab-btn" onclick="filterOrders('ì¹¼ì„ ì‘ì—…', this)">âœ‚ï¸ ì¹¼ì„  ì‘ì—…</button>
            <button class="tab-btn" onclick="filterOrders('ì™„ë£Œë¨', this)">âœ… ì™„ë£Œëœ ì‘ì—…</button>
            <button class="tab-btn" onclick="filterOrders('ì‚­ì œë¨', this)">ğŸ—‘ï¸ íœ´ì§€í†µ</button>
        </div>

        <div id="orderList">ë¡œë”© ì¤‘...</div>
    </div>

    <script type="module">
        import { sb } from "./config.js";

        let currentStatus = 'ì ‘ìˆ˜ë¨';

        window.filterOrders = (status, btn) => {
            currentStatus = status;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            loadOrders();
        };

        window.loadOrders = async () => {
            const list = document.getElementById("orderList");
            list.innerHTML = '<div style="text-align:center; padding:40px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';

            if (!sb) {
                list.innerHTML = '<div style="color:red; text-align:center;">DB ì—°ê²° ì‹¤íŒ¨</div>';
                return;
            }

            const { data, error } = await sb
                .from('orders')
                .select('*')
                .eq('status', currentStatus)
                .order('created_at', { ascending: false });

            if (error) {
                console.error(error);
                list.innerHTML = `<div style="color:red; text-align:center;">ì—ëŸ¬ ë°œìƒ: ${error.message}</div>`;
                return;
            }

            if (!data || data.length === 0) {
                list.innerHTML = `<div class="empty-state">ì´ í´ë”ëŠ” ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            list.innerHTML = "";
            
            data.forEach(order => {
                const date = new Date(order.created_at).toLocaleString('ko-KR');
                
                // íŒŒì¼ ë§í¬ ìƒì„±
                let filesHtml = "";
                if (order.files && Array.isArray(order.files)) {
                    order.files.forEach(f => {
                        let icon = "ğŸ“„";
                        if(f.type === 'order_sheet') icon = "ğŸ“‹";
                        else if(f.type === 'quotation') icon = "ğŸ“‘";
                        else if(f.type === 'product') icon = "ğŸ¨";
                        
                        filesHtml += `
                            <a href="${f.url}" target="_blank" class="file-link" download>
                                <span>${icon} ${f.name}</span>
                            </a>`;
                    });
                } else {
                    filesHtml = '<span style="color:#999; font-size:12px;">íŒŒì¼ ì—†ìŒ</span>';
                }

                // ìƒíƒœë³„ ë²„íŠ¼ êµ¬ì„±
                let actionButtons = "";
                
                // â˜… [í•µì‹¬] íŒŒì¼ ì¼ê´„ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ëª¨ë“  ìƒíƒœì—ì„œ í‘œì‹œ)
                const downloadBtn = `
                    <button class="btn btn-download" onclick="downloadAllFiles(${order.id}, '${order.manager_name}')">
                        ğŸ“¥ íŒŒì¼ ë°›ê¸° (ZIP)
                    </button>`;

                // ì‚­ì œ ë²„íŠ¼ (ìƒíƒœì— ë”°ë¼ ë‹¤ë¦„)
                let deleteBtn = "";
                if (currentStatus === 'ì‚­ì œë¨') {
                    deleteBtn = `<button class="btn btn-danger" onclick="deletePermanently(${order.id})">ğŸ’¥ ì˜êµ¬ ì‚­ì œ</button>`;
                } else {
                    deleteBtn = `<button class="btn btn-danger" onclick="updateStatus(${order.id}, 'ì‚­ì œë¨')">ğŸ—‘ï¸ ì‚­ì œ</button>`;
                }

                // ìƒíƒœ ì´ë™ ë²„íŠ¼ë“¤
                let moveBtns = "";
                if (currentStatus === 'ì ‘ìˆ˜ë¨') {
                    moveBtns = `<button class="btn btn-outline" onclick="updateStatus(${order.id}, 'ì¹¼ì„ ì‘ì—…')">âœ‚ï¸ ì¹¼ì„ ì‘ì—…ìœ¼ë¡œ ì´ë™</button>`;
                } else if (currentStatus === 'ì¹¼ì„ ì‘ì—…') {
                    moveBtns = `
                        <button class="btn btn-primary" onclick="updateStatus(${order.id}, 'ì™„ë£Œë¨')">âœ… ì™„ë£Œ ì²˜ë¦¬</button>
                        <button class="btn btn-outline" onclick="updateStatus(${order.id}, 'ì ‘ìˆ˜ë¨')">â†© ì ‘ìˆ˜ ì·¨ì†Œ</button>
                    `;
                } else if (currentStatus === 'ì™„ë£Œë¨') {
                    moveBtns = `<button class="btn btn-outline" onclick="updateStatus(${order.id}, 'ì ‘ìˆ˜ë¨')">â†© ë¯¸ì™„ë£Œ ì²˜ë¦¬</button>`;
                } else if (currentStatus === 'ì‚­ì œë¨') {
                    moveBtns = `<button class="btn btn-primary" onclick="updateStatus(${order.id}, 'ì ‘ìˆ˜ë¨')">â™»ï¸ ë³µì›</button>`;
                }

                const html = `
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <span class="user-info">${order.manager_name}</span> 
                                <span class="user-phone">${order.phone}</span>
                            </div>
                            <span class="status-badge">${order.status}</span>
                        </div>
                        
                        <div class="info-grid">
                            <span class="label">ì ‘ìˆ˜ ì¼ì‹œ</span> <span class="value">${date}</span>
                            <span class="label">í¬ë§ ë°°ì†¡ì¼</span> <span class="value" style="color:#2563eb; font-weight:bold;">${order.order_date || '-'}</span>
                            <span class="label">ì£¼ì†Œ</span> <span class="value">${order.address}</span>
                            <span class="label">ìš”ì²­ ì‚¬í•­</span> <span class="value">${order.request_note || '-'}</span>
                        </div>

                        <div class="file-box">
                            <div class="file-title">ğŸ“‚ ì²¨ë¶€ íŒŒì¼</div>
                            <div class="file-list">${filesHtml}</div>
                        </div>

                        <div class="action-bar">
                            ${downloadBtn}
                            ${moveBtns}
                            ${deleteBtn}
                        </div>
                    </div>
                `;
                list.innerHTML += html;
            });
        };

        // ìƒíƒœ ë³€ê²½ í•¨ìˆ˜
        window.updateStatus = async (id, newStatus) => {
            if (!confirm(`ìƒíƒœë¥¼ '${newStatus}'(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const { error } = await sb.from('orders').update({ status: newStatus }).eq('id', id);
            if (error) alert("ì˜¤ë¥˜: " + error.message);
            else loadOrders();
        };

        // ì˜êµ¬ ì‚­ì œ í•¨ìˆ˜
        window.deletePermanently = async (id) => {
            if (!confirm("ì •ë§ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (íŒŒì¼ë„ í•¨ê»˜ ì‚­ì œë¨)")) return;
            
            // 1. Storage íŒŒì¼ ì‚­ì œ (ì„ íƒì‚¬í•­, êµ¬í˜„í•˜ë ¤ë©´ íŒŒì¼ ëª©ë¡ ì¡°íšŒ í•„ìš”)
            // 2. DB ì‚­ì œ
            const { error } = await sb.from('orders').delete().eq('id', id);
            if (error) alert("ì˜¤ë¥˜: " + error.message);
            else loadOrders();
        };

        // â˜… [í•µì‹¬] íŒŒì¼ ì¼ê´„ ë‹¤ìš´ë¡œë“œ (ZIP ì••ì¶•)
        window.downloadAllFiles = async (orderId, managerName) => {
            // 1. ì£¼ë¬¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (íŒŒì¼ ëª©ë¡ í™•ì¸ìš©)
            const { data, error } = await sb.from('orders').select('files').eq('id', orderId).single();
            
            if (error || !data || !data.files || data.files.length === 0) {
                alert("ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const files = data.files;
            const zip = new JSZip();
            const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            const folderName = `[${today}]_${managerName}`; // í´ë”ëª…

            // ì•Œë¦¼ í‘œì‹œ
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "ì••ì¶• ì¤‘...";
            btn.disabled = true;

            try {
                // 2. íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë° ZIPì— ì¶”ê°€
                const downloadPromises = files.map(async (file) => {
                    try {
                        // Supabase URLì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (CORS ë¬¸ì œ íšŒí”¼ í•„ìš”í•  ìˆ˜ ìˆìŒ)
                        const response = await fetch(file.url);
                        const blob = await response.blob();
                        zip.file(file.name, blob);
                    } catch (err) {
                        console.error(`íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${file.name}`, err);
                    }
                });

                await Promise.all(downloadPromises);

                // 3. ZIP ìƒì„± ë° ì €ì¥
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `${folderName}.zip`); // FileSaver.js ì‚¬ìš©

            } catch (err) {
                console.error(err);
                alert("íŒŒì¼ ì••ì¶• ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        window.addEventListener('DOMContentLoaded', () => loadOrders());
    </script>
</body>
</html>